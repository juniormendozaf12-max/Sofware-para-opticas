<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Centro √ìptico Sicuani - Sistema Completo v5</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- PDF.js para lectura de archivos PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.min.js"></script>
<script>
  // Configurar workerSrc para PDF.js
  if (typeof pdfjsLib !== 'undefined') {
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.worker.min.js';
  }

  // Declarar variables globales del sistema consultorio TEMPRANO para evitar errores de inicializaci√≥n
  var pacienteConsultorioActual = null;
  var consultaEnEdicion = null;
  var modoVistaConsultorio = 'nuevo-examen';
</script>
<style>
  * { box-sizing: border-box; font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; padding: 0; }

  :root {
    --purple-50: #faf5ff;
    --purple-100: #f3e8ff;
    --purple-200: #e9d5ff;
    --purple-300: #d8b4fe;
    --purple-400: #c084fc;
    --purple-500: #a855f7;
    --purple-600: #9333ea;
    --purple-700: #7c3aed;
    --purple-800: #6b21a8;
    --purple-900: #581c87;
    --gray-50: #fafafa;
    --gray-100: #f4f4f5;
    --gray-200: #e4e4e7;
    --gray-300: #d4d4d8;
    --gray-400: #a1a1aa;
    --gray-500: #71717a;
    --gray-600: #52525b;
    --gray-700: #3f3f46;
    --gray-800: #27272a;
    --gray-900: #18181b;
  }

  body {
    background: linear-gradient(135deg, rgba(109, 40, 217, 0.95) 0%, rgba(91, 33, 182, 0.95) 100%),
                url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1600 900"><defs><pattern id="optical-bg" x="0" y="0" width="150" height="150" patternUnits="userSpaceOnUse"><g opacity="0.08"><circle cx="50" cy="50" r="25" fill="none" stroke="white" stroke-width="2"/><circle cx="100" cy="50" r="25" fill="none" stroke="white" stroke-width="2"/><line x1="75" y1="50" x2="75" y2="50" stroke="white" stroke-width="2"/><path d="M 25 50 Q 20 45, 10 45" stroke="white" stroke-width="2" fill="none"/><path d="M 125 50 Q 130 45, 140 45" stroke="white" stroke-width="2" fill="none"/></g></pattern></defs><rect width="1600" height="900" fill="url(%23optical-bg)"/></svg>');
    background-size: cover, 300px 300px;
    background-position: center, center;
    background-attachment: fixed;
    min-height: 100vh;
    overflow: hidden;
  }

  /* ===== RIBBON SUPERIOR - COMPACTO 100% ZOOM ===== */
  #ribbon {
    height: 52px;
    background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    border-bottom: 3px solid #3b82f6;
    display: flex;
    align-items: center;
    padding: 0 8px;
    gap: 8px;
    box-shadow: 0 6px 24px rgba(59, 130, 246, 0.25), 0 3px 12px rgba(0, 0, 0, 0.2);
    position: sticky;
    top: 0;
    z-index: 1000;
  }

  .ribbon-group {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 6px 10px;
    border-right: 1px solid rgba(255, 255, 255, 0.1);
  }

  .ribbon-group:last-child { border-right: none; }

  .ribbon-group h4 {
    font-size: 7px;
    color: rgba(255, 255, 255, 0.6);
    margin-top: 3px;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    font-weight: 600;
  }

  .ribbon-btn {
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.15) 0%, rgba(37, 99, 235, 0.1) 100%);
    border: 2px solid rgba(59, 130, 246, 0.3);
    border-radius: 8px;
    padding: 6px 10px;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    align-items: center;
    transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    min-width: 50px;
    box-shadow: 0 3px 12px rgba(0, 0, 0, 0.3);
    color: white;
    font-weight: 600;
  }

  .ribbon-btn:hover {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    border-color: #60a5fa;
    transform: translateY(-4px) scale(1.05);
    box-shadow: 0 12px 30px rgba(59, 130, 246, 0.4), 0 4px 15px rgba(0, 0, 0, 0.3);
  }

  .ribbon-btn.active {
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
    color: white;
    border-color: #60a5fa;
    box-shadow: 0 8px 25px rgba(59, 130, 246, 0.6), 0 4px 12px rgba(0, 0, 0, 0.3);
    transform: scale(1.08);
  }

  .ribbon-btn.active:hover {
    transform: translateY(-2px) scale(1.08);
  }

  .ribbon-icon {
    font-size: 20px;
    margin-bottom: 4px;
    filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
    animation: iconPulse 2s ease-in-out infinite;
  }

  @keyframes iconPulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
  }

  .ribbon-btn span {
    font-size: 8px;
    font-weight: 700;
    letter-spacing: 0.3px;
    text-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
  }

  /* ===== ESTRUCTURA ELIMINADA - DISE√ëO LIMPIO ===== */

  /* ===== HEADER PRINCIPAL - COMPACTO 100% ZOOM ===== */
  .app-header {
    position: fixed;
    top: 52px;
    left: 0;
    right: 0;
    height: 55px;
    background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);
    padding: 12px 24px;
    border-bottom: 2px solid #3b82f6;
    display: flex;
    align-items: center;
    justify-content: space-between;
    z-index: 999;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
  }

  .app-header h1 {
    font-size: 20px;
    color: var(--gray-800);
    transition: color 0.3s ease;
  }

  .app-header h1 span {
    color: var(--purple-600);
    font-weight: 700;
    transition: color 0.3s ease;
  }

  .app-header small {
    color: var(--gray-500);
    font-size: 10px;
    transition: color 0.3s ease;
  }

  /* ===== CONTENIDO PRINCIPAL - PANTALLA COMPLETA OPTIMIZADA 100% ZOOM ===== */
  main {
    position: fixed;
    top: 107px;
    left: 0;
    right: 0;
    bottom: 0;
    padding: 10px;
    margin: 0;
    max-width: none;
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    overflow-y: auto;
    overflow-x: hidden;
    z-index: 1;
  }

  main > section {
    display: none;
    width: 100%;
    max-width: 100%;
    height: auto;
    height: 100%;
    padding: 24px;
    overflow-y: auto;
    overflow-x: hidden;
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
  }

  /* REGLA CR√çTICA: Secciones con .hidden SIEMPRE ocultas */
  main > section.hidden {
    display: none !important;
  }

  /* REGLA CR√çTICA: SOLO secciones con .active visibles */
  main > section.active {
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
    animation: sectionFadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 10;
    pointer-events: auto !important;
  }

  /* Asegurar que el contenido dentro de las secciones activas sea visible */
  main > section.active * {
    visibility: visible;
  }

  @keyframes sectionFadeIn {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Logo Principal de Fondo */
  #logoPrincipalContainer {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 0;
    pointer-events: none;
    user-select: none;
  }

  .main-logo {
    opacity: 0.12;
    width: 700px;
    height: auto;
    max-width: 90vw;
    transition: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
    user-select: none;
    pointer-events: none;
    animation: floatUpDown 6s ease-in-out infinite;
  }

  .card {
    background: rgba(255, 255, 255, 0.98);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 16px;
    border: 2px solid rgba(59, 130, 246, 0.1);
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06), 0 1px 3px rgba(0, 0, 0, 0.04);
    transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
    position: relative;
    overflow: hidden;
  }

  .card::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.1), transparent);
    transition: left 0.6s ease;
  }

  .card:hover::before {
    left: 100%;
  }

  .card:hover {
    transform: translateY(-4px) scale(1.01);
    box-shadow: 0 12px 40px rgba(59, 130, 246, 0.15), 0 4px 12px rgba(0, 0, 0, 0.1);
    border-color: rgba(59, 130, 246, 0.3);
    box-shadow: 0 12px 40px rgba(59, 130, 246, 0.2), 0 4px 12px rgba(0, 0, 0, 0.1);
    transform: translateY(-4px) scale(1.01);
    border-color: rgba(59, 130, 246, 0.3);
  }

  /* ===== GLASS EFFECT ===== */
  .card-glass {
    background: rgba(255, 255, 255, 0.85);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: 1px solid rgba(255, 255, 255, 0.3);
    box-shadow: 0 8px 32px rgba(139, 92, 246, 0.15), 0 4px 16px rgba(0, 0, 0, 0.1);
  }

  .modal-glass {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 2px solid rgba(139, 92, 246, 0.2);
    box-shadow: 0 25px 80px rgba(139, 92, 246, 0.3), 0 10px 40px rgba(0, 0, 0, 0.15);
  }

  .card-title {
    font-size: 20px;
    font-weight: 700;
    color: #1e40af;
    margin-bottom: 24px;
    padding: 16px 24px;
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(37, 99, 235, 0.15) 100%);
    border-left: 5px solid #3b82f6;
    border-radius: 10px;
    display: flex;
    align-items: center;
    gap: 12px;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    letter-spacing: 0.5px;
    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);
    min-height: 56px;
  }

  .card-title:hover {
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.15) 0%, rgba(37, 99, 235, 0.2) 100%);
    border-left-color: #2563eb;
    transform: translateX(4px);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
  }

  .row { display: flex; gap: 12px; flex-wrap: wrap; }
  .field { flex: 1 1 160px; min-width: 140px; }

  label {
    font-size: 11px;
    color: #1f2937;
    display: block;
    margin-bottom: 6px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.3px;
    transition: color 0.3s ease;
  }

  input, select, textarea {
    width: 100%;
    padding: 14px 16px;
    border-radius: 10px;
    border: 2px solid var(--gray-200);
    background: #fff;
    color: #1f2937;
    font-size: 15px;
    font-weight: 500;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    min-height: 44px;
  }

  input::placeholder, textarea::placeholder {
    color: var(--gray-400);
    transition: color 0.3s ease, opacity 0.3s ease;
    opacity: 0.7;
  }

  input:hover, select:hover, textarea:hover {
    border-color: var(--purple-300);
    background: linear-gradient(135deg, rgba(249, 250, 251, 1), rgba(243, 244, 246, 1));
  }

  input:hover::placeholder, textarea:hover::placeholder {
    opacity: 1;
    color: var(--purple-400);
  }

  input:focus, select:focus, textarea:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 5px rgba(59, 130, 246, 0.2), 0 6px 20px rgba(59, 130, 246, 0.25);
    transform: translateY(-3px) scale(1.01);
    background: white;
    animation: inputFocusGlowBlue 0.6s cubic-bezier(0.4, 0, 0.2, 1);
  }

  @keyframes inputFocusGlowBlue {
    0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.5); }
    50% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0.2), 0 6px 20px rgba(59, 130, 246, 0.35); }
    100% { box-shadow: 0 0 0 5px rgba(59, 130, 246, 0.2), 0 6px 20px rgba(59, 130, 246, 0.25); }
  }

  input:focus::placeholder, textarea:focus::placeholder {
    opacity: 0.5;
    transform: translateX(5px);
  }

  input[readonly] {
    background: var(--gray-100);
    color: var(--gray-500);
    cursor: not-allowed;
    opacity: 0.7;
  }

  textarea {
    resize: vertical;
    min-height: 60px;
    font-family: inherit;
  }

  /* ===== TABLAS PROFESIONALES ===== */
  table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    font-size: 14px;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 15px rgba(0, 0, 0, 0.08);
  }

  th, td {
    padding: 18px 16px;
    text-align: left;
    border-bottom: 1px solid rgba(59, 130, 246, 0.1);
    font-size: 14px;
  }

  th {
    background: linear-gradient(135deg, #1e40af 0%, #1d4ed8 100%);
    color: white;
    font-weight: 700;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    box-shadow: 0 2px 8px rgba(30, 64, 175, 0.3);
  }

  tbody tr {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    background: white;
  }

  tbody tr:hover {
    background: rgba(59, 130, 246, 0.08);
    transform: scale(1.005);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
  }
  .text-right { text-align: right; }
  .text-center { text-align: center; }

  /* ===== BOTONES ===== */
  .btn {
    border: none;
    border-radius: 12px;
    padding: 12px 24px;
    font-size: 12px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: inline-flex;
    align-items: center;
    gap: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }

  .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.2);
  }

  .btn:active {
    transform: translateY(0);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }

  .btn-primary {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    color: white;
    border: 2px solid #60a5fa;
    box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
  }
  .btn-primary:hover {
    background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
    border-color: #3b82f6;
    box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
  }

  .btn-success { background: linear-gradient(180deg, #22c55e 0%, #16a34a 100%); color: white; }
  .btn-success:hover { background: linear-gradient(180deg, #16a34a 0%, #15803d 100%); }

  .btn-secondary { background: linear-gradient(180deg, var(--gray-100) 0%, var(--gray-200) 100%); color: var(--gray-700); border: 1px solid var(--gray-300); }
  .btn-secondary:hover { background: linear-gradient(180deg, var(--gray-200) 0%, var(--gray-300) 100%); }

  .btn-danger { background: linear-gradient(180deg, #ef4444 0%, #dc2626 100%); color: white; }
  .btn-warning { background: linear-gradient(180deg, #f59e0b 0%, #d97706 100%); color: white; }
  .btn-info { background: linear-gradient(180deg, #06b6d4 0%, #0891b2 100%); color: white; }

  .btn-sm { padding: 7px 12px; font-size: 12px; }

  /* ===== BADGES ===== */
  .badge {
    display: inline-block;
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 700;
  }

  .badge-danger { background: #fef2f2; color: #dc2626; }
  .badge-success { background: #f0fdf4; color: #16a34a; }
  .badge-warning { background: #fffbeb; color: #d97706; }
  .badge-info { background: var(--purple-100); color: var(--purple-700); }
  .badge-purple { background: var(--purple-100); color: var(--purple-700); }

  /* ===== UTILIDADES ===== */
  .hidden { display: none !important; }
  .flex-between { display: flex; align-items: center; justify-content: space-between; }
  .flex-end { display: flex; justify-content: flex-end; gap: 10px; }
  .mt-1 { margin-top: 8px; }
  .mt-2 { margin-top: 14px; }
  .mt-3 { margin-top: 20px; }
  .mb-2 { margin-bottom: 14px; }

  .totals { display: flex; gap: 14px; justify-content: flex-end; }
  .totals .field { max-width: 140px; }

  .pill {
    padding: 6px 14px;
    border-radius: 20px;
    background: var(--purple-100);
    font-size: 12px;
    color: var(--purple-700);
    font-weight: 600;
  }

  /* ===== MODALES ===== */
  dialog {
    border: none;
    border-radius: 20px;
    padding: 0;
    background: rgba(255, 255, 255, 0.98);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    max-width: 750px;
    width: 95%;
    box-shadow: 0 30px 100px rgba(139, 92, 246, 0.3), 0 10px 40px rgba(0,0,0,0.2);
    max-height: 90vh;
    overflow: hidden;
    border: 2px solid rgba(139, 92, 246, 0.2);
    animation: modalZoomIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }

  dialog::backdrop {
    background: rgba(0,0,0,0.7);
    backdrop-filter: blur(4px);
    -webkit-backdrop-filter: blur(4px);
  }

  .modal-header {
    padding: 18px 24px;
    background: linear-gradient(180deg, var(--purple-600) 0%, var(--purple-700) 100%);
    color: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .modal-header strong { font-size: 17px; }

  .modal-body {
    padding: 20px 24px;
    max-height: 65vh;
    overflow-y: auto;
  }

  .modal-footer {
    padding: 16px 24px;
    background: var(--gray-100);
    border-top: 1px solid var(--gray-200);
    display: flex;
    justify-content: flex-end;
    gap: 12px;
  }

  /* ===== PESTA√ëAS ===== */
  .tabs {
    display: flex;
    background: linear-gradient(135deg, rgba(139, 92, 246, 0.05) 0%, rgba(168, 85, 247, 0.08) 100%);
    border-radius: 12px;
    padding: 6px;
    gap: 4px;
  }

  .tab-btn {
    padding: 14px 24px;
    border: none;
    background: transparent;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    color: var(--gray-600);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border-radius: 8px;
    position: relative;
  }

  .tab-btn:hover {
    background: rgba(139, 92, 246, 0.1);
    color: var(--purple-700);
    transform: translateY(-1px);
  }

  .tab-btn.active {
    background: linear-gradient(135deg, var(--purple-600) 0%, var(--purple-700) 100%);
    color: white;
    box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4), 0 2px 6px rgba(0,0,0,0.1);
  }

  .tab-btn.active:hover {
    transform: translateY(0);
  }

  /* Nuevo dise√±o de pantalla completa para prescripciones */
  .rx-fullscreen-content {
    max-height: 600px;
    overflow-y: auto;
    overflow-x: hidden;
    padding: 0 16px 16px;
    scroll-behavior: smooth;
  }

  .rx-fullscreen-content::-webkit-scrollbar {
    width: 10px;
  }

  .rx-fullscreen-content::-webkit-scrollbar-track {
    background: var(--gray-100);
    border-radius: 5px;
  }

  .rx-fullscreen-content::-webkit-scrollbar-thumb {
    background: var(--primary-400);
    border-radius: 5px;
    transition: background 0.3s;
  }

  .rx-fullscreen-content::-webkit-scrollbar-thumb:hover {
    background: var(--primary-600);
  }

  .rx-section {
    margin-bottom: 24px;
    animation: slideInUp 0.4s ease;
  }

  .rx-section-header {
    font-size: 18px;
    font-weight: 700;
    color: var(--primary-700);
    margin: 0 0 16px 0;
    padding: 12px 20px;
    background: linear-gradient(135deg, var(--primary-50), var(--primary-100));
    border-left: 5px solid var(--primary-500);
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    display: flex;
    align-items: center;
    gap: 10px;
    transition: all 0.3s ease;
  }

  .rx-section-header:hover {
    background: linear-gradient(135deg, var(--primary-100), var(--primary-200));
    transform: translateX(5px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.12);
  }

  /* Estilos para m√≥dulo Consultorio - Pantalla completa */
  .consultorio-fullscreen-container {
    max-height: 70vh;
    overflow-y: auto;
    overflow-x: hidden;
    padding: 20px;
    background: linear-gradient(135deg, #faf5ff 0%, #f3f4f6 100%);
    border-radius: 12px;
    scroll-behavior: smooth;
  }

  .consultorio-fullscreen-container::-webkit-scrollbar {
    width: 12px;
  }

  .consultorio-fullscreen-container::-webkit-scrollbar-track {
    background: #e9d5ff;
    border-radius: 6px;
  }

  .consultorio-fullscreen-container::-webkit-scrollbar-thumb {
    background: linear-gradient(180deg, var(--primary-500), var(--primary-700));
    border-radius: 6px;
    transition: background 0.3s;
  }

  .consultorio-fullscreen-container::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(180deg, var(--primary-600), var(--primary-800));
  }

  .consultorio-main-title {
    font-size: 24px;
    font-weight: 800;
    color: var(--primary-700);
    text-align: center;
    margin: 0 0 24px 0;
    padding: 16px 24px;
    background: linear-gradient(135deg, var(--primary-500), var(--primary-700));
    color: white;
    border-radius: 12px;
    box-shadow: 0 8px 24px rgba(124, 58, 237, 0.3);
    text-transform: uppercase;
    letter-spacing: 1px;
    animation: slideInDown 0.5s ease;
  }

  @keyframes slideInDown {
    from {
      opacity: 0;
      transform: translateY(-30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .consultorio-section {
    margin-bottom: 28px;
    animation: fadeInUp 0.5s ease;
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .consultorio-section-header {
    font-size: 18px;
    font-weight: 700;
    color: var(--primary-800);
    margin: 0 0 16px 0;
    padding: 14px 20px;
    background: linear-gradient(135deg, #ddd6fe, #c4b5fd);
    border-left: 6px solid var(--primary-600);
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(124, 58, 237, 0.15);
    display: flex;
    align-items: center;
    gap: 12px;
    transition: all 0.3s ease;
    cursor: pointer;
  }

  .consultorio-section-header:hover {
    background: linear-gradient(135deg, #c4b5fd, #a78bfa);
    transform: translateX(8px) scale(1.01);
    box-shadow: 0 6px 20px rgba(124, 58, 237, 0.25);
  }

  .consultorio-section .card {
    transition: all 0.3s ease;
    border-left: 4px solid transparent;
  }

  .consultorio-section .card:hover {
    transform: translateY(-2px);
    border-left-color: var(--primary-500);
    box-shadow: 0 10px 30px rgba(0,0,0,0.12);
  }

  /* Modal Historial de Consulta - ULTRA MODERNO */
  .modal-historial-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(8px);
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
    animation: fadeIn 0.3s ease;
  }

  .modal-historial-container {
    background: white;
    border-radius: 20px;
    width: 95%;
    max-width: 1400px;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
    box-shadow: 0 25px 80px rgba(0, 0, 0, 0.4);
    animation: slideInUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    overflow: hidden;
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  .modal-historial-header {
    background: linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%);
    color: white;
    padding: 24px 32px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 4px 20px rgba(124, 58, 237, 0.3);
  }

  .modal-historial-title {
    display: flex;
    align-items: center;
    gap: 16px;
  }

  .modal-icon {
    font-size: 40px;
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
  }

  .modal-historial-title h2 {
    margin: 0;
    font-size: 24px;
    font-weight: 800;
    letter-spacing: 0.5px;
  }

  .modal-historial-title p {
    margin: 4px 0 0 0;
    font-size: 14px;
    opacity: 0.9;
  }

  .modal-historial-close {
    background: rgba(255, 255, 255, 0.2);
    border: 2px solid rgba(255, 255, 255, 0.4);
    color: white;
    font-size: 28px;
    width: 48px;
    height: 48px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
  }

  .modal-historial-close:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: rotate(90deg) scale(1.1);
    box-shadow: 0 4px 20px rgba(255, 255, 255, 0.3);
  }

  .modal-historial-content {
    flex: 1;
    overflow-y: auto;
    padding: 32px;
    background: linear-gradient(135deg, #faf5ff 0%, #f8fafc 100%);
  }

  .modal-historial-content::-webkit-scrollbar {
    width: 12px;
  }

  .modal-historial-content::-webkit-scrollbar-track {
    background: #e9d5ff;
    border-radius: 6px;
  }

  .modal-historial-content::-webkit-scrollbar-thumb {
    background: linear-gradient(180deg, var(--primary-500), var(--primary-700));
    border-radius: 6px;
  }

  .modal-historial-footer {
    padding: 20px 32px;
    background: #f8fafc;
    border-top: 2px solid #e9d5ff;
    display: flex;
    gap: 12px;
    justify-content: flex-end;
  }

  /* Secciones dentro del modal */
  .historial-section {
    background: white;
    border-radius: 16px;
    padding: 24px;
    margin-bottom: 24px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    border-left: 6px solid var(--primary-500);
    transition: all 0.3s ease;
    animation: slideInRight 0.5s ease;
  }

  @keyframes slideInRight {
    from {
      opacity: 0;
      transform: translateX(-30px);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }

  .historial-section:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 40px rgba(124, 58, 237, 0.2);
  }

  .historial-section-title {
    font-size: 18px;
    font-weight: 700;
    color: var(--primary-700);
    margin: 0 0 16px 0;
    padding-bottom: 12px;
    border-bottom: 3px solid var(--primary-200);
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .historial-section-title span {
    font-size: 24px;
  }

  /* Grid de datos */
  .historial-data-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 16px;
    margin-top: 16px;
  }

  .historial-data-item {
    background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
    padding: 14px 18px;
    border-radius: 10px;
    border-left: 4px solid var(--primary-400);
    transition: all 0.2s ease;
  }

  .historial-data-item:hover {
    background: linear-gradient(135deg, #e9d5ff 0%, #ddd6fe 100%);
    transform: translateX(5px);
  }

  .historial-data-item strong {
    display: block;
    font-size: 11px;
    color: var(--primary-600);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 4px;
  }

  .historial-data-item span {
    font-size: 15px;
    color: var(--gray-800);
    font-weight: 600;
  }

  /* Modal Visualizaci√≥n de RX - DISE√ëO ESPECTACULAR */
  .modal-rx-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.75);
    backdrop-filter: blur(10px);
    z-index: 10001;
    display: flex;
    align-items: center;
    justify-content: center;
    animation: fadeIn 0.3s ease;
  }

  .modal-rx-container {
    background: white;
    border-radius: 24px;
    width: 96%;
    max-width: 1500px;
    max-height: 92vh;
    display: flex;
    flex-direction: column;
    box-shadow: 0 30px 100px rgba(124, 58, 237, 0.5);
    animation: zoomIn 0.5s cubic-bezier(0.16, 1, 0.3, 1);
    overflow: hidden;
  }

  @keyframes zoomIn {
    from {
      opacity: 0;
      transform: scale(0.8);
    }
    to {
      opacity: 1;
      transform: scale(1);
    }
  }

  .modal-rx-header {
    background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
    color: white;
    padding: 28px 36px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 6px 30px rgba(59, 130, 246, 0.4);
  }

  .modal-rx-title {
    display: flex;
    align-items: center;
    gap: 20px;
  }

  .modal-rx-icon {
    font-size: 48px;
    animation: swing 3s infinite;
  }

  @keyframes swing {
    0%, 100% { transform: rotate(-5deg); }
    50% { transform: rotate(5deg); }
  }

  .modal-rx-title h2 {
    margin: 0;
    font-size: 28px;
    font-weight: 900;
    letter-spacing: 1px;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
  }

  .modal-rx-title p {
    margin: 6px 0 0 0;
    font-size: 15px;
    opacity: 0.95;
  }

  .modal-rx-close {
    background: rgba(255, 255, 255, 0.25);
    border: 3px solid rgba(255, 255, 255, 0.5);
    color: white;
    font-size: 32px;
    width: 52px;
    height: 52px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    font-weight: 300;
  }

  .modal-rx-close:hover {
    background: rgba(255, 255, 255, 0.35);
    transform: rotate(180deg) scale(1.15);
    box-shadow: 0 6px 25px rgba(255, 255, 255, 0.4);
  }

  .modal-rx-content {
    flex: 1;
    overflow-y: auto;
    padding: 36px;
    background: linear-gradient(180deg, #eff6ff 0%, #f8fafc 100%);
  }

  .modal-rx-content::-webkit-scrollbar {
    width: 14px;
  }

  .modal-rx-content::-webkit-scrollbar-track {
    background: #dbeafe;
    border-radius: 7px;
  }

  .modal-rx-content::-webkit-scrollbar-thumb {
    background: linear-gradient(180deg, #3b82f6, #1e40af);
    border-radius: 7px;
    border: 2px solid #dbeafe;
  }

  .modal-rx-footer {
    padding: 24px 36px;
    background: #f1f5f9;
    border-top: 3px solid #dbeafe;
    display: flex;
    gap: 14px;
    justify-content: flex-end;
    box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.05);
  }

  /* Tablas de RX modernas */
  .rx-table-container {
    background: white;
    border-radius: 16px;
    padding: 24px;
    margin-bottom: 24px;
    box-shadow: 0 6px 24px rgba(0, 0, 0, 0.1);
    border: 2px solid #dbeafe;
    transition: all 0.3s ease;
  }

  .rx-table-container:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 40px rgba(59, 130, 246, 0.25);
    border-color: #3b82f6;
  }

  .rx-table-title {
    font-size: 20px;
    font-weight: 800;
    color: #1e40af;
    margin: 0 0 20px 0;
    padding: 14px 20px;
    background: linear-gradient(135deg, #dbeafe, #bfdbfe);
    border-radius: 10px;
    border-left: 6px solid #3b82f6;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .rx-data-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
  }

  .rx-data-table thead th {
    background: linear-gradient(135deg, #3b82f6, #2563eb);
    color: white;
    padding: 14px 12px;
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border: none;
  }

  .rx-data-table thead th:first-child {
    border-radius: 12px 0 0 0;
  }

  .rx-data-table thead th:last-child {
    border-radius: 0 12px 0 0;
  }

  .rx-data-table tbody tr {
    transition: all 0.2s ease;
  }

  .rx-data-table tbody tr:hover {
    background: #eff6ff;
    transform: scale(1.01);
  }

  .rx-data-table tbody td {
    padding: 14px 12px;
    text-align: center;
    font-size: 14px;
    font-weight: 600;
    color: #1e3a8a;
    border-bottom: 1px solid #e0e7ff;
  }

  .rx-data-table tbody td:first-child {
    background: linear-gradient(135deg, #bfdbfe, #93c5fd);
    font-weight: 800;
    color: #1e40af;
    text-transform: uppercase;
    font-size: 13px;
  }

  .rx-data-table tbody tr:last-child td {
    border-bottom: none;
  }

  .rx-data-table tbody tr:last-child td:first-child {
    border-radius: 0 0 0 12px;
  }

  .rx-data-table tbody tr:last-child td:last-child {
    border-radius: 0 0 12px 0;
  }

  /* Secci√≥n de diagn√≥stico */
  .rx-diagnostico-box {
    background: linear-gradient(135deg, #d1fae5, #a7f3d0);
    border: 3px solid #10b981;
    border-radius: 16px;
    padding: 20px 24px;
    margin-top: 24px;
    box-shadow: 0 6px 20px rgba(16, 185, 129, 0.2);
  }

  .rx-diagnostico-title {
    font-size: 18px;
    font-weight: 800;
    color: #065f46;
    margin: 0 0 12px 0;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .rx-diagnostico-content {
    font-size: 16px;
    color: #047857;
    font-weight: 600;
    line-height: 1.6;
  }

  @keyframes slideInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .rx-section .card {
    position: relative;
    transition: all 0.3s ease;
    border-left: 4px solid transparent;
  }

  .rx-section .card:hover {
    transform: translateX(4px);
    border-left-color: var(--primary-500);
    box-shadow: 0 8px 20px rgba(0,0,0,0.15);
  }

  .rx-section .card-title {
    background: linear-gradient(135deg, var(--primary-500), var(--primary-600));
    color: white;
    padding: 12px 16px;
    margin: -16px -16px 16px -16px;
    border-radius: 8px 8px 0 0;
    font-weight: 600;
    font-size: 14px;
    letter-spacing: 0.5px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @keyframes modalZoomIn {
    from {
      opacity: 0;
      transform: scale(0.9) translateY(20px);
    }
    to {
      opacity: 1;
      transform: scale(1) translateY(0);
    }
  }

  .mdi-window[style*="display: flex"] {
    animation: modalZoomIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  /* ===== PRESCRIPCI√ìN GRID ===== */
  .rx-grid {
    display: grid !important;
    gap: 8px;
    align-items: center;
    width: 100%;
    visibility: visible !important;
    opacity: 1 !important;
  }

  .rx-grid .rx-label {
    font-weight: 700;
    color: var(--purple-700);
    font-size: 11px;
    padding: 8px 12px;
    background: linear-gradient(135deg, var(--purple-50) 0%, var(--purple-100) 100%);
    border-radius: 8px;
    text-align: center;
    border: 1px solid var(--purple-200);
  }

  .rx-header {
    font-weight: 700;
    color: var(--purple-700);
    text-align: center;
    font-size: 11px;
    padding: 10px 6px;
    background: linear-gradient(135deg, var(--purple-100) 0%, var(--purple-200) 100%);
    border-radius: 6px;
  }

  .rx-grid input {
    padding: 8px;
    text-align: center;
    font-size: 13px;
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
    border: 2px solid var(--gray-300);
    border-radius: 8px;
    background: white !important;
    color: var(--gray-900) !important;
    min-height: 32px;
    font-weight: 600;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    animation: fadeInScale 0.4s ease-out backwards;
  }

  /* ‚ú® ANIMACIONES ULTRA MODERNAS PARA PESTA√ëAS ‚ú® */
  .rx-tab-content {
    animation: tabFadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }

  @keyframes tabFadeIn {
    from {
      opacity: 0;
      transform: translateY(15px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Efecto de brillo en botones de pesta√±a */
  @keyframes tabGlow {
    0%, 100% {
      box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);
    }
    50% {
      box-shadow: 0 6px 16px rgba(124, 58, 237, 0.5);
    }
  }

  /* Hover effect en pesta√±as inactivas */
  [onclick*="cambiarPesta√±a"]:not([style*="linear-gradient"]):hover {
    background: linear-gradient(135deg, #e9d5ff 0%, #ddd6fe 100%) !important;
    transform: translateY(-2px);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  /* Transici√≥n suave para todos los contenidos de pesta√±as */
  #contenidoPrescripcion,
  #contenidoHistorial,
  #contenidoConsultorioPrescripcion,
  #contenidoConsultorioHistorial {
    transition: opacity 0.3s ease, transform 0.3s ease;
  }

  @keyframes fadeInScale {
    from {
      opacity: 0;
      transform: scale(0.95);
    }
    to {
      opacity: 1;
      transform: scale(1);
    }
  }

  .rx-grid input:focus {
    border-color: var(--primary-500) !important;
    box-shadow: 0 0 0 4px rgba(168, 85, 247, 0.15), 0 4px 12px rgba(139, 92, 246, 0.2) !important;
    transform: scale(1.05) !important;
    outline: none;
    z-index: 10;
    position: relative;
    background: white !important;
    animation: inputPulse 0.5s ease-out;
  }

  @keyframes inputPulse {
    0% { box-shadow: 0 0 0 0 rgba(168, 85, 247, 0.4); }
    50% { box-shadow: 0 0 0 6px rgba(168, 85, 247, 0.2), 0 4px 12px rgba(139, 92, 246, 0.3); }
    100% { box-shadow: 0 0 0 4px rgba(168, 85, 247, 0.15), 0 4px 12px rgba(139, 92, 246, 0.2); }
  }

  /* ===== ANIMACIONES ULTRA MODERNAS VANGUARDISTAS ===== */
  @keyframes slideInFromRight {
    from {
      opacity: 0;
      transform: translateX(30px) scale(0.95);
    }
    to {
      opacity: 1;
      transform: translateX(0) scale(1);
    }
  }

  @keyframes slideInFromLeft {
    from {
      opacity: 0;
      transform: translateX(-30px) scale(0.95);
    }
    to {
      opacity: 1;
      transform: translateX(0) scale(1);
    }
  }

  @keyframes bounceIn {
    0% {
      opacity: 0;
      transform: scale(0.3);
    }
    50% {
      opacity: 1;
      transform: scale(1.05);
    }
    70% { transform: scale(0.9); }
    100% { transform: scale(1); }
  }

  @keyframes shimmer {
    0% {
      background-position: -1000px 0;
    }
    100% {
      background-position: 1000px 0;
    }
  }

  @keyframes floatUpDown {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-8px); }
  }

  @keyframes rotateGlow {
    0% {
      box-shadow: 0 0 20px rgba(59, 130, 246, 0.4);
      transform: rotate(0deg);
    }
    50% {
      box-shadow: 0 0 30px rgba(168, 85, 247, 0.6);
    }
    100% {
      box-shadow: 0 0 20px rgba(59, 130, 246, 0.4);
      transform: rotate(360deg);
    }
  }

  /* ANIMACI√ìN PARA PILLS - SUPER FLUIDAS */
  .pill-button-animate {
    animation: bounceIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  .pill-button-animate:hover {
    transform: translateY(-3px) scale(1.05);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
  }

  .pill-button-animate:active {
    transform: translateY(-1px) scale(1.02);
  }

  .rx-grid input:hover:not(:disabled):not(:focus) {
    border-color: var(--primary-300) !important;
    background: linear-gradient(135deg, #fafafa 0%, #f4f4f5 100%) !important;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(124, 58, 237, 0.1);
  }

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  /* üé® DISE√ëOS ULTRA MODERNOS "ARTISTA √öNICO" - VANGUARDIA INTERNACIONAL üé® */
  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

  /* ‚ú® GLASSMORPHISM PARA TARJETAS DE PRESCRIPCI√ìN */
  .rx-section,
  .rx-grid,
  [id*="contenido"][id*="Prescripcion"],
  [id*="contenido"][id*="Historial"] {
    background: rgba(255, 255, 255, 0.95) !important;
    backdrop-filter: blur(20px) saturate(180%);
    -webkit-backdrop-filter: blur(20px) saturate(180%);
    border: 1px solid rgba(255, 255, 255, 0.6);
    box-shadow:
      0 8px 32px rgba(124, 58, 237, 0.08),
      0 2px 8px rgba(124, 58, 237, 0.04),
      inset 0 1px 1px rgba(255, 255, 255, 0.9);
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .rx-section:hover,
  .rx-grid:hover {
    box-shadow:
      0 12px 48px rgba(124, 58, 237, 0.12),
      0 4px 16px rgba(124, 58, 237, 0.08),
      inset 0 1px 1px rgba(255, 255, 255, 0.9);
    transform: translateY(-2px);
  }

  /* üí´ EFECTOS DE INPUT AL ESCRIBIR - MICRO ANIMACIONES */
  input[type="text"]:not(:placeholder-shown),
  input[type="number"]:not(:placeholder-shown),
  input[type="date"]:not(:placeholder-shown),
  textarea:not(:placeholder-shown) {
    animation: inputFillGlow 0.6s ease-out;
    background: linear-gradient(135deg, #ffffff 0%, #faf5ff 100%) !important;
    border-color: #a78bfa !important;
  }

  @keyframes inputFillGlow {
    0% {
      box-shadow: 0 0 0 0 rgba(168, 85, 247, 0.6);
    }
    50% {
      box-shadow: 0 0 0 8px rgba(168, 85, 247, 0.1), 0 4px 20px rgba(124, 58, 237, 0.3);
    }
    100% {
      box-shadow: 0 0 0 4px rgba(168, 85, 247, 0.05), 0 2px 8px rgba(124, 58, 237, 0.1);
    }
  }

  /* üåü BOTONES CON EFECTO NEO-GLASS Y SHIMMER */
  button,
  [onclick]:not(input):not(select):not(textarea) {
    position: relative;
    overflow: hidden;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  button::before,
  [onclick]:not(input):not(select):not(textarea)::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(
      90deg,
      transparent,
      rgba(255, 255, 255, 0.3),
      transparent
    );
    transition: left 0.5s ease;
  }

  button:hover::before,
  [onclick]:not(input):not(select):not(textarea):hover::before {
    left: 100%;
  }

  button:hover,
  [onclick]:not(input):not(select):not(textarea):hover {
    transform: translateY(-2px) scale(1.02);
    box-shadow: 0 8px 24px rgba(124, 58, 237, 0.25);
    filter: brightness(1.05);
  }

  button:active,
  [onclick]:not(input):not(select):not(textarea):active {
    transform: translateY(0) scale(0.98);
    box-shadow: 0 2px 8px rgba(124, 58, 237, 0.2);
  }

  /* üéØ TABS CON EFECTO GRADIENT SHIFT ANIMADO */
  [onclick*="cambiarPestana"][style*="linear-gradient"] {
    background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 50%, #5b21b6 100%) !important;
    background-size: 200% 200%;
    animation: gradientShift 3s ease infinite;
    position: relative;
  }

  @keyframes gradientShift {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
  }

  /* Efecto de luz en tab activo */
  [onclick*="cambiarPestana"][style*="linear-gradient"]::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.8), transparent);
    animation: lightSweep 2s ease-in-out infinite;
  }

  @keyframes lightSweep {
    0%, 100% { opacity: 0; transform: translateX(-100%); }
    50% { opacity: 1; transform: translateX(100%); }
  }

  /* üíé EFECTOS DE CHECKBOX Y RADIO PREMIUM */
  input[type="checkbox"],
  input[type="radio"] {
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
  }

  input[type="checkbox"]:checked,
  input[type="radio"]:checked {
    animation: checkboxPop 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
  }

  @keyframes checkboxPop {
    0% { transform: scale(1); }
    50% { transform: scale(1.2) rotate(5deg); }
    100% { transform: scale(1) rotate(0deg); }
  }

  input[type="checkbox"]:hover,
  input[type="radio"]:hover {
    transform: scale(1.1);
    filter: drop-shadow(0 2px 4px rgba(124, 58, 237, 0.3));
  }

  /* üåà SELECTS CON EFECTO PREMIUM */
  select {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    background: linear-gradient(135deg, #ffffff 0%, #fafafa 100%) !important;
    cursor: pointer;
  }

  select:hover {
    background: linear-gradient(135deg, #faf5ff 0%, #f3f4f6 100%) !important;
    border-color: #a78bfa !important;
    box-shadow: 0 4px 12px rgba(124, 58, 237, 0.15);
    transform: translateY(-1px);
  }

  select:focus {
    background: linear-gradient(135deg, #ffffff 0%, #faf5ff 100%) !important;
    border-color: #7c3aed !important;
    box-shadow: 0 0 0 4px rgba(124, 58, 237, 0.1), 0 8px 20px rgba(124, 58, 237, 0.2);
    transform: scale(1.02);
  }

  /* üé≠ LABELS CON EFECTO FLOAT Y GRADIENT TEXT */
  label {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
  }

  label:has(+ input:focus),
  label:has(+ select:focus),
  label:has(+ textarea:focus) {
    background: linear-gradient(135deg, #7c3aed 0%, #a78bfa 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    font-weight: 700;
    transform: scale(1.02);
  }

  /* ‚ú® SMOOTH SCROLL BEHAVIOR */
  * {
    scroll-behavior: smooth;
  }

  /* üé™ MODAL/WINDOW ENTRANCE ANIMATION */
  [id*="Window"][style*="display: block"],
  [id*="Modal"][style*="display: block"] {
    animation: modalSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }

  @keyframes modalSlideIn {
    from {
      opacity: 0;
      transform: translateY(30px) scale(0.95);
    }
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }

  /* üí´ LOADING STATE PARA INPUTS */
  input[readonly],
  select[disabled],
  textarea[readonly] {
    background: repeating-linear-gradient(
      45deg,
      #fafafa,
      #fafafa 10px,
      #f5f5f5 10px,
      #f5f5f5 20px
    ) !important;
    opacity: 0.7;
    cursor: not-allowed;
  }

  /* üé® HOVER EFFECT EN FILAS DE TABLAS */
  tr:hover {
    background: linear-gradient(135deg, #faf5ff 0%, #f3f4f6 100%) !important;
    transform: scale(1.01);
    box-shadow: 0 4px 12px rgba(124, 58, 237, 0.1);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  /* üåü SCROLLBAR PERSONALIZADO ULTRA MODERNO */
  ::-webkit-scrollbar {
    width: 10px;
    height: 10px;
  }

  ::-webkit-scrollbar-track {
    background: linear-gradient(180deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 10px;
  }

  ::-webkit-scrollbar-thumb {
    background: linear-gradient(180deg, #7c3aed 0%, #6d28d9 100%);
    border-radius: 10px;
    border: 2px solid #f8f9fa;
    transition: all 0.3s ease;
  }

  ::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(180deg, #6d28d9 0%, #5b21b6 100%);
    border-color: #e9ecef;
    box-shadow: 0 0 10px rgba(124, 58, 237, 0.5);
  }

  ::-webkit-scrollbar-thumb:active {
    background: linear-gradient(180deg, #5b21b6 0%, #4c1d95 100%);
  }

  /* üî• FOCUS VISIBLE PARA ACCESIBILIDAD MODERNA */
  *:focus-visible {
    outline: 3px solid #a78bfa;
    outline-offset: 3px;
    border-radius: 4px;
    animation: focusPulse 1.5s ease-in-out infinite;
  }

  @keyframes focusPulse {
    0%, 100% { outline-color: #a78bfa; }
    50% { outline-color: #7c3aed; }
  }

  /* üíé CARD ELEVATIONS CON M√öLTIPLES CAPAS */
  .card,
  [class*="card"],
  [id*="card"] {
    box-shadow:
      0 1px 3px rgba(0,0,0,0.05),
      0 10px 25px rgba(124, 58, 237, 0.08),
      0 20px 40px rgba(124, 58, 237, 0.05),
      inset 0 1px 0 rgba(255,255,255,0.9);
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .card:hover,
  [class*="card"]:hover,
  [id*="card"]:hover {
    box-shadow:
      0 2px 6px rgba(0,0,0,0.08),
      0 15px 35px rgba(124, 58, 237, 0.12),
      0 25px 50px rgba(124, 58, 237, 0.08),
      inset 0 1px 0 rgba(255,255,255,1);
    transform: translateY(-4px) scale(1.01);
  }

  /* üéØ PULSE EFFECT PARA ELEMENTOS IMPORTANTES */
  .pulse-effect,
  [data-important="true"] {
    animation: gentlePulse 2s ease-in-out infinite;
  }

  @keyframes gentlePulse {
    0%, 100% {
      box-shadow: 0 0 0 0 rgba(124, 58, 237, 0.4);
    }
    50% {
      box-shadow: 0 0 0 10px rgba(124, 58, 237, 0);
    }
  }

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  /* FIN DE DISE√ëOS ULTRA MODERNOS "ARTISTA √öNICO" */
  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

  .rx-grid div {
    display: block !important;
    visibility: visible !important;
  }


  /* ===== HISTORIAL ===== */
  .historial-item {
    display: flex;
    align-items: center;
    padding: 12px;
    background: var(--gray-50);
    border-radius: 8px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    border: 1px solid var(--gray-200);
  }

  .historial-item:hover {
    background: var(--purple-50);
    border-color: var(--purple-300);
    transform: translateX(4px);
  }

  .historial-item.selected {
    background: var(--purple-100);
    border-color: var(--purple-500);
    box-shadow: 0 0 0 3px rgba(147, 51, 234, 0.2);
  }

  .historial-codigo { font-weight: 700; color: var(--purple-700); width: 110px; }
  .historial-fecha { color: var(--gray-600); width: 100px; }
  .historial-especialista { flex: 1; color: var(--gray-700); }

  /* ===== TOOLBAR RX ===== */
  .rx-toolbar {
    display: flex;
    gap: 15px;
    padding: 20px 25px;
    background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
    border-top: 3px solid #3b82f6;
    box-shadow: 0 -4px 20px rgba(59, 130, 246, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.1);
    position: sticky;
    bottom: 0;
    z-index: 100;
  }

  .rx-toolbar button {
    flex: 1;
    max-width: 200px;
    padding: 16px 24px !important;
    font-size: 15px !important;
    font-weight: 800 !important;
    border-radius: 12px !important;
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3), inset 0 1px 2px rgba(255, 255, 255, 0.2) !important;
    transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) !important;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border: none !important;
    position: relative;
    overflow: hidden;
  }

  .rx-toolbar button::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.3);
    transform: translate(-50%, -50%);
    transition: width 0.6s, height 0.6s;
  }

  .rx-toolbar button:hover::before {
    width: 300px;
    height: 300px;
  }

  .rx-toolbar button:hover {
    transform: translateY(-4px) scale(1.05);
    box-shadow: 0 12px 35px rgba(0, 0, 0, 0.4), inset 0 1px 2px rgba(255, 255, 255, 0.3) !important;
  }

  .rx-toolbar button:active {
    transform: translateY(-1px) scale(1.02);
  }

  /* ===== TOAST ===== */
  .toast {
    position: fixed;
    bottom: 25px;
    right: 25px;
    padding: 16px 28px;
    background: var(--gray-800);
    color: white;
    border-radius: 10px;
    box-shadow: 0 8px 30px rgba(0,0,0,0.3);
    z-index: 9999;
    animation: slideIn 0.3s ease;
    font-weight: 500;
  }

  .toast.success { background: linear-gradient(135deg, #22c55e, #16a34a); }
  .toast.error { background: linear-gradient(135deg, #ef4444, #dc2626); }
  .toast.warning { background: linear-gradient(135deg, #f59e0b, #d97706); }

  @keyframes slideIn {
    from { transform: translateX(120%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }

  /* ===== SECCI√ìN BUSCAR VENTAS MEJORADA ===== */
  .filter-section {
    background: var(--purple-50);
    border: 1px solid var(--purple-200);
    border-radius: 10px;
    padding: 16px;
    margin-bottom: 16px;
  }

  .filter-row {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    align-items: flex-end;
  }

  .action-bar {
    display: flex;
    gap: 8px;
    padding: 14px;
    background: var(--gray-100);
    border-radius: 10px;
    margin-top: 14px;
    flex-wrap: wrap;
  }

  .action-bar .btn {
    flex: 0 0 auto;
  }

  /* ===== CHECKBOX ESTILIZADO ===== */
  .checkbox-wrapper {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .checkbox-wrapper input[type="checkbox"] {
    width: 18px;
    height: 18px;
    accent-color: var(--purple-600);
  }

  /* ===== PAGINACI√ìN ===== */
  .pagination {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 14px;
  }

  .pagination button {
    width: 36px;
    height: 36px;
    border-radius: 8px;
    border: 1px solid var(--gray-300);
    background: white;
    cursor: pointer;
    font-size: 16px;
    transition: all 0.2s;
  }

  .pagination button:hover {
    background: var(--purple-100);
    border-color: var(--purple-400);
  }

  .pagination span {
    font-size: 13px;
    color: var(--gray-600);
  }

  /* ===== RESUMEN CARDS ===== */
  .summary-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 12px;
    margin-bottom: 16px;
  }

  .summary-card {
    background: white;
    border-radius: 10px;
    padding: 14px;
    text-align: center;
    border: 1px solid var(--gray-200);
  }

  .summary-card .value {
    font-size: 24px;
    font-weight: 700;
    color: var(--purple-700);
  }

  .summary-card .label {
    font-size: 11px;
    color: var(--gray-500);
    text-transform: uppercase;
    margin-top: 4px;
  }

  .summary-card.success .value { color: #16a34a; }
  .summary-card.warning .value { color: #d97706; }
  .summary-card.danger .value { color: #dc2626; }

  /* ===== PRINT STYLES - OPTIMIZADO PARA A4 ===== */
  @media print {
    * {
      -webkit-print-color-adjust: exact !important;
      print-color-adjust: exact !important;
    }

    body * { visibility: hidden; }
    #printArea, #printArea * { visibility: visible; }
    #printArea {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      background: white !important;
    }

    /* Ocultar elementos que no deben imprimirse */
    #logoPrincipalContainer,
    #logoPrincipal,
    .main-logo,
    #ribbon,
    .app-header,
    .config-float-btn {
      display: none !important;
      visibility: hidden !important;
    }

    @page {
      size: A4 portrait;
      margin: 12mm 10mm;
    }

    /* Evitar saltos de p√°gina */
    .print-rx {
      page-break-inside: avoid;
      page-break-after: auto;
    }

    .print-rx .header,
    .print-rx .patient-info,
    .print-rx .rx-table,
    .print-rx .section-title {
      page-break-inside: avoid;
    }

    /* Asegurar que todos los textos se vean n√≠tidos */
    .print-rx * {
      font-size: inherit !important;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
  }

  /* ============================================
     ESTILOS PARA IMPRESI√ìN T√âRMICA 58mm/80mm
     ULTRA COMPACTO - SIN ESPACIOS EN BLANCO
     ============================================ */
  @media print {
    /* Configuraci√≥n para impresoras t√©rmicas */
    @page {
      size: 80mm auto; /* Ancho 80mm, alto autom√°tico */
      margin: 0mm !important; /* CERO m√°rgenes */
    }

    body {
      margin: 0 !important;
      padding: 0 !important;
    }

    .print-ticket {
      width: 80mm !important;
      max-width: 80mm !important;
      margin: 0 !important;
      padding: 0 !important;
      background: white !important;
    }

    /* Eliminar TODOS los espacios innecesarios */
    .print-ticket > div {
      margin: 0 !important;
      padding: 3px 5px !important;
    }

    /* Compactar tablas al m√°ximo */
    .print-ticket table {
      font-size: 8px !important;
      margin: 0 !important;
      padding: 0 !important;
    }

    .print-ticket th,
    .print-ticket td {
      padding: 2px 4px !important;
      line-height: 1.1 !important;
    }

    /* Encabezado super compacto */
    .print-ticket div[style*="text-align: center"]:first-child {
      padding: 4px 5px !important;
    }

    /* Totales m√°s visibles pero compactos */
    .print-ticket table:last-of-type td {
      font-size: 9px !important;
      padding: 3px 6px !important;
    }

    /* Eliminar espacios entre secciones */
    * {
      margin: 0 !important;
    }

    /* Mantener solo bordes necesarios */
    .print-ticket table {
      border-collapse: collapse !important;
    }
  }

  /* Estilos para vista previa en pantalla */
  .print-ticket {
    font-family: 'Courier New', monospace;
    max-width: 300px;
    margin: 0 auto;
    padding: 10px;
    background: white;
    font-size: 12px;
    line-height: 1.4;
  }

  .print-ticket .header { text-align: center; margin-bottom: 15px; }
  .print-ticket .logo { font-size: 16px; font-weight: bold; }
  .print-ticket .address { font-size: 11px; margin: 5px 0; }
  .print-ticket .divider { border-top: 1px dashed #000; margin: 10px 0; }
  .print-ticket .info-row { display: flex; justify-content: space-between; font-size: 11px; }
  .print-ticket .items-table { width: 100%; font-size: 11px; margin: 10px 0; }
  .print-ticket .items-table th, .print-ticket .items-table td { padding: 3px 2px; text-align: left; }
  .print-ticket .items-table th { border-bottom: 1px solid #000; }
  .print-ticket .total-section { text-align: right; margin-top: 10px; }
  .print-ticket .total-line { font-size: 14px; font-weight: bold; }
  .print-ticket .footer { text-align: center; margin-top: 15px; font-size: 10px; }

  /* üé® ESTILOS PARA NOTA DE VENTA MORADA (A4 / Media Hoja) */
  .nota-venta-morada {
    width: 100% !important;
    max-width: 210mm !important;
    margin: 0 auto !important;
    padding: 10mm !important;
    background: white !important;
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
  }

  .print-rx {
    font-family: 'Segoe UI', Arial, sans-serif;
    max-width: 100%;
    margin: 0 auto;
    padding: 8mm;
    background: white;
    font-size: 11pt !important;
    line-height: 1.4;
    color: #000;
  }

  .print-rx .header {
    text-align: center;
    margin-bottom: 10px;
    border-bottom: 3px solid #4a1d96;
    padding-bottom: 8px;
  }

  .print-rx .logo {
    font-size: 18pt !important;
    font-weight: 900;
    color: #4a1d96;
    letter-spacing: 0.8px;
    margin-bottom: 4px;
  }

  .print-rx .subtitle {
    font-size: 10pt !important;
    color: #555;
    font-weight: 600;
    text-transform: uppercase;
  }

  .print-rx .address {
    font-size: 9pt !important;
    margin-top: 3px;
    color: #333;
    font-weight: 500;
  }

  .print-rx .patient-info {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    margin: 10px 0;
    padding: 8px;
    background: #f8f9fa;
    border-radius: 4px;
    border: 1px solid #dee2e6;
    font-size: 10pt;
  }

  .print-rx .patient-info p {
    margin: 3px 0;
    font-size: 11pt !important;
  }

  .print-rx .patient-info strong {
    color: #4a1d96;
    font-weight: 700;
  }

  .print-rx .section-title {
    font-weight: 800;
    background: #f3f4f6;
    color: #1f2937;
    border: 2px solid #4a1d96;
    padding: 6px;
    margin: 8px 0 5px;
    text-align: center;
    font-size: 11pt !important;
    border-radius: 3px;
    letter-spacing: 0.8px;
  }

  .print-rx .rx-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 10pt !important;
    margin-bottom: 8px;
    box-shadow: none;
  }

  .print-rx .rx-table th,
  .print-rx .rx-table td {
    border: 2px solid #333;
    padding: 5px 4px;
    text-align: center;
  }

  .print-rx .rx-table th {
    background: #e9ecef;
    font-size: 9pt !important;
    font-weight: 700;
    color: #495057;
    text-transform: uppercase;
  }

  .print-rx .rx-table td {
    background: white;
    font-size: 10pt !important;
  }

  .print-rx .rx-table td:first-child {
    font-weight: 700;
    background: #f8f9fa;
    color: #4a1d96;
    font-size: 10pt !important;
  }

  .print-rx .otros-section {
    margin: 8px 0;
    padding: 10px;
    border: 1px solid #e9ecef;
    background: #f8f9fa;
    border-radius: 4px;
  }

  .print-rx .otros-section p {
    margin: 4px 0;
    font-size: 10pt !important;
  }

  .print-rx .otros-section strong {
    color: #4a1d96;
    font-weight: 700;
  }

  .print-rx .specialist {
    text-align: center;
    margin-top: 12px;
    padding-top: 10px;
    border-top: 2px solid #4a1d96;
  }

  .print-rx .specialist p:first-child {
    font-size: 10pt !important;
    color: #666;
    font-weight: 600;
    text-transform: uppercase;
  }

  .print-rx .specialist p:last-child {
    font-size: 13pt !important;
    font-weight: 700;
    color: #4a1d96;
    margin-top: 4px;
  }

  .print-rx .next-appointment {
    text-align: center;
    margin-top: 10px;
    font-size: 10pt !important;
    background: #fff3cd;
    padding: 8px;
    border-radius: 4px;
    border: 1px solid #ffc107;
    font-weight: 600;
    color: #856404;
  }

  /* ===== CAT√ÅLOGO E INVENTARIO ===== */
  .categoria-tabs {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-bottom: 16px;
  }

  .cat-btn, .cat-btn-modal {
    padding: 10px 18px;
    border: 1px solid var(--gray-300);
    border-radius: 25px;
    background: white;
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
    color: var(--gray-600);
    transition: all 0.2s;
  }

  .cat-btn:hover, .cat-btn-modal:hover {
    background: var(--purple-50);
    border-color: var(--purple-400);
    color: var(--purple-700);
  }

  .cat-btn.active, .cat-btn-modal.active {
    background: linear-gradient(180deg, #0ea5e9 0%, #0284c7 100%);
    color: white;
    border-color: #0284c7;
  }

  .catalogo-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    max-height: 350px;
    overflow-y: auto;
    padding: 8px;
    border: 1px solid var(--gray-200);
    border-radius: 10px;
    background: var(--gray-50);
  }

  .producto-card {
    background: white;
    border: 2px solid var(--gray-200);
    border-radius: 12px;
    padding: 12px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
  }

  .producto-card:hover {
    border-color: var(--purple-400);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }

  .producto-card.selected {
    border-color: #0ea5e9;
    background: #f0f9ff;
    box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.2);
  }

  .producto-card .prod-img {
    width: 50px;
    height: 50px;
    margin: 0 auto 8px;
    background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
  }

  .producto-card .prod-img img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 50%;
  }

  .producto-card .prod-nombre {
    font-weight: 600;
    font-size: 12px;
    color: var(--gray-800);
    margin-bottom: 4px;
  }

  .producto-card .prod-precio {
    font-size: 14px;
    font-weight: 700;
    color: #16a34a;
  }

  .producto-card .prod-stock {
    font-size: 10px;
    color: var(--gray-500);
    margin-top: 2px;
  }

  /* Inventario tabla */
  .inv-img {
    width: 50px;
    height: 50px;
    background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
  }

  .inv-img img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 10px;
  }

  .inv-img.lunas { background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%); }
  .inv-img.monturas { background: linear-gradient(135deg, #a78bfa 0%, #8b5cf6 100%); }
  .inv-img.lcontacto { background: linear-gradient(135deg, #34d399 0%, #10b981 100%); }
  .inv-img.accesorios { background: linear-gradient(135deg, #f472b6 0%, #ec4899 100%); }
  .inv-img.servicios { background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); }

  .inv-nombre { font-weight: 700; color: var(--gray-800); font-size: 14px; }
  .inv-desc { font-size: 11px; color: var(--gray-500); margin-top: 2px; }

  .inv-cat {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    padding: 4px 10px;
    border-radius: 15px;
    background: var(--gray-100);
  }

  .inv-cat-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
  }
  .inv-cat-dot.lunas { background: #3b82f6; }
  .inv-cat-dot.monturas { background: #8b5cf6; }
  .inv-cat-dot.lcontacto { background: #10b981; }
  .inv-cat-dot.accesorios { background: #ec4899; }
  .inv-cat-dot.servicios { background: #f59e0b; }

  .inv-stock {
    font-weight: 700;
    font-size: 15px;
    color: var(--gray-800);
  }

  .inv-estado {
    padding: 5px 12px;
    border-radius: 15px;
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
  }

  .inv-estado.ok { background: #dcfce7; color: #16a34a; }
  .inv-estado.low { background: #fef3c7; color: #d97706; }
  .inv-estado.out { background: #fee2e2; color: #dc2626; }

  .inv-actions {
    display: flex;
    gap: 6px;
    justify-content: center;
  }

  .inv-actions button {
    width: 32px;
    height: 32px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .inv-actions .btn-edit { background: #fef3c7; color: #d97706; }
  .inv-actions .btn-add { background: #dcfce7; color: #16a34a; font-weight: 700; }
  .inv-actions .btn-sub { background: #fee2e2; color: #dc2626; font-weight: 700; }
  .inv-actions .btn-del { background: #ef4444; color: white; }

  .inv-actions button:hover { transform: scale(1.15); box-shadow: 0 2px 8px rgba(0,0,0,0.15); }

  /* Tabla de inventario mejorada */
  #inventario table tbody tr {
    transition: all 0.2s;
  }
  #inventario table tbody tr:hover {
    background: #f0f9ff;
  }

  /* ===== LUNAS SISTEMA ===== */
  .lunas-tabs { margin-bottom: 0; }
  .lunas-tab-content { display: none; padding: 16px 0; }
  .lunas-tab-content.active { display: block; }

  .lunas-categorias-tabs {
    display: flex;
    gap: 4px;
    flex-wrap: wrap;
    background: var(--gray-100);
    padding: 10px;
    border-radius: 8px;
    margin-bottom: 12px;
  }

  .luna-cat-btn {
    padding: 8px 14px;
    border: 1px solid var(--gray-300);
    border-radius: 6px;
    background: white;
    cursor: pointer;
    font-size: 11px;
    font-weight: 600;
    color: var(--gray-600);
    transition: all 0.2s;
  }

  .luna-cat-btn:hover {
    background: #e0f2fe;
    border-color: #0ea5e9;
    color: #0284c7;
  }

  .luna-cat-btn.active {
    background: linear-gradient(180deg, #0ea5e9 0%, #0284c7 100%);
    color: white;
    border-color: #0284c7;
  }

  /* Botones de Inventario de Lunas */
  .luna-inv-btn {
    padding: 8px 14px;
    border: 1px solid var(--gray-300);
    border-radius: 6px;
    background: white;
    cursor: pointer;
    font-size: 11px;
    font-weight: 600;
    color: var(--gray-600);
    transition: all 0.2s;
  }

  .luna-inv-btn:hover {
    background: #fef3c7;
    border-color: #f59e0b;
    color: #d97706;
  }

  .luna-inv-btn.active {
    background: linear-gradient(180deg, #f59e0b 0%, #d97706 100%);
    color: white;
    border-color: #d97706;
  }

  .catalogo-lunas-container {
    max-height: 350px;
    overflow-y: auto;
    border: 1px solid var(--gray-200);
    border-radius: 8px;
  }

  .stock-input {
    width: 70px;
    text-align: center;
    padding: 6px;
    border-radius: 4px;
    border: 1px solid var(--gray-300);
  }

  .stock-badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 700;
  }

  .stock-alto { background: #dcfce7; color: #166534; }
  .stock-medio { background: #fef9c3; color: #854d0e; }
  .stock-bajo { background: #fee2e2; color: #991b1b; }
  .stock-cero { background: #f3f4f6; color: #6b7280; }

  /* Selector Lunas Modal */
  .selector-lunas-container {
    display: flex;
    gap: 16px;
    height: 450px;
  }

  .selector-lunas-left {
    width: 220px;
    border: 1px solid var(--gray-200);
    border-radius: 10px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  .selector-lunas-left h4 {
    padding: 12px;
    background: linear-gradient(180deg, #0ea5e9 0%, #0284c7 100%);
    color: white;
    font-size: 13px;
    margin: 0;
  }

  .selector-lunas-list {
    flex: 1;
    overflow-y: auto;
    background: white;
  }

  .selector-lunas-item {
    padding: 10px 12px;
    border-bottom: 1px solid var(--gray-100);
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
    transition: background 0.2s;
  }

  .selector-lunas-item:hover { background: #f0f9ff; }
  .selector-lunas-item.selected { background: #dbeafe; color: #1d4ed8; font-weight: 600; }

  .selector-lunas-item input[type="checkbox"] {
    width: 16px;
    height: 16px;
    accent-color: #0ea5e9;
  }

  .selector-lunas-right {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .selector-medidas-box {
    background: var(--gray-50);
    border: 1px solid var(--gray-200);
    border-radius: 10px;
    padding: 14px;
  }

  .selector-medidas-box h5 {
    font-size: 12px;
    color: var(--gray-700);
    margin: 0 0 10px;
    border-bottom: 2px solid var(--purple-400);
    padding-bottom: 6px;
  }

  .medidas-grid {
    display: grid;
    grid-template-columns: 80px 1fr 1fr 1fr 1fr;
    gap: 6px;
    align-items: center;
  }

  .medidas-grid label {
    font-size: 11px;
    font-weight: 600;
    color: var(--gray-600);
    margin: 0;
  }

  .medidas-grid input, .medidas-grid select {
    padding: 6px 8px;
    font-size: 12px;
  }

  .luna-precio-calculado {
    background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
    border: 2px solid #22c55e;
    border-radius: 10px;
    padding: 16px;
    text-align: center;
  }

  .luna-precio-calculado .precio-label {
    font-size: 12px;
    color: var(--gray-600);
    text-transform: uppercase;
  }

  .luna-precio-calculado .precio-valor {
    font-size: 32px;
    font-weight: 700;
    color: #16a34a;
    margin-top: 4px;
  }

  .luna-resumen {
    background: #eff6ff;
    border: 1px solid #bfdbfe;
    border-radius: 8px;
    padding: 12px;
    font-size: 12px;
  }

  .luna-resumen p { margin: 4px 0; }
  .luna-resumen strong { color: #1d4ed8; }

  /* ===== ALMAC√âN SISTEMA ===== */
  .almacen-tabs {
    display: flex;
    gap: 0;
    background: var(--gray-100);
    border-radius: 10px 10px 0 0;
    overflow: hidden;
    margin-bottom: 0;
  }

  .almacen-tab-btn {
    flex: 1;
    padding: 14px 12px;
    border: none;
    background: var(--gray-100);
    cursor: pointer;
    font-size: 12px;
    font-weight: 600;
    color: var(--gray-600);
    transition: all 0.2s;
    border-bottom: 3px solid transparent;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
  }

  .almacen-tab-btn:hover {
    background: var(--purple-100);
    color: var(--purple-700);
  }

  .almacen-tab-btn.active {
    background: white;
    color: var(--purple-700);
    border-bottom-color: var(--purple-600);
  }

  .almacen-tab-btn .tab-icon { font-size: 20px; }

  .almacen-tab-content {
    display: none;
    padding: 16px;
    background: white;
    border: 1px solid var(--gray-200);
    border-top: none;
    border-radius: 0 0 10px 10px;
  }

  .almacen-tab-content.active { display: block; }

  /* Formulario de movimiento */
  .mov-header {
    display: flex;
    gap: 12px;
    margin-bottom: 16px;
    padding: 14px;
    background: linear-gradient(180deg, var(--purple-50) 0%, white 100%);
    border-radius: 8px;
    border: 1px solid var(--purple-200);
  }

  .mov-tipo-box {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-bottom: 12px;
  }

  .mov-tipo-btn {
    padding: 10px 16px;
    border: 2px solid var(--gray-300);
    border-radius: 8px;
    background: white;
    cursor: pointer;
    font-size: 12px;
    font-weight: 600;
    color: var(--gray-600);
    transition: all 0.2s;
  }

  .mov-tipo-btn:hover {
    border-color: var(--purple-400);
    background: var(--purple-50);
  }

  .mov-tipo-btn.active {
    border-color: var(--purple-600);
    background: var(--purple-600);
    color: white;
  }

  .mov-tipo-btn.ingreso.active {
    border-color: #22c55e;
    background: #22c55e;
  }

  .mov-tipo-btn.salida.active {
    border-color: #ef4444;
    background: #ef4444;
  }

  /* Tabla de productos en movimiento */
  .mov-productos-table {
    background: white;
    border-radius: 8px;
    overflow: hidden;
    border: 1px solid var(--gray-200);
  }

  .mov-productos-table table { margin: 0; }

  /* B√∫squeda de productos */
  .buscar-prod-container {
    display: flex;
    gap: 10px;
    align-items: center;
    margin-bottom: 12px;
  }

  .buscar-prod-container input {
    flex: 1;
    max-width: 350px;
  }

  .buscar-prod-container select {
    width: 160px;
  }

  /* Kardex */
  .kardex-filtros {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    padding: 14px;
    background: var(--gray-50);
    border-radius: 8px;
    margin-bottom: 12px;
  }

  .kardex-filtros .field { flex: 1; min-width: 180px; max-width: 250px; }

  .kardex-resumen {
    display: flex;
    gap: 12px;
    margin-bottom: 12px;
  }

  .kardex-card {
    flex: 1;
    padding: 14px;
    border-radius: 8px;
    text-align: center;
  }

  .kardex-card.entradas {
    background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
    border: 1px solid #22c55e;
  }

  .kardex-card.salidas {
    background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
    border: 1px solid #ef4444;
  }

  .kardex-card.stock {
    background: linear-gradient(135deg, var(--purple-100) 0%, var(--purple-200) 100%);
    border: 1px solid var(--purple-500);
  }

  .kardex-card .k-value { font-size: 24px; font-weight: 700; }
  .kardex-card .k-label { font-size: 11px; color: var(--gray-600); text-transform: uppercase; }

  .kardex-card.entradas .k-value { color: #16a34a; }
  .kardex-card.salidas .k-value { color: #dc2626; }
  .kardex-card.stock .k-value { color: var(--purple-700); }

  /* Gu√≠as de remisi√≥n */
  .guia-estado { padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; }
  .guia-estado.pendiente { background: #fef3c7; color: #d97706; }
  .guia-estado.enviada { background: #dbeafe; color: #2563eb; }
  .guia-estado.entregada { background: #dcfce7; color: #16a34a; }
  .guia-estado.anulada { background: #fee2e2; color: #dc2626; }

  /* Modal buscar productos */
  .buscar-prod-modal .search-filters {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-bottom: 14px;
    padding: 12px;
    background: var(--gray-50);
    border-radius: 8px;
  }

  .buscar-prod-modal .search-filters .field { flex: 1; min-width: 150px; }

  .prod-results-list {
    max-height: 350px;
    overflow-y: auto;
    border: 1px solid var(--gray-200);
    border-radius: 8px;
  }

  .prod-result-item {
    padding: 10px 14px;
    border-bottom: 1px solid var(--gray-100);
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 12px;
    transition: background 0.2s;
  }

  .prod-result-item:hover { background: var(--purple-50); }
  .prod-result-item.selected { background: var(--purple-100); border-left: 3px solid var(--purple-600); }

  .prod-result-item .prod-img {
    width: 45px;
    height: 45px;
    border-radius: 6px;
    object-fit: cover;
    background: var(--gray-200);
  }

  .prod-result-item .prod-info { flex: 1; }
  .prod-result-item .prod-nombre { font-weight: 600; color: var(--gray-800); font-size: 13px; }
  .prod-result-item .prod-codigo { font-size: 11px; color: var(--gray-500); }
  .prod-result-item .prod-stock {
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    background: var(--purple-100);
    color: var(--purple-700);
  }

  /* ===== REPORTES SISTEMA ===== */
  .reportes-tabs {
    display: flex;
    gap: 0;
    background: var(--gray-100);
    border-radius: 10px 10px 0 0;
    overflow: hidden;
    margin-bottom: 0;
  }

  .reportes-tab-btn {
    flex: 1;
    padding: 14px 12px;
    border: none;
    background: var(--gray-100);
    cursor: pointer;
    font-size: 12px;
    font-weight: 600;
    color: var(--gray-600);
    transition: all 0.2s;
    border-bottom: 3px solid transparent;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
  }

  .reportes-tab-btn:hover {
    background: var(--purple-100);
    color: var(--purple-700);
  }

  .reportes-tab-btn.active {
    background: white;
    color: var(--purple-700);
    border-bottom-color: var(--purple-600);
  }

  .reportes-tab-btn .tab-icon { font-size: 20px; }

  .reportes-tab-content {
    display: none;
    padding: 16px;
    background: white;
    border: 1px solid var(--gray-200);
    border-top: none;
    border-radius: 0 0 10px 10px;
  }

  .reportes-tab-content.active { display: block; }

  /* Filtros de reporte */
  .reporte-filtros {
    background: #fffef0;
    border: 1px solid #fde68a;
    border-radius: 10px;
    padding: 16px;
    margin-bottom: 16px;
  }

  .reporte-filtros .section-title {
    color: #d97706;
    font-weight: 700;
    font-size: 12px;
    margin-bottom: 12px;
    text-transform: uppercase;
  }

  .reporte-opciones {
    display: flex;
    gap: 20px;
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid #fde68a;
  }

  .reporte-opciones label {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
    cursor: pointer;
  }

  .reporte-opciones input[type="radio"],
  .reporte-opciones input[type="checkbox"] {
    width: 16px;
    height: 16px;
    accent-color: var(--purple-600);
  }

  .reporte-acciones {
    display: flex;
    gap: 10px;
    justify-content: center;
    padding: 16px;
    background: #fffef0;
    border-radius: 0 0 10px 10px;
    margin-top: -1px;
  }

  /* Vista previa del reporte */
  .reporte-preview {
    background: white;
    border: 1px solid var(--gray-300);
    border-radius: 8px;
    padding: 20px;
    margin-top: 16px;
    min-height: 300px;
  }

  .reporte-header {
    text-align: center;
    border-bottom: 2px solid #333;
    padding-bottom: 15px;
    margin-bottom: 20px;
  }

  .reporte-header h2 {
    font-size: 18px;
    color: #333;
    margin: 0 0 5px;
  }

  .reporte-header .subtitulo {
    font-size: 12px;
    color: #666;
  }

  .reporte-header .periodo {
    font-size: 11px;
    color: #888;
    margin-top: 5px;
  }

  .reporte-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 11px;
    margin-bottom: 15px;
  }

  .reporte-table th {
    background: #e0f2fe;
    color: #0369a1;
    padding: 8px 6px;
    text-align: left;
    font-size: 10px;
    border: 1px solid #bae6fd;
  }

  .reporte-table td {
    padding: 6px;
    border: 1px solid #e5e7eb;
  }

  .reporte-table tbody tr:nth-child(even) {
    background: #f9fafb;
  }

  .reporte-table tfoot td {
    background: #f0f9ff;
    font-weight: 700;
  }

  .reporte-footer {
    display: flex;
    justify-content: space-between;
    font-size: 10px;
    color: #666;
    padding-top: 15px;
    border-top: 1px solid #ddd;
    margin-top: 20px;
  }

  /* Print reporte styles */
  .print-reporte {
    font-family: Arial, sans-serif;
    max-width: 100%;
    padding: 20px;
    background: white;
    font-size: 11px;
  }

  .print-reporte .empresa {
    text-align: center;
    font-size: 16px;
    font-weight: bold;
    margin-bottom: 5px;
  }

  .print-reporte .titulo-reporte {
    text-align: right;
    font-size: 11px;
    color: #666;
  }

  @media print {
    .print-reporte { page-break-inside: avoid; }
  }

  /* ==================== ESTILOS IMPORTACI√ìN AVANZADA ==================== */
  .import-wizard {
    background: linear-gradient(135deg, #f0fdf4 0%, #ecfeff 100%);
    border: 2px solid #86efac;
    border-radius: 12px;
    padding: 20px;
    min-height: 500px;
  }

  .wizard-steps {
    display: flex;
    justify-content: center;
    gap: 40px;
    margin-bottom: 24px;
    padding: 16px;
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }

  .wizard-step {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 20px;
    border-radius: 25px;
    background: #e2e8f0;
    color: #64748b;
    font-weight: 600;
    transition: all 0.3s ease;
  }

  .wizard-step.active {
    background: linear-gradient(135deg, var(--purple-600), var(--purple-700));
    color: white;
    box-shadow: 0 4px 12px rgba(147, 51, 234, 0.4);
  }

  .wizard-step.completed {
    background: #22c55e;
    color: white;
  }

  .step-number {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: rgba(255,255,255,0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
  }

  .wizard-content {
    display: none;
    animation: fadeIn 0.3s ease;
  }

  .wizard-content.active {
    display: block;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .wizard-title {
    color: var(--purple-700);
    font-size: 18px;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 2px solid var(--purple-200);
  }

  /* Bienvenida */
  .import-welcome {
    text-align: center;
    padding: 20px;
  }

  .import-icon {
    font-size: 80px;
    margin-bottom: 20px;
  }

  .import-welcome h2 {
    color: var(--purple-700);
    margin-bottom: 24px;
  }

  .import-info {
    background: white;
    border-radius: 10px;
    padding: 20px;
    text-align: left;
    max-width: 700px;
    margin: 0 auto 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }

  .import-info h3 {
    color: #333;
    margin-bottom: 15px;
  }

  .import-info ul {
    list-style: none;
    padding: 0;
  }

  .import-info li {
    padding: 8px 0;
    padding-left: 25px;
    position: relative;
  }

  .import-info li::before {
    content: "‚Ä¢";
    position: absolute;
    left: 8px;
    font-weight: bold;
  }

  .import-info li.text-success { color: #16a34a; }
  .import-info li.text-primary { color: #2563eb; }
  .import-info li.text-warning { color: #ca8a04; }

  .import-note {
    margin-top: 15px;
    padding: 10px;
    background: #dbeafe;
    border-radius: 6px;
    color: #1e40af;
    font-size: 13px;
  }

  .import-warning {
    background: #fef3c7;
    border: 1px solid #fcd34d;
    border-radius: 8px;
    padding: 15px;
    color: #92400e;
    max-width: 700px;
    margin: 0 auto;
  }

  /* Selector de Tipo de Importaci√≥n */
  .import-type-selector {
    max-width: 600px;
    margin: 0 auto 24px;
  }

  .import-type-selector h3 {
    color: var(--gray-700);
    margin-bottom: 16px;
  }

  .import-type-options {
    display: flex;
    gap: 20px;
    justify-content: center;
  }

  .import-type-option {
    flex: 1;
    max-width: 200px;
    background: white;
    border: 3px solid var(--gray-200);
    border-radius: 16px;
    padding: 20px 12px;
    cursor: pointer;
    transition: all 0.3s;
    text-align: center;
  }

  .import-type-option:hover {
    border-color: var(--purple-400);
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(124, 58, 237, 0.15);
  }

  .import-type-option.active {
    border-color: var(--purple-600);
    background: linear-gradient(180deg, var(--purple-50) 0%, white 100%);
    box-shadow: 0 4px 15px rgba(124, 58, 237, 0.2);
  }

  .import-type-option input[type="radio"] {
    display: none;
  }

  .import-type-icon {
    font-size: 50px;
    margin-bottom: 12px;
  }

  .import-type-label {
    font-size: 18px;
    font-weight: 700;
    color: var(--gray-800);
    margin-bottom: 6px;
  }

  .import-type-desc {
    font-size: 12px;
    color: var(--gray-500);
  }

  .import-type-option.active .import-type-label {
    color: var(--purple-700);
  }

  /* Formulario de carga */
  .import-form {
    background: white;
    border-radius: 10px;
    padding: 24px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }

  .field-row {
    margin-bottom: 16px;
  }

  .field-row label {
    display: block;
    font-weight: 600;
    color: #374151;
    margin-bottom: 6px;
  }

  .field-row input[type="text"] {
    width: 100%;
    max-width: 400px;
    padding: 7px 14px;
    border: 2px solid #d1d5db;
    border-radius: 6px;
    font-size: 12px;
  }

  .file-input-wrapper {
    display: flex;
    gap: 10px;
    align-items: center;
  }

  .file-input-wrapper input[type="text"] {
    flex: 1;
    max-width: none;
    background: #f0fdf4;
    border-color: #86efac;
  }

  .import-preview-area {
    margin-top: 20px;
    min-height: 300px;
    max-height: 400px;
    overflow: auto;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    padding: 16px;
    background: #fafafa;
  }

  .import-preview-area table {
    width: 100%;
    border-collapse: collapse;
    font-size: 12px;
  }

  .import-preview-area th {
    background: var(--purple-600);
    color: white;
    padding: 8px;
    text-align: left;
    position: sticky;
    top: 0;
  }

  .import-preview-area td {
    padding: 6px 8px;
    border-bottom: 1px solid #e5e7eb;
  }

  .import-preview-area tr:nth-child(even) {
    background: #f3f4f6;
  }

  /* Asignaci√≥n de columnas */
  .import-columns-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;
  }

  .import-mapping-table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }

  .import-mapping-table th,
  .import-mapping-table td {
    padding: 6px 12px;
    text-align: left;
    border-bottom: 1px solid #e5e7eb;
  }

  .import-mapping-table td:first-child {
    font-weight: 600;
    color: #374151;
    background: #f9fafb;
  }

  .map-select {
    width: 100%;
    padding: 8px;
    border: 1px solid #d1d5db;
    border-radius: 4px;
    font-size: 13px;
    background: white;
  }

  .import-columns-right {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .import-option-check {
    background: white;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }

  .import-option-check label {
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
    font-weight: 500;
  }

  .import-prices-box {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border: 2px solid #e5e7eb;
  }

  .price-row {
    display: flex;
    align-items: center;
    margin-bottom: 12px;
  }

  .price-row:last-child {
    margin-bottom: 0;
  }

  .price-row label {
    width: 140px;
    font-weight: 500;
    color: #374151;
  }

  .price-row select {
    flex: 1;
  }

  /* Paso 3: Procesar */
  .import-process-grid {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 16px;
    margin-bottom: 20px;
  }

  .process-column h4 {
    background: #1e3a5f;
    color: white;
    padding: 10px;
    margin: 0;
    font-size: 13px;
    text-align: center;
  }

  .process-output {
    background: white;
    border: 2px solid #d1d5db;
    min-height: 200px;
    max-height: 250px;
    overflow: auto;
    padding: 10px;
    font-size: 12px;
    font-family: monospace;
  }

  .process-output.process-errors {
    background: #fef2f2;
    border-color: #fca5a5;
  }

  .process-progress {
    height: 20px;
    background: #e5e7eb;
    border: 1px solid #d1d5db;
    margin-top: -2px;
  }

  .progress-bar {
    height: 100%;
    width: 0%;
    background: linear-gradient(90deg, #22c55e, #16a34a);
    transition: width 0.3s ease;
  }

  .mini-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 11px;
  }

  .mini-table th {
    background: #374151;
    color: white;
    padding: 6px;
  }

  .mini-table td {
    padding: 4px 6px;
    border-bottom: 1px solid #e5e7eb;
  }

  .import-process-actions {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-top: 20px;
  }

  .btn-lg {
    padding: 14px 40px;
    font-size: 16px;
  }

  .import-result-message {
    margin-top: 20px;
    padding: 15px;
    border-radius: 8px;
    text-align: center;
    font-weight: 600;
  }

  .import-result-message.success {
    background: #dcfce7;
    color: #166534;
    border: 2px solid #86efac;
  }

  .import-result-message.error {
    background: #fef2f2;
    color: #991b1b;
    border: 2px solid #fca5a5;
  }

  /* Navegaci√≥n del wizard */
  .wizard-navigation {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 24px;
    padding-top: 20px;
    border-top: 2px solid #d1d5db;
  }

  .wizard-navigation .btn {
    min-width: 140px;
  }

  /* ==================== M√ìDULO DE CONFIGURACI√ìN ==================== */
  .config-tabs {
    display: flex;
    gap: 4px;
    background: #e5e7eb;
    padding: 8px;
    border-radius: 8px;
    margin-bottom: 16px;
  }

  .config-tab-btn {
    padding: 10px 16px;
    border: none;
    background: white;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    color: #374151;
    transition: all 0.2s;
  }

  .config-tab-btn:hover {
    background: #f3e8ff;
  }

  .config-tab-btn.active {
    background: #6b21a8;
    color: white;
  }

  .config-tab-content {
    display: none;
  }

  .config-tab-content.active {
    display: block;
  }

  .config-toolbar {
    display: flex;
    gap: 8px;
    padding: 12px;
    background: #f9fafb;
    border-radius: 8px;
    margin-bottom: 16px;
  }

  .config-table-container {
    max-height: 400px;
    overflow-y: auto;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
  }

  .config-table-container table {
    width: 100%;
    border-collapse: collapse;
  }

  .config-table-container th {
    background: #f97316;
    color: white;
    padding: 10px;
    text-align: left;
    position: sticky;
    top: 0;
  }

  .config-table-container td {
    padding: 6px;
    border-bottom: 1px solid #e5e7eb;
  }

  .config-table-container tr:hover {
    background: #fff7ed;
  }

  .config-table-container tr.selected {
    background: #fed7aa;
  }

  .config-footer {
    padding: 12px;
    background: #ecfdf5;
    border-radius: 8px;
    margin-top: 16px;
    color: #166534;
    font-weight: 600;
  }

  .config-info-banner {
    background: #fef3c7;
    border: 1px solid #f59e0b;
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 16px;
    color: #92400e;
  }

  .config-split-panel {
    display: flex;
    gap: 16px;
    min-height: 350px;
  }

  .config-panel-left {
    flex: 0 0 250px;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    overflow: hidden;
  }

  .config-panel-right {
    flex: 1;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 16px;
  }

  .config-panel-right h4 {
    margin: 0 0 12px 0;
    color: #6b21a8;
  }

  .config-search {
    width: 100%;
    padding: 10px;
    border: none;
    border-bottom: 1px solid #e5e7eb;
    outline: none;
  }

  .config-user-list {
    max-height: 300px;
    overflow-y: auto;
  }

  .config-user-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 12px;
    cursor: pointer;
    border-bottom: 1px solid #f3f4f6;
    transition: background 0.2s;
  }

  .config-user-item:hover {
    background: #f3e8ff;
  }

  .config-user-item.selected {
    background: #e9d5ff;
  }

  .config-user-item .user-icon {
    font-size: 20px;
  }

  .config-almacen-list, .config-caja-list {
    min-height: 150px;
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    margin-bottom: 12px;
  }

  .config-almacen-item, .config-caja-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 12px;
    border-bottom: 1px solid #f3f4f6;
  }

  .config-almacen-actions, .config-caja-actions {
    display: flex;
    gap: 8px;
  }

  .config-almacen-actions select, .config-caja-actions select {
    flex: 1;
    padding: 8px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
  }

  .config-login-box {
    border: 1px solid #d1d5db;
    border-radius: 8px;
    padding: 16px;
    margin-top: 16px;
    background: #f9fafb;
  }

  /* Radio para selecci√≥n en tablas */
  .config-radio {
    width: 18px;
    height: 18px;
    cursor: pointer;
  }
  /* ==================== PANTALLA DE LOGIN ULTRA MODERNA ==================== */
  /* ===== GLASSMORPHISM & ANIMACIONES AVANZADAS ===== */

  @keyframes gradientShift {
    0%, 100% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
  }

  @keyframes floatingParticles {
    0%, 100% { transform: translateY(0px) rotate(0deg); opacity: 0.7; }
    25% { transform: translateY(-20px) rotate(90deg); opacity: 1; }
    50% { transform: translateY(-10px) rotate(180deg); opacity: 0.8; }
    75% { transform: translateY(-30px) rotate(270deg); opacity: 0.9; }
  }

  .login-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(-45deg, #667eea 0%, #764ba2 25%, #f093fb 50%, #4facfe 75%, #00f2fe 100%);
    background-size: 400% 400%;
    animation: gradientShift 15s ease infinite;
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10000;
    transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    overflow: hidden;
  }

  .login-overlay::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1600 900"><defs><filter id="goo"><feGaussianBlur in="SourceGraphic" stdDeviation="10" result="blur" /><feColorMatrix in="blur" mode="matrix" values="1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 18 -7" result="goo" /><feBlend in="SourceGraphic" in2="goo" /></filter></defs><g filter="url(%23goo)"><circle cx="150" cy="150" r="80" fill="%23ffffff" opacity="0.08"><animate attributeName="cx" values="150;1450;150" dur="20s" repeatCount="indefinite"/><animate attributeName="cy" values="150;750;150" dur="15s" repeatCount="indefinite"/></circle><circle cx="800" cy="400" r="100" fill="%23ffffff" opacity="0.06"><animate attributeName="cx" values="800;200;800" dur="25s" repeatCount="indefinite"/><animate attributeName="cy" values="400;200;400" dur="18s" repeatCount="indefinite"/></circle><circle cx="1200" cy="600" r="90" fill="%23ffffff" opacity="0.07"><animate attributeName="cx" values="1200;400;1200" dur="22s" repeatCount="indefinite"/><animate attributeName="cy" values="600;100;600" dur="20s" repeatCount="indefinite"/></circle></g></svg>') no-repeat center;
    background-size: cover;
    pointer-events: none;
  }

  /* Tema morado para Centro √ìptico Sicuani (DOS_DE_MAYO) */
  .login-overlay.tema-morado {
    background: linear-gradient(-45deg, #7c3aed 0%, #5b21b6 25%, #a855f7 50%, #6d28d9 75%, #581c87 100%);
    background-size: 400% 400%;
    animation: gradientShift 15s ease infinite;
  }

  /* Tema azul para √ìptica Sicuani (PLAZA_DE_ARMAS) */
  .login-overlay.tema-azul {
    background: linear-gradient(-45deg, #1e88e5 0%, #1565c0 25%, #42a5f5 50%, #0d47a1 75%, #1976d2 100%);
    background-size: 400% 400%;
    animation: gradientShift 15s ease infinite;
  }

  .login-overlay.hidden {
    display: none;
  }

  .login-container {
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(30px) saturate(180%);
    -webkit-backdrop-filter: blur(30px) saturate(180%);
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 28px;
    box-shadow: 0 30px 90px rgba(0,0,0,0.3),
                0 0 0 1px rgba(255,255,255,0.2) inset,
                0 10px 40px rgba(255,255,255,0.1) inset;
    overflow: hidden;
    width: 580px;
    max-width: 95%;
    animation: loginSlideIn 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
    position: relative;
  }

  .login-container::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
    animation: shimmer 3s infinite;
    pointer-events: none;
  }

  @keyframes shimmer {
    0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
    100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
  }

  @keyframes loginSlideIn {
    0% {
      opacity: 0;
      transform: translateY(-50px) scale(0.9) rotateX(10deg);
    }
    50% {
      transform: translateY(10px) scale(1.02) rotateX(-5deg);
    }
    100% {
      opacity: 1;
      transform: translateY(0) scale(1) rotateX(0);
    }
  }

  .login-header {
    background: rgba(255, 255, 255, 0.25);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    color: white;
    padding: 18px 28px;
    font-weight: 800;
    font-size: 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: all 0.4s ease;
    border-bottom: 1px solid rgba(255,255,255,0.2);
    text-shadow: 0 2px 10px rgba(0,0,0,0.3);
    letter-spacing: 1.5px;
    text-transform: uppercase;
  }

  .login-header.tema-morado {
    background: rgba(124, 58, 237, 0.2);
  }

  .login-header.tema-azul {
    background: rgba(30, 136, 229, 0.2);
  }

  .login-header .close-btn {
    background: rgba(255,255,255,0.15);
    border: 2px solid rgba(255,255,255,0.3);
    backdrop-filter: blur(10px);
    color: white;
    font-size: 22px;
    cursor: pointer;
    width: 38px;
    height: 38px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    font-weight: 300;
  }

  .login-header .close-btn:hover {
    background: rgba(255,255,255,0.3);
    transform: scale(1.15) rotate(90deg);
    border-color: rgba(255,255,255,0.5);
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
  }

  .login-body {
    display: flex;
    flex-direction: column;
    padding: 45px 40px 35px;
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    position: relative;
  }

  /* T√≠tulo del establecimiento */
  .login-title-container {
    text-align: center;
    margin-bottom: 35px;
    margin-top: 10px;
    animation: fadeInDown 0.8s ease-out 0.2s both;
  }

  @keyframes fadeInDown {
    from {
      opacity: 0;
      transform: translateY(-30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .login-empresa-nombre {
    font-size: 46px;
    font-weight: 900;
    margin: 0;
    color: white;
    text-shadow: 0 4px 20px rgba(0,0,0,0.4),
                 0 0 40px rgba(255,255,255,0.3);
    transition: all 0.5s ease;
    letter-spacing: 2px;
    filter: drop-shadow(0 2px 10px rgba(0,0,0,0.3));
  }

  .login-empresa-nombre.tema-morado {
    text-shadow: 0 4px 20px rgba(124, 58, 237, 0.6),
                 0 0 40px rgba(255,255,255,0.3);
  }

  .login-empresa-nombre.tema-azul {
    text-shadow: 0 4px 20px rgba(30, 136, 229, 0.6),
                 0 0 40px rgba(255,255,255,0.3);
  }

  .login-empresa-subtitulo {
    font-size: 14px;
    color: rgba(255,255,255,0.95);
    margin: 12px 0 0;
    font-weight: 600;
    letter-spacing: 2px;
    text-transform: uppercase;
    text-shadow: 0 2px 8px rgba(0,0,0,0.3);
  }

  .login-logo-icon {
    font-size: 90px;
    margin-bottom: 20px;
    display: inline-block;
    filter: drop-shadow(0 8px 16px rgba(0,0,0,0.4));
    animation: floatIcon 3s ease-in-out infinite, rotateIcon 10s linear infinite;
  }

  @keyframes floatIcon {
    0%, 100% { transform: translateY(0px) scale(1); }
    50% { transform: translateY(-15px) scale(1.05); }
  }

  @keyframes rotateIcon {
    0%, 100% { transform: rotate(-5deg); }
    50% { transform: rotate(5deg); }
  }

  .login-form {
    display: flex;
    flex-direction: column;
    gap: 20px;
    animation: fadeInUp 0.8s ease-out 0.4s both;
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .login-field {
    display: flex;
    flex-direction: column;
    gap: 8px;
    position: relative;
  }

  .login-field label {
    font-weight: 700;
    font-size: 11px;
    color: rgba(255,255,255,0.9);
    letter-spacing: 1.5px;
    text-transform: uppercase;
    text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    padding-left: 4px;
  }

  .login-field input, .login-field select {
    padding: 15px 18px;
    border: 2px solid rgba(255,255,255,0.3);
    border-radius: 12px;
    font-size: 15px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    background: rgba(255,255,255,0.9);
    backdrop-filter: blur(10px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    font-weight: 500;
  }

  .login-field input:focus, .login-field select:focus {
    outline: none;
    border-color: rgba(255,255,255,0.8);
    background: rgba(255,255,255,1);
    box-shadow: 0 8px 25px rgba(0,0,0,0.2),
                0 0 0 4px rgba(255,255,255,0.2);
    transform: translateY(-2px);
  }

  .login-field input::placeholder {
    color: rgba(0,0,0,0.4);
    font-weight: 400;
  }

  .login-footer {
    background: rgba(255,255,255,0.1);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    padding: 25px 40px;
    display: flex;
    justify-content: center;
    gap: 15px;
    border-top: 1px solid rgba(255,255,255,0.2);
  }

  .login-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    padding: 14px 36px;
    border: 2px solid rgba(255,255,255,0.4);
    border-radius: 14px;
    font-size: 15px;
    font-weight: 800;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    min-width: 150px;
    text-transform: uppercase;
    letter-spacing: 1px;
    position: relative;
    overflow: hidden;
  }

  .login-btn::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    background: rgba(255,255,255,0.3);
    border-radius: 50%;
    transform: translate(-50%, -50%);
    transition: width 0.5s, height 0.5s;
  }

  .login-btn:hover::before {
    width: 300px;
    height: 300px;
  }

  .login-btn-primary {
    background: rgba(34, 197, 94, 0.9);
    backdrop-filter: blur(10px);
    color: white;
    box-shadow: 0 6px 20px rgba(34,197,94,0.4);
    text-shadow: 0 2px 4px rgba(0,0,0,0.2);
  }

  .login-btn-primary:hover {
    transform: translateY(-3px) scale(1.02);
    box-shadow: 0 10px 30px rgba(34,197,94,0.5);
    border-color: rgba(255,255,255,0.6);
    background: rgba(34, 197, 94, 1);
  }

  .login-btn-primary:active {
    transform: translateY(-1px) scale(0.98);
  }

  .login-btn-secondary {
    background: rgba(239, 68, 68, 0.9);
    backdrop-filter: blur(10px);
    color: white;
    box-shadow: 0 6px 20px rgba(239,68,68,0.4);
    text-shadow: 0 2px 4px rgba(0,0,0,0.2);
  }

  .login-btn-secondary:hover {
    transform: translateY(-3px) scale(1.02);
    box-shadow: 0 10px 30px rgba(239,68,68,0.5);
    border-color: rgba(255,255,255,0.6);
    background: rgba(239, 68, 68, 1);
  }

  .login-btn-secondary:active {
    transform: translateY(-1px) scale(0.98);
  }

  .login-error {
    background: rgba(254, 226, 226, 0.95);
    backdrop-filter: blur(10px);
    border: 2px solid rgba(239, 68, 68, 0.8);
    color: #991b1b;
    padding: 14px 18px;
    border-radius: 12px;
    text-align: center;
    font-weight: 700;
    display: none;
    animation: shakeError 0.6s cubic-bezier(0.36, 0.07, 0.19, 0.97);
    box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
  }

  @keyframes shakeError {
    0%, 100% { transform: translateX(0) scale(1); }
    10%, 30%, 50%, 70%, 90% { transform: translateX(-8px) scale(1.02); }
    20%, 40%, 60%, 80% { transform: translateX(8px) scale(1.02); }
  }

  .login-error.show {
    display: block;
    animation: shakeError 0.6s cubic-bezier(0.36, 0.07, 0.19, 0.97), fadeInUp 0.3s ease-out;
  }

  /* Indicador de establecimiento en el ribbon */
  .establecimiento-badge {
    background: #ffc107;
    color: #333;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: bold;
    margin-left: auto;
    margin-right: 16px;
  }

  /* ============================================
     PANEL LATERAL DE CONFIGURACI√ìN R√ÅPIDA
     ============================================ */

  /* Bot√≥n flotante en esquina inferior derecha */
  .config-float-btn {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 60px;
    height: 60px;
    background: linear-gradient(135deg, #7c3aed 0%, #9333ea 100%);
    border: none;
    border-radius: 50%;
    color: white;
    font-size: 28px;
    cursor: pointer;
    box-shadow: 0 6px 20px rgba(124, 58, 237, 0.5);
    z-index: 9999;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .config-float-btn:hover {
    transform: scale(1.15) rotate(90deg);
    box-shadow: 0 8px 25px rgba(124, 58, 237, 0.7);
  }

  .config-float-btn.active {
    background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
  }

  /* Panel lateral deslizante */
  .config-side-panel {
    position: fixed;
    top: 0;
    right: -400px;
    width: 400px;
    height: 100%;
    background: white;
    box-shadow: -4px 0 20px rgba(0, 0, 0, 0.2);
    z-index: 9998;
    transition: right 0.3s ease;
    display: flex;
    flex-direction: column;
  }

  .config-side-panel.open {
    right: 0;
  }

  .config-panel-header {
    background: linear-gradient(135deg, #7c3aed 0%, #9333ea 100%);
    color: white;
    padding: 20px;
    font-size: 18px;
    font-weight: bold;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .config-panel-close {
    background: none;
    border: none;
    color: white;
    font-size: 28px;
    cursor: pointer;
    width: 35px;
    height: 35px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    transition: background 0.2s;
  }

  .config-panel-close:hover {
    background: rgba(255, 255, 255, 0.2);
  }

  .config-panel-body {
    flex: 1;
    overflow-y: auto;
    padding: 0;
  }

  .config-panel-menu {
    list-style: none;
    margin: 0;
    padding: 0;
  }

  .config-panel-menu li {
    border-bottom: 1px solid #e5e7eb;
  }

  .config-menu-btn {
    width: 100%;
    padding: 18px 20px;
    background: white;
    border: none;
    text-align: left;
    font-size: 15px;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 12px;
    color: #374151;
  }

  .config-menu-btn:hover {
    background: #f3f4f6;
    padding-left: 25px;
  }

  .config-menu-icon {
    font-size: 22px;
    width: 30px;
    text-align: center;
  }

  /* Modal de cambio de contrase√±a */
  .config-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 10000;
    display: none;
    align-items: center;
    justify-content: center;
  }

  .config-modal.active {
    display: flex;
  }

  .config-modal-content {
    background: white;
    border-radius: 12px;
    padding: 0;
    width: 90%;
    max-width: 450px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    animation: modalSlideIn 0.3s ease;
  }

  @keyframes modalSlideIn {
    from {
      transform: translateY(-50px);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  .config-modal-header {
    background: linear-gradient(135deg, #7c3aed 0%, #9333ea 100%);
    color: white;
    padding: 20px;
    border-radius: 12px 12px 0 0;
    font-size: 18px;
    font-weight: bold;
  }

  .config-modal-body {
    padding: 25px;
  }

  .config-modal-footer {
    padding: 15px 25px;
    border-top: 1px solid #e5e7eb;
    display: flex;
    justify-content: flex-end;
    gap: 10px;
  }

  .config-form-group {
    margin-bottom: 20px;
  }

  .config-form-label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #374151;
    font-size: 14px;
  }

  .config-form-input {
    width: 100%;
    padding: 12px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 14px;
    transition: border-color 0.2s;
  }

  .config-form-input:focus {
    outline: none;
    border-color: #7c3aed;
    box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
  }

  .config-form-select {
    width: 100%;
    padding: 12px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 12px;
    background: white;
    cursor: pointer;
  }

  /* Selector de temas */
  .theme-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
    margin-top: 15px;
  }

  .theme-card {
    border: 3px solid #e5e7eb;
    border-radius: 10px;
    padding: 15px;
    cursor: pointer;
    transition: all 0.3s;
    text-align: center;
  }

  .theme-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
  }

  .theme-card.active {
    border-color: #7c3aed;
    background: #f3e8ff;
  }

  .theme-preview {
    width: 100%;
    height: 60px;
    border-radius: 6px;
    margin-bottom: 10px;
  }

  .theme-name {
    font-weight: 600;
    font-size: 13px;
    color: #374151;
  }

  /* Recordatorios */
  .recordatorio-item {
    background: #f9fafb;
    border-left: 4px solid #7c3aed;
    padding: 12px;
    margin-bottom: 10px;
    border-radius: 4px;
  }

  .recordatorio-fecha {
    font-size: 12px;
    color: #6b7280;
    margin-bottom: 5px;
  }

  .recordatorio-nota {
    color: #374151;
    font-size: 14px;
  }

  /* Avisos */
  .aviso-item {
    background: #fef3c7;
    border-left: 4px solid #f59e0b;
    padding: 12px;
    margin-bottom: 10px;
    border-radius: 4px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .aviso-content {
    flex: 1;
  }

  .aviso-titulo {
    font-weight: 600;
    color: #92400e;
    margin-bottom: 4px;
  }

  .aviso-mensaje {
    font-size: 13px;
    color: #78350f;
  }

  .aviso-detalles {
    background: none;
    border: none;
    color: #7c3aed;
    font-weight: 600;
    cursor: pointer;
    padding: 5px 10px;
  }

  .aviso-detalles:hover {
    text-decoration: underline;
  }
</style>
</head>
<body>

<!-- ===== PANTALLA DE LOGIN ===== -->
<div id="loginOverlay" class="login-overlay">
  <div class="login-container">
    <div class="login-header">
      <span id="loginTitulo">üëì ACCESO AL SISTEMA</span>
      <button class="close-btn" onclick="cerrarLogin()">√ó</button>
    </div>
    <div class="login-body">
      <!-- T√≠tulo din√°mico del establecimiento -->
      <div class="login-title-container">
        <div class="login-logo-icon">üï∂Ô∏è</div>
        <h1 id="loginEmpresaNombre" class="login-empresa-nombre">√ìptica Sicuani</h1>
        <p id="loginEmpresaSubtitulo" class="login-empresa-subtitulo">Sistema Control de √ìptica</p>
      </div>

      <div class="login-form">
        <div class="login-field">
          <label>USUARIO</label>
          <input type="text" id="loginUsuario" placeholder="Ingrese su usuario">
        </div>
        <div class="login-field">
          <label>CLAVE</label>
          <input type="password" id="loginPassword" placeholder="Ingrese su contrase√±a">
        </div>
        <div class="login-field">
          <label>ESTABLECIMIENTO</label>
          <select id="loginEstablecimiento" onchange="cambiarTemaLogin()">
            <option value="">-- Seleccione --</option>
            <option value="DOS_DE_MAYO">Centro √ìptico Sicuani</option>
            <option value="PLAZA_DE_ARMAS">√ìptica Sicuani</option>
          </select>
        </div>
        <div class="login-error" id="loginError">
          ‚ö†Ô∏è Usuario o contrase√±a incorrectos
        </div>
      </div>
    </div>
    <div class="login-footer">
      <button class="login-btn login-btn-primary" onclick="intentarLogin()">
        ‚úì Entrar
      </button>
      <button class="login-btn login-btn-secondary" onclick="cerrarLogin()">
        ‚úó Salir
      </button>
    </div>
  </div>
</div>

<!-- ===== RIBBON SUPERIOR ===== -->
<div id="ribbon" class="hidden">
  <div class="ribbon-group">
    <button class="ribbon-btn active" data-section="dashboard">
      <div class="ribbon-icon">üìä</div>
      <span>Dashboard</span>
    </button>
    <h4>Inicio</h4>
  </div>
  <div class="ribbon-group">
    <button class="ribbon-btn" data-section="graficas">
      <div class="ribbon-icon">üìà</div>
      <span>Gr√°ficas</span>
    </button>
    <h4>An√°lisis</h4>
  </div>
  <div class="ribbon-group">
    <button class="ribbon-btn" data-section="ventas">
      <div class="ribbon-icon">üõí</div>
      <span>Ventas</span>
    </button>
    <h4>Gesti√≥n</h4>
  </div>
  <div class="ribbon-group">
    <button class="ribbon-btn" data-section="clientes">
      <div class="ribbon-icon">üë•</div>
      <span>Clientes</span>
    </button>
    <h4>Atenci√≥n</h4>
  </div>
  <div class="ribbon-group">
    <button class="ribbon-btn" data-section="consultorio">
      <div class="ribbon-icon">ü©∫</div>
      <span>Consultorio</span>
    </button>
    <h4>Cl√≠nica</h4>
  </div>
  <div class="ribbon-group">
    <button class="ribbon-btn" data-section="consultas">
      <div class="ribbon-icon">üìù</div>
      <span>Consultas</span>
    </button>
    <h4>Historial</h4>
  </div>
  <div class="ribbon-group">
    <button class="ribbon-btn" data-section="buscarVentas">
      <div class="ribbon-icon">üîç</div>
      <span>Buscar Ventas</span>
    </button>
    <h4>Reportes</h4>
  </div>
  <div class="ribbon-group">
    <button class="ribbon-btn" data-section="buscarRx">
      <div class="ribbon-icon">üìã</div>
      <span>Buscar RX</span>
    </button>
    <h4>Prescripciones</h4>
  </div>
  <div class="ribbon-group">
    <button class="ribbon-btn" data-section="inventario">
      <div class="ribbon-icon">üì¶</div>
      <span>Inventario</span>
    </button>
    <h4>Almac√©n</h4>
  </div>
  <div class="ribbon-group">
    <button class="ribbon-btn" data-section="lunas">
      <div class="ribbon-icon">üîµ</div>
      <span>Lunas</span>
    </button>
    <h4>Laboratorio</h4>
  </div>
  <div class="ribbon-group">
    <button class="ribbon-btn" data-section="almacen">
      <div class="ribbon-icon">üè≠</div>
      <span>Almac√©n</span>
    </button>
    <h4>Log√≠stica</h4>
  </div>
  <div class="ribbon-group">
    <button class="ribbon-btn" data-section="reportes">
      <div class="ribbon-icon">üìä</div>
      <span>Reportes</span>
    </button>
    <h4>Informes</h4>
  </div>
  <div class="ribbon-group">
    <button class="ribbon-btn" data-section="caja">
      <div class="ribbon-icon">üí∞</div>
      <span>Caja</span>
    </button>
    <h4>Finanzas</h4>
  </div>
  <div class="ribbon-group">
    <button class="ribbon-btn" data-section="importacion">
      <div class="ribbon-icon">üì•</div>
      <span>Importaci√≥n</span>
    </button>
    <h4>Herramientas</h4>
  </div>
  <div class="ribbon-group">
    <button class="ribbon-btn" data-section="configuracion">
      <div class="ribbon-icon">‚öôÔ∏è</div>
      <span>Configuraci√≥n</span>
    </button>
    <h4>Sistema</h4>
  </div>
  <div class="establecimiento-badge" id="establecimientoBadge">
    üè™ Sin establecimiento
  </div>
  <div class="ribbon-group" style="margin-left: 0;">
    <button class="ribbon-btn" onclick="cerrarSesion()" style="background: #dc2626;">
      <div class="ribbon-icon">üö™</div>
      <span>Salir</span>
    </button>
    <h4>Sesi√≥n</h4>
  </div>
</div>

<!-- ===== BOT√ìN FLOTANTE DE CONFIGURACI√ìN R√ÅPIDA ===== -->
<button class="config-float-btn" id="configFloatBtn" onclick="toggleConfigPanel()" title="Configuraci√≥n R√°pida">
  ‚öôÔ∏è
</button>

<!-- ===== PANEL LATERAL DE CONFIGURACI√ìN R√ÅPIDA ===== -->
<div class="config-side-panel" id="configSidePanel">
  <div class="config-panel-header">
    <span>‚öôÔ∏è Configuraci√≥n R√°pida</span>
    <button class="config-panel-close" onclick="toggleConfigPanel()">√ó</button>
  </div>
  <div class="config-panel-body">
    <ul class="config-panel-menu">
      <li>
        <button class="config-menu-btn" onclick="abrirCambiarContrasena()">
          <span class="config-menu-icon">üîê</span>
          <span>Cambiar Contrase√±a</span>
        </button>
      </li>
      <li>
        <button class="config-menu-btn" onclick="abrirCambiarAlmacen()">
          <span class="config-menu-icon">üè™</span>
          <span>Cambiar de Almac√©n</span>
        </button>
      </li>
      <li>
        <button class="config-menu-btn" onclick="abrirCambiarEstilo()">
          <span class="config-menu-icon">üé®</span>
          <span>Cambiar de Estilo</span>
        </button>
      </li>
      <li>
        <button class="config-menu-btn" onclick="abrirRecordatorios()">
          <span class="config-menu-icon">üìÖ</span>
          <span>Recordatorios</span>
        </button>
      </li>
      <li>
        <button class="config-menu-btn" onclick="abrirVerAvisos()">
          <span class="config-menu-icon">üì¢</span>
          <span>Ver Avisos</span>
        </button>
      </li>
      <li>
        <button class="config-menu-btn" onclick="salirSistema()" style="background: linear-gradient(135deg, #ef4444, #dc2626); color: white;">
          <span class="config-menu-icon">üö™</span>
          <span>Salir</span>
        </button>
      </li>
    </ul>
  </div>
</div>

<!-- MODAL: Cambiar Contrase√±a -->
<div class="config-modal" id="modalCambiarContrasena">
  <div class="config-modal-content">
    <div class="config-modal-header">
      üîê Cambiar Contrase√±a
    </div>
    <div class="config-modal-body">
      <div class="config-form-group">
        <label class="config-form-label">Nueva Contrase√±a</label>
        <input type="password" class="config-form-input" id="nuevaContrasena" placeholder="Ingrese nueva contrase√±a">
      </div>
      <div class="config-form-group">
        <label class="config-form-label">Confirmar Contrase√±a</label>
        <input type="password" class="config-form-input" id="confirmarContrasena" placeholder="Confirme la contrase√±a">
      </div>
    </div>
    <div class="config-modal-footer">
      <button class="btn btn-secondary" onclick="cerrarModalConfiguracion('modalCambiarContrasena')">‚ùå Cancelar</button>
      <button class="btn btn-success" onclick="guardarNuevaContrasena()">‚úÖ Aceptar</button>
    </div>
  </div>
</div>

<!-- MODAL: Cambiar Almac√©n -->
<div class="config-modal" id="modalCambiarAlmacen">
  <div class="config-modal-content">
    <div class="config-modal-header">
      üè™ Cambiar de Almac√©n
    </div>
    <div class="config-modal-body">
      <div class="config-form-group">
        <label class="config-form-label">Almac√©n</label>
        <select class="config-form-select" id="selectAlmacen">
          <option value="PREMIUM">PREMIUM</option>
          <option value="TIENDA">TIENDA</option>
        </select>
      </div>
    </div>
    <div class="config-modal-footer">
      <button class="btn btn-secondary" onclick="cerrarModalConfiguracion('modalCambiarAlmacen')">Cancelar</button>
      <button class="btn btn-primary" onclick="cambiarAlmacen()">Cambiar</button>
    </div>
  </div>
</div>

<!-- MODAL: Cambiar Estilo (Temas) -->
<div class="config-modal" id="modalCambiarEstilo">
  <div class="config-modal-content" style="max-width: 700px;">
    <div class="config-modal-header">
      üé® Cambiar de Estilo
    </div>
    <div class="config-modal-body">
      <div class="theme-grid">
        <div class="theme-card active" onclick="aplicarTema('sicuani')">
          <div class="theme-preview" style="background: linear-gradient(135deg, #9333ea 0%, #7c3aed 100%);"></div>
          <div class="theme-name">Sicuani Original</div>
        </div>
        <div class="theme-card" onclick="aplicarTema('office2010black')">
          <div class="theme-preview" style="background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);"></div>
          <div class="theme-name">Office Black</div>
        </div>
        <div class="theme-card" onclick="aplicarTema('office2010blue')">
          <div class="theme-preview" style="background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);"></div>
          <div class="theme-name">Office Blue</div>
        </div>
        <div class="theme-card" onclick="aplicarTema('office2010silver')">
          <div class="theme-preview" style="background: linear-gradient(135deg, #64748b 0%, #475569 100%);"></div>
          <div class="theme-name">Office Silver</div>
        </div>
        <div class="theme-card" onclick="aplicarTema('visualstudio2012blue')">
          <div class="theme-preview" style="background: linear-gradient(135deg, #0891b2 0%, #0e7490 100%);"></div>
          <div class="theme-name">VS Blue</div>
        </div>
        <div class="theme-card" onclick="aplicarTema('visualstudio2012dark')">
          <div class="theme-preview" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);"></div>
          <div class="theme-name">VS Dark</div>
        </div>
        <div class="theme-card" onclick="aplicarTema('visualstudio2012light')">
          <div class="theme-preview" style="background: linear-gradient(135deg, #64748b 0%, #475569 100%);"></div>
          <div class="theme-name">VS Light</div>
        </div>
        <div class="theme-card" onclick="aplicarTema('windows7blue')">
          <div class="theme-preview" style="background: linear-gradient(135deg, #1d4ed8 0%, #1e40af 100%);"></div>
          <div class="theme-name">Windows Blue</div>
        </div>
        <div class="theme-card" onclick="aplicarTema('metro')">
          <div class="theme-preview" style="background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);"></div>
          <div class="theme-name">Metro Purple</div>
        </div>
        <div class="theme-card" onclick="aplicarTema('forest')">
          <div class="theme-preview" style="background: linear-gradient(135deg, #059669 0%, #047857 100%);"></div>
          <div class="theme-name">Forest Green</div>
        </div>
        <div class="theme-card" onclick="aplicarTema('sunset')">
          <div class="theme-preview" style="background: linear-gradient(135deg, #ea580c 0%, #c2410c 100%);"></div>
          <div class="theme-name">Sunset Orange</div>
        </div>
        <div class="theme-card" onclick="aplicarTema('midnight')">
          <div class="theme-preview" style="background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);"></div>
          <div class="theme-name">Midnight Blue</div>
        </div>
        <div class="theme-card" onclick="aplicarTema('professional')">
          <div class="theme-preview" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);"></div>
          <div class="theme-name">Professional Blue</div>
        </div>
      </div>
    </div>
    <div class="config-modal-footer">
      <button class="btn btn-secondary" onclick="cerrarModalConfiguracion('modalCambiarEstilo')">Cerrar</button>
    </div>
  </div>
</div>

<!-- MODAL: Recordatorios -->
<div class="config-modal" id="modalRecordatorios">
  <div class="config-modal-content">
    <div class="config-modal-header">
      üìÖ Recordatorios
    </div>
    <div class="config-modal-body">
      <div style="margin-bottom: 15px;">
        <button class="btn btn-success btn-sm" onclick="mostrarFormNuevoRecordatorio()">‚ûï Nuevo Recordatorio</button>
      </div>

      <!-- Formulario nuevo recordatorio (oculto inicialmente) -->
      <div id="formNuevoRecordatorio" style="display: none; background: #f3f4f6; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
        <div class="config-form-group">
          <label class="config-form-label">Fecha</label>
          <input type="date" class="config-form-input" id="recordatorioFecha">
        </div>
        <div class="config-form-group">
          <label class="config-form-label">Nota</label>
          <input type="text" class="config-form-input" id="recordatorioNota" placeholder="Ingrese el recordatorio">
        </div>
        <div style="display: flex; gap: 8px;">
          <button class="btn btn-success btn-sm" onclick="agregarRecordatorio()">Guardar</button>
          <button class="btn btn-secondary btn-sm" onclick="cancelarNuevoRecordatorio()">Cancelar</button>
        </div>
      </div>

      <!-- Lista de recordatorios -->
      <div id="listaRecordatorios">
        <!-- Se llenar√° din√°micamente -->
      </div>
    </div>
    <div class="config-modal-footer">
      <button class="btn btn-secondary" onclick="cerrarModalConfiguracion('modalRecordatorios')">Cerrar</button>
    </div>
  </div>
</div>

<!-- MODAL: Ver Avisos -->
<div class="config-modal" id="modalVerAvisos">
  <div class="config-modal-content">
    <div class="config-modal-header">
      üì¢ Avisos del Sistema
    </div>
    <div class="config-modal-body">
      <div id="listaAvisos">
        <!-- Se llenar√° din√°micamente -->
      </div>
    </div>
    <div class="config-modal-footer">
      <button class="btn btn-primary" onclick="marcarAvisosComoVistos()">‚úÖ Marcar como Vistos</button>
      <button class="btn btn-secondary" onclick="cerrarModalConfiguracion('modalVerAvisos')">Cerrar</button>
    </div>
  </div>
</div>

<!-- Modal: Nuevo Movimiento de Caja -->
<div class="config-modal" id="modalNuevoMovimiento">
  <div class="config-modal-content" style="max-width: 700px;">
    <div class="config-modal-header">
      ‚ûï Nuevo Movimiento de Caja
    </div>
    <div class="config-modal-body">
      <div class="config-form-group">
        <label class="config-form-label">Tipo de Operaci√≥n</label>
        <select class="config-form-input" id="movTipoOperacion">
          <option value="">--Seleccione--</option>
          <option value="LABORATORIO">LABORATORIO</option>
          <option value="PROVEEDOR MONTURA">PROVEEDOR MONTURA</option>
          <option value="ARTICULOS DE OFICINA">ART√çCULOS DE OFICINA</option>
          <option value="SERVICIOS PUBLICOS">SERVICIOS P√öBLICOS</option>
          <option value="OTROS GASTOS">OTROS GASTOS</option>
          <option value="OTROS INGRESOS">OTROS INGRESOS</option>
        </select>
      </div>

      <div class="config-form-group">
        <label class="config-form-label">Concepto</label>
        <input type="text" class="config-form-input" id="movConcepto" placeholder="Descripci√≥n del movimiento">
      </div>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
        <div class="config-form-group">
          <label class="config-form-label">Monto</label>
          <input type="number" class="config-form-input" id="movMonto" placeholder="0.00" step="0.01">
        </div>

        <div class="config-form-group">
          <label class="config-form-label">Tipo</label>
          <select class="config-form-input" id="movTipo">
            <option value="INGRESO">INGRESO</option>
            <option value="EGRESO">EGRESO</option>
          </select>
        </div>
      </div>

      <div class="config-form-group">
        <label class="config-form-label">Forma de Pago</label>
        <select class="config-form-input" id="movFormaPago">
          <option value="EFECTIVO">EFECTIVO</option>
          <option value="TARJETA">TARJETA</option>
          <option value="TRANSFERENCIA">TRANSFERENCIA</option>
          <option value="CHEQUE">CHEQUE</option>
        </select>
      </div>

      <div class="config-form-group">
        <label class="config-form-label">Fecha de Operaci√≥n</label>
        <input type="date" class="config-form-input" id="movFechaOperacion">
      </div>
    </div>
    <div class="config-modal-footer">
      <button class="btn btn-success" onclick="guardarNuevoMovimiento()">‚úÖ Guardar</button>
      <button class="btn btn-secondary" onclick="cerrarModalConfiguracion('modalNuevoMovimiento')">‚ùå Cancelar</button>
    </div>
  </div>
</div>

<!-- Modal: Nuevo Cobro de Venta -->
<div class="config-modal" id="modalNuevoCobro">
  <div class="config-modal-content" style="max-width: 700px;">
    <div class="config-modal-header">
      üíµ Nuevo Cobro de Venta
    </div>
    <div class="config-modal-body">
      <div class="config-form-group">
        <label class="config-form-label">ID de Venta</label>
        <input type="text" class="config-form-input" id="cobroVentaId" placeholder="Ej: VEN-001">
      </div>

      <div class="config-form-group">
        <label class="config-form-label">Cliente</label>
        <input type="text" class="config-form-input" id="cobroClienteNombre" placeholder="Nombre del cliente">
      </div>

      <div class="config-form-group">
        <label class="config-form-label">Concepto</label>
        <input type="text" class="config-form-input" id="cobroConcepto" placeholder="Descripci√≥n del cobro">
      </div>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
        <div class="config-form-group">
          <label class="config-form-label">Monto</label>
          <input type="number" class="config-form-input" id="cobroMonto" placeholder="0.00" step="0.01">
        </div>

        <div class="config-form-group">
          <label class="config-form-label">Tipo de Documento</label>
          <select class="config-form-input" id="cobroTipoDocumento">
            <option value="BOLETA">BOLETA</option>
            <option value="FACTURA">FACTURA</option>
            <option value="RECIBO">RECIBO</option>
          </select>
        </div>
      </div>

      <div class="config-form-group">
        <label class="config-form-label">Forma de Pago</label>
        <select class="config-form-input" id="cobroFormaPago">
          <option value="EFECTIVO">EFECTIVO</option>
          <option value="TARJETA">TARJETA</option>
          <option value="TRANSFERENCIA">TRANSFERENCIA</option>
          <option value="CHEQUE">CHEQUE</option>
        </select>
      </div>

      <div class="config-form-group">
        <label class="config-form-label">Fecha</label>
        <input type="date" class="config-form-input" id="cobroFecha">
      </div>
    </div>
    <div class="config-modal-footer">
      <button class="btn btn-success" onclick="guardarNuevoCobro()">‚úÖ Guardar</button>
      <button class="btn btn-secondary" onclick="cerrarModalConfiguracion('modalNuevoCobro')">‚ùå Cancelar</button>
    </div>
  </div>
</div>

<!-- ===== ESCRITORIO ===== -->
<!-- ===== ESTRUCTURA LIMPIA - SIN MDI ===== -->

<div class="app-header">
  <div>
    <h1>Centro √ìptico <span>Sicuani</span></h1>
    <small>Sistema de Gesti√≥n Integral - Base de datos local</small>
  </div>
  <div class="pill" id="dbStatus">üíæ BD Local activa</div>
</div>

<!-- Logo Principal de Fondo -->
<div id="logoPrincipalContainer">
  <img id="logoPrincipal" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='200' viewBox='0 0 400 200'%3E%3Ctext x='50%25' y='50%25' text-anchor='middle' dy='.3em' fill='%237c3aed' font-size='80' font-weight='bold'%3E%F0%9F%91%81%3C/text%3E%3C/svg%3E" class="main-logo" alt="Logo Principal">
</div>

<main>
        <!-- ======== SECCI√ìN DASHBOARD ULTRA MODERNA ======== -->
        <section id="dashboard" class="active">

          <!-- Header del Dashboard -->
          <div style="margin-bottom: 30px; animation: fadeInDown 0.6s ease-out;">
            <h2 style="font-size: 32px; font-weight: 900; color: #1e293b; margin-bottom: 8px; display: flex; align-items: center; gap: 12px;">
              <span style="font-size: 40px;">üìä</span>
              Dashboard Ejecutivo
            </h2>
            <p style="color: #64748b; font-size: 15px; font-weight: 500;">Vista general del negocio en tiempo real</p>
          </div>

          <!-- Selector de Per√≠odo -->
          <div style="display: flex; justify-content: center; gap: 12px; margin-bottom: 30px; flex-wrap: wrap;">
            <button id="periodHoy" onclick="cambiarPeriodoDashboard('hoy')" style="padding: 12px 24px; background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; border-radius: 12px; font-weight: 700; font-size: 14px; cursor: pointer; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4); transition: all 0.3s;">
              üìÖ Hoy
            </button>
            <button id="periodSemana" onclick="cambiarPeriodoDashboard('semana')" style="padding: 12px 24px; background: white; color: #6b7280; border: 2px solid #e5e7eb; border-radius: 12px; font-weight: 700; font-size: 14px; cursor: pointer; transition: all 0.3s;">
              üìÜ Semana
            </button>
            <button id="period15dias" onclick="cambiarPeriodoDashboard('15dias')" style="padding: 12px 24px; background: white; color: #6b7280; border: 2px solid #e5e7eb; border-radius: 12px; font-weight: 700; font-size: 14px; cursor: pointer; transition: all 0.3s;">
              üìä 15 D√≠as
            </button>
            <button id="periodMes" onclick="cambiarPeriodoDashboard('mes')" style="padding: 12px 24px; background: white; color: #6b7280; border: 2px solid #e5e7eb; border-radius: 12px; font-weight: 700; font-size: 14px; cursor: pointer; transition: all 0.3s;">
              üìà Mes
            </button>
          </div>

          <!-- M√©tricas Principales - Tarjetas Animadas -->
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px;" id="dashboardMetricas">
            <!-- Las tarjetas se generar√°n din√°micamente con JavaScript -->
          </div>

          <!-- Gr√°ficos y Estad√≠sticas -->
          <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 30px;">
            <!-- Ventas del Per√≠odo -->
            <div class="card" style="padding: 25px;">
              <div id="graficoVentasMes" style="min-height: 350px;"></div>
            </div>

            <!-- Top Productos -->
            <div class="card" style="padding: 25px;">
              <h3 style="font-size: 18px; font-weight: 800; color: #1e293b; margin-bottom: 20px;">üèÜ Top Productos</h3>
              <div id="topProductos" style="display: flex; flex-direction: column; gap: 12px;"></div>
            </div>
          </div>

          <!-- Stock Bajo y Alertas -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <!-- Stock Bajo -->
            <div class="card" style="padding: 25px;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="font-size: 18px; font-weight: 800; color: #ef4444; margin: 0; display: flex; align-items: center; gap: 8px;">
                  <span>‚ö†Ô∏è</span> Stock Bajo
                </h3>
                <span id="stockBajoCount" style="background: #fee2e2; color: #991b1b; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 700;"></span>
              </div>
              <div id="listaStockBajo" style="max-height: 300px; overflow-y: auto;"></div>
            </div>

            <!-- Actividad Reciente -->
            <div class="card" style="padding: 25px;">
              <h3 style="font-size: 18px; font-weight: 800; color: #1e293b; margin-bottom: 20px; display: flex; align-items: center; gap: 8px;">
                <span>üîî</span> Actividad Reciente
              </h3>
              <div id="actividadReciente" style="max-height: 300px; overflow-y: auto;"></div>
            </div>
          </div>

        </section>

        <!-- ======== SECCI√ìN GR√ÅFICAS ======== -->
        <section id="graficas" class="hidden">

          <!-- Header de Gr√°ficas -->
          <div style="margin-bottom: 30px; animation: fadeInDown 0.6s ease-out;">
            <h2 style="font-size: 32px; font-weight: 900; color: #1e293b; margin-bottom: 8px; display: flex; align-items: center; gap: 12px;">
              <span style="font-size: 40px;">üìà</span>
              An√°lisis de Ventas
            </h2>
            <p style="color: #64748b; font-size: 15px; font-weight: 500;">Visualizaci√≥n detallada de gr√°ficos de ventas</p>
          </div>

          <!-- Selector de Per√≠odo -->
          <div style="display: flex; justify-content: center; gap: 12px; margin-bottom: 30px; flex-wrap: wrap;">
            <button id="periodHoyGraficas" onclick="cambiarPeriodoDashboard('hoy')" style="padding: 12px 24px; background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; border-radius: 12px; font-weight: 700; font-size: 14px; cursor: pointer; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4); transition: all 0.3s;">
              üìÖ Hoy
            </button>
            <button id="periodSemanaGraficas" onclick="cambiarPeriodoDashboard('semana')" style="padding: 12px 24px; background: white; color: #6b7280; border: 2px solid #e5e7eb; border-radius: 12px; font-weight: 700; font-size: 14px; cursor: pointer; transition: all 0.3s;">
              üìÜ Semana
            </button>
            <button id="period15diasGraficas" onclick="cambiarPeriodoDashboard('15dias')" style="padding: 12px 24px; background: white; color: #6b7280; border: 2px solid #e5e7eb; border-radius: 12px; font-weight: 700; font-size: 14px; cursor: pointer; transition: all 0.3s;">
              üìä 15 D√≠as
            </button>
            <button id="periodMesGraficas" onclick="cambiarPeriodoDashboard('mes')" style="padding: 12px 24px; background: white; color: #6b7280; border: 2px solid #e5e7eb; border-radius: 12px; font-weight: 700; font-size: 14px; cursor: pointer; transition: all 0.3s;">
              üìà Mes
            </button>
          </div>

          <!-- Gr√°fico de Ventas en Pantalla Completa -->
          <div class="card" style="padding: 30px;">
            <div id="graficoVentasGraficas" style="min-height: 550px;"></div>
          </div>

        </section>

        <!-- ======== SECCI√ìN VENTAS ======== -->
        <section id="ventas" class="hidden">
          <div class="card" style="padding: 16px; margin-bottom: 16px;">
            <div style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 10px 14px; border-radius: 8px; margin-bottom: 12px; font-weight: 700; font-size: 12px; display: flex; align-items: center; gap: 10px; box-shadow: 0 3px 10px rgba(16, 185, 129, 0.3);">
              üìÑ Datos del Documento
            </div>
            <!-- FILA 1: Datos Principales del Documento -->
            <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1.5fr 1.5fr; gap: 10px; margin-bottom: 10px;">
              <div class="field" style="margin: 0;">
                <label style="font-size: 10px; margin-bottom: 4px; font-weight: 600; color: #059669;">üìù Tipo Documento</label>
                <select id="docTipo" style="padding: 6px; font-size: 11px; border: 2px solid #10b981; border-radius: 6px; font-weight: 600;">
                  <option value="NOTA">NOTA DE VENTA</option>
                  <option value="BOLETA">BOLETA</option>
                  <option value="FACTURA">FACTURA</option>
                </select>
              </div>
              <div class="field" style="margin: 0;">
                <label style="font-size: 10px; margin-bottom: 4px; font-weight: 600; color: #059669;">üìã Serie</label>
                <input id="docSerie" value="0001" style="padding: 6px; font-size: 11px; text-align: center; border: 2px solid #10b981; border-radius: 6px; font-weight: 700;">
              </div>
              <div class="field" style="margin: 0;">
                <label style="font-size: 10px; margin-bottom: 4px; font-weight: 600; color: #059669;">üî¢ N√∫mero</label>
                <input id="docNumero" readonly style="padding: 6px; font-size: 11px; text-align: center; background: #dcfce7; border: 2px solid #10b981; border-radius: 6px; font-weight: 700;">
              </div>
              <div class="field" style="margin: 0;">
                <label style="font-size: 10px; margin-bottom: 4px; font-weight: 600; color: #059669;">üìÖ F. Emisi√≥n</label>
                <input type="date" id="fechaEmision" style="padding: 6px; font-size: 11px; border: 2px solid #10b981; border-radius: 6px;">
              </div>
              <div class="field" style="margin: 0;">
                <label style="font-size: 10px; margin-bottom: 4px; font-weight: 600; color: #059669;">‚è∞ F. Vencim.</label>
                <input type="date" id="fechaVenc" style="padding: 6px; font-size: 11px; border: 2px solid #10b981; border-radius: 6px;">
              </div>
            </div>

            <!-- FILA 2: Cliente y Estado -->
            <div style="display: grid; grid-template-columns: 3fr 1fr; gap: 10px;">
              <div class="field" style="margin: 0;">
                <label style="font-size: 10px; margin-bottom: 4px; font-weight: 600; color: #059669;">üë§ Cliente</label>
                <div style="display: flex; gap: 6px;">
                  <input id="clienteNombre" placeholder="CLIENTE EVENTUAL" readonly style="flex: 1; padding: 6px; font-size: 11px; border: 2px solid #10b981; border-radius: 6px; background: white; font-weight: 600;">
                  <input type="hidden" id="clienteId">
                  <button class="btn btn-secondary btn-sm" onclick="mostrarSeccion('clientes')" style="padding: 6px 12px; font-size: 10px; border-radius: 6px; font-weight: 600;">üîç Buscar</button>
                  <button class="btn btn-primary btn-sm" onclick="abrirModalCliente()" style="padding: 6px 12px; font-size: 10px; border-radius: 6px; font-weight: 600;">‚ûï Nuevo</button>
                </div>
              </div>
              <div style="margin: 0;">
                <label style="font-size: 10px; margin-bottom: 4px; display: block; font-weight: 600; color: #059669;">ü©∫ Estado RX</label>
                <div style="text-align: center; background: linear-gradient(135deg, #fef2f2, #fee2e2); padding: 6px; border-radius: 6px; border: 2px solid #ef4444;">
                  <span id="badgeMedida" style="font-size: 11px; font-weight: 700; color: #dc2626;">SIN MEDIDA</span>
                </div>
              </div>
            </div>
          </div>

          <div class="card" style="padding: 14px; margin-bottom: 14px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
              <div style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 8px 14px; border-radius: 8px; font-weight: 700; font-size: 12px; display: inline-flex; align-items: center; gap: 8px;">
                üõçÔ∏è Productos / Servicios
              </div>
              <div style="display: flex; gap: 6px;">
                <button class="btn btn-success btn-sm" onclick="abrirCatalogo()" style="padding: 5px 10px; font-size: 10px;">+ Cat√°logo</button>
                <button class="btn btn-info btn-sm" onclick="abrirSelectorLunas()" style="padding: 5px 10px; font-size: 10px;">üîµ Lunas</button>
                <button class="btn btn-secondary btn-sm" onclick="abrirModalItem()" style="padding: 5px 10px; font-size: 10px;">+ Item</button>
                <button class="btn btn-primary btn-sm" onclick="nuevaMedidaCliente()" style="padding: 5px 10px; font-size: 10px;">+ RX</button>
              </div>
            </div>

            <table style="font-size: 10px;">
              <thead>
                <tr style="background: #f3f4f6;">
                  <th style="width: 4%; padding: 6px 4px; font-size: 10px;">#</th>
                  <th style="width: 40%; padding: 6px 4px; font-size: 10px;">DESCRIPCI√ìN</th>
                  <th class="text-center" style="width: 8%; padding: 6px 4px; font-size: 10px;">CANT.</th>
                  <th class="text-right" style="width: 12%; padding: 6px 4px; font-size: 10px;">P. UNIT.</th>
                  <th class="text-right" style="width: 10%; padding: 6px 4px; font-size: 10px;">DESC.</th>
                  <th class="text-right" style="width: 14%; padding: 6px 4px; font-size: 10px;">IMPORTE</th>
                  <th class="text-center" style="width: 12%; padding: 6px 4px; font-size: 10px;">ACC.</th>
                </tr>
              </thead>
              <tbody id="itemsBody" style="font-size: 10px;"></tbody>
            </table>

            <div style="display: grid; grid-template-columns: auto 1fr; gap: 10px; margin-top: 8px; padding-top: 8px; border-top: 2px solid #e5e7eb;">
              <span class="pill" id="registrosInfo" style="font-size: 10px; padding: 4px 10px;">üì¶ Items: 0 | Cant: 0</span>
              <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px;">
                <div class="field" style="margin: 0;">
                  <label style="font-size: 9px; margin-bottom: 2px; font-weight: 600;">Subtotal</label>
                  <input id="totalBruto" readonly value="0.00" style="padding: 4px; font-size: 11px; text-align: right; background: #f9fafb;">
                </div>
                <div class="field" style="margin: 0;">
                  <label style="font-size: 9px; margin-bottom: 2px; font-weight: 600;">Descuento</label>
                  <input id="totalDescuento" readonly value="0.00" style="padding: 4px; font-size: 11px; text-align: right; background: #f9fafb;">
                </div>
                <div class="field" style="margin: 0;">
                  <label style="font-weight: 700; color: #7c3aed; font-size: 9px; margin-bottom: 2px;">TOTAL PAGAR</label>
                  <input id="totalPagar" readonly value="0.00" style="font-weight: bold; font-size: 12px; padding: 4px; background: linear-gradient(135deg, #f0fdf4, #e0f2fe); color: #16a34a; border: 2px solid #7c3aed; text-align: right;">
                </div>
                <div class="field" style="margin: 0;">
                  <label style="font-weight: 700; color: #059669; font-size: 9px; margin-bottom: 2px;">üí∞ Pagado</label>
                  <input id="saldoACuenta" type="number" step="0.01" value="0.00" placeholder="0.00" oninput="calcularSaldoTotal()" style="font-weight: bold; font-size: 12px; padding: 4px; background: #f0fdf4; color: #059669; border: 2px solid #10b981; text-align: right;">
                </div>
                <div class="field" style="margin: 0;">
                  <label style="font-weight: 700; color: #dc2626; font-size: 9px; margin-bottom: 2px;">üìä Pendiente</label>
                  <input id="saldoTotal" readonly value="0.00" style="font-weight: bold; font-size: 12px; padding: 4px; background: linear-gradient(135deg, #fef2f2, #fee2e2); color: #dc2626; border: 2px solid #dc2626; text-align: right;">
                </div>
              </div>
            </div>
          </div>

          <div class="card" style="padding: 20px;">
            <div style="display: grid; grid-template-columns: 150px 180px 1fr auto; gap: 12px; align-items: end;">
              <div class="field" style="margin: 0;">
                <label style="font-size: 11px; margin-bottom: 4px; font-weight: 600;">Pago</label>
                <select id="tipoFinanc" style="padding: 6px; font-size: 12px;">
                  <option value="CONTADO">CONTADO</option>
                  <option value="CREDITO">CR√âDITO</option>
                  <option value="TARJETA">TARJETA</option>
                  <option value="YAPE">YAPE/PLIN</option>
                </select>
              </div>
              <div class="field" style="margin: 0;">
                <label style="font-size: 11px; margin-bottom: 4px; font-weight: 600;">Vendedor</label>
                <input id="vendedor" value="ADMINISTRADOR" style="padding: 6px; font-size: 12px;">
              </div>
              <div class="field" style="margin: 0;">
                <label style="font-size: 11px; margin-bottom: 4px; font-weight: 600;">Observaci√≥n</label>
                <input id="obsVenta" placeholder="Observaciones de la venta..." style="padding: 6px; font-size: 12px;">
              </div>
              <div style="display: flex; gap: 8px;">
                <button class="btn btn-secondary" onclick="nuevaVenta()" style="padding: 8px 16px; font-size: 12px;">üîÑ Nueva Venta</button>
                <button class="btn btn-success" onclick="guardarVenta(); nuevaVenta();" style="padding: 8px 16px; font-size: 12px;">üíæ Guardar Venta</button>
                <button class="btn btn-info" onclick="guardarEImprimir()" style="padding: 8px 16px; font-size: 12px;">üñ®Ô∏è Guardar e Imprimir</button>
              </div>
            </div>
          </div>
        </section>

        <!-- ======== SECCI√ìN CLIENTES ======== -->
        <section id="clientes" class="hidden">
          <div class="card">
            <div class="flex-between mb-2">
              <div class="card-title" style="margin: 0; border: none; padding: 0;">üë• Ex√°menes Visuales - Gesti√≥n de Clientes</div>
              <button class="btn btn-success" onclick="abrirModalCliente()">+ Nuevo Cliente</button>
            </div>
            <div class="row mb-2">
              <div class="field" style="max-width: 400px;">
                <label>Buscar</label>
                <input id="buscarClienteInput" placeholder="üîç Ingrese el texto a buscar y presione Enter..." oninput="renderClientes()">
              </div>
            </div>
            <table>
              <thead>
                <tr>
                  <th>Documento</th>
                  <th>Cliente</th>
                  <th>Edad</th>
                  <th>Tel√©fono</th>
                  <th>Email</th>
                  <th>Estado</th>
                  <th>Ocupaci√≥n</th>
                  <th class="text-center">Acciones</th>
                </tr>
              </thead>
              <tbody id="clientesBody"></tbody>
            </table>
            <div class="flex-between mt-2">
              <span class="pill" id="clientesCount">Registros encontrados: 0</span>
              <div class="flex-end">
                <button class="btn btn-secondary btn-sm" onclick="exportarClientesExcel()">üì• Exportar Excel</button>
              </div>
            </div>
          </div>
        </section>

        <!-- ======== SECCI√ìN CONSULTORIO ======== -->
        <section id="consultorio" class="hidden">
          <div class="card">
            <div class="flex-between mb-2">
              <div class="card-title" style="margin: 0; border: none; padding: 0;">ü©∫ Consultorio - Examen Cl√≠nico y Optom√©trico</div>
              <div style="display: flex; gap: 10px; align-items: center;">
                <button class="btn btn-secondary btn-sm" onclick="toggleAyudaConsultorio()" title="Ver atajos de teclado (F1)">
                  ‚ùì Ayuda R√°pida
                </button>
                <button class="btn btn-info btn-sm" onclick="limpiarFormularioConsultorio()">üîÑ Nuevo Paciente</button>
              </div>
            </div>

            <!-- Panel de Ayuda Contextual -->
            <div id="panelAyudaConsultorio" style="display: none; background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border: 2px solid #3b82f6; border-radius: 12px; padding: 20px; margin-bottom: 20px; animation: fadeInDown 0.3s ease-out;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="font-weight: 700; color: #1e40af; margin: 0; display: flex; align-items: center; gap: 8px;">
                  <span style="font-size: 24px;">‚å®Ô∏è</span> Atajos de Teclado
                </h3>
                <button class="btn btn-secondary btn-sm" onclick="toggleAyudaConsultorio()">‚úñÔ∏è Cerrar</button>
              </div>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 12px;">
                <div style="background: white; padding: 12px; border-radius: 8px; border-left: 4px solid #3b82f6;">
                  <div style="font-weight: 700; color: #1f2937; margin-bottom: 5px;">F1 - Ayuda</div>
                  <div style="font-size: 12px; color: #6b7280;">Mostrar/ocultar este panel</div>
                </div>
                <div style="background: white; padding: 12px; border-radius: 8px; border-left: 4px solid #10b981;">
                  <div style="font-weight: 700; color: #1f2937; margin-bottom: 5px;">Ctrl + S - Guardar</div>
                  <div style="font-size: 12px; color: #6b7280;">Guardar consulta actual</div>
                </div>
                <div style="background: white; padding: 12px; border-radius: 8px; border-left: 4px solid #f59e0b;">
                  <div style="font-weight: 700; color: #1f2937; margin-bottom: 5px;">Ctrl + P - Imprimir</div>
                  <div style="font-size: 12px; color: #6b7280;">Guardar e imprimir prescripci√≥n</div>
                </div>
                <div style="background: white; padding: 12px; border-radius: 8px; border-left: 4px solid #8b5cf6;">
                  <div style="font-weight: 700; color: #1f2937; margin-bottom: 5px;">Ctrl + N - Nuevo</div>
                  <div style="font-size: 12px; color: #6b7280;">Limpiar formulario para nuevo paciente</div>
                </div>
                <div style="background: white; padding: 12px; border-radius: 8px; border-left: 4px solid #ef4444;">
                  <div style="font-weight: 700; color: #1f2937; margin-bottom: 5px;">Ctrl + F - Buscar</div>
                  <div style="font-size: 12px; color: #6b7280;">Enfocar campo de b√∫squeda</div>
                </div>
                <div style="background: white; padding: 12px; border-radius: 8px; border-left: 4px solid #06b6d4;">
                  <div style="font-weight: 700; color: #1f2937; margin-bottom: 5px;">Tab - Navegar</div>
                  <div style="font-size: 12px; color: #6b7280;">Moverse entre campos del formulario</div>
                </div>
              </div>
              <div style="background: #fef3c7; padding: 12px; border-radius: 8px; margin-top: 15px; border-left: 4px solid #f59e0b;">
                <div style="font-weight: 700; color: #92400e; margin-bottom: 5px;">üí° Consejo</div>
                <div style="font-size: 13px; color: #78350f;">El sistema guarda autom√°ticamente borradores cada 2 minutos para evitar p√©rdida de datos.</div>
              </div>
            </div>

            <!-- B√∫squeda de Paciente Mejorada -->
            <div class="card" style="background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%); border: 2px solid #e5e7eb;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <div class="card-title" style="margin: 0; padding: 0; border: none;">üîç Buscar Paciente</div>
                <div id="consultorioEstadoPaciente" style="background: #f3f4f6; color: #6b7280; padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: 600;">
                  Sin seleccionar
                </div>
              </div>
              <div class="row">
                <div class="field" style="flex: 2; position: relative;">
                  <label>DNI / Nombre del Paciente</label>
                  <div style="position: relative;">
                    <input id="consultorioBuscarPaciente" placeholder="Buscar por DNI, nombre o apellidos..." oninput="buscarPacienteConsultorioMejorado()" autocomplete="off" style="padding-left: 40px;">
                    <span style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); font-size: 18px;">üîç</span>
                    <div id="consultorioLoadingBusqueda" style="display: none; position: absolute; right: 12px; top: 50%; transform: translateY(-50%);">
                      <div style="width: 16px; height: 16px; border: 2px solid #3b82f6; border-top-color: transparent; border-radius: 50%; animation: spin 0.6s linear infinite;"></div>
                    </div>
                  </div>
                </div>
                <div class="field" style="flex: 0 0 150px;">
                  <label>&nbsp;</label>
                  <button class="btn btn-primary" onclick="buscarPacienteConsultorioMejorado()" style="width: 100%;">üîç Buscar</button>
                </div>
              </div>
              <!-- Resultados de b√∫squeda con dise√±o mejorado -->
              <div id="consultorioResultadosBusqueda" style="margin-top: 10px;"></div>

              <!-- Sugerencias r√°pidas -->
              <div id="consultorioSugerencias" style="display: none; margin-top: 15px; padding: 15px; background: #fef3c7; border-left: 4px solid #f59e0b; border-radius: 6px;">
                <div style="font-weight: 700; color: #92400e; margin-bottom: 8px;">üí° Sugerencias</div>
                <div id="consultorioSugerenciasLista" style="font-size: 13px; color: #78350f;">
                </div>
              </div>
            </div>

            <!-- Datos del Paciente (Editables) -->
            <div class="card">
              <div class="card-title">üë§ Datos del Paciente</div>
              <div class="row">
                <div class="field" style="flex: 0 0 150px;">
                  <label>DNI</label>
                  <input id="consultorioDNI" placeholder="Ingrese DNI" oninput="actualizarProgresoConsultorio()">
                </div>
                <div class="field" style="flex: 2;">
                  <label>Nombre Completo</label>
                  <input id="consultorioNombre" placeholder="Ingrese nombre completo" oninput="actualizarProgresoConsultorio()">
                </div>
                <div class="field">
                  <label>Tel√©fono</label>
                  <input id="consultorioTelefono" placeholder="Ingrese tel√©fono" oninput="actualizarProgresoConsultorio()">
                </div>
                <div class="field" style="flex: 0 0 120px;">
                  <label>Edad (Opcional)</label>
                  <input id="consultorioEdad" type="number" min="0" max="120" placeholder="Edad ‚Äî" oninput="validarEdad(this)">
                </div>
              </div>
            </div>

            <!-- Motivo de Consulta -->
            <div class="card">
              <div class="card-title">üìã Motivo de Consulta</div>
              <div class="row">
                <div class="field" style="flex: 1;">
                  <label>Motivo de Consulta</label>
                  <textarea id="consultorioMotivo" rows="2" placeholder="Indique el motivo de la consulta..." oninput="actualizarProgresoConsultorio()"></textarea>
                </div>
              </div>
            </div>

            <!-- Indicador de Progreso del Formulario -->
            <div style="background: white; border: 2px solid #e5e7eb; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <div style="font-weight: 700; color: #1f2937;">üìä Progreso del Formulario</div>
                <div id="consultorioProgresoTexto" style="font-weight: 700; color: #3b82f6; font-size: 18px;">0%</div>
              </div>
              <div style="background: #e5e7eb; height: 12px; border-radius: 6px; overflow: hidden;">
                <div id="consultorioProgresoBarra" style="background: linear-gradient(90deg, #3b82f6 0%, #2563eb 100%); height: 100%; width: 0%; transition: width 0.5s ease, background 0.3s ease; border-radius: 6px;"></div>
              </div>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top: 15px;">
                <div style="display: flex; align-items: center; gap: 8px;">
                  <span id="checkPaciente" style="font-size: 18px;">‚≠ï</span>
                  <span style="font-size: 13px; color: #6b7280;">Datos del Paciente</span>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                  <span id="checkMotivo" style="font-size: 18px;">‚≠ï</span>
                  <span style="font-size: 13px; color: #6b7280;">Motivo de Consulta</span>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                  <span id="checkPrescripcion" style="font-size: 18px;">‚≠ï</span>
                  <span style="font-size: 13px; color: #6b7280;">Prescripci√≥n</span>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                  <span id="checkDiagnostico" style="font-size: 18px;">‚≠ï</span>
                  <span style="font-size: 13px; color: #6b7280;">Diagn√≥stico</span>
                </div>
              </div>
            </div>

            <!-- üî¨ EXAMEN OPTOM√âTRICO - ESTRUCTURA EST√ÅNDAR UNIFICADA V3.0 ULTRA MODERNA -->
            <div class="consultorio-fullscreen-container">
              <h2 class="consultorio-main-title" style="background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%); color: white; padding: 12px; border-radius: 10px; text-align: center; font-size: 18px; margin-bottom: 12px; box-shadow: 0 4px 16px rgba(124, 58, 237, 0.25);">
                üëÅÔ∏è PRESCRIPCI√ìN DE LENTES
              </h2>

              <!-- ‚ú® SECCI√ìN: SISTEMA DE PESTA√ëAS PROFESIONAL (IGUAL QUE NUEVA RX) ‚ú® -->
              <div class="consultorio-section">
                <!-- BARRA DE HERRAMIENTAS SUPERIOR -->
                <div style="display: flex; gap: 8px; margin-bottom: 12px; padding: 10px; background: linear-gradient(135deg, #f8fafc, #f1f5f9); border-radius: 8px; border: 2px solid #e2e8f0;">
                  <button onclick="compararUltimaRX()" style="flex: 1; padding: 8px; background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; border: none; border-radius: 6px; font-weight: 700; font-size: 12px; cursor: pointer; box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3); transition: all 0.3s;">
                    üìä Comparar con √∫ltima RX
                  </button>
                  <button onclick="toggleAutoGuardadoConsultorio()" style="flex: 1; padding: 8px; background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; border-radius: 6px; font-weight: 700; font-size: 12px; cursor: pointer; box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3); transition: all 0.3s;">
                    üíæ Guardado autom√°tico: <span id="estadoAutoGuardado">Activado</span>
                  </button>
                </div>

                <!-- ‚ú® SISTEMA DE PESTA√ëAS MODERNO ‚ú® -->
                <div style="background: white; border-bottom: 2px solid #e5e7eb; margin: 0 0 0 0;">
                  <div style="display: flex; gap: 0;">
                    <button onclick="cambiarPestanaConsultorio('prescripcion')" id="tabConsultorioPrescripcion" style="flex: 1; padding: 10px 16px; border: none; background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%); color: white; font-weight: 700; font-size: 13px; cursor: pointer; border-radius: 8px 8px 0 0; transition: all 0.3s; box-shadow: 0 2px 8px rgba(124, 58, 237, 0.3);">
                      üìã Prescripci√≥n de Lentes
                    </button>
                    <button onclick="cambiarPestanaConsultorio('historial')" id="tabConsultorioHistorial" style="flex: 1; padding: 10px 16px; border: none; background: #f3f4f6; color: #6b7280; font-weight: 600; font-size: 13px; cursor: pointer; border-radius: 8px 8px 0 0; transition: all 0.3s;">
                      üìä Historial Cl√≠nico
                    </button>
                  </div>
                </div>

                <!-- ‚ú® CONTENIDO PESTA√ëA 1: PRESCRIPCI√ìN DE LENTES ‚ú® -->
                <div id="contenidoConsultorioPrescripcion" class="rx-tab-content" style="display: block;">
                  <div class="card">

                <!-- BANNER CON HISTORIAL DE PRESCRIPCIONES - COMPACTO -->
                <div id="bannerHistorialRX" style="background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; padding: 10px 14px; border-radius: 8px; margin-bottom: 12px; box-shadow: 0 3px 12px rgba(59, 130, 246, 0.3); display: flex; justify-content: space-between; align-items: center;">
                  <div>
                    <div style="font-size: 13px; font-weight: 700; margin-bottom: 2px;">üìã Historial de Prescripciones</div>
                    <div style="font-size: 10px; opacity: 0.95;" id="contadorPrescripciones">0 prescripci√≥n(es) registrada(s)</div>
                  </div>
                  <button onclick="toggleHistorialPrescripciones()" style="background: white; color: #2563eb; border: none; padding: 8px 14px; border-radius: 6px; font-weight: 700; cursor: pointer; font-size: 11px; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2); transition: all 0.3s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                    <span id="textoToggleHistorial">üìñ Ver Historial</span>
                  </button>
                </div>

                <!-- PANEL HISTORIAL EXPANDIBLE -->
                <div id="panelHistorialPrescripciones" style="display: none; background: #f8fafc; border: 3px solid #3b82f6; border-radius: 12px; padding: 20px; margin-bottom: 20px; max-height: 400px; overflow-y: auto;">
                  <div style="font-size: 14px; font-weight: 700; color: #1e40af; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                    <span>üìö</span>
                    <span>HISTORIAL COMPLETO DE PRESCRIPCIONES</span>
                  </div>
                  <div id="listaHistorialPrescripciones">
                    <!-- Se llena din√°micamente con JavaScript -->
                  </div>
                </div>

                <!-- SELECTOR DE TIPO DE VISI√ìN ULTRA MODERNO - COMPACTO -->
                <div style="display: flex; gap: 4px; margin-bottom: 10px; padding: 4px; background: #f8fafc; border-radius: 6px; border: 2px solid #e2e8f0;">
                  <button onclick="cambiarTipoVision('distancia')" id="btnVisionDistancia" style="flex: 1; padding: 6px 8px; background: linear-gradient(135deg, #7c3aed, #6b21a8); color: white; border: none; border-radius: 5px; font-weight: 700; cursor: pointer; box-shadow: 0 2px 6px rgba(124, 58, 237, 0.4); transition: all 0.3s; font-size: 10px;">
                    üëÅÔ∏è DISTANCIA
                  </button>
                  <button onclick="cambiarTipoVision('cerca')" id="btnVisionCerca" style="flex: 1; padding: 6px 8px; background: white; color: #7c3aed; border: 2px solid #7c3aed; border-radius: 5px; font-weight: 700; cursor: pointer; transition: all 0.3s; font-size: 10px;">
                    üëÅÔ∏è CERCA
                  </button>
                  <button onclick="cambiarTipoVision('intermedia')" id="btnVisionIntermedia" style="flex: 1; padding: 6px 8px; background: white; color: #7c3aed; border: 2px solid #7c3aed; border-radius: 5px; font-weight: 700; cursor: pointer; transition: all 0.3s; font-size: 10px;">
                    üëÅÔ∏è INTERMEDIA
                  </button>
                </div>

                <!-- TABLA UNIFICADA ULTRA PROFESIONAL - OPTIMIZADA 100% ZOOM -->
                <div style="overflow-x: auto; margin-bottom: 10px;">
                  <table style="width: 100%; border-collapse: collapse; font-size: 10px; border: 2px solid #7c3aed; box-shadow: 0 3px 10px rgba(124, 58, 237, 0.15); border-radius: 6px; overflow: hidden;">
                    <thead>
                      <tr style="background: linear-gradient(135deg, #a855f7, #9333ea); color: white;">
                        <th style="padding: 6px 4px; border: 1px solid #7c3aed; font-size: 10px; letter-spacing: 0.3px; width: 50px;"></th>
                        <th style="padding: 6px 4px; border: 1px solid #7c3aed; font-size: 10px; letter-spacing: 0.3px;">ESF</th>
                        <th style="padding: 6px 4px; border: 1px solid #7c3aed; font-size: 10px; letter-spacing: 0.3px;">CIL</th>
                        <th style="padding: 6px 4px; border: 1px solid #7c3aed; font-size: 10px; letter-spacing: 0.3px;">EJE</th>
                        <th style="padding: 6px 4px; border: 1px solid #7c3aed; font-size: 10px; letter-spacing: 0.3px;">DIP</th>
                        <th style="padding: 6px 4px; border: 1px solid #7c3aed; font-size: 10px; letter-spacing: 0.3px;">A.V</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr style="background: linear-gradient(135deg, #f3e8ff, #e9d5ff);">
                        <td style="padding: 4px; border: 1px solid #7c3aed; font-weight: 800; color: #7c3aed; font-size: 11px; text-align: center;">O.D.</td>
                        <td style="padding: 2px; border: 1px solid #7c3aed;"><input id="rxDistEsfOD" oninput="validarCampoRX(this); marcarCambio(this)" style="width: 100%; padding: 4px; border: 1px solid #cbd5e1; border-radius: 3px; text-align: center; font-weight: 600; font-size: 11px; transition: all 0.3s;" placeholder="0.00"></td>
                        <td style="padding: 2px; border: 1px solid #7c3aed;"><input id="rxDistCilOD" oninput="validarCampoRX(this); marcarCambio(this)" style="width: 100%; padding: 4px; border: 1px solid #cbd5e1; border-radius: 3px; text-align: center; font-weight: 600; font-size: 11px; transition: all 0.3s;" placeholder="0.00"></td>
                        <td style="padding: 2px; border: 1px solid #7c3aed;"><input id="rxDistEjeOD" oninput="validarCampoRX(this); marcarCambio(this)" onblur="normalizarEje(this)" style="width: 100%; padding: 4px; border: 1px solid #cbd5e1; border-radius: 3px; text-align: center; font-weight: 600; font-size: 11px; transition: all 0.3s;" placeholder="0¬∞"></td>
                        <td style="padding: 2px; border: 1px solid #7c3aed;"><input id="rxDistDipOD" oninput="validarCampoRX(this); marcarCambio(this)" style="width: 100%; padding: 4px; border: 1px solid #cbd5e1; border-radius: 3px; text-align: center; font-weight: 600; font-size: 11px; transition: all 0.3s;" placeholder="0.0"></td>
                        <td style="padding: 2px; border: 1px solid #7c3aed;"><input id="rxDistAvOD" style="width: 100%; padding: 4px; border: 1px solid #cbd5e1; border-radius: 3px; text-align: center; font-weight: 600; font-size: 11px;" placeholder="20/"></td>
                      </tr>
                      <tr style="background: white;">
                        <td style="padding: 4px; border: 1px solid #7c3aed; font-weight: 800; color: #7c3aed; font-size: 11px; text-align: center;">O.I.</td>
                        <td style="padding: 2px; border: 1px solid #7c3aed;"><input id="rxDistEsfOI" oninput="validarCampoRX(this); marcarCambio(this)" style="width: 100%; padding: 4px; border: 1px solid #cbd5e1; border-radius: 3px; text-align: center; font-weight: 600; font-size: 11px; transition: all 0.3s;" placeholder="0.00"></td>
                        <td style="padding: 2px; border: 1px solid #7c3aed;"><input id="rxDistCilOI" oninput="validarCampoRX(this); marcarCambio(this)" style="width: 100%; padding: 4px; border: 1px solid #cbd5e1; border-radius: 3px; text-align: center; font-weight: 600; font-size: 11px; transition: all 0.3s;" placeholder="0.00"></td>
                        <td style="padding: 2px; border: 1px solid #7c3aed;"><input id="rxDistEjeOI" oninput="validarCampoRX(this); marcarCambio(this)" onblur="normalizarEje(this)" style="width: 100%; padding: 4px; border: 1px solid #cbd5e1; border-radius: 3px; text-align: center; font-weight: 600; font-size: 11px; transition: all 0.3s;" placeholder="0¬∞"></td>
                        <td style="padding: 2px; border: 1px solid #7c3aed;"><input id="rxDistDipOI" oninput="validarCampoRX(this); marcarCambio(this)" style="width: 100%; padding: 4px; border: 1px solid #cbd5e1; border-radius: 3px; text-align: center; font-weight: 600; font-size: 11px; transition: all 0.3s;" placeholder="0.0"></td>
                        <td style="padding: 2px; border: 1px solid #7c3aed;"><input id="rxDistAvOI" style="width: 100%; padding: 4px; border: 1px solid #cbd5e1; border-radius: 3px; text-align: center; font-weight: 600; font-size: 11px;" placeholder="20/"></td>
                      </tr>
                    </tbody>
                  </table>
                </div>

                <!-- CAMPOS OCULTOS PARA CERCA E INTERMEDIA (mantener compatibilidad) -->
                <div style="display: none;">
                  <input id="rxCercaEsfOD"><input id="rxCercaCilOD"><input id="rxCercaEjeOD"><input id="rxCercaDipOD">
                  <input id="rxCercaEsfOI"><input id="rxCercaCilOI"><input id="rxCercaEjeOI"><input id="rxCercaDipOI">
                  <input id="rxInterEsfOD"><input id="rxInterCilOD"><input id="rxInterEjeOD"><input id="rxInterDipOD">
                  <input id="rxInterEsfOI"><input id="rxInterCilOI"><input id="rxInterEjeOI"><input id="rxInterDipOI">
                </div>

                <!-- INDICADOR DE GUARDADO AUTOM√ÅTICO -->
                <div id="indicadorAutoGuardado" style="display: none; padding: 12px; background: linear-gradient(135deg, #10b981, #059669); color: white; border-radius: 8px; margin-bottom: 20px; text-align: center; font-weight: 700; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); animation: fadeInOut 2s;">
                  ‚úì Cambios guardados autom√°ticamente
                </div>

                <!-- PRESI√ìN INTRAOCULAR (PIO) Y DIAGN√ìSTICO - LAYOUT OPTIMIZADO 100% ZOOM -->
                <div style="display: grid; grid-template-columns: 0.8fr 2fr; gap: 10px; margin-bottom: 10px;">
                  <!-- PRESI√ìN INTRAOCULAR (PIO) - COMPACTO -->
                  <div>
                    <div style="background: linear-gradient(135deg, #374151, #1f2937); color: white; padding: 4px; border-radius: 5px; margin-bottom: 6px; font-weight: 700; text-align: center; font-size: 10px; box-shadow: 0 2px 6px rgba(55, 65, 81, 0.3);">
                      üìä PIO
                    </div>
                    <div style="display: grid; gap: 6px;">
                      <div>
                        <label style="font-weight: 600; color: #374151; font-size: 9px; display: block; margin-bottom: 2px;">OD (mmHg)</label>
                        <input type="text" id="rxPioOD" placeholder="15" style="width: 100%; padding: 4px; border: 1px solid #cbd5e1; border-radius: 3px; font-size: 11px; text-align: center; font-weight: 600;">
                      </div>
                      <div>
                        <label style="font-weight: 600; color: #374151; font-size: 9px; display: block; margin-bottom: 2px;">OI (mmHg)</label>
                        <input type="text" id="rxPioOI" placeholder="14" style="width: 100%; padding: 4px; border: 1px solid #cbd5e1; border-radius: 3px; font-size: 11px; text-align: center; font-weight: 600;">
                      </div>
                    </div>
                  </div>

                  <!-- DIAGN√ìSTICO - GRID 3 COLUMNAS COMPACTO -->
                  <div>
                    <div style="background: linear-gradient(135deg, #374151, #1f2937); color: white; padding: 4px; border-radius: 5px; margin-bottom: 6px; font-weight: 700; text-align: center; font-size: 10px; box-shadow: 0 2px 6px rgba(55, 65, 81, 0.3);">
                      üîç DIAGN√ìSTICO
                    </div>
                    <div style="background: linear-gradient(135deg, #f3f4f6, #e5e7eb); padding: 8px; border-radius: 5px; border: 2px solid #7c3aed;">
                      <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px;">
                        <label style="display: flex; align-items: center; gap: 4px; font-size: 10px; cursor: pointer; font-weight: 600;">
                          <input type="checkbox" id="diagMiopia" onchange="guardarDiagnosticoAutomatico()" style="width: 14px; height: 14px; cursor: pointer; accent-color: #7c3aed;">
                          <span>Miop√≠a</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 4px; font-size: 10px; cursor: pointer; font-weight: 600;">
                          <input type="checkbox" id="diagHipermetropia" onchange="guardarDiagnosticoAutomatico()" style="width: 14px; height: 14px; cursor: pointer; accent-color: #7c3aed;">
                          <span>Hipermetrop√≠a</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 4px; font-size: 10px; cursor: pointer; font-weight: 600;">
                          <input type="checkbox" id="diagAstigmatismo" onchange="guardarDiagnosticoAutomatico()" style="width: 14px; height: 14px; cursor: pointer; accent-color: #7c3aed;">
                          <span>Astigmatismo</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 4px; font-size: 10px; cursor: pointer; font-weight: 600;">
                          <input type="checkbox" id="diagPresbicia" onchange="guardarDiagnosticoAutomatico()" style="width: 14px; height: 14px; cursor: pointer; accent-color: #7c3aed;">
                          <span>Presbicia</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 4px; font-size: 10px; cursor: pointer; font-weight: 600;">
                          <input type="checkbox" id="diagAmbliopia" onchange="guardarDiagnosticoAutomatico()" style="width: 14px; height: 14px; cursor: pointer; accent-color: #7c3aed;">
                          <span>Ambliop√≠a</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 4px; font-size: 10px; cursor: pointer; font-weight: 600;">
                          <input type="checkbox" id="diagAnisometropia" onchange="guardarDiagnosticoAutomatico()" style="width: 14px; height: 14px; cursor: pointer; accent-color: #7c3aed;">
                          <span>Anisometrop√≠a</span>
                        </label>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- OBSERVACIONES Y ESPECIALISTA - COMPACTO -->
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 10px; margin-bottom: 10px;">
                  <div>
                    <label style="font-weight: 700; color: #374151; font-size: 10px; display: block; margin-bottom: 4px;">üìù Observaciones</label>
                    <textarea id="rxObservaciones" rows="2" placeholder="Observaciones adicionales..." style="width: 100%; border: 1px solid #cbd5e1; border-radius: 4px; padding: 6px; font-size: 10px; resize: vertical;"></textarea>
                  </div>
                  <div>
                    <label style="font-weight: 700; color: #374151; font-size: 10px; display: block; margin-bottom: 4px;">üë®‚Äç‚öïÔ∏è Especialista</label>
                    <input type="text" id="rxEspecialista" placeholder="Nombre del especialista" style="width: 100%; border: 1px solid #cbd5e1; border-radius: 4px; padding: 6px; font-size: 10px; font-weight: 600;">
                  </div>
                </div>
                </div>
              </div>

              </div> <!-- Fin contenido Prescripci√≥n -->

              <!-- ‚ú® CONTENIDO PESTA√ëA 2: HISTORIAL CL√çNICO PROFESIONAL ‚ú® -->
              <div id="contenidoConsultorioHistorial" class="rx-tab-content" style="display: none;">

                <!-- NAVEGACI√ìN ULTRA MODERNA CON PILLS - ANIMACIONES FLUIDAS -->
                <div style="background: linear-gradient(135deg, #f8fafc, #e2e8f0); padding: 10px 12px; border-radius: 10px; margin-bottom: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08), 0 2px 6px rgba(0,0,0,0.04);">
                  <div style="display: flex; gap: 6px; flex-wrap: wrap; justify-content: center;">
                    <button onclick="cambiarSubPestanaHistorial('anamnesis')" id="subTabAnamnesis" class="pill-button-animate" style="padding: 7px 14px; border: 2px solid #3b82f6; background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; border-radius: 18px; font-weight: 700; font-size: 10px; cursor: pointer; transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); box-shadow: 0 4px 12px rgba(59,130,246,0.4); position: relative; overflow: hidden;">
                      üìã Anamnesis
                    </button>
                    <button onclick="cambiarSubPestanaHistorial('agudeza')" id="subTabAgudeza" class="pill-button-animate" style="padding: 7px 14px; border: 2px solid #10b981; background: white; color: #10b981; border-radius: 18px; font-weight: 700; font-size: 10px; cursor: pointer; transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); position: relative; overflow: hidden;">
                      üëÅÔ∏è Agudeza
                    </button>
                    <button onclick="cambiarSubPestanaHistorial('motilidad')" id="subTabMotilidad" class="pill-button-animate" style="padding: 7px 14px; border: 2px solid #8b5cf6; background: white; color: #8b5cf6; border-radius: 18px; font-weight: 700; font-size: 10px; cursor: pointer; transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); position: relative; overflow: hidden;">
                      üîÑ Motilidad
                    </button>
                    <button onclick="cambiarSubPestanaHistorial('reflejos')" id="subTabReflejos" class="pill-button-animate" style="padding: 7px 14px; border: 2px solid #f59e0b; background: white; color: #f59e0b; border-radius: 18px; font-weight: 700; font-size: 10px; cursor: pointer; transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); position: relative; overflow: hidden;">
                      ‚ú® Reflejos
                    </button>
                    <button onclick="cambiarSubPestanaHistorial('oftalmoscopia')" id="subTabOftalmoscopia" class="pill-button-animate" style="padding: 7px 14px; border: 2px solid #ec4899; background: white; color: #ec4899; border-radius: 18px; font-weight: 700; font-size: 10px; cursor: pointer; transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); position: relative; overflow: hidden;">
                      üî¨ Oftalmoscop√≠a
                    </button>
                    <button onclick="cambiarSubPestanaHistorial('keratometria')" id="subTabKeratometria" class="pill-button-animate" style="padding: 7px 14px; border: 2px solid #14b8a6; background: white; color: #14b8a6; border-radius: 18px; font-weight: 700; font-size: 10px; cursor: pointer; transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); position: relative; overflow: hidden;">
                      üìê Keratometr√≠a
                    </button>
                    <button onclick="cambiarSubPestanaHistorial('retinoscopia')" id="subTabRetinoscopia" class="pill-button-animate" style="padding: 7px 14px; border: 2px solid #6366f1; background: white; color: #6366f1; border-radius: 18px; font-weight: 700; font-size: 10px; cursor: pointer; transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); position: relative; overflow: hidden;">
                      üåü Retinoscop√≠a
                    </button>
                    <button onclick="cambiarSubPestanaHistorial('refraccion')" id="subTabRefraccion" class="pill-button-animate" style="padding: 7px 14px; border: 2px solid #06b6d4; background: white; color: #06b6d4; border-radius: 18px; font-weight: 700; font-size: 10px; cursor: pointer; transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); position: relative; overflow: hidden;">
                      ‚úÖ Refracci√≥n
                    </button>
                    <button onclick="cambiarSubPestanaHistorial('diagnostico')" id="subTabDiagnostico" class="pill-button-animate" style="padding: 7px 14px; border: 2px solid #ef4444; background: white; color: #ef4444; border-radius: 18px; font-weight: 700; font-size: 10px; cursor: pointer; transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); position: relative; overflow: hidden;">
                      üè• Diagn√≥stico
                    </button>
                    <button onclick="cambiarSubPestanaHistorial('examinador')" id="subTabExaminador" class="pill-button-animate" style="padding: 7px 14px; border: 2px solid #64748b; background: white; color: #64748b; border-radius: 18px; font-weight: 700; font-size: 10px; cursor: pointer; transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); position: relative; overflow: hidden;">
                      üë®‚Äç‚öïÔ∏è Examinador
                    </button>
                  </div>
                </div>

                <!-- CONTENEDOR DE CONTENIDO DE SUB-PESTA√ëAS -->
                <div id="contenedorSubPestanas" style="min-height: 400px;">
                  <!-- El contenido se carga din√°micamente seg√∫n la sub-pesta√±a seleccionada -->
                </div>

              </div> <!-- Fin contenido Historial Cl√≠nico -->

              </div> <!-- Fin consultorio-section -->
            </div>

            <!-- ==================== HISTORIAL CL√çNICO COMPLETO - COMENTADO TEMPORALMENTE ==================== -->
            <!--
            ‚ö†Ô∏è SECCI√ìN TEMPORALMENTE DESACTIVADA PARA ELIMINAR REDUNDANCIA ‚ö†Ô∏è

            Esta secci√≥n conten√≠a informaci√≥n profesional valiosa que ahora se encuentra en la pesta√±a
            "Historial Cl√≠nico" del sistema de pesta√±as unificado (arriba).

            Campos que conten√≠a:
            - Anamnesis (descripci√≥n s√≠ntomas, antecedentes personales HTA/DM/OA, alergias, necesidad visual)
            - Agudeza Visual (con correcci√≥n y sin correcci√≥n: Lejos/Cerca/PH/OD/OI/AO)
            - Motilidad Ocular (KAPPA, HIRSCHBERG, COVER TEST, PPC, DUCCIONES, VERSIONES)
            - Reflejos Pupilares (Fotomotor, Consensual, Acomodativo)
            - Examen Externo (P√°rpados, Conjuntiva, C√≥rnea, Iris, Cristalino para OD y OI)
            - Oftalmoscop√≠a (Papila, Excavaci√≥n, Vasos, Rel. A/V, M√°cula, Reflejo)
            - Keratometr√≠a (OD y OI con mediciones Horizontal/Vertical, A.C., A.T.E.)
            - Retinoscop√≠a (ESF, CIL, EJE, AV mono/AO, DIP)
            - Refracci√≥n Final (ESF, CIL, EJE, AV mono/AO, DIP, ADD Cerca, Rx Cerca, Observaciones)
            - Diagn√≥stico, Manejo y Controles
            - Informaci√≥n del Examinador (Examinador, Grupo de Pr√°ctica, Ciclo/Turno, Firma Supervisor)

            Si necesitas activar esta secci√≥n nuevamente, elimina este comentario y descomenta el c√≥digo.
            -->
            <!--
            <div class="consultorio-section" style="margin-top: 30px;">
              <h3 class="consultorio-section-header" style="background: linear-gradient(135deg, #1e40af 0%, #1d4ed8 100%); color: white; padding: 16px 24px; border-radius: 12px; font-size: 20px; text-align: center; box-shadow: 0 4px 15px rgba(30, 64, 175, 0.3); margin-bottom: 24px;">
                üìã HISTORIA CL√çNICA COMPLETA - OPTOMETR√çA PROFESIONAL
              </h3>

              <!-- ANAMNESIS Y ANTECEDENTES -->
              <div class="card" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.05) 0%, rgba(147, 197, 253, 0.05) 100%); border: 2px solid rgba(59, 130, 246, 0.2);">
                <div class="card-title" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; margin: -24px -24px 20px -24px; padding: 14px 20px; border-radius: 14px 14px 0 0;">
                  üìù ANAMNESIS
                </div>
                <div class="row">
                  <div class="field" style="flex: 1;">
                    <label style="font-weight: 700; color: #1e40af;">Anamnesis</label>
                    <textarea id="hcAnamnesis" rows="4" placeholder="Descripci√≥n detallada de s√≠ntomas, molestias y motivo de consulta..." style="border: 2px solid #93c5fd; border-radius: 8px; font-size: 13px;"></textarea>
                  </div>
                </div>

                <div style="background: #dbeafe; padding: 12px; border-radius: 8px; margin: 16px 0;">
                  <label style="font-weight: 700; color: #1e40af; display: block; margin-bottom: 8px;">ANTECEDENTES PERSONALES</label>
                  <div class="row" style="gap: 16px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                      <input type="checkbox" id="hcAntHTA" style="width: 18px; height: 18px; cursor: pointer; accent-color: #3b82f6;">
                      <span style="font-weight: 600;">HTA (Hipertensi√≥n)</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                      <input type="checkbox" id="hcAntDM" style="width: 18px; height: 18px; cursor: pointer; accent-color: #3b82f6;">
                      <span style="font-weight: 600;">DM (Diabetes)</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                      <input type="checkbox" id="hcAntOA" style="width: 18px; height: 18px; cursor: pointer; accent-color: #3b82f6;">
                      <span style="font-weight: 600;">OA (Osteoartritis)</span>
                    </label>
                  </div>
                  <div class="row" style="margin-top: 12px;">
                    <div class="field" style="flex: 1;">
                      <input type="text" id="hcAntOtros" placeholder="Otros antecedentes personales..." style="border: 2px solid #93c5fd; border-radius: 6px;">
                    </div>
                  </div>
                </div>

                <div class="row" style="margin-top: 16px;">
                  <div class="field" style="flex: 1;">
                    <label style="font-weight: 700; color: #1e40af;">Alergias</label>
                    <input type="text" id="hcAlergias" placeholder="Alergias conocidas..." style="border: 2px solid #93c5fd; border-radius: 6px;">
                  </div>
                </div>

                <div style="background: #dbeafe; padding: 12px; border-radius: 8px; margin: 16px 0;">
                  <label style="font-weight: 700; color: #1e40af; display: block; margin-bottom: 8px;">NECESIDAD VISUAL</label>
                  <div class="row" style="gap: 16px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                      <input type="checkbox" id="hcNecVL" style="width: 18px; height: 18px; cursor: pointer; accent-color: #3b82f6;">
                      <span style="font-weight: 600;">(OA) VL (Visi√≥n Lejana)</span>
                    label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                      <input type="checkbox" id="hcNecVC" style="width: 18px; height: 18px; cursor: pointer; accent-color: #3b82f6;">
                      <span style="font-weight: 600;">(onom) VA (Visi√≥n Aumentada)</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                      <input type="checkbox" id="hcNecBILA" style="width: 18px; height: 18px; cursor: pointer; accent-color: #3b82f6;">
                      <span style="font-weight: 600;">BILA (Bilateral)</span>
                    </label>
                  </div>
                </div>
              </div>

              <!-- AGUDEZA VISUAL -->
              <div class="card" style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.05) 0%, rgba(134, 239, 172, 0.05) 100%); border: 2px solid rgba(34, 197, 94, 0.2); margin-top: 20px;">
                <div class="card-title" style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: white; margin: -24px -24px 20px -24px; padding: 14px 20px; border-radius: 14px 14px 0 0;">
                  üëÅÔ∏è AGUDEZA VISUAL
                </div>

                <!-- CON CORRECCI√ìN -->
                <div style="background: #dcfce7; padding: 14px; border-radius: 8px; margin-bottom: 16px;">
                  <h4 style="color: #15803d; font-weight: 700; margin-bottom: 12px; font-size: 15px;">CON CORRECCI√ìN</h4>
                  <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                    <div>
                      <label style="font-weight: 600; color: #166534; font-size: 13px;">Lejos</label>
                      <input type="text" id="hcAVCCLejos" placeholder="Ej: 20/20" style="width: 100%; border: 2px solid #86efac; border-radius: 6px; padding: 8px;">
                    </div>
                    <div>
                      <label style="font-weight: 600; color: #166534; font-size: 13px;">Cerca</label>
                      <input type="text" id="hcAVCCCerca" placeholder="Ej: 20/20" style="width: 100%; border: 2px solid #86efac; border-radius: 6px; padding: 8px;">
                    </div>
                    <div>
                      <label style="font-weight: 600; color: #166534; font-size: 13px;">P.H.</label>
                      <input type="text" id="hcAVCCPH" placeholder="..." style="width: 100%; border: 2px solid #86efac; border-radius: 6px; padding: 8px;">
                    </div>
                  </div>
                  <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-top: 12px;">
                    <div>
                      <label style="font-weight: 600; color: #166534; font-size: 13px;">OD</label>
                      <input type="text" id="hcAVCCOD" style="width: 100%; border: 2px solid #86efac; border-radius: 6px; padding: 8px;">
                    </div>
                    <div>
                      <label style="font-weight: 600; color: #166534; font-size: 13px;">OI</label>
                      <input type="text" id="hcAVCCOI" style="width: 100%; border: 2px solid #86efac; border-radius: 6px; padding: 8px;">
                    </div>
                    <div>
                      <label style="font-weight: 600; color: #166534; font-size: 13px;">AO</label>
                      <input type="text" id="hcAVCCAO" style="width: 100%; border: 2px solid #86efac; border-radius: 6px; padding: 8px;">
                    </div>
                  </div>
                </div>

                <!-- SIN CORRECCI√ìN -->
                <div style="background: #fef3c7; padding: 14px; border-radius: 8px;">
                  <h4 style="color: #92400e; font-weight: 700; margin-bottom: 12px; font-size: 15px;">SIN CORRECCI√ìN: HERN</h4>
                  <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                    <div>
                      <label style="font-weight: 600; color: #78350f; font-size: 13px;">Lejos</label>
                      <input type="text" id="hcAVSCLejos" placeholder="Ej: 20/40" style="width: 100%; border: 2px solid #fde68a; border-radius: 6px; padding: 8px;">
                    </div>
                    <div>
                      <label style="font-weight: 600; color: #78350f; font-size: 13px;">Cerca</label>
                      <input type="text" id="hcAVSCCerca" placeholder="Ej: 20/30" style="width: 100%; border: 2px solid #fde68a; border-radius: 6px; padding: 8px;">
                    </div>
                    <div>
                      <label style="font-weight: 600; color: #78350f; font-size: 13px;">P.H.</label>
                      <input type="text" id="hcAVSCPH" placeholder="..." style="width: 100%; border: 2px solid #fde68a; border-radius: 6px; padding: 8px;">
                    </div>
                  </div>
                  <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-top: 12px;">
                    <div>
                      <label style="font-weight: 600; color: #78350f; font-size: 13px;">OD</label>
                      <input type="text" id="hcAVSCOD" style="width: 100%; border: 2px solid #fde68a; border-radius: 6px; padding: 8px;">
                    </div>
                    <div>
                      <label style="font-weight: 600; color: #78350f; font-size: 13px;">OI</label>
                      <input type="text" id="hcAVSCOI" style="width: 100%; border: 2px solid #fde68a; border-radius: 6px; padding: 8px;">
                    </div>
                    <div>
                      <label style="font-weight: 600; color: #78350f; font-size: 13px;">AO</label>
                      <input type="text" id="hcAVSCAO" style="width: 100%; border: 2px solid #fde68a; border-radius: 6px; padding: 8px;">
                    </div>
                  </div>
                </div>
              </div>

              <!-- MOTILIDAD OCULAR -->
              <div class="card" style="background: linear-gradient(135deg, rgba(168, 85, 247, 0.05) 0%, rgba(217, 70, 239, 0.05) 100%); border: 2px solid rgba(168, 85, 247, 0.2); margin-top: 20px;">
                <div class="card-title" style="background: linear-gradient(135deg, #a855f7 0%, #9333ea 100%); color: white; margin: -24px -24px 20px -24px; padding: 14px 20px; border-radius: 14px 14px 0 0;">
                  üîÑ MOTILIDAD OCULAR
                </div>

                <div class="row">
                  <div class="field">
                    <label style="font-weight: 700; color: #7c3aed;">KAPPA OD:</label>
                    <input type="text" id="hcMotKappaOD" placeholder="..." style="border: 2px solid #d8b4fe; border-radius: 6px;">
                  </div>
                  <div class="field">
                    <label style="font-weight: 700; color: #7c3aed;">KAPPA OI:</label>
                    <input type="text" id="hcMotKappaOI" placeholder="..." style="border: 2px solid #d8b4fe; border-radius: 6px;">
                  </div>
                  <div class="field">
                    <label style="font-weight: 700; color: #7c3aed;">HIRSCHBERG:</label>
                    <input type="text" id="hcMotHirschberg" placeholder="..." style="border: 2px solid #d8b4fe; border-radius: 6px;">
                  </div>
                </div>

                <div class="row" style="margin-top: 16px;">
                  <div class="field">
                    <label style="font-weight: 700; color: #7c3aed;">COVER TEST</label>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 8px;">
                      <div>
                        <label style="font-size: 12px; font-weight: 600;">6m:</label>
                        <input type="text" id="hcCoverTest6m" style="width: 100%; border: 2px solid #d8b4fe; border-radius: 6px; padding: 6px;">
                      </div>
                      <div>
                        <label style="font-size: 12px; font-weight: 600;">40cm:</label>
                        <input type="text" id="hcCoverTest40cm" style="width: 100%; border: 2px solid #d8b4fe; border-radius: 6px; padding: 6px;">
                      </div>
                      <div>
                        <label style="font-size: 12px; font-weight: 600;">20cm:</label>
                        <input type="text" id="hcCoverTest20cm" style="width: 100%; border: 2px solid #d8b4fe; border-radius: 6px; padding: 6px;">
                      </div>
                    </div>
                  </div>
                </div>

                <div class="row" style="margin-top: 16px;">
                  <div class="field">
                    <label style="font-weight: 700; color: #7c3aed;">PPC (Punto Pr√≥ximo de Convergencia)</label>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 8px;">
                      <div>
                        <label style="font-size: 12px; font-weight: 600;">OR:</label>
                        <input type="text" id="hcPPCOR" style="width: 100%; border: 2px solid #d8b4fe; border-radius: 6px; padding: 6px;">
                      </div>
                      <div>
                        <label style="font-size: 12px; font-weight: 600;">LUZ:</label>
                        <input type="text" id="hcPPCLuz" style="width: 100%; border: 2px solid #d8b4fe; border-radius: 6px; padding: 6px;">
                      </div>
                      <div>
                        <label style="font-size: 12px; font-weight: 600;">FR+L:</label>
                        <input type="text" id="hcPPCFRPL" style="width: 100%; border: 2px solid #d8b4fe; border-radius: 6px; padding: 6px;">
                      </div>
                    </div>
                  </div>
                </div>

                <div class="row" style="margin-top: 16px;">
                  <div class="field" style="flex: 1;">
                    <label style="font-weight: 700; color: #7c3aed;">DUCCIONES</label>
                    <textarea id="hcDucciones" rows="2" placeholder="Ducciones..." style="border: 2px solid #d8b4fe; border-radius: 6px;"></textarea>
                  </div>
                  <div class="field" style="flex: 1;">
                    <label style="font-weight: 700; color: #7c3aed;">VERSIONES</label>
                    <textarea id="hcVersiones" rows="2" placeholder="Versiones..." style="border: 2px solid #d8b4fe; border-radius: 6px;"></textarea>
                  </div>
                </div>

                <div class="row" style="margin-top: 16px;">
                  <div class="field" style="flex: 1;">
                    <label style="font-weight: 700; color: #7c3aed;">Observaciones Motilidad:</label>
                    <textarea id="hcMotObservaciones" rows="2" placeholder="Observaciones adicionales..." style="border: 2px solid #d8b4fe; border-radius: 6px;"></textarea>
                  </div>
                </div>
              </div>

              <!-- REFLEJOS PUPILARES Y EXAMEN EXTERNO -->
              <div class="card" style="background: linear-gradient(135deg, rgba(239, 68, 68, 0.05) 0%, rgba(252, 165, 165, 0.05) 100%); border: 2px solid rgba(239, 68, 68, 0.2); margin-top: 20px;">
                <div class="card-title" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; margin: -24px -24px 20px -24px; padding: 14px 20px; border-radius: 14px 14px 0 0;">
                  üî¶ REFLEJOS PUPILARES & EXAMEN EXTERNO
                </div>

                <div style="background: #fee2e2; padding: 14px; border-radius: 8px; margin-bottom: 16px;">
                  <h4 style="color: #991b1b; font-weight: 700; margin-bottom: 12px;">REFLEJOS PUPILARES</h4>
                  <div class="row">
                    <div class="field">
                      <label style="font-weight: 600; color: #7f1d1d;">Fotomotor:</label>
                      <input type="text" id="hcRefFotomotor" placeholder="..." style="border: 2px solid #fca5a5; border-radius: 6px;">
                    </div>
                    <div class="field">
                      <label style="font-weight: 600; color: #7f1d1d;">Consensual:</label>
                      <input type="text" id="hcRefConsensual" placeholder="..." style="border: 2px solid #fca5a5; border-radius: 6px;">
                    </div>
                    <div class="field">
                      <label style="font-weight: 600; color: #7f1d1d;">Acomodativo:</label>
                      <input type="text" id="hcRefAcomodativo" placeholder="..." style="border: 2px solid #fca5a5; border-radius: 6px;">
                    </div>
                  </div>
                </div>

                <div style="background: #fef2f2; padding: 14px; border-radius: 8px;">
                  <h4 style="color: #991b1b; font-weight: 700; margin-bottom: 12px;">EXAMEN EXTERNO</h4>
                  <table style="width: 100%; border-collapse: collapse; border: 2px solid #fca5a5;">
                    <thead>
                      <tr style="background: #fecaca;">
                        <th style="padding: 10px; border: 2px solid #fca5a5; color: #7f1d1d;"></th>
                        <th style="padding: 10px; border: 2px solid #fca5a5; color: #7f1d1d;">P√ÅRPADOS</th>
                        <th style="padding: 10px; border: 2px solid #fca5a5; color: #7f1d1d;">CONJUNTIVA</th>
                        <th style="padding: 10px; border: 2px solid #fca5a5; color: #7f1d1d;">C√ìRNEA</th>
                        <th style="padding: 10px; border: 2px solid #fca5a5; color: #7f1d1d;">IRIS</th>
                        <th style="padding: 10px; border: 2px solid #fca5a5; color: #7f1d1d;">CRISTALINO</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr style="background: white;">
                        <td style="padding: 8px; border: 2px solid #fca5a5; font-weight: 700; color: #991b1b;">OD</td>
                        <td style="padding: 4px; border: 2px solid #fca5a5;"><input type="text" id="hcExExtODParpados" style="width: 100%; border: 1px solid #fca5a5; border-radius: 4px; padding: 6px;"></td>
                        <td style="padding: 4px; border: 2px solid #fca5a5;"><input type="text" id="hcExExtODConjuntiva" style="width: 100%; border: 1px solid #fca5a5; border-radius: 4px; padding: 6px;"></td>
                        <td style="padding: 4px; border: 2px solid #fca5a5;"><input type="text" id="hcExExtODCornea" style="width: 100%; border: 1px solid #fca5a5; border-radius: 4px; padding: 6px;"></td>
                        <td style="padding: 4px; border: 2px solid #fca5a5;"><input type="text" id="hcExExtODIris" style="width: 100%; border: 1px solid #fca5a5; border-radius: 4px; padding: 6px;"></td>
                        <td style="padding: 4px; border: 2px solid #fca5a5;"><input type="text" id="hcExExtODCristalino" style="width: 100%; border: 1px solid #fca5a5; border-radius: 4px; padding: 6px;"></td>
                      </tr>
                      <tr style="background: #fff5f5;">
                        <td style="padding: 8px; border: 2px solid #fca5a5; font-weight: 700; color: #991b1b;">OI</td>
                        <td style="padding: 4px; border: 2px solid #fca5a5;"><input type="text" id="hcExExtOIParpados" style="width: 100%; border: 1px solid #fca5a5; border-radius: 4px; padding: 6px;"></td>
                        <td style="padding: 4px; border: 2px solid #fca5a5;"><input type="text" id="hcExExtOIConjuntiva" style="width: 100%; border: 1px solid #fca5a5; border-radius: 4px; padding: 6px;"></td>
                        <td style="padding: 4px; border: 2px solid #fca5a5;"><input type="text" id="hcExExtOICornea" style="width: 100%; border: 1px solid #fca5a5; border-radius: 4px; padding: 6px;"></td>
                        <td style="padding: 4px; border: 2px solid #fca5a5;"><input type="text" id="hcExExtOIIris" style="width: 100%; border: 1px solid #fca5a5; border-radius: 4px; padding: 6px;"></td>
                        <td style="padding: 4px; border: 2px solid #fca5a5;"><input type="text" id="hcExExtOICristalino" style="width: 100%; border: 1px solid #fca5a5; border-radius: 4px; padding: 6px;"></td>
                      </tr>
                    </tbody>
                  </table>
                  <div class="row" style="margin-top: 12px;">
                    <div class="field" style="flex: 1;">
                      <label style="font-weight: 600; color: #7f1d1d;">Observaciones Examen Externo:</label>
                      <textarea id="hcExExtObservaciones" rows="2" placeholder="Observaciones..." style="border: 2px solid #fca5a5; border-radius: 6px;"></textarea>
                    </div>
                  </div>
                </div>
              </div>

              <!-- P√ÅGINA 2: OFTALMOSCOP√çA, KERATOMETR√çA, RETINOSCOP√çA -->
              <div class="card" style="background: linear-gradient(135deg, rgba(6, 182, 212, 0.05) 0%, rgba(103, 232, 249, 0.05) 100%); border: 2px solid rgba(6, 182, 212, 0.2); margin-top: 20px;">
                <div class="card-title" style="background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); color: white; margin: -24px -24px 20px -24px; padding: 14px 20px; border-radius: 14px 14px 0 0;">
                  üëÅÔ∏è‚Äçüó®Ô∏è OFTALMOSCOP√çA
                </div>

                <div class="row">
                  <div class="field">
                    <label style="font-weight: 700; color: #0e7490;">Papila</label>
                    <input type="text" id="hcOftPapila" placeholder="Descripci√≥n de la papila..." style="border: 2px solid #67e8f9; border-radius: 6px;">
                  </div>
                  <div class="field">
                    <label style="font-weight: 700; color: #0e7490;">Excavaci√≥n</label>
                    <input type="text" id="hcOftExcavacion" placeholder="Excavaci√≥n..." style="border: 2px solid #67e8f9; border-radius: 6px;">
                  </div>
                </div>

                <div class="row" style="margin-top: 12px;">
                  <div class="field">
                    <label style="font-weight: 700; color: #0e7490;">Vasos</label>
                    <input type="text" id="hcOftVasos" placeholder="Estado de los vasos..." style="border: 2px solid #67e8f9; border-radius: 6px;">
                  </div>
                  <div class="field">
                    <label style="font-weight: 700; color: #0e7490;">Rel. A/V</label>
                    <input type="text" id="hcOftRelAV" placeholder="Relaci√≥n A/V..." style="border: 2px solid #67e8f9; border-radius: 6px;">
                  </div>
                </div>

                <div class="row" style="margin-top: 12px;">
                  <div class="field">
                    <label style="font-weight: 700; color: #0e7490;">M√°cula</label>
                    <input type="text" id="hcOftMacula" placeholder="Descripci√≥n de la m√°cula..." style="border: 2px solid #67e8f9; border-radius: 6px;">
                  </div>
                  <div class="field">
                    <label style="font-weight: 700; color: #0e7490;">Reflejo</label>
                    <input type="text" id="hcOftReflejo" placeholder="Reflejo macular..." style="border: 2px solid #67e8f9; border-radius: 6px;">
                  </div>
                </div>

                <div class="row" style="margin-top: 12px;">
                  <div class="field" style="flex: 1;">
                    <label style="font-weight: 700; color: #0e7490;">Observaciones Oftalmoscop√≠a:</label>
                    <textarea id="hcOftObservaciones" rows="2" placeholder="Observaciones adicionales..." style="border: 2px solid #67e8f9; border-radius: 6px;"></textarea>
                  </div>
                </div>
              </div>

              <!-- KERATOMETR√çA -->
              <div class="card" style="background: linear-gradient(135deg, rgba(251, 146, 60, 0.05) 0%, rgba(253, 186, 116, 0.05) 100%); border: 2px solid rgba(251, 146, 60, 0.2); margin-top: 20px;">
                <div class="card-title" style="background: linear-gradient(135deg, #fb923c 0%, #f97316 100%); color: white; margin: -24px -24px 20px -24px; padding: 14px 20px; border-radius: 14px 14px 0 0;">
                  üìê KERATOMETR√çA
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                  <div style="background: #ffedd5; padding: 14px; border-radius: 8px; border: 2px solid #fdba74;">
                    <h5 style="color: #9a3412; font-weight: 700; margin-bottom: 10px;">OD (Ojo Derecho)</h5>
                    <div class="row" style="margin-bottom: 8px;">
                      <div class="field" style="flex: 1;">
                        <label style="font-size: 12px; font-weight: 600; color: #7c2d12;">@ (Horizontal)</label>
                        <input type="text" id="hcKeratOD1" placeholder="..." style="width: 100%; border: 2px solid #fdba74; border-radius: 6px; padding: 6px;">
                      </div>
                      <div class="field" style="flex: 0 0 80px;">
                        <label style="font-size: 12px; font-weight: 600; color: #7c2d12;">A.C.</label>
                        <input type="text" id="hcKeratODAC1" placeholder="..." style="width: 100%; border: 2px solid #fdba74; border-radius: 6px; padding: 6px;">
                      </div>
                      <div class="field" style="flex: 0 0 80px;">
                        <label style="font-size: 12px; font-weight: 600; color: #7c2d12;">A.T.E.</label>
                        <input type="text" id="hcKeratODATE1" placeholder="..." style="width: 100%; border: 2px solid #fdba74; border-radius: 6px; padding: 6px;">
                      </div>
                    </div>
                    <div class="row">
                      <div class="field" style="flex: 1;">
                        <label style="font-size: 12px; font-weight: 600; color: #7c2d12;">@ (Vertical)</label>
                        <input type="text" id="hcKeratOD2" placeholder="..." style="width: 100%; border: 2px solid #fdba74; border-radius: 6px; padding: 6px;">
                      </div>
                      <div class="field" style="flex: 0 0 80px;">
                        <label style="font-size: 12px; font-weight: 600; color: #7c2d12;">A.C.</label>
                        <input type="text" id="hcKeratODAC2" placeholder="..." style="width: 100%; border: 2px solid #fdba74; border-radius: 6px; padding: 6px;">
                      </div>
                      <div class="field" style="flex: 0 0 80px;">
                        <label style="font-size: 12px; font-weight: 600; color: #7c2d12;">A.T.E.</label>
                        <input type="text" id="hcKeratODATE2" placeholder="..." style="width: 100%; border: 2px solid #fdba74; border-radius: 6px; padding: 6px;">
                      </div>
                    </div>
                  </div>

                  <div style="background: #ffedd5; padding: 14px; border-radius: 8px; border: 2px solid #fdba74;">
                    <h5 style="color: #9a3412; font-weight: 700; margin-bottom: 10px;">OI (Ojo Izquierdo)</h5>
                    <div class="row" style="margin-bottom: 8px;">
                      <div class="field" style="flex: 1;">
                        <label style="font-size: 12px; font-weight: 600; color: #7c2d12;">@ (Horizontal)</label>
                        <input type="text" id="hcKeratOI1" placeholder="..." style="width: 100%; border: 2px solid #fdba74; border-radius: 6px; padding: 6px;">
                      </div>
                      <div class="field" style="flex: 0 0 80px;">
                        <label style="font-size: 12px; font-weight: 600; color: #7c2d12;">A.C.</label>
                        <input type="text" id="hcKeratOIAC1" placeholder="..." style="width: 100%; border: 2px solid #fdba74; border-radius: 6px; padding: 6px;">
                      </div>
                      <div class="field" style="flex: 0 0 80px;">
                        <label style="font-size: 12px; font-weight: 600; color: #7c2d12;">A.T.E.</label>
                        <input type="text" id="hcKeratOIATE1" placeholder="..." style="width: 100%; border: 2px solid #fdba74; border-radius: 6px; padding: 6px;">
                      </div>
                    </div>
                    <div class="row">
                      <div class="field" style="flex: 1;">
                        <label style="font-size: 12px; font-weight: 600; color: #7c2d12;">@ (Vertical)</label>
                        <input type="text" id="hcKeratOI2" placeholder="..." style="width: 100%; border: 2px solid #fdba74; border-radius: 6px; padding: 6px;">
                      </div>
                      <div class="field" style="flex: 0 0 80px;">
                        <label style="font-size: 12px; font-weight: 600; color: #7c2d12;">A.C.</label>
                        <input type="text" id="hcKeratOIAC2" placeholder="..." style="width: 100%; border: 2px solid #fdba74; border-radius: 6px; padding: 6px;">
                      </div>
                      <div class="field" style="flex: 0 0 80px;">
                        <label style="font-size: 12px; font-weight: 600; color: #7c2d12;">A.T.E.</label>
                        <input type="text" id="hcKeratOIATE2" placeholder="..." style="width: 100%; border: 2px solid #fdba74; border-radius: 6px; padding: 6px;">
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- RETINOSCOP√çA -->
              <div class="card" style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.05) 0%, rgba(196, 181, 253, 0.05) 100%); border: 2px solid rgba(139, 92, 246, 0.2); margin-top: 20px;">
                <div class="card-title" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; margin: -24px -24px 20px -24px; padding: 14px 20px; border-radius: 14px 14px 0 0;">
                  üîç RETINOSCOP√çA
                </div>

                <table style="width: 100%; border-collapse: collapse; border: 2px solid #c4b5fd;">
                  <thead>
                    <tr style="background: #e9d5ff;">
                      <th style="padding: 10px; border: 2px solid #c4b5fd; color: #5b21b6;"></th>
                      <th style="padding: 10px; border: 2px solid #c4b5fd; color: #5b21b6;">ESF</th>
                      <th style="padding: 10px; border: 2px solid #c4b5fd; color: #5b21b6;">CIL</th>
                      <th style="padding: 10px; border: 2px solid #c4b5fd; color: #5b21b6;">EJE</th>
                      <th style="padding: 10px; border: 2px solid #c4b5fd; color: #5b21b6;">AV (mono)</th>
                      <th style="padding: 10px; border: 2px solid #c4b5fd; color: #5b21b6;">AV (AO)</th>
                      <th style="padding: 10px; border: 2px solid #c4b5fd; color: #5b21b6;">DIP</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr style="background: white;">
                      <td style="padding: 8px; border: 2px solid #c4b5fd; font-weight: 700; color: #6b21a8;">OD</td>
                      <td style="padding: 4px; border: 2px solid #c4b5fd;"><input type="text" id="hcRetinoODEsf" style="width: 100%; border: 1px solid #c4b5fd; border-radius: 4px; padding: 6px;"></td>
                      <td style="padding: 4px; border: 2px solid #c4b5fd;"><input type="text" id="hcRetinoODCil" style="width: 100%; border: 1px solid #c4b5fd; border-radius: 4px; padding: 6px;"></td>
                      <td style="padding: 4px; border: 2px solid #c4b5fd;"><input type="text" id="hcRetinoODEje" style="width: 100%; border: 1px solid #c4b5fd; border-radius: 4px; padding: 6px;"></td>
                      <td style="padding: 4px; border: 2px solid #c4b5fd;"><input type="text" id="hcRetinoODAVMono" style="width: 100%; border: 1px solid #c4b5fd; border-radius: 4px; padding: 6px;"></td>
                      <td style="padding: 4px; border: 2px solid #c4b5fd;"><input type="text" id="hcRetinoODAVAO" style="width: 100%; border: 1px solid #c4b5fd; border-radius: 4px; padding: 6px;"></td>
                      <td style="padding: 4px; border: 2px solid #c4b5fd;"><input type="text" id="hcRetinoODDIP" style="width: 100%; border: 1px solid #c4b5fd; border-radius: 4px; padding: 6px;"></td>
                    </tr>
                    <tr style="background: #faf5ff;">
                      <td style="padding: 8px; border: 2px solid #c4b5fd; font-weight: 700; color: #6b21a8;">OI</td>
                      <td style="padding: 4px; border: 2px solid #c4b5fd;"><input type="text" id="hcRetinoOIEsf" style="width: 100%; border: 1px solid #c4b5fd; border-radius: 4px; padding: 6px;"></td>
                      <td style="padding: 4px; border: 2px solid #c4b5fd;"><input type="text" id="hcRetinoOICil" style="width: 100%; border: 1px solid #c4b5fd; border-radius: 4px; padding: 6px;"></td>
                      <td style="padding: 4px; border: 2px solid #c4b5fd;"><input type="text" id="hcRetinoOIEje" style="width: 100%; border: 1px solid #c4b5fd; border-radius: 4px; padding: 6px;"></td>
                      <td style="padding: 4px; border: 2px solid #c4b5fd;"><input type="text" id="hcRetinoOIAVMono" style="width: 100%; border: 1px solid #c4b5fd; border-radius: 4px; padding: 6px;"></td>
                      <td style="padding: 4px; border: 2px solid #c4b5fd;"><input type="text" id="hcRetinoOIAVAO" style="width: 100%; border: 1px solid #c4b5fd; border-radius: 4px; padding: 6px;"></td>
                      <td style="padding: 4px; border: 2px solid #c4b5fd;"><input type="text" id="hcRetinoOIDIP" style="width: 100%; border: 1px solid #c4b5fd; border-radius: 4px; padding: 6px;"></td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <!-- REFRACCI√ìN FINAL -->
              <div class="card" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.05) 0%, rgba(110, 231, 183, 0.05) 100%); border: 2px solid rgba(16, 185, 129, 0.2); margin-top: 20px;">
                <div class="card-title" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; margin: -24px -24px 20px -24px; padding: 14px 20px; border-radius: 14px 14px 0 0;">
                  ‚úÖ REFRACCI√ìN FINAL
                </div>

                <table style="width: 100%; border-collapse: collapse; border: 2px solid #6ee7b7;">
                  <thead>
                    <tr style="background: #d1fae5;">
                      <th style="padding: 10px; border: 2px solid #6ee7b7; color: #065f46;"></th>
                      <th style="padding: 10px; border: 2px solid #6ee7b7; color: #065f46;">ESF</th>
                      <th style="padding: 10px; border: 2px solid #6ee7b7; color: #065f46;">CIL</th>
                      <th style="padding: 10px; border: 2px solid #6ee7b7; color: #065f46;">EJE</th>
                      <th style="padding: 10px; border: 2px solid #6ee7b7; color: #065f46;">AV (mono)</th>
                      <th style="padding: 10px; border: 2px solid #6ee7b7; color: #065f46;">AV (AO)</th>
                      <th style="padding: 10px; border: 2px solid #6ee7b7; color: #065f46;">DIP</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr style="background: white;">
                      <td style="padding: 8px; border: 2px solid #6ee7b7; font-weight: 700; color: #047857;">OD</td>
                      <td style="padding: 4px; border: 2px solid #6ee7b7;"><input type="text" id="hcRefFinalODEsf" style="width: 100%; border: 1px solid #6ee7b7; border-radius: 4px; padding: 6px;"></td>
                      <td style="padding: 4px; border: 2px solid #6ee7b7;"><input type="text" id="hcRefFinalODCil" style="width: 100%; border: 1px solid #6ee7b7; border-radius: 4px; padding: 6px;"></td>
                      <td style="padding: 4px; border: 2px solid #6ee7b7;"><input type="text" id="hcRefFinalODEje" style="width: 100%; border: 1px solid #6ee7b7; border-radius: 4px; padding: 6px;"></td>
                      <td style="padding: 4px; border: 2px solid #6ee7b7;"><input type="text" id="hcRefFinalODAVMono" placeholder="10" style="width: 100%; border: 1px solid #6ee7b7; border-radius: 4px; padding: 6px;"></td>
                      <td style="padding: 4px; border: 2px solid #6ee7b7;"><input type="text" id="hcRefFinalODAVAO" style="width: 100%; border: 1px solid #6ee7b7; border-radius: 4px; padding: 6px;"></td>
                      <td style="padding: 4px; border: 2px solid #6ee7b7;"><input type="text" id="hcRefFinalODDIP" style="width: 100%; border: 1px solid #6ee7b7; border-radius: 4px; padding: 6px;"></td>
                    </tr>
                    <tr style="background: #f0fdf4;">
                      <td style="padding: 8px; border: 2px solid #6ee7b7; font-weight: 700; color: #047857;">OI</td>
                      <td style="padding: 4px; border: 2px solid #6ee7b7;"><input type="text" id="hcRefFinalOIEsf" style="width: 100%; border: 1px solid #6ee7b7; border-radius: 4px; padding: 6px;"></td>
                      <td style="padding: 4px; border: 2px solid #6ee7b7;"><input type="text" id="hcRefFinalOICil" style="width: 100%; border: 1px solid #6ee7b7; border-radius: 4px; padding: 6px;"></td>
                      <td style="padding: 4px; border: 2px solid #6ee7b7;"><input type="text" id="hcRefFinalOIEje" style="width: 100%; border: 1px solid #6ee7b7; border-radius: 4px; padding: 6px;"></td>
                      <td style="padding: 4px; border: 2px solid #6ee7b7;"><input type="text" id="hcRefFinalOIAVMono" placeholder="OA" style="width: 100%; border: 1px solid #6ee7b7; border-radius: 4px; padding: 6px;"></td>
                      <td style="padding: 4px; border: 2px solid #6ee7b7;"><input type="text" id="hcRefFinalOIAVAO" style="width: 100%; border: 1px solid #6ee7b7; border-radius: 4px; padding: 6px;"></td>
                      <td style="padding: 4px; border: 2px solid #6ee7b7;"><input type="text" id="hcRefFinalOIDIP" style="width: 100%; border: 1px solid #6ee7b7; border-radius: 4px; padding: 6px;"></td>
                    </tr>
                  </tbody>
                </table>

                <!-- ADD CERCA / RX CERCA -->
                <div style="background: #d1fae5; padding: 14px; border-radius: 8px; margin-top: 16px; border: 2px solid #6ee7b7;">
                  <h4 style="color: #065f46; font-weight: 700; margin-bottom: 12px;">ADD: Cerca / Rx. Cerca</h4>
                  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                      <label style="font-weight: 600; color: #047857;">ADD: Cerca OD</label>
                      <input type="text" id="hcAddCercaOD" placeholder="..." style="width: 100%; border: 2px solid #6ee7b7; border-radius: 6px; padding: 8px; margin-top: 6px;">
                    </div>
                    <div>
                      <label style="font-weight: 600; color: #047857;">Rx. Cerca OD</label>
                      <input type="text" id="hcRxCercaOD" placeholder="..." style="width: 100%; border: 2px solid #6ee7b7; border-radius: 6px; padding: 8px; margin-top: 6px;">
                    </div>
                  </div>
                  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 12px;">
                    <div>
                      <label style="font-weight: 600; color: #047857;">ADD: Cerca OI</label>
                      <input type="text" id="hcAddCercaOI" placeholder="..." style="width: 100%; border: 2px solid #6ee7b7; border-radius: 6px; padding: 8px; margin-top: 6px;">
                    </div>
                    <div>
                      <label style="font-weight: 600; color: #047857;">Rx. Cerca OI</label>
                      <input type="text" id="hcRxCercaOI" placeholder="OA 1" style="width: 100%; border: 2px solid #6ee7b7; border-radius: 6px; padding: 8px; margin-top: 6px;">
                    </div>
                  </div>
                </div>

                <div class="row" style="margin-top: 16px;">
                  <div class="field" style="flex: 1;">
                    <label style="font-weight: 700; color: #047857;">Observaciones y Recomendaciones:</label>
                    <textarea id="hcRefFinalObservaciones" rows="3" placeholder="Observaciones y recomendaciones cl√≠nicas..." style="border: 2px solid #6ee7b7; border-radius: 6px;"></textarea>
                  </div>
                </div>
              </div>

              <!-- DIAGN√ìSTICO, MANEJO Y CONTROLES -->
              <div class="card" style="background: linear-gradient(135deg, rgba(236, 72, 153, 0.05) 0%, rgba(251, 207, 232, 0.05) 100%); border: 2px solid rgba(236, 72, 153, 0.2); margin-top: 20px;">
                <div class="card-title" style="background: linear-gradient(135deg, #ec4899 0%, #db2777 100%); color: white; margin: -24px -24px 20px -24px; padding: 14px 20px; border-radius: 14px 14px 0 0;">
                  üìã DIAGN√ìSTICO, MANEJO Y CONTROLES
                </div>

                <div class="row">
                  <div class="field" style="flex: 1;">
                    <label style="font-weight: 700; color: #9f1239; font-size: 15px;">Diagn√≥stico:</label>
                    <textarea id="hcDiagnosticoFinal" rows="3" placeholder="Diagn√≥stico cl√≠nico completo..." style="border: 2px solid #fbcfe8; border-radius: 8px; font-size: 13px; padding: 12px;"></textarea>
                  </div>
                </div>

                <div class="row" style="margin-top: 16px;">
                  <div class="field" style="flex: 1;">
                    <label style="font-weight: 700; color: #9f1239; font-size: 15px;">Manejo:</label>
                    <textarea id="hcManejo" rows="3" placeholder="Plan de tratamiento y manejo del paciente..." style="border: 2px solid #fbcfe8; border-radius: 8px; font-size: 13px; padding: 12px;"></textarea>
                  </div>
                </div>

                <div class="row" style="margin-top: 16px;">
                  <div class="field" style="flex: 1;">
                    <label style="font-weight: 700; color: #9f1239; font-size: 15px;">Controles:</label>
                    <textarea id="hcControles" rows="2" placeholder="Indicaciones de controles y seguimiento..." style="border: 2px solid #fbcfe8; border-radius: 8px; font-size: 13px; padding: 12px;"></textarea>
                  </div>
                </div>
              </div>

              <!-- EXAMINADOR Y FIRMA -->
              <div class="card" style="background: linear-gradient(135deg, rgba(100, 116, 139, 0.05) 0%, rgba(203, 213, 225, 0.05) 100%); border: 2px solid rgba(100, 116, 139, 0.2); margin-top: 20px;">
                <div class="card-title" style="background: linear-gradient(135deg, #64748b 0%, #475569 100%); color: white; margin: -24px -24px 20px -24px; padding: 14px 20px; border-radius: 14px 14px 0 0;">
                  üë®‚Äç‚öïÔ∏è INFORMACI√ìN DEL EXAMINADOR
                </div>

                <div class="row">
                  <div class="field">
                    <label style="font-weight: 700; color: #1e293b;">Examinador:</label>
                    <input type="text" id="hcExaminador" placeholder="Nombre completo del examinador" style="border: 2px solid #cbd5e1; border-radius: 6px; padding: 10px;">
                  </div>
                  <div class="field">
                    <label style="font-weight: 700; color: #1e293b;">Grupo de Pr√°ctica:</label>
                    <input type="text" id="hcGrupoPractica" placeholder="Grupo de pr√°ctica" style="border: 2px solid #cbd5e1; border-radius: 6px; padding: 10px;">
                  </div>
                </div>

                <div class="row" style="margin-top: 12px;">
                  <div class="field">
                    <label style="font-weight: 700; color: #1e293b;">Ciclo / Turno:</label>
                    <input type="text" id="hcCicloTurno" placeholder="Ciclo o turno" style="border: 2px solid #cbd5e1; border-radius: 6px; padding: 10px;">
                  </div>
                  <div class="field">
                    <label style="font-weight: 700; color: #1e293b;">Firma del Supervisor:</label>
                    <input type="text" id="hcFirmaSupervisor" placeholder="Firma del supervisor" style="border: 2px solid #cbd5e1; border-radius: 6px; padding: 10px;">
                  </div>
                </div>
              </div>
            </div>
            -->
            <!-- ==================== FIN HISTORIAL CL√çNICO COMPLETO (COMENTADO) ==================== -->

            <!-- ‚ú® BOTONES DE ACCI√ìN SIMPLIFICADOS ‚ú® -->
            <div style="position: sticky; bottom: 20px; display: flex; justify-content: center; gap: 15px; padding: 20px; background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%); border-radius: 16px; box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1); margin-top: 30px; z-index: 100;">
              <button class="btn btn-secondary" onclick="limpiarFormularioConsultorio()" style="flex: 1; max-width: 200px; padding: 14px; font-size: 15px; font-weight: 700;">
                üîÑ Nuevo Paciente
              </button>
              <button class="btn btn-success" onclick="guardarConsultaClinica()" style="flex: 1; max-width: 200px; padding: 14px; font-size: 15px; font-weight: 700;">
                üíæ Guardar Prescripci√≥n
              </button>
              <button class="btn btn-info" onclick="guardarEImprimirConsulta()" style="flex: 1; max-width: 200px; padding: 14px; font-size: 15px; font-weight: 700;">
                üñ®Ô∏è Guardar e Imprimir
              </button>
            </div>

          </div>
        </section>

        <!-- ======== SECCI√ìN CONSULTAS ======== -->
        <section id="consultas" class="hidden">
          <div class="card">
            <div class="flex-between mb-2">
              <div class="card-title" style="margin: 0; border: none; padding: 0;">üìù Consultas - Historial de Clientes</div>
              <div style="display: flex; gap: 8px;">
                <button class="btn btn-success btn-sm" onclick="exportarTodosClientesConsulta()">üìä Exportar Todos a Excel</button>
                <button class="btn btn-primary btn-sm" onclick="exportarHistorialSeleccionado()">üìÑ Exportar Cliente Actual</button>
              </div>
            </div>

            <div class="row mb-2">
              <div class="field" style="max-width: 500px;">
                <label>Buscar Cliente</label>
                <input id="consultaBuscarCliente" placeholder="üîç Buscar por apellidos y nombres..." oninput="buscarClientesConsulta()">
              </div>
            </div>

            <!-- Panel dividido: Lista de clientes y Detalles -->
            <div style="display: grid; grid-template-columns: 300px 1fr; gap: 16px; min-height: 500px;">
              <!-- Lista de clientes -->
              <div style="border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden;">
                <div style="background: #6b21a8; color: white; padding: 12px; font-weight: bold;">
                  Clientes Encontrados
                </div>
                <div id="consultaListaClientes" style="max-height: 600px; overflow-y: auto; background: white;">
                  <div style="padding: 30px; text-align: center; color: #9ca3af;">
                    Busca un cliente para ver su historial
                  </div>
                </div>
              </div>

              <!-- Panel de detalles del cliente -->
              <div id="consultaDetalleCliente" style="border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden;">
                <div style="background: #f9fafb; padding: 30px; text-align: center; color: #9ca3af;">
                  Selecciona un cliente de la lista
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- ======== SECCI√ìN BUSCAR VENTAS ======== -->
        <section id="buscarVentas" class="hidden">
          <div class="card">
            <div class="card-title">üîç Buscar Ventas</div>

            <div class="filter-section">
              <div class="filter-row">
                <div class="field">
                  <label>Buscar por</label>
                  <select id="buscarVentaTipo">
                    <option value="TODAS">TODAS LAS VENTAS</option>
                    <option value="DNI">N¬∫ DOCUMENTO (DNI)</option>
                    <option value="NOMBRE">NOMBRE CLIENTE</option>
                    <option value="NROVENTA">N¬∫ DE VENTA</option>
                  </select>
                </div>
                <div class="field">
                  <label>Fechas</label>
                  <select id="buscarVentaFechas">
                    <option value="HOY">HOY</option>
                    <option value="SEMANA">ESTA SEMANA</option>
                    <option value="MES">ESTE MES</option>
                    <option value="RANGO">RANGO PERSONALIZADO</option>
                    <option value="TODAS">TODAS</option>
                  </select>
                </div>
                <div class="field" id="fechaDesdeContainer" style="display: none;">
                  <label>Desde</label>
                  <input type="date" id="buscarFechaDesde">
                </div>
                <div class="field" id="fechaHastaContainer" style="display: none;">
                  <label>Hasta</label>
                  <input type="date" id="buscarFechaHasta">
                </div>
                <div class="field">
                  <label>Texto b√∫squeda</label>
                  <input id="buscarVentaTexto" placeholder="DNI, nombre o N¬∫ venta...">
                </div>
                <div class="field" style="flex: 0 0 120px;">
                  <label>&nbsp;</label>
                  <button class="btn btn-primary" onclick="buscarVentas()">üîç Mostrar</button>
                </div>
              </div>

              <div class="row mt-2">
                <div class="field">
                  <label>Estado Pago</label>
                  <select id="buscarEstadoPago">
                    <option value="">Todos</option>
                    <option value="PAGADO">Pagado</option>
                    <option value="PENDIENTE">Pendiente</option>
                  </select>
                </div>
                <div class="field">
                  <label>Estado Entrega</label>
                  <select id="buscarEstadoEntrega">
                    <option value="">Todos</option>
                    <option value="ENTREGADO">Entregado</option>
                    <option value="PENDIENTE">Pendiente</option>
                  </select>
                </div>
                <div class="field">
                  <div class="checkbox-wrapper" style="margin-top: 22px;">
                    <input type="checkbox" id="seleccionarTodos" onchange="toggleSeleccionarTodos()">
                    <label style="margin: 0; text-transform: none;">Seleccionar Todos</label>
                  </div>
                </div>
              </div>
            </div>

            <div class="summary-cards">
              <div class="summary-card">
                <div class="value" id="totalVentasSum">S/ 0.00</div>
                <div class="label">Total</div>
              </div>
              <div class="summary-card success">
                <div class="value" id="cobradoSum">S/ 0.00</div>
                <div class="label">Cobrado</div>
              </div>
              <div class="summary-card warning">
                <div class="value" id="saldoSum">S/ 0.00</div>
                <div class="label">Saldo</div>
              </div>
            </div>
          </div>

          <div class="card">
            <table>
              <thead>
                <tr>
                  <th style="width: 4%;">Sel.</th>
                  <th>Vendedor</th>
                  <th>Cliente</th>
                  <th>Documento</th>
                  <th class="text-right">Total</th>
                  <th class="text-right">Pagado</th>
                  <th class="text-right">Saldo</th>
                  <th>Fecha</th>
                  <th class="text-center">Entrega</th>
                  <th class="text-center">Estado</th>
                  <th>Tel√©fono</th>
                </tr>
              </thead>
              <tbody id="ventasBody"></tbody>
            </table>

            <div class="action-bar">
              <button class="btn btn-danger btn-sm" onclick="anularVentasSeleccionadas()">üóëÔ∏è Anular</button>
              <button class="btn btn-info btn-sm" onclick="verDetalleVentaSeleccionada()">üìã Ver Detalle</button>
              <button class="btn btn-secondary btn-sm" onclick="imprimirVentaSeleccionada()">üñ®Ô∏è Imprimir Documento</button>
              <button class="btn btn-success btn-sm" onclick="exportarVentasExcel()">üìä Excel</button>
              <button class="btn btn-warning btn-sm" onclick="cambiarEstadoEntrega()">üì¶ Estado Entrega</button>
              <div style="flex: 1;"></div>
              <button class="btn btn-secondary btn-sm" onclick="cerrarBusquedaVentas()">üö™ Salir</button>
            </div>

            <div class="flex-between mt-2">
              <span class="pill" id="ventasResumen">Registros Encontrados: 0</span>
              <div class="pagination">
                <span>Ingrese cantidad de registros:</span>
                <input type="number" id="registrosPorPagina" value="10" style="width: 60px; text-align: center;">
                <button onclick="paginaAnterior()">‚óÄ</button>
                <button onclick="paginaSiguiente()">‚ñ∂</button>
                <span id="paginaInfo">P√°gina 0 de: 0</span>
              </div>
            </div>
          </div>
        </section>

        <!-- ======== SECCI√ìN BUSCAR RX ======== -->
        <section id="buscarRx" class="hidden">
          <div class="card">
            <div class="card-title">üìã Buscar Prescripciones</div>

            <div class="filter-section">
              <div class="filter-row">
                <div class="field">
                  <label>Buscar por paciente / documento</label>
                  <input id="buscarRxTexto" placeholder="Nombre paciente o documento...">
                </div>
                <div class="field">
                  <label>Fecha desde</label>
                  <input type="date" id="buscarRxDesde">
                </div>
                <div class="field">
                  <label>Fecha hasta</label>
                  <input type="date" id="buscarRxHasta">
                </div>
                <div class="field">
                  <label>Especialista</label>
                  <select id="buscarRxEspecialista">
                    <option value="">Todos</option>
                    <option value="JOSE PEREZ">JOSE PEREZ</option>
                    <option value="MARIA GARCIA">MARIA GARCIA</option>
                    <option value="FREDDY MENDOZA FERNANDEZ">FREDDY MENDOZA FERNANDEZ</option>
                    <option value="GLORIA ISABEL HUAMAN QUISPE">GLORIA ISABEL HUAMAN QUISPE</option>
                    <option value="IMPORTADO - SISTEMA ANTIGUO">IMPORTADO - SISTEMA ANTIGUO</option>
                  </select>
                </div>
                <div class="field" style="flex: 0 0 120px;">
                  <label>&nbsp;</label>
                  <button class="btn btn-primary" onclick="buscarPrescripciones()">üîç Mostrar</button>
                </div>
              </div>
            </div>
          </div>

          <div class="card">
            <table>
              <thead>
                <tr>
                  <th>C√≥digo</th>
                  <th>Paciente</th>
                  <th>Fecha</th>
                  <th>Especialista</th>
                  <th>Lugar</th>
                  <th class="text-center">Acciones</th>
                </tr>
              </thead>
              <tbody id="buscarRxBody"></tbody>
            </table>
            <div class="flex-between mt-2">
              <span class="pill" id="buscarRxResumen">Prescripciones: 0</span>
              <div class="flex-end">
                <button class="btn btn-success btn-sm" onclick="exportarRxExcel()">üì• Exportar Excel</button>
              </div>
            </div>
          </div>
        </section>

        <!-- ======== SECCI√ìN LUNAS ======== -->
        <section id="lunas" class="hidden">
          <div class="card">
            <div class="tabs lunas-tabs">
              <button class="tab-btn active" data-lunastab="catalogo">üì¶ Cat√°logo de Lunas</button>
              <button class="tab-btn" data-lunastab="registrar">üîµ Registrar Tipos</button>
              <button class="tab-btn" data-lunastab="vendidas">üìã Lunas Vendidas</button>
            </div>

            <!-- TAB CAT√ÅLOGO DE LUNAS (INVENTARIO) -->
            <div class="lunas-tab-content active" id="tabCatalogoLunas">
              <div class="flex-between mb-2 mt-2">
                <div class="card-title" style="margin: 0; border: none; padding: 0;">üì¶ Cat√°logo e Inventario de Lunas</div>
                <div class="flex-end">
                  <button class="btn btn-success" onclick="abrirSelectorLunas()">üõí Seleccionar para Venta</button>
                  <button class="btn btn-warning" onclick="exportarCatalogoLunasExcel()">üìä Exportar Excel</button>
                </div>
              </div>

              <!-- Filtros de categor√≠a -->
              <div class="lunas-categorias-tabs">
                <button class="luna-inv-btn active" data-lunainv="TODOS">TODOS</button>
                <button class="luna-inv-btn" data-lunainv="ESFERICO">üîµ ESF√âRICOS</button>
                <button class="luna-inv-btn" data-lunainv="COMBINADO">üü£ COMBINADOS</button>
                <button class="luna-inv-btn" data-lunainv="CRISTAL">üü§ CRISTALES</button>
                <button class="luna-inv-btn" data-lunainv="BIFOCAL">üîµ BIFOCALES</button>
                <button class="luna-inv-btn" data-lunainv="PROGRESIVO">üü¢ PROGRESIVOS</button>
                <button class="luna-inv-btn" data-lunainv="ALTO_INDICE">üü° ALTO √çNDICE</button>
              </div>

              <!-- Tabla de Cat√°logo -->
              <div class="catalogo-lunas-container">
                <table class="mt-2">
                  <thead>
                    <tr style="background: #0ea5e9; color: white;">
                      <th>CATEGOR√çA</th>
                      <th>TIPO DE LUNA</th>
                      <th>RANGO</th>
                      <th class="text-right">PRECIO UNIT.</th>
                      <th class="text-center">STOCK</th>
                      <th class="text-center">ACCIONES</th>
                    </tr>
                  </thead>
                  <tbody id="catalogoLunasBody"></tbody>
                </table>
              </div>

              <div class="flex-between mt-2">
                <span class="pill" id="catalogoLunasCount">Productos: 0</span>
                <span class="pill" style="background: #dcfce7; color: #166534;" id="catalogoLunasTotal">Valor Total: S/ 0.00</span>
              </div>
            </div>

            <!-- TAB REGISTRAR LUNAS -->
            <div class="lunas-tab-content" id="tabRegistrarLunas">
              <div class="flex-between mb-2 mt-2">
                <div class="card-title" style="margin: 0; border: none; padding: 0;">üîµ Registro de Lunas - Sistema de Inventario</div>
                <div class="flex-end">
                  <button class="btn btn-primary" onclick="abrirModalTipoFoco()">+ Registrar Tipo de Foco</button>
                  <button class="btn btn-secondary" onclick="abrirModalEditarTipoFoco()">‚úèÔ∏è Editar Tipo de Foco</button>
                  <button class="btn btn-danger" onclick="eliminarTipoFocoSeleccionado()">üóëÔ∏è Eliminar Tipo de Foco</button>
                  <button class="btn btn-success" onclick="abrirSelectorLunas()">üîç Seleccionar Lunas</button>
                </div>
              </div>

              <!-- Categor√≠as de Lunas -->
              <div class="lunas-categorias-tabs">
                <button class="luna-cat-btn active" data-lunacat="TIPO_FOCO">TIPO DE FOCO</button>
                <button class="luna-cat-btn" data-lunacat="MATERIAL">MATERIAL</button>
                <button class="luna-cat-btn" data-lunacat="SERVICIO">SERVICIO</button>
                <button class="luna-cat-btn" data-lunacat="TRATAMIENTO">TRATAMIENTO</button>
                <button class="luna-cat-btn" data-lunacat="INDICE">INDICE</button>
                <button class="luna-cat-btn" data-lunacat="FILTROS">FILTROS</button>
                <button class="luna-cat-btn" data-lunacat="TALLADO">TALLADO</button>
                <button class="luna-cat-btn" data-lunacat="FOTOSENSIBLES">LENTES FOTOSENSIBLES</button>
              </div>

              <!-- Tabla de Tipos de Lunas -->
              <table class="mt-2">
                <thead>
                  <tr>
                    <th style="width: 40px;"><input type="checkbox" id="selTodosLunas" onchange="toggleSeleccionarTodosLunas()"></th>
                    <th>Descripci√≥n</th>
                    <th style="width: 120px;">Abreviatura</th>
                  </tr>
                </thead>
                <tbody id="tiposLunasBody"></tbody>
              </table>

              <div class="flex-between mt-2">
                <span class="pill" id="lunasCount">Registros: 0</span>
                <div class="flex-end">
                  <button class="btn btn-warning btn-sm" onclick="exportarLunasExcel()">üìä Exportar Excel</button>
                </div>
              </div>
            </div>

            <!-- TAB LUNAS VENDIDAS -->
            <div class="lunas-tab-content" id="tabLunasVendidas">
              <div class="flex-between mb-2 mt-2">
                <div class="card-title" style="margin: 0; border: none; padding: 0;">üìã Historial de Lunas Vendidas</div>
                <div class="flex-end">
                  <button class="btn btn-warning" onclick="exportarLunasVendidasExcel()">üìä Exportar Excel</button>
                </div>
              </div>

              <div class="filter-section">
                <div class="filter-row">
                  <div class="field">
                    <label>Buscar</label>
                    <input id="buscarLunaVendida" placeholder="Cliente, tipo de luna..." oninput="renderLunasVendidas()">
                  </div>
                  <div class="field">
                    <label>Fecha Desde</label>
                    <input type="date" id="lunaVendidaDesde">
                  </div>
                  <div class="field">
                    <label>Fecha Hasta</label>
                    <input type="date" id="lunaVendidaHasta">
                  </div>
                  <div class="field" style="flex: 0 0 120px;">
                    <label>&nbsp;</label>
                    <button class="btn btn-primary" onclick="renderLunasVendidas()">üîç Filtrar</button>
                  </div>
                </div>
              </div>

              <table class="mt-2">
                <thead>
                  <tr>
                    <th>Fecha</th>
                    <th>Cliente</th>
                    <th>Tipo Luna</th>
                    <th>Material</th>
                    <th>Tratamiento</th>
                    <th>Medida OD</th>
                    <th>Medida OI</th>
                    <th class="text-right">Precio</th>
                    <th>Venta</th>
                  </tr>
                </thead>
                <tbody id="lunasVendidasBody"></tbody>
              </table>

              <div class="flex-between mt-2">
                <span class="pill" id="lunasVendidasCount">Registros: 0</span>
                <div class="summary-cards" style="margin: 0; gap: 10px;">
                  <div class="summary-card success" style="padding: 10px; min-width: 120px;">
                    <div class="value" id="totalLunasVendidas">S/ 0.00</div>
                    <div class="label">Total Ventas</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- ======== SECCI√ìN INVENTARIO ======== -->
        <section id="inventario" class="hidden">
          <div class="card">
            <div class="flex-between mb-2">
              <div class="card-title" style="margin: 0; border: none; padding: 0;">üì¶ Inventario de Productos</div>
              <div class="flex-end">
                <button class="btn btn-info btn-sm" onclick="recargarCatalogoCompleto()" title="Restaurar cat√°logo original">üîÑ Recargar</button>
                <button class="btn btn-success" onclick="abrirModalNuevoProducto()">+ Nuevo Producto</button>
                <button class="btn btn-warning" onclick="exportarInventarioExcel()">üìä Exportar Excel</button>
              </div>
            </div>

            <div class="categoria-tabs">
              <button class="cat-btn active" data-cat="TODOS">Todos</button>
              <button class="cat-btn" data-cat="LUNAS">üîµ Lunas</button>
              <button class="cat-btn" data-cat="MONTURAS">üëì Monturas</button>
              <button class="cat-btn" data-cat="LCONTACTO">üîò L. Contacto</button>
              <button class="cat-btn" data-cat="ACCESORIOS">üéÅ Accesorios</button>
              <button class="cat-btn" data-cat="SERVICIOS">üîß Servicios</button>
            </div>

            <table class="mt-2">
              <thead>
                <tr>
                  <th style="width: 60px;">Imagen</th>
                  <th>Producto</th>
                  <th>Categor√≠a</th>
                  <th class="text-right">Precio</th>
                  <th class="text-center">Stock</th>
                  <th class="text-center">Estado</th>
                  <th class="text-center" style="width: 150px;">Acciones</th>
                </tr>
              </thead>
              <tbody id="inventarioBody"></tbody>
            </table>
            <div class="flex-between mt-2">
              <span class="pill" id="inventarioCount">Productos: 0</span>
            </div>
          </div>
        </section>

        <!-- ======== SECCI√ìN ALMAC√âN ======== -->
        <section id="almacen" class="hidden">
          <div class="card">
            <div class="almacen-tabs">
              <button class="almacen-tab-btn active" data-almtab="ingreso">
                <span class="tab-icon">üì•</span>
                <span>Ingreso Mercader√≠a</span>
              </button>
              <button class="almacen-tab-btn" data-almtab="salida">
                <span class="tab-icon">üì§</span>
                <span>Salida Mercader√≠a</span>
              </button>
              <button class="almacen-tab-btn" data-almtab="guias">
                <span class="tab-icon">üìã</span>
                <span>Gu√≠as Remisi√≥n</span>
              </button>
              <button class="almacen-tab-btn" data-almtab="kardex">
                <span class="tab-icon">üìä</span>
                <span>Kardex</span>
              </button>
              <button class="almacen-tab-btn" data-almtab="stock">
                <span class="tab-icon">üì¶</span>
                <span>Consulta Stock</span>
              </button>
              <button class="almacen-tab-btn" data-almtab="importar">
                <span class="tab-icon">üìä</span>
                <span>Importar Datos</span>
              </button>
            </div>

            <!-- Tab: Ingreso de Mercader√≠a -->
            <div class="almacen-tab-content active" id="tabIngreso">
              <div class="mov-tipo-box">
                <button class="mov-tipo-btn ingreso active" data-tipo="COMPRA_DIRECTA">Compra Directa</button>
                <button class="mov-tipo-btn ingreso" data-tipo="INVENTARIO_INICIAL">Inventario Inicial</button>
                <button class="mov-tipo-btn ingreso" data-tipo="ENTRADAS_VARIAS">Entradas Varias</button>
                <button class="mov-tipo-btn ingreso" data-tipo="RETORNO_MERMA">Retorno de Merma</button>
              </div>

              <div class="mov-header">
                <div class="field" style="flex: 2;">
                  <label>Nro. Documento</label>
                  <input type="text" id="ingresoNroDoc" placeholder="Ej: FAC-001-000123">
                </div>
                <div class="field">
                  <label>Fecha</label>
                  <input type="date" id="ingresoFecha">
                </div>
                <div class="field" style="flex: 2;">
                  <label>Proveedor / Origen</label>
                  <input type="text" id="ingresoProveedor" placeholder="Nombre del proveedor">
                </div>
              </div>

              <div class="buscar-prod-container">
                <input type="text" id="buscarProdIngreso" placeholder="Buscar producto por c√≥digo o nombre..." onkeyup="buscarProductoAlmacen(this.value, 'ingreso')">
                <button class="btn btn-primary" onclick="abrirModalBuscarProducto('ingreso')">üîç Buscar Avanzado</button>
                <button class="btn btn-success" onclick="agregarFilaIngreso()">+ Agregar Fila</button>
              </div>

              <div class="mov-productos-table">
                <table>
                  <thead>
                    <tr>
                      <th style="width: 120px;">C√≥digo</th>
                      <th>Producto</th>
                      <th class="text-center" style="width: 100px;">Cantidad</th>
                      <th class="text-right" style="width: 110px;">Costo Unit.</th>
                      <th class="text-right" style="width: 110px;">Subtotal</th>
                      <th class="text-center" style="width: 60px;"></th>
                    </tr>
                  </thead>
                  <tbody id="ingresoProductosBody"></tbody>
                  <tfoot>
                    <tr>
                      <td colspan="4" class="text-right" style="font-weight: 700;">TOTAL:</td>
                      <td class="text-right" style="font-weight: 700; font-size: 16px; color: #16a34a;" id="ingresoTotal">S/ 0.00</td>
                      <td></td>
                    </tr>
                  </tfoot>
                </table>
              </div>

              <div class="flex-end mt-2">
                <button class="btn btn-secondary" onclick="limpiarIngreso()">üóëÔ∏è Limpiar</button>
                <button class="btn btn-success" onclick="procesarIngreso()">‚úì Procesar Ingreso</button>
              </div>
            </div>

            <!-- Tab: Salida de Mercader√≠a -->
            <div class="almacen-tab-content" id="tabSalida">
              <div class="mov-tipo-box">
                <button class="mov-tipo-btn salida active" data-tipo="TRASLADO_ALMACENES">Traslado entre Almacenes</button>
                <button class="mov-tipo-btn salida" data-tipo="SALIDA_TIENDA">Salida a Tienda</button>
                <button class="mov-tipo-btn salida" data-tipo="AJUSTE_INVENTARIO">Ajuste de Inventario</button>
                <button class="mov-tipo-btn salida" data-tipo="DEVOLUCION_PROVEEDOR">Devoluci√≥n a Proveedor</button>
              </div>

              <div class="mov-header">
                <div class="field" style="flex: 2;">
                  <label>Nro. Documento</label>
                  <input type="text" id="salidaNroDoc" placeholder="Ej: SAL-001-000123">
                </div>
                <div class="field">
                  <label>Fecha</label>
                  <input type="date" id="salidaFecha">
                </div>
                <div class="field" style="flex: 2;">
                  <label>Destino / Motivo</label>
                  <input type="text" id="salidaDestino" placeholder="Destino o motivo de salida">
                </div>
              </div>

              <div class="buscar-prod-container">
                <input type="text" id="buscarProdSalida" placeholder="Buscar producto por c√≥digo o nombre..." onkeyup="buscarProductoAlmacen(this.value, 'salida')">
                <button class="btn btn-primary" onclick="abrirModalBuscarProducto('salida')">üîç Buscar Avanzado</button>
                <button class="btn btn-danger" onclick="agregarFilaSalida()">+ Agregar Fila</button>
              </div>

              <div class="mov-productos-table">
                <table>
                  <thead>
                    <tr>
                      <th style="width: 120px;">C√≥digo</th>
                      <th>Producto</th>
                      <th class="text-center" style="width: 80px;">Stock</th>
                      <th class="text-center" style="width: 100px;">Cantidad</th>
                      <th class="text-right" style="width: 110px;">Costo Unit.</th>
                      <th class="text-right" style="width: 110px;">Subtotal</th>
                      <th class="text-center" style="width: 60px;"></th>
                    </tr>
                  </thead>
                  <tbody id="salidaProductosBody"></tbody>
                  <tfoot>
                    <tr>
                      <td colspan="5" class="text-right" style="font-weight: 700;">TOTAL:</td>
                      <td class="text-right" style="font-weight: 700; font-size: 16px; color: #dc2626;" id="salidaTotal">S/ 0.00</td>
                      <td></td>
                    </tr>
                  </tfoot>
                </table>
              </div>

              <div class="flex-end mt-2">
                <button class="btn btn-secondary" onclick="limpiarSalida()">üóëÔ∏è Limpiar</button>
                <button class="btn btn-danger" onclick="procesarSalida()">‚úì Procesar Salida</button>
              </div>
            </div>

            <!-- Tab: Gu√≠as de Remisi√≥n -->
            <div class="almacen-tab-content" id="tabGuias">
              <div class="flex-between mb-2">
                <div class="row" style="gap: 10px; flex: 1;">
                  <div class="field" style="max-width: 200px;">
                    <label>Buscar Gu√≠a</label>
                    <input type="text" id="buscarGuia" placeholder="Nro. gu√≠a..." onkeyup="buscarGuias()">
                  </div>
                  <div class="field" style="max-width: 150px;">
                    <label>Estado</label>
                    <select id="filtroEstadoGuia" onchange="buscarGuias()">
                      <option value="">Todos</option>
                      <option value="PENDIENTE">Pendiente</option>
                      <option value="ENVIADA">Enviada</option>
                      <option value="ENTREGADA">Entregada</option>
                      <option value="ANULADA">Anulada</option>
                    </select>
                  </div>
                  <div class="field" style="max-width: 150px;">
                    <label>Desde</label>
                    <input type="date" id="guiaDesde" onchange="buscarGuias()">
                  </div>
                  <div class="field" style="max-width: 150px;">
                    <label>Hasta</label>
                    <input type="date" id="guiaHasta" onchange="buscarGuias()">
                  </div>
                </div>
                <div class="flex-end" style="padding-top: 20px;">
                  <button class="btn btn-success" onclick="nuevaGuiaRemision()">+ Nueva Gu√≠a</button>
                  <button class="btn btn-warning" onclick="exportarGuiasExcel()">üìä Exportar</button>
                </div>
              </div>

              <table>
                <thead>
                  <tr>
                    <th>Nro. Gu√≠a</th>
                    <th>Fecha</th>
                    <th>Destino</th>
                    <th>Transportista</th>
                    <th class="text-center">Items</th>
                    <th class="text-center">Estado</th>
                    <th class="text-center" style="width: 180px;">Acciones</th>
                  </tr>
                </thead>
                <tbody id="guiasBody"></tbody>
              </table>
              <div class="flex-between mt-2">
                <span class="pill" id="guiasCount">Gu√≠as: 0</span>
              </div>
            </div>

            <!-- Tab: Kardex -->
            <div class="almacen-tab-content" id="tabKardex">
              <div class="kardex-filtros">
                <div class="field">
                  <label>Producto</label>
                  <select id="kardexProducto" onchange="cargarKardex()">
                    <option value="">Seleccione producto...</option>
                  </select>
                </div>
                <div class="field">
                  <label>Desde</label>
                  <input type="date" id="kardexDesde" onchange="cargarKardex()">
                </div>
                <div class="field">
                  <label>Hasta</label>
                  <input type="date" id="kardexHasta" onchange="cargarKardex()">
                </div>
                <div class="field" style="display: flex; align-items: flex-end; gap: 8px;">
                  <button class="btn btn-primary" onclick="cargarKardex()">üîç Consultar</button>
                  <button class="btn btn-warning" onclick="exportarKardexExcel()">üìä Excel</button>
                </div>
              </div>

              <div class="kardex-resumen">
                <div class="kardex-card entradas">
                  <div class="k-value" id="kardexEntradas">0</div>
                  <div class="k-label">Total Entradas</div>
                </div>
                <div class="kardex-card salidas">
                  <div class="k-value" id="kardexSalidas">0</div>
                  <div class="k-label">Total Salidas</div>
                </div>
                <div class="kardex-card stock">
                  <div class="k-value" id="kardexStock">0</div>
                  <div class="k-label">Stock Actual</div>
                </div>
              </div>

              <table>
                <thead>
                  <tr>
                    <th>Fecha</th>
                    <th>Tipo</th>
                    <th>Documento</th>
                    <th>Descripci√≥n</th>
                    <th class="text-center">Entrada</th>
                    <th class="text-center">Salida</th>
                    <th class="text-center">Saldo</th>
                  </tr>
                </thead>
                <tbody id="kardexBody"></tbody>
              </table>
              <div class="flex-between mt-2">
                <span class="pill" id="kardexCount">Movimientos: 0</span>
              </div>
            </div>

            <!-- Tab: Consulta de Stock -->
            <div class="almacen-tab-content" id="tabStock">
              <div class="kardex-filtros">
                <div class="field">
                  <label>Buscar</label>
                  <input type="text" id="stockBuscar" placeholder="C√≥digo, nombre o modelo..." onkeyup="buscarStock()">
                </div>
                <div class="field">
                  <label>Categor√≠a</label>
                  <select id="stockCategoria" onchange="buscarStock()">
                    <option value="">Todas</option>
                    <option value="LUNAS">Lunas</option>
                    <option value="MONTURAS">Monturas</option>
                    <option value="LCONTACTO">L. Contacto</option>
                    <option value="ACCESORIOS">Accesorios</option>
                    <option value="SERVICIOS">Servicios</option>
                  </select>
                </div>
                <div class="field">
                  <label>Stock</label>
                  <select id="stockFiltro" onchange="buscarStock()">
                    <option value="">Todos</option>
                    <option value="BAJO">Stock Bajo (‚â§5)</option>
                    <option value="AGOTADO">Agotado (0)</option>
                    <option value="DISPONIBLE">Disponible (>5)</option>
                  </select>
                </div>
                <div class="field" style="display: flex; align-items: flex-end; gap: 8px;">
                  <button class="btn btn-primary" onclick="buscarStock()">üîç Buscar</button>
                  <button class="btn btn-warning" onclick="exportarStockExcel()">üìä Excel</button>
                </div>
              </div>

              <table>
                <thead>
                  <tr>
                    <th style="width: 60px;">Img</th>
                    <th style="width: 100px;">C√≥digo</th>
                    <th>Producto</th>
                    <th>Categor√≠a</th>
                    <th class="text-right">Precio</th>
                    <th class="text-center">Stock</th>
                    <th class="text-center">Estado</th>
                  </tr>
                </thead>
                <tbody id="stockBody"></tbody>
              </table>
              <div class="flex-between mt-2">
                <span class="pill" id="stockCount">Productos: 0</span>
                <div class="summary-cards" style="margin: 0; gap: 10px;">
                  <div class="summary-card" style="padding: 10px; min-width: 100px; background: #fee2e2;">
                    <div class="value" id="stockAgotados" style="color: #dc2626;">0</div>
                    <div class="label">Agotados</div>
                  </div>
                  <div class="summary-card" style="padding: 10px; min-width: 100px; background: #fef3c7;">
                    <div class="value" id="stockBajos" style="color: #d97706;">0</div>
                    <div class="label">Stock Bajo</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Tab: Importar Datos Masivos -->
            <div class="almacen-tab-content" id="tabImportar">
              <div style="max-width: 900px; margin: 0 auto;">
                <!-- T√≠tulo y descripci√≥n -->
                <div style="text-align: center; margin-bottom: 30px; animation: fadeInDown 0.6s ease-out;">
                  <h2 style="font-size: 28px; font-weight: 900; color: #1f2937; margin-bottom: 10px;">üìä Importaci√≥n Masiva de Productos</h2>
                  <p style="color: #6b7280; font-size: 14px;">Carga m√∫ltiples productos desde archivos CSV o Excel de forma r√°pida y sencilla</p>
                </div>

                <!-- Selector de tipo de importaci√≥n -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-bottom: 30px;">
                  <div class="import-type-card active" onclick="seleccionarTipoImportacion('productos')" data-tipo="productos" style="background: linear-gradient(135deg, #dbeafe 0%, white 100%); border: 2px solid #3b82f6; border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.3s ease; position: relative;">
                    <div style="font-size: 40px; margin-bottom: 10px;">üì¶</div>
                    <h3 style="font-weight: 700; margin-bottom: 8px; color: #1f2937;">Productos</h3>
                    <p style="font-size: 13px; color: #6b7280; margin-bottom: 12px;">Importar inventario completo de productos, lunas, monturas y accesorios</p>
                    <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                      <span style="background: #3b82f6; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">CSV</span>
                      <span style="background: #10b981; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">Excel</span>
                    </div>
                  </div>

                  <div class="import-type-card" onclick="seleccionarTipoImportacion('clientes')" data-tipo="clientes" style="background: white; border: 2px solid #e5e7eb; border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.3s ease; position: relative;">
                    <div style="font-size: 40px; margin-bottom: 10px;">üë•</div>
                    <h3 style="font-weight: 700; margin-bottom: 8px; color: #1f2937;">Clientes</h3>
                    <p style="font-size: 13px; color: #6b7280; margin-bottom: 12px;">Importar base de datos de clientes con informaci√≥n de contacto</p>
                    <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                      <span style="background: #3b82f6; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">CSV</span>
                      <span style="background: #10b981; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">Excel</span>
                    </div>
                  </div>
                </div>

                <!-- √Årea de carga de archivo -->
                <div style="background: linear-gradient(135deg, #f9fafb 0%, #ffffff 100%); border: 3px dashed #d1d5db; border-radius: 16px; padding: 40px; text-align: center; margin-bottom: 25px; transition: all 0.3s ease;" id="dropZone">
                  <input type="file" id="importFileInput" accept=".csv,.xlsx,.xls" style="display: none;" onchange="procesarArchivoImportacion(this.files[0])">

                  <div style="font-size: 64px; margin-bottom: 15px; opacity: 0.7;">üì§</div>
                  <h3 style="font-weight: 700; color: #1f2937; margin-bottom: 10px;">Arrastra tu archivo aqu√≠</h3>
                  <p style="color: #6b7280; margin-bottom: 20px;">o haz clic para seleccionar desde tu computadora</p>
                  <button class="btn btn-primary" onclick="document.getElementById('importFileInput').click()" style="padding: 12px 32px; font-size: 16px; font-weight: 600;">
                    üìÅ Seleccionar Archivo
                  </button>
                  <p style="color: #9ca3af; font-size: 12px; margin-top: 15px;">Formatos soportados: CSV, Excel (.xlsx, .xls)</p>
                </div>

                <!-- Instrucciones y plantillas -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
                  <div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 20px; border-radius: 8px;">
                    <h4 style="font-weight: 700; color: #92400e; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                      <span>‚ÑπÔ∏è</span> Instrucciones
                    </h4>
                    <ul style="color: #78350f; font-size: 13px; line-height: 1.8; margin: 0; padding-left: 20px;">
                      <li>La primera fila debe contener los encabezados</li>
                      <li>Los campos obligatorios est√°n marcados con *</li>
                      <li>Usa el formato de plantilla proporcionado</li>
                      <li>M√°ximo 1000 registros por archivo</li>
                    </ul>
                  </div>

                  <div style="background: #dbeafe; border-left: 4px solid #3b82f6; padding: 20px; border-radius: 8px;">
                    <h4 style="font-weight: 700; color: #1e3a8a; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                      <span>üì•</span> Descargar Plantillas
                    </h4>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                      <button class="btn btn-secondary" onclick="descargarPlantillaImportacion('productos')" style="width: 100%; justify-content: center; font-size: 13px;">
                        üì¶ Plantilla Productos CSV
                      </button>
                      <button class="btn btn-secondary" onclick="descargarPlantillaImportacion('clientes')" style="width: 100%; justify-content: center; font-size: 13px;">
                        üë• Plantilla Clientes CSV
                      </button>
                    </div>
                  </div>
                </div>

                <!-- Vista previa de datos -->
                <div id="vistaPreviewImportacion" style="display: none; animation: fadeInUp 0.6s ease-out;">
                  <div style="background: white; border: 2px solid #e5e7eb; border-radius: 12px; padding: 25px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                      <h3 style="font-weight: 700; color: #1f2937; display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 24px;">üëÅÔ∏è</span> Vista Previa
                      </h3>
                      <div style="display: flex; gap: 10px; align-items: center;">
                        <span style="background: #dbeafe; color: #1e40af; padding: 6px 14px; border-radius: 20px; font-size: 13px; font-weight: 600;" id="previewCount">0 registros</span>
                        <button class="btn btn-secondary" onclick="cancelarImportacion()" style="padding: 8px 16px;">‚úñÔ∏è Cancelar</button>
                        <button class="btn btn-success" onclick="confirmarImportacion()" style="padding: 8px 24px; font-weight: 600;">‚úÖ Confirmar Importaci√≥n</button>
                      </div>
                    </div>

                    <div style="max-height: 400px; overflow: auto; border: 1px solid #e5e7eb; border-radius: 8px;">
                      <table style="width: 100%; border-collapse: collapse;">
                        <thead id="previewTableHead" style="position: sticky; top: 0; background: #f9fafb; z-index: 10;">
                        </thead>
                        <tbody id="previewTableBody">
                        </tbody>
                      </table>
                    </div>

                    <div id="erroresValidacion" style="display: none; margin-top: 20px; background: #fee2e2; border-left: 4px solid #dc2626; padding: 15px; border-radius: 8px;">
                      <h4 style="color: #991b1b; font-weight: 700; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                        <span>‚ö†Ô∏è</span> Errores de Validaci√≥n
                      </h4>
                      <ul id="listaErroresValidacion" style="color: #7f1d1d; font-size: 13px; margin: 0; padding-left: 20px;">
                      </ul>
                    </div>
                  </div>
                </div>

                <!-- Progreso de importaci√≥n -->
                <div id="progresoImportacion" style="display: none; animation: fadeInUp 0.6s ease-out;">
                  <div style="background: white; border: 2px solid #e5e7eb; border-radius: 12px; padding: 25px; text-align: center;">
                    <div style="font-size: 48px; margin-bottom: 15px;">‚è≥</div>
                    <h3 style="font-weight: 700; color: #1f2937; margin-bottom: 10px;">Procesando Importaci√≥n...</h3>
                    <div style="background: #e5e7eb; height: 8px; border-radius: 4px; overflow: hidden; margin: 20px 0;">
                      <div id="barraProgreso" style="background: linear-gradient(90deg, #3b82f6 0%, #2563eb 100%); height: 100%; width: 0%; transition: width 0.3s ease;"></div>
                    </div>
                    <p id="textoProgreso" style="color: #6b7280; font-size: 14px;">0 de 0 registros procesados</p>
                  </div>
                </div>

                <!-- Resultado de importaci√≥n -->
                <div id="resultadoImportacion" style="display: none; animation: fadeInUp 0.6s ease-out;">
                  <div style="background: white; border: 2px solid #10b981; border-radius: 12px; padding: 30px; text-align: center;">
                    <div style="font-size: 64px; margin-bottom: 15px;">‚úÖ</div>
                    <h3 style="font-weight: 700; color: #059669; margin-bottom: 15px;">¬°Importaci√≥n Completada!</h3>
                    <div style="display: flex; justify-content: center; gap: 30px; margin: 20px 0;">
                      <div>
                        <div style="font-size: 32px; font-weight: 900; color: #059669;" id="resultadoExitosos">0</div>
                        <div style="color: #6b7280; font-size: 13px;">Registros exitosos</div>
                      </div>
                      <div>
                        <div style="font-size: 32px; font-weight: 900; color: #dc2626;" id="resultadoErrores">0</div>
                        <div style="color: #6b7280; font-size: 13px;">Errores</div>
                      </div>
                    </div>
                    <button class="btn btn-primary" onclick="reiniciarImportacion()" style="padding: 12px 32px; font-weight: 600;">
                      üîÑ Nueva Importaci√≥n
                    </button>
                  </div>
                </div>

              </div>
            </div>

          </div>
        </section>

        <!-- ======== SECCI√ìN REPORTES ======== -->
        <section id="reportes" class="hidden">
          <div class="card">
            <div class="reportes-tabs">
              <button class="reportes-tab-btn active" onclick="mostrarTabReportes('tabRepVentas', this)">
                <span class="tab-icon">üí∞</span>
                <span>Ventas</span>
              </button>
              <button class="reportes-tab-btn" onclick="mostrarTabReportes('tabRepProductos', this)">
                <span class="tab-icon">üì¶</span>
                <span>Productos Vendidos</span>
              </button>
              <button class="reportes-tab-btn" onclick="mostrarTabReportes('tabRepClientes', this)">
                <span class="tab-icon">üë•</span>
                <span>Suscripci√≥n Clientes</span>
              </button>
              <button class="reportes-tab-btn" onclick="mostrarTabReportes('tabRepOptiabi', this)">
                <span class="tab-icon">üìä</span>
                <span>Reportes Optiabi</span>
              </button>
              <button class="reportes-tab-btn" onclick="mostrarTabReportes('tabAnalisisPredictivo', this)">
                <span class="tab-icon">üìà</span>
                <span>An√°lisis Predictivo</span>
              </button>
            </div>

            <!-- Tab: Reporte de Ventas -->
            <div class="reportes-tab-content active" id="tabRepVentas">
              <div class="reporte-filtros">
                <div class="section-title">Reporte de Ventas</div>

                <!-- Filtros R√°pidos de Per√≠odo -->
                <div style="background: #f3f4f6; padding: 12px; border-radius: 6px; margin-bottom: 16px;">
                  <label style="font-weight: 600; margin-bottom: 8px; display: block;">‚ö° Per√≠odos R√°pidos:</label>
                  <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                    <button class="btn btn-secondary" style="font-size: 12px; padding: 6px 12px;" onclick="establecerPeriodoVentas('hoy')">üìÖ Hoy</button>
                    <button class="btn btn-secondary" style="font-size: 12px; padding: 6px 12px;" onclick="establecerPeriodoVentas('semana')">üìÜ Esta Semana</button>
                    <button class="btn btn-secondary" style="font-size: 12px; padding: 6px 12px;" onclick="establecerPeriodoVentas('mes')">üìä Este Mes</button>
                    <button class="btn btn-secondary" style="font-size: 12px; padding: 6px 12px;" onclick="establecerPeriodoVentas('anio')">üìà Este A√±o</button>
                    <button class="btn btn-secondary" style="font-size: 12px; padding: 6px 12px;" onclick="establecerPeriodoVentas('todo')">üåê Todo</button>
                  </div>
                </div>

                <div class="row">
                  <div class="field">
                    <label><input type="checkbox" id="repVentasFiltrarFecha" checked> Filtrar por Fecha</label>
                  </div>
                </div>
                <div class="row mt-1">
                  <div class="field" style="max-width: 160px;">
                    <label>Desde</label>
                    <input type="date" id="repVentasDesde">
                  </div>
                  <div class="field" style="max-width: 160px;">
                    <label>Hasta</label>
                    <input type="date" id="repVentasHasta">
                  </div>
                  <div class="field">
                    <label>Estado</label>
                    <select id="repVentasEstado">
                      <option value="">Todas</option>
                      <option value="EFECTUADA">Solo Efectuadas</option>
                      <option value="ANULADA">Anuladas</option>
                    </select>
                  </div>
                  <div class="field">
                    <label>Estado de Pago</label>
                    <select id="repVentasEstadoPago">
                      <option value="">Todas</option>
                      <option value="PAGADO">Pagado</option>
                      <option value="PENDIENTE">Pendiente</option>
                    </select>
                  </div>
                  <div class="field">
                    <label>Estado Entrega</label>
                    <select id="repVentasEntrega">
                      <option value="">Todas</option>
                      <option value="ENTREGADO">Entregado</option>
                      <option value="PENDIENTE">Pendiente</option>
                    </select>
                  </div>
                </div>
                <div class="row mt-1">
                  <div class="field">
                    <label><input type="checkbox" id="repVentasAlmacen"> Por Almac√©n Despacho</label>
                  </div>
                </div>
                <div class="reporte-opciones">
                  <label><input type="radio" name="tipoRepVentas" value="general" checked> General</label>
                  <label><input type="radio" name="tipoRepVentas" value="detallada"> Detallada por Productos</label>
                </div>
              </div>
              <div class="reporte-acciones">
                <button class="btn btn-primary" onclick="generarReporteVentas()">üìä Visualizar</button>
                <button class="btn btn-success" onclick="exportarReporteVentasExcel()">üìä Exportar a Excel</button>
                <button class="btn btn-info" onclick="exportarReporteVentasPDF()">üìÑ Exportar a PDF</button>
                <button class="btn btn-secondary" onclick="cerrarReporteVentas()">üö™ Salir</button>
              </div>
              <div class="reporte-preview" id="previewRepVentas" style="display: none;"></div>
            </div>

            <!-- Tab: Reporte de Ventas y Pacientes/Especialistas -->
            <div class="reportes-tab-content" id="tabRepEspecialistas" style="display: none;">
              <div class="reporte-filtros">
                <div class="section-title">Reporte de Ventas y Pacientes</div>
                <div class="row">
                  <div class="field" style="max-width: 160px;">
                    <label>Desde</label>
                    <input type="date" id="repEspDesde">
                  </div>
                  <div class="field" style="max-width: 160px;">
                    <label>Hasta</label>
                    <input type="date" id="repEspHasta">
                  </div>
                  <div class="field">
                    <label>Estado</label>
                    <select id="repEspEstado">
                      <option value="">Todas</option>
                      <option value="EFECTUADA">Solo Efectuadas</option>
                      <option value="ANULADA">Anuladas</option>
                    </select>
                  </div>
                </div>
                <div class="row mt-2">
                  <div class="field">
                    <label><input type="checkbox" id="repEspFiltrarVendedor"> Filtrar por Vendedor</label>
                    <select id="repEspVendedor" style="margin-top: 5px;">
                      <option value="">Todos</option>
                      <option value="ADMINISTRADOR">Administrador</option>
                    </select>
                  </div>
                  <div class="field">
                    <label><input type="checkbox" id="repEspFiltrarAlmacen"> Filtrar por Almac√©n</label>
                    <select id="repEspAlmacen" style="margin-top: 5px;">
                      <option value="">Todos</option>
                      <option value="PRINCIPAL">Principal</option>
                    </select>
                  </div>
                  <div class="field">
                    <label><input type="checkbox" id="repEspFiltrarEspecialista"> Filtrar por Especialista</label>
                    <select id="repEspEspecialista" style="margin-top: 5px;">
                      <option value="">Todos</option>
                      <option value="FREDDY MENDOZA">Freddy Mendoza</option>
                      <option value="GLORIA HUAMAN">Gloria Huaman</option>
                    </select>
                  </div>
                </div>
                <div class="reporte-opciones">
                  <label><input type="radio" name="tipoRepEsp" value="general" checked> Reporte de Ventas General</label>
                  <label><input type="radio" name="tipoRepEsp" value="detallado"> Reporte de Ventas Detallado</label>
                  <label><input type="checkbox" id="repEspCredito"> Filtrar por L√≠nea de Cr√©dito</label>
                </div>
              </div>
              <div class="reporte-acciones">
                <button class="btn btn-primary" onclick="generarReporteEspecialistas()">üìä Visualizar</button>
                <button class="btn btn-secondary" onclick="cerrarReporteEspecialistas()">üö™ Salir</button>
              </div>
              <div class="reporte-preview" id="previewRepEspecialistas" style="display: none;"></div>
            </div>

            <!-- Sub-tabs dentro de Ventas -->
            <div id="subTabsVentas" class="mt-2" style="display: flex; gap: 10px; margin-bottom: 10px;">
              <button class="btn btn-sm btn-primary" onclick="mostrarSubRepVentas('ventas')">üìã Reporte de Ventas</button>
              <button class="btn btn-sm btn-secondary" onclick="mostrarSubRepVentas('especialistas')">üë®‚Äç‚öïÔ∏è Rep. Ventas y Especialistas</button>
            </div>

            <!-- Tab: Productos Vendidos -->
            <div class="reportes-tab-content" id="tabRepProductos" style="display: none;">
              <div class="reporte-filtros">
                <div class="section-title">Reporte de Productos Vendidos</div>
                <div class="row">
                  <div class="field">
                    <label><input type="checkbox" id="repProdFamilia"> Filtrar por Familia</label>
                    <select id="repProdFamiliaVal" style="margin-top: 5px;">
                      <option value="">Todas</option>
                      <option value="MONTURAS">Monturas</option>
                      <option value="LUNAS">Lunas</option>
                      <option value="LCONTACTO">Lentes de Contacto</option>
                    </select>
                  </div>
                  <div class="field">
                    <label><input type="checkbox" id="repProdLinea"> Filtrar por L√≠nea</label>
                    <select id="repProdLineaVal" style="margin-top: 5px;">
                      <option value="">Todas</option>
                      <option value="OFTALMICA">Oft√°lmica</option>
                      <option value="LIMPIEZA">Limpieza</option>
                      <option value="MUJER">Mujer</option>
                    </select>
                  </div>
                </div>
                <div class="row mt-1">
                  <div class="field">
                    <label><input type="checkbox" id="repProdCategoria"> Filtrar por Categor√≠a</label>
                    <select id="repProdCategoriaVal" style="margin-top: 5px;">
                      <option value="">Todas</option>
                      <option value="MONTURAS">Monturas</option>
                      <option value="LUNAS">Lunas</option>
                      <option value="ACCESORIOS">Accesorios</option>
                      <option value="SERVICIOS">Servicios</option>
                    </select>
                  </div>
                  <div class="field">
                    <label><input type="checkbox" id="repProdMarca"> Filtrar por Marca</label>
                    <select id="repProdMarcaVal" style="margin-top: 5px;">
                      <option value="">Todas</option>
                    </select>
                  </div>
                  <div class="field">
                    <label><input type="checkbox" id="repProdAlmacen"> Filtrar por Almac√©n</label>
                    <select id="repProdAlmacenVal" style="margin-top: 5px;">
                      <option value="">Todos</option>
                      <option value="PRINCIPAL">Principal</option>
                    </select>
                  </div>
                </div>
                <div class="row mt-1">
                  <div class="field">
                    <label><input type="checkbox" id="repProdFecha" checked> Filtrar por Fecha</label>
                  </div>
                  <div class="field" style="max-width: 160px;">
                    <label>Desde</label>
                    <input type="date" id="repProdDesde">
                  </div>
                  <div class="field" style="max-width: 160px;">
                    <label>Hasta</label>
                    <input type="date" id="repProdHasta">
                  </div>
                </div>
                <div class="row mt-1">
                  <div class="field">
                    <label>Ordenados por:</label>
                    <select id="repProdOrden">
                      <option value="masVendido">M√°s vendido</option>
                      <option value="menosVendido">Menos vendido</option>
                      <option value="alfabetico">Alfab√©tico</option>
                    </select>
                  </div>
                  <div class="field">
                    <label><input type="checkbox" id="repProdVendedor"> Filtrar por Vendedor</label>
                    <select id="repProdVendedorVal" style="margin-top: 5px;">
                      <option value="">Todos</option>
                      <option value="ADMINISTRADOR">Administrador</option>
                    </select>
                  </div>
                </div>
                <div class="reporte-opciones">
                  <label><input type="radio" name="tipoRepProd" value="detallado" checked> Reporte detallado por precios de Venta</label>
                  <label><input type="radio" name="tipoRepProd" value="consolidado"> Reporte Consolidado</label>
                </div>
              </div>
              <div class="reporte-acciones">
                <button class="btn btn-primary" onclick="generarReporteProductos()">üìä Visualizar</button>
                <button class="btn btn-secondary" onclick="cerrarReporteProductos()">üö™ Salir</button>
              </div>
              <div class="reporte-preview" id="previewRepProductos" style="display: none;"></div>
            </div>

            <!-- Tab: Suscripci√≥n Clientes -->
            <div class="reportes-tab-content" id="tabRepClientes" style="display: none;">
              <div class="reporte-filtros">
                <div class="section-title">Reporte de Clientes</div>
                <div class="row">
                  <div class="field">
                    <label>Almac√©n</label>
                    <select id="repClientesAlmacen">
                      <option value="">Todos</option>
                      <option value="PRINCIPAL">Principal</option>
                      <option value="PREMIUM">Premium</option>
                    </select>
                  </div>
                  <div class="field" style="max-width: 160px;">
                    <label>Desde</label>
                    <input type="date" id="repClientesDesde">
                  </div>
                  <div class="field" style="max-width: 160px;">
                    <label>Hasta</label>
                    <input type="date" id="repClientesHasta">
                  </div>
                </div>
                <div class="row mt-2">
                  <div class="field">
                    <label><input type="checkbox" id="repClientesSexo"> Sexo</label>
                    <select id="repClientesSexoVal" style="margin-top: 5px;">
                      <option value="">Todos</option>
                      <option value="M">Masculino</option>
                      <option value="F">Femenino</option>
                    </select>
                  </div>
                  <div class="field">
                    <label><input type="checkbox" id="repClientesEstadoCivil"> Estado Civil</label>
                    <select id="repClientesEstadoCivilVal" style="margin-top: 5px;">
                      <option value="">Todos</option>
                      <option value="SOLTERO">Soltero(a)</option>
                      <option value="CASADO">Casado(a)</option>
                      <option value="DIVORCIADO">Divorciado(a)</option>
                    </select>
                  </div>
                  <div class="field">
                    <label><input type="checkbox" id="repClientesDpto"> Departamento</label>
                    <select id="repClientesDptoVal" style="margin-top: 5px;">
                      <option value="">Todos</option>
                      <option value="CUSCO">Cusco</option>
                    </select>
                  </div>
                  <div class="field">
                    <label><input type="checkbox" id="repClientesProv"> Provincia</label>
                    <select id="repClientesProvVal" style="margin-top: 5px;">
                      <option value="">Todas</option>
                      <option value="CANCHIS">Canchis</option>
                    </select>
                  </div>
                  <div class="field">
                    <label><input type="checkbox" id="repClientesDist"> Distrito</label>
                    <select id="repClientesDistVal" style="margin-top: 5px;">
                      <option value="">Todos</option>
                      <option value="SICUANI">Sicuani</option>
                    </select>
                  </div>
                </div>
              </div>
              <div class="reporte-acciones">
                <button class="btn btn-primary" onclick="generarReporteClientes()">üîç Buscar</button>
                <button class="btn btn-success" onclick="exportarReporteClientesExcel()">üìä Exportar Excel</button>
                <button class="btn btn-secondary" onclick="cerrarReporteClientes()">üö™ Salir</button>
              </div>
              <div class="reporte-preview" id="previewRepClientes" style="display: none;"></div>
            </div>

            <!-- Tab: Reportes Optiabi (Compatibilidad con sistema antiguo) -->
            <div class="reportes-tab-content" id="tabRepOptiabi" style="display: none;">
              <div class="reporte-filtros">
                <div class="section-title">üìä Reportes Optiabi - Compatible con Sistema Antiguo</div>

                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-top: 20px;">
                  <!-- Reporte por D√≠as -->
                  <div style="border: 1px solid #e5e7eb; padding: 16px; border-radius: 8px; background: white;">
                    <h4 style="color: #6b21a8; margin-bottom: 12px;">üìÖ Por D√≠as (dd/mm/aa)</h4>
                    <div class="field">
                      <label>Fecha espec√≠fica</label>
                      <input type="date" id="repOptiabiDia">
                    </div>
                    <button class="btn btn-primary btn-sm mt-1" onclick="generarReporteOptiabi('dias')">
                      üëÅÔ∏è Vista Preliminar
                    </button>
                  </div>

                  <!-- Reporte por A√±os -->
                  <div style="border: 1px solid #e5e7eb; padding: 16px; border-radius: 8px; background: white;">
                    <h4 style="color: #6b21a8; margin-bottom: 12px;">üìÜ Reporte por A√±os</h4>
                    <div class="field">
                      <label>A√±o</label>
                      <select id="repOptiabiAnio">
                        <option value="">Seleccionar a√±o...</option>
                      </select>
                    </div>
                    <button class="btn btn-primary btn-sm mt-1" onclick="generarReporteOptiabi('anios')">
                      üëÅÔ∏è Vista Preliminar
                    </button>
                  </div>

                  <!-- Reporte Meses y A√±os -->
                  <div style="border: 1px solid #e5e7eb; padding: 16px; border-radius: 8px; background: white;">
                    <h4 style="color: #6b21a8; margin-bottom: 12px;">üìä Meses y A√±os</h4>
                    <div class="field">
                      <label>Mes</label>
                      <select id="repOptiabiMes">
                        <option value="01">Enero</option>
                        <option value="02">Febrero</option>
                        <option value="03">Marzo</option>
                        <option value="04">Abril</option>
                        <option value="05">Mayo</option>
                        <option value="06">Junio</option>
                        <option value="07">Julio</option>
                        <option value="08">Agosto</option>
                        <option value="09">Septiembre</option>
                        <option value="10">Octubre</option>
                        <option value="11">Noviembre</option>
                        <option value="12">Diciembre</option>
                      </select>
                    </div>
                    <div class="field">
                      <label>A√±o</label>
                      <select id="repOptiabiMesAnio">
                        <option value="">Seleccionar a√±o...</option>
                      </select>
                    </div>
                    <button class="btn btn-primary btn-sm mt-1" onclick="generarReporteOptiabi('meses')">
                      üëÅÔ∏è Vista Preliminar
                    </button>
                  </div>

                  <!-- Reporte de Deudores -->
                  <div style="border: 1px solid #e5e7eb; padding: 16px; border-radius: 8px; background: white;">
                    <h4 style="color: #6b21a8; margin-bottom: 12px;">üí∞ Reporte de Deudores</h4>
                    <p style="font-size: 13px; color: #6b7280; margin-bottom: 12px;">
                      Clientes con saldo pendiente
                    </p>
                    <button class="btn btn-primary btn-sm" onclick="generarReporteOptiabi('deudores')">
                      üëÅÔ∏è Vista Preliminar
                    </button>
                  </div>
                </div>

                <!-- Reporte General -->
                <div style="border: 1px solid #e5e7eb; padding: 16px; border-radius: 8px; background: white; margin-top: 16px;">
                  <h4 style="color: #6b21a8; margin-bottom: 12px;">üìã General (Todo)</h4>
                  <p style="font-size: 13px; color: #6b7280; margin-bottom: 12px;">
                    Reporte completo de todos los clientes y sus prescripciones
                  </p>
                  <button class="btn btn-primary" onclick="generarReporteOptiabi('general')">
                    üëÅÔ∏è Vista Preliminar
                  </button>
                  <button class="btn btn-success" onclick="exportarReporteOptiabiExcel('general')">
                    üìä Exportar a Excel
                  </button>
                </div>
              </div>

              <div class="reporte-acciones" style="margin-top: 16px;">
                <button class="btn btn-secondary" onclick="cerrarReporteOptiabi()">üö™ Salir</button>
              </div>

              <div class="reporte-preview" id="previewRepOptiabi" style="display: none; margin-top: 20px;"></div>
            </div>

            <!-- Tab: An√°lisis Predictivo -->
            <div class="reportes-tab-content" id="tabAnalisisPredictivo" style="display: none;">
              <div style="max-width: 1200px; margin: 0 auto;">
                <!-- T√≠tulo -->
                <div style="text-align: center; margin-bottom: 30px; animation: fadeInDown 0.6s ease-out;">
                  <h2 style="font-size: 32px; font-weight: 900; color: #1f2937; margin-bottom: 10px;">üìà An√°lisis Predictivo & Tendencias</h2>
                  <p style="color: #6b7280; font-size: 14px;">Proyecciones inteligentes basadas en datos hist√≥ricos y tendencias del negocio</p>
                </div>

                <!-- Selector de per√≠odo de an√°lisis -->
                <div style="background: linear-gradient(135deg, #f9fafb 0%, #ffffff 100%); border: 2px solid #e5e7eb; border-radius: 12px; padding: 20px; margin-bottom: 30px;">
                  <h3 style="font-weight: 700; color: #1f2937; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                    <span>üéØ</span> Per√≠odo de An√°lisis
                  </h3>
                  <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-secondary periodo-analisis-btn active" data-periodo="7" onclick="cambiarPeriodoAnalisis(7)">
                      √öltimos 7 d√≠as
                    </button>
                    <button class="btn btn-secondary periodo-analisis-btn" data-periodo="30" onclick="cambiarPeriodoAnalisis(30)">
                      √öltimos 30 d√≠as
                    </button>
                    <button class="btn btn-secondary periodo-analisis-btn" data-periodo="90" onclick="cambiarPeriodoAnalisis(90)">
                      √öltimos 3 meses
                    </button>
                    <button class="btn btn-secondary periodo-analisis-btn" data-periodo="180" onclick="cambiarPeriodoAnalisis(180)">
                      √öltimos 6 meses
                    </button>
                    <button class="btn btn-secondary periodo-analisis-btn" data-periodo="365" onclick="cambiarPeriodoAnalisis(365)">
                      √öltimo a√±o
                    </button>
                  </div>
                </div>

                <!-- M√©tricas de tendencia -->
                <div id="metricasTendencia" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px;">
                  <!-- Se llenar√° din√°micamente -->
                </div>

                <!-- Gr√°fico de proyecci√≥n de ventas -->
                <div style="background: white; border: 2px solid #e5e7eb; border-radius: 12px; padding: 25px; margin-bottom: 25px; animation: fadeInUp 0.6s ease-out;">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="font-weight: 700; color: #1f2937; display: flex; align-items: center; gap: 10px;">
                      <span style="font-size: 24px;">üìä</span> Proyecci√≥n de Ventas (30 d√≠as)
                    </h3>
                    <div style="display: flex; gap: 15px; align-items: center;">
                      <div style="display: flex; align-items: center; gap: 6px;">
                        <div style="width: 16px; height: 3px; background: #3b82f6;"></div>
                        <span style="font-size: 12px; color: #6b7280;">Datos Reales</span>
                      </div>
                      <div style="display: flex; align-items: center; gap: 6px;">
                        <div style="width: 16px; height: 3px; background: #10b981; border: 2px dashed #10b981;"></div>
                        <span style="font-size: 12px; color: #6b7280;">Proyecci√≥n</span>
                      </div>
                    </div>
                  </div>
                  <div id="graficoProyeccion" style="position: relative; height: 300px; border: 1px solid #f3f4f6; border-radius: 8px; padding: 15px; background: #fafafa;">
                    <!-- Gr√°fico de l√≠nea con proyecci√≥n -->
                  </div>
                </div>

                <!-- Productos con tendencia al alza -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
                  <div style="background: white; border: 2px solid #e5e7eb; border-radius: 12px; padding: 25px; animation: fadeInLeft 0.6s ease-out;">
                    <h3 style="font-weight: 700; color: #1f2937; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                      <span style="font-size: 24px;">üî•</span> Productos en Tendencia Alcista
                    </h3>
                    <div id="productosTendenciaAlza">
                      <!-- Se llenar√° din√°micamente -->
                    </div>
                  </div>

                  <div style="background: white; border: 2px solid #e5e7eb; border-radius: 12px; padding: 25px; animation: fadeInRight 0.6s ease-out;">
                    <h3 style="font-weight: 700; color: #1f2937; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                      <span style="font-size: 24px;">üìâ</span> Productos en Declive
                    </h3>
                    <div id="productosTendenciaBaja">
                      <!-- Se llenar√° din√°micamente -->
                    </div>
                  </div>
                </div>

                <!-- Insights y recomendaciones -->
                <div style="background: linear-gradient(135deg, #dbeafe 0%, #ffffff 100%); border: 2px solid #3b82f6; border-radius: 12px; padding: 25px; margin-bottom: 25px;">
                  <h3 style="font-weight: 700; color: #1e40af; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 24px;">üí°</span> Insights Inteligentes
                  </h3>
                  <div id="insightsInteligentes" style="display: flex; flex-direction: column; gap: 12px;">
                    <!-- Se llenar√° din√°micamente -->
                  </div>
                </div>

                <!-- An√°lisis de estacionalidad -->
                <div style="background: white; border: 2px solid #e5e7eb; border-radius: 12px; padding: 25px; margin-bottom: 25px;">
                  <h3 style="font-weight: 700; color: #1f2937; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 24px;">üìÖ</span> An√°lisis de Estacionalidad
                  </h3>
                  <div id="graficoEstacionalidad" style="position: relative; height: 250px;">
                    <!-- Gr√°fico de barras por mes -->
                  </div>
                </div>

                <!-- Predicci√≥n de demanda -->
                <div style="background: white; border: 2px solid #e5e7eb; border-radius: 12px; padding: 25px;">
                  <h3 style="font-weight: 700; color: #1f2937; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 24px;">üéØ</span> Predicci√≥n de Demanda (Pr√≥ximos 7 d√≠as)
                  </h3>
                  <div id="tablaDemandaPredictiva">
                    <!-- Tabla con productos y demanda estimada -->
                  </div>
                </div>

              </div>
            </div>

          </div>
        </section>

        <!-- ======== SECCI√ìN IMPORTACI√ìN AVANZADA ======== -->
        <section id="importacion" class="hidden">
          <div class="card">
            <div class="card-title">üì• Importaci√≥n Avanzada desde Excel</div>

            <!-- Asistente de Importaci√≥n -->
            <div class="import-wizard">
              <!-- Pasos indicadores -->
              <div class="wizard-steps">
                <div class="wizard-step active" id="wizardStep1">
                  <div class="step-number">1</div>
                  <span>Cargar Archivo</span>
                </div>
                <div class="wizard-step" id="wizardStep2">
                  <div class="step-number">2</div>
                  <span>Asignar Columnas</span>
                </div>
                <div class="wizard-step" id="wizardStep3">
                  <div class="step-number">3</div>
                  <span>Procesar</span>
                </div>
              </div>

              <!-- Paso 0: Bienvenida y Selecci√≥n de Tipo -->
              <div class="wizard-content active" id="importPaso0">
                <div class="import-welcome">
                  <div class="import-icon">üìä</div>
                  <h2>Bienvenido al Asistente de Importaci√≥n Avanzada desde Excel</h2>

                  <!-- Selector de Tipo de Importaci√≥n -->
                  <div class="import-type-selector">
                    <h3>¬øQu√© desea importar?</h3>
                    <div class="import-type-options">
                      <label class="import-type-option active" data-type="productos">
                        <input type="radio" name="importType" value="productos" checked>
                        <div class="import-type-icon">üì¶</div>
                        <div class="import-type-label">Productos</div>
                        <div class="import-type-desc">Lunas, monturas, accesorios, etc.</div>
                      </label>
                      <label class="import-type-option" data-type="clientes">
                        <input type="radio" name="importType" value="clientes">
                        <div class="import-type-icon">üë•</div>
                        <div class="import-type-label">Clientes</div>
                        <div class="import-type-desc">Datos de clientes y contactos</div>
                      </label>
                      <label class="import-type-option" data-type="prescripciones">
                        <input type="radio" name="importType" value="prescripciones">
                        <div class="import-type-icon">üëì</div>
                        <div class="import-type-label">Prescripciones</div>
                        <div class="import-type-desc">Recetas con medidas OD/OI</div>
                      </label>
                      <label class="import-type-option" data-type="pdf">
                        <input type="radio" name="importType" value="pdf">
                        <div class="import-type-icon">üìÑ</div>
                        <div class="import-type-label">PDF Recetas</div>
                        <div class="import-type-desc">Leer recetas desde archivos PDF</div>
                      </label>
                      <label class="import-type-option" data-type="optiabi">
                        <input type="radio" name="importType" value="optiabi">
                        <div class="import-type-icon">üîÑ</div>
                        <div class="import-type-label">Sistema Optiabi</div>
                        <div class="import-type-desc">Importar datos del sistema antiguo</div>
                      </label>
                    </div>
                  </div>

                  <div class="import-info">
                    <h3>Acciones del Importador</h3>
                    <ul>
                      <li class="text-success">Se Importar√°n Nuevos registros al Sistema</li>
                      <li class="text-primary">Se validar√° si existen mediante c√≥digo/DNI</li>
                      <li class="text-primary">Se ajustar√°n los movimientos del Kardex (productos)</li>
                      <li class="text-warning">Soporta archivos hasta 40MB (.xlsx, .xls, .csv)</li>
                    </ul>
                    <p class="import-note">Se recomienda que la primera fila de la hoja del excel contenga los nombres de Cada columna sin espacios.</p>
                  </div>
                  <div class="import-warning">
                    <strong>‚ö†Ô∏è Estimado usuario:</strong> antes de proceder con la importaci√≥n de datos debe verificar que los datos del excel cumplan con las especificaciones se√±aladas
                  </div>
                </div>
              </div>

              <!-- Paso 1: Cargar archivo Excel -->
              <div class="wizard-content" id="importPaso1">
                <h3 class="wizard-title">Paso 1: Cargar datos desde una Hoja de Excel</h3>
                <div class="import-form">
                  <div class="field-row">
                    <label>Nombre de Hoja</label>
                    <input type="text" id="importNombreHoja" placeholder="Hoja1 (opcional, usa la primera por defecto)">
                  </div>
                  <div class="field-row">
                    <label>Archivo de Excel</label>
                    <div class="file-input-wrapper">
                      <input type="text" id="importArchivoNombre" readonly placeholder="Seleccione un archivo Excel o PDF...">
                      <input type="file" id="importArchivoExcel" accept=".xlsx,.xls,.csv,.pdf" style="display:none;">
                      <button class="btn btn-secondary" onclick="document.getElementById('importArchivoExcel').click()">Examinar...</button>
                    </div>
                    <small class="text-muted">M√°ximo 40MB. Formatos: .xlsx, .xls, .csv, .pdf</small>
                  </div>
                  <div class="import-preview-area" id="importPreviewArea">
                    <p class="text-center text-muted">Vista previa de datos aparecer√° aqu√≠...</p>
                  </div>
                </div>
              </div>

              <!-- Paso 2: Asignar columnas -->
              <div class="wizard-content" id="importPaso2">
                <h3 class="wizard-title">Paso 2: Asignar Columnas de la Hoja</h3>

                <!-- Mapeo para PRODUCTOS -->
                <div class="import-columns-container" id="mappingProductos">
                  <div class="import-columns-left">
                    <table class="import-mapping-table">
                      <thead>
                        <tr>
                          <th style="background: #dc2626; color: white;">Campo del Sistema</th>
                          <th style="background: #16a34a; color: white;">Columna del Excel</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr><td>SubC√≥digo</td><td><select id="mapSubCodigo" class="map-select"><option value="">--Seleccione--</option></select></td></tr>
                        <tr><td>Descripci√≥n *</td><td><select id="mapDescripcion" class="map-select"><option value="">--Seleccione--</option></select></td></tr>
                        <tr><td>Marca</td><td><select id="mapMarca" class="map-select"><option value="">--Seleccione--</option></select></td></tr>
                        <tr><td>Modelo</td><td><select id="mapModelo" class="map-select"><option value="">--Seleccione--</option></select></td></tr>
                        <tr><td>Familia</td><td><select id="mapFamilia" class="map-select"><option value="">--Seleccione--</option></select></td></tr>
                        <tr><td>L√≠nea</td><td><select id="mapLinea" class="map-select"><option value="">--Seleccione--</option></select></td></tr>
                        <tr><td>Categor√≠a</td><td><select id="mapCategoria" class="map-select"><option value="">--Seleccione--</option></select></td></tr>
                        <tr><td>Ubicaci√≥n</td><td><select id="mapUbicacion" class="map-select"><option value="">--Seleccione--</option></select></td></tr>
                        <tr><td>Material</td><td><select id="mapMaterial" class="map-select"><option value="">--Seleccione--</option></select></td></tr>
                        <tr><td>Unidad Medida</td><td><select id="mapUnidadMedida" class="map-select"><option value="">--Seleccione--</option></select></td></tr>
                        <tr><td>Talla</td><td><select id="mapTalla" class="map-select"><option value="">--Seleccione--</option></select></td></tr>
                        <tr><td>Caracter√≠stica</td><td><select id="mapCaracteristica" class="map-select"><option value="">--Seleccione--</option></select></td></tr>
                        <tr><td>Stock</td><td><select id="mapStock" class="map-select"><option value="">--Seleccione--</option></select></td></tr>
                      </tbody>
                    </table>
                  </div>
                  <div class="import-columns-right">
                    <div class="import-option-check">
                      <label><input type="checkbox" id="importNoIngresarDuplicados" checked> No ingresar si existe el subc√≥digo</label>
                    </div>
                    <div class="import-prices-box">
                      <div class="price-row">
                        <label>Precio Compra</label>
                        <select id="mapPrecioCompra" class="map-select"><option value="">--Seleccione--</option></select>
                      </div>
                      <div class="price-row">
                        <label>Precio Venta</label>
                        <select id="mapPrecioVenta" class="map-select"><option value="">--Seleccione--</option></select>
                      </div>
                      <div class="price-row">
                        <label>Precio Venta Medio</label>
                        <select id="mapPrecioVentaMedio" class="map-select"><option value="">--Seleccione--</option></select>
                      </div>
                      <div class="price-row">
                        <label>Precio Venta M√≠nimo</label>
                        <select id="mapPrecioVentaMinimo" class="map-select"><option value="">--Seleccione--</option></select>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Mapeo para CLIENTES -->
                <div class="import-columns-container" id="mappingClientes" style="display: none;">
                  <div class="import-columns-left" style="flex: 1;">
                    <table class="import-mapping-table">
                      <thead>
                        <tr>
                          <th style="background: #7c3aed; color: white;">Campo del Sistema</th>
                          <th style="background: #16a34a; color: white;">Columna del Excel</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr><td>Nombre / Nombres *</td><td><select id="mapCliNombre" class="map-select"><option value="">--Seleccione--</option></select></td></tr>
                        <tr><td>Apellidos</td><td><select id="mapCliApellido" class="map-select"><option value="">--Seleccione--</option></select></td></tr>
                        <tr><td>DNI / Documento</td><td><select id="mapCliDni" class="map-select"><option value="">--Seleccione--</option></select></td></tr>
                        <tr><td>Celular / Tel√©fono</td><td><select id="mapCliCelular" class="map-select"><option value="">--Seleccione--</option></select></td></tr>
                        <tr><td>Email / Correo</td><td><select id="mapCliEmail" class="map-select"><option value="">--Seleccione--</option></select></td></tr>
                        <tr><td>Direcci√≥n</td><td><select id="mapCliDireccion" class="map-select"><option value="">--Seleccione--</option></select></td></tr>
                        <tr><td>Ciudad / Distrito</td><td><select id="mapCliCiudad" class="map-select"><option value="">--Seleccione--</option></select></td></tr>
                        <tr><td>Fecha Nacimiento</td><td><select id="mapCliFechaNac" class="map-select"><option value="">--Seleccione--</option></select></td></tr>
                        <tr><td>Observaciones</td><td><select id="mapCliObservaciones" class="map-select"><option value="">--Seleccione--</option></select></td></tr>
                      </tbody>
                    </table>
                  </div>
                  <div class="import-columns-right">
                    <div class="import-option-check">
                      <label><input type="checkbox" id="importNoIngresarDuplicadosCli"> No ingresar si existe el DNI</label>
                    </div>
                    <div class="import-info-box" style="background: #f0fdf4; padding: 15px; border-radius: 8px; margin-top: 15px;">
                      <h4 style="color: #166534; margin-bottom: 10px;">üìå Mapeo Autom√°tico</h4>
                      <p style="font-size: 12px; color: #166534;">El sistema detectar√° autom√°ticamente columnas como:<br>
                      ‚Ä¢ Nombre, Nombres, Cliente<br>
                      ‚Ä¢ Apellido, Apellidos<br>
                      ‚Ä¢ DNI, Documento, RUC<br>
                      ‚Ä¢ Celular, Tel√©fono, Phone<br>
                      ‚Ä¢ Email, Correo, Mail</p>
                    </div>
                  </div>
                </div>

                <!-- Mapeo para PRESCRIPCIONES -->
                <div class="import-columns-container" id="mappingPrescripciones" style="display: none;">
                  <div class="import-columns-left" style="flex: 1;">
                    <table class="import-mapping-table">
                      <thead>
                        <tr>
                          <th style="background: #0891b2; color: white;">Campo del Sistema</th>
                          <th style="background: #16a34a; color: white;">Columna del Excel</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr><td>C√≥digo *</td><td><select id="mapRxCodigo" class="map-select"><option value="">--Seleccione--</option></select></td></tr>
                        <tr><td>Paciente / Cliente *</td><td><select id="mapRxPaciente" class="map-select"><option value="">--Seleccione--</option></select></td></tr>
                        <tr><td>Fecha</td><td><select id="mapRxFecha" class="map-select"><option value="">--Seleccione--</option></select></td></tr>
                        <tr><td>Especialista</td><td><select id="mapRxEspecialista" class="map-select"><option value="">--Seleccione--</option></select></td></tr>
                        <tr><td>OD ESF (Ojo Derecho Esfera)</td><td><select id="mapRxOdEsf" class="map-select"><option value="">--Seleccione--</option></select></td></tr>
                        <tr><td>OD CIL (Ojo Derecho Cilindro)</td><td><select id="mapRxOdCil" class="map-select"><option value="">--Seleccione--</option></select></td></tr>
                        <tr><td>OD EJE (Ojo Derecho Eje)</td><td><select id="mapRxOdEje" class="map-select"><option value="">--Seleccione--</option></select></td></tr>
                        <tr><td>OD ADD (Ojo Derecho Adici√≥n)</td><td><select id="mapRxOdAdd" class="map-select"><option value="">--Seleccione--</option></select></td></tr>
                        <tr><td>OI ESF (Ojo Izquierdo Esfera)</td><td><select id="mapRxOiEsf" class="map-select"><option value="">--Seleccione--</option></select></td></tr>
                        <tr><td>OI CIL (Ojo Izquierdo Cilindro)</td><td><select id="mapRxOiCil" class="map-select"><option value="">--Seleccione--</option></select></td></tr>
                        <tr><td>OI EJE (Ojo Izquierdo Eje)</td><td><select id="mapRxOiEje" class="map-select"><option value="">--Seleccione--</option></select></td></tr>
                        <tr><td>OI ADD (Ojo Izquierdo Adici√≥n)</td><td><select id="mapRxOiAdd" class="map-select"><option value="">--Seleccione--</option></select></td></tr>
                        <tr><td>DIP (Distancia Interpupilar)</td><td><select id="mapRxDip" class="map-select"><option value="">--Seleccione--</option></select></td></tr>
                        <tr><td>Observaciones</td><td><select id="mapRxObservaciones" class="map-select"><option value="">--Seleccione--</option></select></td></tr>
                      </tbody>
                    </table>
                  </div>
                  <div class="import-columns-right">
                    <div class="import-option-check">
                      <label><input type="checkbox" id="importNoIngresarDuplicadosRx"> No ingresar si existe el C√≥digo</label>
                    </div>
                    <div class="import-info-box" style="background: #ecfeff; padding: 15px; border-radius: 8px; margin-top: 15px;">
                      <h4 style="color: #0e7490; margin-bottom: 10px;">üëì Mapeo Autom√°tico</h4>
                      <p style="font-size: 12px; color: #0e7490;">El sistema detectar√° autom√°ticamente columnas como:<br>
                      ‚Ä¢ Codigo, Code, ID<br>
                      ‚Ä¢ Paciente, Cliente, Patient<br>
                      ‚Ä¢ Fecha, Date<br>
                      ‚Ä¢ Especialista, Doctor<br>
                      ‚Ä¢ OD_ESF, OD_CIL, OI_ESF, OI_CIL<br>
                      ‚Ä¢ Medidas oftalmol√≥gicas est√°ndar<br><br>
                      <strong>‚ö†Ô∏è El campo Paciente se dividir√° autom√°ticamente en Nombre y Apellido</strong></p>
                    </div>
                  </div>
                </div>

                <!-- Mapeo para PDFs -->
                <div class="import-columns-container" id="mappingPdf" style="display: none;">
                  <div class="import-columns-left" style="flex: 1;">
                    <table class="import-mapping-table">
                      <thead>
                        <tr>
                          <th style="background: #7c3aed; color: white;">Campo del Sistema</th>
                          <th style="background: #16a34a; color: white;">Columna Detectada en PDF</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr><td>Paciente / Cliente *</td><td><select id="mapPdfPaciente" class="map-select"><option value="">--Seleccione--</option></select></td></tr>
                        <tr><td>Edad</td><td><select id="mapPdfEdad" class="map-select"><option value="">--Seleccione--</option></select></td></tr>
                        <tr><td>Fecha</td><td><select id="mapPdfFecha" class="map-select"><option value="">--Seleccione--</option></select></td></tr>
                        <tr><td>OD ESF (Ojo Derecho Esfera)</td><td><select id="mapPdfOdEsf" class="map-select"><option value="">--Seleccione--</option></select></td></tr>
                        <tr><td>OD CIL (Ojo Derecho Cilindro)</td><td><select id="mapPdfOdCil" class="map-select"><option value="">--Seleccione--</option></select></td></tr>
                        <tr><td>OD EJE (Ojo Derecho Eje)</td><td><select id="mapPdfOdEje" class="map-select"><option value="">--Seleccione--</option></select></td></tr>
                        <tr><td>OD ADD (Ojo Derecho Adici√≥n)</td><td><select id="mapPdfOdAdd" class="map-select"><option value="">--Seleccione--</option></select></td></tr>
                        <tr><td>OI ESF (Ojo Izquierdo Esfera)</td><td><select id="mapPdfOiEsf" class="map-select"><option value="">--Seleccione--</option></select></td></tr>
                        <tr><td>OI CIL (Ojo Izquierdo Cilindro)</td><td><select id="mapPdfOiCil" class="map-select"><option value="">--Seleccione--</option></select></td></tr>
                        <tr><td>OI EJE (Ojo Izquierdo Eje)</td><td><select id="mapPdfOiEje" class="map-select"><option value="">--Seleccione--</option></select></td></tr>
                        <tr><td>OI ADD (Ojo Izquierdo Adici√≥n)</td><td><select id="mapPdfOiAdd" class="map-select"><option value="">--Seleccione--</option></select></td></tr>
                        <tr><td>Montura / Frame</td><td><select id="mapPdfMontura" class="map-select"><option value="">--Seleccione--</option></select></td></tr>
                        <tr><td>Cristales / Lentes</td><td><select id="mapPdfCristales" class="map-select"><option value="">--Seleccione--</option></select></td></tr>
                        <tr><td>Precio / Total</td><td><select id="mapPdfPrecio" class="map-select"><option value="">--Seleccione--</option></select></td></tr>
                        <tr><td>Observaciones</td><td><select id="mapPdfObservaciones" class="map-select"><option value="">--Seleccione--</option></select></td></tr>
                      </tbody>
                    </table>
                  </div>
                  <div class="import-columns-right">
                    <div class="import-info-box" style="background: #f3e8ff; padding: 15px; border-radius: 8px;">
                      <h4 style="color: #7c3aed; margin-bottom: 10px;">üìÑ Extracci√≥n desde PDF</h4>
                      <p style="font-size: 12px; color: #6b21a8;">El sistema extrae autom√°ticamente datos de PDFs con recetas oftalmol√≥gicas.<br><br>
                      Se detectan patrones como:<br>
                      ‚Ä¢ Paciente, Nombre, Patient<br>
                      ‚Ä¢ Edad, Age<br>
                      ‚Ä¢ OD / OI (Ojo Derecho / Izquierdo)<br>
                      ‚Ä¢ Medidas ESF, CIL, EJE, ADD<br>
                      ‚Ä¢ Montura, Frame, Armaz√≥n<br>
                      ‚Ä¢ Cristales, Lentes<br>
                      ‚Ä¢ Precio, Total<br><br>
                      <strong>üí° Los datos extra√≠dos se guardar√°n en el historial del paciente</strong></p>
                    </div>
                  </div>
                </div>

                <!-- Mapeo para OPTIABI -->
                <div class="import-columns-container" id="mappingOptiabi" style="display: none;">
                  <div class="import-columns-left" style="flex: 1;">
                    <table class="import-mapping-table">
                      <thead>
                        <tr>
                          <th style="background: #9333ea; color: white;">Campo del Sistema</th>
                          <th style="background: #16a34a; color: white;">Columna del Excel/PDF Optiabi</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr><td>Apellidos y Nombres *</td><td><select id="mapOptiabiApellidos" class="map-select"><option value="">--Seleccione--</option></select></td></tr>
                        <tr><td>Edad</td><td><select id="mapOptiabiEdad" class="map-select"><option value="">--Seleccione--</option></select></td></tr>
                        <tr><td>O.D (Ojo Derecho)</td><td><select id="mapOptiabiOd" class="map-select"><option value="">--Seleccione--</option></select></td></tr>
                        <tr><td>O.I (Ojo Izquierdo)</td><td><select id="mapOptiabiOi" class="map-select"><option value="">--Seleccione--</option></select></td></tr>
                        <tr><td>Monturas</td><td><select id="mapOptiabiMonturas" class="map-select"><option value="">--Seleccione--</option></select></td></tr>
                        <tr><td>Cristales</td><td><select id="mapOptiabiCristales" class="map-select"><option value="">--Seleccione--</option></select></td></tr>
                        <tr><td>Precio</td><td><select id="mapOptiabiPrecio" class="map-select"><option value="">--Seleccione--</option></select></td></tr>
                        <tr><td>Adelanto</td><td><select id="mapOptiabiAdelanto" class="map-select"><option value="">--Seleccione--</option></select></td></tr>
                        <tr><td>Deuda</td><td><select id="mapOptiabiDeuda" class="map-select"><option value="">--Seleccione--</option></select></td></tr>
                        <tr><td>Fecha de Venta</td><td><select id="mapOptiabiFechaVenta" class="map-select"><option value="">--Seleccione--</option></select></td></tr>
                        <tr><td>Documento / DNI</td><td><select id="mapOptiabiDocumento" class="map-select"><option value="">--Seleccione--</option></select></td></tr>
                        <tr><td>Tel√©fono</td><td><select id="mapOptiabiTelefono" class="map-select"><option value="">--Seleccione--</option></select></td></tr>
                        <tr><td>Direcci√≥n</td><td><select id="mapOptiabiDireccion" class="map-select"><option value="">--Seleccione--</option></select></td></tr>
                        <tr><td>Observaciones</td><td><select id="mapOptiabiObservaciones" class="map-select"><option value="">--Seleccione--</option></select></td></tr>
                      </tbody>
                    </table>
                  </div>
                  <div class="import-columns-right">
                    <div class="import-info-box" style="background: #faf5ff; padding: 15px; border-radius: 8px;">
                      <h4 style="color: #9333ea; margin-bottom: 10px;">üîÑ Importaci√≥n desde Optiabi</h4>
                      <p style="font-size: 12px; color: #7e22ce;">Importa datos del sistema antiguo Optiabi con todos los campos:<br><br>
                      <strong>Datos del Cliente:</strong><br>
                      ‚Ä¢ Apellidos y Nombres<br>
                      ‚Ä¢ Edad, Documento, Tel√©fono<br><br>
                      <strong>Prescripci√≥n Oftalmol√≥gica:</strong><br>
                      ‚Ä¢ O.D / O.I con formatos: "CIL-2.00X179", "ESF-0.75", "+1.50-3.00X163"<br>
                      ‚Ä¢ Monturas y Cristales<br><br>
                      <strong>Datos de Venta:</strong><br>
                      ‚Ä¢ Precio, Adelanto, Deuda<br>
                      ‚Ä¢ Fecha de Venta<br><br>
                      <strong>üí° Los datos se integran 100% en:</strong><br>
                      ‚Ä¢ Consultas<br>
                      ‚Ä¢ Buscar RX<br>
                      ‚Ä¢ Reportes<br>
                      ‚Ä¢ Historial de Clientes</p>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Paso 3: Procesar informaci√≥n -->
              <div class="wizard-content" id="importPaso3">
                <h3 class="wizard-title">3-Procesar Informaci√≥n</h3>
                <p class="text-warning" style="font-size: 12px; margin-bottom: 20px;">
                  <strong>Estimado usuario debe haber revisado los datos detalladamente ya que esta operaci√≥n es irreversible, solo se importar√°n los datos de los productos</strong>
                </p>
                <div class="import-process-grid">
                  <div class="process-column">
                    <h4>Salida de Procesados</h4>
                    <div class="process-output" id="importSalidaProcesados">
                      <p class="text-muted">Esperando proceso...</p>
                    </div>
                  </div>
                  <div class="process-column">
                    <h4>Salida de Errores</h4>
                    <div class="process-output process-errors" id="importSalidaErrores">
                      <p class="text-muted">Sin errores</p>
                    </div>
                    <div class="process-progress">
                      <div class="progress-bar" id="importProgressBar"></div>
                    </div>
                  </div>
                  <div class="process-column">
                    <h4>Existentes</h4>
                    <div class="process-output" id="importExistentes">
                      <table class="mini-table">
                        <thead><tr><th>‚úì</th><th>C√ìDIGO</th></tr></thead>
                        <tbody id="importExistentesBody"></tbody>
                      </table>
                    </div>
                  </div>
                </div>
                <div class="import-process-actions">
                  <button class="btn btn-primary btn-lg" onclick="procesarImportacion()">
                    ‚öôÔ∏è Procesar
                  </button>
                  <button class="btn btn-danger btn-lg" onclick="cancelarImportacion()">
                    üö´ Cancelar
                  </button>
                </div>
                <div class="import-result-message" id="importResultMessage" style="display: none;"></div>
              </div>

              <!-- Navegaci√≥n del wizard -->
              <div class="wizard-navigation">
                <button class="btn btn-secondary" id="btnImportPrev" onclick="importWizardPrev()" style="visibility: hidden;">
                  ‚¨ÖÔ∏è Anterior
                </button>
                <button class="btn btn-primary" id="btnImportNext" onclick="importWizardNext()">
                  Siguiente ‚û°Ô∏è
                </button>
                <button class="btn btn-danger" onclick="cerrarImportWizard()">
                  üö™ Salir
                </button>
              </div>
            </div>

          </div>
        </section>

        <!-- ======== SECCI√ìN CAJA ======== -->
        <section id="caja" class="hidden">
          <div class="card">
            <div class="card-title">üí∞ Gesti√≥n de Caja</div>

            <!-- Tabs de Caja -->
            <div class="config-tabs">
              <button class="config-tab-btn active" onclick="mostrarCajaTab('tabApertura', this)">
                üìÇ Apertura
              </button>
              <button class="config-tab-btn" onclick="mostrarCajaTab('tabCierre', this)">
                üîí Cierre
              </button>
              <button class="config-tab-btn" onclick="mostrarCajaTab('tabMovimientos', this)">
                üìä Movimientos
              </button>
              <button class="config-tab-btn" onclick="mostrarCajaTab('tabCobroVentas', this)">
                üíµ Cobro de Ventas
              </button>
              <button class="config-tab-btn" onclick="mostrarCajaTab('tabPagoProveedores', this)">
                üí≥ Pago a Proveedores
              </button>
            </div>

            <!-- TAB: APERTURA DE CAJA -->
            <div class="config-tab-content active" id="tabApertura">
              <div style="max-width: 600px; margin: 0 auto; padding: 30px;">
                <h3 style="color: #7c3aed; margin-bottom: 25px; text-align: center;">üìÇ Apertura de Caja</h3>

                <div class="config-form-group">
                  <label class="config-form-label">Fecha de Apertura</label>
                  <input type="date" class="config-form-input" id="aperturaFecha" value="">
                </div>

                <div class="config-form-group">
                  <label class="config-form-label">Monto de Apertura</label>
                  <input type="number" class="config-form-input" id="aperturaMonto" placeholder="0.00" step="0.01">
                </div>

                <div class="config-form-group">
                  <label class="config-form-label">Observaci√≥n</label>
                  <textarea class="config-form-input" id="aperturaObservacion" rows="4" placeholder="Observaciones del d√≠a..."></textarea>
                </div>

                <div style="display: flex; gap: 12px; justify-content: center; margin-top: 30px;">
                  <button class="btn btn-success" onclick="guardarAperturaCaja()">‚úÖ Guardar</button>
                  <button class="btn btn-secondary" onclick="cancelarAperturaCaja()">‚ùå Cancelar</button>
                </div>

                <!-- Estado de caja actual -->
                <div id="estadoCajaActual" style="margin-top: 30px; padding: 20px; background: #f3f4f6; border-radius: 8px; display: none;">
                  <h4 style="color: #059669; margin-bottom: 10px;">‚úÖ Caja Abierta</h4>
                  <div id="infoCajaActual"></div>
                </div>
              </div>
            </div>

            <!-- TAB: CIERRE DE CAJA -->
            <div class="config-tab-content" id="tabCierre">
              <div style="padding: 20px;">
                <h3 style="color: #7c3aed; margin-bottom: 20px;">üîí Cierre de Caja</h3>

                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 25px;">
                  <div style="background: #f3f4f6; padding: 15px; border-radius: 8px;">
                    <div style="font-size: 12px; color: #6b7280;">Apertura</div>
                    <div style="font-size: 24px; font-weight: bold; color: #059669;" id="cierreMontoApertura">S/ 0.00</div>
                  </div>
                  <div style="background: #f3f4f6; padding: 15px; border-radius: 8px;">
                    <div style="font-size: 12px; color: #6b7280;">Cierre</div>
                    <div style="font-size: 24px; font-weight: bold; color: #dc2626;" id="cierreMontoFinal">S/ 0.00</div>
                  </div>
                  <div style="background: #f3f4f6; padding: 15px; border-radius: 8px;">
                    <div style="font-size: 12px; color: #6b7280;">Tipo de Cambio</div>
                    <input type="number" style="font-size: 20px; font-weight: bold; width: 100%; border: 1px solid #d1d5db; padding: 5px; border-radius: 4px;" id="cierreTipoCambio" value="3.80" step="0.01">
                  </div>
                </div>

                <!-- Resumen por operaci√≥n -->
                <div style="margin-bottom: 20px;">
                  <h4 style="color: #374151; margin-bottom: 12px;">üìä Resumen por Operaci√≥n</h4>
                  <table class="data-table" style="width: 100%;">
                    <thead>
                      <tr>
                        <th>TIPO OPERACI√ìN</th>
                        <th>Tipo</th>
                        <th>TOTAL</th>
                        <th>CAJA</th>
                      </tr>
                    </thead>
                    <tbody id="cierreResumenOperaciones">
                      <!-- Se llena din√°micamente -->
                    </tbody>
                  </table>
                </div>

                <!-- Totales -->
                <div style="margin-bottom: 20px;">
                  <h4 style="color: #374151; margin-bottom: 12px;">üí∞ Totales por Forma de Pago</h4>
                  <table class="data-table" style="width: 100%;">
                    <thead>
                      <tr>
                        <th>FORMA DE PAGO</th>
                        <th>TOTAL</th>
                        <th>CAJA</th>
                      </tr>
                    </thead>
                    <tbody id="cierreTotalesFormaPago">
                      <!-- Se llena din√°micamente -->
                    </tbody>
                  </table>
                </div>

                <div style="display: flex; gap: 12px; justify-content: center; margin-top: 30px;">
                  <button class="btn btn-info" onclick="mostrarResumenCierre()">üìä Listar Resumen</button>
                  <button class="btn btn-danger" onclick="cerrarCaja()">üîí Cerrar Caja</button>
                  <button class="btn btn-secondary" onclick="imprimirCierreCaja()">üñ®Ô∏è Imprimir</button>
                  <button class="btn btn-success" onclick="exportarCierreExcel()">üìä Excel</button>
                </div>
              </div>
            </div>

            <!-- TAB: MOVIMIENTOS DE CAJA -->
            <div class="config-tab-content" id="tabMovimientos">
              <div style="padding: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                  <h3 style="color: #7c3aed; margin: 0;">üìä Movimientos de Caja</h3>
                  <div style="display: flex; gap: 8px;">
                    <button class="btn btn-info btn-sm" onclick="mostrarMovimientosCaja()">üîç Mostrar</button>
                    <button class="btn btn-success btn-sm" onclick="nuevoMovimientoCaja()">‚ûï Nuevo</button>
                    <button class="btn btn-warning btn-sm" onclick="modificarMovimientoSeleccionado()">‚úèÔ∏è Modificar</button>
                    <button class="btn btn-danger btn-sm" onclick="anularMovimientoSeleccionado()">üö´ Anular</button>
                    <button class="btn btn-secondary btn-sm" onclick="verDetalleMovimiento()">üëÅÔ∏è Ver Detalle</button>
                    <button class="btn btn-success btn-sm" onclick="exportarMovimientosExcel()">üìä Excel</button>
                  </div>
                </div>

                <!-- Filtros -->
                <div style="display: flex; gap: 12px; margin-bottom: 20px; padding: 15px; background: #f9fafb; border-radius: 8px;">
                  <div class="field" style="flex: 1;">
                    <label>Filtrar por Operaci√≥n</label>
                    <select id="filtroMovimientoOperacion" class="config-form-select">
                      <option value="">Todas</option>
                      <option value="LABORATORIO">LABORATORIO</option>
                      <option value="PROVEEDOR MONTURA">PROVEEDOR MONTURA</option>
                      <option value="ARTICULOS DE OFICINA">ART√çCULOS DE OFICINA</option>
                      <option value="UTILES DE LIMPIEZA">√öTILES DE LIMPIEZA</option>
                      <option value="SUELDO">SUELDO</option>
                    </select>
                  </div>
                  <div class="field" style="flex: 1;">
                    <label>Caja/Cuenta</label>
                    <select id="filtroMovimientoCaja" class="config-form-select">
                      <option value="">Todas</option>
                    </select>
                  </div>
                </div>

                <!-- Tabla de movimientos -->
                <div style="overflow-x: auto;">
                  <table class="data-table" style="width: 100%;">
                    <thead>
                      <tr>
                        <th>ID</th>
                        <th>CONCEPTO</th>
                        <th>MONTO</th>
                        <th>TIPO</th>
                        <th>TIPO OPERACI√ìN</th>
                        <th>FORMA PAGO</th>
                        <th>FECHA OPERACI√ìN</th>
                        <th>FECHA REGISTRO</th>
                        <th>ESTADO</th>
                        <th>CAJA</th>
                      </tr>
                    </thead>
                    <tbody id="movimientosCajaBody">
                      <tr><td colspan="10" style="text-align: center; padding: 40px; color: #9ca3af;">No hay movimientos registrados</td></tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

            <!-- TAB: COBRO DE VENTAS -->
            <div class="config-tab-content" id="tabCobroVentas">
              <div style="padding: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                  <h3 style="color: #7c3aed; margin: 0;">üíµ Cobro de Ventas</h3>
                  <div style="display: flex; gap: 8px;">
                    <button class="btn btn-info btn-sm" onclick="mostrarCobrosVentas()">üîç Mostrar</button>
                    <button class="btn btn-success btn-sm" onclick="nuevoCobroVenta()">‚ûï Nuevo</button>
                    <button class="btn btn-danger btn-sm" onclick="anularCobroSeleccionado()">üö´ Anular</button>
                    <button class="btn btn-success btn-sm" onclick="exportarCobrosExcel()">üìä Excel</button>
                  </div>
                </div>

                <!-- Tabla de cobros -->
                <div style="overflow-x: auto;">
                  <table class="data-table" style="width: 100%;">
                    <thead>
                      <tr>
                        <th>ID</th>
                        <th>CONCEPTO</th>
                        <th>MONTO</th>
                        <th>TIPO</th>
                        <th>DOCUMENTO</th>
                        <th>FORMA PAGO</th>
                        <th>FECHA</th>
                        <th>REGISTRO</th>
                        <th>ESTADO</th>
                        <th>CAJA</th>
                      </tr>
                    </thead>
                    <tbody id="cobrosVentasBody">
                      <tr><td colspan="10" style="text-align: center; padding: 40px; color: #9ca3af;">No hay cobros registrados</td></tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

            <!-- TAB: PAGO A PROVEEDORES -->
            <div class="config-tab-content" id="tabPagoProveedores">
              <div style="padding: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                  <h3 style="color: #7c3aed; margin: 0;">üí≥ Pago a Proveedores</h3>
                  <div style="display: flex; gap: 8px;">
                    <button class="btn btn-info btn-sm" onclick="mostrarPagosProveedores()">üîç Mostrar</button>
                    <button class="btn btn-danger btn-sm" onclick="anularPagoSeleccionado()">üö´ Anular</button>
                    <button class="btn btn-secondary btn-sm" onclick="imprimirDocumentoPago()">üñ®Ô∏è Imprimir Documento</button>
                    <button class="btn btn-success btn-sm" onclick="exportarPagosExcel()">üìä Excel</button>
                  </div>
                </div>

                <!-- Filtros -->
                <div style="display: flex; gap: 12px; margin-bottom: 20px; padding: 15px; background: #f9fafb; border-radius: 8px;">
                  <div class="field" style="flex: 1;">
                    <label>Por Fecha de Operaci√≥n</label>
                    <div style="display: flex; gap: 8px;">
                      <input type="date" id="filtroPagoDesde" class="config-form-input">
                      <input type="date" id="filtroPagoHasta" class="config-form-input">
                    </div>
                  </div>
                  <div class="field" style="flex: 1;">
                    <label>Por Proveedor</label>
                    <input type="text" id="filtroPagoProveedor" class="config-form-input" placeholder="Ingrese raz√≥n social del proveedor">
                  </div>
                </div>

                <!-- Tabla de pagos -->
                <div style="overflow-x: auto;">
                  <table class="data-table" style="width: 100%;">
                    <thead>
                      <tr>
                        <th>ID</th>
                        <th>CONCEPTO</th>
                        <th>MONTO</th>
                        <th>PROVEEDOR</th>
                        <th>DOCUMENTO</th>
                        <th>FORMA PAGO</th>
                        <th>FECHA</th>
                        <th>REGISTRO</th>
                        <th>ESTADO</th>
                        <th>CAJA</th>
                      </tr>
                    </thead>
                    <tbody id="pagosProveedoresBody">
                      <tr><td colspan="10" style="text-align: center; padding: 40px; color: #9ca3af;">No hay pagos registrados</td></tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

          </div>
        </section>

        <!-- ======== SECCI√ìN CONFIGURACI√ìN ======== -->
        <section id="configuracion" class="hidden">
          <div class="card">
            <div class="card-title">‚öôÔ∏è Configuraci√≥n del Sistema</div>

            <!-- Tabs de Configuraci√≥n -->
            <div class="config-tabs">
              <button class="config-tab-btn active" onclick="mostrarConfigTab('tabUsuarios', this)">
                üë§ Usuarios
              </button>
              <button class="config-tab-btn" onclick="mostrarConfigTab('tabUsuariosAlmacen', this)">
                üè™ Usuarios con Almacenes
              </button>
              <button class="config-tab-btn" onclick="mostrarConfigTab('tabCorrelativos', this)">
                üìÑ Correlativo Documentos
              </button>
              <button class="config-tab-btn" onclick="mostrarConfigTab('tabUsuariosCaja', this)">
                üí∞ Usuarios con Cajas
              </button>
            </div>

            <!-- Tab: Usuarios -->
            <div class="config-tab-content active" id="tabUsuarios">
              <div class="config-toolbar">
                <button class="btn btn-info" onclick="mostrarUsuarios()">üîç Mostrar</button>
                <button class="btn btn-success" onclick="abrirModalUsuario()">‚ûï Nuevo</button>
                <button class="btn btn-warning" onclick="modificarUsuarioSeleccionado()">‚úèÔ∏è Modificar</button>
                <button class="btn btn-danger" onclick="anularUsuarioSeleccionado()">üö´ Anular</button>
              </div>
              <div class="config-table-container">
                <table class="data-table">
                  <thead>
                    <tr>
                      <th style="width: 40px;"></th>
                      <th>USUARIO</th>
                      <th>RESPONSABLE</th>
                      <th>ESTADO</th>
                      <th>GRUPO</th>
                    </tr>
                  </thead>
                  <tbody id="usuariosBody"></tbody>
                </table>
              </div>
              <div class="config-footer">
                <span id="usuariosCount">REGISTROS ENCONTRADOS: 0</span>
              </div>
            </div>

            <!-- Tab: Usuarios con Almacenes -->
            <div class="config-tab-content" id="tabUsuariosAlmacen">
              <div class="config-info-banner">
                ‚ö†Ô∏è Estimado usuario para mostrar los almacenes y asignar el acceso, se debe haber dado privilegio al usuario a determinado almac√©n ya que los almacenes pertenecen a un establecimiento
              </div>
              <div class="config-split-panel">
                <div class="config-panel-left">
                  <input type="text" id="buscarUsuarioAlmacen" placeholder="Buscar usuario..." class="config-search">
                  <div class="config-user-list" id="listaUsuariosAlmacen"></div>
                </div>
                <div class="config-panel-right">
                  <h4>Almacenes Asignados</h4>
                  <div class="config-almacen-list" id="listaAlmacenesUsuario"></div>
                  <div class="config-almacen-actions">
                    <select id="selectAlmacenAsignar">
                      <option value="">-- Seleccionar Almac√©n --</option>
                    </select>
                    <button class="btn btn-success btn-sm" onclick="asignarAlmacenUsuario()">‚ûï Asignar</button>
                  </div>
                </div>
              </div>
              <div class="config-toolbar" style="justify-content: flex-end;">
                <button class="btn btn-danger" onclick="mostrarSeccion('ventas')">üö™ Salir</button>
              </div>
            </div>

            <!-- Tab: Correlativo Documentos -->
            <div class="config-tab-content" id="tabCorrelativos">
              <div class="config-toolbar">
                <button class="btn btn-info" onclick="mostrarCorrelativos()">üîç Mostrar</button>
                <button class="btn btn-success" onclick="abrirModalCorrelativo()">‚ûï Nuevo</button>
                <button class="btn btn-warning" onclick="modificarCorrelativoSeleccionado()">‚úèÔ∏è Modificar</button>
                <button class="btn btn-danger" onclick="eliminarCorrelativoSeleccionado()">üóëÔ∏è Eliminar</button>
              </div>
              <div class="config-table-container">
                <table class="data-table">
                  <thead>
                    <tr>
                      <th style="width: 40px;"></th>
                      <th>DOCUMENTO</th>
                      <th>SERIE</th>
                      <th>EMITIDOS</th>
                      <th>ESTABLECIMIENTO</th>
                    </tr>
                  </thead>
                  <tbody id="correlativosBody"></tbody>
                </table>
              </div>
              <div class="config-footer">
                <span id="correlativosCount">REGISTROS ENCONTRADOS: 0</span>
              </div>
            </div>

            <!-- Tab: Usuarios con Cajas -->
            <div class="config-tab-content" id="tabUsuariosCaja">
              <div class="config-info-banner">
                ‚ö†Ô∏è Estimado usuario para mostrar las cajas y asignar el acceso, se debe haber dado privilegio al usuario a determinado almac√©n ya que las cajas pertenecen a un almac√©n o establecimiento
              </div>
              <div class="config-split-panel">
                <div class="config-panel-left">
                  <input type="text" id="buscarUsuarioCaja" placeholder="Buscar usuario..." class="config-search">
                  <div class="config-user-list" id="listaUsuariosCaja"></div>
                </div>
                <div class="config-panel-right">
                  <h4>Cajas Asignadas</h4>
                  <div class="config-caja-list" id="listaCajasUsuario"></div>
                  <div class="config-caja-actions">
                    <select id="selectCajaAsignar">
                      <option value="">-- Seleccionar Caja --</option>
                    </select>
                    <button class="btn btn-success btn-sm" onclick="asignarCajaUsuario()">‚ûï Asignar</button>
                  </div>
                </div>
              </div>
              <div class="config-toolbar" style="justify-content: flex-end;">
                <button class="btn btn-danger" onclick="mostrarSeccion('ventas')">üö™ Salir</button>
              </div>
            </div>

          </div>
        </section>

</main>

<!-- ===== VENTANA PRESCRIPCI√ìN (MODAL) ===== -->
<div class="mdi-window" id="prescripcionWindow" style="position: fixed; display: none; z-index: 2000;">
    <div class="mdi-titlebar" id="rxTitleBar" style="background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); border-bottom: 3px solid #3b82f6; padding: 16px 24px; box-shadow: 0 4px 20px rgba(59, 130, 246, 0.3);">
      <span style="font-size: 18px; font-weight: 800; display: flex; align-items: center; gap: 12px;">
        <span style="background: linear-gradient(135deg, #3b82f6, #2563eb); padding: 8px 12px; border-radius: 8px; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);">üëÅÔ∏è</span>
        <span id="rxClienteNombre" style="color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">Paciente</span>
      </span>
      <div class="mdi-buttons">
        <button class="btn-minimize" id="btnRxMin" style="background: #3b82f6; color: white; width: 40px; height: 40px; border-radius: 8px; font-size: 24px; font-weight: 700; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); transition: all 0.3s;">‚àí</button>
        <button class="btn-close" id="btnRxClose" style="background: #ef4444; color: white; width: 40px; height: 40px; border-radius: 8px; font-size: 24px; font-weight: 700; box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3); transition: all 0.3s;">√ó</button>
      </div>
    </div>
    <div class="mdi-content">
      <!-- Header Paciente -->
      <div class="card" style="margin: 16px; margin-bottom: 0;">
        <div class="row">
          <div class="field" style="flex: 2;">
            <label>Paciente</label>
            <input id="rxPaciente" readonly style="font-weight: bold; font-size: 14px;">
          </div>
          <div class="field">
            <label>Ocupaci√≥n</label>
            <input id="rxOcupacion">
          </div>
        </div>
        <div class="row mt-1">
          <div class="field">
            <label>Fecha</label>
            <input type="date" id="rxFecha">
          </div>
          <div class="field" style="flex: 0 0 80px;">
            <label>Edad</label>
            <input id="rxEdad" type="number" value="0">
          </div>
          <div class="field">
            <label>Pr√≥xima Cita</label>
            <input type="datetime-local" id="rxProximaCita">
          </div>
          <div class="field">
            <label>Especialista</label>
            <select id="rxEspecialista">
              <option value="FREDDY MENDOZA FERNANDEZ">FREDDY MENDOZA FERNANDEZ</option>
              <option value="GLORIA ISABEL HUAMAN QUISPE">GLORIA ISABEL HUAMAN QUISPE</option>
              <option value="OTRO">OTRO</option>
            </select>
          </div>
        </div>
        <div class="row mt-1">
          <div class="field">
            <label>Prescripci√≥n</label>
            <div style="display: flex; gap: 15px; padding: 8px 0;">
              <label style="display: flex; align-items: center; gap: 5px; text-transform: none;">
                <input type="radio" name="rxTipo" value="PROPIA" checked> Propia
              </label>
              <label style="display: flex; align-items: center; gap: 5px; text-transform: none;">
                <input type="radio" name="rxTipo" value="EXTERNA"> Externa
              </label>
            </div>
          </div>
        </div>
      </div>

      <!-- ‚ú® SISTEMA DE PESTA√ëAS MODERNO ‚ú® -->
      <div style="background: white; border-bottom: 2px solid #e5e7eb; margin: 16px 16px 0 16px;">
        <div style="display: flex; gap: 0;">
          <button onclick="cambiarPestanaRX('prescripcion')" id="tabPrescripcion" style="flex: 1; padding: 16px 24px; border: none; background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%); color: white; font-weight: 700; font-size: 14px; cursor: pointer; border-radius: 12px 12px 0 0; transition: all 0.3s; box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);">
            üìã Prescripci√≥n de Lentes
          </button>
          <button onclick="cambiarPestanaRX('historial')" id="tabHistorial" style="flex: 1; padding: 16px 24px; border: none; background: #f3f4f6; color: #6b7280; font-weight: 600; font-size: 14px; cursor: pointer; border-radius: 12px 12px 0 0; transition: all 0.3s;">
            üìä Historial Cl√≠nico
          </button>
        </div>
      </div>

      <!-- Contenido con scroll vertical - CON PESTA√ëAS -->
      <div class="rx-fullscreen-content">

        <!-- ========== PESTA√ëA 1: PRESCRIPCI√ìN ========== -->
        <div id="contenidoPrescripcion" class="rx-tab-content">

          <!-- DISTANCIA (LEJOS) Y CERCA EN GRID -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: 12px;">
            <!-- DISTANCIA (LEJOS) -->
            <div class="card" style="padding: 20px;">
              <div style="background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%); color: white; padding: 12px; border-radius: 10px; margin-bottom: 14px; text-align: center; font-weight: 700; font-size: 13px;">
                üëÅÔ∏è DISTANCIA (LEJOS)
              </div>
              <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                <thead>
                  <tr style="background: #f3f4f6;">
                    <th style="padding: 6px; border: 1px solid #7c3aed; font-weight: 700; text-align: center;"></th>
                    <th style="padding: 6px; border: 1px solid #7c3aed; font-weight: 700; text-align: center;">ESF</th>
                    <th style="padding: 6px; border: 1px solid #7c3aed; font-weight: 700; text-align: center;">CIL</th>
                    <th style="padding: 6px; border: 1px solid #7c3aed; font-weight: 700; text-align: center;">EJE</th>
                    <th style="padding: 6px; border: 1px solid #7c3aed; font-weight: 700; text-align: center;">DIP</th>
                    <th style="padding: 6px; border: 1px solid #7c3aed; font-weight: 700; text-align: center;">A.V</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td style="padding: 4px; border: 1px solid #7c3aed; font-weight: 800; text-align: center; background: #f3f4f6; color: #7c3aed; font-size: 11px;">O.D.</td>
                    <td style="padding: 3px; border: 1px solid #7c3aed;"><input id="lejosOdEsf" oninput="validarCampoRX(this)" style="width: 100%; padding: 5px; border: 1px solid #cbd5e1; border-radius: 4px; text-align: center; font-weight: 600; font-size: 11px;" placeholder="0.00"></td>
                    <td style="padding: 3px; border: 1px solid #7c3aed;"><input id="lejosOdCil" oninput="validarCampoRX(this)" style="width: 100%; padding: 5px; border: 1px solid #cbd5e1; border-radius: 4px; text-align: center; font-weight: 600; font-size: 11px;" placeholder="0.00"></td>
                    <td style="padding: 3px; border: 1px solid #7c3aed;"><input id="lejosOdEje" oninput="validarCampoRX(this)" style="width: 100%; padding: 5px; border: 1px solid #cbd5e1; border-radius: 4px; text-align: center; font-weight: 600; font-size: 11px;" placeholder="0¬∞"></td>
                    <td style="padding: 3px; border: 1px solid #7c3aed;"><input id="lejosDip" oninput="validarCampoRX(this)" style="width: 100%; padding: 5px; border: 1px solid #cbd5e1; border-radius: 4px; text-align: center; font-weight: 600; font-size: 11px;" placeholder="0.0"></td>
                    <td style="padding: 3px; border: 1px solid #7c3aed;"><input id="lejosOdAv" value="20/" style="width: 100%; padding: 5px; border: 1px solid #cbd5e1; border-radius: 4px; text-align: center; font-weight: 600; font-size: 11px;"></td>
                  </tr>
                  <tr>
                    <td style="padding: 4px; border: 1px solid #7c3aed; font-weight: 800; text-align: center; background: #f3f4f6; color: #7c3aed; font-size: 11px;">O.I.</td>
                    <td style="padding: 3px; border: 1px solid #7c3aed;"><input id="lejosOiEsf" oninput="validarCampoRX(this)" style="width: 100%; padding: 5px; border: 1px solid #cbd5e1; border-radius: 4px; text-align: center; font-weight: 600; font-size: 11px;" placeholder="0.00"></td>
                    <td style="padding: 3px; border: 1px solid #7c3aed;"><input id="lejosOiCil" oninput="validarCampoRX(this)" style="width: 100%; padding: 5px; border: 1px solid #cbd5e1; border-radius: 4px; text-align: center; font-weight: 600; font-size: 11px;" placeholder="0.00"></td>
                    <td style="padding: 3px; border: 1px solid #7c3aed;"><input id="lejosOiEje" oninput="validarCampoRX(this)" style="width: 100%; padding: 5px; border: 1px solid #cbd5e1; border-radius: 4px; text-align: center; font-weight: 600; font-size: 11px;" placeholder="0¬∞"></td>
                    <td style="padding: 3px; border: 1px solid #7c3aed;"><input id="lejosDipOi" disabled style="width: 100%; padding: 5px; border: 1px solid #cbd5e1; border-radius: 4px; text-align: center; background: #f3f4f6; font-size: 11px;"></td>
                    <td style="padding: 3px; border: 1px solid #7c3aed;"><input id="lejosOiAv" value="20/" style="width: 100%; padding: 5px; border: 1px solid #cbd5e1; border-radius: 4px; text-align: center; font-weight: 600; font-size: 11px;"></td>
                  </tr>
                </tbody>
              </table>
              <!-- Campos ocultos para compatibilidad -->
              <input type="hidden" id="lejosOdNp"><input type="hidden" id="lejosOdPrisma"><input type="hidden" id="lejosOdAdd"><input type="hidden" id="lejosOdAddMedia">
              <input type="hidden" id="lejosOiNp"><input type="hidden" id="lejosOiPrisma"><input type="hidden" id="lejosOiAdd"><input type="hidden" id="lejosOiAddMedia">
            </div>

            <!-- CERCA -->
            <div class="card" style="padding: 20px;">
              <div style="background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%); color: white; padding: 12px; border-radius: 10px; margin-bottom: 14px; text-align: center; font-weight: 700; font-size: 13px;">
                üìñ CERCA
              </div>
              <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                <thead>
                  <tr style="background: #f3f4f6;">
                    <th style="padding: 6px; border: 1px solid #7c3aed; font-weight: 700; text-align: center;"></th>
                    <th style="padding: 6px; border: 1px solid #7c3aed; font-weight: 700; text-align: center;">ESF</th>
                    <th style="padding: 6px; border: 1px solid #7c3aed; font-weight: 700; text-align: center;">CIL</th>
                    <th style="padding: 6px; border: 1px solid #7c3aed; font-weight: 700; text-align: center;">EJE</th>
                    <th style="padding: 6px; border: 1px solid #7c3aed; font-weight: 700; text-align: center;">DIP</th>
                    <th style="padding: 6px; border: 1px solid #7c3aed; font-weight: 700; text-align: center;">A.V</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td style="padding: 4px; border: 1px solid #7c3aed; font-weight: 800; text-align: center; background: #f3f4f6; color: #7c3aed; font-size: 11px;">O.D.</td>
                    <td style="padding: 3px; border: 1px solid #7c3aed;"><input id="cercaOdEsf" oninput="validarCampoRX(this)" style="width: 100%; padding: 5px; border: 1px solid #cbd5e1; border-radius: 4px; text-align: center; font-weight: 600; font-size: 11px;" placeholder="0.00"></td>
                    <td style="padding: 3px; border: 1px solid #7c3aed;"><input id="cercaOdCil" oninput="validarCampoRX(this)" style="width: 100%; padding: 5px; border: 1px solid #cbd5e1; border-radius: 4px; text-align: center; font-weight: 600; font-size: 11px;" placeholder="0.00"></td>
                    <td style="padding: 3px; border: 1px solid #7c3aed;"><input id="cercaOdEje" oninput="validarCampoRX(this)" onblur="normalizarEje(this)" style="width: 100%; padding: 5px; border: 1px solid #cbd5e1; border-radius: 4px; text-align: center; font-weight: 600; font-size: 11px;" placeholder="0¬∞"></td>
                    <td style="padding: 3px; border: 1px solid #7c3aed;"><input id="cercaDip" oninput="validarCampoRX(this)" style="width: 100%; padding: 5px; border: 1px solid #cbd5e1; border-radius: 4px; text-align: center; font-weight: 600; font-size: 11px;" placeholder="0.0"></td>
                    <td style="padding: 3px; border: 1px solid #7c3aed;"><input id="cercaOdAv" value="20/" style="width: 100%; padding: 5px; border: 1px solid #cbd5e1; border-radius: 4px; text-align: center; font-weight: 600; font-size: 11px;"></td>
                  </tr>
                  <tr>
                    <td style="padding: 4px; border: 1px solid #7c3aed; font-weight: 800; text-align: center; background: #f3f4f6; color: #7c3aed; font-size: 11px;">O.I.</td>
                    <td style="padding: 3px; border: 1px solid #7c3aed;"><input id="cercaOiEsf" oninput="validarCampoRX(this)" style="width: 100%; padding: 5px; border: 1px solid #cbd5e1; border-radius: 4px; text-align: center; font-weight: 600; font-size: 11px;" placeholder="0.00"></td>
                    <td style="padding: 3px; border: 1px solid #7c3aed;"><input id="cercaOiCil" oninput="validarCampoRX(this)" style="width: 100%; padding: 5px; border: 1px solid #cbd5e1; border-radius: 4px; text-align: center; font-weight: 600; font-size: 11px;" placeholder="0.00"></td>
                    <td style="padding: 3px; border: 1px solid #7c3aed;"><input id="cercaOiEje" oninput="validarCampoRX(this)" onblur="normalizarEje(this)" style="width: 100%; padding: 5px; border: 1px solid #cbd5e1; border-radius: 4px; text-align: center; font-weight: 600; font-size: 11px;" placeholder="0¬∞"></td>
                    <td style="padding: 3px; border: 1px solid #7c3aed;"><input id="cercaDipOi" disabled style="width: 100%; padding: 5px; border: 1px solid #cbd5e1; border-radius: 4px; text-align: center; background: #f3f4f6; font-size: 11px;"></td>
                    <td style="padding: 3px; border: 1px solid #7c3aed;"><input id="cercaOiAv" value="20/" style="width: 100%; padding: 5px; border: 1px solid #cbd5e1; border-radius: 4px; text-align: center; font-weight: 600; font-size: 11px;"></td>
                  </tr>
                </tbody>
              </table>
              <!-- Campos ocultos para compatibilidad -->
              <input type="hidden" id="cercaOdNp"><input type="hidden" id="cercaOdPrisma"><input type="hidden" id="cercaAltura">
              <input type="hidden" id="cercaOiNp"><input type="hidden" id="cercaOiPrisma"><input type="hidden" id="cercaAlturaOi">
            </div>
          </div>

          <!-- PRESI√ìN INTRAOCULAR (PIO) -->
          <div class="card" style="margin: 16px;">
            <div class="card-title" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; margin: -24px -24px 20px -24px; padding: 14px 20px; border-radius: 14px 14px 0 0;">
              üìä PRESI√ìN INTRAOCULAR
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
              <div>
                <label style="display: block; font-weight: 700; margin-bottom: 8px; color: #059669;">PIO OD (mmHg)</label>
                <input id="oftTonoOd" oninput="validarCampoRX(this)" type="number" placeholder="Ej: 15" style="width: 100%; padding: 14px; border: 2px solid #10b981; border-radius: 8px; font-size: 16px; font-weight: 600; text-align: center;">
              </div>
              <div>
                <label style="display: block; font-weight: 700; margin-bottom: 8px; color: #059669;">PIO OI (mmHg)</label>
                <input id="oftTonoOi" oninput="validarCampoRX(this)" type="number" placeholder="Ej: 14" style="width: 100%; padding: 14px; border: 2px solid #10b981; border-radius: 8px; font-size: 16px; font-weight: 600; text-align: center;">
              </div>
            </div>
          </div>

          <!-- DIAGN√ìSTICO -->
          <div class="card" style="margin: 16px;">
            <div class="card-title" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; margin: -24px -24px 20px -24px; padding: 14px 20px; border-radius: 14px 14px 0 0;">
              ü©∫ DIAGN√ìSTICO
            </div>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; padding: 8px;">
              <label style="display: flex; align-items: center; gap: 10px; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='#fef2f2'; this.style.borderColor='#ef4444'" onmouseout="this.style.background='white'; this.style.borderColor='#e5e7eb'">
                <input type="checkbox" id="diagMiopia" style="width: 20px; height: 20px; cursor: pointer; accent-color: #ef4444;">
                <span style="font-weight: 600; font-size: 14px;">Miop√≠a</span>
              </label>
              <label style="display: flex; align-items: center; gap: 10px; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='#fef2f2'; this.style.borderColor='#ef4444'" onmouseout="this.style.background='white'; this.style.borderColor='#e5e7eb'">
                <input type="checkbox" id="diagHipermetropia" style="width: 20px; height: 20px; cursor: pointer; accent-color: #ef4444;">
                <span style="font-weight: 600; font-size: 14px;">Hipermetrop√≠a</span>
              </label>
              <label style="display: flex; align-items: center; gap: 10px; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='#fef2f2'; this.style.borderColor='#ef4444'" onmouseout="this.style.background='white'; this.style.borderColor='#e5e7eb'">
                <input type="checkbox" id="diagAstigmatismo" style="width: 20px; height: 20px; cursor: pointer; accent-color: #ef4444;">
                <span style="font-weight: 600; font-size: 14px;">Astigmatismo</span>
              </label>
              <label style="display: flex; align-items: center; gap: 10px; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='#fef2f2'; this.style.borderColor='#ef4444'" onmouseout="this.style.background='white'; this.style.borderColor='#e5e7eb'">
                <input type="checkbox" id="diagPresbicia" style="width: 20px; height: 20px; cursor: pointer; accent-color: #ef4444;">
                <span style="font-weight: 600; font-size: 14px;">Presbicia</span>
              </label>
              <label style="display: flex; align-items: center; gap: 10px; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='#fef2f2'; this.style.borderColor='#ef4444'" onmouseout="this.style.background='white'; this.style.borderColor='#e5e7eb'">
                <input type="checkbox" id="diagAmbliopia" style="width: 20px; height: 20px; cursor: pointer; accent-color: #ef4444;">
                <span style="font-weight: 600; font-size: 14px;">Ambliop√≠a</span>
              </label>
              <label style="display: flex; align-items: center; gap: 10px; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='#fef2f2'; this.style.borderColor='#ef4444'" onmouseout="this.style.background='white'; this.style.borderColor='#e5e7eb'">
                <input type="checkbox" id="diagAnisometropia" style="width: 20px; height: 20px; cursor: pointer; accent-color: #ef4444;">
                <span style="font-weight: 600; font-size: 14px;">Anisometrop√≠a</span>
              </label>
            </div>
          </div>

          <!-- OBSERVACIONES -->
          <div class="card" style="margin: 16px;">
            <label style="font-weight: 700; font-size: 14px; margin-bottom: 8px; display: block;">üìù Observaciones</label>
            <textarea id="rxObservacion" rows="3" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;" placeholder="Observaciones adicionales..."></textarea>
          </div>

          <!-- Campos ocultos de INTERMEDIA para compatibilidad -->
          <input type="hidden" id="interOdEsf"><input type="hidden" id="interOdCil"><input type="hidden" id="interOdEje"><input type="hidden" id="interOdAv" value="20/">
          <input type="hidden" id="interDip"><input type="hidden" id="interOdNp"><input type="hidden" id="interOdPrisma"><input type="hidden" id="interDtra">
          <input type="hidden" id="interOiEsf"><input type="hidden" id="interOiCil"><input type="hidden" id="interOiEje"><input type="hidden" id="interOiAv" value="20/">
          <input type="hidden" id="interDipOi"><input type="hidden" id="interOiNp"><input type="hidden" id="interOiPrisma"><input type="hidden" id="interDtraOi">

        </div>
        <!-- FIN PESTA√ëA 1 -->

        <!-- ========== PESTA√ëA 2: HISTORIAL CL√çNICO ========== -->
        <div id="contenidoHistorial" class="rx-tab-content" style="display: none;">

          <!-- ANAMNESIS -->
          <div class="card" style="margin: 16px;">
            <div class="card-title" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; margin: -24px -24px 20px -24px; padding: 14px 20px; border-radius: 14px 14px 0 0;">
              üìã ANAMNESIS
            </div>
            <div style="display: grid; gap: 16px;">
              <div>
                <label style="font-weight: 700; font-size: 14px; margin-bottom: 8px; display: block;">1.- S√≠ntomas Principales</label>
                <textarea id="histSintomas" rows="3" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;" placeholder="Describa los s√≠ntomas principales del paciente..."></textarea>
              </div>
              <div>
                <label style="font-weight: 700; font-size: 14px; margin-bottom: 8px; display: block;">2.- Antecedentes Personales y Familiares</label>
                <textarea id="histAntecedentes" rows="3" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;" placeholder="Antecedentes m√©dicos relevantes..."></textarea>
              </div>
              <div>
                <label style="font-weight: 700; font-size: 14px; margin-bottom: 8px; display: block;">Examen Oftalmol√≥gico</label>
                <textarea id="histExamen" rows="3" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;" placeholder="Resultados del examen oftalmol√≥gico..."></textarea>
              </div>
            </div>
          </div>

          <!-- LENTES DE CONTACTO -->
          <div class="card" style="margin: 16px;">
            <div class="card-title" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; margin: -24px -24px 20px -24px; padding: 14px 20px; border-radius: 14px 14px 0 0;">
              üîç LENTES DE CONTACTO
            </div>
            <table style="width: 100%; border-collapse: collapse; margin-bottom: 16px;">
              <thead>
                <tr style="background: #f3f4f6;">
                  <th style="padding: 10px; border: 2px solid #10b981; font-weight: 700; text-align: center; width: 80px;"></th>
                  <th style="padding: 10px; border: 2px solid #10b981; font-weight: 700; text-align: center;">H</th>
                  <th style="padding: 10px; border: 2px solid #10b981; font-weight: 700; text-align: center;">V</th>
                  <th style="padding: 10px; border: 2px solid #10b981; font-weight: 700; text-align: center;">EJE</th>
                  <th style="padding: 10px; border: 2px solid #10b981; font-weight: 700; text-align: center;">CB</th>
                  <th style="padding: 10px; border: 2px solid #10b981; font-weight: 700; text-align: center;">PODER</th>
                  <th style="padding: 10px; border: 2px solid #10b981; font-weight: 700; text-align: center;">DI√ÅMETRO</th>
                  <th style="padding: 10px; border: 2px solid #10b981; font-weight: 700; text-align: center;">CONTACTO</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td style="padding: 8px; border: 2px solid #10b981; font-weight: 800; text-align: center; background: #f3f4f6; color: #059669;">O.D.</td>
                  <td style="padding: 6px; border: 2px solid #10b981;"><input id="lcOdH" style="width: 100%; padding: 8px; border: 2px solid #cbd5e1; border-radius: 6px; text-align: center;"></td>
                  <td style="padding: 6px; border: 2px solid #10b981;"><input id="lcOdV" style="width: 100%; padding: 8px; border: 2px solid #cbd5e1; border-radius: 6px; text-align: center;"></td>
                  <td style="padding: 6px; border: 2px solid #10b981;"><input id="lcOdEje" style="width: 100%; padding: 8px; border: 2px solid #cbd5e1; border-radius: 6px; text-align: center;"></td>
                  <td style="padding: 6px; border: 2px solid #10b981;"><input id="lcOdCb" style="width: 100%; padding: 8px; border: 2px solid #cbd5e1; border-radius: 6px; text-align: center;"></td>
                  <td style="padding: 6px; border: 2px solid #10b981;"><input id="lcOdPoder" style="width: 100%; padding: 8px; border: 2px solid #cbd5e1; border-radius: 6px; text-align: center;"></td>
                  <td style="padding: 6px; border: 2px solid #10b981;"><input id="lcOdDiametro" style="width: 100%; padding: 8px; border: 2px solid #cbd5e1; border-radius: 6px; text-align: center;"></td>
                  <td style="padding: 6px; border: 2px solid #10b981;"><input id="lcOdContacto" style="width: 100%; padding: 8px; border: 2px solid #cbd5e1; border-radius: 6px; text-align: center;"></td>
                </tr>
                <tr>
                  <td style="padding: 8px; border: 2px solid #10b981; font-weight: 800; text-align: center; background: #f3f4f6; color: #059669;">O.I.</td>
                  <td style="padding: 6px; border: 2px solid #10b981;"><input id="lcOiH" style="width: 100%; padding: 8px; border: 2px solid #cbd5e1; border-radius: 6px; text-align: center;"></td>
                  <td style="padding: 6px; border: 2px solid #10b981;"><input id="lcOiV" style="width: 100%; padding: 8px; border: 2px solid #cbd5e1; border-radius: 6px; text-align: center;"></td>
                  <td style="padding: 6px; border: 2px solid #10b981;"><input id="lcOiEje" style="width: 100%; padding: 8px; border: 2px solid #cbd5e1; border-radius: 6px; text-align: center;"></td>
                  <td style="padding: 6px; border: 2px solid #10b981;"><input id="lcOiCb" style="width: 100%; padding: 8px; border: 2px solid #cbd5e1; border-radius: 6px; text-align: center;"></td>
                  <td style="padding: 6px; border: 2px solid #10b981;"><input id="lcOiPoder" style="width: 100%; padding: 8px; border: 2px solid #cbd5e1; border-radius: 6px; text-align: center;"></td>
                  <td style="padding: 6px; border: 2px solid #10b981;"><input id="lcOiDiametro" style="width: 100%; padding: 8px; border: 2px solid #cbd5e1; border-radius: 6px; text-align: center;"></td>
                  <td style="padding: 6px; border: 2px solid #10b981;"><input id="lcOiContacto" style="width: 100%; padding: 8px; border: 2px solid #cbd5e1; border-radius: 6px; text-align: center;"></td>
                </tr>
              </tbody>
            </table>
            <div style="margin-top: 16px;">
              <label style="font-weight: 700; font-size: 14px; margin-bottom: 8px; display: block;">Tipo de Lente de Contacto</label>
              <textarea id="lcTipoLente" rows="2" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;" placeholder="Especifique el tipo de lente de contacto..."></textarea>
            </div>
            <div style="margin-top: 16px;">
              <label style="font-weight: 700; font-size: 14px; margin-bottom: 8px; display: block;">L√°mpara de Hendidura o Biomicroscopio</label>
              <textarea id="lcBiomicroscopio" rows="2" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;" placeholder="Observaciones del biomicroscopio..."></textarea>
            </div>
          </div>

          <!-- ESPECIFICACIONES ADICIONALES -->
          <div class="card" style="margin: 16px;">
            <div class="card-title" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; margin: -24px -24px 20px -24px; padding: 14px 20px; border-radius: 14px 14px 0 0;">
              ‚öôÔ∏è ESPECIFICACIONES ADICIONALES
            </div>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 16px;">
              <div>
                <label style="font-weight: 700; font-size: 14px; margin-bottom: 8px; display: block;">Tipo de Lente</label>
                <select id="otrosTipoLente" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                  <option value="">Seleccionar...</option>
                  <option value="MONOFOCAL">Monofocal</option>
                  <option value="BIFOCAL">Bifocal</option>
                  <option value="PROGRESIVO">Progresivo</option>
                </select>
              </div>
              <div>
                <label style="font-weight: 700; font-size: 14px; margin-bottom: 8px; display: block;">Material</label>
                <select id="otrosMaterial" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                  <option value="">Seleccionar...</option>
                  <option value="CR39">CR-39</option>
                  <option value="POLICARBONATO">Policarbonato</option>
                  <option value="TRIVEX">Trivex</option>
                  <option value="ALTO_INDICE">Alto √≠ndice</option>
                </select>
              </div>
              <div>
                <label style="font-weight: 700; font-size: 14px; margin-bottom: 8px; display: block;">Tratamiento</label>
                <select id="otrosTratamiento" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                  <option value="">Seleccionar...</option>
                  <option value="ANTIRREFLEJO">Antirreflejo</option>
                  <option value="FOTOCROMATICO">Fotocrom√°tico</option>
                  <option value="BLUE_DEFENSE">Blue Defense</option>
                  <option value="TRANSITIONS">Transitions</option>
                </select>
              </div>
            </div>
            <div>
              <label style="font-weight: 700; font-size: 14px; margin-bottom: 8px; display: block;">Notas Adicionales</label>
              <textarea id="otrosNotas" rows="3" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;" placeholder="Notas adicionales sobre las especificaciones..."></textarea>
            </div>
          </div>

          <!-- PRESCRIPCIONES ANTERIORES -->
          <div class="card" style="margin: 16px;">
            <div class="card-title" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; margin: -24px -24px 20px -24px; padding: 14px 20px; border-radius: 14px 14px 0 0;">
              üìú PRESCRIPCIONES ANTERIORES
            </div>
            <table style="width: 100%; border-collapse: collapse;">
              <thead>
                <tr style="background: #f3f4f6;">
                  <th style="padding: 12px; border: 2px solid #8b5cf6; font-weight: 700;">C√≥digo</th>
                  <th style="padding: 12px; border: 2px solid #8b5cf6; font-weight: 700;">Especialista</th>
                  <th style="padding: 12px; border: 2px solid #8b5cf6; font-weight: 700;">Fecha</th>
                  <th style="padding: 12px; border: 2px solid #8b5cf6; font-weight: 700;">Lugar</th>
                  <th style="padding: 12px; border: 2px solid #8b5cf6; font-weight: 700; text-align: center;">Acciones</th>
                </tr>
              </thead>
              <tbody id="historialRxBody"></tbody>
            </table>
            <div id="noHistorialRx" style="text-align: center; padding: 40px; color: #9ca3af; font-size: 14px;">
              üìã No hay prescripciones anteriores registradas
            </div>
          </div>

          <!-- ‚ú® TONOMETR√çA Y OFTALMOLOG√çA ‚ú® -->
          <div class="card" style="margin: 16px;">
            <div class="card-title" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; margin: -24px -24px 20px -24px; padding: 14px 20px; border-radius: 14px 14px 0 0;">
              üìä TONOMETR√çA
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr 2fr; gap: 20px; padding: 8px;">
              <div style="background: linear-gradient(135deg, #dbeafe, #bfdbfe); padding: 20px; border-radius: 12px; border: 2px solid #3b82f6; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.2);">
                <label style="display: block; font-weight: 800; margin-bottom: 10px; color: #1e40af; font-size: 14px; text-align: center;">üîµ TONO O.D (mmHg)</label>
                <input id="oftTonoOd" type="number" placeholder="Ej: 15" style="width: 100%; padding: 14px; border: 2px solid #3b82f6; border-radius: 10px; font-size: 18px; font-weight: 700; text-align: center; background: white; color: #1e40af; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);">
              </div>
              <div style="background: linear-gradient(135deg, #dbeafe, #bfdbfe); padding: 20px; border-radius: 12px; border: 2px solid #3b82f6; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.2);">
                <label style="display: block; font-weight: 800; margin-bottom: 10px; color: #1e40af; font-size: 14px; text-align: center;">üîµ TONO O.I (mmHg)</label>
                <input id="oftTonoOi" type="number" placeholder="Ej: 14" style="width: 100%; padding: 14px; border: 2px solid #3b82f6; border-radius: 10px; font-size: 18px; font-weight: 700; text-align: center; background: white; color: #1e40af; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);">
              </div>
              <div style="background: linear-gradient(135deg, #f0fdf4, #dcfce7); padding: 20px; border-radius: 12px; border: 2px solid #10b981; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.2);">
                <label style="display: block; font-weight: 800; margin-bottom: 10px; color: #065f46; font-size: 14px;">üìã C√≥digo CIE 10</label>
                <select id="oftCie10" style="width: 100%; padding: 14px; border: 2px solid #10b981; border-radius: 10px; font-size: 13px; font-weight: 600; background: white; color: #065f46; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);">
                  <option value="">Seleccionar diagn√≥stico...</option>
                  <option value="H52.0">H52.0 - Hipermetrop√≠a</option>
                  <option value="H52.1">H52.1 - Miop√≠a</option>
                  <option value="H52.2">H52.2 - Astigmatismo</option>
                  <option value="H52.4">H52.4 - Presbicia</option>
                </select>
              </div>
            </div>
          </div>

          <!-- OFTALMOLOG√çA - TRATAMIENTO -->
          <div class="card" style="margin: 16px;">
            <div class="card-title" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; margin: -24px -24px 20px -24px; padding: 14px 20px; border-radius: 14px 14px 0 0;">
              üíä TRATAMIENTO Y RECOMENDACIONES
            </div>
            <div style="display: grid; gap: 16px;">
              <div>
                <label style="font-weight: 700; font-size: 14px; margin-bottom: 8px; display: block;">Plan de Tratamiento</label>
                <textarea id="oftTratamiento" rows="3" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;" placeholder="Indique el plan de tratamiento recomendado..."></textarea>
              </div>
              <div>
                <label style="font-weight: 700; font-size: 14px; margin-bottom: 8px; display: block;">Otros Ex√°menes</label>
                <textarea id="oftOtrosExamenes" rows="2" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;" placeholder="Otros ex√°menes realizados o solicitados..."></textarea>
              </div>
            </div>
          </div>

        </div>
        <!-- FIN PESTA√ëA 2 -->

      </div>

      <!-- Toolbar -->
      <div class="rx-toolbar">
        <button class="btn btn-success" onclick="guardarPrescripcion()">üíæ Guardar</button>
        <button class="btn btn-info" onclick="imprimirPrescripcion()">üñ®Ô∏è Imprimir</button>
        <button class="btn btn-warning" onclick="exportarPrescripcionExcel()">üìä Excel</button>
        <div style="flex: 1;"></div>
        <button class="btn btn-danger" onclick="cerrarPrescripcion()">üö™ Salir</button>
      </div>
    </div>
    <input type="hidden" id="rxIdHidden">
    <input type="hidden" id="rxClienteIdHidden">
  </div>

</div>

<!-- ===== MODALES ===== -->

<!-- Modal Cliente -->
<dialog id="clienteModal">
  <div class="modal-header">
    <strong id="clienteModalTitulo">Nuevo Cliente</strong>
    <button class="btn btn-sm" style="background: transparent; color: white; font-size: 20px;" onclick="cerrarModal('clienteModal')">√ó</button>
  </div>
  <div class="modal-body">
    <div class="card" style="background: var(--purple-50); margin-bottom: 15px;">
      <div class="card-title" style="border-color: var(--purple-400); color: var(--purple-700);">üìã Datos del Cliente</div>
      <div class="row">
        <div class="field">
          <label>Tipo</label>
          <select id="cliTipo">
            <option value="PN">PERSONA NATURAL</option>
            <option value="PJ">PERSONA JUR√çDICA</option>
          </select>
        </div>
        <div class="field">
          <label>DNI / RUC</label>
          <input id="cliDocumento" maxlength="11">
        </div>
      </div>
      <div class="row mt-2">
        <div class="field" style="flex: 1;">
          <label>Nombres</label>
          <input id="cliNombres">
        </div>
      </div>
      <div class="row mt-2">
        <div class="field">
          <label>Tel√©fono / Celular</label>
          <input id="cliTelefono">
        </div>
        <div class="field">
          <label>Fecha Nacimiento</label>
          <input type="date" id="cliFechaNac" onchange="calcularEdad()">
        </div>
        <div class="field" style="flex: 0 0 80px;">
          <label>Edad</label>
          <input id="cliEdad" type="number" readonly style="color: #16a34a;">
        </div>
      </div>
      <div class="row mt-2">
        <div class="field">
          <label>Email</label>
          <input id="cliEmail" type="email">
        </div>
        <div class="field">
          <label>Ocupaci√≥n</label>
          <input id="cliOcupacion">
        </div>
      </div>
      <div class="row mt-2">
        <div class="field" style="flex: 1;">
          <label>Direcci√≥n</label>
          <input id="cliDireccion">
        </div>
      </div>
      <div class="row mt-2">
        <div class="field">
          <label>Sexo</label>
          <select id="cliSexo">
            <option value="">-</option>
            <option value="M">MASCULINO</option>
            <option value="F">FEMENINO</option>
          </select>
        </div>
        <div class="field">
          <label>Estado</label>
          <select id="cliEstado">
            <option value="H">HABILITADO</option>
            <option value="D">DESHABILITADO</option>
          </select>
        </div>
      </div>
    </div>
    <input type="hidden" id="cliIdHidden">
  </div>
  <div class="modal-footer">
    <button class="btn btn-success" onclick="guardarCliente()">üíæ Guardar</button>
    <button class="btn btn-danger" onclick="cerrarModal('clienteModal')">üö™ Salir</button>
  </div>
</dialog>

<!-- Modal Producto -->
<dialog id="itemModal">
  <div class="modal-header">
    <strong id="itemModalTitulo">Agregar Producto</strong>
    <button class="btn btn-sm" style="background: transparent; color: white; font-size: 20px;" onclick="cerrarModal('itemModal')">√ó</button>
  </div>
  <div class="modal-body">
    <div class="row">
      <div class="field" style="flex: 1;">
        <label>Descripci√≥n</label>
        <input id="itemDescripcion" placeholder="Lente, montura, servicio, etc.">
      </div>
    </div>
    <div class="row mt-2">
      <div class="field">
        <label>Cantidad</label>
        <input type="number" id="itemCantidad" value="1" min="1">
      </div>
      <div class="field">
        <label>Precio Unitario</label>
        <input type="number" id="itemPrecio" value="0" step="0.01">
      </div>
      <div class="field">
        <label>Descuento</label>
        <input type="number" id="itemDescuento" value="0" step="0.01">
      </div>
    </div>
    <input type="hidden" id="itemIndexEdit">
  </div>
  <div class="modal-footer">
    <button class="btn btn-secondary" onclick="cerrarModal('itemModal')">Cancelar</button>
    <button class="btn btn-success" onclick="guardarItem()">üíæ Agregar</button>
  </div>
</dialog>

<!-- Modal Detalle Venta -->
<dialog id="detalleVentaModal" style="max-width: 600px;">
  <div class="modal-header">
    <strong>üìã Detalle de Venta</strong>
    <button class="btn btn-sm" style="background: transparent; color: white; font-size: 20px;" onclick="cerrarModal('detalleVentaModal')">√ó</button>
  </div>
  <div class="modal-body" id="detalleVentaContenido"></div>
  <div class="modal-footer">
    <button class="btn btn-secondary" onclick="imprimirDetalleVenta()">üñ®Ô∏è Imprimir</button>
    <button class="btn btn-primary" onclick="cerrarModal('detalleVentaModal')">Cerrar</button>
  </div>
</dialog>

<!-- Modal Estado Entrega -->
<dialog id="estadoEntregaModal" style="max-width: 400px;">
  <div class="modal-header">
    <strong>üì¶ Cambiar Estado de Entrega</strong>
    <button class="btn btn-sm" style="background: transparent; color: white; font-size: 20px;" onclick="cerrarModal('estadoEntregaModal')">√ó</button>
  </div>
  <div class="modal-body">
    <div class="field">
      <label>Nuevo Estado</label>
      <select id="nuevoEstadoEntrega">
        <option value="PENDIENTE">PENDIENTE</option>
        <option value="ENTREGADO">ENTREGADO</option>
      </select>
    </div>
  </div>
  <div class="modal-footer">
    <button class="btn btn-secondary" onclick="cerrarModal('estadoEntregaModal')">Cancelar</button>
    <button class="btn btn-success" onclick="confirmarCambioEstado()">‚úì Confirmar</button>
  </div>
</dialog>

<!-- Modal Cat√°logo de Productos -->
<dialog id="catalogoModal" style="max-width: 750px;">
  <div class="modal-header" style="background: linear-gradient(180deg, #0ea5e9 0%, #0284c7 100%);">
    <strong>üì¶ Cat√°logo de Productos</strong>
    <button class="btn btn-sm" style="background: transparent; color: white; font-size: 20px;" onclick="cerrarModal('catalogoModal')">√ó</button>
  </div>
  <div class="modal-body">
    <div class="categoria-tabs">
      <button class="cat-btn-modal active" data-catm="TODOS">Todos</button>
      <button class="cat-btn-modal" data-catm="LUNAS">üîµ Lunas</button>
      <button class="cat-btn-modal" data-catm="MONTURAS">üëì Monturas</button>
      <button class="cat-btn-modal" data-catm="LCONTACTO">üîò L. Contacto</button>
      <button class="cat-btn-modal" data-catm="ACCESORIOS">üéÅ Accesorios</button>
    </div>
    <div id="catalogoGrid" class="catalogo-grid"></div>
    <div class="row mt-2">
      <div class="field">
        <label>Cantidad</label>
        <input type="number" id="catCantidad" value="1" min="1">
      </div>
      <div class="field">
        <label>Descuento</label>
        <input type="number" id="catDescuento" value="0" step="0.01">
      </div>
    </div>
  </div>
  <div class="modal-footer">
    <button class="btn btn-secondary" onclick="cerrarModal('catalogoModal')">Cancelar</button>
    <button class="btn btn-success" onclick="agregarProductoSeleccionado()">‚úì Agregar a Venta</button>
  </div>
</dialog>

<!-- Modal Nuevo Producto -->
<dialog id="nuevoProductoModal" style="max-width: 600px;">
  <div class="modal-header" style="background: linear-gradient(180deg, #22c55e 0%, #16a34a 100%);">
    <strong id="productoModalTitulo">Nuevo Producto</strong>
    <button class="btn btn-sm" style="background: transparent; color: white; font-size: 20px;" onclick="cerrarModal('nuevoProductoModal')">√ó</button>
  </div>
  <div class="modal-body">
    <div style="display: flex; gap: 16px;">
      <!-- Columna izquierda: Preview imagen -->
      <div style="flex: 0 0 120px;">
        <label style="display: block; margin-bottom: 5px;">Vista Previa</label>
        <div id="prodImagenPreview" style="width: 120px; height: 120px; border: 2px dashed #d4d4d8; border-radius: 12px; display: flex; align-items: center; justify-content: center; background: #fafafa; font-size: 40px; color: #a1a1aa;">
          üì¶
        </div>
      </div>
      <!-- Columna derecha: Datos -->
      <div style="flex: 1;">
        <div class="row">
          <div class="field">
            <label>Categor√≠a</label>
            <select id="prodCategoria" onchange="actualizarPreviewCategoria()">
              <option value="LUNAS">üîµ Lunas</option>
              <option value="MONTURAS">üëì Monturas</option>
              <option value="LCONTACTO">üîò L. Contacto</option>
              <option value="ACCESORIOS">üéÅ Accesorios</option>
              <option value="SERVICIOS">üîß Servicios</option>
            </select>
          </div>
          <div class="field" style="flex: 2;">
            <label>Nombre del Producto</label>
            <input id="prodNombre" placeholder="Nombre del producto">
          </div>
        </div>
        <div class="row mt-1">
          <div class="field">
            <label>C√≥digo</label>
            <input id="prodCodigo" placeholder="AUTO" readonly style="background: #f4f4f5;">
          </div>
          <div class="field">
            <label>Precio (S/)</label>
            <input type="number" id="prodPrecio" value="0" step="0.01">
          </div>
          <div class="field">
            <label>Costo (S/)</label>
            <input type="number" id="prodCosto" value="0" step="0.01">
          </div>
        </div>
      </div>
    </div>
    <div class="row mt-2">
      <div class="field">
        <label>Stock Actual</label>
        <input type="number" id="prodStock" value="0" min="0">
      </div>
      <div class="field">
        <label>Stock M√≠nimo</label>
        <input type="number" id="prodStockMin" value="5" min="0">
      </div>
      <div class="field" style="flex: 2;">
        <label>URL Imagen (Opcional)</label>
        <input id="prodImagen" placeholder="https://..." oninput="actualizarPreviewImagen()">
      </div>
    </div>
    <div class="row mt-2">
      <div class="field" style="flex: 1;">
        <label>Descripci√≥n</label>
        <textarea id="prodDescripcion" rows="2" placeholder="Descripci√≥n detallada del producto..."></textarea>
      </div>
    </div>
    <input type="hidden" id="prodIdHidden">
  </div>
  <div class="modal-footer">
    <button class="btn btn-secondary" onclick="cerrarModal('nuevoProductoModal')">Cancelar</button>
    <button class="btn btn-success" onclick="guardarProducto()">üíæ Guardar Producto</button>
  </div>
</dialog>

<!-- Modal Tipo de Foco -->
<dialog id="tipoFocoModal" style="max-width: 450px;">
  <div class="modal-header" style="background: linear-gradient(180deg, #0ea5e9 0%, #0284c7 100%);">
    <strong id="tipoFocoModalTitulo">Registrar Tipo de Foco</strong>
    <button class="btn btn-sm" style="background: transparent; color: white; font-size: 20px;" onclick="cerrarModal('tipoFocoModal')">√ó</button>
  </div>
  <div class="modal-body">
    <div class="row">
      <div class="field">
        <label>Categor√≠a</label>
        <select id="tipoFocoCategoria">
          <option value="TIPO_FOCO">Tipo de Foco</option>
          <option value="MATERIAL">Material</option>
          <option value="SERVICIO">Servicio</option>
          <option value="TRATAMIENTO">Tratamiento</option>
          <option value="INDICE">√çndice</option>
          <option value="FILTROS">Filtros</option>
          <option value="TALLADO">Tallado</option>
          <option value="FOTOSENSIBLES">Lentes Fotosensibles</option>
        </select>
      </div>
    </div>
    <div class="row mt-2">
      <div class="field" style="flex: 2;">
        <label>Descripci√≥n</label>
        <input id="tipoFocoDescripcion" placeholder="Ej: BIFOCAL INVISIBLE">
      </div>
      <div class="field">
        <label>Abreviatura</label>
        <input id="tipoFocoAbrev" placeholder="Ej: BINV" maxlength="10">
      </div>
    </div>
    <input type="hidden" id="tipoFocoIdHidden">
  </div>
  <div class="modal-footer">
    <button class="btn btn-secondary" onclick="cerrarModal('tipoFocoModal')">Cancelar</button>
    <button class="btn btn-success" onclick="guardarTipoFoco()">üíæ Guardar</button>
  </div>
</dialog>

<!-- Modal Selector de Lunas -->
<dialog id="selectorLunasModal" style="max-width: 900px; width: 95%;">
  <div class="modal-header" style="background: linear-gradient(180deg, #0ea5e9 0%, #0284c7 100%);">
    <strong>üîµ Seleccionar Lunas</strong>
    <button class="btn btn-sm" style="background: transparent; color: white; font-size: 20px;" onclick="cerrarModal('selectorLunasModal')">√ó</button>
  </div>
  <div class="modal-body">
    <div class="selector-lunas-container">
      <!-- Panel Izquierdo - Categor√≠as -->
      <div class="selector-lunas-left">
        <h4>Lunas Disponibles</h4>
        <div class="selector-lunas-list" id="selectorLunasList"></div>
      </div>

      <!-- Panel Derecho - Medidas y Precio -->
      <div class="selector-lunas-right">
        <div class="selector-medidas-box">
          <h5>üìê Medidas del Paciente</h5>
          <div class="medidas-grid">
            <label></label>
            <label style="text-align: center;">Esf√©rico</label>
            <label style="text-align: center;">Cilindro</label>
            <label style="text-align: center;">Eje</label>
            <label style="text-align: center;">Adici√≥n</label>

            <label>OJO DER.</label>
            <input type="number" step="0.25" id="lunaOdEsf" placeholder="0.00" onchange="calcularPrecioLuna()">
            <input type="number" step="0.25" id="lunaOdCil" placeholder="0.00" onchange="calcularPrecioLuna()">
            <input type="number" id="lunaOdEje" placeholder="0">
            <input type="number" step="0.25" id="lunaOdAdd" placeholder="0.00">

            <label>OJO IZQ.</label>
            <input type="number" step="0.25" id="lunaOiEsf" placeholder="0.00" onchange="calcularPrecioLuna()">
            <input type="number" step="0.25" id="lunaOiCil" placeholder="0.00" onchange="calcularPrecioLuna()">
            <input type="number" id="lunaOiEje" placeholder="0">
            <input type="number" step="0.25" id="lunaOiAdd" placeholder="0.00">
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label>Tipo de Lente</label>
            <select id="lunaTipoLente" onchange="calcularPrecioLuna()">
              <option value="ESFERICO">Esf√©rico</option>
              <option value="COMBINADO">Combinado (Esf + Cil)</option>
              <option value="BIFOCAL">Bifocal</option>
              <option value="PROGRESIVO">Progresivo</option>
            </select>
          </div>
          <div class="field">
            <label>Material/Tratamiento</label>
            <select id="lunaMaterial" onchange="calcularPrecioLuna()">
              <option value="PHOTOMATIC">Photomatic AR Gris</option>
              <option value="POLY_AR">Poly Antireflex</option>
              <option value="POLY_BLUE">Poly Blue</option>
              <option value="LUX_BLUE">Lux Blue</option>
              <option value="DIPPIN">Dippin</option>
              <option value="CRISTAL_BLANCO">Cristal Blanco</option>
              <option value="CRISTAL_AR">Cristal Antireflex</option>
              <option value="CRISTAL_GRAY">Cristal Gray</option>
              <option value="ALTO_INDICE_167">Alto √çndice 1.67</option>
              <option value="ALTO_INDICE_174">Alto √çndice 1.74</option>
            </select>
          </div>
        </div>

        <div class="luna-precio-calculado">
          <div class="precio-label">Precio Calculado (par)</div>
          <div class="precio-valor" id="lunaPrecioCalculado">S/ 0.00</div>
        </div>

        <div class="row mt-1">
          <div class="field">
            <label>Precio Manual (opcional - reemplaza el calculado)</label>
            <input type="number" step="0.01" id="lunaPrecioManual" placeholder="Dejar vac√≠o para usar precio calculado" style="font-size: 16px; font-weight: bold; color: #059669;">
          </div>
        </div>

        <div class="luna-resumen" id="lunaResumen">
          <p><strong>Tipo:</strong> <span id="resumenTipo">-</span></p>
          <p><strong>Material:</strong> <span id="resumenMaterial">-</span></p>
          <p><strong>Rango:</strong> <span id="resumenRango">-</span></p>
          <p><strong>Inc. Cilindro:</strong> <span id="resumenIncCil">S/ 0.00</span></p>
        </div>
      </div>
    </div>
  </div>
  <div class="modal-footer">
    <button class="btn btn-secondary" onclick="cerrarModal('selectorLunasModal')">Cancelar</button>
    <button class="btn btn-success" onclick="agregarLunaAVenta()">‚úì Agregar a Venta</button>
  </div>
</dialog>

<!-- Modal Buscar Producto para Almac√©n -->
<dialog id="buscarProductoModal" class="buscar-prod-modal" style="max-width: 700px;">
  <div class="modal-header">
    <strong>üîç Buscar Producto</strong>
    <button class="btn btn-sm" style="background: transparent; color: white; font-size: 20px;" onclick="cerrarModal('buscarProductoModal')">√ó</button>
  </div>
  <div class="modal-body">
    <div class="search-filters">
      <div class="field">
        <label>Buscar por</label>
        <select id="buscarProdTipo">
          <option value="nombre">Nombre/Descripci√≥n</option>
          <option value="codigo">C√≥digo</option>
          <option value="modelo">Modelo</option>
          <option value="categoria">Categor√≠a</option>
          <option value="marca">Marca</option>
        </select>
      </div>
      <div class="field" style="flex: 2;">
        <label>T√©rmino de b√∫squeda</label>
        <input type="text" id="buscarProdTermino" placeholder="Escriba para buscar..." onkeyup="filtrarProductosModal()">
      </div>
      <div class="field">
        <label>Categor√≠a</label>
        <select id="buscarProdCategoria" onchange="filtrarProductosModal()">
          <option value="">Todas</option>
          <option value="LUNAS">Lunas</option>
          <option value="MONTURAS">Monturas</option>
          <option value="LCONTACTO">L. Contacto</option>
          <option value="ACCESORIOS">Accesorios</option>
          <option value="SERVICIOS">Servicios</option>
        </select>
      </div>
    </div>
    <div class="prod-results-list" id="prodResultsList"></div>
  </div>
  <div class="modal-footer">
    <button class="btn btn-secondary" onclick="cerrarModal('buscarProductoModal')">Cancelar</button>
    <button class="btn btn-primary" onclick="seleccionarProductoModal()">‚úì Seleccionar</button>
  </div>
</dialog>

<!-- Modal Nueva Gu√≠a de Remisi√≥n -->
<dialog id="nuevaGuiaModal" style="max-width: 800px;">
  <div class="modal-header">
    <strong>üìã Nueva Gu√≠a de Remisi√≥n</strong>
    <button class="btn btn-sm" style="background: transparent; color: white; font-size: 20px;" onclick="cerrarModal('nuevaGuiaModal')">√ó</button>
  </div>
  <div class="modal-body">
    <div class="row mb-2">
      <div class="field">
        <label>Nro. Gu√≠a</label>
        <input type="text" id="guiaNro" placeholder="GR-001-000001">
      </div>
      <div class="field">
        <label>Fecha Emisi√≥n</label>
        <input type="date" id="guiaFechaEmision">
      </div>
      <div class="field">
        <label>Fecha Traslado</label>
        <input type="date" id="guiaFechaTraslado">
      </div>
    </div>
    <div class="row mb-2">
      <div class="field" style="flex: 2;">
        <label>Punto Partida</label>
        <input type="text" id="guiaPuntoPartida" placeholder="Direcci√≥n de origen">
      </div>
      <div class="field" style="flex: 2;">
        <label>Punto Llegada</label>
        <input type="text" id="guiaPuntoLlegada" placeholder="Direcci√≥n de destino">
      </div>
    </div>
    <div class="row mb-2">
      <div class="field" style="flex: 2;">
        <label>Destinatario</label>
        <input type="text" id="guiaDestinatario" placeholder="Nombre del destinatario">
      </div>
      <div class="field">
        <label>RUC/DNI Destinatario</label>
        <input type="text" id="guiaDestinatarioDoc" placeholder="Documento">
      </div>
    </div>
    <div class="row mb-2">
      <div class="field" style="flex: 2;">
        <label>Transportista</label>
        <input type="text" id="guiaTransportista" placeholder="Nombre del transportista">
      </div>
      <div class="field">
        <label>RUC Transportista</label>
        <input type="text" id="guiaTransportistaRuc" placeholder="RUC">
      </div>
      <div class="field">
        <label>Placa Veh√≠culo</label>
        <input type="text" id="guiaPlaca" placeholder="ABC-123">
      </div>
    </div>
    <div class="field mb-2">
      <label>Motivo de Traslado</label>
      <select id="guiaMotivo">
        <option value="VENTA">Venta</option>
        <option value="TRASLADO">Traslado entre Establecimientos</option>
        <option value="CONSIGNACION">Consignaci√≥n</option>
        <option value="DEVOLUCION">Devoluci√≥n</option>
        <option value="OTROS">Otros</option>
      </select>
    </div>

    <div class="card-title" style="font-size: 13px; margin-top: 16px;">Productos a Trasladar</div>
    <div class="buscar-prod-container">
      <input type="text" id="buscarProdGuia" placeholder="Buscar producto..." style="max-width: 300px;">
      <button class="btn btn-success btn-sm" onclick="agregarFilaGuia()">+ Agregar</button>
    </div>
    <table>
      <thead>
        <tr>
          <th>C√≥digo</th>
          <th>Descripci√≥n</th>
          <th class="text-center" style="width: 100px;">Cantidad</th>
          <th class="text-center" style="width: 100px;">Peso (Kg)</th>
          <th class="text-center" style="width: 50px;"></th>
        </tr>
      </thead>
      <tbody id="guiaProductosBody"></tbody>
    </table>
  </div>
  <div class="modal-footer">
    <button class="btn btn-secondary" onclick="cerrarModal('nuevaGuiaModal')">Cancelar</button>
    <button class="btn btn-success" onclick="guardarGuiaRemision()">‚úì Guardar Gu√≠a</button>
  </div>
</dialog>

<!-- Modal Ver/Imprimir Gu√≠a -->
<dialog id="verGuiaModal" style="max-width: 800px;">
  <div class="modal-header">
    <strong>üìã Gu√≠a de Remisi√≥n</strong>
    <button class="btn btn-sm" style="background: transparent; color: white; font-size: 20px;" onclick="cerrarModal('verGuiaModal')">√ó</button>
  </div>
  <div class="modal-body" id="verGuiaContenido">
  </div>
  <div class="modal-footer">
    <button class="btn btn-secondary" onclick="cerrarModal('verGuiaModal')">Cerrar</button>
    <button class="btn btn-primary" onclick="imprimirGuia()">üñ®Ô∏è Imprimir</button>
  </div>
</dialog>

<!-- Modal Usuario -->
<dialog id="usuarioModal" style="max-width: 550px;">
  <div class="modal-header">
    <strong id="usuarioModalTitulo">üë§ Nuevo Usuario</strong>
    <button class="btn btn-sm" style="background: transparent; color: white; font-size: 20px;" onclick="cerrarModal('usuarioModal')">√ó</button>
  </div>
  <div class="modal-body">
    <input type="hidden" id="usuarioIdHidden">
    <div class="row">
      <div class="field" style="flex: 0 0 120px;">
        <label>Elegir</label>
        <select id="usuarioTipoDoc">
          <option value="DNI">DNI</option>
          <option value="RUC">RUC</option>
          <option value="CE">CE</option>
        </select>
      </div>
      <div class="field" style="flex: 0 0 100px;">
        <button class="btn btn-info btn-sm" onclick="consultarReniecUsuario()" style="margin-top: 22px;">RENIEC</button>
      </div>
      <div class="field">
        <label>Dni</label>
        <input type="text" id="usuarioDni" maxlength="11">
      </div>
    </div>
    <div class="field">
      <label>NOMBRES</label>
      <input type="text" id="usuarioNombres" style="background: #fffde7;">
    </div>
    <div class="row">
      <div class="field">
        <label>Tel√©fono</label>
        <input type="text" id="usuarioTelefono">
      </div>
      <div class="field">
        <label>Correo</label>
        <input type="email" id="usuarioCorreo">
      </div>
    </div>
    <div class="field">
      <label>Direcci√≥n</label>
      <input type="text" id="usuarioDireccion">
    </div>
    <div class="row">
      <div class="field">
        <label>Fecha de Nacimiento</label>
        <input type="date" id="usuarioFechaNac">
      </div>
      <div class="field">
        <label>Fecha de Inicio</label>
        <input type="date" id="usuarioFechaInicio">
      </div>
    </div>
    <div class="field">
      <label>Grupo</label>
      <select id="usuarioGrupo">
        <option value="">Seleccione el grupo</option>
        <option value="ADMINISTRADOR">ADMINISTRADOR</option>
        <option value="VENTAS">VENTAS</option>
        <option value="ALMACEN">ALMACEN</option>
        <option value="CAJERO">CAJERO</option>
      </select>
    </div>
    <div class="row">
      <div class="field">
        <label><input type="checkbox" id="usuarioEsVendedor"> Marque esta casilla si es un Vendedor</label>
      </div>
    </div>
    <div class="row">
      <div class="field">
        <label><input type="checkbox" id="usuarioEsCajero"> Es un Cajero (Permite Aperturar y Cerrar Caja)</label>
      </div>
    </div>
    <div class="config-login-box">
      <p class="text-danger" style="text-align: center; margin-bottom: 10px;">(para el inicio de sesi√≥n)</p>
      <div class="field">
        <label>Usuario</label>
        <input type="text" id="usuarioUsername">
      </div>
      <div class="field">
        <label>Contrase√±a</label>
        <input type="password" id="usuarioPassword">
      </div>
      <div class="field">
        <label>Confirmar Contrase√±a</label>
        <input type="password" id="usuarioPasswordConfirm">
      </div>
    </div>
  </div>
  <div class="modal-footer" style="background: #fff176;">
    <button class="btn btn-success" onclick="guardarUsuario()">üíæ Guardar</button>
    <button class="btn btn-danger" onclick="cerrarModal('usuarioModal')">üö™ Salir</button>
  </div>
</dialog>

<!-- Modal Correlativo Documento -->
<dialog id="correlativoModal" style="max-width: 450px;">
  <div class="modal-header">
    <strong id="correlativoModalTitulo">üìÑ Correlativo Documento</strong>
    <button class="btn btn-sm" style="background: transparent; color: white; font-size: 20px;" onclick="cerrarModal('correlativoModal')">√ó</button>
  </div>
  <div class="modal-body">
    <input type="hidden" id="correlativoIdHidden">
    <div class="field">
      <label>Documento</label>
      <select id="correlativoDocumento">
        <option value="">Seleccione...</option>
        <option value="NOTA DE CREDITO">NOTA DE CREDITO</option>
        <option value="NOTA DE VENTA">NOTA DE VENTA</option>
        <option value="TICKET RECIBO">TICKET RECIBO</option>
        <option value="FACTURA ELECTRONICA">FACTURA ELECTRONICA</option>
        <option value="BOLETA DE VENTA ELECTRONICA">BOLETA DE VENTA ELECTRONICA</option>
        <option value="NOTA DE ANULACION">NOTA DE ANULACION</option>
        <option value="GUIA DE REMISION">GUIA DE REMISION</option>
      </select>
    </div>
    <div class="field">
      <label>Establecimiento</label>
      <select id="correlativoEstablecimiento">
        <option value="PREMIUM">PREMIUM</option>
        <option value="PRINCIPAL">PRINCIPAL</option>
        <option value="SUCURSAL">SUCURSAL</option>
      </select>
    </div>
    <div class="field">
      <label>Nombre del Reporte</label>
      <input type="text" id="correlativoNombreReporte" placeholder="Ej: RlTicketElectronicoNCIMG">
    </div>
    <div class="row">
      <div class="field">
        <label>Serie</label>
        <input type="text" id="correlativoSerie" placeholder="Ej: BC01, F001">
      </div>
      <div class="field" style="flex: 0 0 120px;">
        <label>Emitidos</label>
        <input type="number" id="correlativoEmitidos" value="0" min="0">
      </div>
    </div>
    <div class="row">
      <div class="field">
        <label><input type="checkbox" id="correlativoMostrarVentas"> Mostrar solo en ventas</label>
      </div>
    </div>
    <div class="row">
      <div class="field">
        <label><input type="checkbox" id="correlativoGenAuto" checked> Generaci√≥n autom√°tica</label>
      </div>
    </div>
  </div>
  <div class="modal-footer" style="background: #fff176;">
    <button class="btn btn-success" onclick="guardarCorrelativo()">üíæ Guardar</button>
    <button class="btn btn-danger" onclick="cerrarModal('correlativoModal')">üö™ Salir</button>
  </div>
</dialog>

<!-- Modal Historial de Consulta - ULTRA MODERNO -->
<div id="modalHistorialConsulta" class="modal-historial-overlay" style="display: none;">
  <div class="modal-historial-container">
    <!-- Header del Modal -->
    <div class="modal-historial-header">
      <div class="modal-historial-title">
        <span class="modal-icon">ü©∫</span>
        <div>
          <h2 id="modalHistorialTitulo">HISTORIAL CL√çNICO COMPLETO</h2>
          <p id="modalHistorialSubtitulo">Detalles de la consulta</p>
        </div>
      </div>
      <button class="modal-historial-close" onclick="cerrarModalHistorial()">‚úï</button>
    </div>

    <!-- Contenido del Modal con Scroll -->
    <div class="modal-historial-content" id="modalHistorialContenido">
      <!-- El contenido se genera din√°micamente -->
    </div>

    <!-- Footer del Modal -->
    <div class="modal-historial-footer">
      <button class="btn btn-secondary" onclick="cerrarModalHistorial()">üö™ Cerrar</button>
      <button class="btn btn-info" onclick="imprimirConsultaActual()">üñ®Ô∏è Imprimir</button>
      <button class="btn btn-success" onclick="exportarConsultaPDF()">üìÑ Exportar PDF</button>
    </div>
  </div>
</div>

<!-- Modal Visualizaci√≥n de RX - DISE√ëO ESPECTACULAR -->
<div id="modalVisualizacionRX" class="modal-rx-overlay" style="display: none;">
  <div class="modal-rx-container" style="max-width: 100%; width: 100%; height: 100vh; margin: 0; border-radius: 0;">
    <!-- Header del Modal -->
    <div class="modal-rx-header" style="background: linear-gradient(135deg, #3b82f6, #2563eb); padding: 20px 30px; border-radius: 0;">
      <div class="modal-rx-title">
        <span class="modal-rx-icon" style="font-size: 36px; filter: drop-shadow(0 2px 8px rgba(0,0,0,0.3));">üëì</span>
        <div>
          <h2 style="color: white; font-size: 26px; font-weight: 800; margin: 0;">PRESCRIPCI√ìN DE LENTES</h2>
          <p id="modalRxSubtitulo" style="color: rgba(255,255,255,0.95); font-size: 14px; margin: 5px 0 0 0;">Datos del paciente</p>
        </div>
      </div>
      <button class="modal-rx-close" onclick="cerrarModalRX()">‚úï</button>
    </div>

    <!-- Pesta√±as del Modal -->
    <div style="display: flex; gap: 0; border-bottom: 3px solid #e5e7eb; background: #f9fafb; padding: 0 15px;">
      <button id="tabRxActual" onclick="cambiarTabRX('actual')" style="flex: 1; padding: 12px 18px; background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; border: none; border-radius: 8px 8px 0 0; font-weight: 700; font-size: 13px; cursor: pointer; transition: all 0.3s; margin-right: 4px;">
        üìã Prescripci√≥n Actual
      </button>
      <button id="tabRxHistorial" onclick="cambiarTabRX('historial')" style="flex: 1; padding: 12px 18px; background: white; color: #6b7280; border: none; border-radius: 8px 8px 0 0; font-weight: 700; font-size: 13px; cursor: pointer; transition: all 0.3s;">
        üìö Historial de Prescripciones
      </button>
    </div>

    <!-- Contenido del Modal -->
    <div class="modal-rx-content" id="modalRxContenido">
      <!-- El contenido se genera din√°micamente -->
    </div>

    <!-- Footer del Modal -->
    <div class="modal-rx-footer" style="display: flex; gap: 12px; flex-wrap: wrap; justify-content: flex-end; align-items: center; padding: 20px 30px; background: linear-gradient(180deg, #f9fafb, #ffffff); border-top: 3px solid #e5e7eb;">
      <!-- Botones de acci√≥n -->
      <div style="display: flex; gap: 10px; flex-wrap: wrap;">
      <button class="btn btn-info" onclick="imprimirRxActual()" style="background: linear-gradient(135deg, #3b82f6, #2563eb); border: none; color: white;">üñ®Ô∏è Imprimir Prescripci√≥n</button>
      <button class="btn btn-success" onclick="imprimirHistorialClinicoCompleto()" style="background: linear-gradient(135deg, #10b981, #059669); border: none; color: white;">üìã Imprimir Historial Cl√≠nico</button>
      <button class="btn btn-primary" onclick="editarRxActual()">‚úèÔ∏è Editar</button>
      </div>
    </div>
  </div>
</div>

<!-- √Årea de impresi√≥n -->
<div id="printArea" style="display: none;"></div>

<script>
/* ============================================
   VARIABLES GLOBALES DEL SISTEMA
   ============================================ */

// Establecimiento y usuario
let establecimientoActual = null;
let usuarioActual = null;

// Variables de productos y cat√°logo
let productoSeleccionado = null;
let productoSeleccionadoModal = null;
let filtroCatalogoModal = 'TODOS';

// Variables de precios de lunas
let PRECIOS_LUNAS = null;

// Tema actual
let temaActual = 'sicuani';

// Variables de reportes y an√°lisis
let ventasPaginadas = [];
let periodoAnalisisActual = 'mes';
let itemsVenta = [];

// Variables de ventanas paginadas (para evitar errores de "before initialization")
let paginaActual = 1;
let registrosPorPagina = 20;

// Variables del sistema de consultorio cl√≠nico (declaradas al inicio del HTML como var globales)
// pacienteConsultorioActual, consultaEnEdicion, modoVistaConsultorio

/* ============================================
   SISTEMA DE LOGIN Y AUTENTICACI√ìN
   ============================================ */

// Configuraci√≥n de logos por establecimiento
const logosPorEstablecimiento = {
  'DOS_DE_MAYO': 'data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%27400%27 height=%27200%27 viewBox=%270 0 400 200%27%3E%3Crect width=%27400%27 height=%27200%27 fill=%27%237c3aed%27/%3E%3Ctext x=%2750%25%27 y=%2735%25%27 text-anchor=%27middle%27 fill=%27white%27 font-size=%2736%27 font-weight=%27bold%27%3ECENTRO √ìPTICO%3C/text%3E%3Ctext x=%2750%25%27 y=%2765%25%27 text-anchor=%27middle%27 fill=%27%2306b6d4%27 font-size=%2752%27 font-weight=%27bold%27%3ESICUANI%3C/text%3E%3Ctext x=%2750%25%27 y=%2785%25%27 text-anchor=%27middle%27 fill=%27white%27 font-size=%2716%27%3EMEDIDA DE LA VISTA COMPUTARIZADA%3C/text%3E%3C/svg%3E',
  'PLAZA_DE_ARMAS': 'data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%27400%27 height=%27200%27 viewBox=%270 0 400 200%27%3E%3Crect width=%27400%27 height=%27200%27 fill=%27%232563eb%27/%3E%3Ctext x=%2750%25%27 y=%2740%25%27 text-anchor=%27middle%27 fill=%27white%27 font-size=%2764%27 font-weight=%27bold%27%3E√ìPTICA%3C/text%3E%3Ctext x=%2750%25%27 y=%2775%25%27 text-anchor=%27middle%27 fill=%27%23ef4444%27 font-size=%2748%27 font-weight=%27bold%27 style=%27text-shadow: 2px 2px 0 white%27%3ESICUANI%3C/text%3E%3C/svg%3E',
  'DEFAULT': 'data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%27400%27 height=%27200%27 viewBox=%270 0 400 200%27%3E%3Ctext x=%2750%25%27 y=%2750%25%27 text-anchor=%27middle%27 dy=%27.3em%27 fill=%27%237c3aed%27 font-size=%2780%27 font-weight=%27bold%27%3EüëÅ%3C/text%3E%3C/svg%3E'
};

// Funci√≥n para actualizar el logo principal del dashboard
function actualizarLogoPrincipal(establecimiento) {
  const logo = logosPorEstablecimiento[establecimiento] || logosPorEstablecimiento['DEFAULT'];
  const logoElement = document.getElementById('logoPrincipal');
  if (logoElement) {
    logoElement.src = logo;
  }
}

// Funci√≥n para actualizar el logo del login
function actualizarLogoLogin(establecimiento) {
  const logo = logosPorEstablecimiento[establecimiento] || logosPorEstablecimiento['DEFAULT'];
  const logoElement = document.getElementById('loginLogo');
  if (logoElement) {
    logoElement.src = logo;
  }
}

// Credenciales predefinidas por establecimiento
const CREDENCIALES = {
  'DOS_DE_MAYO': {
    usuario: 'Centro √ìptico Sicuani',
    password: 'ADMI',
    nombreMostrar: 'Dos de Mayo'
  },
  'PLAZA_DE_ARMAS': {
    usuario: '√ìptica Sicuani',
    password: 'ADMI',
    nombreMostrar: 'Plaza de Armas'
  }
};

// Funci√≥n para normalizar texto (eliminar tildes y caracteres especiales)
function normalizeText(text) {
  return text
    .toLowerCase()
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g, '') // Elimina tildes
    .replace(/[^a-z0-9\s]/g, '') // Elimina caracteres especiales
    .trim();
}

// Funci√≥n para cambiar tema del login seg√∫n establecimiento
function cambiarTemaLogin() {
  const establecimiento = document.getElementById('loginEstablecimiento').value;
  const overlay = document.getElementById('loginOverlay');
  const header = document.querySelector('.login-header');
  const nombreEmpresa = document.getElementById('loginEmpresaNombre');

  if (establecimiento === 'DOS_DE_MAYO') {
    // Tema morado para Centro √ìptico Sicuani
    overlay.className = 'login-overlay tema-morado';
    header.className = 'login-header tema-morado';
    nombreEmpresa.className = 'login-empresa-nombre tema-morado';
    nombreEmpresa.textContent = 'Centro √ìptico Sicuani';
  } else if (establecimiento === 'PLAZA_DE_ARMAS') {
    // Tema azul para √ìptica Sicuani
    overlay.className = 'login-overlay tema-azul';
    header.className = 'login-header tema-azul';
    nombreEmpresa.className = 'login-empresa-nombre tema-azul';
    nombreEmpresa.textContent = '√ìptica Sicuani';
  } else {
    // Tema por defecto
    overlay.className = 'login-overlay';
    header.className = 'login-header';
    nombreEmpresa.className = 'login-empresa-nombre';
    nombreEmpresa.textContent = '√ìptica Sicuani';
  }
}

// Funci√≥n para intentar login
function intentarLogin() {
  const usuario = document.getElementById('loginUsuario').value.trim();
  const password = document.getElementById('loginPassword').value;
  const establecimiento = document.getElementById('loginEstablecimiento').value;
  const errorDiv = document.getElementById('loginError');

  // Validaciones
  if (!usuario || !password || !establecimiento) {
    errorDiv.textContent = 'Complete todos los campos';
    errorDiv.classList.add('show');
    return;
  }

  // Normalizar usuario ingresado (quitar tildes y convertir a min√∫sculas)
  const usuarioNormalizado = normalizeText(usuario);

  // Verificar credenciales
  const credenciales = CREDENCIALES[establecimiento];

  // Normalizar usuario de credenciales para comparaci√≥n
  const usuarioCredencialNormalizado = normalizeText(credenciales?.usuario || '');

  // Comparar usuarios normalizados (sin tildes) pero mantener contrase√±a exacta
  if (credenciales && usuarioNormalizado === usuarioCredencialNormalizado && credenciales.password === password) {
    // Login exitoso
    establecimientoActual = establecimiento;
    usuarioActual = usuario;

    // Guardar sesi√≥n
    localStorage.setItem('optica_sesion', JSON.stringify({
      establecimiento: establecimiento,
      usuario: usuario,
      timestamp: Date.now()
    }));

    // Ocultar login y mostrar sistema (sin MDI)
    const loginOverlay = document.getElementById('loginOverlay');
    const ribbon = document.getElementById('ribbon');
    const badge = document.getElementById('establecimientoBadge');

    if (loginOverlay) loginOverlay.classList.add('hidden');
    if (ribbon) {
      ribbon.classList.remove('hidden');
      ribbon.style.display = 'flex';
    }
    if (badge) badge.textContent = 'üè™ ' + credenciales.nombreMostrar;

    // Actualizar logo principal del dashboard
    actualizarLogoPrincipal(establecimiento);

    // Recargar datos del establecimiento
    actualizarDB();
    inicializarSistema();

    toast('Bienvenido, ' + usuario);
  } else {
    errorDiv.textContent = 'Usuario o contrase√±a incorrectos';
    errorDiv.classList.add('show');
  }
}

// Funci√≥n para cerrar login (cancelar)
function cerrarLogin() {
  // No hacer nada, el usuario debe hacer login
  toast('Debe iniciar sesi√≥n para continuar', 'warning');
}

// Funci√≥n para cerrar sesi√≥n
function cerrarSesion() {
  if (!confirm('¬øEst√° seguro de cerrar sesi√≥n?')) return;

  // Limpiar sesi√≥n
  localStorage.removeItem('optica_sesion');
  establecimientoActual = null;
  usuarioActual = null;

  // Mostrar login y ocultar sistema
  document.getElementById('loginOverlay').classList.remove('hidden');
  document.getElementById('ribbon').classList.add('hidden');
  document.getElementById('ribbon').style.display = 'none';
  const desktopEl = document.getElementById('desktop');
  if (desktopEl) desktopEl.style.display = 'none';

  // Limpiar formulario de login
  document.getElementById('loginUsuario').value = '';
  document.getElementById('loginPassword').value = '';
  document.getElementById('loginEstablecimiento').value = '';
  document.getElementById('loginError').classList.remove('show');

  toast('Sesi√≥n cerrada');
}

// Verificar sesi√≥n existente al cargar
function verificarSesion() {
  const sesionGuardada = localStorage.getItem('optica_sesion');

  if (sesionGuardada) {
    try {
      const sesion = JSON.parse(sesionGuardada);
      // Verificar que la sesi√≥n no sea muy antigua (24 horas)
      if (Date.now() - sesion.timestamp < 24 * 60 * 60 * 1000) {
        establecimientoActual = sesion.establecimiento;
        usuarioActual = sesion.usuario;

        const credenciales = CREDENCIALES[establecimientoActual];

        // Mostrar sistema (sin MDI)
        const loginOverlay = document.getElementById('loginOverlay');
        const ribbon = document.getElementById('ribbon');
        const badge = document.getElementById('establecimientoBadge');

        if (loginOverlay) loginOverlay.classList.add('hidden');
        if (ribbon) {
          ribbon.classList.remove('hidden');
          ribbon.style.display = 'flex';
        }
        if (badge) badge.textContent = 'üè™ ' + credenciales.nombreMostrar;

        // Actualizar logo principal del dashboard
        actualizarLogoPrincipal(establecimientoActual);

        actualizarDB();
        return true;
      }
    } catch (e) {
      console.error('Error al verificar sesi√≥n:', e);
    }
  }

  // No hay sesi√≥n v√°lida, mostrar login
  document.getElementById('ribbon').classList.add('hidden');
  document.getElementById('ribbon').style.display = 'none';
  const desktopEl = document.getElementById('desktop');
  if (desktopEl) desktopEl.style.display = 'none';
  document.getElementById('loginOverlay').classList.remove('hidden');
  return false;
}

// Evento Enter en campos de login y cambio de logo
document.addEventListener('DOMContentLoaded', function() {
  const loginFields = ['loginUsuario', 'loginPassword', 'loginEstablecimiento'];
  loginFields.forEach(fieldId => {
    const field = document.getElementById(fieldId);
    if (field) {
      field.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          intentarLogin();
        }
      });
    }
  });

  // Event listener para cambiar tema del login al seleccionar establecimiento
  const establecimientoSelect = document.getElementById('loginEstablecimiento');
  if (establecimientoSelect) {
    establecimientoSelect.addEventListener('change', function() {
      cambiarTemaLogin();
    });
  }
});

/* ============================================
   BASE DE DATOS LOCAL (POR ESTABLECIMIENTO)
   ============================================ */

// Prefijo base para las claves de localStorage
const DB_BASE = {
  CLIENTES: 'clientes',
  PRODUCTOS: 'productos',
  VENTAS: 'ventas',
  MEDIDAS: 'medidas',
  TIPOS_LUNAS: 'tipos_lunas',
  LUNAS_VENDIDAS: 'lunas_vendidas',
  MOVIMIENTOS: 'movimientos',
  GUIAS: 'guias',
  USUARIOS: 'usuarios',
  CORRELATIVOS: 'correlativos',
  ALMACENES: 'almacenes',
  CAJAS: 'cajas',
  CONSULTAS_CLINICAS: 'consultas_clinicas'
};

// Objeto DB din√°mico seg√∫n establecimiento
let DB = {};

// Actualizar claves de DB seg√∫n establecimiento
function actualizarDB() {
  const prefijo = establecimientoActual ? 'optica_' + establecimientoActual.toLowerCase() + '_' : 'optica_default_';

  DB = {
    CLIENTES: prefijo + 'clientes',
    PRODUCTOS: prefijo + 'productos',
    VENTAS: prefijo + 'ventas',
    MEDIDAS: prefijo + 'medidas',
    PRESCRIPCIONES: prefijo + 'prescripciones',
    TIPOS_LUNAS: prefijo + 'tipos_lunas',
    LUNAS_VENDIDAS: prefijo + 'lunas_vendidas',
    INVENTARIO_LUNAS: prefijo + 'inventario_lunas',
    MOVIMIENTOS: prefijo + 'movimientos',
    GUIAS: prefijo + 'guias',
    USUARIOS: prefijo + 'usuarios',
    CORRELATIVOS: prefijo + 'correlativos',
    ALMACENES: prefijo + 'almacenes',
    CAJAS: prefijo + 'cajas',
    CONSULTAS_CLINICAS: prefijo + 'consultas_clinicas'
  };
}

// Inicializar DB con valores por defecto (para cuando no hay sesi√≥n)
actualizarDB();

// Fallback storage en memoria para navegadores que bloquean localStorage
const memoryStorage = {};

// Verificar si localStorage est√° disponible
function isLocalStorageAvailable() {
  try {
    const test = '__localStorage_test__';
    localStorage.setItem(test, test);
    localStorage.removeItem(test);
    return true;
  } catch (e) {
    console.warn('‚ö†Ô∏è localStorage no disponible, usando almacenamiento en memoria');
    return false;
  }
}

const useLocalStorage = isLocalStorageAvailable();

function load(key) {
  try {
    if (useLocalStorage) {
      return JSON.parse(localStorage.getItem(key) || '[]');
    } else {
      return memoryStorage[key] || [];
    }
  } catch(e) {
    console.error('Error al cargar datos:', e);
    return [];
  }
}

function save(key, data) {
  try {
    if (useLocalStorage) {
      localStorage.setItem(key, JSON.stringify(data));
    } else {
      memoryStorage[key] = data;
    }
  } catch(e) {
    console.error('Error al guardar datos:', e);
    // Fallback a memoria
    memoryStorage[key] = data;
  }
}

function genId(prefix) {
  return prefix + '_' + Date.now() + '_' + Math.floor(Math.random() * 1000);
}

function today() { return new Date().toISOString().slice(0, 10); }
function now() { return new Date().toISOString().slice(0, 16); }

function formatDate(d) {
  if (!d) return '-';

  // Si la fecha ya incluye hora (ISO completo), usar directamente
  if (d.includes('T') || d.includes(':')) {
    const fecha = new Date(d);
    if (isNaN(fecha.getTime())) return '-';
    return fecha.toLocaleDateString('es-PE');
  }

  // Si es solo fecha (YYYY-MM-DD), agregar hora
  const fecha = new Date(d + 'T00:00:00');
  if (isNaN(fecha.getTime())) return '-';
  return fecha.toLocaleDateString('es-PE');
}

/* ============================================
   TOAST NOTIFICATIONS - VERSI√ìN ULTRA MODERNA 3.0
   Glassmorphism + Animaciones Avanzadas + Barra de Progreso
   ============================================ */
function toast(msg, type = 'success') {
  // Eliminar toasts existentes con animaci√≥n de salida
  const existing = document.querySelector('.toast-ultra');
  if (existing) {
    existing.style.animation = 'toastSlideOut 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards';
    setTimeout(() => existing.remove(), 400);
  }

  // Configuraci√≥n por tipo con iconos animados y colores modernos
  const configs = {
    success: {
      bg: 'rgba(16, 185, 129, 0.95)',
      icon: '‚úì',
      borderColor: '#10b981',
      shadow: 'rgba(16, 185, 129, 0.4)'
    },
    error: {
      bg: 'rgba(239, 68, 68, 0.95)',
      icon: '‚úï',
      borderColor: '#ef4444',
      shadow: 'rgba(239, 68, 68, 0.4)'
    },
    warning: {
      bg: 'rgba(245, 158, 11, 0.95)',
      icon: '‚ö†',
      borderColor: '#f59e0b',
      shadow: 'rgba(245, 158, 11, 0.4)'
    },
    info: {
      bg: 'rgba(59, 130, 246, 0.95)',
      icon: '‚Ñπ',
      borderColor: '#3b82f6',
      shadow: 'rgba(59, 130, 246, 0.4)'
    }
  };

  const config = configs[type] || configs.success;

  // Crear toast con glassmorphism
  const t = document.createElement('div');
  t.className = `toast-ultra ${type}`;
  t.style.cssText = `
    position: fixed;
    top: 100px;
    right: 24px;
    background: ${config.bg};
    backdrop-filter: blur(20px) saturate(180%);
    -webkit-backdrop-filter: blur(20px) saturate(180%);
    color: white;
    padding: 18px 24px;
    border-radius: 16px;
    box-shadow: 0 15px 50px ${config.shadow},
                0 0 0 1px rgba(255, 255, 255, 0.2) inset,
                0 5px 15px rgba(255, 255, 255, 0.1) inset;
    z-index: 100000;
    display: flex;
    align-items: center;
    gap: 14px;
    font-weight: 700;
    font-size: 14px;
    min-width: 320px;
    max-width: 550px;
    animation: toastSlideIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
    border: 2px solid rgba(255, 255, 255, 0.3);
    position: relative;
    overflow: hidden;
  `;

  t.innerHTML = `
    <div style="
      width: 42px;
      height: 42px;
      background: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(10px);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      font-weight: 900;
      animation: toastIconBounce 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      flex-shrink: 0;
    ">${config.icon}</div>
    <span style="
      flex: 1;
      line-height: 1.5;
      letter-spacing: 0.3px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    ">${msg}</span>
    <button onclick="this.parentElement.remove()" style="
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(10px);
      border: 2px solid rgba(255, 255, 255, 0.3);
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      font-weight: 300;
      flex-shrink: 0;
    " onmouseover="this.style.background='rgba(255, 255, 255, 0.35)'; this.style.transform='rotate(90deg) scale(1.15)'; this.style.borderColor='rgba(255, 255, 255, 0.5)';" onmouseout="this.style.background='rgba(255, 255, 255, 0.2)'; this.style.transform='rotate(0) scale(1)'; this.style.borderColor='rgba(255, 255, 255, 0.3)';">√ó</button>
    <div class="toast-progress" style="
      position: absolute;
      bottom: 0;
      left: 0;
      height: 4px;
      background: rgba(255, 255, 255, 0.4);
      width: 100%;
      animation: toastProgress 3.5s linear forwards;
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
    "></div>
  `;

  document.body.appendChild(t);

  // Auto-remover despu√©s de 3.5 segundos con animaci√≥n
  setTimeout(() => {
    t.style.animation = 'toastSlideOut 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards';
    setTimeout(() => t.remove(), 400);
  }, 3500);

  // Agregar estilos de animaci√≥n si no existen
  if (!document.getElementById('toast-animations-style')) {
    const style = document.createElement('style');
    style.id = 'toast-animations-style';
    style.textContent = `
      @keyframes toastSlideIn {
        0% {
          opacity: 0;
          transform: translateX(120%) translateY(-30px) scale(0.8) rotateZ(10deg);
        }
        60% {
          transform: translateX(-10px) translateY(0) scale(1.05) rotateZ(-2deg);
        }
        100% {
          opacity: 1;
          transform: translateX(0) translateY(0) scale(1) rotateZ(0);
        }
      }

      @keyframes toastSlideOut {
        0% {
          opacity: 1;
          transform: translateX(0) scale(1) rotateZ(0);
        }
        100% {
          opacity: 0;
          transform: translateX(150%) scale(0.7) rotateZ(-10deg);
        }
      }

      @keyframes toastIconBounce {
        0% { transform: scale(0) rotate(-180deg); }
        50% { transform: scale(1.3) rotate(10deg); }
        70% { transform: scale(0.9) rotate(-5deg); }
        85% { transform: scale(1.1) rotate(2deg); }
        100% { transform: scale(1) rotate(0); }
      }

      @keyframes toastProgress {
        from { width: 100%; }
        to { width: 0%; }
      }
    `;
    document.head.appendChild(style);
  }
}

/* ============================================
   NAVEGACI√ìN
   ============================================ */
function mostrarSeccion(seccion) {
  // Ocultar todas las secciones y remover clase active
  document.querySelectorAll('main section').forEach(s => {
    s.classList.add('hidden');
    s.classList.remove('active');
  });

  // Mostrar SOLO la secci√≥n seleccionada
  const seccionActual = document.getElementById(seccion);
  if (seccionActual) {
    seccionActual.classList.remove('hidden');
    seccionActual.classList.add('active');
  }

  // Actualizar estado de botones del ribbon
  document.querySelectorAll('.ribbon-btn').forEach(b => b.classList.remove('active'));
  document.querySelector(`[data-section="${seccion}"]`)?.classList.add('active');

  if (seccion === 'clientes') renderClientes();
  if (seccion === 'buscarVentas') buscarVentas();
  if (seccion === 'buscarRx') buscarPrescripciones();
}

document.querySelectorAll('.ribbon-btn[data-section]').forEach(btn => {
  btn.onclick = () => mostrarSeccion(btn.dataset.section);
});

function cerrarModal(id) {
  document.getElementById(id).close();
}

/* ============================================
   VENTANAS MDI
   ============================================ */
function makeDraggable(windowEl, titleBarEl) {
  let offsetX = 0, offsetY = 0, isDragging = false;

  titleBarEl.addEventListener('mousedown', e => {
    if (e.target.tagName === 'BUTTON') return;
    isDragging = true;
    offsetX = e.clientX - windowEl.offsetLeft;
    offsetY = e.clientY - windowEl.offsetTop;
    windowEl.style.zIndex = 200;
  });

  document.addEventListener('mouseup', () => isDragging = false);
  document.addEventListener('mousemove', e => {
    if (!isDragging) return;
    windowEl.style.left = (e.clientX - offsetX) + 'px';
    windowEl.style.top = (e.clientY - offsetY) + 'px';
  });
}

// C√ìDIGO MDI DESACTIVADO - YA NO SE USA
// makeDraggable(document.getElementById('appWindow'), document.getElementById('appTitleBar'));
makeDraggable(document.getElementById('prescripcionWindow'), document.getElementById('rxTitleBar'));

// document.getElementById('btnMin').onclick = () => {
//   const content = document.getElementById('appContent');
//   const win = document.getElementById('appWindow');
//   content.style.display = content.style.display === 'none' ? 'block' : 'none';
//   win.style.height = content.style.display === 'none' ? '38px' : '620px';
// };

// document.getElementById('btnClose').onclick = () => {
//   document.getElementById('appWindow').style.display = 'none';
// };

document.getElementById('btnRxMin').onclick = () => {
  const win = document.getElementById('prescripcionWindow');
  const content = win.querySelector('.mdi-content');
  content.style.display = content.style.display === 'none' ? 'block' : 'none';
  win.style.height = content.style.display === 'none' ? '38px' : '600px';
};

document.getElementById('btnRxClose').onclick = () => cerrarPrescripcion();

/* ============================================
   VENTAS
   ============================================ */
// Variable movida al inicio del script (l√≠nea 9702)

function initVenta() {
  document.getElementById('fechaEmision').value = today();
  document.getElementById('fechaVenc').value = today();
  const ventas = load(DB.VENTAS);

  // üî• NUMERACI√ìN PROGRESIVA POR D√çA
  const hoy = today();
  const ventasHoy = ventas.filter(v => v.fechaEmision === hoy);
  const numeroDelDia = ventasHoy.length + 1;

  document.getElementById('docNumero').value = String(numeroDelDia).padStart(6, '0');
  renderItemsVenta();
}

function renderItemsVenta() {
  const tbody = document.getElementById('itemsBody');
  tbody.innerHTML = '';
  let totalCant = 0, totalBruto = 0, totalDesc = 0;

  itemsVenta.forEach((item, idx) => {
    const importe = (item.cantidad * item.precio) - item.descuento;
    totalCant += item.cantidad;
    totalBruto += item.cantidad * item.precio;
    totalDesc += item.descuento;

    tbody.innerHTML += `
      <tr>
        <td class="text-center">${idx + 1}</td>
        <td>${item.descripcion}</td>
        <td class="text-center">${item.cantidad}</td>
        <td class="text-right">S/ ${item.precio.toFixed(2)}</td>
        <td class="text-right">S/ ${item.descuento.toFixed(2)}</td>
        <td class="text-right"><strong>S/ ${importe.toFixed(2)}</strong></td>
        <td class="text-center">
          <button class="btn btn-danger btn-sm" onclick="eliminarItem(${idx})">üóëÔ∏è</button>
        </td>
      </tr>
    `;
  });

  document.getElementById('registrosInfo').textContent = `üì¶ Items: ${itemsVenta.length} | Cantidad: ${totalCant}`;
  document.getElementById('totalBruto').value = totalBruto.toFixed(2);
  document.getElementById('totalDescuento').value = totalDesc.toFixed(2);
  document.getElementById('totalPagar').value = (totalBruto - totalDesc).toFixed(2);

  // Auto-calcular saldo total
  calcularSaldoTotal();
}

function eliminarItem(idx) {
  itemsVenta.splice(idx, 1);
  renderItemsVenta();
}

function nuevaVenta() {
  itemsVenta = [];
  document.getElementById('clienteId').value = '';
  document.getElementById('clienteNombre').value = '';
  document.getElementById('badgeMedida').textContent = 'SIN MEDIDA';
  document.getElementById('badgeMedida').className = 'badge badge-danger';
  document.getElementById('obsVenta').value = '';
  initVenta();
  toast('Nueva venta iniciada');
}

// Calcular saldo total autom√°ticamente
function calcularSaldoTotal() {
  const totalPagar = parseFloat(document.getElementById('totalPagar').value) || 0;
  const saldoACuenta = parseFloat(document.getElementById('saldoACuenta').value) || 0;
  const saldoTotal = Math.max(0, totalPagar - saldoACuenta);

  document.getElementById('saldoTotal').value = saldoTotal.toFixed(2);

  // Cambiar color seg√∫n el estado
  const saldoTotalInput = document.getElementById('saldoTotal');
  if (saldoTotal > 0) {
    saldoTotalInput.style.color = '#dc2626';
    saldoTotalInput.style.background = 'linear-gradient(135deg, #fef2f2, #fee2e2)';
  } else {
    saldoTotalInput.style.color = '#059669';
    saldoTotalInput.style.background = 'linear-gradient(135deg, #f0fdf4, #d1fae5)';
  }
}

function guardarVenta() {
  if (itemsVenta.length === 0) { toast('Agrega productos', 'error'); return; }

  const totalPagar = parseFloat(document.getElementById('totalPagar').value);
  const saldoACuenta = parseFloat(document.getElementById('saldoACuenta').value) || totalPagar;
  const saldoTotal = parseFloat(document.getElementById('saldoTotal').value) || 0;

  const venta = {
    id: genId('VEN'),
    docTipo: document.getElementById('docTipo').value,
    docSerie: document.getElementById('docSerie').value,
    docNumero: document.getElementById('docNumero').value,
    fechaEmision: document.getElementById('fechaEmision').value,
    clienteId: document.getElementById('clienteId').value,
    clienteNombre: document.getElementById('clienteNombre').value || 'CLIENTE EVENTUAL',
    tipoFinanc: document.getElementById('tipoFinanc').value,
    vendedor: document.getElementById('vendedor').value,
    observacion: document.getElementById('obsVenta').value,
    items: [...itemsVenta],
    totalBruto: parseFloat(document.getElementById('totalBruto').value),
    totalDescuento: parseFloat(document.getElementById('totalDescuento').value),
    totalPagar: totalPagar,
    saldoACuenta: saldoACuenta,
    saldoTotal: saldoTotal,
    pagado: saldoACuenta,
    saldo: saldoTotal,
    estadoPago: saldoTotal > 0 ? 'PENDIENTE' : 'PAGADO',
    estadoEntrega: 'PENDIENTE',
    fechaCreacion: new Date().toISOString()
  };

  const ventas = load(DB.VENTAS);
  ventas.push(venta);
  save(DB.VENTAS, ventas);
  toast('‚úÖ Venta guardada correctamente');
  return venta;
}

function guardarEImprimir() {
  const venta = guardarVenta();
  if (venta) {
    generarTicketVenta(venta);
    nuevaVenta();
  }
}

// Modal Item
function abrirModalItem() {
  document.getElementById('itemModalTitulo').textContent = 'Agregar Producto';
  document.getElementById('itemDescripcion').value = '';
  document.getElementById('itemCantidad').value = '1';
  document.getElementById('itemPrecio').value = '0';
  document.getElementById('itemDescuento').value = '0';
  document.getElementById('itemIndexEdit').value = '';
  document.getElementById('itemModal').showModal();
}

function guardarItem() {
  const desc = document.getElementById('itemDescripcion').value.trim();
  if (!desc) { toast('Descripci√≥n requerida', 'error'); return; }

  itemsVenta.push({
    descripcion: desc,
    cantidad: parseInt(document.getElementById('itemCantidad').value) || 1,
    precio: parseFloat(document.getElementById('itemPrecio').value) || 0,
    descuento: parseFloat(document.getElementById('itemDescuento').value) || 0
  });

  renderItemsVenta();
  cerrarModal('itemModal');
  toast('Producto agregado');
}

/* ============================================
   CLIENTES
   ============================================ */
function abrirModalCliente(cliente = null) {
  document.getElementById('clienteModalTitulo').textContent = cliente ? 'Editar Cliente' : 'Nuevo Cliente';
  document.getElementById('cliIdHidden').value = cliente?.id || '';
  document.getElementById('cliTipo').value = cliente?.tipo || 'PN';
  document.getElementById('cliDocumento').value = cliente?.documento || '';
  document.getElementById('cliNombres').value = cliente?.nombres || '';
  document.getElementById('cliTelefono').value = cliente?.telefono || '';
  document.getElementById('cliFechaNac').value = cliente?.fechaNac || '';
  document.getElementById('cliEmail').value = cliente?.email || '';
  document.getElementById('cliOcupacion').value = cliente?.ocupacion || '';
  document.getElementById('cliDireccion').value = cliente?.direccion || '';
  document.getElementById('cliSexo').value = cliente?.sexo || '';
  document.getElementById('cliEstado').value = cliente?.estado || 'H';
  calcularEdad();
  document.getElementById('clienteModal').showModal();
}

function calcularEdad() {
  const fechaNac = document.getElementById('cliFechaNac').value;
  if (fechaNac) {
    const hoy = new Date();
    const nac = new Date(fechaNac);
    let edad = hoy.getFullYear() - nac.getFullYear();
    const m = hoy.getMonth() - nac.getMonth();
    if (m < 0 || (m === 0 && hoy.getDate() < nac.getDate())) edad--;
    document.getElementById('cliEdad').value = edad;
  }
}

function guardarCliente() {
  const nombres = document.getElementById('cliNombres').value.trim();
  if (!nombres) { toast('Nombre requerido', 'error'); return; }

  const id = document.getElementById('cliIdHidden').value || genId('CLI');
  const esNuevo = !document.getElementById('cliIdHidden').value;

  const cliente = {
    id,
    tipo: document.getElementById('cliTipo').value,
    documento: document.getElementById('cliDocumento').value.trim(),
    nombres,
    telefono: document.getElementById('cliTelefono').value.trim(),
    fechaNac: document.getElementById('cliFechaNac').value,
    email: document.getElementById('cliEmail').value.trim(),
    ocupacion: document.getElementById('cliOcupacion').value.trim(),
    direccion: document.getElementById('cliDireccion').value.trim(),
    sexo: document.getElementById('cliSexo').value,
    estado: document.getElementById('cliEstado').value
  };

  const clientes = load(DB.CLIENTES);
  const idx = clientes.findIndex(c => c.id === id);
  if (idx >= 0) clientes[idx] = cliente;
  else clientes.push(cliente);
  save(DB.CLIENTES, clientes);

  cerrarModal('clienteModal');
  renderClientes();
  toast('Cliente guardado');

  // Si es un cliente nuevo y la secci√≥n activa es Ventas, seleccionarlo autom√°ticamente
  const seccionActiva = document.querySelector('section.active');
  if (esNuevo && seccionActiva && seccionActiva.id === 'ventas') {
    // Esperar un momento para que se cierre el modal
    setTimeout(() => {
      usarCliente(id);
    }, 300);
  }
}

function renderClientes() {
  const clientes = load(DB.CLIENTES);
  const medidas = load(DB.MEDIDAS);
  const filtro = (document.getElementById('buscarClienteInput')?.value || '').toLowerCase();

  const filtrados = clientes.filter(c => {
    if (!filtro) return true;
    // ‚úÖ Buscar en nombre completo (nombres + apellidos)
    const nombreCompleto = (c.nombres + ' ' + (c.apellidos || '')).trim().toLowerCase();
    return nombreCompleto.includes(filtro) || (c.documento || '').includes(filtro);
  });

  document.getElementById('clientesBody').innerHTML = filtrados.map(c => {
    const tieneRx = medidas.some(m => m.clienteId === c.id);
    const edad = c.fechaNac ? calcularEdadDesde(c.fechaNac) : '-';
    // ‚úÖ Mostrar nombre completo (nombres + apellidos)
    const nombreCompleto = (c.nombres + ' ' + (c.apellidos || '')).trim();
    return `
      <tr>
        <td>${c.documento || '-'}</td>
        <td><strong>${nombreCompleto}</strong></td>
        <td>${edad}</td>
        <td>${c.telefono || '-'}</td>
        <td>${c.email || '-'}</td>
        <td><span class="badge ${c.estado === 'H' ? 'badge-success' : 'badge-danger'}">${c.estado === 'H' ? 'H' : 'D'}</span></td>
        <td>${c.ocupacion || '-'}</td>
        <td class="text-center">
          <button class="btn btn-primary btn-sm" onclick="usarCliente('${c.id}')">‚úì Usar</button>
          <button class="btn btn-secondary btn-sm" onclick="editarCliente('${c.id}')">‚úèÔ∏è</button>
          <button class="btn btn-info btn-sm" onclick="verRxClienteModal('${c.id}')">üëÅÔ∏è Ver RX</button>
          <button class="btn btn-danger btn-sm" onclick="eliminarCliente('${c.id}')">üóëÔ∏è</button>
        </td>
      </tr>
    `;
  }).join('');

  document.getElementById('clientesCount').textContent = `Registros encontrados: ${filtrados.length}`;
}

function calcularEdadDesde(fechaNac) {
  const hoy = new Date();
  const nac = new Date(fechaNac);
  let edad = hoy.getFullYear() - nac.getFullYear();
  const m = hoy.getMonth() - nac.getMonth();
  if (m < 0 || (m === 0 && hoy.getDate() < nac.getDate())) edad--;
  return edad;
}

function usarCliente(id) {
  const c = load(DB.CLIENTES).find(x => x.id === id);
  if (!c) return;

  // ‚úÖ Mostrar nombre completo (una sola vez)
  const nombreCompleto = (c.nombres + ' ' + (c.apellidos || '')).trim();

  document.getElementById('clienteId').value = c.id;
  document.getElementById('clienteNombre').value = nombreCompleto;

  const tieneRx = load(DB.MEDIDAS).some(m => m.clienteId === id);
  document.getElementById('badgeMedida').textContent = tieneRx ? 'CON MEDIDA' : 'SIN MEDIDA';
  document.getElementById('badgeMedida').className = `badge ${tieneRx ? 'badge-success' : 'badge-danger'}`;

  mostrarSeccion('ventas');
  toast(`Cliente: ${nombreCompleto}`);
}

function editarCliente(id) {
  const c = load(DB.CLIENTES).find(x => x.id === id);
  if (c) abrirModalCliente(c);
}

function eliminarCliente(id) {
  const clientes = load(DB.CLIENTES);
  const cliente = clientes.find(c => c.id === id);

  if (!cliente) {
    toast('Cliente no encontrado', 'error');
    return;
  }

  const nombreCompleto = (cliente.nombres + ' ' + (cliente.apellidos || '')).trim();

  // Verificar si tiene prescripciones
  const medidas = load(DB.MEDIDAS);
  const tieneRx = medidas.filter(m => m.clienteId === id);

  // Verificar si tiene ventas
  const ventas = load(DB.VENTAS);
  const tieneVentas = ventas.filter(v => v.clienteId === id);

  let mensaje = `¬øEst√° seguro de eliminar al cliente "${nombreCompleto}"?`;

  if (tieneRx.length > 0 || tieneVentas.length > 0) {
    mensaje += `\n\nADVERTENCIA: Este cliente tiene:\n`;
    if (tieneRx.length > 0) mensaje += `- ${tieneRx.length} prescripci√≥n(es)\n`;
    if (tieneVentas.length > 0) mensaje += `- ${tieneVentas.length} venta(s)\n`;
    mensaje += `\nEstos registros tambi√©n ser√°n eliminados.`;
  }

  if (!confirm(mensaje)) return;

  // Eliminar cliente
  const clientesActualizados = clientes.filter(c => c.id !== id);
  save(DB.CLIENTES, clientesActualizados);

  // Eliminar prescripciones asociadas
  if (tieneRx.length > 0) {
    const medidasActualizadas = medidas.filter(m => m.clienteId !== id);
    save(DB.MEDIDAS, medidasActualizadas);
  }

  // Eliminar ventas asociadas
  if (tieneVentas.length > 0) {
    const ventasActualizadas = ventas.filter(v => v.clienteId !== id);
    save(DB.VENTAS, ventasActualizadas);
  }

  toast(`Cliente "${nombreCompleto}" eliminado correctamente`, 'success');
  renderClientes();
}

/* ============================================
   CONSULTAS - HISTORIAL DE CLIENTES
   ============================================ */
function buscarClientesConsulta() {
  const texto = document.getElementById('consultaBuscarCliente').value.toLowerCase().trim();
  const clientes = load(DB.CLIENTES);

  if (texto.length < 2) {
    document.getElementById('consultaListaClientes').innerHTML = '<div style="padding: 30px; text-align: center; color: #9ca3af;">Escribe al menos 2 caracteres</div>';
    return;
  }

  const filtrados = clientes.filter(c => {
    const nombreCompleto = (c.apellidos + ' ' + c.nombres).toLowerCase();
    return nombreCompleto.includes(texto) || (c.documento && c.documento.includes(texto));
  });

  if (filtrados.length === 0) {
    document.getElementById('consultaListaClientes').innerHTML = '<div style="padding: 30px; text-align: center; color: #9ca3af;">No se encontraron clientes</div>';
    return;
  }

  document.getElementById('consultaListaClientes').innerHTML = filtrados.map(c => {
    const nombreCompleto = (c.apellidos + ' ' + c.nombres).trim();
    const medidas = load(DB.MEDIDAS).filter(m => m.clienteId === c.id);
    return `
      <div onclick="mostrarDetalleConsulta('${c.id}')" style="padding: 12px; border-bottom: 1px solid #e5e7eb; cursor: pointer; transition: all 0.2s;"
           onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='white'">
        <div style="font-weight: 600; color: #374151;">${nombreCompleto}</div>
        <div style="font-size: 12px; color: #6b7280; margin-top: 4px;">
          ${c.documento ? 'DNI: ' + c.documento : 'Sin documento'}<br>
          ${medidas.length} prescripci√≥n(es)
        </div>
      </div>
    `;
  }).join('');
}
window.buscarClientesConsulta = buscarClientesConsulta;

function mostrarDetalleConsulta(clienteId) {
  const cliente = load(DB.CLIENTES).find(c => c.id === clienteId);
  if (!cliente) return;

  // Guardar ID del cliente seleccionado para exportaci√≥n
  clienteSeleccionadoConsulta = clienteId;

  const nombreCompleto = (cliente.apellidos + ' ' + cliente.nombres).trim();
  const medidas = load(DB.MEDIDAS).filter(m => m.clienteId === clienteId).sort((a, b) => (b.fecha || '').localeCompare(a.fecha || ''));

  const html = `
    <div style="background: linear-gradient(135deg, #6b21a8 0%, #9333ea 100%); color: white; padding: 20px;">
      <h2 style="margin: 0; font-size: 24px;">${nombreCompleto}</h2>
      <div style="margin-top: 8px; opacity: 0.9;">
        <div>üìÑ DNI: ${cliente.documento || 'No registrado'}</div>
        <div>üìû Tel√©fono: ${cliente.telefono || 'No registrado'}</div>
        <div>üìß Email: ${cliente.email || 'No registrado'}</div>
        <div>üíº Ocupaci√≥n: ${cliente.ocupacion || 'No registrada'}</div>
        <div>üéÇ Edad: ${cliente.edad || 'No registrada'} a√±os</div>
      </div>
    </div>

    <div style="padding: 20px;">
      <div style="display: flex; gap: 12px; margin-bottom: 16px;">
        <button class="btn btn-success" onclick="usarClienteEnVenta('${clienteId}')">üõí Usar en Venta</button>
        <button class="btn btn-primary" onclick="abrirPrescripcion('${clienteId}')">üìã Nueva Prescripci√≥n</button>
        <button class="btn btn-info" onclick="editarCliente('${clienteId}')">‚úèÔ∏è Editar Cliente</button>
        <button class="btn btn-danger" onclick="eliminarClienteConsulta('${clienteId}')">üóëÔ∏è Eliminar</button>
      </div>

      <h3 style="color: #6b21a8; margin-top: 24px; margin-bottom: 12px;">üìã Historial de Prescripciones (${medidas.length})</h3>

      ${medidas.length === 0 ? `
        <div style="padding: 40px; text-align: center; background: #f9fafb; border-radius: 8px; color: #6b7280;">
          No hay prescripciones registradas para este cliente
        </div>
      ` : `
        <div style="max-height: 400px; overflow-y: auto;">
          <table style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="background: #f3f4f6; position: sticky; top: 0;">
                <th style="padding: 10px; text-align: left; border: 1px solid #e5e7eb;">Fecha</th>
                <th style="padding: 10px; text-align: left; border: 1px solid #e5e7eb;">Especialista</th>
                <th style="padding: 10px; text-align: left; border: 1px solid #e5e7eb;">Tipo</th>
                <th style="padding: 10px; text-align: center; border: 1px solid #e5e7eb;">Acciones</th>
              </tr>
            </thead>
            <tbody>
              ${medidas.map(m => `
                <tr style="border-bottom: 1px solid #e5e7eb;">
                  <td style="padding: 10px; border: 1px solid #e5e7eb;">${formatDate(m.fecha)}</td>
                  <td style="padding: 10px; border: 1px solid #e5e7eb;">${m.especialista || '-'}</td>
                  <td style="padding: 10px; border: 1px solid #e5e7eb;">
                    ${m.tipo || 'PROPIA'}
                    ${m.excepcion === 'Duplicado' ? '<span style="color: #dc2626; font-weight: bold; margin-left: 8px;">[DUPLICADO]</span>' : ''}
                  </td>
                  <td style="padding: 10px; text-align: center; border: 1px solid #e5e7eb;">
                    <button class="btn btn-info btn-sm" onclick="verMedidaConsulta('${m.id}')" style="margin-right: 5px;">üëÅÔ∏è Ver</button>
                    <button class="btn btn-danger btn-sm" onclick="borrarMedidaConsulta('${m.id}')">üóëÔ∏è</button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `}
    </div>
  `;

  document.getElementById('consultaDetalleCliente').innerHTML = html;
}
window.mostrarDetalleConsulta = mostrarDetalleConsulta;

function usarClienteEnVenta(clienteId) {
  usarCliente(clienteId);
  mostrarSeccion('ventas');
}
window.usarClienteEnVenta = usarClienteEnVenta;

function eliminarClienteConsulta(clienteId) {
  if (!confirm('¬øEst√° seguro de eliminar este cliente? Esta acci√≥n no se puede deshacer.')) return;

  let clientes = load(DB.CLIENTES);
  clientes = clientes.filter(c => c.id !== clienteId);
  save(DB.CLIENTES, clientes);

  // Actualizar vista
  buscarClientesConsulta();
  document.getElementById('consultaDetalleCliente').innerHTML = '<div style="padding: 30px; text-align: center; color: #9ca3af;">Cliente eliminado</div>';
  toast('Cliente eliminado correctamente', 'success');
}
window.eliminarClienteConsulta = eliminarClienteConsulta;

function verMedidaConsulta(medidaId) {
  const medida = load(DB.MEDIDAS).find(m => m.id === medidaId);
  if (!medida) {
    toast('No se encontr√≥ la prescripci√≥n', 'error');
    return;
  }

  // Abrir la ventana de prescripci√≥n y cargar los datos
  abrirPrescripcion(medida.clienteId);
  setTimeout(() => {
    cargarPrescripcion(medida);
  }, 100);
}
window.verMedidaConsulta = verMedidaConsulta;

function borrarMedidaConsulta(medidaId) {
  if (!confirm('¬øEst√° seguro de eliminar esta prescripci√≥n?')) return;

  let medidas = load(DB.MEDIDAS);
  const medida = medidas.find(m => m.id === medidaId);
  const clienteId = medida?.clienteId;

  medidas = medidas.filter(m => m.id !== medidaId);
  save(DB.MEDIDAS, medidas);

  toast('Prescripci√≥n eliminada', 'success');

  // Refrescar la vista del cliente
  if (clienteId) {
    mostrarDetalleConsulta(clienteId);
  }
}
window.borrarMedidaConsulta = borrarMedidaConsulta;

// Variable global para guardar el ID del cliente seleccionado
let clienteSeleccionadoConsulta = null;

function exportarTodosClientesConsulta() {
  const clientes = load(DB.CLIENTES);
  const medidas = load(DB.MEDIDAS);

  if (clientes.length === 0) {
    toast('No hay clientes para exportar', 'warning');
    return;
  }

  // Headers del Excel
  const headers = [
    'N¬∞', 'APELLIDOS Y NOMBRES', 'EDAD', 'DOCUMENTO', 'TELEFONO',
    'OJO DERECHO (OD)', 'OJO IZQUIERDO (OI)', 'MONTURAS', 'CRISTALES',
    'PRECIO', 'ADELANTO', 'DEUDA', 'FECHA VENTA', 'FECHA ENTREGA', 'OBSERVACIONES'
  ];

  const rows = [];
  let numero = 1;

  clientes.forEach(cliente => {
    const nombreCompleto = (cliente.apellidos + ' ' + cliente.nombres).trim();
    const medidasCliente = medidas.filter(m => m.clienteId === cliente.id)
      .sort((a, b) => (b.fecha || '').localeCompare(a.fecha || ''));

    if (medidasCliente.length === 0) {
      // Cliente sin prescripciones
      rows.push([
        numero++,
        nombreCompleto,
        cliente.edad || '-',
        cliente.documento || '-',
        cliente.telefono || '-',
        '-', '-', '-', '-',
        '0.00', '0.00', '0.00',
        '-', '-',
        'Sin prescripciones'
      ]);
    } else {
      // Cliente con prescripciones
      medidasCliente.forEach(m => {
        const od = `${m.lejosOdEsf || ''}/${m.lejosOdCil || ''}${m.lejosOdEje ? 'X' + m.lejosOdEje : ''}`;
        const oi = `${m.lejosOiEsf || ''}/${m.lejosOiCil || ''}${m.lejosOiEje ? 'X' + m.lejosOiEje : ''}`;

        rows.push([
          numero++,
          nombreCompleto,
          m.edad || cliente.edad || '-',
          cliente.documento || '-',
          cliente.telefono || '-',
          od,
          oi,
          m.rxMonturas || '-',
          m.rxCristales || '-',
          '0.00', // Precio (se puede agregar si existe en la BD)
          '0.00', // Adelanto
          '0.00', // Deuda
          formatDate(m.fecha),
          '-', // Fecha entrega
          m.rxObservacion || '-'
        ]);
      });
    }
  });

  const csv = generarCSV(headers, rows);
  descargarCSV(csv, `historial_clientes_completo_${today()}.csv`);
  toast(`Exportados ${clientes.length} clientes con ${rows.length} registros`, 'success');
}
window.exportarTodosClientesConsulta = exportarTodosClientesConsulta;

function exportarHistorialSeleccionado() {
  if (!clienteSeleccionadoConsulta) {
    toast('Primero selecciona un cliente', 'warning');
    return;
  }

  const cliente = load(DB.CLIENTES).find(c => c.id === clienteSeleccionadoConsulta);
  if (!cliente) {
    toast('Cliente no encontrado', 'error');
    return;
  }

  const medidas = load(DB.MEDIDAS).filter(m => m.clienteId === clienteSeleccionadoConsulta)
    .sort((a, b) => (b.fecha || '').localeCompare(a.fecha || ''));

  const nombreCompleto = (cliente.apellidos + ' ' + cliente.nombres).trim();

  const headers = [
    'FECHA', 'ESPECIALISTA', 'TIPO', 'OD ESF', 'OD CIL', 'OD EJE',
    'OI ESF', 'OI CIL', 'OI EJE', 'MONTURAS', 'CRISTALES', 'OBSERVACIONES'
  ];

  const rows = medidas.map(m => [
    formatDate(m.fecha),
    m.especialista || '-',
    m.tipo || 'PROPIA',
    m.lejosOdEsf || '',
    m.lejosOdCil || '',
    m.lejosOdEje || '',
    m.lejosOiEsf || '',
    m.lejosOiCil || '',
    m.lejosOiEje || '',
    m.rxMonturas || '-',
    m.rxCristales || '-',
    m.rxObservacion || '-'
  ]);

  const csv = [
    `"HISTORIAL DE: ${nombreCompleto}"`,
    `"DNI: ${cliente.documento || 'No registrado'}"`,
    `"TELEFONO: ${cliente.telefono || 'No registrado'}"`,
    '',
    headers.join(','),
    ...rows.map(r => r.map(c => `"${c}"`).join(','))
  ].join('\n');

  descargarCSV(csv, `historial_${nombreCompleto.replace(/\s+/g, '_')}_${today()}.csv`);
  toast(`Exportado historial de ${nombreCompleto}`, 'success');
}
window.exportarHistorialSeleccionado = exportarHistorialSeleccionado;

/* ============================================
   BUSCAR VENTAS
   ============================================ */
// Variables movidas al inicio del script (l√≠neas 9700, 9705)

document.getElementById('buscarVentaFechas').onchange = function() {
  const mostrar = this.value === 'RANGO';
  document.getElementById('fechaDesdeContainer').style.display = mostrar ? 'block' : 'none';
  document.getElementById('fechaHastaContainer').style.display = mostrar ? 'block' : 'none';
};

function buscarVentas() {
  const ventas = load(DB.VENTAS);
  const tipo = document.getElementById('buscarVentaTipo').value;
  const fechas = document.getElementById('buscarVentaFechas').value;
  const texto = document.getElementById('buscarVentaTexto').value.toLowerCase();
  const estadoPago = document.getElementById('buscarEstadoPago').value;
  const estadoEntrega = document.getElementById('buscarEstadoEntrega').value;

  let filtradas = ventas.filter(v => {
    // Filtro por tipo de b√∫squeda
    if (tipo === 'DNI' && texto) {
      const cliente = load(DB.CLIENTES).find(c => c.id === v.clienteId);
      if (!cliente || !cliente.documento.toLowerCase().includes(texto)) return false;
    }
    if (tipo === 'NOMBRE' && texto && !v.clienteNombre.toLowerCase().includes(texto)) return false;
    if (tipo === 'NROVENTA' && texto && !v.docNumero.includes(texto)) return false;

    // Filtro por fechas
    const hoy = today();
    if (fechas === 'HOY' && v.fechaEmision !== hoy) return false;
    if (fechas === 'SEMANA') {
      const hace7dias = new Date();
      hace7dias.setDate(hace7dias.getDate() - 7);
      if (new Date(v.fechaEmision) < hace7dias) return false;
    }
    if (fechas === 'MES') {
      const hace30dias = new Date();
      hace30dias.setDate(hace30dias.getDate() - 30);
      if (new Date(v.fechaEmision) < hace30dias) return false;
    }
    if (fechas === 'RANGO') {
      const desde = document.getElementById('buscarFechaDesde').value;
      const hasta = document.getElementById('buscarFechaHasta').value;
      if (desde && v.fechaEmision < desde) return false;
      if (hasta && v.fechaEmision > hasta) return false;
    }

    // Filtro por estado
    if (estadoPago && v.estadoPago !== estadoPago) return false;
    if (estadoEntrega && v.estadoEntrega !== estadoEntrega) return false;

    return true;
  });

  ventasPaginadas = filtradas;
  paginaActual = 0;
  renderVentasTabla();
}

function renderVentasTabla() {
  const porPagina = parseInt(document.getElementById('registrosPorPagina').value) || 10;
  const inicio = paginaActual * porPagina;
  const fin = inicio + porPagina;
  const ventas = ventasPaginadas.slice(inicio, fin);

  let totalSum = 0, cobradoSum = 0, saldoSum = 0;
  ventasPaginadas.forEach(v => {
    totalSum += v.totalPagar;
    cobradoSum += v.pagado || v.totalPagar;
    saldoSum += v.saldo || 0;
  });

  document.getElementById('totalVentasSum').textContent = `S/ ${totalSum.toFixed(2)}`;
  document.getElementById('cobradoSum').textContent = `S/ ${cobradoSum.toFixed(2)}`;
  document.getElementById('saldoSum').textContent = `S/ ${saldoSum.toFixed(2)}`;

  const clientes = load(DB.CLIENTES);

  document.getElementById('ventasBody').innerHTML = ventas.map(v => {
    const cliente = clientes.find(c => c.id === v.clienteId);
    return `
      <tr>
        <td class="text-center"><input type="checkbox" class="venta-check" data-id="${v.id}"></td>
        <td>${v.vendedor}</td>
        <td>${v.clienteNombre}</td>
        <td>${v.docTipo} ${v.docSerie}-${v.docNumero}</td>
        <td class="text-right">S/ ${v.totalPagar.toFixed(2)}</td>
        <td class="text-right">S/ ${(v.pagado || v.totalPagar).toFixed(2)}</td>
        <td class="text-right">S/ ${(v.saldo || 0).toFixed(2)}</td>
        <td>${formatDate(v.fechaEmision)}</td>
        <td class="text-center"><span class="badge ${v.estadoEntrega === 'ENTREGADO' ? 'badge-success' : 'badge-warning'}">${v.estadoEntrega}</span></td>
        <td class="text-center"><span class="badge ${v.estadoPago === 'PAGADO' ? 'badge-success' : 'badge-warning'}">${v.estadoPago}</span></td>
        <td>${cliente?.telefono || '-'}</td>
      </tr>
    `;
  }).join('');

  const totalPaginas = Math.ceil(ventasPaginadas.length / porPagina);
  document.getElementById('ventasResumen').textContent = `Registros Encontrados: ${ventasPaginadas.length}`;
  document.getElementById('paginaInfo').textContent = `P√°gina ${paginaActual + 1} de: ${totalPaginas || 1}`;
}

function paginaAnterior() {
  if (paginaActual > 0) {
    paginaActual--;
    renderVentasTabla();
  }
}

function paginaSiguiente() {
  const porPagina = parseInt(document.getElementById('registrosPorPagina').value) || 10;
  const totalPaginas = Math.ceil(ventasPaginadas.length / porPagina);
  if (paginaActual < totalPaginas - 1) {
    paginaActual++;
    renderVentasTabla();
  }
}

function toggleSeleccionarTodos() {
  const checked = document.getElementById('seleccionarTodos').checked;
  document.querySelectorAll('.venta-check').forEach(cb => cb.checked = checked);
}

function getVentasSeleccionadas() {
  return Array.from(document.querySelectorAll('.venta-check:checked')).map(cb => cb.dataset.id);
}

function verDetalleVentaSeleccionada() {
  const ids = getVentasSeleccionadas();
  if (ids.length !== 1) { toast('Selecciona una venta', 'warning'); return; }
  verDetalleVenta(ids[0]);
}

let ventaActualDetalle = null;

function verDetalleVenta(id) {
  const v = load(DB.VENTAS).find(x => x.id === id);
  if (!v) return;
  ventaActualDetalle = v;

  let html = `
    <div style="text-align: center; margin-bottom: 20px;">
      <h2 style="color: var(--purple-700);">Centro √ìptico Sicuani</h2>
      <p><strong>${v.docTipo}</strong> ${v.docSerie}-${v.docNumero}</p>
      <p>Fecha: ${formatDate(v.fechaEmision)}</p>
    </div>
    <p><strong>Cliente:</strong> ${v.clienteNombre}</p>
    <p><strong>Vendedor:</strong> ${v.vendedor}</p>
    <hr style="margin: 15px 0;">
    <table style="width: 100%; font-size: 12px;">
      <thead><tr><th>Descripci√≥n</th><th>Cant</th><th>P.Unit</th><th>Total</th></tr></thead>
      <tbody>
  `;

  v.items.forEach(item => {
    const importe = (item.cantidad * item.precio) - item.descuento;
    html += `<tr><td>${item.descripcion}</td><td>${item.cantidad}</td><td>S/ ${item.precio.toFixed(2)}</td><td>S/ ${importe.toFixed(2)}</td></tr>`;
  });

  html += `
      </tbody>
    </table>
    <hr style="margin: 15px 0;">
    <p style="text-align: right; font-size: 18px;"><strong>TOTAL: S/ ${v.totalPagar.toFixed(2)}</strong></p>
  `;

  if (v.observacion) html += `<p><strong>Obs:</strong> ${v.observacion}</p>`;

  document.getElementById('detalleVentaContenido').innerHTML = html;
  document.getElementById('detalleVentaModal').showModal();
}

function imprimirVentaSeleccionada() {
  const ids = getVentasSeleccionadas();
  if (ids.length !== 1) { toast('Selecciona una venta', 'warning'); return; }
  const v = load(DB.VENTAS).find(x => x.id === ids[0]);
  if (!v) { toast('Venta no encontrada', 'error'); return; }
  generarTicketVenta(v);
}

function exportarVentasExcel() {
  if (ventasPaginadas.length === 0) { toast('No hay ventas para exportar', 'warning'); return; }

  const headers = ['Fecha', 'Documento', 'Cliente', 'Total', 'Pagado', 'Saldo', 'Estado Pago', 'Estado Entrega'];
  const rows = ventasPaginadas.map(v => [
    v.fechaEmision,
    `${v.docTipo} ${v.docSerie}-${v.docNumero}`,
    v.clienteNombre,
    v.totalPagar.toFixed(2),
    (v.pagado || v.totalPagar).toFixed(2),
    (v.saldo || 0).toFixed(2),
    v.estadoPago,
    v.estadoEntrega
  ]);

  const csv = generarCSV(headers, rows);
  descargarCSV(csv, 'ventas_optica.csv');
  toast('Ventas exportadas');
}

function cambiarEstadoEntrega() {
  const ids = getVentasSeleccionadas();
  if (ids.length === 0) { toast('Selecciona ventas', 'warning'); return; }
  document.getElementById('estadoEntregaModal').showModal();
}

function confirmarCambioEstado() {
  const ids = getVentasSeleccionadas();
  const nuevoEstado = document.getElementById('nuevoEstadoEntrega').value;
  const ventas = load(DB.VENTAS);

  ids.forEach(id => {
    const v = ventas.find(x => x.id === id);
    if (v) v.estadoEntrega = nuevoEstado;
  });

  save(DB.VENTAS, ventas);
  cerrarModal('estadoEntregaModal');
  buscarVentas();
  toast('Estado actualizado');
}

function anularVentasSeleccionadas() {
  const ids = getVentasSeleccionadas();
  if (ids.length === 0) { toast('Selecciona ventas', 'warning'); return; }
  if (!confirm(`¬øAnular ${ids.length} venta(s)?`)) return;

  let ventas = load(DB.VENTAS);
  ventas = ventas.filter(v => !ids.includes(v.id));
  save(DB.VENTAS, ventas);
  buscarVentas();
  toast('Ventas anuladas');
}

function cerrarBusquedaVentas() {
  mostrarSeccion('ventas');
}

/* ============================================
   PRESCRIPCIONES
   ============================================ */

// Ya no se necesita funci√≥n de tabs - ahora todo es pantalla completa con scroll
// Esta funci√≥n se mantiene vac√≠a para compatibilidad
function inicializarTabsPrescripcion() {
  console.log('‚úÖ Modo pantalla completa activado - No se requieren tabs');
}

function verMedidaCliente() {
  const clienteId = document.getElementById('clienteId').value;
  if (!clienteId) {
    toast('‚ö†Ô∏è Selecciona un cliente primero', 'warning');
    return;
  }
  // Usar modal ultra moderno de visualizaci√≥n RX
  verRxClienteModal(clienteId);
}

function nuevaMedidaCliente() {
  const clienteId = document.getElementById('clienteId').value;
  if (!clienteId) {
    toast('‚ö†Ô∏è Selecciona un cliente primero', 'warning');
    return;
  }
  // Abrir formulario completo para crear nueva prescripci√≥n
  abrirPrescripcion(clienteId, true);
}

function verPrescripcionCliente(clienteId) {
  // Usar modal ultra moderno de visualizaci√≥n RX
  verRxClienteModal(clienteId);
}

function abrirPrescripcion(clienteId, esNueva = false) {
  const cliente = load(DB.CLIENTES).find(c => c.id === clienteId);
  if (!cliente) {
    toast('‚ùå Cliente no encontrado', 'error');
    return;
  }

  // ‚úÖ Mostrar nombre completo en formulario de prescripci√≥n (soportar nombres/nombre y apellidos/apellido)
  const nombre = cliente.nombre || cliente.nombres || '';
  const apellido = cliente.apellidos || cliente.apellido || '';
  const nombreCompleto = (nombre + ' ' + apellido).trim();

  document.getElementById('rxClienteNombre').textContent = nombreCompleto;
  document.getElementById('rxPaciente').value = nombreCompleto;
  document.getElementById('rxOcupacion').value = cliente.ocupacion || '';
  document.getElementById('rxClienteIdHidden').value = clienteId;

  // Calcular edad desde fecha de nacimiento
  if (cliente.fechaNacimiento || cliente.fechaNac) {
    const fechaNac = cliente.fechaNacimiento || cliente.fechaNac;
    const hoy = new Date();
    const nacimiento = new Date(fechaNac);
    const edad = Math.floor((hoy - nacimiento) / (365.25 * 24 * 60 * 60 * 1000));
    document.getElementById('rxEdad').value = edad;
  }

  document.getElementById('rxFecha').value = today();

  if (esNueva) {
    limpiarFormularioRx();
    toast('‚úÖ Nueva RX iniciada para ' + nombreCompleto, 'success');
  } else {
    // Cargar √∫ltima consulta/RX del paciente
    const consultas = load(DB.CONSULTAS_CLINICAS).filter(c => c.idCliente === clienteId)
      .sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

    if (consultas.length > 0) {
      // Cargar datos de la consulta m√°s reciente
      const ultima = consultas[0];
      cargarPrescripcion(ultima);
      toast('‚úÖ RX cargada: ' + (ultima.fechaFormato || '√öltima consulta'), 'success');
    } else {
      limpiarFormularioRx();
      toast('‚ÑπÔ∏è No hay RX previa. Mostrando formulario nuevo', 'info');
    }
  }

  // Mostrar ventana en modo pantalla completa
  const ventana = document.getElementById('prescripcionWindow');
  ventana.style.display = 'flex';
  ventana.style.zIndex = 200;
  ventana.style.height = '85vh'; // Altura adaptativa al viewport
  ventana.style.width = '95vw'; // Ancho adaptativo
  ventana.style.maxWidth = '1400px'; // M√°ximo ancho para pantallas grandes

  // Asegurar que el contenido sea visible
  const mdiContent = ventana.querySelector('.mdi-content');
  if (mdiContent) {
    mdiContent.style.display = 'block';
    mdiContent.style.height = 'auto';
  }

  // Scroll suave al inicio del contenido
  const rxContent = document.querySelector('.rx-fullscreen-content');
  if (rxContent) {
    setTimeout(() => {
      rxContent.scrollTop = 0;
      console.log('‚úÖ Prescripci√≥n abierta en modo pantalla completa');
    }, 100);
  }

  // Renderizar historial autom√°ticamente
  renderHistorialRx();
}

function limpiarFormularioRx() {
  document.getElementById('rxIdHidden').value = '';

  const campos = [
    'lejosOdEsf', 'lejosOdCil', 'lejosOdEje', 'lejosDip', 'lejosOdNp', 'lejosOdPrisma', 'lejosOdAdd', 'lejosOdAddMedia',
    'lejosOiEsf', 'lejosOiCil', 'lejosOiEje', 'lejosOiNp', 'lejosOiPrisma', 'lejosOiAdd', 'lejosOiAddMedia',
    'cercaOdEsf', 'cercaOdCil', 'cercaOdEje', 'cercaDip', 'cercaOdNp', 'cercaOdPrisma', 'cercaAltura',
    'cercaOiEsf', 'cercaOiCil', 'cercaOiEje', 'cercaOiNp', 'cercaOiPrisma',
    'interOdEsf', 'interOdCil', 'interOdEje', 'interDip', 'interOdNp', 'interOdPrisma', 'interDtra',
    'interOiEsf', 'interOiCil', 'interOiEje', 'interOiNp', 'interOiPrisma',
    'lcOdH', 'lcOdV', 'lcOdEje', 'lcOdCb', 'lcOdPoder', 'lcOdDiametro', 'lcOdContacto',
    'lcOiH', 'lcOiV', 'lcOiEje', 'lcOiCb', 'lcOiPoder', 'lcOiDiametro', 'lcOiContacto',
    'lcTipoLente', 'lcBiomicroscopio', 'rxObservacion', 'otrosNotas',
    'histSintomas', 'histAntecedentes', 'histExamen',
    'oftTratamiento', 'oftOtrosExamenes', 'oftTonoOd', 'oftTonoOi',
    'oftCcOdLejos', 'oftCcOdCerca', 'oftCcOiLejos', 'oftCcOiCerca', 'oftCcAdLejos', 'oftCcAdCerca',
    'oftScOdLejos', 'oftScOdCerca', 'oftScOdPh', 'oftScOiLejos', 'oftScOiCerca', 'oftScOiPh', 'oftScAdLejos', 'oftScAdCerca'
  ];

  campos.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = '';
  });

  ['lejosOdAv', 'lejosOiAv', 'cercaOdAv', 'cercaOiAv', 'interOdAv', 'interOiAv'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = '20/';
  });

  document.getElementById('otrosTipoLente').value = '';
  document.getElementById('otrosMaterial').value = '';
  document.getElementById('otrosTratamiento').value = '';
  document.getElementById('oftCie10').value = '';
}

function cargarPrescripcion(rx) {
  document.getElementById('rxIdHidden').value = rx.id;
  document.getElementById('rxFecha').value = rx.fecha || '';
  document.getElementById('rxProximaCita').value = rx.proximaCita || '';

  // Cargar todos los campos si existen
  Object.keys(rx).forEach(key => {
    const el = document.getElementById(key);
    if (el) {
      // ‚úÖ CHECKBOXES - Usar .checked en lugar de .value
      if (el.type === 'checkbox') {
        el.checked = rx[key] === true || rx[key] === 'true';
      }
      // ‚úÖ CAMPOS DE TEXTO - Usar .value
      else if (typeof rx[key] === 'string') {
        el.value = rx[key];
      }
    }
  });
}

function guardarPrescripcion() {
  const clienteId = document.getElementById('rxClienteIdHidden').value;
  if (!clienteId) { toast('No hay cliente', 'error'); return; }

  const id = document.getElementById('rxIdHidden').value || genId('RX');

  const rx = {
    id,
    clienteId,
    codigo: id.split('_')[1],
    fecha: document.getElementById('rxFecha').value,
    proximaCita: document.getElementById('rxProximaCita').value,
    especialista: document.getElementById('rxEspecialista').value,
    tipo: document.querySelector('input[name="rxTipo"]:checked')?.value || 'PROPIA',
    ocupacion: document.getElementById('rxOcupacion').value,
    edad: document.getElementById('rxEdad').value,

    // Visi√≥n Lejos
    lejosOdEsf: document.getElementById('lejosOdEsf').value,
    lejosOdCil: document.getElementById('lejosOdCil').value,
    lejosOdEje: document.getElementById('lejosOdEje').value,
    lejosOdAv: document.getElementById('lejosOdAv').value,
    lejosDip: document.getElementById('lejosDip').value,
    lejosOdNp: document.getElementById('lejosOdNp').value,
    lejosOdPrisma: document.getElementById('lejosOdPrisma').value,
    lejosOdAdd: document.getElementById('lejosOdAdd').value,
    lejosOdAddMedia: document.getElementById('lejosOdAddMedia').value,
    lejosOiEsf: document.getElementById('lejosOiEsf').value,
    lejosOiCil: document.getElementById('lejosOiCil').value,
    lejosOiEje: document.getElementById('lejosOiEje').value,
    lejosOiAv: document.getElementById('lejosOiAv').value,
    lejosOiNp: document.getElementById('lejosOiNp').value,
    lejosOiPrisma: document.getElementById('lejosOiPrisma').value,
    lejosOiAdd: document.getElementById('lejosOiAdd').value,
    lejosOiAddMedia: document.getElementById('lejosOiAddMedia').value,

    // Visi√≥n Cerca
    cercaOdEsf: document.getElementById('cercaOdEsf').value,
    cercaOdCil: document.getElementById('cercaOdCil').value,
    cercaOdEje: document.getElementById('cercaOdEje').value,
    cercaOdAv: document.getElementById('cercaOdAv').value,
    cercaDip: document.getElementById('cercaDip').value,
    cercaOdNp: document.getElementById('cercaOdNp').value,
    cercaOdPrisma: document.getElementById('cercaOdPrisma').value,
    cercaAltura: document.getElementById('cercaAltura').value,
    cercaOiEsf: document.getElementById('cercaOiEsf').value,
    cercaOiCil: document.getElementById('cercaOiCil').value,
    cercaOiEje: document.getElementById('cercaOiEje').value,
    cercaOiAv: document.getElementById('cercaOiAv').value,
    cercaOiNp: document.getElementById('cercaOiNp').value,
    cercaOiPrisma: document.getElementById('cercaOiPrisma').value,

    // Observaci√≥n
    rxObservacion: document.getElementById('rxObservacion')?.value || '',

    // TAB OTROS
    otrosTipoLente: document.getElementById('otrosTipoLente')?.value || '',
    otrosMaterial: document.getElementById('otrosMaterial')?.value || '',
    otrosTratamiento: document.getElementById('otrosTratamiento')?.value || '',
    otrosNotas: document.getElementById('otrosNotas')?.value || '',

    // TAB LC (Lentes de Contacto)
    lcOdH: document.getElementById('lcOdH')?.value || '',
    lcOdV: document.getElementById('lcOdV')?.value || '',
    lcOdEje: document.getElementById('lcOdEje')?.value || '',
    lcOdCb: document.getElementById('lcOdCb')?.value || '',
    lcOdPoder: document.getElementById('lcOdPoder')?.value || '',
    lcOdDiametro: document.getElementById('lcOdDiametro')?.value || '',
    lcOdContacto: document.getElementById('lcOdContacto')?.value || '',
    lcOiH: document.getElementById('lcOiH')?.value || '',
    lcOiV: document.getElementById('lcOiV')?.value || '',
    lcOiEje: document.getElementById('lcOiEje')?.value || '',
    lcOiCb: document.getElementById('lcOiCb')?.value || '',
    lcOiPoder: document.getElementById('lcOiPoder')?.value || '',
    lcOiDiametro: document.getElementById('lcOiDiametro')?.value || '',
    lcOiContacto: document.getElementById('lcOiContacto')?.value || '',
    lcTipoLente: document.getElementById('lcTipoLente')?.value || '',
    lcBiomicroscopio: document.getElementById('lcBiomicroscopio')?.value || '',

    // TAB HISTORIAL CL√çNICO
    histSintomas: document.getElementById('histSintomas')?.value || '',
    histAntecedentes: document.getElementById('histAntecedentes')?.value || '',
    histExamen: document.getElementById('histExamen')?.value || '',

    // TAB OFTALMOLOG√çA
    oftTratamiento: document.getElementById('oftTratamiento')?.value || '',
    oftOtrosExamenes: document.getElementById('oftOtrosExamenes')?.value || '',

    // ‚úÖ DIAGN√ìSTICOS - GUARDAR VALORES DE CHECKBOXES
    diagMiopia: document.getElementById('diagMiopia')?.checked || false,
    diagHipermetropia: document.getElementById('diagHipermetropia')?.checked || false,
    diagAstigmatismo: document.getElementById('diagAstigmatismo')?.checked || false,
    diagPresbicia: document.getElementById('diagPresbicia')?.checked || false,
    diagAmbliopia: document.getElementById('diagAmbliopia')?.checked || false,
    diagAnisometropia: document.getElementById('diagAnisometropia')?.checked || false,

    // ‚úÖ PIO - GUARDAR PRESI√ìN INTRAOCULAR
    rxPioOD: document.getElementById('rxPioOD')?.value || '',
    rxPioOI: document.getElementById('rxPioOI')?.value || '',

    // ‚úÖ OBSERVACIONES Y ESPECIALISTA
    rxObservaciones: document.getElementById('rxObservaciones')?.value || '',
    rxEspecialista: document.getElementById('rxEspecialista')?.value || '',

    fechaCreacion: new Date().toISOString()
  };

  const medidas = load(DB.MEDIDAS);
  const idx = medidas.findIndex(m => m.id === id);
  if (idx >= 0) medidas[idx] = rx;
  else medidas.push(rx);
  save(DB.MEDIDAS, medidas);

  document.getElementById('rxIdHidden').value = id;

  // Actualizar badge
  if (document.getElementById('clienteId').value === clienteId) {
    document.getElementById('badgeMedida').textContent = 'CON MEDIDA';
    document.getElementById('badgeMedida').className = 'badge badge-success';
  }

  toast('‚úÖ Prescripci√≥n guardada');
  renderHistorialRx();
}

function renderHistorialRx() {
  const clienteId = document.getElementById('rxClienteIdHidden').value;
  const medidas = load(DB.MEDIDAS).filter(m => m.clienteId === clienteId)
    .sort((a, b) => (b.fecha || '').localeCompare(a.fecha || ''));

  const tbody = document.getElementById('historialRxBody');
  const noHist = document.getElementById('noHistorialRx');

  if (medidas.length === 0) {
    tbody.innerHTML = '';
    noHist.style.display = 'block';
    return;
  }

  noHist.style.display = 'none';
  tbody.innerHTML = medidas.map((m, index) => `
    <tr style="animation: fadeInUp 0.3s ease ${index * 0.05}s backwards;">
      <td style="font-weight: 700; color: #3b82f6;">${m.codigo || m.id.split('_')[1]}</td>
      <td>${m.especialista || '-'}</td>
      <td>${formatDate(m.fecha)}</td>
      <td><span style="display: inline-block; background: ${m.tipo === 'PROPIA' ? '#dbeafe' : '#fef3c7'}; color: ${m.tipo === 'PROPIA' ? '#1e40af' : '#92400e'}; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 700;">${m.tipo || 'PROPIA'}</span></td>
      <td class="text-center">
        <button class="btn btn-info btn-sm" onclick="cargarRxHistorial('${m.id}')"
                style="margin-right: 6px; background: linear-gradient(135deg, #3b82f6, #2563eb); border: none; box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3); transition: all 0.2s;"
                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(59, 130, 246, 0.4)';"
                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(59, 130, 246, 0.3)';">
          üëÅÔ∏è Ver RX
        </button>
        <button class="btn btn-danger btn-sm" onclick="borrarPrescripcionHistorial('${m.id}')"
                style="background: linear-gradient(135deg, #ef4444, #dc2626); border: none; box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3); transition: all 0.2s;"
                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(239, 68, 68, 0.4)';"
                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(239, 68, 68, 0.3)';">
          üóëÔ∏è
        </button>
      </td>
    </tr>
  `).join('');
}

function cargarRxHistorial(id) {
  const rx = load(DB.MEDIDAS).find(m => m.id === id);
  if (!rx) {
    toast('‚ùå Prescripci√≥n no encontrada', 'error');
    return;
  }

  // Obtener ID del cliente desde la RX
  const clienteId = rx.clienteId;

  // Cerrar ventana de prescripci√≥n si est√° abierta
  const prescripcionWindow = document.getElementById('prescripcionWindow');
  if (prescripcionWindow) {
    prescripcionWindow.style.display = 'none';
  }

  // Abrir modal ultra moderno de visualizaci√≥n
  if (clienteId) {
    verRxClienteModal(clienteId);
    toast('üëì Visualizando prescripci√≥n en modo lectura', 'success');
  } else {
    // Fallback: cargar en formulario de edici√≥n
    cargarPrescripcion(rx);
    const rxContent = document.querySelector('.rx-fullscreen-content');
    if (rxContent) rxContent.scrollTop = 0;
    toast('‚úÖ Prescripci√≥n cargada para edici√≥n', 'success');
  }
}
window.cargarRxHistorial = cargarRxHistorial;

function borrarPrescripcionHistorial(id) {
  const rx = load(DB.MEDIDAS).find(m => m.id === id);

  if (!rx) {
    toast('‚ùå No se encontr√≥ la prescripci√≥n', 'error');
    return;
  }

  const codigo = rx.codigo || rx.id.split('_')[1];
  const fecha = formatDate(rx.fecha) || 'Sin fecha';

  if (!confirm(`‚ö†Ô∏è ¬øEst√° seguro de ELIMINAR esta prescripci√≥n?\n\nC√≥digo: ${codigo}\nFecha: ${fecha}\n\n‚ö†Ô∏è Esta acci√≥n NO se puede deshacer.`)) {
    return;
  }

  const medidas = load(DB.MEDIDAS);
  const index = medidas.findIndex(m => m.id === id);

  if (index !== -1) {
    medidas.splice(index, 1);
    save(DB.MEDIDAS, medidas);
    renderHistorialRx();
    toast('‚úÖ Prescripci√≥n eliminada del historial', 'success');
    console.log('üóëÔ∏è Prescripci√≥n eliminada:', { id, codigo, fecha });
  } else {
    toast('‚ùå Error al eliminar la prescripci√≥n', 'error');
  }
}
window.borrarPrescripcionHistorial = borrarPrescripcionHistorial;

// ‚ú® FUNCI√ìN PARA CAMBIAR PESTA√ëAS EN MODAL RX ‚ú®
// ‚ú® FUNCI√ìN PARA CAMBIAR PESTA√ëAS EN MODAL RX (NUEVA PRESCRIPCI√ìN - VENTAS) ‚ú®
function cambiarPestanaRX(pestana) {
  // Ocultar todas las pesta√±as
  document.getElementById('contenidoPrescripcion').style.display = 'none';
  document.getElementById('contenidoHistorial').style.display = 'none';

  // Resetear estilos de los botones
  document.getElementById('tabPrescripcion').style.background = '#f3f4f6';
  document.getElementById('tabPrescripcion').style.color = '#6b7280';
  document.getElementById('tabPrescripcion').style.boxShadow = 'none';

  document.getElementById('tabHistorial').style.background = '#f3f4f6';
  document.getElementById('tabHistorial').style.color = '#6b7280';
  document.getElementById('tabHistorial').style.boxShadow = 'none';

  // Mostrar la pesta√±a seleccionada con animaci√≥n suave
  if (pestana === 'prescripcion') {
    document.getElementById('contenidoPrescripcion').style.display = 'block';
    document.getElementById('tabPrescripcion').style.background = 'linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%)';
    document.getElementById('tabPrescripcion').style.color = 'white';
    document.getElementById('tabPrescripcion').style.boxShadow = '0 4px 12px rgba(124, 58, 237, 0.3)';
  } else if (pestana === 'historial') {
    document.getElementById('contenidoHistorial').style.display = 'block';
    document.getElementById('tabHistorial').style.background = 'linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%)';
    document.getElementById('tabHistorial').style.color = 'white';
    document.getElementById('tabHistorial').style.boxShadow = '0 4px 12px rgba(124, 58, 237, 0.3)';
  }
}

// ‚ú® FUNCI√ìN PARA CAMBIAR PESTA√ëAS EN CONSULTORIO (ID√âNTICA AL MODAL RX) ‚ú®
function cambiarPestanaConsultorio(pestana) {
  // Ocultar todas las pesta√±as
  document.getElementById('contenidoConsultorioPrescripcion').style.display = 'none';
  document.getElementById('contenidoConsultorioHistorial').style.display = 'none';

  // Resetear estilos de los botones
  document.getElementById('tabConsultorioPrescripcion').style.background = '#f3f4f6';
  document.getElementById('tabConsultorioPrescripcion').style.color = '#6b7280';
  document.getElementById('tabConsultorioPrescripcion').style.boxShadow = 'none';

  document.getElementById('tabConsultorioHistorial').style.background = '#f3f4f6';
  document.getElementById('tabConsultorioHistorial').style.color = '#6b7280';
  document.getElementById('tabConsultorioHistorial').style.boxShadow = 'none';

  // Mostrar la pesta√±a seleccionada con animaci√≥n suave
  if (pestana === 'prescripcion') {
    document.getElementById('contenidoConsultorioPrescripcion').style.display = 'block';
    document.getElementById('tabConsultorioPrescripcion').style.background = 'linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%)';
    document.getElementById('tabConsultorioPrescripcion').style.color = 'white';
    document.getElementById('tabConsultorioPrescripcion').style.boxShadow = '0 4px 12px rgba(124, 58, 237, 0.3)';
  } else if (pestana === 'historial') {
    document.getElementById('contenidoConsultorioHistorial').style.display = 'block';
    document.getElementById('tabConsultorioHistorial').style.background = 'linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%)';
    document.getElementById('tabConsultorioHistorial').style.color = 'white';
    document.getElementById('tabConsultorioHistorial').style.boxShadow = '0 4px 12px rgba(124, 58, 237, 0.3)';
  }

  // Notificaci√≥n visual de cambio de pesta√±a
  console.log(`‚úÖ Pesta√±a cambiada a: ${pestana}`);

  // Actualizar contador de prescripciones si estamos en la pesta√±a de prescripci√≥n
  if (pestana === 'prescripcion') {
    actualizarContadorPrescripciones();
  }
}

// ‚ú® FUNCI√ìN PARA TOGGLE DEL HISTORIAL DE PRESCRIPCIONES ‚ú®
function toggleHistorialPrescripciones() {
  const panel = document.getElementById('panelHistorialPrescripciones');
  const textoToggle = document.getElementById('textoToggleHistorial');

  if (panel.style.display === 'none') {
    // Mostrar historial
    panel.style.display = 'block';
    textoToggle.textContent = '‚ùå Cerrar Historial';
    cargarHistorialPrescripciones();
  } else {
    // Ocultar historial
    panel.style.display = 'none';
    textoToggle.textContent = 'üìñ Ver Historial';
  }
}

// ‚ú® FUNCI√ìN PARA ACTUALIZAR CONTADOR DE PRESCRIPCIONES ‚ú®
function actualizarContadorPrescripciones() {
  if (!pacienteConsultorioActual || !pacienteConsultorioActual.id) return;

  const medidas = load(DB.MEDIDAS);
  const prescripcionesCliente = medidas.filter(m => m.clienteId === pacienteConsultorioActual.id);
  const contador = document.getElementById('contadorPrescripciones');

  if (contador) {
    contador.textContent = `${prescripcionesCliente.length} prescripci√≥n(es) registrada(s)`;
  }
}


// ‚ú® FUNCI√ìN PARA OBTENER CONTENIDO DE SUB-PESTA√ëAS DEL HISTORIAL CL√çNICO ‚ú®
function obtenerContenidoSubPestana(subPestana) {
  const contenidos = {
    anamnesis: `
      <div style="animation: slideInFromRight 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);">
        <div style="background: linear-gradient(135deg, #f0f9ff, #e0f2fe); border-radius: 16px; padding: 28px; margin-bottom: 20px; box-shadow: 0 8px 30px rgba(59, 130, 246, 0.15);">
          <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 24px;">
            <div style="font-size: 56px; animation: bounceIn 0.6s ease;">üìã</div>
            <h3 style="font-size: 26px; font-weight: 900; color: #1e40af; margin: 0; letter-spacing: 1px;">ANAMNESIS</h3>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div>
              <label style="display: block; font-weight: 700; color: #374151; margin-bottom: 8px; font-size: 14px;">üìù Motivo de Consulta</label>
              <textarea id="hcMotivoConsulta" placeholder="Describe el motivo principal de la consulta..." style="width: 100%; min-height: 120px; padding: 14px; border: 3px solid #bfdbfe; border-radius: 10px; font-size: 15px; font-family: inherit; transition: all 0.3s; background: white;" onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 4px 20px rgba(59,130,246,0.2)'" onblur="this.style.borderColor='#bfdbfe'; this.style.boxShadow='none'"></textarea>
            </div>

            <div>
              <label style="display: block; font-weight: 700; color: #374151; margin-bottom: 8px; font-size: 14px;">üè• Antecedentes Patol√≥gicos</label>
              <textarea id="hcAntecedentesPatologicos" placeholder="Enfermedades previas, cirug√≠as, alergias..." style="width: 100%; min-height: 120px; padding: 14px; border: 3px solid #bfdbfe; border-radius: 10px; font-size: 15px; font-family: inherit; transition: all 0.3s; background: white;" onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 4px 20px rgba(59,130,246,0.2)'" onblur="this.style.borderColor='#bfdbfe'; this.style.boxShadow='none'"></textarea>
            </div>

            <div>
              <label style="display: block; font-weight: 700; color: #374151; margin-bottom: 8px; font-size: 14px;">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Antecedentes Familiares</label>
              <textarea id="hcAntecedentesFamiliares" placeholder="Historial familiar de problemas oculares..." style="width: 100%; min-height: 120px; padding: 14px; border: 3px solid #bfdbfe; border-radius: 10px; font-size: 15px; font-family: inherit; transition: all 0.3s; background: white;" onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 4px 20px rgba(59,130,246,0.2)'" onblur="this.style.borderColor='#bfdbfe'; this.style.boxShadow='none'"></textarea>
            </div>

            <div>
              <label style="display: block; font-weight: 700; color: #374151; margin-bottom: 8px; font-size: 14px;">üíä Medicaci√≥n Actual</label>
              <textarea id="hcMedicacionActual" placeholder="Medicamentos que est√° tomando actualmente..." style="width: 100%; min-height: 120px; padding: 14px; border: 3px solid #bfdbfe; border-radius: 10px; font-size: 15px; font-family: inherit; transition: all 0.3s; background: white;" onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 4px 20px rgba(59,130,246,0.2)'" onblur="this.style.borderColor='#bfdbfe'; this.style.boxShadow='none'"></textarea>
            </div>
          </div>
        </div>
      </div>
    `,

    agudeza: `
      <div style="animation: slideInFromRight 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);">
        <div style="background: linear-gradient(135deg, #fef3c7, #fde68a); border-radius: 16px; padding: 28px; margin-bottom: 20px; box-shadow: 0 8px 30px rgba(245, 158, 11, 0.15);">
          <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 24px;">
            <div style="font-size: 56px; animation: bounceIn 0.6s ease;">üëÅÔ∏è</div>
            <h3 style="font-size: 26px; font-weight: 900; color: #92400e; margin: 0; letter-spacing: 1px;">AGUDEZA VISUAL</h3>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
            <div style="background: white; padding: 20px; border-radius: 12px; border: 3px solid #fbbf24; box-shadow: 0 4px 15px rgba(251,191,36,0.1);">
              <h4 style="font-size: 18px; font-weight: 800; color: #b45309; margin: 0 0 16px 0; display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 24px;">üëÅÔ∏è</span> OJO DERECHO (OD)
              </h4>
              <div style="margin-bottom: 14px;">
                <label style="display: block; font-weight: 700; color: #374151; margin-bottom: 6px; font-size: 13px;">Sin Correcci√≥n (SC)</label>
                <input type="text" id="hcAgudezaOD_SC" placeholder="20/20" style="width: 100%; padding: 12px; border: 2px solid #fde68a; border-radius: 8px; font-size: 16px; font-weight: 700; text-align: center;" onfocus="this.style.borderColor='#f59e0b'; this.style.boxShadow='0 4px 15px rgba(245,158,11,0.2)'" onblur="this.style.borderColor='#fde68a'; this.style.boxShadow='none'">
              </div>
              <div style="margin-bottom: 14px;">
                <label style="display: block; font-weight: 700; color: #374151; margin-bottom: 6px; font-size: 13px;">Con Correcci√≥n (CC)</label>
                <input type="text" id="hcAgudezaOD_CC" placeholder="20/20" style="width: 100%; padding: 12px; border: 2px solid #fde68a; border-radius: 8px; font-size: 16px; font-weight: 700; text-align: center;" onfocus="this.style.borderColor='#f59e0b'; this.style.boxShadow='0 4px 15px rgba(245,158,11,0.2)'" onblur="this.style.borderColor='#fde68a'; this.style.boxShadow='none'">
              </div>
              <div>
                <label style="display: block; font-weight: 700; color: #374151; margin-bottom: 6px; font-size: 13px;">Agujero Estenopeico (PH)</label>
                <input type="text" id="hcAgudezaOD_PH" placeholder="20/20" style="width: 100%; padding: 12px; border: 2px solid #fde68a; border-radius: 8px; font-size: 16px; font-weight: 700; text-align: center;" onfocus="this.style.borderColor='#f59e0b'; this.style.boxShadow='0 4px 15px rgba(245,158,11,0.2)'" onblur="this.style.borderColor='#fde68a'; this.style.boxShadow='none'">
              </div>
            </div>

            <div style="background: white; padding: 20px; border-radius: 12px; border: 3px solid #fbbf24; box-shadow: 0 4px 15px rgba(251,191,36,0.1);">
              <h4 style="font-size: 18px; font-weight: 800; color: #b45309; margin: 0 0 16px 0; display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 24px;">üëÅÔ∏è</span> OJO IZQUIERDO (OI)
              </h4>
              <div style="margin-bottom: 14px;">
                <label style="display: block; font-weight: 700; color: #374151; margin-bottom: 6px; font-size: 13px;">Sin Correcci√≥n (SC)</label>
                <input type="text" id="hcAgudezaOI_SC" placeholder="20/20" style="width: 100%; padding: 12px; border: 2px solid #fde68a; border-radius: 8px; font-size: 16px; font-weight: 700; text-align: center;" onfocus="this.style.borderColor='#f59e0b'; this.style.boxShadow='0 4px 15px rgba(245,158,11,0.2)'" onblur="this.style.borderColor='#fde68a'; this.style.boxShadow='none'">
              </div>
              <div style="margin-bottom: 14px;">
                <label style="display: block; font-weight: 700; color: #374151; margin-bottom: 6px; font-size: 13px;">Con Correcci√≥n (CC)</label>
                <input type="text" id="hcAgudezaOI_CC" placeholder="20/20" style="width: 100%; padding: 12px; border: 2px solid #fde68a; border-radius: 8px; font-size: 16px; font-weight: 700; text-align: center;" onfocus="this.style.borderColor='#f59e0b'; this.style.boxShadow='0 4px 15px rgba(245,158,11,0.2)'" onblur="this.style.borderColor='#fde68a'; this.style.boxShadow='none'">
              </div>
              <div>
                <label style="display: block; font-weight: 700; color: #374151; margin-bottom: 6px; font-size: 13px;">Agujero Estenopeico (PH)</label>
                <input type="text" id="hcAgudezaOI_PH" placeholder="20/20" style="width: 100%; padding: 12px; border: 2px solid #fde68a; border-radius: 8px; font-size: 16px; font-weight: 700; text-align: center;" onfocus="this.style.borderColor='#f59e0b'; this.style.boxShadow='0 4px 15px rgba(245,158,11,0.2)'" onblur="this.style.borderColor='#fde68a'; this.style.boxShadow='none'">
              </div>
            </div>
          </div>
        </div>
      </div>
    `,

    motilidad: `
      <div style="animation: slideInFromRight 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);">
        <div style="background: linear-gradient(135deg, #e0e7ff, #c7d2fe); border-radius: 16px; padding: 28px; margin-bottom: 20px; box-shadow: 0 8px 30px rgba(99, 102, 241, 0.15);">
          <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 24px;">
            <div style="font-size: 56px; animation: bounceIn 0.6s ease;">üîÑ</div>
            <h3 style="font-size: 26px; font-weight: 900; color: #3730a3; margin: 0; letter-spacing: 1px;">MOTILIDAD OCULAR</h3>
          </div>

          <div style="background: white; padding: 24px; border-radius: 12px; border: 3px solid #818cf8; margin-bottom: 20px;">
            <h4 style="font-size: 18px; font-weight: 800; color: #4338ca; margin: 0 0 18px 0;">üìê Test de Ducciones</h4>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
              <div style="text-align: center; padding: 14px; background: #f0f9ff; border-radius: 8px; border: 2px solid #bfdbfe;">
                <div style="font-size: 32px; margin-bottom: 6px;">‚¨ÜÔ∏è</div>
                <label style="font-size: 12px; font-weight: 700; color: #1e40af;">Elevaci√≥n</label>
                <input type="text" id="hcMotilidad_Elevacion" placeholder="Normal" style="width: 100%; margin-top: 8px; padding: 8px; border: 2px solid #dbeafe; border-radius: 6px; text-align: center; font-size: 13px;">
              </div>
              <div style="text-align: center; padding: 14px; background: #f0f9ff; border-radius: 8px; border: 2px solid #bfdbfe;">
                <div style="font-size: 32px; margin-bottom: 6px;">‚¨áÔ∏è</div>
                <label style="font-size: 12px; font-weight: 700; color: #1e40af;">Depresi√≥n</label>
                <input type="text" id="hcMotilidad_Depresion" placeholder="Normal" style="width: 100%; margin-top: 8px; padding: 8px; border: 2px solid #dbeafe; border-radius: 6px; text-align: center; font-size: 13px;">
              </div>
              <div style="text-align: center; padding: 14px; background: #f0f9ff; border-radius: 8px; border: 2px solid #bfdbfe;">
                <div style="font-size: 32px; margin-bottom: 6px;">‚û°Ô∏è</div>
                <label style="font-size: 12px; font-weight: 700; color: #1e40af;">Abducci√≥n</label>
                <input type="text" id="hcMotilidad_Abduccion" placeholder="Normal" style="width: 100%; margin-top: 8px; padding: 8px; border: 2px solid #dbeafe; border-radius: 6px; text-align: center; font-size: 13px;">
              </div>
              <div style="text-align: center; padding: 14px; background: #f0f9ff; border-radius: 8px; border: 2px solid #bfdbfe;">
                <div style="font-size: 32px; margin-bottom: 6px;">‚¨ÖÔ∏è</div>
                <label style="font-size: 12px; font-weight: 700; color: #1e40af;">Aducci√≥n</label>
                <input type="text" id="hcMotilidad_Aduccion" placeholder="Normal" style="width: 100%; margin-top: 8px; padding: 8px; border: 2px solid #dbeafe; border-radius: 6px; text-align: center; font-size: 13px;">
              </div>
              <div style="text-align: center; padding: 14px; background: #f0f9ff; border-radius: 8px; border: 2px solid #bfdbfe;">
                <div style="font-size: 32px; margin-bottom: 6px;">‚ÜóÔ∏è</div>
                <label style="font-size: 12px; font-weight: 700; color: #1e40af;">Oblicuos</label>
                <input type="text" id="hcMotilidad_Oblicuos" placeholder="Normal" style="width: 100%; margin-top: 8px; padding: 8px; border: 2px solid #dbeafe; border-radius: 6px; text-align: center; font-size: 13px;">
              </div>
              <div style="text-align: center; padding: 14px; background: #f0f9ff; border-radius: 8px; border: 2px solid #bfdbfe;">
                <div style="font-size: 32px; margin-bottom: 6px;">üëÅÔ∏èüëÅÔ∏è</div>
                <label style="font-size: 12px; font-weight: 700; color: #1e40af;">Versiones</label>
                <input type="text" id="hcMotilidad_Versiones" placeholder="Normal" style="width: 100%; margin-top: 8px; padding: 8px; border: 2px solid #dbeafe; border-radius: 6px; text-align: center; font-size: 13px;">
              </div>
            </div>
          </div>

          <div style="background: white; padding: 20px; border-radius: 12px; border: 3px solid #818cf8;">
            <label style="display: block; font-weight: 700; color: #4338ca; margin-bottom: 10px; font-size: 15px;">üìù Observaciones Adicionales</label>
            <textarea id="hcMotilidad_Observaciones" placeholder="Notas sobre motilidad ocular, nistagmus, estrabismo..." style="width: 100%; min-height: 100px; padding: 14px; border: 2px solid #c7d2fe; border-radius: 10px; font-size: 15px; font-family: inherit;"></textarea>
          </div>
        </div>
      </div>
    `,

    reflejos: `
      <div style="animation: slideInFromRight 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);">
        <div style="background: linear-gradient(135deg, #fce7f3, #fbcfe8); border-radius: 16px; padding: 28px; margin-bottom: 20px; box-shadow: 0 8px 30px rgba(236, 72, 153, 0.15);">
          <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 24px;">
            <div style="font-size: 56px; animation: bounceIn 0.6s ease;">‚ú®</div>
            <h3 style="font-size: 26px; font-weight: 900; color: #9f1239; margin: 0; letter-spacing: 1px;">REFLEJOS & EXAMEN EXTERNO</h3>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
            <div style="background: white; padding: 20px; border-radius: 12px; border: 3px solid #f9a8d4;">
              <h4 style="font-size: 17px; font-weight: 800; color: #be185d; margin: 0 0 16px 0;">üí° Reflejos Pupilares</h4>
              <div style="margin-bottom: 12px;">
                <label style="display: block; font-weight: 700; color: #374151; margin-bottom: 6px; font-size: 13px;">Reflejo Fotomotor OD</label>
                <input type="text" id="hcReflejos_FotomotorOD" placeholder="Normal / Alterado" style="width: 100%; padding: 10px; border: 2px solid #fbcfe8; border-radius: 8px; font-size: 14px;">
              </div>
              <div style="margin-bottom: 12px;">
                <label style="display: block; font-weight: 700; color: #374151; margin-bottom: 6px; font-size: 13px;">Reflejo Fotomotor OI</label>
                <input type="text" id="hcReflejos_FotomotorOI" placeholder="Normal / Alterado" style="width: 100%; padding: 10px; border: 2px solid #fbcfe8; border-radius: 8px; font-size: 14px;">
              </div>
              <div>
                <label style="display: block; font-weight: 700; color: #374151; margin-bottom: 6px; font-size: 13px;">Reflejo Consensual</label>
                <input type="text" id="hcReflejos_Consensual" placeholder="Presente / Ausente" style="width: 100%; padding: 10px; border: 2px solid #fbcfe8; border-radius: 8px; font-size: 14px;">
              </div>
            </div>

            <div style="background: white; padding: 20px; border-radius: 12px; border: 3px solid #f9a8d4;">
              <h4 style="font-size: 17px; font-weight: 800; color: #be185d; margin: 0 0 16px 0;">üëÅÔ∏è Examen Externo</h4>
              <div style="margin-bottom: 12px;">
                <label style="display: block; font-weight: 700; color: #374151; margin-bottom: 6px; font-size: 13px;">P√°rpados</label>
                <input type="text" id="hcExterno_Parpados" placeholder="Normal / Ptosis / Edema..." style="width: 100%; padding: 10px; border: 2px solid #fbcfe8; border-radius: 8px; font-size: 14px;">
              </div>
              <div style="margin-bottom: 12px;">
                <label style="display: block; font-weight: 700; color: #374151; margin-bottom: 6px; font-size: 13px;">Conjuntiva</label>
                <input type="text" id="hcExterno_Conjuntiva" placeholder="Normal / Hiperemia / Secreci√≥n..." style="width: 100%; padding: 10px; border: 2px solid #fbcfe8; border-radius: 8px; font-size: 14px;">
              </div>
              <div>
                <label style="display: block; font-weight: 700; color: #374151; margin-bottom: 6px; font-size: 13px;">C√≥rnea</label>
                <input type="text" id="hcExterno_Cornea" placeholder="Transparente / Opacidad / √ölcera..." style="width: 100%; padding: 10px; border: 2px solid #fbcfe8; border-radius: 8px; font-size: 14px;">
              </div>
            </div>
          </div>

          <div style="background: white; padding: 20px; border-radius: 12px; border: 3px solid #f9a8d4;">
            <label style="display: block; font-weight: 700; color: #be185d; margin-bottom: 10px; font-size: 15px;">üìù Observaciones</label>
            <textarea id="hcReflejos_Observaciones" placeholder="Hallazgos adicionales del examen externo y reflejos..." style="width: 100%; min-height: 90px; padding: 14px; border: 2px solid #fbcfe8; border-radius: 10px; font-size: 15px; font-family: inherit;"></textarea>
          </div>
        </div>
      </div>
    `,

    oftalmoscopia: `
      <div style="animation: slideInFromRight 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);">
        <div style="background: linear-gradient(135deg, #dcfce7, #bbf7d0); border-radius: 16px; padding: 28px; margin-bottom: 20px; box-shadow: 0 8px 30px rgba(34, 197, 94, 0.15);">
          <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 24px;">
            <div style="font-size: 56px; animation: bounceIn 0.6s ease;">üî¨</div>
            <h3 style="font-size: 26px; font-weight: 900; color: #14532d; margin: 0; letter-spacing: 1px;">OFTALMOSCOP√çA</h3>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div style="background: white; padding: 22px; border-radius: 12px; border: 3px solid #86efac; box-shadow: 0 4px 15px rgba(134,239,172,0.1);">
              <h4 style="font-size: 18px; font-weight: 800; color: #15803d; margin: 0 0 18px 0; display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 24px;">üëÅÔ∏è</span> OJO DERECHO (OD)
              </h4>
              <div style="margin-bottom: 14px;">
                <label style="display: block; font-weight: 700; color: #374151; margin-bottom: 6px; font-size: 13px;">üî¥ Disco √ìptico</label>
                <input type="text" id="hcOftalmoscopia_DiscoOD" placeholder="Tama√±o, color, excavaci√≥n..." style="width: 100%; padding: 12px; border: 2px solid #bbf7d0; border-radius: 8px; font-size: 14px;">
              </div>
              <div style="margin-bottom: 14px;">
                <label style="display: block; font-weight: 700; color: #374151; margin-bottom: 6px; font-size: 13px;">ü©∏ Vasos Retinianos</label>
                <input type="text" id="hcOftalmoscopia_VasosOD" placeholder="Calibre, cruces AV, tortuosidad..." style="width: 100%; padding: 12px; border: 2px solid #bbf7d0; border-radius: 8px; font-size: 14px;">
              </div>
              <div style="margin-bottom: 14px;">
                <label style="display: block; font-weight: 700; color: #374151; margin-bottom: 6px; font-size: 13px;">üü° M√°cula</label>
                <input type="text" id="hcOftalmoscopia_MaculaOD" placeholder="Brillo foveal, lesiones..." style="width: 100%; padding: 12px; border: 2px solid #bbf7d0; border-radius: 8px; font-size: 14px;">
              </div>
              <div>
                <label style="display: block; font-weight: 700; color: #374151; margin-bottom: 6px; font-size: 13px;">üëÅÔ∏è Retina Perif√©rica</label>
                <input type="text" id="hcOftalmoscopia_RetinaOD" placeholder="Desgarros, degeneraci√≥n..." style="width: 100%; padding: 12px; border: 2px solid #bbf7d0; border-radius: 8px; font-size: 14px;">
              </div>
            </div>

            <div style="background: white; padding: 22px; border-radius: 12px; border: 3px solid #86efac; box-shadow: 0 4px 15px rgba(134,239,172,0.1);">
              <h4 style="font-size: 18px; font-weight: 800; color: #15803d; margin: 0 0 18px 0; display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 24px;">üëÅÔ∏è</span> OJO IZQUIERDO (OI)
              </h4>
              <div style="margin-bottom: 14px;">
                <label style="display: block; font-weight: 700; color: #374151; margin-bottom: 6px; font-size: 13px;">üî¥ Disco √ìptico</label>
                <input type="text" id="hcOftalmoscopia_DiscoOI" placeholder="Tama√±o, color, excavaci√≥n..." style="width: 100%; padding: 12px; border: 2px solid #bbf7d0; border-radius: 8px; font-size: 14px;">
              </div>
              <div style="margin-bottom: 14px;">
                <label style="display: block; font-weight: 700; color: #374151; margin-bottom: 6px; font-size: 13px;">ü©∏ Vasos Retinianos</label>
                <input type="text" id="hcOftalmoscopia_VasosOI" placeholder="Calibre, cruces AV, tortuosidad..." style="width: 100%; padding: 12px; border: 2px solid #bbf7d0; border-radius: 8px; font-size: 14px;">
              </div>
              <div style="margin-bottom: 14px;">
                <label style="display: block; font-weight: 700; color: #374151; margin-bottom: 6px; font-size: 13px;">üü° M√°cula</label>
                <input type="text" id="hcOftalmoscopia_MaculaOI" placeholder="Brillo foveal, lesiones..." style="width: 100%; padding: 12px; border: 2px solid #bbf7d0; border-radius: 8px; font-size: 14px;">
              </div>
              <div>
                <label style="display: block; font-weight: 700; color: #374151; margin-bottom: 6px; font-size: 13px;">üëÅÔ∏è Retina Perif√©rica</label>
                <input type="text" id="hcOftalmoscopia_RetinaOI" placeholder="Desgarros, degeneraci√≥n..." style="width: 100%; padding: 12px; border: 2px solid #bbf7d0; border-radius: 8px; font-size: 14px;">
              </div>
            </div>
          </div>
        </div>
      </div>
    `,

    keratometria: `
      <div style="animation: slideInFromRight 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);">
        <div style="background: linear-gradient(135deg, #e0f2fe, #bae6fd); border-radius: 16px; padding: 28px; margin-bottom: 20px; box-shadow: 0 8px 30px rgba(14, 165, 233, 0.15);">
          <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 24px;">
            <div style="font-size: 56px; animation: bounceIn 0.6s ease;">üìê</div>
            <h3 style="font-size: 26px; font-weight: 900; color: #075985; margin: 0; letter-spacing: 1px;">KERATOMETR√çA</h3>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
            <div style="background: white; padding: 22px; border-radius: 12px; border: 3px solid #7dd3fc; box-shadow: 0 4px 15px rgba(125,211,252,0.1);">
              <h4 style="font-size: 18px; font-weight: 800; color: #0369a1; margin: 0 0 18px 0; display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 24px;">üëÅÔ∏è</span> OJO DERECHO (OD)
              </h4>
              <div style="margin-bottom: 14px;">
                <label style="display: block; font-weight: 700; color: #374151; margin-bottom: 6px; font-size: 13px;">K1 (Meridiano Plano)</label>
                <input type="text" id="hcKerat_K1_OD" placeholder="42.00 D @ 180¬∞" style="width: 100%; padding: 12px; border: 2px solid #bae6fd; border-radius: 8px; font-size: 15px; font-weight: 700; text-align: center;">
              </div>
              <div style="margin-bottom: 14px;">
                <label style="display: block; font-weight: 700; color: #374151; margin-bottom: 6px; font-size: 13px;">K2 (Meridiano Curvo)</label>
                <input type="text" id="hcKerat_K2_OD" placeholder="44.00 D @ 90¬∞" style="width: 100%; padding: 12px; border: 2px solid #bae6fd; border-radius: 8px; font-size: 15px; font-weight: 700; text-align: center;">
              </div>
              <div style="background: linear-gradient(135deg, #f0f9ff, #e0f2fe); padding: 12px; border-radius: 8px; border: 2px solid #0ea5e9;">
                <label style="display: block; font-weight: 700; color: #0369a1; margin-bottom: 4px; font-size: 12px;">Astigmatismo Corneal</label>
                <div style="font-size: 18px; font-weight: 900; color: #075985; text-align: center;">-2.00 D</div>
              </div>
            </div>

            <div style="background: white; padding: 22px; border-radius: 12px; border: 3px solid #7dd3fc; box-shadow: 0 4px 15px rgba(125,211,252,0.1);">
              <h4 style="font-size: 18px; font-weight: 800; color: #0369a1; margin: 0 0 18px 0; display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 24px;">üëÅÔ∏è</span> OJO IZQUIERDO (OI)
              </h4>
              <div style="margin-bottom: 14px;">
                <label style="display: block; font-weight: 700; color: #374151; margin-bottom: 6px; font-size: 13px;">K1 (Meridiano Plano)</label>
                <input type="text" id="hcKerat_K1_OI" placeholder="42.00 D @ 180¬∞" style="width: 100%; padding: 12px; border: 2px solid #bae6fd; border-radius: 8px; font-size: 15px; font-weight: 700; text-align: center;">
              </div>
              <div style="margin-bottom: 14px;">
                <label style="display: block; font-weight: 700; color: #374151; margin-bottom: 6px; font-size: 13px;">K2 (Meridiano Curvo)</label>
                <input type="text" id="hcKerat_K2_OI" placeholder="44.00 D @ 90¬∞" style="width: 100%; padding: 12px; border: 2px solid #bae6fd; border-radius: 8px; font-size: 15px; font-weight: 700; text-align: center;">
              </div>
              <div style="background: linear-gradient(135deg, #f0f9ff, #e0f2fe); padding: 12px; border-radius: 8px; border: 2px solid #0ea5e9;">
                <label style="display: block; font-weight: 700; color: #0369a1; margin-bottom: 4px; font-size: 12px;">Astigmatismo Corneal</label>
                <div style="font-size: 18px; font-weight: 900; color: #075985; text-align: center;">-2.00 D</div>
              </div>
            </div>
          </div>

          <div style="background: white; padding: 20px; border-radius: 12px; border: 3px solid #7dd3fc; margin-top: 20px;">
            <label style="display: block; font-weight: 700; color: #0369a1; margin-bottom: 10px; font-size: 15px;">üìù Observaciones</label>
            <textarea id="hcKerat_Observaciones" placeholder="Irregularidades corneales, queratocono, cicatrices..." style="width: 100%; min-height: 90px; padding: 14px; border: 2px solid #bae6fd; border-radius: 10px; font-size: 15px; font-family: inherit;"></textarea>
          </div>
        </div>
      </div>
    `,

    retinoscopia: `
      <div style="animation: slideInFromRight 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);">
        <div style="background: linear-gradient(135deg, #fef9c3, #fef08a); border-radius: 16px; padding: 28px; margin-bottom: 20px; box-shadow: 0 8px 30px rgba(234, 179, 8, 0.15);">
          <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 24px;">
            <div style="font-size: 56px; animation: bounceIn 0.6s ease;">üåü</div>
            <h3 style="font-size: 26px; font-weight: 900; color: #713f12; margin: 0; letter-spacing: 1px;">RETINOSCOP√çA</h3>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div style="background: white; padding: 22px; border-radius: 12px; border: 3px solid #fde047; box-shadow: 0 4px 15px rgba(253,224,71,0.1);">
              <h4 style="font-size: 18px; font-weight: 800; color: #a16207; margin: 0 0 18px 0; display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 24px;">üëÅÔ∏è</span> OJO DERECHO (OD)
              </h4>
              <div style="margin-bottom: 14px;">
                <label style="display: block; font-weight: 700; color: #374151; margin-bottom: 6px; font-size: 13px;">Esfera (SPH)</label>
                <input type="text" id="hcRetino_EsferaOD" placeholder="+0.00" style="width: 100%; padding: 12px; border: 2px solid #fef08a; border-radius: 8px; font-size: 16px; font-weight: 700; text-align: center;">
              </div>
              <div style="margin-bottom: 14px;">
                <label style="display: block; font-weight: 700; color: #374151; margin-bottom: 6px; font-size: 13px;">Cilindro (CYL)</label>
                <input type="text" id="hcRetino_CilindroOD" placeholder="-0.00" style="width: 100%; padding: 12px; border: 2px solid #fef08a; border-radius: 8px; font-size: 16px; font-weight: 700; text-align: center;">
              </div>
              <div>
                <label style="display: block; font-weight: 700; color: #374151; margin-bottom: 6px; font-size: 13px;">Eje (AXIS)</label>
                <input type="text" id="hcRetino_EjeOD" placeholder="0¬∞" style="width: 100%; padding: 12px; border: 2px solid #fef08a; border-radius: 8px; font-size: 16px; font-weight: 700; text-align: center;">
              </div>
            </div>

            <div style="background: white; padding: 22px; border-radius: 12px; border: 3px solid #fde047; box-shadow: 0 4px 15px rgba(253,224,71,0.1);">
              <h4 style="font-size: 18px; font-weight: 800; color: #a16207; margin: 0 0 18px 0; display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 24px;">üëÅÔ∏è</span> OJO IZQUIERDO (OI)
              </h4>
              <div style="margin-bottom: 14px;">
                <label style="display: block; font-weight: 700; color: #374151; margin-bottom: 6px; font-size: 13px;">Esfera (SPH)</label>
                <input type="text" id="hcRetino_EsferaOI" placeholder="+0.00" style="width: 100%; padding: 12px; border: 2px solid #fef08a; border-radius: 8px; font-size: 16px; font-weight: 700; text-align: center;">
              </div>
              <div style="margin-bottom: 14px;">
                <label style="display: block; font-weight: 700; color: #374151; margin-bottom: 6px; font-size: 13px;">Cilindro (CYL)</label>
                <input type="text" id="hcRetino_CilindroOI" placeholder="-0.00" style="width: 100%; padding: 12px; border: 2px solid #fef08a; border-radius: 8px; font-size: 16px; font-weight: 700; text-align: center;">
              </div>
              <div>
                <label style="display: block; font-weight: 700; color: #374151; margin-bottom: 6px; font-size: 13px;">Eje (AXIS)</label>
                <input type="text" id="hcRetino_EjeOI" placeholder="0¬∞" style="width: 100%; padding: 12px; border: 2px solid #fef08a; border-radius: 8px; font-size: 16px; font-weight: 700; text-align: center;">
              </div>
            </div>
          </div>

          <div style="background: white; padding: 20px; border-radius: 12px; border: 3px solid #fde047; margin-top: 20px;">
            <label style="display: block; font-weight: 700; color: #a16207; margin-bottom: 10px; font-size: 15px;">üìù Observaciones</label>
            <textarea id="hcRetino_Observaciones" placeholder="Tipo de reflejo (con, contra, neutro), velocidad, brillo..." style="width: 100%; min-height: 90px; padding: 14px; border: 2px solid #fef08a; border-radius: 10px; font-size: 15px; font-family: inherit;"></textarea>
          </div>
        </div>
      </div>
    `,

    refraccion: `
      <div style="animation: slideInFromRight 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);">
        <div style="background: linear-gradient(135deg, #ddd6fe, #c4b5fd); border-radius: 16px; padding: 28px; margin-bottom: 20px; box-shadow: 0 8px 30px rgba(139, 92, 246, 0.15);">
          <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 24px;">
            <div style="font-size: 56px; animation: bounceIn 0.6s ease;">‚úÖ</div>
            <h3 style="font-size: 26px; font-weight: 900; color: #5b21b6; margin: 0; letter-spacing: 1px;">REFRACCI√ìN FINAL</h3>
          </div>

          <div style="background: linear-gradient(135deg, #fef3c7, #fde68a); padding: 16px; border-radius: 12px; margin-bottom: 20px; border: 3px solid #f59e0b;">
            <div style="text-align: center; font-size: 15px; font-weight: 800; color: #92400e;">
              ‚ö†Ô∏è Esta es la prescripci√≥n final despu√©s de refinar con for√≥ptero y test de agudeza visual
            </div>
          </div>

          <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 20px rgba(139,92,246,0.15);">
              <thead>
                <tr style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">
                  <th style="padding: 16px; color: white; font-size: 16px; font-weight: 900; text-align: center; border: 2px solid #a78bfa;">OJO</th>
                  <th style="padding: 16px; color: white; font-size: 16px; font-weight: 900; text-align: center; border: 2px solid #a78bfa;">ESFERA</th>
                  <th style="padding: 16px; color: white; font-size: 16px; font-weight: 900; text-align: center; border: 2px solid #a78bfa;">CILINDRO</th>
                  <th style="padding: 16px; color: white; font-size: 16px; font-weight: 900; text-align: center; border: 2px solid #a78bfa;">EJE</th>
                  <th style="padding: 16px; color: white; font-size: 16px; font-weight: 900; text-align: center; border: 2px solid #a78bfa;">ADD</th>
                  <th style="padding: 16px; color: white; font-size: 16px; font-weight: 900; text-align: center; border: 2px solid #a78bfa;">AV FINAL</th>
                </tr>
              </thead>
              <tbody>
                <tr style="background: #faf5ff;">
                  <td style="padding: 14px; text-align: center; font-weight: 800; font-size: 15px; color: #5b21b6; border: 2px solid #e9d5ff;">OD</td>
                  <td style="padding: 14px; text-align: center; border: 2px solid #e9d5ff;"><input type="text" id="hcRefFinal_EsferaOD" placeholder="+0.00" style="width: 100%; padding: 10px; border: 2px solid #c4b5fd; border-radius: 6px; font-size: 15px; font-weight: 700; text-align: center;"></td>
                  <td style="padding: 14px; text-align: center; border: 2px solid #e9d5ff;"><input type="text" id="hcRefFinal_CilindroOD" placeholder="-0.00" style="width: 100%; padding: 10px; border: 2px solid #c4b5fd; border-radius: 6px; font-size: 15px; font-weight: 700; text-align: center;"></td>
                  <td style="padding: 14px; text-align: center; border: 2px solid #e9d5ff;"><input type="text" id="hcRefFinal_EjeOD" placeholder="0¬∞" style="width: 100%; padding: 10px; border: 2px solid #c4b5fd; border-radius: 6px; font-size: 15px; font-weight: 700; text-align: center;"></td>
                  <td style="padding: 14px; text-align: center; border: 2px solid #e9d5ff;"><input type="text" id="hcRefFinal_AddOD" placeholder="+0.00" style="width: 100%; padding: 10px; border: 2px solid #c4b5fd; border-radius: 6px; font-size: 15px; font-weight: 700; text-align: center;"></td>
                  <td style="padding: 14px; text-align: center; border: 2px solid #e9d5ff;"><input type="text" id="hcRefFinal_AVOD" placeholder="20/20" style="width: 100%; padding: 10px; border: 2px solid #c4b5fd; border-radius: 6px; font-size: 15px; font-weight: 700; text-align: center;"></td>
                </tr>
                <tr style="background: white;">
                  <td style="padding: 14px; text-align: center; font-weight: 800; font-size: 15px; color: #5b21b6; border: 2px solid #e9d5ff;">OI</td>
                  <td style="padding: 14px; text-align: center; border: 2px solid #e9d5ff;"><input type="text" id="hcRefFinal_EsferaOI" placeholder="+0.00" style="width: 100%; padding: 10px; border: 2px solid #c4b5fd; border-radius: 6px; font-size: 15px; font-weight: 700; text-align: center;"></td>
                  <td style="padding: 14px; text-align: center; border: 2px solid #e9d5ff;"><input type="text" id="hcRefFinal_CilindroOI" placeholder="-0.00" style="width: 100%; padding: 10px; border: 2px solid #c4b5fd; border-radius: 6px; font-size: 15px; font-weight: 700; text-align: center;"></td>
                  <td style="padding: 14px; text-align: center; border: 2px solid #e9d5ff;"><input type="text" id="hcRefFinal_EjeOI" placeholder="0¬∞" style="width: 100%; padding: 10px; border: 2px solid #c4b5fd; border-radius: 6px; font-size: 15px; font-weight: 700; text-align: center;"></td>
                  <td style="padding: 14px; text-align: center; border: 2px solid #e9d5ff;"><input type="text" id="hcRefFinal_AddOI" placeholder="+0.00" style="width: 100%; padding: 10px; border: 2px solid #c4b5fd; border-radius: 6px; font-size: 15px; font-weight: 700; text-align: center;"></td>
                  <td style="padding: 14px; text-align: center; border: 2px solid #e9d5ff;"><input type="text" id="hcRefFinal_AVOI" placeholder="20/20" style="width: 100%; padding: 10px; border: 2px solid #c4b5fd; border-radius: 6px; font-size: 15px; font-weight: 700; text-align: center;"></td>
                </tr>
              </tbody>
            </table>
          </div>

          <div style="background: white; padding: 20px; border-radius: 12px; border: 3px solid #c4b5fd; margin-top: 20px;">
            <label style="display: block; font-weight: 700; color: #5b21b6; margin-bottom: 10px; font-size: 15px;">üìù Observaciones de Refracci√≥n</label>
            <textarea id="hcRefFinal_Observaciones" placeholder="Balance binocular, test de visi√≥n binocular, recomendaciones de uso..." style="width: 100%; min-height: 90px; padding: 14px; border: 2px solid #ddd6fe; border-radius: 10px; font-size: 15px; font-family: inherit;"></textarea>
          </div>
        </div>
      </div>
    `,

    diagnostico: `
      <div style="animation: slideInFromRight 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);">
        <div style="background: linear-gradient(135deg, #fee2e2, #fecaca); border-radius: 16px; padding: 28px; margin-bottom: 20px; box-shadow: 0 8px 30px rgba(239, 68, 68, 0.15);">
          <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 24px;">
            <div style="font-size: 56px; animation: bounceIn 0.6s ease;">üè•</div>
            <h3 style="font-size: 26px; font-weight: 900; color: #991b1b; margin: 0; letter-spacing: 1px;">DIAGN√ìSTICO</h3>
          </div>

          <div style="background: white; padding: 24px; border-radius: 12px; border: 3px solid #fca5a5; margin-bottom: 20px;">
            <h4 style="font-size: 18px; font-weight: 800; color: #dc2626; margin: 0 0 18px 0;">‚úÖ Diagn√≥sticos Confirmados</h4>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 14px;">
              <label style="display: flex; align-items: center; gap: 10px; padding: 14px; background: #fef2f2; border: 3px solid #fecaca; border-radius: 10px; cursor: pointer; transition: all 0.3s; font-weight: 700; font-size: 14px; color: #991b1b;" onmouseover="this.style.transform='scale(1.03)'; this.style.boxShadow='0 6px 20px rgba(220,38,38,0.2)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none'">
                <input type="checkbox" id="hcDiag_Miopia" style="width: 22px; height: 22px; cursor: pointer;">
                üëì Miop√≠a
              </label>
              <label style="display: flex; align-items: center; gap: 10px; padding: 14px; background: #fef2f2; border: 3px solid #fecaca; border-radius: 10px; cursor: pointer; transition: all 0.3s; font-weight: 700; font-size: 14px; color: #991b1b;" onmouseover="this.style.transform='scale(1.03)'; this.style.boxShadow='0 6px 20px rgba(220,38,38,0.2)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none'">
                <input type="checkbox" id="hcDiag_Hipermetropia" style="width: 22px; height: 22px; cursor: pointer;">
                üîç Hipermetrop√≠a
              </label>
              <label style="display: flex; align-items: center; gap: 10px; padding: 14px; background: #fef2f2; border: 3px solid #fecaca; border-radius: 10px; cursor: pointer; transition: all 0.3s; font-weight: 700; font-size: 14px; color: #991b1b;" onmouseover="this.style.transform='scale(1.03)'; this.style.boxShadow='0 6px 20px rgba(220,38,38,0.2)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none'">
                <input type="checkbox" id="hcDiag_Astigmatismo" style="width: 22px; height: 22px; cursor: pointer;">
                üìê Astigmatismo
              </label>
              <label style="display: flex; align-items: center; gap: 10px; padding: 14px; background: #fef2f2; border: 3px solid #fecaca; border-radius: 10px; cursor: pointer; transition: all 0.3s; font-weight: 700; font-size: 14px; color: #991b1b;" onmouseover="this.style.transform='scale(1.03)'; this.style.boxShadow='0 6px 20px rgba(220,38,38,0.2)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none'">
                <input type="checkbox" id="hcDiag_Presbicia" style="width: 22px; height: 22px; cursor: pointer;">
                üë¥ Presbicia
              </label>
              <label style="display: flex; align-items: center; gap: 10px; padding: 14px; background: #fef2f2; border: 3px solid #fecaca; border-radius: 10px; cursor: pointer; transition: all 0.3s; font-weight: 700; font-size: 14px; color: #991b1b;" onmouseover="this.style.transform='scale(1.03)'; this.style.boxShadow='0 6px 20px rgba(220,38,38,0.2)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none'">
                <input type="checkbox" id="hcDiag_Ambliopia" style="width: 22px; height: 22px; cursor: pointer;">
                üò∂‚Äçüå´Ô∏è Ambliop√≠a
              </label>
              <label style="display: flex; align-items: center; gap: 10px; padding: 14px; background: #fef2f2; border: 3px solid #fecaca; border-radius: 10px; cursor: pointer; transition: all 0.3s; font-weight: 700; font-size: 14px; color: #991b1b;" onmouseover="this.style.transform='scale(1.03)'; this.style.boxShadow='0 6px 20px rgba(220,38,38,0.2)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none'">
                <input type="checkbox" id="hcDiag_Anisometropia" style="width: 22px; height: 22px; cursor: pointer;">
                ‚öñÔ∏è Anisometrop√≠a
              </label>
              <label style="display: flex; align-items: center; gap: 10px; padding: 14px; background: #fef2f2; border: 3px solid #fecaca; border-radius: 10px; cursor: pointer; transition: all 0.3s; font-weight: 700; font-size: 14px; color: #991b1b;" onmouseover="this.style.transform='scale(1.03)'; this.style.boxShadow='0 6px 20px rgba(220,38,38,0.2)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none'">
                <input type="checkbox" id="hcDiag_Estrabismo" style="width: 22px; height: 22px; cursor: pointer;">
                üëÄ Estrabismo
              </label>
              <label style="display: flex; align-items: center; gap: 10px; padding: 14px; background: #fef2f2; border: 3px solid #fecaca; border-radius: 10px; cursor: pointer; transition: all 0.3s; font-weight: 700; font-size: 14px; color: #991b1b;" onmouseover="this.style.transform='scale(1.03)'; this.style.boxShadow='0 6px 20px rgba(220,38,38,0.2)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none'">
                <input type="checkbox" id="hcDiag_Catarata" style="width: 22px; height: 22px; cursor: pointer;">
                üå´Ô∏è Catarata
              </label>
              <label style="display: flex; align-items: center; gap: 10px; padding: 14px; background: #fef2f2; border: 3px solid #fecaca; border-radius: 10px; cursor: pointer; transition: all 0.3s; font-weight: 700; font-size: 14px; color: #991b1b;" onmouseover="this.style.transform='scale(1.03)'; this.style.boxShadow='0 6px 20px rgba(220,38,38,0.2)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none'">
                <input type="checkbox" id="hcDiag_Glaucoma" style="width: 22px; height: 22px; cursor: pointer;">
                ‚ö†Ô∏è Glaucoma
              </label>
            </div>
          </div>

          <div style="background: white; padding: 20px; border-radius: 12px; border: 3px solid #fca5a5;">
            <label style="display: block; font-weight: 700; color: #dc2626; margin-bottom: 10px; font-size: 15px;">üìã Plan de Tratamiento</label>
            <textarea id="hcDiag_PlanTratamiento" placeholder="Descripci√≥n detallada del plan de tratamiento, prescripci√≥n de lentes, seguimiento, derivaciones..." style="width: 100%; min-height: 120px; padding: 14px; border: 2px solid #fecaca; border-radius: 10px; font-size: 15px; font-family: inherit;"></textarea>
          </div>
        </div>
      </div>
    `,

    examinador: `
      <div style="animation: slideInFromRight 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);">
        <div style="background: linear-gradient(135deg, #f3e8ff, #e9d5ff); border-radius: 16px; padding: 28px; margin-bottom: 20px; box-shadow: 0 8px 30px rgba(168, 85, 247, 0.15);">
          <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 24px;">
            <div style="font-size: 56px; animation: bounceIn 0.6s ease;">üë®‚Äç‚öïÔ∏è</div>
            <h3 style="font-size: 26px; font-weight: 900; color: #6b21a8; margin: 0; letter-spacing: 1px;">DATOS DEL EXAMINADOR</h3>
          </div>

          <div style="background: white; padding: 26px; border-radius: 12px; border: 3px solid #d8b4fe;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
              <div>
                <label style="display: block; font-weight: 700; color: #374151; margin-bottom: 8px; font-size: 14px;">üë®‚Äç‚öïÔ∏è Nombre del Profesional</label>
                <input type="text" id="hcExam_Nombre" placeholder="Dr. Juan P√©rez Garc√≠a" style="width: 100%; padding: 14px; border: 3px solid #e9d5ff; border-radius: 10px; font-size: 15px; font-weight: 700;" onfocus="this.style.borderColor='#a855f7'; this.style.boxShadow='0 4px 20px rgba(168,85,247,0.2)'" onblur="this.style.borderColor='#e9d5ff'; this.style.boxShadow='none'">
              </div>

              <div>
                <label style="display: block; font-weight: 700; color: #374151; margin-bottom: 8px; font-size: 14px;">üéì Especialidad</label>
                <input type="text" id="hcExam_Especialidad" placeholder="Optometrista / Oftalm√≥logo" style="width: 100%; padding: 14px; border: 3px solid #e9d5ff; border-radius: 10px; font-size: 15px; font-weight: 700;" onfocus="this.style.borderColor='#a855f7'; this.style.boxShadow='0 4px 20px rgba(168,85,247,0.2)'" onblur="this.style.borderColor='#e9d5ff'; this.style.boxShadow='none'">
              </div>

              <div>
                <label style="display: block; font-weight: 700; color: #374151; margin-bottom: 8px; font-size: 14px;">üìã N√∫mero de Colegiatura</label>
                <input type="text" id="hcExam_Colegiatura" placeholder="COP 12345" style="width: 100%; padding: 14px; border: 3px solid #e9d5ff; border-radius: 10px; font-size: 15px; font-weight: 700;" onfocus="this.style.borderColor='#a855f7'; this.style.boxShadow='0 4px 20px rgba(168,85,247,0.2)'" onblur="this.style.borderColor='#e9d5ff'; this.style.boxShadow='none'">
              </div>

              <div>
                <label style="display: block; font-weight: 700; color: #374151; margin-bottom: 8px; font-size: 14px;">üìÖ Fecha de Examen</label>
                <input type="date" id="hcExam_Fecha" style="width: 100%; padding: 14px; border: 3px solid #e9d5ff; border-radius: 10px; font-size: 15px; font-weight: 700;" onfocus="this.style.borderColor='#a855f7'; this.style.boxShadow='0 4px 20px rgba(168,85,247,0.2)'" onblur="this.style.borderColor='#e9d5ff'; this.style.boxShadow='none'">
              </div>
            </div>

            <div style="background: linear-gradient(135deg, #fef3c7, #fde68a); padding: 18px; border-radius: 10px; border: 3px solid #f59e0b; margin-top: 20px;">
              <div style="display: flex; align-items: start; gap: 12px;">
                <div style="font-size: 32px;">‚úçÔ∏è</div>
                <div>
                  <div style="font-size: 16px; font-weight: 800; color: #92400e; margin-bottom: 8px;">Firma Digital del Profesional</div>
                  <div style="font-size: 13px; color: #78350f; line-height: 1.6;">
                    Al guardar este historial cl√≠nico, confirmo que todos los datos registrados son ver√≠dicos y que el examen fue realizado siguiendo los est√°ndares profesionales de optometr√≠a.
                  </div>
                </div>
              </div>
            </div>

            <div style="margin-top: 24px; text-align: center;">
              <button onclick="guardarHistorialClinico()" style="background: linear-gradient(135deg, #a855f7, #9333ea); color: white; border: none; padding: 16px 40px; border-radius: 12px; font-size: 17px; font-weight: 900; cursor: pointer; box-shadow: 0 8px 25px rgba(168,85,247,0.4); transition: all 0.3s;" onmouseover="this.style.transform='translateY(-3px) scale(1.05)'; this.style.boxShadow='0 12px 35px rgba(168,85,247,0.5)'" onmouseout="this.style.transform='translateY(0) scale(1)'; this.style.boxShadow='0 8px 25px rgba(168,85,247,0.4)'">
                üíæ GUARDAR HISTORIAL CL√çNICO COMPLETO
              </button>
            </div>
          </div>
        </div>
      </div>
    `
  };

  return contenidos[subPestana] || '<div style="padding: 20px; text-align: center; color: #6b7280;">Secci√≥n no encontrada</div>';
}

// ‚ú® FUNCI√ìN PARA CAMBIAR SUB-PESTA√ëAS DEL HISTORIAL CL√çNICO ‚ú®
function cambiarSubPestanaHistorial(subPestana) {
  // Resetear todos los botones
  const botones = ['subTabAnamnesis', 'subTabAgudeza', 'subTabMotilidad', 'subTabReflejos', 
                   'subTabOftalmoscopia', 'subTabKeratometria', 'subTabRetinoscopia', 
                   'subTabRefraccion', 'subTabDiagnostico', 'subTabExaminador'];
  
  botones.forEach(id => {
    const btn = document.getElementById(id);
    if (btn) {
      btn.style.background = 'white';
      btn.style.boxShadow = 'none';
    }
  });

  // Activar bot√≥n seleccionado
  const btnActivo = document.getElementById('subTab' + subPestana.charAt(0).toUpperCase() + subPestana.slice(1));
  if (btnActivo) {
    const color = btnActivo.style.borderColor;
    btnActivo.style.background = `linear-gradient(135deg, ${color}, ${color})`;
    btnActivo.style.color = 'white';
    btnActivo.style.boxShadow = `0 2px 8px ${color}66`;
  }

  // Cargar contenido seg√∫n la sub-pesta√±a
  const contenedor = document.getElementById('contenedorSubPestanas');
  contenedor.innerHTML = obtenerContenidoSubPestana(subPestana);
}

// ‚ú® FUNCI√ìN PARA CARGAR HISTORIAL DE PRESCRIPCIONES ‚ú®
function cargarHistorialPrescripciones() {
  if (!pacienteConsultorioActual || !pacienteConsultorioActual.id) {
    document.getElementById('listaHistorialPrescripciones').innerHTML = '<div style="text-align: center; padding: 20px; color: #6b7280;">No hay paciente seleccionado</div>';
    return;
  }

  const medidas = load(DB.MEDIDAS);
  const prescripcionesCliente = medidas
    .filter(m => m.clienteId === pacienteConsultorioActual.id)
    .sort((a, b) => (b.fecha || '').localeCompare(a.fecha || ''));

  const lista = document.getElementById('listaHistorialPrescripciones');

  if (prescripcionesCliente.length === 0) {
    lista.innerHTML = '<div style="text-align: center; padding: 20px; color: #6b7280; font-style: italic;">No hay prescripciones registradas para este paciente</div>';
    return;
  }

  lista.innerHTML = prescripcionesCliente.map((rx, index) => {
    const esMasReciente = index === 0;
    return `
      <div style="background: ${esMasReciente ? 'linear-gradient(135deg, #dbeafe, #bfdbfe)' : 'white'}; border: 2px solid ${esMasReciente ? '#3b82f6' : '#e5e7eb'}; border-radius: 10px; padding: 16px; margin-bottom: 12px; position: relative;">
        ${esMasReciente ? '<div style="position: absolute; top: 10px; right: 10px; background: #10b981; color: white; padding: 4px 12px; border-radius: 20px; font-size: 10px; font-weight: 700;">M√ÅS RECIENTE</div>' : ''}

        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
          <div>
            <div style="font-size: 13px; font-weight: 700; color: #1e40af; margin-bottom: 4px;">
              üìÖ ${formatDate(rx.fecha)} ${rx.especialista ? '| üë®‚Äç‚öïÔ∏è ' + rx.especialista : ''}
            </div>
            <div style="font-size: 11px; color: #6b7280;">C√≥digo: ${rx.codigo || rx.id}</div>
          </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
          ${(rx.lejosOdEsf || rx.lejosOiEsf) ? `
          <div style="background: linear-gradient(135deg, #f3e8ff, #e9d5ff); padding: 10px; border-radius: 8px; border: 2px solid #a855f7;">
            <div style="font-weight: 700; color: #7c3aed; font-size: 11px; margin-bottom: 6px;">üëÅÔ∏è VISI√ìN DE DISTANCIA</div>
            <div style="font-size: 10px; color: #374151; line-height: 1.6;">
              <div><strong>O.D.:</strong> ESF ${rx.lejosOdEsf || '-'} | CIL ${rx.lejosOdCil || '-'} | EJE ${rx.lejosOdEje || '-'}</div>
              <div><strong>O.I.:</strong> ESF ${rx.lejosOiEsf || '-'} | CIL ${rx.lejosOiCil || '-'} | EJE ${rx.lejosOiEje || '-'}</div>
              ${rx.lejosDip ? `<div><strong>DIP:</strong> ${rx.lejosDip}</div>` : ''}
            </div>
          </div>
          ` : ''}

          ${(rx.cercaOdEsf || rx.cercaOiEsf) ? `
          <div style="background: linear-gradient(135deg, #d1fae5, #a7f3d0); padding: 10px; border-radius: 8px; border: 2px solid #10b981;">
            <div style="font-weight: 700; color: #059669; font-size: 11px; margin-bottom: 6px;">üìñ VISI√ìN DE CERCA</div>
            <div style="font-size: 10px; color: #374151; line-height: 1.6;">
              <div><strong>O.D.:</strong> ESF ${rx.cercaOdEsf || '-'} | CIL ${rx.cercaOdCil || '-'} | EJE ${rx.cercaOdEje || '-'}</div>
              <div><strong>O.I.:</strong> ESF ${rx.cercaOiEsf || '-'} | CIL ${rx.cercaOiCil || '-'} | EJE ${rx.cercaOiEje || '-'}</div>
            </div>
          </div>
          ` : ''}
        </div>

        <div style="margin-top: 12px; display: flex; gap: 8px; justify-content: flex-end;">
          <button onclick="cargarPrescripcionEnFormulario('${rx.id}')" style="background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; border: none; padding: 6px 14px; border-radius: 6px; font-size: 11px; font-weight: 700; cursor: pointer; box-shadow: 0 2px 6px rgba(59, 130, 246, 0.3);" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
            üì• Cargar en Formulario
          </button>
          <button onclick="imprimirPrescripcionIndividual('${rx.id}')" style="background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; padding: 6px 14px; border-radius: 6px; font-size: 11px; font-weight: 700; cursor: pointer; box-shadow: 0 2px 6px rgba(16, 185, 129, 0.3);" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
            üñ®Ô∏è Imprimir
          </button>
        </div>
      </div>
    `;
  }).join('');
}

// ‚ú® FUNCI√ìN PARA CARGAR PRESCRIPCI√ìN EN FORMULARIO ‚ú®
function cargarPrescripcionEnFormulario(rxId) {
  const medidas = load(DB.MEDIDAS);
  const rx = medidas.find(m => m.id === rxId);

  if (!rx) {
    toast('‚ùå Prescripci√≥n no encontrada', 'error');
    return;
  }

  // Cargar datos de distancia
  document.getElementById('rxDistEsfOD').value = rx.lejosOdEsf || '';
  document.getElementById('rxDistCilOD').value = rx.lejosOdCil || '';
  document.getElementById('rxDistEjeOD').value = rx.lejosOdEje || '';
  document.getElementById('rxDistDipOD').value = rx.lejosDip || '';
  document.getElementById('rxDistAvOD').value = rx.lejosOdAv || '';

  document.getElementById('rxDistEsfOI').value = rx.lejosOiEsf || '';
  document.getElementById('rxDistCilOI').value = rx.lejosOiCil || '';
  document.getElementById('rxDistEjeOI').value = rx.lejosOiEje || '';
  document.getElementById('rxDistDipOI').value = rx.lejosDip || '';
  document.getElementById('rxDistAvOI').value = rx.lejosOiAv || '';

  // Cargar especialista y observaciones si existen
  if (rx.especialista) document.getElementById('rxEspecialista').value = rx.especialista;
  if (rx.observaciones) document.getElementById('rxObservaciones').value = rx.observaciones;

  // Cerrar panel de historial
  document.getElementById('panelHistorialPrescripciones').style.display = 'none';
  document.getElementById('textoToggleHistorial').textContent = 'üìñ Ver Historial';

  toast('‚úÖ Prescripci√≥n cargada en el formulario', 'success');
}

// ‚ú® FUNCI√ìN PARA IMPRIMIR PRESCRIPCI√ìN INDIVIDUAL ‚ú®
function imprimirPrescripcionIndividual(rxId) {
  const medidas = load(DB.MEDIDAS);
  const rx = medidas.find(m => m.id === rxId);

  if (!rx) {
    toast('‚ùå Prescripci√≥n no encontrada', 'error');
    return;
  }

  // Usar la funci√≥n existente verMedidaConsulta que ya imprime
  verMedidaConsulta(rxId);
}

// ‚ú® FUNCI√ìN TOGGLE PARA GUARDADO AUTOM√ÅTICO EN CONSULTORIO ‚ú®
function toggleAutoGuardadoConsultorio() {
  const estadoSpan = document.getElementById('estadoAutoGuardado');
  if (estadoSpan.textContent === 'Activado') {
    estadoSpan.textContent = 'Desactivado';
    toast('‚ö†Ô∏è Guardado autom√°tico desactivado', 'warning');
  } else {
    estadoSpan.textContent = 'Activado';
    toast('‚úÖ Guardado autom√°tico activado', 'success');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// üöÄ SISTEMA DE SINCRONIZACI√ìN EN TIEMPO REAL - PRESCRIPCIONES UNIFICADAS üöÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Este sistema permite que los datos de prescripci√≥n se sincronicen autom√°ticamente
// entre CONSULTORIO, CLIENTES y VENTAS en tiempo real.
//
// Cuando completes datos en cualquier m√≥dulo, se actualizan INMEDIATAMENTE en todos
// los dem√°s. ¬°Una sola fuente de verdad para toda la prescripci√≥n!
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// üì¶ MODELO DE DATOS UNIFICADO - SINGLE SOURCE OF TRUTH
let PrescripcionCentralActual = {
  clienteId: '',
  fecha: '',
  profesional: '',

  // DISTANCIA (LEJOS)
  distancia: {
    od: { esf: '', cil: '', eje: '', av: '', dp: '' },
    oi: { esf: '', cil: '', eje: '', av: '', dp: '' },
    ao: { av: '' }
  },

  // CERCA
  cerca: {
    od: { esf: '', cil: '', eje: '', av: '', add: '' },
    oi: { esf: '', cil: '', eje: '', av: '', add: '' },
    ao: { av: '' }
  },

  // PIO (Presi√≥n Intraocular)
  pio: {
    od: '',
    oi: ''
  },

  // DIAGN√ìSTICOS
  diagnosticos: {
    miopia: false,
    hipermetropia: false,
    astigmatismo: false,
    presbicia: false,
    ambliopia: false,
    anisometropia: false
  },

  // OBSERVACIONES
  observaciones: '',
  proximaCita: ''
};

// üîÑ FUNCI√ìN PRINCIPAL: ACTUALIZAR PRESCRIPCI√ìN GLOBAL
// Esta funci√≥n se llama cada vez que cambia un campo de prescripci√≥n
function actualizarPrescripcionGlobal(campo, valor, origen = 'unknown') {
  // Determinar la ruta en el objeto PrescripcionCentralActual
  const rutas = {
    // DISTANCIA OD
    'rxDistEsfOD': 'distancia.od.esf',
    'lejosOdEsf': 'distancia.od.esf',
    'od_esf_consultorio': 'distancia.od.esf',

    'rxDistCilOD': 'distancia.od.cil',
    'lejosOdCil': 'distancia.od.cil',
    'od_cil_consultorio': 'distancia.od.cil',

    'rxDistEjeOD': 'distancia.od.eje',
    'lejosOdEje': 'distancia.od.eje',
    'od_eje_consultorio': 'distancia.od.eje',

    'rxDistAvOD': 'distancia.od.av',
    'lejosOdAv': 'distancia.od.av',
    'od_av_consultorio': 'distancia.od.av',

    'rxDistDpOD': 'distancia.od.dp',
    'lejosDpOd': 'distancia.od.dp',
    'od_dp_consultorio': 'distancia.od.dp',

    // DISTANCIA OI
    'rxDistEsfOI': 'distancia.oi.esf',
    'lejosOiEsf': 'distancia.oi.esf',
    'oi_esf_consultorio': 'distancia.oi.esf',

    'rxDistCilOI': 'distancia.oi.cil',
    'lejosOiCil': 'distancia.oi.cil',
    'oi_cil_consultorio': 'distancia.oi.cil',

    'rxDistEjeOI': 'distancia.oi.eje',
    'lejosOiEje': 'distancia.oi.eje',
    'oi_eje_consultorio': 'distancia.oi.eje',

    'rxDistAvOI': 'distancia.oi.av',
    'lejosOiAv': 'distancia.oi.av',
    'oi_av_consultorio': 'distancia.oi.av',

    'rxDistDpOI': 'distancia.oi.dp',
    'lejosDpOi': 'distancia.oi.dp',
    'oi_dp_consultorio': 'distancia.oi.dp',

    // DISTANCIA AO
    'rxDistAvAO': 'distancia.ao.av',
    'lejosAoAv': 'distancia.ao.av',
    'ao_av_consultorio': 'distancia.ao.av',

    // CERCA OD
    'rxCercaEsfOD': 'cerca.od.esf',
    'cercaOdEsf': 'cerca.od.esf',
    'od_esf_cerca_consultorio': 'cerca.od.esf',

    'rxCercaCilOD': 'cerca.od.cil',
    'cercaOdCil': 'cerca.od.cil',
    'od_cil_cerca_consultorio': 'cerca.od.cil',

    'rxCercaEjeOD': 'cerca.od.eje',
    'cercaOdEje': 'cerca.od.eje',
    'od_eje_cerca_consultorio': 'cerca.od.eje',

    'rxCercaAvOD': 'cerca.od.av',
    'cercaOdAv': 'cerca.od.av',
    'od_av_cerca_consultorio': 'cerca.od.av',

    'rxCercaAddOD': 'cerca.od.add',
    'cercaOdAdd': 'cerca.od.add',
    'od_add_consultorio': 'cerca.od.add',

    // CERCA OI
    'rxCercaEsfOI': 'cerca.oi.esf',
    'cercaOiEsf': 'cerca.oi.esf',
    'oi_esf_cerca_consultorio': 'cerca.oi.esf',

    'rxCercaCilOI': 'cerca.oi.cil',
    'cercaOiCil': 'cerca.oi.cil',
    'oi_cil_cerca_consultorio': 'cerca.oi.cil',

    'rxCercaEjeOI': 'cerca.oi.eje',
    'cercaOiEje': 'cerca.oi.eje',
    'oi_eje_cerca_consultorio': 'cerca.oi.eje',

    'rxCercaAvOI': 'cerca.oi.av',
    'cercaOiAv': 'cerca.oi.av',
    'oi_av_cerca_consultorio': 'cerca.oi.av',

    'rxCercaAddOI': 'cerca.oi.add',
    'cercaOiAdd': 'cerca.oi.add',
    'oi_add_consultorio': 'cerca.oi.add',

    // CERCA AO
    'rxCercaAvAO': 'cerca.ao.av',
    'cercaAoAv': 'cerca.ao.av',
    'ao_av_cerca_consultorio': 'cerca.ao.av',

    // PIO
    'rxPioOD': 'pio.od',
    'oftTonoOd': 'pio.od',
    'pio_od_consultorio': 'pio.od',

    'rxPioOI': 'pio.oi',
    'oftTonoOi': 'pio.oi',
    'pio_oi_consultorio': 'pio.oi',

    // DIAGN√ìSTICOS
    'diagMiopia': 'diagnosticos.miopia',
    'diagHipermetropia': 'diagnosticos.hipermetropia',
    'diagAstigmatismo': 'diagnosticos.astigmatismo',
    'diagPresbicia': 'diagnosticos.presbicia',
    'diagAmbliopia': 'diagnosticos.ambliopia',
    'diagAnisometropia': 'diagnosticos.anisometropia',

    // OBSERVACIONES
    'rxObservacion': 'observaciones',
    'rxProximaCita': 'proximaCita'
  };

  const ruta = rutas[campo];
  if (!ruta) {
    console.warn(`‚ö†Ô∏è Campo no mapeado en sincronizaci√≥n: ${campo}`);
    return;
  }

  // Actualizar el valor en PrescripcionCentralActual
  const partes = ruta.split('.');
  let obj = PrescripcionCentralActual;
  for (let i = 0; i < partes.length - 1; i++) {
    obj = obj[partes[i]];
  }
  obj[partes[partes.length - 1]] = valor;

  // Guardar en localStorage
  localStorage.setItem('prescripcion_central', JSON.stringify(PrescripcionCentralActual));

  // Sincronizar todos los m√≥dulos (excepto el origen para evitar loops)
  sincronizarModulosRX(origen);

  console.log(`‚úÖ Sincronizaci√≥n: ${campo} = "${valor}" [origen: ${origen}]`);
}

// üîÑ SINCRONIZAR TODOS LOS M√ìDULOS
function sincronizarModulosRX(origen = '') {
  const data = PrescripcionCentralActual;

  // Sincronizar CONSULTORIO (si no es el origen)
  if (origen !== 'consultorio') {
    sincronizarConsultorio(data);
  }

  // Sincronizar CLIENTES - Nueva RX (si no es el origen)
  if (origen !== 'nuevarx') {
    sincronizarNuevaRX(data);
  }

  // Sincronizar VENTAS (si no es el origen)
  if (origen !== 'ventas') {
    sincronizarVentas(data);
  }
}

// üìù SINCRONIZAR CONSULTORIO
function sincronizarConsultorio(data) {
  const setValueSafe = (id, value) => {
    const elem = document.getElementById(id);
    if (elem) {
      if (elem.type === 'checkbox') {
        elem.checked = value;
      } else {
        elem.value = value || '';
      }
    }
  };

  // DISTANCIA
  setValueSafe('od_esf_consultorio', data.distancia.od.esf);
  setValueSafe('od_cil_consultorio', data.distancia.od.cil);
  setValueSafe('od_eje_consultorio', data.distancia.od.eje);
  setValueSafe('od_av_consultorio', data.distancia.od.av);
  setValueSafe('od_dp_consultorio', data.distancia.od.dp);

  setValueSafe('oi_esf_consultorio', data.distancia.oi.esf);
  setValueSafe('oi_cil_consultorio', data.distancia.oi.cil);
  setValueSafe('oi_eje_consultorio', data.distancia.oi.eje);
  setValueSafe('oi_av_consultorio', data.distancia.oi.av);
  setValueSafe('oi_dp_consultorio', data.distancia.oi.dp);

  setValueSafe('ao_av_consultorio', data.distancia.ao.av);

  // CERCA
  setValueSafe('od_esf_cerca_consultorio', data.cerca.od.esf);
  setValueSafe('od_cil_cerca_consultorio', data.cerca.od.cil);
  setValueSafe('od_eje_cerca_consultorio', data.cerca.od.eje);
  setValueSafe('od_av_cerca_consultorio', data.cerca.od.av);
  setValueSafe('od_add_consultorio', data.cerca.od.add);

  setValueSafe('oi_esf_cerca_consultorio', data.cerca.oi.esf);
  setValueSafe('oi_cil_cerca_consultorio', data.cerca.oi.cil);
  setValueSafe('oi_eje_cerca_consultorio', data.cerca.oi.eje);
  setValueSafe('oi_av_cerca_consultorio', data.cerca.oi.av);
  setValueSafe('oi_add_consultorio', data.cerca.oi.add);

  setValueSafe('ao_av_cerca_consultorio', data.cerca.ao.av);

  // PIO
  setValueSafe('pio_od_consultorio', data.pio.od);
  setValueSafe('pio_oi_consultorio', data.pio.oi);
}

// üìù SINCRONIZAR NUEVA RX (CLIENTES)
function sincronizarNuevaRX(data) {
  const setValueSafe = (id, value) => {
    const elem = document.getElementById(id);
    if (elem) {
      if (elem.type === 'checkbox') {
        elem.checked = value;
      } else {
        elem.value = value || '';
      }
    }
  };

  // DISTANCIA (LEJOS)
  setValueSafe('lejosOdEsf', data.distancia.od.esf);
  setValueSafe('lejosOdCil', data.distancia.od.cil);
  setValueSafe('lejosOdEje', data.distancia.od.eje);
  setValueSafe('lejosOdAv', data.distancia.od.av);
  setValueSafe('lejosDpOd', data.distancia.od.dp);

  setValueSafe('lejosOiEsf', data.distancia.oi.esf);
  setValueSafe('lejosOiCil', data.distancia.oi.cil);
  setValueSafe('lejosOiEje', data.distancia.oi.eje);
  setValueSafe('lejosOiAv', data.distancia.oi.av);
  setValueSafe('lejosDpOi', data.distancia.oi.dp);

  setValueSafe('lejosAoAv', data.distancia.ao.av);

  // CERCA
  setValueSafe('cercaOdEsf', data.cerca.od.esf);
  setValueSafe('cercaOdCil', data.cerca.od.cil);
  setValueSafe('cercaOdEje', data.cerca.od.eje);
  setValueSafe('cercaOdAv', data.cerca.od.av);
  setValueSafe('cercaOdAdd', data.cerca.od.add);

  setValueSafe('cercaOiEsf', data.cerca.oi.esf);
  setValueSafe('cercaOiCil', data.cerca.oi.cil);
  setValueSafe('cercaOiEje', data.cerca.oi.eje);
  setValueSafe('cercaOiAv', data.cerca.oi.av);
  setValueSafe('cercaOiAdd', data.cerca.oi.add);

  setValueSafe('cercaAoAv', data.cerca.ao.av);

  // PIO
  setValueSafe('oftTonoOd', data.pio.od);
  setValueSafe('oftTonoOi', data.pio.oi);

  // DIAGN√ìSTICOS
  setValueSafe('diagMiopia', data.diagnosticos.miopia);
  setValueSafe('diagHipermetropia', data.diagnosticos.hipermetropia);
  setValueSafe('diagAstigmatismo', data.diagnosticos.astigmatismo);
  setValueSafe('diagPresbicia', data.diagnosticos.presbicia);
  setValueSafe('diagAmbliopia', data.diagnosticos.ambliopia);
  setValueSafe('diagAnisometropia', data.diagnosticos.anisometropia);

  // OBSERVACIONES
  setValueSafe('rxObservacion', data.observaciones);
  setValueSafe('rxProximaCita', data.proximaCita);
}

// üìù SINCRONIZAR VENTAS
function sincronizarVentas(data) {
  const setValueSafe = (id, value) => {
    const elem = document.getElementById(id);
    if (elem) {
      if (elem.type === 'checkbox') {
        elem.checked = value;
      } else {
        elem.value = value || '';
      }
    }
  };

  // DISTANCIA
  setValueSafe('rxDistEsfOD', data.distancia.od.esf);
  setValueSafe('rxDistCilOD', data.distancia.od.cil);
  setValueSafe('rxDistEjeOD', data.distancia.od.eje);
  setValueSafe('rxDistAvOD', data.distancia.od.av);
  setValueSafe('rxDistDpOD', data.distancia.od.dp);

  setValueSafe('rxDistEsfOI', data.distancia.oi.esf);
  setValueSafe('rxDistCilOI', data.distancia.oi.cil);
  setValueSafe('rxDistEjeOI', data.distancia.oi.eje);
  setValueSafe('rxDistAvOI', data.distancia.oi.av);
  setValueSafe('rxDistDpOI', data.distancia.oi.dp);

  setValueSafe('rxDistAvAO', data.distancia.ao.av);

  // CERCA
  setValueSafe('rxCercaEsfOD', data.cerca.od.esf);
  setValueSafe('rxCercaCilOD', data.cerca.od.cil);
  setValueSafe('rxCercaEjeOD', data.cerca.od.eje);
  setValueSafe('rxCercaAvOD', data.cerca.od.av);
  setValueSafe('rxCercaAddOD', data.cerca.od.add);

  setValueSafe('rxCercaEsfOI', data.cerca.oi.esf);
  setValueSafe('rxCercaCilOI', data.cerca.oi.cil);
  setValueSafe('rxCercaEjeOI', data.cerca.oi.eje);
  setValueSafe('rxCercaAvOI', data.cerca.oi.av);
  setValueSafe('rxCercaAddOI', data.cerca.oi.add);

  setValueSafe('rxCercaAvAO', data.cerca.ao.av);

  // PIO
  setValueSafe('rxPioOD', data.pio.od);
  setValueSafe('rxPioOI', data.pio.oi);
}

// üéØ INICIALIZAR SISTEMA DE SINCRONIZACI√ìN
function inicializarSincronizacionRX() {
  console.log('üöÄ Inicializando sistema de sincronizaci√≥n en tiempo real...');

  // Cargar datos previos de localStorage si existen
  const datosGuardados = localStorage.getItem('prescripcion_central');
  if (datosGuardados) {
    try {
      PrescripcionCentralActual = JSON.parse(datosGuardados);
      console.log('‚úÖ Datos de prescripci√≥n cargados desde localStorage');
    } catch (e) {
      console.warn('‚ö†Ô∏è Error al cargar datos de prescripci√≥n:', e);
    }
  }

  // Lista de todos los IDs de campos que necesitan sincronizaci√≥n
  const camposConsultorio = [
    'od_esf_consultorio', 'od_cil_consultorio', 'od_eje_consultorio', 'od_av_consultorio', 'od_dp_consultorio',
    'oi_esf_consultorio', 'oi_cil_consultorio', 'oi_eje_consultorio', 'oi_av_consultorio', 'oi_dp_consultorio',
    'ao_av_consultorio',
    'od_esf_cerca_consultorio', 'od_cil_cerca_consultorio', 'od_eje_cerca_consultorio', 'od_av_cerca_consultorio', 'od_add_consultorio',
    'oi_esf_cerca_consultorio', 'oi_cil_cerca_consultorio', 'oi_eje_cerca_consultorio', 'oi_av_cerca_consultorio', 'oi_add_consultorio',
    'ao_av_cerca_consultorio',
    'pio_od_consultorio', 'pio_oi_consultorio'
  ];

  const camposNuevaRX = [
    'lejosOdEsf', 'lejosOdCil', 'lejosOdEje', 'lejosOdAv', 'lejosDpOd',
    'lejosOiEsf', 'lejosOiCil', 'lejosOiEje', 'lejosOiAv', 'lejosDpOi',
    'lejosAoAv',
    'cercaOdEsf', 'cercaOdCil', 'cercaOdEje', 'cercaOdAv', 'cercaOdAdd',
    'cercaOiEsf', 'cercaOiCil', 'cercaOiEje', 'cercaOiAv', 'cercaOiAdd',
    'cercaAoAv',
    'oftTonoOd', 'oftTonoOi',
    // DIAGN√ìSTICOS REMOVIDOS DE LA SINCRONIZACI√ìN AUTOM√ÅTICA - No deben sincronizarse con EJE ni PIO
    // 'diagMiopia', 'diagHipermetropia', 'diagAstigmatismo', 'diagPresbicia', 'diagAmbliopia', 'diagAnisometropia',
    'rxObservacion', 'rxProximaCita'
  ];

  const camposVentas = [
    'rxDistEsfOD', 'rxDistCilOD', 'rxDistEjeOD', 'rxDistAvOD', 'rxDistDpOD',
    'rxDistEsfOI', 'rxDistCilOI', 'rxDistEjeOI', 'rxDistAvOI', 'rxDistDpOI',
    'rxDistAvAO',
    'rxCercaEsfOD', 'rxCercaCilOD', 'rxCercaEjeOD', 'rxCercaAvOD', 'rxCercaAddOD',
    'rxCercaEsfOI', 'rxCercaCilOI', 'rxCercaEjeOI', 'rxCercaAvOI', 'rxCercaAddOI',
    'rxCercaAvAO',
    'rxPioOD', 'rxPioOI'
  ];

  // Adjuntar event listeners a CONSULTORIO
  camposConsultorio.forEach(campoId => {
    const elem = document.getElementById(campoId);
    if (elem) {
      const eventType = elem.type === 'checkbox' ? 'change' : 'input';
      elem.addEventListener(eventType, function(e) {
        const valor = elem.type === 'checkbox' ? elem.checked : elem.value;
        actualizarPrescripcionGlobal(campoId, valor, 'consultorio');
      });
    }
  });

  // Adjuntar event listeners a NUEVA RX
  camposNuevaRX.forEach(campoId => {
    const elem = document.getElementById(campoId);
    if (elem) {
      const eventType = elem.type === 'checkbox' ? 'change' : 'input';
      elem.addEventListener(eventType, function(e) {
        const valor = elem.type === 'checkbox' ? elem.checked : elem.value;
        actualizarPrescripcionGlobal(campoId, valor, 'nuevarx');
      });
    }
  });

  // Adjuntar event listeners a VENTAS
  camposVentas.forEach(campoId => {
    const elem = document.getElementById(campoId);
    if (elem) {
      const eventType = elem.type === 'checkbox' ? 'change' : 'input';
      elem.addEventListener(eventType, function(e) {
        const valor = elem.type === 'checkbox' ? elem.checked : elem.value;
        actualizarPrescripcionGlobal(campoId, valor, 'ventas');
      });
    }
  });

  console.log(`‚úÖ Sincronizaci√≥n configurada para ${camposConsultorio.length + camposNuevaRX.length + camposVentas.length} campos`);
  console.log('üéØ SISTEMA DE SINCRONIZACI√ìN EN TIEMPO REAL ACTIVADO');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FIN DEL SISTEMA DE SINCRONIZACI√ìN EN TIEMPO REAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function cerrarPrescripcion() {
  document.getElementById('prescripcionWindow').style.display = 'none';
}

// ‚ú® NUEVA FUNCI√ìN DE IMPRESI√ìN CON DISE√ëO ULTRA MODERNO ‚ú®
function imprimirPrescripcion() {
  const clienteId = document.getElementById('rxClienteIdHidden').value;
  const cliente = load(DB.CLIENTES).find(c => c.id === clienteId);
  if (!cliente) { toast('No hay cliente seleccionado', 'error'); return; }

  const fecha = document.getElementById('rxFecha').value;
  const edad = document.getElementById('rxEdad').value || '';
  const especialista = document.getElementById('rxEspecialista').value || '';
  const proximaCita = document.getElementById('rxProximaCita').value || '';
  const observaciones = document.getElementById('rxObservacion').value || '';

  // Preparar datos en el formato que espera imprimirPrescripcionUnificada
  const datosImpresion = {
    // Informaci√≥n del paciente
    nombreCliente: ((cliente.nombre || cliente.nombres || '') + ' ' + (cliente.apellidos || cliente.apellido || '')).trim(),
    dniCliente: cliente.documento || '',
    edad: edad,
    fechaFormato: formatDate(fecha),
    fecha: fecha,

    // DISTANCIA (LEJOS)
    rxDistEsfOD: document.getElementById('lejosOdEsf').value || '',
    rxDistCilOD: document.getElementById('lejosOdCil').value || '',
    rxDistEjeOD: document.getElementById('lejosOdEje').value || '',
    rxDistDipOD: document.getElementById('lejosDip').value || '',

    rxDistEsfOI: document.getElementById('lejosOiEsf').value || '',
    rxDistCilOI: document.getElementById('lejosOiCil').value || '',
    rxDistEjeOI: document.getElementById('lejosOiEje').value || '',
    rxDistDipOI: '',

    // CERCA
    rxCercaEsfOD: document.getElementById('cercaOdEsf').value || '',
    rxCercaCilOD: document.getElementById('cercaOdCil').value || '',
    rxCercaEjeOD: document.getElementById('cercaOdEje').value || '',
    rxCercaDipOD: document.getElementById('cercaDip').value || '',

    rxCercaEsfOI: document.getElementById('cercaOiEsf').value || '',
    rxCercaCilOI: document.getElementById('cercaOiCil').value || '',
    rxCercaEjeOI: document.getElementById('cercaOiEje').value || '',
    rxCercaDipOI: '',

    // PIO (Presi√≥n Intraocular)
    rxPioOD: document.getElementById('oftTonoOd').value || '',
    rxPioOI: document.getElementById('oftTonoOi').value || '',

    // DIAGN√ìSTICO
    diagMiopia: document.getElementById('diagMiopia')?.checked || false,
    diagHipermetropia: document.getElementById('diagHipermetropia')?.checked || false,
    diagAstigmatismo: document.getElementById('diagAstigmatismo')?.checked || false,
    diagPresbicia: document.getElementById('diagPresbicia')?.checked || false,
    diagAmbliopia: document.getElementById('diagAmbliopia')?.checked || false,
    diagAnisometropia: document.getElementById('diagAnisometropia')?.checked || false,

    // OTROS DATOS
    rxObservaciones: observaciones,
    rxEspecialista: especialista,
    proximoControl: proximaCita ? formatDate(proximaCita) : ''
  };

  // Usar la funci√≥n unificada de impresi√≥n profesional
  imprimirPrescripcionUnificada(datosImpresion, 'PRESCRIPCION');
}

function exportarPrescripcionExcel() {
  const clienteId = document.getElementById('rxClienteIdHidden').value;
  const clientes = load(DB.CLIENTES);
  const cliente = clientes.find(c => c.id === clienteId);
  const medidas = load(DB.MEDIDAS).filter(m => m.clienteId === clienteId);

  if (medidas.length === 0) { toast('No hay prescripciones', 'warning'); return; }

  // ‚úÖ Nombre completo en exportaci√≥n individual
  const nombreCliente = cliente
    ? (cliente.nombres + ' ' + (cliente.apellidos || '')).trim()
    : 'Sin nombre';
  const docCliente = cliente?.documento || '';

  // Headers completos con todas las medidas
  const headers = [
    'CLIENTE', 'DOCUMENTO', 'FECHA', 'TIPO_RX',
    // Visi√≥n de Lejos
    'LEJOS_OD_ESF', 'LEJOS_OD_CIL', 'LEJOS_OD_EJE', 'LEJOS_OD_AV', 'LEJOS_DIP', 'LEJOS_OD_NP', 'LEJOS_OD_PRISMA', 'LEJOS_OD_ADD', 'LEJOS_OD_ADD_MEDIA',
    'LEJOS_OI_ESF', 'LEJOS_OI_CIL', 'LEJOS_OI_EJE', 'LEJOS_OI_NP', 'LEJOS_OI_PRISMA', 'LEJOS_OI_ADD', 'LEJOS_OI_ADD_MEDIA',
    // Visi√≥n de Cerca
    'CERCA_OD_ESF', 'CERCA_OD_CIL', 'CERCA_OD_EJE', 'CERCA_OD_AV', 'CERCA_DIP', 'CERCA_OD_NP', 'CERCA_OD_PRISMA', 'CERCA_ALTURA',
    'CERCA_OI_ESF', 'CERCA_OI_CIL', 'CERCA_OI_EJE', 'CERCA_OI_NP', 'CERCA_OI_PRISMA',
    // Visi√≥n Intermedia
    'INTER_OD_ESF', 'INTER_OD_CIL', 'INTER_OD_EJE', 'INTER_OD_AV', 'INTER_DIP', 'INTER_OD_NP', 'INTER_OD_PRISMA', 'INTER_DTRA',
    'INTER_OI_ESF', 'INTER_OI_CIL', 'INTER_OI_EJE', 'INTER_OI_NP', 'INTER_OI_PRISMA',
    // Extras
    'ESPECIALISTA', 'OBSERVACION'
  ];

  const rows = medidas.map(m => [
    '"' + nombreCliente + '"',
    docCliente,
    m.fecha || '',
    m.tipo || 'PROPIA',
    // Visi√≥n de Lejos OD
    m.lejosOdEsf || '', m.lejosOdCil || '', m.lejosOdEje || '', m.lejosOdAv || '', m.lejosDip || '', m.lejosOdNp || '', m.lejosOdPrisma || '', m.lejosOdAdd || '', m.lejosOdAddMedia || '',
    // Visi√≥n de Lejos OI
    m.lejosOiEsf || '', m.lejosOiCil || '', m.lejosOiEje || '', m.lejosOiNp || '', m.lejosOiPrisma || '', m.lejosOiAdd || '', m.lejosOiAddMedia || '',
    // Visi√≥n de Cerca OD
    m.cercaOdEsf || '', m.cercaOdCil || '', m.cercaOdEje || '', m.cercaOdAv || '', m.cercaDip || '', m.cercaOdNp || '', m.cercaOdPrisma || '', m.cercaAltura || '',
    // Visi√≥n de Cerca OI
    m.cercaOiEsf || '', m.cercaOiCil || '', m.cercaOiEje || '', m.cercaOiNp || '', m.cercaOiPrisma || '',
    // Visi√≥n Intermedia OD
    m.interOdEsf || '', m.interOdCil || '', m.interOdEje || '', m.interOdAv || '', m.interDip || '', m.interOdNp || '', m.interOdPrisma || '', m.interDtra || '',
    // Visi√≥n Intermedia OI
    m.interOiEsf || '', m.interOiCil || '', m.interOiEje || '', m.interOiNp || '', m.interOiPrisma || '',
    // Extras
    '"' + (m.especialista || '') + '"',
    '"' + (m.rxObservacion || '').replace(/"/g, '""') + '"'
  ]);

  const csv = generarCSV(headers, rows);
  const nombreArchivo = 'prescripcion_' + nombreCliente.replace(/[^a-zA-Z0-9]/g, '_') + '_' + (medidas[0]?.fecha || 'sin_fecha') + '.csv';
  descargarCSV(csv, nombreArchivo);
  toast('Prescripci√≥n de ' + nombreCliente + ' exportada');
}

/* ============================================
   BUSCAR PRESCRIPCIONES
   ============================================ */
function buscarPrescripciones() {
  const medidas = load(DB.MEDIDAS);
  const clientes = load(DB.CLIENTES);
  const texto = (document.getElementById('buscarRxTexto')?.value || '').toLowerCase();
  const desde = document.getElementById('buscarRxDesde')?.value;
  const hasta = document.getElementById('buscarRxHasta')?.value;
  const especialista = document.getElementById('buscarRxEspecialista')?.value;

  const filtradas = medidas.filter(m => {
    const cliente = clientes.find(c => c.id === m.clienteId);

    if (texto) {
      // ‚úÖ Buscar en nombre completo (nombres + apellidos)
      const nombreCompleto = cliente
        ? (cliente.nombres + ' ' + (cliente.apellidos || '')).trim().toLowerCase()
        : '';
      const nombreMatch = nombreCompleto.includes(texto);
      const docMatch = cliente?.documento?.toLowerCase().includes(texto);
      if (!nombreMatch && !docMatch) return false;
    }

    if (desde && m.fecha < desde) return false;
    if (hasta && m.fecha > hasta) return false;
    if (especialista && m.especialista !== especialista) return false;

    return true;
  });

  // Detectar duplicados por clienteId y fecha
  const duplicados = {};
  filtradas.forEach(m => {
    const key = `${m.clienteId}_${m.fecha}`;
    if (!duplicados[key]) duplicados[key] = [];
    duplicados[key].push(m);
  });

  document.getElementById('buscarRxBody').innerHTML = filtradas.map(m => {
    const cliente = clientes.find(c => c.id === m.clienteId);
    // ‚úÖ Mostrar nombre completo (nombres + apellidos)
    const nombreCompleto = cliente
      ? (cliente.nombres + ' ' + (cliente.apellidos || '')).trim()
      : '-';

    // Verificar si es duplicado
    const key = `${m.clienteId}_${m.fecha}`;
    const esDuplicado = duplicados[key] && duplicados[key].length > 1;
    const bgColor = esDuplicado ? 'background: #fef3c7;' : '';
    const etiquetaDuplicado = m.excepcion === 'Duplicado' ? '<span style="color: #dc2626; font-weight: bold;">[DUPLICADO]</span>' : '';

    return `
      <tr style="${bgColor}">
        <td>${m.codigo || m.id.split('_')[1]}</td>
        <td><strong>${nombreCompleto}</strong> ${etiquetaDuplicado}</td>
        <td>${formatDate(m.fecha)}</td>
        <td>${m.especialista || '-'}</td>
        <td>${m.tipo || 'PROPIA'}</td>
        <td class="text-center">
          <button class="btn btn-info btn-sm" onclick="verPrescripcionCliente('${m.clienteId}')" style="margin-right: 5px;">üëÅÔ∏è Ver</button>
          ${esDuplicado && !m.excepcion ? `<button class="btn btn-warning btn-sm" onclick="marcarComoDuplicado('${m.id}')">‚ö†Ô∏è Duplicado</button>` : ''}
        </td>
      </tr>
    `;
  }).join('');

  document.getElementById('buscarRxResumen').textContent = `Prescripciones: ${filtradas.length}`;
}

function marcarComoDuplicado(medidaId) {
  if (!confirm('¬øMarcar esta prescripci√≥n como duplicada? Se agregar√° al historial cl√≠nico con la excepci√≥n "Duplicado".')) return;

  const medidas = load(DB.MEDIDAS);
  const medida = medidas.find(m => m.id === medidaId);

  if (medida) {
    // Marcar como duplicado
    medida.excepcion = 'Duplicado';
    medida.observacion = (medida.observacion || '') + ' [Marcado como Duplicado]';
    save(DB.MEDIDAS, medidas);

    // Refrescar la b√∫squeda
    buscarPrescripciones();
    toast('Prescripci√≥n marcada como duplicada', 'success');
  } else {
    toast('No se encontr√≥ la prescripci√≥n', 'error');
  }
}
window.marcarComoDuplicado = marcarComoDuplicado;

function exportarRxExcel() {
  const medidas = load(DB.MEDIDAS);
  const clientes = load(DB.CLIENTES);

  if (medidas.length === 0) { toast('No hay prescripciones', 'warning'); return; }

  // Headers completos
  const headers = [
    'CODIGO', 'CLIENTE', 'DOCUMENTO', 'FECHA', 'TIPO_RX',
    // Visi√≥n de Lejos
    'LEJOS_OD_ESF', 'LEJOS_OD_CIL', 'LEJOS_OD_EJE', 'LEJOS_DIP',
    'LEJOS_OI_ESF', 'LEJOS_OI_CIL', 'LEJOS_OI_EJE',
    'LEJOS_OD_ADD', 'LEJOS_OI_ADD',
    // Visi√≥n de Cerca
    'CERCA_OD_ESF', 'CERCA_OD_CIL', 'CERCA_OD_EJE', 'CERCA_DIP',
    'CERCA_OI_ESF', 'CERCA_OI_CIL', 'CERCA_OI_EJE',
    // Visi√≥n Intermedia
    'INTER_OD_ESF', 'INTER_OD_CIL', 'INTER_OD_EJE', 'INTER_DIP',
    'INTER_OI_ESF', 'INTER_OI_CIL', 'INTER_OI_EJE',
    // Extras
    'ESPECIALISTA', 'OBSERVACION'
  ];

  const rows = medidas.map(m => {
    const cliente = clientes.find(c => c.id === m.clienteId);
    // ‚úÖ Nombre completo en exportaci√≥n
    const nombreCompleto = cliente
      ? (cliente.nombres + ' ' + (cliente.apellidos || '')).trim()
      : '-';
    return [
      m.codigo || m.id,
      '"' + nombreCompleto + '"',
      cliente?.documento || '',
      m.fecha || '',
      m.tipo || 'PROPIA',
      // Visi√≥n de Lejos
      m.lejosOdEsf || '', m.lejosOdCil || '', m.lejosOdEje || '', m.lejosDip || '',
      m.lejosOiEsf || '', m.lejosOiCil || '', m.lejosOiEje || '',
      m.lejosOdAdd || '', m.lejosOiAdd || '',
      // Visi√≥n de Cerca
      m.cercaOdEsf || '', m.cercaOdCil || '', m.cercaOdEje || '', m.cercaDip || '',
      m.cercaOiEsf || '', m.cercaOiCil || '', m.cercaOiEje || '',
      // Visi√≥n Intermedia
      m.interOdEsf || '', m.interOdCil || '', m.interOdEje || '', m.interDip || '',
      m.interOiEsf || '', m.interOiCil || '', m.interOiEje || '',
      // Extras
      '"' + (m.especialista || '') + '"',
      '"' + (m.rxObservacion || '').replace(/"/g, '""') + '"'
    ];
  });

  const csv = generarCSV(headers, rows);
  descargarCSV(csv, 'todas_prescripciones_' + today() + '.csv');
  toast('Todas las prescripciones exportadas');
}

function exportarClientesExcel() {
  const clientes = load(DB.CLIENTES);
  if (clientes.length === 0) { toast('No hay clientes', 'warning'); return; }

  const headers = ['Documento', 'Nombres', 'Telefono', 'Email', 'Ocupacion', 'Estado'];
  const rows = clientes.map(c => {
    // ‚úÖ Exportar nombre completo (nombres + apellidos)
    const nombreCompleto = (c.nombres + ' ' + (c.apellidos || '')).trim();
    return [
      c.documento || '',
      nombreCompleto,
      c.telefono || '',
      c.email || '',
      c.ocupacion || '',
      c.estado === 'H' ? 'HABILITADO' : 'DESHABILITADO'
    ];
  });

  const csv = generarCSV(headers, rows);
  descargarCSV(csv, 'clientes_optica.csv');
  toast('Clientes exportados');
}

/* ============================================
   UTILIDADES CSV - VERSI√ìN MEJORADA CON UTF-8 BOM
   ============================================ */

// Funci√≥n para escapar valores CSV correctamente
function escaparCSV(valor) {
  if (valor === null || valor === undefined) return '';

  // Convertir a string
  let str = String(valor);

  // Si contiene comas, comillas dobles o saltos de l√≠nea, envolver en comillas
  if (str.includes(',') || str.includes('"') || str.includes('\n') || str.includes('\r')) {
    // Duplicar comillas dobles internas
    str = str.replace(/"/g, '""');
    // Envolver en comillas
    str = '"' + str + '"';
  }

  return str;
}

// Funci√≥n mejorada para descargar CSV con UTF-8 BOM
function descargarCSV(contenido, nombreArchivo) {
  // Agregar BOM (Byte Order Mark) para UTF-8
  // Esto asegura que Excel y otros programas detecten correctamente la codificaci√≥n
  const BOM = '\uFEFF';
  const contenidoConBOM = BOM + contenido;

  // Crear blob con charset UTF-8
  const blob = new Blob([contenidoConBOM], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = nombreArchivo;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// Funci√≥n para generar CSV desde arrays (con validaci√≥n de longitud)
function generarCSV(headers, rows) {
  const numColumnas = headers.length;

  // Escapar headers
  const headerLine = headers.map(h => escaparCSV(h)).join(',');

  // Procesar filas
  const dataLines = rows.map(row => {
    // Asegurar que la fila tenga el n√∫mero correcto de columnas
    const filaNormalizada = [];
    for (let i = 0; i < numColumnas; i++) {
      filaNormalizada.push(row[i] !== undefined ? row[i] : '');
    }
    // Escapar valores y unir con comas
    return filaNormalizada.map(v => escaparCSV(v)).join(',');
  });

  // Unir todo con saltos de l√≠nea
  return [headerLine, ...dataLines].join('\n');
}

function imprimirDetalleVenta() {
  if (ventaActualDetalle) {
    generarTicketVenta(ventaActualDetalle);
  } else {
    const ids = getVentasSeleccionadas();
    if (ids.length === 1) {
      const v = load(DB.VENTAS).find(x => x.id === ids[0]);
      if (v) generarTicketVenta(v);
    }
  }
}

function generarTicketVenta(v) {
  const cliente = load(DB.CLIENTES).find(c => c.id === v.clienteId);
  const fechaEmision = new Date(v.fechaEmision + 'T00:00:00');
  const horaActual = new Date().toLocaleTimeString('es-PE', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true });

  // Determinar tipo de documento y configuraci√≥n espec√≠fica
  const tipoDoc = v.docTipo || 'BOLETA';

  // üî• DECISI√ìN: Si es NOTA DE VENTA, usar plantilla morada A4
  if (tipoDoc === 'NOTA') {
    generarNotaVentaMorada(v, cliente, fechaEmision, horaActual);
    return;
  }

  // Para BOLETA y FACTURA, continuar con plantilla t√©rmica
  let tituloDocumento = tipoDoc === 'FACTURA' ? 'FACTURA' : 'BOLETA DE VENTA';
  let mostrarIGV = (tipoDoc === 'FACTURA');

  // Color seg√∫n establecimiento (igual para todos los documentos)
  // NEGRO para Centro √ìptico Sicuani (DOS_DE_MAYO) - Fondo blanco profesional
  // Azul para √ìptica Sicuani (PLAZA_DE_ARMAS)
  const colorTitulo = establecimientoActual === 'DOS_DE_MAYO' ? '#000000' : '#0033cc';

  // Obtener datos del establecimiento actual
  const establecimientoDatos = establecimientoActual === 'DOS_DE_MAYO' ? {
    nombre: 'CENTRO √ìPTICO SICUANI',
    direccion: 'JR. DOS DE MAYO 217 - SICUANI',
    telefono: 'Cel. 984 047 273',
    ubicacion: 'PLAZA DE ARMAS - SICUANI - CANCHIS - CUSCO',
    ruc: '10247144132'
  } : {
    nombre: '√ìPTICA "SICUANI"',
    direccion: 'De: Huam√°n Quispe Gloria Isabel',
    telefono: 'Cel. 984 047 273',
    ubicacion: 'JR. GARCILAZO DE LA VEGA N¬∞ 135 - PLAZA DE ARMAS - SICUANI - CANCHIS - CUSCO',
    ruc: '10247144132'
  };

  // Construir items (sin medidas)
  let itemsHtml = '';
  v.items.forEach(item => {
    const importe = (item.cantidad * item.precio) - item.descuento;

    // Limpiar descripci√≥n: eliminar medidas como "OD: 0.25/-0.50 OI: 0/0"
    let descripcionLimpia = item.descripcion;

    // Eliminar patrones de medidas oftalmol√≥gicas
    // Patr√≥n: OD: n√∫meros/n√∫meros OI: n√∫meros/n√∫meros
    descripcionLimpia = descripcionLimpia.replace(/\s*OD:\s*[-+]?\d*\.?\d+\/[-+]?\d*\.?\d+\s*OI:\s*[-+]?\d*\.?\d+\/[-+]?\d*\.?\d+/gi, '');
    // Patr√≥n alternativo: OD: n√∫meros/-n√∫meros OI: n√∫meros/n√∫meros
    descripcionLimpia = descripcionLimpia.replace(/\s*OD:\s*[-+]?\d*\.?\d+\s*\/\s*[-+]?\d*\.?\d+\s*OI:\s*[-+]?\d*\.?\d+\s*\/\s*[-+]?\d*\.?\d+/gi, '');
    // Patr√≥n m√°s flexible
    descripcionLimpia = descripcionLimpia.replace(/\s*\(?\s*OD[:\s]*[-+]?\d*\.?\d*\s*\/?\s*[-+]?\d*\.?\d*\s*OI[:\s]*[-+]?\d*\.?\d*\s*\/?\s*[-+]?\d*\.?\d*\s*\)?/gi, '');

    // Limpiar espacios m√∫ltiples que puedan quedar
    descripcionLimpia = descripcionLimpia.replace(/\s+/g, ' ').trim();

    itemsHtml += `<div style="margin-bottom: 3px;">${item.cantidad.toFixed(0)} x ${descripcionLimpia} <span style="float: right;">S/. ${importe.toFixed(2)}</span></div>`;
  });

  // Obtener nombre completo del cliente
  const nombreCompleto = cliente
    ? (cliente.nombres + ' ' + (cliente.apellidos || '')).trim()
    : v.clienteNombre || 'CLIENTE GENERAL';

  // üî• SOLUCI√ìN DEFINITIVA: Usar window.open() para evitar TrustedScript
  const printWindow = window.open('', '', 'width=800,height=600');
  if (!printWindow) {
    alert('Por favor permite las ventanas emergentes para imprimir');
    return;
  }

  printWindow.document.write(`
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="UTF-8">
      <title>${tituloDocumento}</title>
      <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
        @media print {
          @page { size: 80mm auto; margin: 0; }
          body { margin: 0; padding: 0; }
        }
      </style>
    </head>
    <body>
    <div style="width: 80mm; margin: 0; padding: 8px; font-family: 'Courier New', monospace; font-size: 11px; line-height: 1.4;">

      <!-- ENCABEZADO -->
      <div style="text-align: center; margin-bottom: 8px;">
        <div style="font-weight: bold; font-size: 13px;">${establecimientoDatos.nombre}</div>
        <div style="font-size: 10px;">${establecimientoDatos.direccion}</div>
        <div style="font-size: 10px;">RUC: ${establecimientoDatos.ruc}</div>
        <div style="font-size: 10px;">${establecimientoDatos.telefono}</div>
      </div>

      <!-- SEPARADOR -->
      <div style="border-top: 1px dashed #000; margin: 6px 0;"></div>

      <!-- CLIENTE -->
      <div style="margin-bottom: 6px;">
        <div style="font-weight: bold;">CLIENTE: ${nombreCompleto}</div>
        <div>RUC: ${cliente?.documento || '-'}</div>
      </div>

      <!-- SEPARADOR -->
      <div style="border-top: 1px dashed #000; margin: 6px 0;"></div>

      <!-- TIPO DOCUMENTO Y SERIE -->
      <div style="text-align: center; margin-bottom: 6px;">
        <div style="font-weight: bold; font-size: 12px;">${tituloDocumento}</div>
        <div style="font-weight: bold;">${v.docSerie}-${v.docNumero}</div>
      </div>

      <!-- FECHA -->
      <div style="margin-bottom: 6px;">
        <div>FECHA DE EMISI√ìN: ${fechaEmision.getDate()}/${fechaEmision.getMonth() + 1}/${fechaEmision.getFullYear()}</div>
        <div>FORMA DE PAGO: CONTADO</div>
      </div>

      <!-- SEPARADOR -->
      <div style="border-top: 1px dashed #000; margin: 6px 0;"></div>

      <!-- PRODUCTOS -->
      <div style="margin-bottom: 6px;">
        <div style="font-weight: bold; border-bottom: 1px dashed #000; padding-bottom: 3px; margin-bottom: 4px;">
          DETALLE DE COMPRA:
        </div>
        ${itemsHtml}
      </div>

      <!-- SEPARADOR -->
      <div style="border-top: 1px dashed #000; margin: 6px 0;"></div>

      <!-- TOTALES -->
      <div style="margin-bottom: 6px;">
        <div style="display: flex; justify-content: space-between; font-weight: bold;">
          <span>OPERACI√ìN GRAVADA S/.</span>
          <span>${(v.totalPagar / 1.18).toFixed(2)}</span>
        </div>
        <div style="display: flex; justify-content: space-between;">
          <span>IGV S/.</span>
          <span>${(v.totalPagar - (v.totalPagar / 1.18)).toFixed(2)}</span>
        </div>
        <div style="display: flex; justify-content: space-between; font-weight: bold; font-size: 13px; margin-top: 4px;">
          <span>IMPORTE TOTAL S/.</span>
          <span>${v.totalPagar.toFixed(2)}</span>
        </div>
      </div>

      <!-- SEPARADOR -->
      <div style="border-top: 1px dashed #000; margin: 6px 0;"></div>

      <!-- SALDOS -->
      <div style="margin-bottom: 6px;">
        <div style="display: flex; justify-content: space-between; font-weight: bold;">
          <span>SALDO A CUENTA S/.</span>
          <span>${(v.saldoACuenta || v.totalPagar).toFixed(2)}</span>
        </div>
        <div style="display: flex; justify-content: space-between; font-weight: bold;">
          <span>SALDO TOTAL S/.</span>
          <span>${(v.saldoTotal || 0).toFixed(2)}</span>
        </div>
      </div>

      <!-- SEPARADOR -->
      <div style="border-top: 1px dashed #000; margin: 6px 0;"></div>

      <!-- VENDEDOR -->
      <div style="margin-bottom: 6px; font-size: 10px;">
        <div>VENDEDOR(A): ${v.vendedor || 'ADMINISTRADOR'}</div>
      </div>

      <!-- SEPARADOR -->
      <div style="border-top: 1px dashed #000; margin: 6px 0;"></div>

      <!-- PIE -->
      <div style="text-align: center; font-size: 11px; font-weight: bold; margin-top: 8px;">
        Gracias por su compra
      </div>
    </div>
    </body>
    </html>
  `);

  printWindow.document.close();
  printWindow.focus();

  setTimeout(() => {
    printWindow.print();
    printWindow.close();
  }, 250);
}

// üé® PLANTILLA MORADA PARA NOTA DE VENTA (A4 / Media Hoja)
function generarNotaVentaMorada(v, cliente, fechaEmision, horaActual) {
  // Obtener datos del establecimiento
  const establecimientoDatos = establecimientoActual === 'DOS_DE_MAYO' ? {
    nombre: 'CENTRO √ìPTICO SICUANI',
    direccion: 'JR. DOS DE MAYO N¬∞217 - SICUANI',
    ubicacion: 'PLAZA DE ARMAS - SICUANI - CANCHIS - CUSCO',
    telefono: 'Cel. 984 047 273',
    ruc: '10247144132'
  } : {
    nombre: '√ìPTICA "SICUANI"',
    direccion: 'JR. GARCILAZO DE LA VEGA N¬∞ 135',
    ubicacion: 'PLAZA DE ARMAS - SICUANI - CANCHIS - CUSCO',
    telefono: 'Cel. 984 047 273',
    ruc: '10247144132'
  };

  // Construir items
  let itemsHtml = '';
  v.items.forEach(item => {
    const importe = (item.cantidad * item.precio) - item.descuento;

    // Limpiar descripci√≥n
    let descripcionLimpia = item.descripcion;
    descripcionLimpia = descripcionLimpia.replace(/\s*OD:\s*[-+]?\d*\.?\d+\/[-+]?\d*\.?\d+\s*OI:\s*[-+]?\d*\.?\d+\/[-+]?\d*\.?\d+/gi, '');
    descripcionLimpia = descripcionLimpia.replace(/\s*\(?\s*OD[:\s]*[-+]?\d*\.?\d*\s*\/?\s*[-+]?\d*\.?\d*\s*OI[:\s]*[-+]?\d*\.?\d*\s*\/?\s*[-+]?\d*\.?\d*\s*\)?/gi, '');
    descripcionLimpia = descripcionLimpia.replace(/\s+/g, ' ').trim();

    itemsHtml += `
      <tr>
        <td style="padding: 12px 8px; border-bottom: 1px solid #ddd; text-align: center; font-size: 13px;">${item.cantidad.toFixed(2)}</td>
        <td style="padding: 12px 12px; border-bottom: 1px solid #ddd; font-size: 13px;">${descripcionLimpia}</td>
        <td style="padding: 12px 8px; border-bottom: 1px solid #ddd; text-align: right; font-size: 13px;">${item.precio.toFixed(2)}</td>
        <td style="padding: 12px 12px; border-bottom: 1px solid #ddd; text-align: right; font-weight: 700; font-size: 13px;">${importe.toFixed(2)}</td>
      </tr>
    `;
  });

  // Nombre del cliente
  const nombreCompleto = cliente
    ? (cliente.nombres + ' ' + (cliente.apellidos || '')).trim()
    : v.clienteNombre || 'CLIENTE GENERAL';

  // üî• SOLUCI√ìN DEFINITIVA: Usar window.open() para evitar TrustedScript
  const printWindow = window.open('', '', 'width=900,height=700');
  if (!printWindow) {
    alert('Por favor permite las ventanas emergentes para imprimir');
    return;
  }

  printWindow.document.write(`
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="UTF-8">
      <title>NOTA DE VENTA</title>
      <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
        @media print {
          @page { size: A4; margin: 10mm; }
          body { margin: 0; padding: 0; }
        }
      </style>
    </head>
    <body>
    <div class="nota-venta-morada" style="max-width: 210mm; margin: 0 auto; padding: 20px; font-family: Arial, sans-serif; background: white;">

      <!-- ENCABEZADO -->
      <div style="text-align: center; margin-bottom: 15px;">
        <div style="font-size: 20px; font-weight: 900; color: #000; letter-spacing: 1px; margin-bottom: 8px;">${establecimientoDatos.nombre}</div>
        <div style="font-size: 11px; color: #333; line-height: 1.5;">${establecimientoDatos.direccion}</div>
        <div style="font-size: 11px; color: #333; line-height: 1.5;">Venta de Lunas Policarbonato RX Blue Protect, Transitions Gen 5, Multifocales Digitales,</div>
        <div style="font-size: 11px; color: #333; line-height: 1.5;">Lentes de Contacto, Monturas Acetato, Fibra Naylon, Metal Flex, Lentes de Sol</div>
        <div style="font-size: 12px; font-weight: bold; color: #000; margin-top: 5px;">${establecimientoDatos.ubicacion}</div>
        <div style="font-size: 12px; font-weight: bold; color: #000; margin-top: 3px;">${establecimientoDatos.telefono}</div>
      </div>

      <!-- BANDA MORADA CON T√çTULO -->
      <div style="background: linear-gradient(135deg, #7c3aed 0%, #6b21a8 100%); padding: 14px; text-align: center; margin-bottom: 15px; border-radius: 8px; box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);">
        <div style="font-size: 22px; font-weight: 900; color: white; letter-spacing: 1.5px;">NOTA DE VENTA</div>
        <div style="font-size: 16px; font-weight: 700; color: white; margin-top: 5px;">${v.docSerie} - N¬∞ ${v.docNumero}</div>
      </div>

      <!-- TABLA DE DATOS DEL CLIENTE -->
      <table style="width: 100%; border-collapse: collapse; margin-bottom: 15px; border: 2px solid #7c3aed;">
        <tr>
          <td style="padding: 10px; border: 1px solid #ddd; background: #f3f4f6; font-weight: 700; width: 120px;">Se√±or(a):</td>
          <td style="padding: 10px; border: 1px solid #ddd;" colspan="3">${nombreCompleto}</td>
        </tr>
        <tr>
          <td style="padding: 10px; border: 1px solid #ddd; background: #f3f4f6; font-weight: 700;">Direcci√≥n:</td>
          <td style="padding: 10px; border: 1px solid #ddd;">${cliente?.direccion || ''}</td>
          <td style="padding: 10px; border: 1px solid #ddd; background: #f3f4f6; font-weight: 700; width: 80px;">D.N.I.:</td>
          <td style="padding: 10px; border: 1px solid #ddd; width: 140px;">${cliente?.documento || ''}</td>
        </tr>
        <tr>
          <td style="padding: 10px; border: 1px solid #ddd; background: #f3f4f6; font-weight: 700;">FECHA DE EMISI√ìN</td>
          <td style="padding: 10px; border: 1px solid #ddd;">
            <div style="display: inline-flex; gap: 15px;">
              <span><strong>D√çA:</strong> ${fechaEmision.getDate()}</span>
              <span><strong>MES:</strong> ${fechaEmision.getMonth() + 1}</span>
              <span><strong>A√ëO:</strong> ${fechaEmision.getFullYear()}</span>
            </div>
          </td>
          <td style="padding: 10px; border: 1px solid #ddd; background: #f3f4f6; font-weight: 700;">RUC:</td>
          <td style="padding: 10px; border: 1px solid #ddd;">${establecimientoDatos.ruc}</td>
        </tr>
        <tr>
          <td colspan="4" style="padding: 8px; border: 1px solid #ddd; text-align: right; background: #7c3aed; color: white; font-weight: 700;">N¬∞ ${v.docNumero}</td>
        </tr>
      </table>

      <!-- TABLA DE PRODUCTOS -->
      <table style="width: 100%; border-collapse: collapse; margin-bottom: 15px; border: 2px solid #7c3aed;">
        <thead>
          <tr style="background: linear-gradient(135deg, #7c3aed 0%, #6b21a8 100%); color: white;">
            <th style="padding: 12px 8px; border: 1px solid #6b21a8; text-align: center; width: 70px;">CANT.</th>
            <th style="padding: 12px 12px; border: 1px solid #6b21a8; text-align: left;">DESCRIPCI√ìN</th>
            <th style="padding: 12px 8px; border: 1px solid #6b21a8; text-align: right; width: 100px;">P. UNIT.</th>
            <th style="padding: 12px 12px; border: 1px solid #6b21a8; text-align: right; width: 110px;">TOTAL</th>
          </tr>
        </thead>
        <tbody>
          ${itemsHtml}
        </tbody>
      </table>

      <!-- TOTAL S/ CON SALDOS -->
      <div style="margin-bottom: 20px;">
        <table style="width: 100%; border-collapse: collapse; border: 3px solid #7c3aed;">
          <tr>
            <td style="padding: 15px; background: linear-gradient(135deg, #7c3aed 0%, #6b21a8 100%); color: white; font-size: 18px; font-weight: 900; text-align: center; letter-spacing: 1px;">TOTAL S/</td>
            <td style="padding: 15px; background: linear-gradient(135deg, #7c3aed 0%, #6b21a8 100%); color: white; font-size: 22px; font-weight: 900; text-align: right; width: 180px;">${v.totalPagar.toFixed(2)}</td>
          </tr>
          <tr>
            <td style="padding: 12px; background: #f9fafb; border-top: 2px solid #7c3aed; font-weight: 700; text-align: right; font-size: 14px;">SALDO A CUENTA S/</td>
            <td style="padding: 12px; background: #f9fafb; border-top: 2px solid #7c3aed; font-weight: 900; text-align: right; font-size: 16px; color: #059669;">${(v.saldoACuenta || v.totalPagar).toFixed(2)}</td>
          </tr>
          <tr>
            <td style="padding: 12px; background: #f9fafb; border-top: 2px solid #7c3aed; font-weight: 700; text-align: right; font-size: 14px;">SALDO TOTAL S/</td>
            <td style="padding: 12px; background: #f9fafb; border-top: 2px solid #7c3aed; font-weight: 900; text-align: right; font-size: 16px; color: ${(v.saldoTotal || 0) > 0 ? '#dc2626' : '#059669'};">${(v.saldoTotal || 0).toFixed(2)}</td>
          </tr>
        </table>
      </div>

      <!-- PIE DE P√ÅGINA -->
      <div style="margin-top: 20px; padding: 12px; background: #f9fafb; border: 1px solid #ddd; border-radius: 6px;">
        <div style="font-size: 11px; text-align: center; color: #666; margin-bottom: 5px;">
          Items: ${v.items.length} | Total Productos: ${v.items.reduce((a, i) => a + i.cantidad, 0)}
        </div>
        <div style="font-size: 11px; text-align: center; color: #666; margin-bottom: 5px;">
          IMPRESO POR: ${v.vendedor || 'ADMINISTRADOR'}
        </div>
        <div style="font-size: 16px; text-align: center; font-weight: 900; color: #7c3aed; margin-top: 10px;">
          GRACIAS POR SU COMPRA
        </div>
        <div style="font-size: 10px; text-align: center; color: #999; margin-top: 5px;">
          FECHA: ${fechaEmision.toLocaleDateString('es-PE')} | HORA: ${horaActual}
        </div>
      </div>
    </div>
    </body>
    </html>
  `);

  printWindow.document.close();
  printWindow.focus();

  setTimeout(() => {
    printWindow.print();
    printWindow.close();
  }, 250);
}

function numeroALetras(num) {
  const unidades = ['', 'UN', 'DOS', 'TRES', 'CUATRO', 'CINCO', 'SEIS', 'SIETE', 'OCHO', 'NUEVE'];
  const decenas = ['', 'DIEZ', 'VEINTE', 'TREINTA', 'CUARENTA', 'CINCUENTA', 'SESENTA', 'SETENTA', 'OCHENTA', 'NOVENTA'];
  const centenas = ['', 'CIENTO', 'DOSCIENTOS', 'TRESCIENTOS', 'CUATROCIENTOS', 'QUINIENTOS', 'SEISCIENTOS', 'SETECIENTOS', 'OCHOCIENTOS', 'NOVECIENTOS'];

  const entero = Math.floor(num);
  const decimales = Math.round((num - entero) * 100);

  if (entero === 0) return `CERO Y ${decimales}/100 NUEVOS SOLES`;
  if (entero === 100) return `CIEN Y ${decimales}/100 NUEVOS SOLES`;

  let resultado = '';

  if (entero >= 1000) {
    const miles = Math.floor(entero / 1000);
    const resto = entero % 1000;
    if (miles === 1) resultado = 'MIL ';
    else if (miles < 10) resultado = unidades[miles] + ' MIL ';
    else resultado = miles + ' MIL ';

    if (resto > 0) {
      if (resto < 10) resultado += unidades[resto];
      else if (resto < 100) {
        const d = Math.floor(resto / 10);
        const u = resto % 10;
        if (u === 0) resultado += decenas[d];
        else if (d === 2) resultado += 'VEINTI' + unidades[u];
        else resultado += decenas[d] + ' Y ' + unidades[u];
      } else {
        const c = Math.floor(resto / 100);
        const restoCentena = resto % 100;
        resultado += centenas[c];
        if (restoCentena > 0) {
          if (restoCentena < 10) resultado += ' ' + unidades[restoCentena];
          else {
            const d = Math.floor(restoCentena / 10);
            const u = restoCentena % 10;
            if (u === 0) resultado += ' ' + decenas[d];
            else resultado += ' ' + decenas[d] + ' Y ' + unidades[u];
          }
        }
      }
    }
  } else if (entero >= 100) {
    const c = Math.floor(entero / 100);
    const resto = entero % 100;
    resultado = centenas[c];
    if (resto > 0) {
      if (resto < 10) resultado += ' ' + unidades[resto];
      else {
        const d = Math.floor(resto / 10);
        const u = resto % 10;
        if (u === 0) resultado += ' ' + decenas[d];
        else resultado += ' ' + decenas[d] + ' Y ' + unidades[u];
      }
    }
  } else if (entero >= 10) {
    const d = Math.floor(entero / 10);
    const u = entero % 10;
    if (u === 0) resultado = decenas[d];
    else resultado = decenas[d] + ' Y ' + unidades[u];
  } else {
    resultado = unidades[entero];
  }

  return resultado.trim() + ` Y ${decimales.toString().padStart(2, '0')}/100 NUEVOS SOLES`;
}

/* ============================================
   INICIALIZACI√ìN
   ============================================ */
mostrarSeccion('ventas');
initVenta();
renderClientes();
/* ============================================
   INVENTARIO Y CAT√ÅLOGO
   ============================================ */

// Productos predefinidos con precios - Cat√°logo Completo de la √ìptica
const PRODUCTOS_CATALOGO = [
  // ===================== LUNAS =====================
  // Blue Defense y Protecci√≥n Luz Azul
  { id: 'LUN001', nombre: 'Blue Defense Premium', descripcion: 'Lentes con protecci√≥n luz azul premium', categoria: 'LUNAS', precio: 130, costo: 65, stock: 50, stockMin: 5, imagen: '' },
  { id: 'LUN002', nombre: 'Crizal Sapphire HR', descripcion: 'Antirreflejo Sapphire alta resistencia', categoria: 'LUNAS', precio: 190, costo: 95, stock: 30, stockMin: 5, imagen: '' },
  { id: 'LUN003', nombre: 'Crizal Easy Pro', descripcion: 'Antirreflejo f√°cil limpieza profesional', categoria: 'LUNAS', precio: 120, costo: 60, stock: 47, stockMin: 5, imagen: '' },
  // Transitions y Fotocrom√°ticos
  { id: 'LUN004', nombre: 'Transitions Signature', descripcion: 'Fotocrom√°tico Signature adaptable', categoria: 'LUNAS', precio: 280, costo: 140, stock: 25, stockMin: 5, imagen: '' },
  { id: 'LUN005', nombre: 'Transitions XTRActive', descripcion: 'Fotocrom√°tico extra oscuro exterior', categoria: 'LUNAS', precio: 320, costo: 160, stock: 15, stockMin: 5, imagen: '' },
  { id: 'LUN006', nombre: 'Fotocrom√°tico', descripcion: 'Luna fotocrom√°tica est√°ndar', categoria: 'LUNAS', precio: 150, costo: 75, stock: 100, stockMin: 10, imagen: '' },
  // Policarbonato
  { id: 'LUN007', nombre: 'Policarbonato', descripcion: 'Luna policarbonato resistente impacto', categoria: 'LUNAS', precio: 80, costo: 40, stock: 100, stockMin: 10, imagen: '' },
  // Trivex
  { id: 'LUN008', nombre: 'Trivex', descripcion: 'Luna Trivex ultraliviana', categoria: 'LUNAS', precio: 95, costo: 48, stock: 60, stockMin: 5, imagen: '' },
  // Blue Zero
  { id: 'LUN009', nombre: 'Blue Zero', descripcion: 'Protecci√≥n luz azul b√°sica econ√≥mica', categoria: 'LUNAS', precio: 85, costo: 43, stock: 80, stockMin: 10, imagen: '' },
  // Alto √çndice
  { id: 'LUN010', nombre: 'Alto √çndice 1.67', descripcion: 'Luna delgada alto √≠ndice 1.67', categoria: 'LUNAS', precio: 180, costo: 90, stock: 25, stockMin: 5, imagen: '' },
  { id: 'LUN011', nombre: 'Alto √çndice 1.74', descripcion: 'Luna ultra delgada alto √≠ndice 1.74', categoria: 'LUNAS', precio: 250, costo: 125, stock: 15, stockMin: 5, imagen: '' },
  // Fotocrom√°ticos Colores
  { id: 'LUN012', nombre: 'Fotocrom√°tico Gris', descripcion: 'Luna fotocrom√°tica color gris', categoria: 'LUNAS', precio: 150, costo: 75, stock: 30, stockMin: 5, imagen: '' },
  { id: 'LUN013', nombre: 'Fotocrom√°tico Caf√©', descripcion: 'Luna fotocrom√°tica color caf√©', categoria: 'LUNAS', precio: 150, costo: 75, stock: 30, stockMin: 5, imagen: '' },
  // Progresivos
  { id: 'LUN014', nombre: 'Progresivo Varilux', descripcion: 'Multifocal Varilux premium', categoria: 'LUNAS', precio: 450, costo: 225, stock: 10, stockMin: 3, imagen: '' },
  { id: 'LUN015', nombre: 'Progresivo Econ√≥mico', descripcion: 'Multifocal econ√≥mico est√°ndar', categoria: 'LUNAS', precio: 200, costo: 100, stock: 20, stockMin: 5, imagen: '' },
  { id: 'LUN016', nombre: 'Progresivo Kodak', descripcion: 'Multifocal Kodak alta definici√≥n', categoria: 'LUNAS', precio: 380, costo: 190, stock: 12, stockMin: 3, imagen: '' },
  { id: 'LUN017', nombre: 'Progresivo Essilor', descripcion: 'Multifocal Essilor calidad premium', categoria: 'LUNAS', precio: 420, costo: 210, stock: 8, stockMin: 3, imagen: '' },
  // Bifocales
  { id: 'LUN018', nombre: 'Bifocal FT-28', descripcion: 'Bifocal flat top 28mm', categoria: 'LUNAS', precio: 120, costo: 60, stock: 30, stockMin: 5, imagen: '' },
  { id: 'LUN019', nombre: 'Bifocal Invisible', descripcion: 'Bifocal sin l√≠nea visible', categoria: 'LUNAS', precio: 180, costo: 90, stock: 20, stockMin: 5, imagen: '' },
  // Antireflex
  { id: 'LUN020', nombre: 'Antireflex HD', descripcion: 'Tratamiento antirreflejo HD', categoria: 'LUNAS', precio: 45, costo: 23, stock: 150, stockMin: 20, imagen: '' },
  { id: 'LUN021', nombre: 'Antireflex Premium', descripcion: 'Tratamiento antirreflejo premium', categoria: 'LUNAS', precio: 65, costo: 33, stock: 100, stockMin: 15, imagen: '' },
  // Montura Met√°lica Classic
  { id: 'LUN022', nombre: 'Montura Met√°lica Classic', descripcion: 'Montura met√°lica cl√°sica elegante', categoria: 'LUNAS', precio: 120, costo: 60, stock: 100, stockMin: 10, imagen: '' },
  // Montura Acetato Premium
  { id: 'LUN023', nombre: 'Montura Acetato Premium', descripcion: 'Montura acetato alta calidad', categoria: 'LUNAS', precio: 180, costo: 90, stock: 100, stockMin: 10, imagen: '' },

  // ===================== MONTURAS =====================
  { id: 'MON001', nombre: 'Montura Met√°lica Cl√°sica', descripcion: 'Montura met√°lica dise√±o cl√°sico', categoria: 'MONTURAS', precio: 120, costo: 60, stock: 47, stockMin: 5, imagen: '' },
  { id: 'MON002', nombre: 'Montura Acetato Fashion', descripcion: 'Montura acetato moda actual', categoria: 'MONTURAS', precio: 150, costo: 75, stock: 35, stockMin: 5, imagen: '' },
  { id: 'MON003', nombre: 'Montura Titanio', descripcion: 'Montura titanio ultraliviana', categoria: 'MONTURAS', precio: 280, costo: 140, stock: 10, stockMin: 3, imagen: '' },
  { id: 'MON004', nombre: 'Montura Infantil', descripcion: 'Montura ni√±os flexible resistente', categoria: 'MONTURAS', precio: 85, costo: 43, stock: 30, stockMin: 5, imagen: '' },
  { id: 'MON005', nombre: 'Montura Sport', descripcion: 'Montura deportiva resistente', categoria: 'MONTURAS', precio: 150, costo: 75, stock: 15, stockMin: 5, imagen: '' },
  { id: 'MON006', nombre: 'Montura Semi Al Aire', descripcion: 'Montura semi al aire elegante', categoria: 'MONTURAS', precio: 95, costo: 48, stock: 40, stockMin: 5, imagen: '' },
  { id: 'MON007', nombre: 'Montura Aviador', descripcion: 'Montura estilo aviador cl√°sico', categoria: 'MONTURAS', precio: 110, costo: 55, stock: 25, stockMin: 5, imagen: '' },
  { id: 'MON008', nombre: 'Montura Cat Eye', descripcion: 'Montura ojo de gato femenina', categoria: 'MONTURAS', precio: 130, costo: 65, stock: 20, stockMin: 5, imagen: '' },
  { id: 'MON009', nombre: 'Montura Redonda Vintage', descripcion: 'Montura redonda estilo vintage', categoria: 'MONTURAS', precio: 100, costo: 50, stock: 30, stockMin: 5, imagen: '' },
  { id: 'MON010', nombre: 'Montura Cuadrada Ejecutiva', descripcion: 'Montura cuadrada estilo ejecutivo', categoria: 'MONTURAS', precio: 140, costo: 70, stock: 25, stockMin: 5, imagen: '' },
  { id: 'MON011', nombre: 'Montura Flexible Memory', descripcion: 'Montura memory flex resistente', categoria: 'MONTURAS', precio: 165, costo: 83, stock: 20, stockMin: 5, imagen: '' },
  { id: 'MON012', nombre: 'Montura Oversize', descripcion: 'Montura grande oversize fashion', categoria: 'MONTURAS', precio: 125, costo: 63, stock: 18, stockMin: 5, imagen: '' },
  { id: 'MON013', nombre: 'Montura Acetato Grueso', descripcion: 'Montura acetato grueso moderno', categoria: 'MONTURAS', precio: 145, costo: 73, stock: 22, stockMin: 5, imagen: '' },
  { id: 'MON014', nombre: 'Montura Sin Aro', descripcion: 'Montura sin aro minimalista', categoria: 'MONTURAS', precio: 200, costo: 100, stock: 12, stockMin: 3, imagen: '' },
  { id: 'MON015', nombre: 'Montura Carey', descripcion: 'Montura efecto carey cl√°sico', categoria: 'MONTURAS', precio: 135, costo: 68, stock: 28, stockMin: 5, imagen: '' },

  // ===================== LENTES DE CONTACTO =====================
  { id: 'LC001', nombre: 'LC Mensual Esf√©rico', descripcion: 'Lente contacto mensual esf√©rico', categoria: 'LCONTACTO', precio: 45, costo: 23, stock: 50, stockMin: 10, imagen: '' },
  { id: 'LC002', nombre: 'LC Diario Pack 30', descripcion: 'Lentes diarios caja 30 unidades', categoria: 'LCONTACTO', precio: 120, costo: 60, stock: 20, stockMin: 5, imagen: '' },
  { id: 'LC003', nombre: 'LC Color Mensual', descripcion: 'Lente contacto color mensual', categoria: 'LCONTACTO', precio: 65, costo: 33, stock: 30, stockMin: 5, imagen: '' },
  { id: 'LC004', nombre: 'LC T√≥rico Mensual', descripcion: 'Lente contacto t√≥rico astigmatismo', categoria: 'LCONTACTO', precio: 85, costo: 43, stock: 25, stockMin: 5, imagen: '' },
  { id: 'LC005', nombre: 'LC Multifocal', descripcion: 'Lente contacto multifocal presbicia', categoria: 'LCONTACTO', precio: 95, costo: 48, stock: 15, stockMin: 5, imagen: '' },
  { id: 'LC006', nombre: 'LC Quincenal', descripcion: 'Lente contacto quincenal', categoria: 'LCONTACTO', precio: 55, costo: 28, stock: 35, stockMin: 8, imagen: '' },
  { id: 'LC007', nombre: 'Soluci√≥n Multiprop√≥sito 360ml', descripcion: 'Soluci√≥n limpieza LC 360ml', categoria: 'LCONTACTO', precio: 35, costo: 18, stock: 60, stockMin: 15, imagen: '' },
  { id: 'LC008', nombre: 'Estuche Lentes Contacto', descripcion: 'Estuche porta lentes contacto', categoria: 'LCONTACTO', precio: 8, costo: 4, stock: 80, stockMin: 20, imagen: '' },

  // ===================== ACCESORIOS =====================
  { id: 'ACC001', nombre: 'Estuche R√≠gido', descripcion: 'Estuche protector r√≠gido premium', categoria: 'ACCESORIOS', precio: 15, costo: 8, stock: 100, stockMin: 20, imagen: '' },
  { id: 'ACC002', nombre: 'Estuche Blando', descripcion: 'Estuche blando flexible', categoria: 'ACCESORIOS', precio: 10, costo: 5, stock: 120, stockMin: 25, imagen: '' },
  { id: 'ACC003', nombre: 'Pa√±o Microfibra', descripcion: 'Pa√±o limpiador microfibra suave', categoria: 'ACCESORIOS', precio: 8, costo: 4, stock: 200, stockMin: 50, imagen: '' },
  { id: 'ACC004', nombre: 'Spray Limpiador 60ml', descripcion: 'Spray limpiador lentes 60ml', categoria: 'ACCESORIOS', precio: 12, costo: 6, stock: 80, stockMin: 20, imagen: '' },
  { id: 'ACC005', nombre: 'Cord√≥n para Lentes', descripcion: 'Cord√≥n sujetador lentes cl√°sico', categoria: 'ACCESORIOS', precio: 10, costo: 5, stock: 60, stockMin: 15, imagen: '' },
  { id: 'ACC006', nombre: 'Cadena Met√°lica', descripcion: 'Cadena met√°lica porta lentes', categoria: 'ACCESORIOS', precio: 25, costo: 13, stock: 40, stockMin: 10, imagen: '' },
  { id: 'ACC007', nombre: 'Toallitas H√∫medas x50', descripcion: 'Toallitas h√∫medas limpieza x50', categoria: 'ACCESORIOS', precio: 18, costo: 9, stock: 50, stockMin: 12, imagen: '' },
  { id: 'ACC008', nombre: 'Kit Limpieza Completo', descripcion: 'Kit spray + pa√±o + estuche', categoria: 'ACCESORIOS', precio: 30, costo: 15, stock: 35, stockMin: 8, imagen: '' },
  { id: 'ACC009', nombre: 'Soporte Exhibidor', descripcion: 'Soporte exhibidor lentes mesa', categoria: 'ACCESORIOS', precio: 20, costo: 10, stock: 25, stockMin: 5, imagen: '' },
  { id: 'ACC010', nombre: 'Protector Solar Lentes', descripcion: 'Clip protector solar para lentes', categoria: 'ACCESORIOS', precio: 35, costo: 18, stock: 30, stockMin: 8, imagen: '' },
  { id: 'ACC011', nombre: 'Parches Nasales Silicona', descripcion: 'Parches nasales silicona x2', categoria: 'ACCESORIOS', precio: 5, costo: 3, stock: 100, stockMin: 25, imagen: '' },
  { id: 'ACC012', nombre: 'Tornillos Repuesto', descripcion: 'Kit tornillos repuesto universal', categoria: 'ACCESORIOS', precio: 8, costo: 4, stock: 80, stockMin: 20, imagen: '' },
  { id: 'ACC013', nombre: 'Anteojos Nataci√≥n', descripcion: 'Anteojos nataci√≥n graduables', categoria: 'ACCESORIOS', precio: 45, costo: 23, stock: 15, stockMin: 5, imagen: '' },
  { id: 'ACC014', nombre: 'Funda de Viaje', descripcion: 'Funda de viaje porta 3 lentes', categoria: 'ACCESORIOS', precio: 28, costo: 14, stock: 20, stockMin: 5, imagen: '' },

  // ===================== SERVICIOS =====================
  { id: 'SRV001', nombre: 'Examen Visual Completo', descripcion: 'Examen de vista computarizado', categoria: 'SERVICIOS', precio: 30, costo: 0, stock: 999, stockMin: 0, imagen: '' },
  { id: 'SRV002', nombre: 'Ajuste de Montura', descripcion: 'Ajuste y calibraci√≥n montura', categoria: 'SERVICIOS', precio: 10, costo: 0, stock: 999, stockMin: 0, imagen: '' },
  { id: 'SRV003', nombre: 'Reparaci√≥n Soldadura', descripcion: 'Reparaci√≥n con soldadura l√°ser', categoria: 'SERVICIOS', precio: 25, costo: 0, stock: 999, stockMin: 0, imagen: '' },
  { id: 'SRV004', nombre: 'Cambio de Plaquetas', descripcion: 'Cambio plaquetas nasales', categoria: 'SERVICIOS', precio: 8, costo: 0, stock: 999, stockMin: 0, imagen: '' },
  { id: 'SRV005', nombre: 'Limpieza Ultras√≥nica', descripcion: 'Limpieza profunda ultras√≥nica', categoria: 'SERVICIOS', precio: 15, costo: 0, stock: 999, stockMin: 0, imagen: '' },
  { id: 'SRV006', nombre: 'Adaptaci√≥n LC', descripcion: 'Adaptaci√≥n lentes de contacto', categoria: 'SERVICIOS', precio: 40, costo: 0, stock: 999, stockMin: 0, imagen: '' },
  { id: 'SRV007', nombre: 'Control Post-Venta', descripcion: 'Control adaptaci√≥n post venta', categoria: 'SERVICIOS', precio: 0, costo: 0, stock: 999, stockMin: 0, imagen: '' },
  { id: 'SRV008', nombre: 'Montaje Express', descripcion: 'Montaje de lunas en 1 hora', categoria: 'SERVICIOS', precio: 20, costo: 0, stock: 999, stockMin: 0, imagen: '' },
  { id: 'SRV009', nombre: 'Tallado Especial', descripcion: 'Tallado lentes especiales', categoria: 'SERVICIOS', precio: 35, costo: 0, stock: 999, stockMin: 0, imagen: '' },
  { id: 'SRV010', nombre: 'Certificado √ìptico', descripcion: 'Certificado examen √≥ptico', categoria: 'SERVICIOS', precio: 15, costo: 0, stock: 999, stockMin: 0, imagen: '' }
];

// Inicializar productos en localStorage si no existen o actualizar cat√°logo
function initProductos() {
  const productos = load(DB.PRODUCTOS);
  // Si no hay productos O si el cat√°logo tiene m√°s productos, actualizar
  if (productos.length === 0 || productos.length < PRODUCTOS_CATALOGO.length) {
    // Combinar productos existentes con el nuevo cat√°logo
    const productosExistentes = {};
    productos.forEach(p => { productosExistentes[p.id] = p; });

    // Agregar nuevos productos del cat√°logo manteniendo stock de existentes
    const productosActualizados = PRODUCTOS_CATALOGO.map(catProd => {
      if (productosExistentes[catProd.id]) {
        // Mantener stock actual del producto existente
        return { ...catProd, stock: productosExistentes[catProd.id].stock };
      }
      return catProd;
    });

    save(DB.PRODUCTOS, productosActualizados);
  }
}

// Funci√≥n para recargar cat√°logo completo (usar si se necesita reset)
function recargarCatalogoCompleto() {
  if (confirm('¬øRecargar todo el cat√°logo? Esto restaurar√° todos los productos a sus valores originales.')) {
    save(DB.PRODUCTOS, PRODUCTOS_CATALOGO);
    renderInventario();
    toast('Cat√°logo recargado con ' + PRODUCTOS_CATALOGO.length + ' productos');
  }
}

// Renderizar inventario
let filtroCategoria = 'TODOS';

function renderInventario() {
  const productos = load(DB.PRODUCTOS);
  const filtrados = filtroCategoria === 'TODOS'
    ? productos
    : productos.filter(p => p.categoria === filtroCategoria);

  const catLabels = {
    'LUNAS': 'Lunas',
    'MONTURAS': 'Monturas',
    'LCONTACTO': 'L. Contacto',
    'ACCESORIOS': 'Accesorios',
    'SERVICIOS': 'Servicios'
  };

  const catIcons = {
    'LUNAS': 'üîµ',
    'MONTURAS': 'üëì',
    'LCONTACTO': 'üîò',
    'ACCESORIOS': 'üéÅ',
    'SERVICIOS': 'üîß'
  };

  document.getElementById('inventarioBody').innerHTML = filtrados.map(p => {
    const estado = p.stock <= 0 ? 'out' : (p.stock <= (p.stockMin || 5) ? 'low' : 'ok');
    const estadoLabel = p.stock <= 0 ? 'Agotado' : (p.stock <= (p.stockMin || 5) ? 'Stock Bajo' : 'En Stock');
    const catClass = p.categoria.toLowerCase();
    return `
      <tr>
        <td>
          <div class="inv-img ${catClass}">
            ${p.imagen ? '<img src="' + p.imagen + '">' : catIcons[p.categoria] || 'üì¶'}
          </div>
        </td>
        <td>
          <div class="inv-nombre">${p.nombre}</div>
          <div class="inv-desc">${p.descripcion || p.id}</div>
        </td>
        <td>
          <span class="inv-cat">
            <span class="inv-cat-dot ${catClass}"></span>
            ${catLabels[p.categoria] || p.categoria}
          </span>
        </td>
        <td class="text-right"><strong style="color: #16a34a; font-size: 15px;">S/ ${p.precio.toFixed(2)}</strong></td>
        <td class="text-center"><span class="inv-stock">${p.stock}</span></td>
        <td class="text-center"><span class="inv-estado ${estado}">${estadoLabel}</span></td>
        <td>
          <div class="inv-actions">
            <button class="btn-edit" onclick="editarProducto('${p.id}')" title="Editar">‚úèÔ∏è</button>
            <button class="btn-add" onclick="ajustarStock('${p.id}', 1)" title="Agregar stock">+</button>
            <button class="btn-sub" onclick="ajustarStock('${p.id}', -1)" title="Quitar stock">‚àí</button>
            <button class="btn-del" onclick="eliminarProducto('${p.id}')" title="Eliminar">üóëÔ∏è</button>
          </div>
        </td>
      </tr>
    `;
  }).join('');

  document.getElementById('inventarioCount').textContent = `Productos: ${filtrados.length}`;
}

// Filtros de categor√≠a inventario
document.querySelectorAll('.cat-btn').forEach(btn => {
  btn.onclick = () => {
    document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    filtroCategoria = btn.dataset.cat;
    renderInventario();
  };
});

// Modal Nuevo Producto
function abrirModalNuevoProducto(producto = null) {
  document.getElementById('productoModalTitulo').textContent = producto ? 'Editar Producto' : 'Nuevo Producto';
  document.getElementById('prodIdHidden').value = producto?.id || '';
  document.getElementById('prodCategoria').value = producto?.categoria || 'LUNAS';
  document.getElementById('prodNombre').value = producto?.nombre || '';
  document.getElementById('prodCodigo').value = producto?.id || 'AUTO';
  document.getElementById('prodPrecio').value = producto?.precio || 0;
  document.getElementById('prodCosto').value = producto?.costo || 0;
  document.getElementById('prodStock').value = producto?.stock || 0;
  document.getElementById('prodStockMin').value = producto?.stockMin || 5;
  document.getElementById('prodImagen').value = producto?.imagen || '';
  document.getElementById('prodDescripcion').value = producto?.descripcion || '';

  // Actualizar vista previa
  actualizarPreviewCategoria();
  actualizarPreviewImagen();

  document.getElementById('nuevoProductoModal').showModal();
}

// Actualizar vista previa de categor√≠a
function actualizarPreviewCategoria() {
  const cat = document.getElementById('prodCategoria').value;
  const preview = document.getElementById('prodImagenPreview');
  const imagen = document.getElementById('prodImagen').value.trim();

  if (imagen) return; // Si hay imagen, no cambiar

  const icons = {
    'LUNAS': 'üîµ',
    'MONTURAS': 'üëì',
    'LCONTACTO': 'üîò',
    'ACCESORIOS': 'üéÅ',
    'SERVICIOS': 'üîß'
  };

  const colors = {
    'LUNAS': 'linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%)',
    'MONTURAS': 'linear-gradient(135deg, #a78bfa 0%, #8b5cf6 100%)',
    'LCONTACTO': 'linear-gradient(135deg, #34d399 0%, #10b981 100%)',
    'ACCESORIOS': 'linear-gradient(135deg, #f472b6 0%, #ec4899 100%)',
    'SERVICIOS': 'linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%)'
  };

  preview.innerHTML = icons[cat] || 'üì¶';
  preview.style.background = colors[cat] || '#fafafa';
  preview.style.border = 'none';
  preview.style.color = 'white';
}

// Actualizar vista previa de imagen
function actualizarPreviewImagen() {
  const imagen = document.getElementById('prodImagen').value.trim();
  const preview = document.getElementById('prodImagenPreview');

  if (imagen) {
    preview.innerHTML = '<img src="' + imagen + '" style="width: 100%; height: 100%; object-fit: cover; border-radius: 10px;" onerror="this.parentElement.innerHTML=\'‚ùå\'; this.parentElement.style.background=\'#fee2e2\';">';
    preview.style.background = '#fff';
    preview.style.border = '2px solid #d4d4d8';
  } else {
    actualizarPreviewCategoria();
  }
}

function guardarProducto() {
  const nombre = document.getElementById('prodNombre').value.trim();
  if (!nombre) { toast('Nombre requerido', 'error'); return; }

  const id = document.getElementById('prodIdHidden').value || genId('PROD');
  const producto = {
    id,
    categoria: document.getElementById('prodCategoria').value,
    nombre,
    descripcion: document.getElementById('prodDescripcion').value.trim(),
    precio: parseFloat(document.getElementById('prodPrecio').value) || 0,
    costo: parseFloat(document.getElementById('prodCosto').value) || 0,
    stock: parseInt(document.getElementById('prodStock').value) || 0,
    stockMin: parseInt(document.getElementById('prodStockMin').value) || 5,
    imagen: document.getElementById('prodImagen').value.trim()
  };

  const productos = load(DB.PRODUCTOS);
  const idx = productos.findIndex(p => p.id === id);
  if (idx >= 0) productos[idx] = producto;
  else productos.push(producto);
  save(DB.PRODUCTOS, productos);

  cerrarModal('nuevoProductoModal');
  renderInventario();
  toast('Producto guardado');
}

function editarProducto(id) {
  const producto = load(DB.PRODUCTOS).find(p => p.id === id);
  if (producto) abrirModalNuevoProducto(producto);
}

function eliminarProducto(id) {
  if (!confirm('¬øEliminar este producto?')) return;
  let productos = load(DB.PRODUCTOS);
  productos = productos.filter(p => p.id !== id);
  save(DB.PRODUCTOS, productos);
  renderInventario();
  toast('Producto eliminado');
}

function ajustarStock(id, cantidad) {
  const productos = load(DB.PRODUCTOS);
  const producto = productos.find(p => p.id === id);
  if (producto) {
    producto.stock = Math.max(0, producto.stock + cantidad);
    save(DB.PRODUCTOS, productos);
    renderInventario();
  }
}

function exportarInventarioExcel() {
  const productos = load(DB.PRODUCTOS);
  if (productos.length === 0) { toast('No hay productos', 'warning'); return; }

  const catLabels = {
    'LUNAS': 'Lunas',
    'MONTURAS': 'Monturas',
    'LCONTACTO': 'L. Contacto',
    'ACCESORIOS': 'Accesorios',
    'SERVICIOS': 'Servicios'
  };

  // Calcular totales
  let valorTotalStock = 0;
  let valorTotalCosto = 0;

  const headers = ['C√ìDIGO', 'PRODUCTO', 'DESCRIPCI√ìN', 'CATEGOR√çA', 'PRECIO', 'COSTO', 'STOCK', 'STOCK MIN', 'ESTADO', 'VALOR STOCK'];
  const rows = productos.map(p => {
    const valorStock = p.precio * p.stock;
    valorTotalStock += valorStock;
    valorTotalCosto += p.costo * p.stock;
    const estado = p.stock <= 0 ? 'AGOTADO' : (p.stock <= (p.stockMin || 5) ? 'STOCK BAJO' : 'EN STOCK');
    return [
      p.id,
      p.nombre,
      p.descripcion || '',
      catLabels[p.categoria] || p.categoria,
      p.precio.toFixed(2),
      (p.costo || 0).toFixed(2),
      p.stock,
      p.stockMin || 5,
      estado,
      valorStock.toFixed(2)
    ];
  });

  // Agregar fila de totales
  rows.push(['', '', '', '', '', '', '', '', 'VALOR TOTAL', valorTotalStock.toFixed(2)]);

  const csv = generarCSV(headers, rows);
  descargarCSV(csv, `inventario_productos_${today()}.csv`);
  toast('Inventario exportado a Excel');
}

// CAT√ÅLOGO PARA VENTAS
// Variables movidas al inicio del script (l√≠nea 9689-9691)

function abrirCatalogo() {
  productoSeleccionado = null;
  document.getElementById('catCantidad').value = '1';
  document.getElementById('catDescuento').value = '0';
  filtroCatalogoModal = 'TODOS';
  document.querySelectorAll('.cat-btn-modal').forEach(b => b.classList.remove('active'));
  document.querySelector('.cat-btn-modal[data-catm="TODOS"]').classList.add('active');
  renderCatalogo();
  document.getElementById('catalogoModal').showModal();
}

function renderCatalogo() {
  const productos = load(DB.PRODUCTOS);
  const filtrados = filtroCatalogoModal === 'TODOS'
    ? productos.filter(p => p.stock > 0)
    : productos.filter(p => p.categoria === filtroCatalogoModal && p.stock > 0);

  document.getElementById('catalogoGrid').innerHTML = filtrados.map(p => `
    <div class="producto-card ${productoSeleccionado?.id === p.id ? 'selected' : ''}" onclick="seleccionarProducto('${p.id}')">
      <div class="prod-img">${p.imagen ? '<img src="' + p.imagen + '">' : 'üîµ'}</div>
      <div class="prod-nombre">${p.nombre}</div>
      <div class="prod-precio">S/ ${p.precio.toFixed(2)}</div>
      <div class="prod-stock">Stock: ${p.stock}</div>
    </div>
  `).join('');
}

// Filtros de categor√≠a en modal cat√°logo
document.querySelectorAll('.cat-btn-modal').forEach(btn => {
  btn.onclick = () => {
    document.querySelectorAll('.cat-btn-modal').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    filtroCatalogoModal = btn.dataset.catm;
    renderCatalogo();
  };
});

function seleccionarProducto(id) {
  productoSeleccionado = load(DB.PRODUCTOS).find(p => p.id === id);
  renderCatalogo();
}

function agregarProductoSeleccionado() {
  if (!productoSeleccionado) { toast('Selecciona un producto', 'warning'); return; }

  const cantidad = parseInt(document.getElementById('catCantidad').value) || 1;
  const descuento = parseFloat(document.getElementById('catDescuento').value) || 0;

  if (cantidad > productoSeleccionado.stock) {
    toast('Stock insuficiente', 'error');
    return;
  }

  itemsVenta.push({
    productoId: productoSeleccionado.id,
    descripcion: productoSeleccionado.nombre,
    cantidad,
    precio: productoSeleccionado.precio,
    descuento
  });

  // Descontar stock
  const productos = load(DB.PRODUCTOS);
  const prod = productos.find(p => p.id === productoSeleccionado.id);
  if (prod) {
    prod.stock -= cantidad;
    save(DB.PRODUCTOS, productos);
  }

  renderItemsVenta();
  cerrarModal('catalogoModal');
  toast(`${productoSeleccionado.nombre} agregado`);
}

// Agregar inventario a la navegaci√≥n
if (document.getElementById('inventario')) {
  // Ya est√° agregado en mostrarSeccion
}

// Modificar mostrarSeccion para incluir inventario y lunas
const originalMostrarSeccion = mostrarSeccion;
mostrarSeccion = function(seccion) {
  originalMostrarSeccion(seccion);
  if (seccion === 'inventario') renderInventario();
  if (seccion === 'lunas') {
    initTiposLunas();
    renderTiposLunas();
    renderCatalogoLunas(); // Inicializar cat√°logo con inventario
  }
};

// Inicializar productos al cargar
initProductos();

/* ============================================
   SISTEMA DE LUNAS
   ============================================ */

// Tipos de Lunas predefinidos
const TIPOS_LUNAS_DEFAULT = [
  // TIPO DE FOCO
  { id: 'TF001', categoria: 'TIPO_FOCO', descripcion: 'BIFOCAL INVISIBLE', abrev: 'BINV' },
  { id: 'TF002', categoria: 'TIPO_FOCO', descripcion: 'MULTIFOCAL', abrev: 'MULT' },
  { id: 'TF003', categoria: 'TIPO_FOCO', descripcion: 'BIFOCAL FLAPTOP AR', abrev: 'BIF FLAP A' },
  { id: 'TF004', categoria: 'TIPO_FOCO', descripcion: 'MULTIFOCAL TOP', abrev: 'MULT TOP' },
  { id: 'TF005', categoria: 'TIPO_FOCO', descripcion: 'MULTIFOCAL SHORT', abrev: 'MULT SH' },
  { id: 'TF006', categoria: 'TIPO_FOCO', descripcion: 'BIFOCAL SMART', abrev: 'BIF SM' },
  { id: 'TF007', categoria: 'TIPO_FOCO', descripcion: 'MONOFOCAL', abrev: 'MO' },
  // MATERIAL
  { id: 'MT001', categoria: 'MATERIAL', descripcion: 'RESINAS', abrev: 'RE' },
  { id: 'MT002', categoria: 'MATERIAL', descripcion: 'RESINA NK', abrev: 'RNK' },
  { id: 'MT003', categoria: 'MATERIAL', descripcion: 'POLICARBONATO', abrev: 'POL' },
  { id: 'MT004', categoria: 'MATERIAL', descripcion: 'FUTUREX', abrev: 'FX' },
  { id: 'MT005', categoria: 'MATERIAL', descripcion: 'CRISTAL', abrev: 'CRIS' },
  { id: 'MT006', categoria: 'MATERIAL', descripcion: 'MR8', abrev: 'MR8' },
  { id: 'MT007', categoria: 'MATERIAL', descripcion: 'BLINDEX', abrev: 'BX' },
  { id: 'MT008', categoria: 'MATERIAL', descripcion: 'CRIZAL', abrev: 'CR' },
  { id: 'MT009', categoria: 'MATERIAL', descripcion: 'RESINA X', abrev: 'RX' },
  // SERVICIO
  { id: 'SV001', categoria: 'SERVICIO', descripcion: 'ESFERICO', abrev: 'ESF' },
  { id: 'SV002', categoria: 'SERVICIO', descripcion: 'CILINDRO', abrev: 'CIL' },
  { id: 'SV003', categoria: 'SERVICIO', descripcion: 'COMBINADOS', abrev: 'COM' },
  // TRATAMIENTO
  { id: 'TR001', categoria: 'TRATAMIENTO', descripcion: 'ULTRAVIOLETA', abrev: 'UV' },
  { id: 'TR002', categoria: 'TRATAMIENTO', descripcion: 'DURAQUARZ', abrev: 'DQ' },
  { id: 'TR003', categoria: 'TRATAMIENTO', descripcion: 'ANTIREFLEX', abrev: 'AR' },
  { id: 'TR004', categoria: 'TRATAMIENTO', descripcion: 'ANTIREFLEX UV', abrev: 'AUV' },
  { id: 'TR005', categoria: 'TRATAMIENTO', descripcion: 'FILTRO LUZ AZUL UV', abrev: 'FLA' },
  { id: 'TR006', categoria: 'TRATAMIENTO', descripcion: 'BLUE DEFENSE', abrev: 'BP' },
  { id: 'TR007', categoria: 'TRATAMIENTO', descripcion: 'CIRCADIAN', abrev: 'CIR' },
  { id: 'TR008', categoria: 'TRATAMIENTO', descripcion: 'DIPPIN', abrev: 'D' },
  { id: 'TR009', categoria: 'TRATAMIENTO', descripcion: 'FREE EVOLUTION', abrev: 'FEV' },
  { id: 'TR010', categoria: 'TRATAMIENTO', descripcion: 'UV 400', abrev: 'UV 400' },
  { id: 'TR011', categoria: 'TRATAMIENTO', descripcion: 'AR PREMIUM', abrev: 'AP' },
  // INDICE
  { id: 'IN001', categoria: 'INDICE', descripcion: 'ALTO INDICE 1.60', abrev: 'AI160' },
  { id: 'IN002', categoria: 'INDICE', descripcion: 'ALTO INDICE 1.64', abrev: 'AI164' },
  { id: 'IN003', categoria: 'INDICE', descripcion: 'ALTO INDICE 1.74', abrev: 'AI174' },
  { id: 'IN004', categoria: 'INDICE', descripcion: 'ALTO INDICE 1.7', abrev: 'AI17' },
  { id: 'IN005', categoria: 'INDICE', descripcion: 'ALTO INDICE 1.8', abrev: 'AI18' },
  { id: 'IN006', categoria: 'INDICE', descripcion: 'ALTO INDICE 1.67', abrev: 'AI67' },
  { id: 'IN007', categoria: 'INDICE', descripcion: 'AI 1.85', abrev: 'AI 185' },
  // FILTROS
  { id: 'FI001', categoria: 'FILTROS', descripcion: 'FILTRO LUZ AZUL UV', abrev: 'FLAU' },
  { id: 'FI002', categoria: 'FILTROS', descripcion: 'FOTO BLUE GRIS', abrev: 'FB' },
  { id: 'FI003', categoria: 'FILTROS', descripcion: 'BLUE DEFENSE', abrev: 'BD' },
  // TALLADO
  { id: 'TA001', categoria: 'TALLADO', descripcion: 'REDUCCION DE DIAMETRO', abrev: 'RD' },
  { id: 'TA002', categoria: 'TALLADO', descripcion: 'DESCENTRADO', abrev: 'DST' },
  { id: 'TA003', categoria: 'TALLADO', descripcion: 'PRISMA', abrev: 'PS' },
  // FOTOSENSIBLES
  { id: 'FS001', categoria: 'FOTOSENSIBLES', descripcion: 'PHOTOGRAY', abrev: 'PHG' },
  { id: 'FS002', categoria: 'FOTOSENSIBLES', descripcion: 'TRANSITION', abrev: 'TRAN' },
  { id: 'FS003', categoria: 'FOTOSENSIBLES', descripcion: 'PHOTOMATIC', abrev: 'PHOT' },
  { id: 'FS004', categoria: 'FOTOSENSIBLES', descripcion: 'BLUPRINT', abrev: 'BLUP' },
  { id: 'FS005', categoria: 'FOTOSENSIBLES', descripcion: 'TOPGRAY', abrev: 'TOP' },
  { id: 'FS006', categoria: 'FOTOSENSIBLES', descripcion: 'TOPBROWN', abrev: 'TPB' },
  { id: 'FS007', categoria: 'FOTOSENSIBLES', descripcion: 'PHOTOMATIC BLUE', abrev: 'PHOT BL' }
];

// Precios de Lunas por Rango y Tipo (Variable movida al inicio, ahora asignaci√≥n)
PRECIOS_LUNAS = {
  // ESF√âRICOS
  ESFERICO: {
    RANGO_1: { min: 0.25, max: 2.00, precios: { PHOTOMATIC: 70, POLY_AR: 50, POLY_BLUE: 85, LUX_BLUE: 50, DIPPIN: 80 }},
    RANGO_2: { min: 2.25, max: 3.00, precios: { PHOTOMATIC: 70, POLY_AR: 50, POLY_BLUE: 85, LUX_BLUE: 50, DIPPIN: 80 }},
    RANGO_3: { min: 3.25, max: 4.00, precios: { PHOTOMATIC: 80, POLY_AR: 55, POLY_BLUE: 90, LUX_BLUE: 60, DIPPIN: 90 }},
    RANGO_4: { min: 4.25, max: 5.00, precios: { PHOTOMATIC: 120, POLY_AR: 120, POLY_BLUE: 150, LUX_BLUE: 110, DIPPIN: 145 }},
    RANGO_5: { min: 5.25, max: 6.00, precios: { PHOTOMATIC: 125, POLY_AR: 125, POLY_BLUE: 140, LUX_BLUE: 110, DIPPIN: 145 }}
  },
  // COMBINADOS (Esf + Cil)
  COMBINADO: {
    RANGO_1: { min: 0.25, max: 2.00, precios: { PHOTOMATIC: 75, POLY_AR: 50, POLY_BLUE: 85, LUX_BLUE: 50, DIPPIN: 80 }},
    RANGO_2: { min: 2.25, max: 3.00, precios: { PHOTOMATIC: 105, POLY_AR: 95, POLY_BLUE: 130, LUX_BLUE: 80, DIPPIN: 130 }},
    RANGO_3: { min: 3.25, max: 6.00, precios: { PHOTOMATIC: 125, POLY_AR: 125, POLY_BLUE: 140, LUX_BLUE: 110, DIPPIN: 145 }}
  },
  // CRISTALES ESF√âRICOS
  CRISTAL_ESF: {
    RANGO_1: { min: 0.25, max: 2.00, precios: { CRISTAL_BLANCO: 20, CRISTAL_AR: 26, CRISTAL_GRAY: 50, CRISTAL_FOTO_AR: 45 }},
    RANGO_2: { min: 2.25, max: 4.00, precios: { CRISTAL_BLANCO: 25, CRISTAL_AR: 30, CRISTAL_GRAY: 55, CRISTAL_FOTO_AR: 50 }},
    RANGO_3: { min: 4.25, max: 6.00, precios: { CRISTAL_BLANCO: 40, CRISTAL_AR: 45, CRISTAL_GRAY: 70, CRISTAL_FOTO_AR: 65 }}
  },
  // CRISTALES COMBINADOS
  CRISTAL_COMB: {
    RANGO_1: { min: 0.25, max: 2.00, precios: { CRISTAL_BLANCO: 25, CRISTAL_AR: 50 }},
    RANGO_2: { min: 2.25, max: 4.00, precios: { CRISTAL_BLANCO: 42, CRISTAL_AR: 55 }},
    RANGO_3: { min: 4.25, max: 6.00, precios: { CRISTAL_BLANCO: 80, CRISTAL_AR: 85 }}
  },
  // BIFOCAL
  BIFOCAL: {
    FLAT_TOP: 65,
    ADD_3: 135
  },
  // PROGRESIVOS
  PROGRESIVO: {
    ADAPTA_VIEW: { RX_BLUE: 360, PHOTOMATIC: 400, DIPPIN: 360, POLY_BLUE: 450 },
    EASY_VIEW: { RX_BLUE: 400, PHOTOMATIC: 420, DIPPIN: 450, POLY_BLUE: 390 },
    ULTRA_VIEW: { RX_BLUE: 580, PHOTOMATIC: 585, DIPPIN: 660, POLY_BLUE: 620 }
  },
  // ALTO √çNDICE
  ALTO_INDICE: {
    BLUE_AR_174: 460,
    QUARZ_174: 430
  },
  // INCREMENTO POR CILINDRO
  INCREMENTO_CIL: {
    RANGO_1: { min: 0.25, max: 4.00, inc: 5 },
    RANGO_2: { min: 4.25, max: 6.00, inc: 8 },
    RANGO_3: { min: 6.25, max: 8.00, inc: 10 }
  }
};

let filtroLunaCat = 'TIPO_FOCO';

// Inicializar tipos de lunas
function initTiposLunas() {
  const tipos = load(DB.TIPOS_LUNAS);
  if (tipos.length === 0) {
    save(DB.TIPOS_LUNAS, TIPOS_LUNAS_DEFAULT);
  }
}

// Renderizar tabla de tipos de lunas
function renderTiposLunas() {
  const tipos = load(DB.TIPOS_LUNAS).filter(t => t.categoria === filtroLunaCat);

  document.getElementById('tiposLunasBody').innerHTML = tipos.map(t => `
    <tr>
      <td class="text-center">
        <input type="checkbox" class="luna-check" data-id="${t.id}">
      </td>
      <td style="color: #0ea5e9; font-weight: 600;">${t.descripcion}</td>
      <td>${t.abrev}</td>
    </tr>
  `).join('');

  document.getElementById('lunasCount').textContent = `Registros: ${tipos.length}`;
}

// Tabs de categor√≠as de lunas
document.querySelectorAll('.luna-cat-btn').forEach(btn => {
  btn.onclick = () => {
    document.querySelectorAll('.luna-cat-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    filtroLunaCat = btn.dataset.lunacat;
    renderTiposLunas();
  };
});

// Tabs de secci√≥n lunas (Registrar / Vendidas)
document.querySelectorAll('.tab-btn[data-lunastab]').forEach(btn => {
  btn.onclick = () => {
    document.querySelectorAll('.tab-btn[data-lunastab]').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    document.querySelectorAll('.lunas-tab-content').forEach(c => c.classList.remove('active'));

    if (btn.dataset.lunastab === 'catalogo') {
      document.getElementById('tabCatalogoLunas').classList.add('active');
      renderCatalogoLunas();
    } else if (btn.dataset.lunastab === 'registrar') {
      document.getElementById('tabRegistrarLunas').classList.add('active');
    } else {
      document.getElementById('tabLunasVendidas').classList.add('active');
      renderLunasVendidas();
    }
  };
});

// Modal Tipo de Foco
function abrirModalTipoFoco(tipo = null) {
  document.getElementById('tipoFocoModalTitulo').textContent = tipo ? 'Editar Tipo de Foco' : 'Registrar Tipo de Foco';
  document.getElementById('tipoFocoIdHidden').value = tipo?.id || '';
  document.getElementById('tipoFocoCategoria').value = tipo?.categoria || filtroLunaCat;
  document.getElementById('tipoFocoDescripcion').value = tipo?.descripcion || '';
  document.getElementById('tipoFocoAbrev').value = tipo?.abrev || '';
  document.getElementById('tipoFocoModal').showModal();
}

function abrirModalEditarTipoFoco() {
  const seleccionados = Array.from(document.querySelectorAll('.luna-check:checked')).map(cb => cb.dataset.id);
  if (seleccionados.length !== 1) { toast('Selecciona un tipo de foco', 'warning'); return; }
  const tipo = load(DB.TIPOS_LUNAS).find(t => t.id === seleccionados[0]);
  if (tipo) abrirModalTipoFoco(tipo);
}

function guardarTipoFoco() {
  const descripcion = document.getElementById('tipoFocoDescripcion').value.trim();
  if (!descripcion) { toast('Descripci√≥n requerida', 'error'); return; }

  const id = document.getElementById('tipoFocoIdHidden').value || genId('TL');
  const tipo = {
    id,
    categoria: document.getElementById('tipoFocoCategoria').value,
    descripcion: descripcion.toUpperCase(),
    abrev: document.getElementById('tipoFocoAbrev').value.trim().toUpperCase()
  };

  const tipos = load(DB.TIPOS_LUNAS);
  const idx = tipos.findIndex(t => t.id === id);
  if (idx >= 0) tipos[idx] = tipo;
  else tipos.push(tipo);
  save(DB.TIPOS_LUNAS, tipos);

  cerrarModal('tipoFocoModal');
  renderTiposLunas();
  toast('Tipo de foco guardado');
}

function eliminarTipoFocoSeleccionado() {
  const seleccionados = Array.from(document.querySelectorAll('.luna-check:checked')).map(cb => cb.dataset.id);
  if (seleccionados.length === 0) { toast('Selecciona tipos de foco', 'warning'); return; }
  if (!confirm(`¬øEliminar ${seleccionados.length} tipo(s) de foco?`)) return;

  let tipos = load(DB.TIPOS_LUNAS);
  tipos = tipos.filter(t => !seleccionados.includes(t.id));
  save(DB.TIPOS_LUNAS, tipos);
  renderTiposLunas();
  toast('Tipos eliminados');
}

function toggleSeleccionarTodosLunas() {
  const checked = document.getElementById('selTodosLunas').checked;
  document.querySelectorAll('.luna-check').forEach(cb => cb.checked = checked);
}

// Selector de Lunas para Ventas
function abrirSelectorLunas() {
  // Limpiar campos
  ['lunaOdEsf', 'lunaOdCil', 'lunaOdEje', 'lunaOdAdd', 'lunaOiEsf', 'lunaOiCil', 'lunaOiEje', 'lunaOiAdd'].forEach(id => {
    document.getElementById(id).value = '';
  });
  document.getElementById('lunaTipoLente').value = 'ESFERICO';
  document.getElementById('lunaMaterial').value = 'PHOTOMATIC';
  document.getElementById('lunaPrecioCalculado').textContent = 'S/ 0.00';

  // Cargar lista de lunas disponibles
  renderSelectorLunasList();
  calcularPrecioLuna();
  document.getElementById('selectorLunasModal').showModal();
}

function renderSelectorLunasList() {
  const tipos = load(DB.TIPOS_LUNAS);
  const materiales = tipos.filter(t => t.categoria === 'MATERIAL' || t.categoria === 'TRATAMIENTO');

  document.getElementById('selectorLunasList').innerHTML = materiales.map(t => `
    <div class="selector-lunas-item" onclick="seleccionarLunaItem('${t.id}')">
      <input type="checkbox" id="chk_${t.id}">
      <span>${t.descripcion}</span>
    </div>
  `).join('');
}

function seleccionarLunaItem(id) {
  document.querySelectorAll('.selector-lunas-item').forEach(item => item.classList.remove('selected'));
  event.currentTarget.classList.add('selected');
  const cb = document.getElementById('chk_' + id);
  if (cb) cb.checked = !cb.checked;
}

// Calcular precio de luna seg√∫n medidas
function calcularPrecioLuna() {
  const tipoLente = document.getElementById('lunaTipoLente').value;
  const material = document.getElementById('lunaMaterial').value;

  const odEsf = Math.abs(parseFloat(document.getElementById('lunaOdEsf').value) || 0);
  const odCil = Math.abs(parseFloat(document.getElementById('lunaOdCil').value) || 0);
  const oiEsf = Math.abs(parseFloat(document.getElementById('lunaOiEsf').value) || 0);
  const oiCil = Math.abs(parseFloat(document.getElementById('lunaOiCil').value) || 0);

  // Usar el valor mayor entre ambos ojos
  const maxEsf = Math.max(odEsf, oiEsf);
  const maxCil = Math.max(odCil, oiCil);

  let precioBase = 0;
  let rango = '';
  let incCil = 0;

  // Determinar si es combinado (tiene cilindro)
  const esCombinado = maxCil > 0;
  const tipoReal = esCombinado && tipoLente === 'ESFERICO' ? 'COMBINADO' : tipoLente;

  // Calcular precio base seg√∫n tipo y rango
  if (tipoReal === 'ESFERICO' && PRECIOS_LUNAS.ESFERICO) {
    for (const [key, rangoData] of Object.entries(PRECIOS_LUNAS.ESFERICO)) {
      if (maxEsf >= rangoData.min && maxEsf <= rangoData.max) {
        precioBase = rangoData.precios[material] || 0;
        rango = `${rangoData.min.toFixed(2)} a ${rangoData.max.toFixed(2)}`;
        break;
      }
    }
  } else if (tipoReal === 'COMBINADO' && PRECIOS_LUNAS.COMBINADO) {
    for (const [key, rangoData] of Object.entries(PRECIOS_LUNAS.COMBINADO)) {
      if (maxEsf >= rangoData.min && maxEsf <= rangoData.max) {
        precioBase = rangoData.precios[material] || 0;
        rango = `${rangoData.min.toFixed(2)} a ${rangoData.max.toFixed(2)}`;
        break;
      }
    }
  } else if (tipoReal === 'BIFOCAL') {
    precioBase = PRECIOS_LUNAS.BIFOCAL.FLAT_TOP || 65;
    rango = 'Bifocal Flat Top';
  } else if (tipoReal === 'PROGRESIVO') {
    precioBase = PRECIOS_LUNAS.PROGRESIVO.ADAPTA_VIEW?.RX_BLUE || 360;
    rango = 'Progresivo Adapta View';
  }

  // Calcular incremento por cilindro
  if (maxCil > 0) {
    for (const [key, rangoData] of Object.entries(PRECIOS_LUNAS.INCREMENTO_CIL)) {
      if (maxCil >= rangoData.min && maxCil <= rangoData.max) {
        incCil = rangoData.inc;
        break;
      }
    }
  }

  // Precio total = (precio base + incremento cilindro) * 2 (par de lunas)
  const precioTotal = (precioBase + incCil) * 2;

  // Actualizar UI
  document.getElementById('lunaPrecioCalculado').textContent = `S/ ${precioTotal.toFixed(2)}`;
  document.getElementById('resumenTipo').textContent = tipoReal;
  document.getElementById('resumenMaterial').textContent = material.replace(/_/g, ' ');
  document.getElementById('resumenRango').textContent = rango || 'Sin rango definido';
  document.getElementById('resumenIncCil').textContent = `S/ ${(incCil * 2).toFixed(2)}`;

  return precioTotal;
}

// Agregar luna a venta
function agregarLunaAVenta() {
  // Verificar si hay un precio manual ingresado
  const precioManual = parseFloat(document.getElementById('lunaPrecioManual').value);
  const precioCalculado = calcularPrecioLuna();

  // Usar precio manual si est√° disponible, sino usar el calculado
  const precio = precioManual > 0 ? precioManual : precioCalculado;

  if (precio <= 0) { toast('Configura las medidas o ingresa un precio manual', 'warning'); return; }

  const tipoLente = document.getElementById('lunaTipoLente').value;
  const material = document.getElementById('lunaMaterial').value;
  const odEsf = document.getElementById('lunaOdEsf').value || '0';
  const odCil = document.getElementById('lunaOdCil').value || '0';
  const oiEsf = document.getElementById('lunaOiEsf').value || '0';
  const oiCil = document.getElementById('lunaOiCil').value || '0';

  const descripcion = `Luna ${tipoLente} ${material.replace(/_/g, ' ')} | OD: ${odEsf}/${odCil} OI: ${oiEsf}/${oiCil}`;

  itemsVenta.push({
    descripcion,
    cantidad: 1,
    precio: precio,
    descuento: 0,
    esLuna: true,
    detallesLuna: {
      tipo: tipoLente,
      material,
      odEsf, odCil,
      oiEsf, oiCil,
      odEje: document.getElementById('lunaOdEje').value,
      oiEje: document.getElementById('lunaOiEje').value,
      odAdd: document.getElementById('lunaOdAdd').value,
      oiAdd: document.getElementById('lunaOiAdd').value
    }
  });

  // Guardar en historial de lunas vendidas
  const lunaVendida = {
    id: genId('LV'),
    fecha: today(),
    clienteId: document.getElementById('clienteId').value,
    clienteNombre: document.getElementById('clienteNombre').value || 'CLIENTE EVENTUAL',
    tipo: tipoLente,
    material,
    tratamiento: '',
    medidaOd: `${odEsf}/${odCil}`,
    medidaOi: `${oiEsf}/${oiCil}`,
    precio,
    ventaId: ''
  };

  const lunasVendidas = load(DB.LUNAS_VENDIDAS);
  lunasVendidas.push(lunaVendida);
  save(DB.LUNAS_VENDIDAS, lunasVendidas);

  // Reducir stock del inventario de lunas
  reducirStockLuna(tipoLente, material, 1);

  renderItemsVenta();
  cerrarModal('selectorLunasModal');
  toast('Luna agregada a la venta');
}

// Renderizar lunas vendidas
function renderLunasVendidas() {
  const lunasVendidas = load(DB.LUNAS_VENDIDAS);
  const filtro = (document.getElementById('buscarLunaVendida')?.value || '').toLowerCase();
  const desde = document.getElementById('lunaVendidaDesde')?.value;
  const hasta = document.getElementById('lunaVendidaHasta')?.value;

  let filtradas = lunasVendidas.filter(l => {
    if (filtro && !l.clienteNombre.toLowerCase().includes(filtro) && !l.tipo.toLowerCase().includes(filtro)) return false;
    if (desde && l.fecha < desde) return false;
    if (hasta && l.fecha > hasta) return false;
    return true;
  });

  let totalVentas = 0;

  document.getElementById('lunasVendidasBody').innerHTML = filtradas.map(l => {
    totalVentas += l.precio;
    return `
      <tr>
        <td>${formatDate(l.fecha)}</td>
        <td><strong>${l.clienteNombre}</strong></td>
        <td>${l.tipo}</td>
        <td>${l.material?.replace(/_/g, ' ') || '-'}</td>
        <td>${l.tratamiento || '-'}</td>
        <td>${l.medidaOd}</td>
        <td>${l.medidaOi}</td>
        <td class="text-right"><strong style="color: #16a34a;">S/ ${l.precio.toFixed(2)}</strong></td>
        <td>${l.ventaId || '-'}</td>
      </tr>
    `;
  }).join('');

  document.getElementById('lunasVendidasCount').textContent = `Registros: ${filtradas.length}`;
  document.getElementById('totalLunasVendidas').textContent = `S/ ${totalVentas.toFixed(2)}`;
}

// Exportar lunas a Excel
function exportarLunasExcel() {
  const tipos = load(DB.TIPOS_LUNAS);
  if (tipos.length === 0) { toast('No hay tipos de lunas', 'warning'); return; }

  const headers = ['ID', 'Categor√≠a', 'Descripci√≥n', 'Abreviatura'];
  const rows = tipos.map(t => [t.id, t.categoria, t.descripcion, t.abrev]);
  const csv = generarCSV(headers, rows);
  descargarCSV(csv, 'tipos_lunas_optica.csv');
  toast('Tipos de lunas exportados');
}

function exportarLunasVendidasExcel() {
  const lunasVendidas = load(DB.LUNAS_VENDIDAS);
  if (lunasVendidas.length === 0) { toast('No hay lunas vendidas', 'warning'); return; }

  const headers = ['Fecha', 'Cliente', 'Tipo', 'Material', 'Tratamiento', 'Medida OD', 'Medida OI', 'Precio'];
  const rows = lunasVendidas.map(l => [
    l.fecha,
    l.clienteNombre,
    l.tipo,
    l.material || '',
    l.tratamiento || '',
    l.medidaOd,
    l.medidaOi,
    l.precio.toFixed(2)
  ]);
  const csv = generarCSV(headers, rows);
  descargarCSV(csv, 'lunas_vendidas_optica.csv');
  toast('Lunas vendidas exportadas');
}

/* ============================================
   CAT√ÅLOGO DE LUNAS - INVENTARIO COMPLETO
   ============================================ */

// Cat√°logo completo de lunas con todos los tipos y precios
const CATALOGO_LUNAS_COMPLETO = [
  // === ESF√âRICOS ===
  // Rango 0.25 a 2.00
  { id: 'ESF_R1_PHOTO', categoria: 'ESFERICO', tipo: 'PHOTOMATIC', rango: '0.25 a 2.00', precio: 70 },
  { id: 'ESF_R1_POLY_AR', categoria: 'ESFERICO', tipo: 'POLY AR', rango: '0.25 a 2.00', precio: 50 },
  { id: 'ESF_R1_POLY_BLUE', categoria: 'ESFERICO', tipo: 'POLY BLUE', rango: '0.25 a 2.00', precio: 85 },
  { id: 'ESF_R1_LUX_BLUE', categoria: 'ESFERICO', tipo: 'LUX BLUE', rango: '0.25 a 2.00', precio: 50 },
  { id: 'ESF_R1_DIPPIN', categoria: 'ESFERICO', tipo: 'DIPPIN', rango: '0.25 a 2.00', precio: 80 },
  // Rango 2.25 a 3.00
  { id: 'ESF_R2_PHOTO', categoria: 'ESFERICO', tipo: 'PHOTOMATIC', rango: '2.25 a 3.00', precio: 70 },
  { id: 'ESF_R2_POLY_AR', categoria: 'ESFERICO', tipo: 'POLY AR', rango: '2.25 a 3.00', precio: 50 },
  { id: 'ESF_R2_POLY_BLUE', categoria: 'ESFERICO', tipo: 'POLY BLUE', rango: '2.25 a 3.00', precio: 85 },
  { id: 'ESF_R2_LUX_BLUE', categoria: 'ESFERICO', tipo: 'LUX BLUE', rango: '2.25 a 3.00', precio: 50 },
  { id: 'ESF_R2_DIPPIN', categoria: 'ESFERICO', tipo: 'DIPPIN', rango: '2.25 a 3.00', precio: 80 },
  // Rango 3.25 a 4.00
  { id: 'ESF_R3_PHOTO', categoria: 'ESFERICO', tipo: 'PHOTOMATIC', rango: '3.25 a 4.00', precio: 80 },
  { id: 'ESF_R3_POLY_AR', categoria: 'ESFERICO', tipo: 'POLY AR', rango: '3.25 a 4.00', precio: 55 },
  { id: 'ESF_R3_POLY_BLUE', categoria: 'ESFERICO', tipo: 'POLY BLUE', rango: '3.25 a 4.00', precio: 90 },
  { id: 'ESF_R3_LUX_BLUE', categoria: 'ESFERICO', tipo: 'LUX BLUE', rango: '3.25 a 4.00', precio: 60 },
  { id: 'ESF_R3_DIPPIN', categoria: 'ESFERICO', tipo: 'DIPPIN', rango: '3.25 a 4.00', precio: 90 },
  // Rango 4.25 a 5.00
  { id: 'ESF_R4_PHOTO', categoria: 'ESFERICO', tipo: 'PHOTOMATIC', rango: '4.25 a 5.00', precio: 120 },
  { id: 'ESF_R4_POLY_AR', categoria: 'ESFERICO', tipo: 'POLY AR', rango: '4.25 a 5.00', precio: 120 },
  { id: 'ESF_R4_POLY_BLUE', categoria: 'ESFERICO', tipo: 'POLY BLUE', rango: '4.25 a 5.00', precio: 150 },
  { id: 'ESF_R4_LUX_BLUE', categoria: 'ESFERICO', tipo: 'LUX BLUE', rango: '4.25 a 5.00', precio: 110 },
  { id: 'ESF_R4_DIPPIN', categoria: 'ESFERICO', tipo: 'DIPPIN', rango: '4.25 a 5.00', precio: 145 },
  // Rango 5.25 a 6.00
  { id: 'ESF_R5_PHOTO', categoria: 'ESFERICO', tipo: 'PHOTOMATIC', rango: '5.25 a 6.00', precio: 125 },
  { id: 'ESF_R5_POLY_AR', categoria: 'ESFERICO', tipo: 'POLY AR', rango: '5.25 a 6.00', precio: 125 },
  { id: 'ESF_R5_POLY_BLUE', categoria: 'ESFERICO', tipo: 'POLY BLUE', rango: '5.25 a 6.00', precio: 140 },
  { id: 'ESF_R5_LUX_BLUE', categoria: 'ESFERICO', tipo: 'LUX BLUE', rango: '5.25 a 6.00', precio: 110 },
  { id: 'ESF_R5_DIPPIN', categoria: 'ESFERICO', tipo: 'DIPPIN', rango: '5.25 a 6.00', precio: 145 },

  // === COMBINADOS ===
  // Rango 0.25 a 2.00
  { id: 'COMB_R1_PHOTO', categoria: 'COMBINADO', tipo: 'PHOTOMATIC', rango: '0.25 a 2.00', precio: 75 },
  { id: 'COMB_R1_POLY_AR', categoria: 'COMBINADO', tipo: 'POLY AR', rango: '0.25 a 2.00', precio: 50 },
  { id: 'COMB_R1_POLY_BLUE', categoria: 'COMBINADO', tipo: 'POLY BLUE', rango: '0.25 a 2.00', precio: 85 },
  { id: 'COMB_R1_LUX_BLUE', categoria: 'COMBINADO', tipo: 'LUX BLUE', rango: '0.25 a 2.00', precio: 50 },
  { id: 'COMB_R1_DIPPIN', categoria: 'COMBINADO', tipo: 'DIPPIN', rango: '0.25 a 2.00', precio: 80 },
  // Rango 2.25 a 3.00
  { id: 'COMB_R2_PHOTO', categoria: 'COMBINADO', tipo: 'PHOTOMATIC', rango: '2.25 a 3.00', precio: 105 },
  { id: 'COMB_R2_POLY_AR', categoria: 'COMBINADO', tipo: 'POLY AR', rango: '2.25 a 3.00', precio: 95 },
  { id: 'COMB_R2_POLY_BLUE', categoria: 'COMBINADO', tipo: 'POLY BLUE', rango: '2.25 a 3.00', precio: 130 },
  { id: 'COMB_R2_LUX_BLUE', categoria: 'COMBINADO', tipo: 'LUX BLUE', rango: '2.25 a 3.00', precio: 80 },
  { id: 'COMB_R2_DIPPIN', categoria: 'COMBINADO', tipo: 'DIPPIN', rango: '2.25 a 3.00', precio: 130 },
  // Rango 3.25 a 6.00
  { id: 'COMB_R3_PHOTO', categoria: 'COMBINADO', tipo: 'PHOTOMATIC', rango: '3.25 a 6.00', precio: 125 },
  { id: 'COMB_R3_POLY_AR', categoria: 'COMBINADO', tipo: 'POLY AR', rango: '3.25 a 6.00', precio: 125 },
  { id: 'COMB_R3_POLY_BLUE', categoria: 'COMBINADO', tipo: 'POLY BLUE', rango: '3.25 a 6.00', precio: 140 },
  { id: 'COMB_R3_LUX_BLUE', categoria: 'COMBINADO', tipo: 'LUX BLUE', rango: '3.25 a 6.00', precio: 110 },
  { id: 'COMB_R3_DIPPIN', categoria: 'COMBINADO', tipo: 'DIPPIN', rango: '3.25 a 6.00', precio: 145 },

  // === CRISTALES ESF√âRICOS ===
  // Rango 0.25 a 2.00
  { id: 'CRIST_ESF_R1_BLANCO', categoria: 'CRISTAL', tipo: 'CRISTAL BLANCO', rango: '0.25 a 2.00', precio: 20 },
  { id: 'CRIST_ESF_R1_AR', categoria: 'CRISTAL', tipo: 'CRISTAL AR', rango: '0.25 a 2.00', precio: 26 },
  { id: 'CRIST_ESF_R1_GRAY', categoria: 'CRISTAL', tipo: 'CRISTAL GRAY', rango: '0.25 a 2.00', precio: 50 },
  { id: 'CRIST_ESF_R1_FOTO_AR', categoria: 'CRISTAL', tipo: 'CRISTAL FOTO AR', rango: '0.25 a 2.00', precio: 45 },
  // Rango 2.25 a 4.00
  { id: 'CRIST_ESF_R2_BLANCO', categoria: 'CRISTAL', tipo: 'CRISTAL BLANCO', rango: '2.25 a 4.00', precio: 25 },
  { id: 'CRIST_ESF_R2_AR', categoria: 'CRISTAL', tipo: 'CRISTAL AR', rango: '2.25 a 4.00', precio: 30 },
  { id: 'CRIST_ESF_R2_GRAY', categoria: 'CRISTAL', tipo: 'CRISTAL GRAY', rango: '2.25 a 4.00', precio: 55 },
  { id: 'CRIST_ESF_R2_FOTO_AR', categoria: 'CRISTAL', tipo: 'CRISTAL FOTO AR', rango: '2.25 a 4.00', precio: 50 },
  // Rango 4.25 a 6.00
  { id: 'CRIST_ESF_R3_BLANCO', categoria: 'CRISTAL', tipo: 'CRISTAL BLANCO', rango: '4.25 a 6.00', precio: 40 },
  { id: 'CRIST_ESF_R3_AR', categoria: 'CRISTAL', tipo: 'CRISTAL AR', rango: '4.25 a 6.00', precio: 45 },
  { id: 'CRIST_ESF_R3_GRAY', categoria: 'CRISTAL', tipo: 'CRISTAL GRAY', rango: '4.25 a 6.00', precio: 70 },
  { id: 'CRIST_ESF_R3_FOTO_AR', categoria: 'CRISTAL', tipo: 'CRISTAL FOTO AR', rango: '4.25 a 6.00', precio: 65 },

  // === CRISTALES COMBINADOS ===
  // Rango 0.25 a 2.00
  { id: 'CRIST_COMB_R1_BLANCO', categoria: 'CRISTAL', tipo: 'CRISTAL COMB BLANCO', rango: '0.25 a 2.00', precio: 25 },
  { id: 'CRIST_COMB_R1_AR', categoria: 'CRISTAL', tipo: 'CRISTAL COMB AR', rango: '0.25 a 2.00', precio: 50 },
  // Rango 2.25 a 4.00
  { id: 'CRIST_COMB_R2_BLANCO', categoria: 'CRISTAL', tipo: 'CRISTAL COMB BLANCO', rango: '2.25 a 4.00', precio: 42 },
  { id: 'CRIST_COMB_R2_AR', categoria: 'CRISTAL', tipo: 'CRISTAL COMB AR', rango: '2.25 a 4.00', precio: 55 },
  // Rango 4.25 a 6.00
  { id: 'CRIST_COMB_R3_BLANCO', categoria: 'CRISTAL', tipo: 'CRISTAL COMB BLANCO', rango: '4.25 a 6.00', precio: 80 },
  { id: 'CRIST_COMB_R3_AR', categoria: 'CRISTAL', tipo: 'CRISTAL COMB AR', rango: '4.25 a 6.00', precio: 85 },

  // === BIFOCALES ===
  { id: 'BIF_FLAT_TOP', categoria: 'BIFOCAL', tipo: 'FLAT TOP', rango: 'Est√°ndar', precio: 65 },
  { id: 'BIF_ADD_3', categoria: 'BIFOCAL', tipo: 'ADD +3.00', rango: 'ADD Alto', precio: 135 },
  { id: 'BIF_INVISIBLE', categoria: 'BIFOCAL', tipo: 'INVISIBLE', rango: 'Est√°ndar', precio: 95 },
  { id: 'BIF_BLENDED', categoria: 'BIFOCAL', tipo: 'BLENDED', rango: 'Est√°ndar', precio: 110 },

  // === PROGRESIVOS ===
  // ADAPTA VIEW
  { id: 'PROG_ADAPTA_RX_BLUE', categoria: 'PROGRESIVO', tipo: 'ADAPTA VIEW RX BLUE', rango: 'Est√°ndar', precio: 360 },
  { id: 'PROG_ADAPTA_PHOTO', categoria: 'PROGRESIVO', tipo: 'ADAPTA VIEW PHOTOMATIC', rango: 'Est√°ndar', precio: 400 },
  { id: 'PROG_ADAPTA_DIPPIN', categoria: 'PROGRESIVO', tipo: 'ADAPTA VIEW DIPPIN', rango: 'Est√°ndar', precio: 360 },
  { id: 'PROG_ADAPTA_POLY_BLUE', categoria: 'PROGRESIVO', tipo: 'ADAPTA VIEW POLY BLUE', rango: 'Est√°ndar', precio: 450 },
  // EASY VIEW
  { id: 'PROG_EASY_RX_BLUE', categoria: 'PROGRESIVO', tipo: 'EASY VIEW RX BLUE', rango: 'Est√°ndar', precio: 400 },
  { id: 'PROG_EASY_PHOTO', categoria: 'PROGRESIVO', tipo: 'EASY VIEW PHOTOMATIC', rango: 'Est√°ndar', precio: 420 },
  { id: 'PROG_EASY_DIPPIN', categoria: 'PROGRESIVO', tipo: 'EASY VIEW DIPPIN', rango: 'Est√°ndar', precio: 450 },
  { id: 'PROG_EASY_POLY_BLUE', categoria: 'PROGRESIVO', tipo: 'EASY VIEW POLY BLUE', rango: 'Est√°ndar', precio: 390 },
  // ULTRA VIEW
  { id: 'PROG_ULTRA_RX_BLUE', categoria: 'PROGRESIVO', tipo: 'ULTRA VIEW RX BLUE', rango: 'Premium', precio: 580 },
  { id: 'PROG_ULTRA_PHOTO', categoria: 'PROGRESIVO', tipo: 'ULTRA VIEW PHOTOMATIC', rango: 'Premium', precio: 585 },
  { id: 'PROG_ULTRA_DIPPIN', categoria: 'PROGRESIVO', tipo: 'ULTRA VIEW DIPPIN', rango: 'Premium', precio: 660 },
  { id: 'PROG_ULTRA_POLY_BLUE', categoria: 'PROGRESIVO', tipo: 'ULTRA VIEW POLY BLUE', rango: 'Premium', precio: 620 },

  // === ALTO √çNDICE ===
  { id: 'AI_BLUE_AR_174', categoria: 'ALTO_INDICE', tipo: 'BLUE AR 1.74', rango: 'Ultra Delgado', precio: 460 },
  { id: 'AI_QUARZ_174', categoria: 'ALTO_INDICE', tipo: 'QUARZ 1.74', rango: 'Ultra Delgado', precio: 430 },
  { id: 'AI_BLUE_AR_167', categoria: 'ALTO_INDICE', tipo: 'BLUE AR 1.67', rango: 'Muy Delgado', precio: 280 },
  { id: 'AI_PHOTO_167', categoria: 'ALTO_INDICE', tipo: 'PHOTOMATIC 1.67', rango: 'Muy Delgado', precio: 320 },

  // === INCREMENTO POR CILINDRO ===
  { id: 'INC_CIL_R1', categoria: 'INCREMENTO_CIL', tipo: 'Incremento Cil', rango: '0.25 a 4.00', precio: 5 },
  { id: 'INC_CIL_R2', categoria: 'INCREMENTO_CIL', tipo: 'Incremento Cil', rango: '4.25 a 6.00', precio: 8 },
  { id: 'INC_CIL_R3', categoria: 'INCREMENTO_CIL', tipo: 'Incremento Cil', rango: '6.25 a 8.00', precio: 10 }
];

// Variable para filtro de inventario
let filtroInvLuna = 'TODOS';

// Inicializar inventario de lunas si no existe
function initInventarioLunas() {
  let inventario = load(DB.INVENTARIO_LUNAS);
  if (!inventario || inventario.length === 0) {
    // Crear inventario inicial basado en el cat√°logo
    inventario = CATALOGO_LUNAS_COMPLETO.map(luna => ({
      id: luna.id,
      categoria: luna.categoria,
      tipo: luna.tipo,
      rango: luna.rango,
      precio: luna.precio,
      stock: 10 // Stock inicial
    }));
    save(DB.INVENTARIO_LUNAS, inventario);
  }
  return inventario;
}

// Renderizar cat√°logo de lunas
function renderCatalogoLunas() {
  let inventario = initInventarioLunas();

  // Filtrar por categor√≠a
  if (filtroInvLuna !== 'TODOS') {
    inventario = inventario.filter(l => l.categoria === filtroInvLuna);
  }

  const iconos = {
    'ESFERICO': 'üîµ',
    'COMBINADO': 'üü£',
    'CRISTAL': 'üü§',
    'BIFOCAL': 'üîµ',
    'PROGRESIVO': 'üü¢',
    'ALTO_INDICE': 'üü°',
    'INCREMENTO_CIL': '‚ö™'
  };

  let totalProductos = 0;
  let valorTotal = 0;

  const html = inventario.map(luna => {
    totalProductos++;
    valorTotal += luna.precio * luna.stock;

    const stockClass = luna.stock === 0 ? 'stock-cero' :
                       luna.stock < 5 ? 'stock-bajo' :
                       luna.stock < 10 ? 'stock-medio' : 'stock-alto';

    return `
      <tr>
        <td><span style="font-size: 16px;">${iconos[luna.categoria] || '‚ö™'}</span> ${luna.categoria.replace(/_/g, ' ')}</td>
        <td><strong style="color: #0ea5e9;">${luna.tipo}</strong></td>
        <td>${luna.rango}</td>
        <td class="text-right"><strong>S/ ${luna.precio.toFixed(2)}</strong></td>
        <td class="text-center">
          <span class="stock-badge ${stockClass}">${luna.stock}</span>
        </td>
        <td class="text-center">
          <button class="btn btn-sm btn-warning" onclick="editarLuna('${luna.id}')" title="Editar Nombre y Precio">‚úèÔ∏è</button>
          <button class="btn btn-sm btn-secondary" onclick="editarStockLuna('${luna.id}')" title="Editar Stock">üìù</button>
          <button class="btn btn-sm btn-success" onclick="agregarStockLuna('${luna.id}', 1)" title="+1">+</button>
          <button class="btn btn-sm btn-danger" onclick="agregarStockLuna('${luna.id}', -1)" title="-1">‚àí</button>
        </td>
      </tr>
    `;
  }).join('');

  document.getElementById('catalogoLunasBody').innerHTML = html;
  document.getElementById('catalogoLunasCount').textContent = `Productos: ${totalProductos}`;
  document.getElementById('catalogoLunasTotal').textContent = `Valor Total: S/ ${valorTotal.toFixed(2)}`;
}

// Filtro de categor√≠as de inventario
document.querySelectorAll('.luna-inv-btn').forEach(btn => {
  btn.onclick = () => {
    document.querySelectorAll('.luna-inv-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    filtroInvLuna = btn.dataset.lunainv;
    renderCatalogoLunas();
  };
});

// Editar stock de una luna
function editarStockLuna(id) {
  const inventario = load(DB.INVENTARIO_LUNAS);
  const luna = inventario.find(l => l.id === id);
  if (!luna) return;

  const nuevoStock = prompt(`Stock actual de "${luna.tipo}" (${luna.rango}): ${luna.stock}\n\nIngrese nuevo stock:`, luna.stock);
  if (nuevoStock === null) return;

  const stock = parseInt(nuevoStock);
  if (isNaN(stock) || stock < 0) {
    toast('Stock inv√°lido', 'error');
    return;
  }

  luna.stock = stock;
  save(DB.INVENTARIO_LUNAS, inventario);
  renderCatalogoLunas();
  toast(`Stock actualizado: ${luna.tipo} = ${stock}`);
}

// Editar nombre y precio de una luna
function editarLuna(id) {
  const inventario = load(DB.INVENTARIO_LUNAS);
  const luna = inventario.find(l => l.id === id);
  if (!luna) return;

  // Solicitar nuevo nombre
  const nuevoNombre = prompt(`Editar nombre de luna\n\nNombre actual: "${luna.tipo}"\n\nIngrese nuevo nombre:`, luna.tipo);
  if (nuevoNombre === null) return;

  const nombreTrim = nuevoNombre.trim();
  if (!nombreTrim) {
    toast('El nombre no puede estar vac√≠o', 'error');
    return;
  }

  // Solicitar nuevo precio
  const nuevoPrecio = prompt(`Editar precio de luna\n\nPrecio actual: S/ ${luna.precio.toFixed(2)}\n\nIngrese nuevo precio:`, luna.precio);
  if (nuevoPrecio === null) return;

  const precio = parseFloat(nuevoPrecio);
  if (isNaN(precio) || precio < 0) {
    toast('Precio inv√°lido', 'error');
    return;
  }

  // Actualizar datos
  luna.tipo = nombreTrim;
  luna.precio = precio;
  save(DB.INVENTARIO_LUNAS, inventario);
  renderCatalogoLunas();
  toast(`‚úÖ Luna actualizada: ${nombreTrim} - S/ ${precio.toFixed(2)}`);
}

// Agregar o quitar stock
function agregarStockLuna(id, cantidad) {
  const inventario = load(DB.INVENTARIO_LUNAS);
  const luna = inventario.find(l => l.id === id);
  if (!luna) return;

  luna.stock = Math.max(0, luna.stock + cantidad);
  save(DB.INVENTARIO_LUNAS, inventario);
  renderCatalogoLunas();
}

// Exportar cat√°logo de lunas a Excel
function exportarCatalogoLunasExcel() {
  const inventario = load(DB.INVENTARIO_LUNAS);
  if (!inventario || inventario.length === 0) {
    toast('No hay datos en el inventario', 'warning');
    return;
  }

  // Calcular valor total
  const valorTotal = inventario.reduce((sum, l) => sum + (l.precio * l.stock), 0);

  const headers = ['CATEGOR√çA', 'TIPO DE LUNA', 'RANGO', 'PRECIO UNIT.', 'STOCK', 'VALOR TOTAL'];
  const rows = inventario.map(l => [
    l.categoria.replace(/_/g, ' '),
    l.tipo,
    l.rango,
    l.precio.toFixed(2),
    l.stock,
    (l.precio * l.stock).toFixed(2)
  ]);

  // Agregar fila de totales
  rows.push(['', '', '', '', 'TOTAL', valorTotal.toFixed(2)]);

  const csv = generarCSV(headers, rows);
  descargarCSV(csv, `inventario_lunas_${today()}.csv`);
  toast('Inventario de lunas exportado');
}

// Reducir stock al vender luna
function reducirStockLuna(categoria, tipo, cantidad = 1) {
  const inventario = load(DB.INVENTARIO_LUNAS);

  // Buscar luna que coincida
  const luna = inventario.find(l =>
    l.categoria === categoria ||
    l.tipo.toLowerCase().includes(tipo.toLowerCase())
  );

  if (luna && luna.stock > 0) {
    luna.stock = Math.max(0, luna.stock - cantidad);
    save(DB.INVENTARIO_LUNAS, inventario);
  }
}

/* ============================================
   ALMAC√âN - SISTEMA COMPLETO
   ============================================ */

// Variables globales de almac√©n
let tipoIngresoActual = 'COMPRA_DIRECTA';
let tipoSalidaActual = 'TRASLADO_ALMACENES';
let productosIngreso = [];
let productosSalida = [];
let productosGuia = [];
// Variable movida al inicio del script (l√≠nea 9690)
let contextoModal = 'ingreso';
let guiaEditandoId = null;

// Navegaci√≥n de tabs de almac√©n
document.querySelectorAll('.almacen-tab-btn').forEach(btn => {
  btn.onclick = () => {
    document.querySelectorAll('.almacen-tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.almacen-tab-content').forEach(c => c.classList.remove('active'));
    btn.classList.add('active');
    const tab = btn.dataset.almtab;
    const tabMap = {
      'ingreso': 'tabIngreso',
      'salida': 'tabSalida',
      'guias': 'tabGuias',
      'kardex': 'tabKardex',
      'stock': 'tabStock'
    };
    document.getElementById(tabMap[tab])?.classList.add('active');

    if (tab === 'guias') buscarGuias();
    if (tab === 'kardex') inicializarKardex();
    if (tab === 'stock') buscarStock();
  };
});

// Tipos de movimiento - Ingreso
document.querySelectorAll('.mov-tipo-btn.ingreso').forEach(btn => {
  btn.onclick = () => {
    document.querySelectorAll('.mov-tipo-btn.ingreso').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    tipoIngresoActual = btn.dataset.tipo;
  };
});

// Tipos de movimiento - Salida
document.querySelectorAll('.mov-tipo-btn.salida').forEach(btn => {
  btn.onclick = () => {
    document.querySelectorAll('.mov-tipo-btn.salida').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    tipoSalidaActual = btn.dataset.tipo;
  };
});

// Inicializar fechas
function initAlmacenFechas() {
  const hoy = today();
  document.getElementById('ingresoFecha').value = hoy;
  document.getElementById('salidaFecha').value = hoy;
}

// ========== INGRESO DE MERCADER√çA ==========

function agregarFilaIngreso() {
  productosIngreso.push({
    id: genId('ing'),
    productoId: '',
    codigo: '',
    nombre: '',
    cantidad: 1,
    costoUnit: 0
  });
  renderFilasIngreso();
}

function renderFilasIngreso() {
  const body = document.getElementById('ingresoProductosBody');
  body.innerHTML = productosIngreso.map((item, idx) => `
    <tr>
      <td>
        <input type="text" value="${item.codigo}" placeholder="C√≥digo"
               onchange="actualizarIngresoItem(${idx}, 'codigo', this.value)"
               onkeyup="buscarProductoPorCodigo(this.value, ${idx}, 'ingreso')">
      </td>
      <td>
        <input type="text" value="${item.nombre}" placeholder="Producto"
               onchange="actualizarIngresoItem(${idx}, 'nombre', this.value)">
      </td>
      <td class="text-center">
        <input type="number" min="1" value="${item.cantidad}" style="width: 80px; text-align: center;"
               onchange="actualizarIngresoItem(${idx}, 'cantidad', parseFloat(this.value) || 1)">
      </td>
      <td class="text-right">
        <input type="number" min="0" step="0.01" value="${item.costoUnit.toFixed(2)}"
               style="width: 100px; text-align: right;"
               onchange="actualizarIngresoItem(${idx}, 'costoUnit', parseFloat(this.value) || 0)">
      </td>
      <td class="text-right" style="font-weight: 600;">S/ ${(item.cantidad * item.costoUnit).toFixed(2)}</td>
      <td class="text-center">
        <button class="btn btn-danger btn-sm" onclick="eliminarFilaIngreso(${idx})">√ó</button>
      </td>
    </tr>
  `).join('');
  calcularTotalIngreso();
}

function actualizarIngresoItem(idx, campo, valor) {
  productosIngreso[idx][campo] = valor;
  calcularTotalIngreso();
}

function eliminarFilaIngreso(idx) {
  productosIngreso.splice(idx, 1);
  renderFilasIngreso();
}

function calcularTotalIngreso() {
  const total = productosIngreso.reduce((sum, item) => sum + (item.cantidad * item.costoUnit), 0);
  document.getElementById('ingresoTotal').textContent = `S/ ${total.toFixed(2)}`;
}

function limpiarIngreso() {
  productosIngreso = [];
  document.getElementById('ingresoNroDoc').value = '';
  document.getElementById('ingresoProveedor').value = '';
  document.getElementById('ingresoFecha').value = today();
  renderFilasIngreso();
  toast('Formulario limpiado');
}

function procesarIngreso() {
  if (productosIngreso.length === 0) {
    toast('Agregue al menos un producto', 'warning');
    return;
  }

  const nroDoc = document.getElementById('ingresoNroDoc').value.trim();
  const fecha = document.getElementById('ingresoFecha').value;
  const proveedor = document.getElementById('ingresoProveedor').value.trim();

  if (!nroDoc) {
    toast('Ingrese n√∫mero de documento', 'warning');
    return;
  }

  const productos = load(DB.PRODUCTOS);
  const movimientos = load(DB.MOVIMIENTOS);

  productosIngreso.forEach(item => {
    if (!item.productoId && item.codigo) {
      const prod = productos.find(p => p.codigo === item.codigo);
      if (prod) item.productoId = prod.id;
    }

    if (item.productoId) {
      const prod = productos.find(p => p.id === item.productoId);
      if (prod) {
        prod.stock = (prod.stock || 0) + item.cantidad;
      }
    }

    movimientos.push({
      id: genId('mov'),
      tipo: 'INGRESO',
      tipoMov: tipoIngresoActual,
      fecha: fecha,
      documento: nroDoc,
      productoId: item.productoId,
      codigo: item.codigo,
      producto: item.nombre,
      cantidad: item.cantidad,
      costoUnit: item.costoUnit,
      proveedor: proveedor,
      creado: now()
    });
  });

  save(DB.PRODUCTOS, productos);
  save(DB.MOVIMIENTOS, movimientos);

  limpiarIngreso();
  toast('Ingreso procesado correctamente');
  renderInventario();
}

// ========== SALIDA DE MERCADER√çA ==========

function agregarFilaSalida() {
  productosSalida.push({
    id: genId('sal'),
    productoId: '',
    codigo: '',
    nombre: '',
    stockActual: 0,
    cantidad: 1,
    costoUnit: 0
  });
  renderFilasSalida();
}

function renderFilasSalida() {
  const body = document.getElementById('salidaProductosBody');
  body.innerHTML = productosSalida.map((item, idx) => `
    <tr>
      <td>
        <input type="text" value="${item.codigo}" placeholder="C√≥digo"
               onchange="actualizarSalidaItem(${idx}, 'codigo', this.value)"
               onkeyup="buscarProductoPorCodigo(this.value, ${idx}, 'salida')">
      </td>
      <td>
        <input type="text" value="${item.nombre}" placeholder="Producto"
               onchange="actualizarSalidaItem(${idx}, 'nombre', this.value)">
      </td>
      <td class="text-center">
        <span class="badge ${item.stockActual > 0 ? 'badge-success' : 'badge-danger'}">${item.stockActual}</span>
      </td>
      <td class="text-center">
        <input type="number" min="1" max="${item.stockActual}" value="${item.cantidad}"
               style="width: 80px; text-align: center;"
               onchange="actualizarSalidaItem(${idx}, 'cantidad', parseFloat(this.value) || 1)">
      </td>
      <td class="text-right">
        <input type="number" min="0" step="0.01" value="${item.costoUnit.toFixed(2)}"
               style="width: 100px; text-align: right;"
               onchange="actualizarSalidaItem(${idx}, 'costoUnit', parseFloat(this.value) || 0)">
      </td>
      <td class="text-right" style="font-weight: 600;">S/ ${(item.cantidad * item.costoUnit).toFixed(2)}</td>
      <td class="text-center">
        <button class="btn btn-danger btn-sm" onclick="eliminarFilaSalida(${idx})">√ó</button>
      </td>
    </tr>
  `).join('');
  calcularTotalSalida();
}

function actualizarSalidaItem(idx, campo, valor) {
  productosSalida[idx][campo] = valor;
  calcularTotalSalida();
}

function eliminarFilaSalida(idx) {
  productosSalida.splice(idx, 1);
  renderFilasSalida();
}

function calcularTotalSalida() {
  const total = productosSalida.reduce((sum, item) => sum + (item.cantidad * item.costoUnit), 0);
  document.getElementById('salidaTotal').textContent = `S/ ${total.toFixed(2)}`;
}

function limpiarSalida() {
  productosSalida = [];
  document.getElementById('salidaNroDoc').value = '';
  document.getElementById('salidaDestino').value = '';
  document.getElementById('salidaFecha').value = today();
  renderFilasSalida();
  toast('Formulario limpiado');
}

function procesarSalida() {
  if (productosSalida.length === 0) {
    toast('Agregue al menos un producto', 'warning');
    return;
  }

  const nroDoc = document.getElementById('salidaNroDoc').value.trim();
  const fecha = document.getElementById('salidaFecha').value;
  const destino = document.getElementById('salidaDestino').value.trim();

  if (!nroDoc) {
    toast('Ingrese n√∫mero de documento', 'warning');
    return;
  }

  // Validar stock
  for (const item of productosSalida) {
    if (item.cantidad > item.stockActual) {
      toast(`Stock insuficiente para ${item.nombre}`, 'error');
      return;
    }
  }

  const productos = load(DB.PRODUCTOS);
  const movimientos = load(DB.MOVIMIENTOS);

  productosSalida.forEach(item => {
    if (item.productoId) {
      const prod = productos.find(p => p.id === item.productoId);
      if (prod) {
        prod.stock = Math.max(0, (prod.stock || 0) - item.cantidad);
      }
    }

    movimientos.push({
      id: genId('mov'),
      tipo: 'SALIDA',
      tipoMov: tipoSalidaActual,
      fecha: fecha,
      documento: nroDoc,
      productoId: item.productoId,
      codigo: item.codigo,
      producto: item.nombre,
      cantidad: item.cantidad,
      costoUnit: item.costoUnit,
      destino: destino,
      creado: now()
    });
  });

  save(DB.PRODUCTOS, productos);
  save(DB.MOVIMIENTOS, movimientos);

  limpiarSalida();
  toast('Salida procesada correctamente');
  renderInventario();
}

// ========== BUSCAR PRODUCTO ==========

function buscarProductoPorCodigo(codigo, idx, tipo) {
  if (!codigo || codigo.length < 2) return;

  const productos = load(DB.PRODUCTOS);
  const prod = productos.find(p => p.codigo?.toLowerCase() === codigo.toLowerCase());

  if (prod) {
    if (tipo === 'ingreso') {
      productosIngreso[idx].productoId = prod.id;
      productosIngreso[idx].nombre = prod.nombre;
      productosIngreso[idx].costoUnit = prod.precio || 0;
      renderFilasIngreso();
    } else {
      productosSalida[idx].productoId = prod.id;
      productosSalida[idx].nombre = prod.nombre;
      productosSalida[idx].stockActual = prod.stock || 0;
      productosSalida[idx].costoUnit = prod.precio || 0;
      renderFilasSalida();
    }
  }
}

function buscarProductoAlmacen(termino, tipo) {
  // Auto-completado b√°sico (puede expandirse)
}

function abrirModalBuscarProducto(contexto) {
  contextoModal = contexto;
  productoSeleccionadoModal = null;
  document.getElementById('buscarProdTermino').value = '';
  document.getElementById('buscarProdCategoria').value = '';
  filtrarProductosModal();
  document.getElementById('buscarProductoModal').showModal();
}

function filtrarProductosModal() {
  const termino = document.getElementById('buscarProdTermino').value.toLowerCase();
  const tipoBusq = document.getElementById('buscarProdTipo').value;
  const categoria = document.getElementById('buscarProdCategoria').value;

  let productos = load(DB.PRODUCTOS);

  if (categoria) {
    productos = productos.filter(p => p.categoria === categoria);
  }

  if (termino) {
    productos = productos.filter(p => {
      switch(tipoBusq) {
        case 'codigo': return p.codigo?.toLowerCase().includes(termino);
        case 'modelo': return p.modelo?.toLowerCase().includes(termino);
        case 'categoria': return p.categoria?.toLowerCase().includes(termino);
        case 'marca': return p.marca?.toLowerCase().includes(termino);
        default: return p.nombre?.toLowerCase().includes(termino);
      }
    });
  }

  const container = document.getElementById('prodResultsList');
  container.innerHTML = productos.slice(0, 50).map(p => `
    <div class="prod-result-item ${productoSeleccionadoModal === p.id ? 'selected' : ''}"
         onclick="seleccionarProductoLista('${p.id}')">
      <img src="${p.imagen || ''}" class="prod-img" onerror="this.style.display='none'">
      <div class="prod-info">
        <div class="prod-nombre">${p.nombre}</div>
        <div class="prod-codigo">${p.codigo || 'Sin c√≥digo'} | ${p.categoria || 'Sin categor√≠a'}</div>
      </div>
      <div class="prod-stock">Stock: ${p.stock || 0}</div>
    </div>
  `).join('') || '<p style="padding: 20px; text-align: center; color: #888;">No se encontraron productos</p>';
}

function seleccionarProductoLista(id) {
  productoSeleccionadoModal = id;
  filtrarProductosModal();
}

function seleccionarProductoModal() {
  if (!productoSeleccionadoModal) {
    toast('Seleccione un producto', 'warning');
    return;
  }

  const productos = load(DB.PRODUCTOS);
  const prod = productos.find(p => p.id === productoSeleccionadoModal);

  if (!prod) return;

  if (contextoModal === 'ingreso') {
    productosIngreso.push({
      id: genId('ing'),
      productoId: prod.id,
      codigo: prod.codigo || '',
      nombre: prod.nombre,
      cantidad: 1,
      costoUnit: prod.precio || 0
    });
    renderFilasIngreso();
  } else if (contextoModal === 'salida') {
    productosSalida.push({
      id: genId('sal'),
      productoId: prod.id,
      codigo: prod.codigo || '',
      nombre: prod.nombre,
      stockActual: prod.stock || 0,
      cantidad: 1,
      costoUnit: prod.precio || 0
    });
    renderFilasSalida();
  }

  cerrarModal('buscarProductoModal');
  toast(`${prod.nombre} agregado`);
}

// ========== GU√çAS DE REMISI√ìN ==========

function buscarGuias() {
  const termino = document.getElementById('buscarGuia').value.toLowerCase();
  const estado = document.getElementById('filtroEstadoGuia').value;
  const desde = document.getElementById('guiaDesde').value;
  const hasta = document.getElementById('guiaHasta').value;

  let guias = load(DB.GUIAS);

  if (termino) {
    guias = guias.filter(g => g.numero?.toLowerCase().includes(termino) ||
                              g.destinatario?.toLowerCase().includes(termino));
  }
  if (estado) {
    guias = guias.filter(g => g.estado === estado);
  }
  if (desde) {
    guias = guias.filter(g => g.fechaEmision >= desde);
  }
  if (hasta) {
    guias = guias.filter(g => g.fechaEmision <= hasta);
  }

  guias.sort((a, b) => new Date(b.fechaEmision) - new Date(a.fechaEmision));

  const body = document.getElementById('guiasBody');
  body.innerHTML = guias.map(g => {
    const estadoClass = g.estado?.toLowerCase() || 'pendiente';
    return `
      <tr>
        <td style="font-weight: 600;">${g.numero}</td>
        <td>${formatDate(g.fechaEmision)}</td>
        <td>${g.puntoLlegada || g.destinatario || '-'}</td>
        <td>${g.transportista || '-'}</td>
        <td class="text-center">${g.productos?.length || 0}</td>
        <td class="text-center"><span class="guia-estado ${estadoClass}">${g.estado || 'PENDIENTE'}</span></td>
        <td class="text-center">
          <button class="btn btn-info btn-sm" onclick="verGuia('${g.id}')" title="Ver">üëÅÔ∏è</button>
          <button class="btn btn-primary btn-sm" onclick="imprimirGuiaDirecto('${g.id}')" title="Imprimir">üñ®Ô∏è</button>
          ${g.estado !== 'ANULADA' ? '<button class="btn btn-danger btn-sm" onclick="anularGuia(\'' + g.id + '\')" title="Anular">‚ùå</button>' : ''}
        </td>
      </tr>
    `;
  }).join('') || '<tr><td colspan="7" style="text-align: center; padding: 30px; color: #888;">No hay gu√≠as registradas</td></tr>';

  document.getElementById('guiasCount').textContent = `Gu√≠as: ${guias.length}`;
}

function nuevaGuiaRemision() {
  guiaEditandoId = null;
  productosGuia = [];
  document.getElementById('guiaNro').value = generarNumeroGuia();
  document.getElementById('guiaFechaEmision').value = today();
  document.getElementById('guiaFechaTraslado').value = today();
  document.getElementById('guiaPuntoPartida').value = 'Centro √ìptico Sicuani - Sicuani, Cusco';
  document.getElementById('guiaPuntoLlegada').value = '';
  document.getElementById('guiaDestinatario').value = '';
  document.getElementById('guiaDestinatarioDoc').value = '';
  document.getElementById('guiaTransportista').value = '';
  document.getElementById('guiaTransportistaRuc').value = '';
  document.getElementById('guiaPlaca').value = '';
  document.getElementById('guiaMotivo').value = 'VENTA';
  renderFilasGuia();
  document.getElementById('nuevaGuiaModal').showModal();
}

function generarNumeroGuia() {
  const guias = load(DB.GUIAS);
  const num = guias.length + 1;
  return `GR-001-${String(num).padStart(6, '0')}`;
}

function agregarFilaGuia() {
  productosGuia.push({
    id: genId('gp'),
    codigo: '',
    descripcion: '',
    cantidad: 1,
    peso: 0.1
  });
  renderFilasGuia();
}

function renderFilasGuia() {
  const body = document.getElementById('guiaProductosBody');
  body.innerHTML = productosGuia.map((item, idx) => `
    <tr>
      <td><input type="text" value="${item.codigo}" onchange="productosGuia[${idx}].codigo = this.value"></td>
      <td><input type="text" value="${item.descripcion}" onchange="productosGuia[${idx}].descripcion = this.value"></td>
      <td class="text-center"><input type="number" min="1" value="${item.cantidad}" style="width: 80px;" onchange="productosGuia[${idx}].cantidad = parseInt(this.value) || 1"></td>
      <td class="text-center"><input type="number" min="0" step="0.01" value="${item.peso}" style="width: 80px;" onchange="productosGuia[${idx}].peso = parseFloat(this.value) || 0"></td>
      <td class="text-center"><button class="btn btn-danger btn-sm" onclick="productosGuia.splice(${idx}, 1); renderFilasGuia()">√ó</button></td>
    </tr>
  `).join('');
}

function guardarGuiaRemision() {
  const numero = document.getElementById('guiaNro').value.trim();
  if (!numero) {
    toast('Ingrese n√∫mero de gu√≠a', 'warning');
    return;
  }
  if (productosGuia.length === 0) {
    toast('Agregue al menos un producto', 'warning');
    return;
  }

  const guia = {
    id: guiaEditandoId || genId('guia'),
    numero: numero,
    fechaEmision: document.getElementById('guiaFechaEmision').value,
    fechaTraslado: document.getElementById('guiaFechaTraslado').value,
    puntoPartida: document.getElementById('guiaPuntoPartida').value,
    puntoLlegada: document.getElementById('guiaPuntoLlegada').value,
    destinatario: document.getElementById('guiaDestinatario').value,
    destinatarioDoc: document.getElementById('guiaDestinatarioDoc').value,
    transportista: document.getElementById('guiaTransportista').value,
    transportistaRuc: document.getElementById('guiaTransportistaRuc').value,
    placa: document.getElementById('guiaPlaca').value,
    motivo: document.getElementById('guiaMotivo').value,
    productos: [...productosGuia],
    estado: 'PENDIENTE',
    creado: now()
  };

  const guias = load(DB.GUIAS);
  const idx = guias.findIndex(g => g.id === guia.id);
  if (idx >= 0) {
    guias[idx] = guia;
  } else {
    guias.push(guia);
  }
  save(DB.GUIAS, guias);

  cerrarModal('nuevaGuiaModal');
  buscarGuias();
  toast('Gu√≠a guardada correctamente');
}

function verGuia(id) {
  const guias = load(DB.GUIAS);
  const guia = guias.find(g => g.id === id);
  if (!guia) return;

  const content = `
    <div style="font-family: Arial, sans-serif;">
      <div style="text-align: center; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 15px;">
        <h2 style="margin: 0;">GU√çA DE REMISI√ìN</h2>
        <p style="margin: 5px 0; font-size: 18px; font-weight: bold;">${guia.numero}</p>
      </div>

      <div style="display: flex; gap: 20px; margin-bottom: 15px;">
        <div style="flex: 1;">
          <p><strong>Fecha Emisi√≥n:</strong> ${formatDate(guia.fechaEmision)}</p>
          <p><strong>Fecha Traslado:</strong> ${formatDate(guia.fechaTraslado)}</p>
          <p><strong>Motivo:</strong> ${guia.motivo}</p>
        </div>
        <div style="flex: 1;">
          <p><strong>Estado:</strong> <span class="guia-estado ${guia.estado?.toLowerCase()}">${guia.estado}</span></p>
        </div>
      </div>

      <div style="display: flex; gap: 20px; margin-bottom: 15px; padding: 10px; background: #f5f5f5; border-radius: 8px;">
        <div style="flex: 1;">
          <h4 style="margin: 0 0 10px;">Punto Partida</h4>
          <p style="margin: 0;">${guia.puntoPartida || '-'}</p>
        </div>
        <div style="flex: 1;">
          <h4 style="margin: 0 0 10px;">Punto Llegada</h4>
          <p style="margin: 0;">${guia.puntoLlegada || '-'}</p>
        </div>
      </div>

      <div style="display: flex; gap: 20px; margin-bottom: 15px;">
        <div style="flex: 1;">
          <h4>Destinatario</h4>
          <p>${guia.destinatario || '-'}</p>
          <p>Doc: ${guia.destinatarioDoc || '-'}</p>
        </div>
        <div style="flex: 1;">
          <h4>Transportista</h4>
          <p>${guia.transportista || '-'}</p>
          <p>RUC: ${guia.transportistaRuc || '-'}</p>
          <p>Placa: ${guia.placa || '-'}</p>
        </div>
      </div>

      <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
        <thead>
          <tr style="background: #e5e5e5;">
            <th style="border: 1px solid #999; padding: 8px;">C√≥digo</th>
            <th style="border: 1px solid #999; padding: 8px;">Descripci√≥n</th>
            <th style="border: 1px solid #999; padding: 8px; text-align: center;">Cant.</th>
            <th style="border: 1px solid #999; padding: 8px; text-align: center;">Peso (Kg)</th>
          </tr>
        </thead>
        <tbody>
          ${guia.productos?.map(p => `
            <tr>
              <td style="border: 1px solid #999; padding: 8px;">${p.codigo}</td>
              <td style="border: 1px solid #999; padding: 8px;">${p.descripcion}</td>
              <td style="border: 1px solid #999; padding: 8px; text-align: center;">${p.cantidad}</td>
              <td style="border: 1px solid #999; padding: 8px; text-align: center;">${p.peso?.toFixed(2) || '0.00'}</td>
            </tr>
          `).join('') || '<tr><td colspan="4" style="text-align: center; padding: 15px;">Sin productos</td></tr>'}
        </tbody>
        <tfoot>
          <tr style="font-weight: bold;">
            <td colspan="2" style="border: 1px solid #999; padding: 8px; text-align: right;">TOTAL:</td>
            <td style="border: 1px solid #999; padding: 8px; text-align: center;">${guia.productos?.reduce((s, p) => s + (p.cantidad || 0), 0) || 0}</td>
            <td style="border: 1px solid #999; padding: 8px; text-align: center;">${guia.productos?.reduce((s, p) => s + (p.peso || 0), 0).toFixed(2) || '0.00'}</td>
          </tr>
        </tfoot>
      </table>
    </div>
  `;

  document.getElementById('verGuiaContenido').innerHTML = content;
  guiaEditandoId = id;
  document.getElementById('verGuiaModal').showModal();
}

function imprimirGuia() {
  const contenido = document.getElementById('verGuiaContenido').innerHTML;
  const printArea = document.getElementById('printArea');
  var estilosPrint = '@media print { body * { visibility: hidden; } #printArea, #printArea * { visibility: visible; } #printArea { position: absolute; left: 0; top: 0; width: 100%; } }';
  printArea.innerHTML = '<sty' + 'le>' + estilosPrint + '</sty' + 'le>' + contenido;
  window.print();
  printArea.innerHTML = '';
  cerrarModal('verGuiaModal');
}

function imprimirGuiaDirecto(id) {
  verGuia(id);
  setTimeout(() => imprimirGuia(), 300);
}

function anularGuia(id) {
  if (!confirm('¬øEst√° seguro de anular esta gu√≠a?')) return;

  const guias = load(DB.GUIAS);
  const idx = guias.findIndex(g => g.id === id);
  if (idx >= 0) {
    guias[idx].estado = 'ANULADA';
    save(DB.GUIAS, guias);
    buscarGuias();
    toast('Gu√≠a anulada');
  }
}

function exportarGuiasExcel() {
  const guias = load(DB.GUIAS);
  if (guias.length === 0) { toast('No hay gu√≠as para exportar', 'warning'); return; }

  const headers = ['N√∫mero', 'Fecha Emisi√≥n', 'Destinatario', 'Punto Llegada', 'Transportista', 'Estado', 'Items'];
  const rows = guias.map(g => [
    g.numero,
    g.fechaEmision,
    g.destinatario || '',
    g.puntoLlegada || '',
    g.transportista || '',
    g.estado,
    g.productos?.length || 0
  ]);
  const csv = generarCSV(headers, rows);
  descargarCSV(csv, 'guias_remision.csv');
  toast('Gu√≠as exportadas');
}

// ========== KARDEX ==========

function inicializarKardex() {
  const productos = load(DB.PRODUCTOS);
  const select = document.getElementById('kardexProducto');
  select.innerHTML = '<option value="">Seleccione producto...</option>' +
    productos.map(p => `<option value="${p.id}">${p.codigo || ''} - ${p.nombre}</option>`).join('');

  document.getElementById('kardexDesde').value = '';
  document.getElementById('kardexHasta').value = '';
}

function cargarKardex() {
  const productoId = document.getElementById('kardexProducto').value;
  const desde = document.getElementById('kardexDesde').value;
  const hasta = document.getElementById('kardexHasta').value;

  if (!productoId) {
    document.getElementById('kardexBody').innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 30px; color: #888;">Seleccione un producto</td></tr>';
    document.getElementById('kardexEntradas').textContent = '0';
    document.getElementById('kardexSalidas').textContent = '0';
    document.getElementById('kardexStock').textContent = '0';
    document.getElementById('kardexCount').textContent = 'Movimientos: 0';
    return;
  }

  let movimientos = load(DB.MOVIMIENTOS).filter(m => m.productoId === productoId);

  if (desde) movimientos = movimientos.filter(m => m.fecha >= desde);
  if (hasta) movimientos = movimientos.filter(m => m.fecha <= hasta);

  movimientos.sort((a, b) => new Date(a.fecha) - new Date(b.fecha));

  let saldo = 0;
  let totalEntradas = 0;
  let totalSalidas = 0;

  const rows = movimientos.map(m => {
    const entrada = m.tipo === 'INGRESO' ? m.cantidad : 0;
    const salida = m.tipo === 'SALIDA' ? m.cantidad : 0;
    saldo += entrada - salida;
    totalEntradas += entrada;
    totalSalidas += salida;

    const tipoLabel = m.tipoMov?.replace(/_/g, ' ') || m.tipo;

    return `
      <tr>
        <td>${formatDate(m.fecha)}</td>
        <td><span class="badge ${m.tipo === 'INGRESO' ? 'badge-success' : 'badge-danger'}">${m.tipo}</span></td>
        <td>${m.documento || '-'}</td>
        <td>${tipoLabel}</td>
        <td class="text-center" style="color: #16a34a; font-weight: 600;">${entrada || '-'}</td>
        <td class="text-center" style="color: #dc2626; font-weight: 600;">${salida || '-'}</td>
        <td class="text-center" style="font-weight: 700;">${saldo}</td>
      </tr>
    `;
  });

  document.getElementById('kardexBody').innerHTML = rows.join('') ||
    '<tr><td colspan="7" style="text-align: center; padding: 30px; color: #888;">Sin movimientos</td></tr>';

  document.getElementById('kardexEntradas').textContent = totalEntradas;
  document.getElementById('kardexSalidas').textContent = totalSalidas;

  const productos = load(DB.PRODUCTOS);
  const prod = productos.find(p => p.id === productoId);
  document.getElementById('kardexStock').textContent = prod?.stock || 0;

  document.getElementById('kardexCount').textContent = `Movimientos: ${movimientos.length}`;
}

function exportarKardexExcel() {
  const productoId = document.getElementById('kardexProducto').value;
  if (!productoId) { toast('Seleccione un producto', 'warning'); return; }

  const productos = load(DB.PRODUCTOS);
  const prod = productos.find(p => p.id === productoId);
  let movimientos = load(DB.MOVIMIENTOS).filter(m => m.productoId === productoId);
  movimientos.sort((a, b) => new Date(a.fecha) - new Date(b.fecha));

  let saldo = 0;
  const headers = ['Fecha', 'Tipo', 'Documento', 'Descripci√≥n', 'Entrada', 'Salida', 'Saldo'];
  const rows = movimientos.map(m => {
    const entrada = m.tipo === 'INGRESO' ? m.cantidad : 0;
    const salida = m.tipo === 'SALIDA' ? m.cantidad : 0;
    saldo += entrada - salida;
    return [m.fecha, m.tipo, m.documento || '', m.tipoMov || '', entrada, salida, saldo];
  });

  const csv = generarCSV(headers, rows);
  descargarCSV(csv, `kardex_${prod?.codigo || 'producto'}.csv`);
  toast('Kardex exportado');
}

// ========== CONSULTA DE STOCK ==========

function buscarStock() {
  const termino = document.getElementById('stockBuscar').value.toLowerCase();
  const categoria = document.getElementById('stockCategoria').value;
  const filtroStock = document.getElementById('stockFiltro').value;

  let productos = load(DB.PRODUCTOS);

  if (termino) {
    productos = productos.filter(p =>
      p.nombre?.toLowerCase().includes(termino) ||
      p.codigo?.toLowerCase().includes(termino) ||
      p.modelo?.toLowerCase().includes(termino)
    );
  }

  if (categoria) {
    productos = productos.filter(p => p.categoria === categoria);
  }

  if (filtroStock === 'BAJO') {
    productos = productos.filter(p => (p.stock || 0) > 0 && (p.stock || 0) <= 5);
  } else if (filtroStock === 'AGOTADO') {
    productos = productos.filter(p => (p.stock || 0) === 0);
  } else if (filtroStock === 'DISPONIBLE') {
    productos = productos.filter(p => (p.stock || 0) > 5);
  }

  const body = document.getElementById('stockBody');
  body.innerHTML = productos.map(p => {
    const stock = p.stock || 0;
    let estadoClass = 'badge-success';
    let estadoText = 'Disponible';
    if (stock === 0) { estadoClass = 'badge-danger'; estadoText = 'Agotado'; }
    else if (stock <= 5) { estadoClass = 'badge-warning'; estadoText = 'Stock Bajo'; }

    return `
      <tr>
        <td><img src="${p.imagen || ''}" style="width: 40px; height: 40px; border-radius: 6px; object-fit: cover;" onerror="this.style.display='none'"></td>
        <td style="font-weight: 600;">${p.codigo || '-'}</td>
        <td>${p.nombre}</td>
        <td><span class="badge badge-purple">${p.categoria || '-'}</span></td>
        <td class="text-right">S/ ${(p.precio || 0).toFixed(2)}</td>
        <td class="text-center" style="font-weight: 700; font-size: 16px;">${stock}</td>
        <td class="text-center"><span class="badge ${estadoClass}">${estadoText}</span></td>
      </tr>
    `;
  }).join('') || '<tr><td colspan="7" style="text-align: center; padding: 30px; color: #888;">No se encontraron productos</td></tr>';

  const todosProds = load(DB.PRODUCTOS);
  const agotados = todosProds.filter(p => (p.stock || 0) === 0).length;
  const bajos = todosProds.filter(p => (p.stock || 0) > 0 && (p.stock || 0) <= 5).length;

  document.getElementById('stockCount').textContent = `Productos: ${productos.length}`;
  document.getElementById('stockAgotados').textContent = agotados;
  document.getElementById('stockBajos').textContent = bajos;
}

function exportarStockExcel() {
  const productos = load(DB.PRODUCTOS);
  if (productos.length === 0) { toast('No hay productos', 'warning'); return; }

  const headers = ['C√≥digo', 'Producto', 'Categor√≠a', 'Precio', 'Stock', 'Estado'];
  const rows = productos.map(p => {
    const stock = p.stock || 0;
    let estado = 'Disponible';
    if (stock === 0) estado = 'Agotado';
    else if (stock <= 5) estado = 'Stock Bajo';
    return [p.codigo || '', p.nombre, p.categoria || '', (p.precio || 0).toFixed(2), stock, estado];
  });

  const csv = generarCSV(headers, rows);
  descargarCSV(csv, 'consulta_stock.csv');
  toast('Stock exportado');
}

// ==================== M√ìDULO DE IMPORTACI√ìN MASIVA ====================

// Variables globales para importaci√≥n
let tipoImportacionActual = 'productos';
let datosImportacionTemp = [];

// Seleccionar tipo de importaci√≥n
function seleccionarTipoImportacion(tipo) {
  tipoImportacionActual = tipo;

  // Actualizar UI
  document.querySelectorAll('.import-type-card').forEach(card => {
    if (card.dataset.tipo === tipo) {
      card.style.background = 'linear-gradient(135deg, #dbeafe 0%, white 100%)';
      card.style.borderColor = '#3b82f6';
      card.classList.add('active');
    } else {
      card.style.background = 'white';
      card.style.borderColor = '#e5e7eb';
      card.classList.remove('active');
    }
  });

  // Resetear estado
  reiniciarImportacion();
}

// Configurar drag & drop
document.addEventListener('DOMContentLoaded', function() {
  const dropZone = document.getElementById('dropZone');
  if (!dropZone) return;

  dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.style.borderColor = '#3b82f6';
    dropZone.style.background = 'linear-gradient(135deg, #dbeafe 0%, #ffffff 100%)';
  });

  dropZone.addEventListener('dragleave', (e) => {
    e.preventDefault();
    dropZone.style.borderColor = '#d1d5db';
    dropZone.style.background = 'linear-gradient(135deg, #f9fafb 0%, #ffffff 100%)';
  });

  dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.style.borderColor = '#d1d5db';
    dropZone.style.background = 'linear-gradient(135deg, #f9fafb 0%, #ffffff 100%)';

    const file = e.dataTransfer.files[0];
    if (file) {
      procesarArchivoImportacion(file);
    }
  });
});

// Procesar archivo CSV/Excel
function procesarArchivoImportacion(file) {
  if (!file) return;

  const extension = file.name.split('.').pop().toLowerCase();

  if (extension === 'csv') {
    leerArchivoCSV(file);
  } else if (extension === 'xlsx' || extension === 'xls') {
    toast('Soporte de Excel pr√≥ximamente. Por favor usa CSV.', 'warning');
    return;
  } else {
    toast('Formato no soportado. Usa CSV o Excel.', 'error');
    return;
  }
}

// Leer archivo CSV
function leerArchivoCSV(file) {
  const reader = new FileReader();

  reader.onload = function(e) {
    const contenido = e.target.result;
    parsearCSV(contenido);
  };

  reader.onerror = function() {
    toast('Error al leer el archivo', 'error');
  };

  reader.readAsText(file, 'UTF-8');
}

// Parsear CSV y validar datos
function parsearCSV(contenido) {
  // Remover BOM si existe
  if (contenido.charCodeAt(0) === 0xFEFF) {
    contenido = contenido.slice(1);
  }

  const lineas = contenido.split('\n').filter(l => l.trim());
  if (lineas.length < 2) {
    toast('El archivo est√° vac√≠o o no tiene datos', 'error');
    return;
  }

  // Parsear headers (primera l√≠nea)
  const headers = lineas[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));

  // Parsear datos
  const datos = [];
  for (let i = 1; i < lineas.length; i++) {
    const valores = lineas[i].split(',').map(v => v.trim().replace(/^"|"$/g, ''));
    const registro = {};

    headers.forEach((header, idx) => {
      registro[header] = valores[idx] || '';
    });

    datos.push(registro);
  }

  if (datos.length === 0) {
    toast('No se encontraron datos v√°lidos', 'error');
    return;
  }

  if (datos.length > 1000) {
    toast('M√°ximo 1000 registros por archivo', 'error');
    return;
  }

  // Validar estructura seg√∫n tipo
  const errores = validarDatosImportacion(datos, headers);

  datosImportacionTemp = datos;
  mostrarVistaPrevia(datos, headers, errores);
}

// Validar datos seg√∫n tipo de importaci√≥n
function validarDatosImportacion(datos, headers) {
  const errores = [];

  if (tipoImportacionActual === 'productos') {
    // Campos requeridos para productos
    const requeridos = ['codigo', 'nombre', 'categoria', 'precio'];
    const faltantes = requeridos.filter(r => !headers.includes(r));

    if (faltantes.length > 0) {
      errores.push(`Faltan columnas requeridas: ${faltantes.join(', ')}`);
    }

    // Validar datos individuales
    datos.forEach((registro, idx) => {
      if (!registro.codigo || registro.codigo.trim() === '') {
        errores.push(`Fila ${idx + 2}: c√≥digo vac√≠o`);
      }
      if (!registro.nombre || registro.nombre.trim() === '') {
        errores.push(`Fila ${idx + 2}: nombre vac√≠o`);
      }
      if (!registro.precio || isNaN(parseFloat(registro.precio))) {
        errores.push(`Fila ${idx + 2}: precio inv√°lido`);
      }
    });

  } else if (tipoImportacionActual === 'clientes') {
    // Campos requeridos para clientes
    const requeridos = ['dni', 'nombre', 'apellidos'];
    const faltantes = requeridos.filter(r => !headers.includes(r));

    if (faltantes.length > 0) {
      errores.push(`Faltan columnas requeridas: ${faltantes.join(', ')}`);
    }

    // Validar datos individuales
    datos.forEach((registro, idx) => {
      if (!registro.dni || registro.dni.trim() === '') {
        errores.push(`Fila ${idx + 2}: DNI vac√≠o`);
      }
      if (!registro.nombre || registro.nombre.trim() === '') {
        errores.push(`Fila ${idx + 2}: nombre vac√≠o`);
      }
    });
  }

  return errores;
}

// Mostrar vista previa de datos
function mostrarVistaPrevia(datos, headers, errores) {
  document.getElementById('vistaPreviewImportacion').style.display = 'block';
  document.getElementById('previewCount').textContent = `${datos.length} registros`;

  // Generar tabla de preview
  const thead = document.getElementById('previewTableHead');
  thead.innerHTML = '<tr>' + headers.map(h =>
    `<th style="padding: 12px; border-bottom: 2px solid #e5e7eb; text-align: left; font-weight: 700; color: #1f2937;">${h}</th>`
  ).join('') + '</tr>';

  const tbody = document.getElementById('previewTableBody');
  tbody.innerHTML = datos.slice(0, 50).map(registro =>
    '<tr>' + headers.map(h =>
      `<td style="padding: 10px; border-bottom: 1px solid #f3f4f6; font-size: 13px;">${registro[h] || '-'}</td>`
    ).join('') + '</tr>'
  ).join('');

  if (datos.length > 50) {
    tbody.innerHTML += `<tr><td colspan="${headers.length}" style="padding: 15px; text-align: center; color: #6b7280; font-style: italic;">
      Mostrando 50 de ${datos.length} registros...
    </td></tr>`;
  }

  // Mostrar errores si existen
  const divErrores = document.getElementById('erroresValidacion');
  const listaErrores = document.getElementById('listaErroresValidacion');

  if (errores.length > 0) {
    divErrores.style.display = 'block';
    listaErrores.innerHTML = errores.slice(0, 20).map(e => `<li>${e}</li>`).join('');
    if (errores.length > 20) {
      listaErrores.innerHTML += `<li style="font-weight: 600;">... y ${errores.length - 20} errores m√°s</li>`;
    }
  } else {
    divErrores.style.display = 'none';
  }
}

// Confirmar importaci√≥n
function confirmarImportacion() {
  if (datosImportacionTemp.length === 0) {
    toast('No hay datos para importar', 'error');
    return;
  }

  // Validar nuevamente
  const headers = Object.keys(datosImportacionTemp[0]);
  const errores = validarDatosImportacion(datosImportacionTemp, headers);

  if (errores.length > 0) {
    toast(`Hay ${errores.length} errores. Corr√≠gelos antes de continuar.`, 'error');
    return;
  }

  // Ocultar preview y mostrar progreso
  document.getElementById('vistaPreviewImportacion').style.display = 'none';
  document.getElementById('progresoImportacion').style.display = 'block';

  // Procesar importaci√≥n
  ejecutarImportacion();
}

// Ejecutar importaci√≥n con progreso
function ejecutarImportacion() {
  const total = datosImportacionTemp.length;
  let procesados = 0;
  let exitosos = 0;
  let errores = 0;

  const intervalo = setInterval(() => {
    const lote = datosImportacionTemp.slice(procesados, procesados + 10);

    lote.forEach(registro => {
      try {
        if (tipoImportacionActual === 'productos') {
          importarProducto(registro);
          exitosos++;
        } else if (tipoImportacionActual === 'clientes') {
          importarCliente(registro);
          exitosos++;
        }
      } catch (error) {
        errores++;
        console.error('Error importando registro:', error);
      }

      procesados++;
    });

    // Actualizar progreso
    const porcentaje = (procesados / total) * 100;
    document.getElementById('barraProgreso').style.width = porcentaje + '%';
    document.getElementById('textoProgreso').textContent = `${procesados} de ${total} registros procesados`;

    // Terminar
    if (procesados >= total) {
      clearInterval(intervalo);

      setTimeout(() => {
        document.getElementById('progresoImportacion').style.display = 'none';
        document.getElementById('resultadoImportacion').style.display = 'block';
        document.getElementById('resultadoExitosos').textContent = exitosos;
        document.getElementById('resultadoErrores').textContent = errores;

        toast(`Importaci√≥n completada: ${exitosos} exitosos, ${errores} errores`, 'success');

        // Actualizar vistas
        if (tipoImportacionActual === 'productos') {
          if (typeof cargarProductos === 'function') cargarProductos();
          if (typeof buscarStock === 'function') buscarStock();
        } else if (tipoImportacionActual === 'clientes') {
          if (typeof renderClientes === 'function') renderClientes();
        }
      }, 500);
    }
  }, 100);
}

// Importar producto individual
function importarProducto(registro) {
  const productos = load(DB.PRODUCTOS) || [];

  // Verificar si ya existe el c√≥digo
  const existente = productos.find(p => p.codigo === registro.codigo);

  const producto = {
    id: existente ? existente.id : genId('PROD'),
    codigo: registro.codigo,
    nombre: registro.nombre,
    categoria: registro.categoria || 'OTROS',
    precio: parseFloat(registro.precio) || 0,
    stock: parseInt(registro.stock) || 0,
    stockMinimo: parseInt(registro.stockMinimo) || 5,
    descripcion: registro.descripcion || '',
    marca: registro.marca || '',
    modelo: registro.modelo || '',
    color: registro.color || '',
    material: registro.material || '',
    fechaCreacion: existente ? existente.fechaCreacion : new Date().toISOString(),
    fechaModificacion: new Date().toISOString()
  };

  if (existente) {
    // Actualizar producto existente
    const index = productos.findIndex(p => p.id === existente.id);
    productos[index] = { ...productos[index], ...producto };
  } else {
    // Agregar nuevo producto
    productos.push(producto);
  }

  save(DB.PRODUCTOS, productos);
}

// Importar cliente individual
function importarCliente(registro) {
  const clientes = load(DB.CLIENTES) || [];

  // Verificar si ya existe el DNI
  const existente = clientes.find(c => c.dni === registro.dni);

  const cliente = {
    id: existente ? existente.id : genId('CLI'),
    dni: registro.dni,
    nombre: registro.nombre,
    apellidos: registro.apellidos,
    telefono: registro.telefono || '',
    email: registro.email || '',
    direccion: registro.direccion || '',
    fechaNacimiento: registro.fechaNacimiento || '',
    tipo: registro.tipo || 'NATURAL',
    fechaRegistro: existente ? existente.fechaRegistro : new Date().toISOString()
  };

  if (existente) {
    // Actualizar cliente existente
    const index = clientes.findIndex(c => c.id === existente.id);
    clientes[index] = { ...clientes[index], ...cliente };
  } else {
    // Agregar nuevo cliente
    clientes.push(cliente);
  }

  save(DB.CLIENTES, clientes);
}

// Cancelar importaci√≥n
function cancelarImportacion() {
  datosImportacionTemp = [];
  reiniciarImportacion();
}

// Reiniciar importaci√≥n
function reiniciarImportacion() {
  document.getElementById('vistaPreviewImportacion').style.display = 'none';
  document.getElementById('progresoImportacion').style.display = 'none';
  document.getElementById('resultadoImportacion').style.display = 'none';
  document.getElementById('importFileInput').value = '';
  datosImportacionTemp = [];
}

// Descargar plantillas CSV
function descargarPlantillaImportacion(tipo) {
  let headers, ejemplos;

  if (tipo === 'productos') {
    headers = ['codigo', 'nombre', 'categoria', 'precio', 'stock', 'stockMinimo', 'descripcion', 'marca', 'modelo', 'color', 'material'];
    ejemplos = [
      ['MONT001', 'Montura Ray-Ban Aviator', 'MONTURAS', '350.00', '10', '5', 'Montura cl√°sica aviador', 'Ray-Ban', 'RB3025', 'Dorado', 'Metal'],
      ['LUNA001', 'Luna Transitions Gray', 'LUNAS', '180.00', '25', '10', 'Luna con tecnolog√≠a Transitions', 'Essilor', 'Transitions', 'Gris', 'Org√°nico'],
      ['ACC001', 'Estuche Premium', 'ACCESORIOS', '25.00', '50', '20', 'Estuche r√≠gido premium', 'Gen√©rico', '', 'Negro', 'Pl√°stico']
    ];
  } else if (tipo === 'clientes') {
    headers = ['dni', 'nombre', 'apellidos', 'telefono', 'email', 'direccion', 'fechaNacimiento', 'tipo'];
    ejemplos = [
      ['12345678', 'Juan', 'P√©rez Garc√≠a', '987654321', 'juan@email.com', 'Av. Principal 123', '1990-05-15', 'NATURAL'],
      ['87654321', 'Mar√≠a', 'L√≥pez Rodr√≠guez', '987123456', 'maria@email.com', 'Jr. Comercio 456', '1985-08-20', 'NATURAL'],
      ['20123456789', '√ìptica Vision SAC', '', '984567890', 'ventas@optica.com', 'Av. Grau 789', '', 'JURIDICA']
    ];
  }

  const csv = generarCSV(headers, ejemplos);
  descargarCSV(csv, `plantilla_${tipo}.csv`);
  toast(`Plantilla de ${tipo} descargada`, 'success');
}

// ==================== M√ìDULO DE AN√ÅLISIS PREDICTIVO ====================

// Variable movida al inicio del script (l√≠nea 9701)
// Nota: el valor inicial se cambia de 'mes' a 30 d√≠as aqu√≠
periodoAnalisisActual = 30;

// Cambiar per√≠odo de an√°lisis
function cambiarPeriodoAnalisis(dias) {
  periodoAnalisisActual = dias;

  // Actualizar UI
  document.querySelectorAll('.periodo-analisis-btn').forEach(btn => {
    if (parseInt(btn.dataset.periodo) === dias) {
      btn.classList.add('active');
      btn.style.background = '#3b82f6';
      btn.style.color = 'white';
    } else {
      btn.classList.remove('active');
      btn.style.background = '';
      btn.style.color = '';
    }
  });

  // Recargar an√°lisis
  cargarAnalisisPredictivo();
}

// Cargar an√°lisis predictivo completo
function cargarAnalisisPredictivo() {
  cargarMetricasTendencia();
  cargarGraficoProyeccion();
  cargarTendenciasProductos();
  cargarInsightsInteligentes();
  cargarEstacionalidad();
  cargarDemandaPredictiva();
}

// Cargar m√©tricas de tendencia
function cargarMetricasTendencia() {
  const ventas = load(DB.VENTAS) || [];
  const hoy = new Date();
  const fechaInicio = new Date(hoy);
  fechaInicio.setDate(fechaInicio.getDate() - periodoAnalisisActual);

  // Filtrar ventas del per√≠odo
  const ventasPeriodo = ventas.filter(v => {
    const fechaVenta = new Date(v.fecha);
    return fechaVenta >= fechaInicio && fechaVenta <= hoy;
  });

  // Calcular per√≠odo anterior para comparaci√≥n
  const fechaInicioAnterior = new Date(fechaInicio);
  fechaInicioAnterior.setDate(fechaInicioAnterior.getDate() - periodoAnalisisActual);

  const ventasPeriodoAnterior = ventas.filter(v => {
    const fechaVenta = new Date(v.fecha);
    return fechaVenta >= fechaInicioAnterior && fechaVenta < fechaInicio;
  });

  // Calcular m√©tricas
  const totalVentas = ventasPeriodo.reduce((sum, v) => sum + (v.total || 0), 0);
  const totalVentasAnterior = ventasPeriodoAnterior.reduce((sum, v) => sum + (v.total || 0), 0);
  const crecimientoVentas = totalVentasAnterior > 0
    ? ((totalVentas - totalVentasAnterior) / totalVentasAnterior) * 100
    : 0;

  const promedioVentaDiaria = totalVentas / periodoAnalisisActual;
  const numTransacciones = ventasPeriodo.length;
  const ticketPromedio = numTransacciones > 0 ? totalVentas / numTransacciones : 0;

  // Calcular productos m√°s vendidos
  const productosVendidos = {};
  ventasPeriodo.forEach(venta => {
    if (venta.items) {
      venta.items.forEach(item => {
        if (!productosVendidos[item.productoId]) {
          productosVendidos[item.productoId] = 0;
        }
        productosVendidos[item.productoId] += item.cantidad || 0;
      });
    }
  });
  const numProductosVendidos = Object.keys(productosVendidos).length;

  // Proyecci√≥n para el pr√≥ximo per√≠odo
  const proyeccionVentas = totalVentas * (1 + (crecimientoVentas / 100));

  const metricas = [
    {
      titulo: 'Crecimiento',
      valor: `${crecimientoVentas >= 0 ? '+' : ''}${crecimientoVentas.toFixed(1)}%`,
      icono: crecimientoVentas >= 0 ? 'üìà' : 'üìâ',
      color: crecimientoVentas >= 0 ? '#10b981' : '#ef4444',
      colorFondo: crecimientoVentas >= 0 ? '#d1fae5' : '#fee2e2',
      subtitulo: `vs per√≠odo anterior`
    },
    {
      titulo: 'Venta Diaria Promedio',
      valor: `S/ ${promedioVentaDiaria.toFixed(2)}`,
      icono: 'üí∞',
      color: '#3b82f6',
      colorFondo: '#dbeafe',
      subtitulo: `√öltimos ${periodoAnalisisActual} d√≠as`
    },
    {
      titulo: 'Ticket Promedio',
      valor: `S/ ${ticketPromedio.toFixed(2)}`,
      icono: 'üé´',
      color: '#8b5cf6',
      colorFondo: '#ede9fe',
      subtitulo: `${numTransacciones} transacciones`
    },
    {
      titulo: 'Proyecci√≥n',
      valor: `S/ ${proyeccionVentas.toFixed(2)}`,
      icono: 'üîÆ',
      color: '#f59e0b',
      colorFondo: '#fef3c7',
      subtitulo: `Pr√≥ximos ${periodoAnalisisActual} d√≠as`
    }
  ];

  const metricasDiv = document.getElementById('metricasTendencia');
  metricasDiv.innerHTML = metricas.map((m, index) => `
    <div style="
      background: linear-gradient(135deg, white 0%, ${m.colorFondo} 100%);
      border: 2px solid ${m.color};
      border-radius: 12px;
      padding: 20px;
      animation: fadeInUp 0.6s ease-out ${index * 0.1}s both;
      transition: all 0.3s ease;
    " onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 10px 20px rgba(0,0,0,0.1)';" onmouseout="this.style.transform=''; this.style.boxShadow='';">
      <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
        <span style="font-size: 36px;">${m.icono}</span>
        <span style="background: ${m.color}; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 700;">TENDENCIA</span>
      </div>
      <div style="font-size: 28px; font-weight: 900; color: ${m.color}; margin-bottom: 5px;">${m.valor}</div>
      <div style="font-weight: 600; color: #1f2937; margin-bottom: 5px;">${m.titulo}</div>
      <div style="font-size: 12px; color: #6b7280;">${m.subtitulo}</div>
    </div>
  `).join('');
}

// Cargar gr√°fico de proyecci√≥n
function cargarGraficoProyeccion() {
  const ventas = load(DB.VENTAS) || [];
  const hoy = new Date();

  // Obtener datos de los √∫ltimos 30 d√≠as
  const datos = [];
  for (let i = 29; i >= 0; i--) {
    const fecha = new Date(hoy);
    fecha.setDate(fecha.getDate() - i);
    const fechaStr = fecha.toISOString().split('T')[0];

    const ventasDia = ventas.filter(v => v.fecha.startsWith(fechaStr));
    const total = ventasDia.reduce((sum, v) => sum + (v.total || 0), 0);

    datos.push({ fecha: fechaStr, total: total, tipo: 'real' });
  }

  // Calcular tendencia usando regresi√≥n lineal simple
  const n = datos.length;
  let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0;

  datos.forEach((d, i) => {
    sumX += i;
    sumY += d.total;
    sumXY += i * d.total;
    sumX2 += i * i;
  });

  const pendiente = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
  const intercepto = (sumY - pendiente * sumX) / n;

  // Generar proyecci√≥n para los pr√≥ximos 7 d√≠as
  for (let i = 1; i <= 7; i++) {
    const fecha = new Date(hoy);
    fecha.setDate(fecha.getDate() + i);
    const fechaStr = fecha.toISOString().split('T')[0];

    const valorProyectado = Math.max(0, intercepto + pendiente * (n + i - 1));
    datos.push({ fecha: fechaStr, total: valorProyectado, tipo: 'proyeccion' });
  }

  // Encontrar valor m√°ximo para escala
  const maxValor = Math.max(...datos.map(d => d.total));

  // Renderizar gr√°fico
  const graficoDiv = document.getElementById('graficoProyeccion');
  graficoDiv.innerHTML = `
    <div style="display: flex; height: 100%; align-items: flex-end; justify-content: space-between; gap: 2px; position: relative;">
      ${datos.map((d, i) => {
        const altura = maxValor > 0 ? (d.total / maxValor) * 100 : 0;
        const esProyeccion = d.tipo === 'proyeccion';
        const color = esProyeccion ? '#10b981' : '#3b82f6';
        const fecha = new Date(d.fecha);
        const dia = fecha.getDate();

        return `
          <div style="
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
          ">
            <div style="
              width: 100%;
              height: ${altura}%;
              background: ${color};
              border-radius: 4px 4px 0 0;
              ${esProyeccion ? 'opacity: 0.7; border: 2px dashed ' + color + ';' : ''}
              transition: all 0.3s ease;
              cursor: pointer;
              position: relative;
            "
            onmouseover="this.style.opacity='1'; this.style.transform='scaleY(1.05)';"
            onmouseout="this.style.opacity='${esProyeccion ? '0.7' : '1'}'; this.style.transform='';"
            title="S/ ${d.total.toFixed(2)}">
              ${altura > 15 ? `<div style="position: absolute; top: -20px; left: 50%; transform: translateX(-50%); font-size: 10px; font-weight: 700; color: ${color}; white-space: nowrap;">S/ ${d.total.toFixed(0)}</div>` : ''}
            </div>
            <div style="font-size: 10px; color: #6b7280; font-weight: 600;">${dia}</div>
          </div>
        `;
      }).join('')}
    </div>
    <div style="text-align: center; margin-top: 15px; padding-top: 10px; border-top: 1px solid #e5e7eb; font-size: 12px; color: #6b7280;">
      √öltimos 30 d√≠as + Proyecci√≥n 7 d√≠as
    </div>
  `;
}

// Cargar tendencias de productos
function cargarTendenciasProductos() {
  const ventas = load(DB.VENTAS) || [];
  const productos = load(DB.PRODUCTOS) || [];
  const hoy = new Date();

  // Dividir per√≠odo en dos mitades
  const fechaInicio = new Date(hoy);
  fechaInicio.setDate(fechaInicio.getDate() - periodoAnalisisActual);

  const fechaMitad = new Date(fechaInicio);
  fechaMitad.setDate(fechaMitad.getDate() + Math.floor(periodoAnalisisActual / 2));

  // Contar ventas por producto en cada mitad
  const ventasPrimeraMitad = {};
  const ventasSegundaMitad = {};

  ventas.forEach(venta => {
    const fechaVenta = new Date(venta.fecha);

    if (venta.items) {
      venta.items.forEach(item => {
        if (fechaVenta >= fechaInicio && fechaVenta < fechaMitad) {
          ventasPrimeraMitad[item.productoId] = (ventasPrimeraMitad[item.productoId] || 0) + (item.cantidad || 0);
        } else if (fechaVenta >= fechaMitad && fechaVenta <= hoy) {
          ventasSegundaMitad[item.productoId] = (ventasSegundaMitad[item.productoId] || 0) + (item.cantidad || 0);
        }
      });
    }
  });

  // Calcular tendencias
  const tendencias = [];
  const todosProductos = new Set([...Object.keys(ventasPrimeraMitad), ...Object.keys(ventasSegundaMitad)]);

  todosProductos.forEach(prodId => {
    const ventasAntes = ventasPrimeraMitad[prodId] || 0;
    const ventasDespues = ventasSegundaMitad[prodId] || 0;

    if (ventasAntes > 0 || ventasDespues > 0) {
      const cambio = ventasAntes > 0 ? ((ventasDespues - ventasAntes) / ventasAntes) * 100 : (ventasDespues > 0 ? 100 : 0);
      const producto = productos.find(p => p.id === prodId);

      if (producto) {
        tendencias.push({
          producto: producto,
          cambio: cambio,
          ventasAntes: ventasAntes,
          ventasDespues: ventasDespues
        });
      }
    }
  });

  // Ordenar y separar en alza y baja
  tendencias.sort((a, b) => b.cambio - a.cambio);
  const tendenciasAlza = tendencias.filter(t => t.cambio > 0).slice(0, 5);
  const tendenciasBaja = tendencias.filter(t => t.cambio < 0).slice(-5).reverse();

  // Renderizar productos en alza
  const divAlza = document.getElementById('productosTendenciaAlza');
  if (tendenciasAlza.length > 0) {
    divAlza.innerHTML = tendenciasAlza.map(t => `
      <div style="padding: 12px; background: #f0fdf4; border-left: 4px solid #10b981; border-radius: 6px; margin-bottom: 10px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
          <span style="font-weight: 600; color: #1f2937; font-size: 14px;">${t.producto.nombre}</span>
          <span style="background: #10b981; color: white; padding: 3px 10px; border-radius: 12px; font-size: 11px; font-weight: 700;">+${t.cambio.toFixed(0)}%</span>
        </div>
        <div style="font-size: 12px; color: #6b7280;">
          ${t.ventasAntes} ‚Üí ${t.ventasDespues} unidades vendidas
        </div>
      </div>
    `).join('');
  } else {
    divAlza.innerHTML = '<div style="text-align: center; padding: 30px; color: #9ca3af;">No hay datos suficientes</div>';
  }

  // Renderizar productos en declive
  const divBaja = document.getElementById('productosTendenciaBaja');
  if (tendenciasBaja.length > 0) {
    divBaja.innerHTML = tendenciasBaja.map(t => `
      <div style="padding: 12px; background: #fef2f2; border-left: 4px solid #ef4444; border-radius: 6px; margin-bottom: 10px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
          <span style="font-weight: 600; color: #1f2937; font-size: 14px;">${t.producto.nombre}</span>
          <span style="background: #ef4444; color: white; padding: 3px 10px; border-radius: 12px; font-size: 11px; font-weight: 700;">${t.cambio.toFixed(0)}%</span>
        </div>
        <div style="font-size: 12px; color: #6b7280;">
          ${t.ventasAntes} ‚Üí ${t.ventasDespues} unidades vendidas
        </div>
      </div>
    `).join('');
  } else {
    divBaja.innerHTML = '<div style="text-align: center; padding: 30px; color: #9ca3af;">No hay datos suficientes</div>';
  }
}

// Cargar insights inteligentes
function cargarInsightsInteligentes() {
  const ventas = load(DB.VENTAS) || [];
  const productos = load(DB.PRODUCTOS) || [];
  const insights = [];

  // An√°lisis de stock cr√≠tico
  const productosBajoStock = productos.filter(p => (p.stock || 0) <= (p.stockMinimo || 5) && (p.stock || 0) > 0);
  const productosAgotados = productos.filter(p => (p.stock || 0) === 0);

  if (productosAgotados.length > 0) {
    insights.push({
      tipo: 'critico',
      icono: 'üö®',
      titulo: 'Stock Agotado Cr√≠tico',
      mensaje: `Hay ${productosAgotados.length} productos sin stock. Considera reabastecimiento inmediato.`,
      color: '#ef4444'
    });
  }

  if (productosBajoStock.length > 0) {
    insights.push({
      tipo: 'advertencia',
      icono: '‚ö†Ô∏è',
      titulo: 'Alerta de Stock Bajo',
      mensaje: `${productosBajoStock.length} productos est√°n cerca del stock m√≠nimo.`,
      color: '#f59e0b'
    });
  }

  // An√°lisis de ventas
  const hoy = new Date();
  const fechaInicio = new Date(hoy);
  fechaInicio.setDate(fechaInicio.getDate() - 7);

  const ventasUltimaSemana = ventas.filter(v => new Date(v.fecha) >= fechaInicio);
  const totalVentasSemana = ventasUltimaSemana.reduce((sum, v) => sum + (v.total || 0), 0);
  const promediodiario = totalVentasSemana / 7;

  if (ventasUltimaSemana.length > 0) {
    insights.push({
      tipo: 'exito',
      icono: 'üí°',
      titulo: 'Rendimiento Semanal',
      mensaje: `Promedio de S/ ${promediodiario.toFixed(2)} por d√≠a en la √∫ltima semana con ${ventasUltimaSemana.length} transacciones.`,
      color: '#10b981'
    });
  }

  // Recomendaci√≥n de mejor d√≠a de venta
  const ventasPorDia = {};
  ventas.forEach(v => {
    const fecha = new Date(v.fecha);
    const dia = fecha.getDay(); // 0=Domingo, 1=Lunes, etc.
    ventasPorDia[dia] = (ventasPorDia[dia] || 0) + (v.total || 0);
  });

  const diasSemana = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];
  let mejorDia = 0;
  let maxVentas = 0;
  Object.keys(ventasPorDia).forEach(dia => {
    if (ventasPorDia[dia] > maxVentas) {
      maxVentas = ventasPorDia[dia];
      mejorDia = parseInt(dia);
    }
  });

  if (maxVentas > 0) {
    insights.push({
      tipo: 'info',
      icono: 'üìÖ',
      titulo: 'Mejor D√≠a de Ventas',
      mensaje: `Los ${diasSemana[mejorDia]}s son tu mejor d√≠a de ventas hist√≥ricamente.`,
      color: '#3b82f6'
    });
  }

  // Renderizar insights
  const divInsights = document.getElementById('insightsInteligentes');
  if (insights.length > 0) {
    divInsights.innerHTML = insights.map(insight => `
      <div style="display: flex; align-items: flex-start; gap: 12px; padding: 15px; background: white; border-left: 4px solid ${insight.color}; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
        <div style="font-size: 28px;">${insight.icono}</div>
        <div style="flex: 1;">
          <div style="font-weight: 700; color: #1f2937; margin-bottom: 5px;">${insight.titulo}</div>
          <div style="font-size: 13px; color: #6b7280; line-height: 1.5;">${insight.mensaje}</div>
        </div>
      </div>
    `).join('');
  } else {
    divInsights.innerHTML = '<div style="text-align: center; padding: 20px; color: #9ca3af;">No hay insights disponibles</div>';
  }
}

// Cargar estacionalidad
function cargarEstacionalidad() {
  const ventas = load(DB.VENTAS) || [];
  const ventasPorMes = {};

  // Agrupar ventas por mes
  ventas.forEach(v => {
    const fecha = new Date(v.fecha);
    const mes = fecha.getMonth(); // 0-11
    ventasPorMes[mes] = (ventasPorMes[mes] || 0) + (v.total || 0);
  });

  const meses = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
  const datos = meses.map((nombre, index) => ({
    mes: nombre,
    total: ventasPorMes[index] || 0
  }));

  const maxValor = Math.max(...datos.map(d => d.total), 1);

  // Renderizar gr√°fico
  const graficoDiv = document.getElementById('graficoEstacionalidad');
  graficoDiv.innerHTML = `
    <div style="display: flex; height: 100%; align-items: flex-end; justify-content: space-between; gap: 8px;">
      ${datos.map(d => {
        const altura = (d.total / maxValor) * 100;
        return `
          <div style="flex: 1; display: flex; flex-direction: column; align-items: center; gap: 8px;">
            <div style="
              width: 100%;
              height: ${altura}%;
              background: linear-gradient(180deg, #3b82f6 0%, #2563eb 100%);
              border-radius: 6px 6px 0 0;
              transition: all 0.3s ease;
              cursor: pointer;
              position: relative;
            "
            onmouseover="this.style.transform='scaleY(1.1)'; this.style.opacity='0.8';"
            onmouseout="this.style.transform=''; this.style.opacity='1';"
            title="S/ ${d.total.toFixed(2)}">
              ${altura > 20 ? `<div style="position: absolute; top: -22px; left: 50%; transform: translateX(-50%); font-size: 11px; font-weight: 700; color: #3b82f6; white-space: nowrap;">S/ ${d.total.toFixed(0)}</div>` : ''}
            </div>
            <div style="font-size: 12px; color: #6b7280; font-weight: 600;">${d.mes}</div>
          </div>
        `;
      }).join('')}
    </div>
  `;
}

// Cargar predicci√≥n de demanda
function cargarDemandaPredictiva() {
  const ventas = load(DB.VENTAS) || [];
  const productos = load(DB.PRODUCTOS) || [];
  const hoy = new Date();
  const fechaInicio = new Date(hoy);
  fechaInicio.setDate(fechaInicio.getDate() - 30);

  // Calcular demanda hist√≥rica por producto
  const demandaPorProducto = {};

  ventas.forEach(venta => {
    const fechaVenta = new Date(venta.fecha);
    if (fechaVenta >= fechaInicio && venta.items) {
      venta.items.forEach(item => {
        if (!demandaPorProducto[item.productoId]) {
          demandaPorProducto[item.productoId] = [];
        }
        demandaPorProducto[item.productoId].push({
          fecha: venta.fecha,
          cantidad: item.cantidad || 0
        });
      });
    }
  });

  // Calcular predicci√≥n para pr√≥ximos 7 d√≠as
  const predicciones = [];

  Object.keys(demandaPorProducto).forEach(prodId => {
    const producto = productos.find(p => p.id === prodId);
    if (producto) {
      const ventas = demandaPorProducto[prodId];
      const totalVendido = ventas.reduce((sum, v) => sum + v.cantidad, 0);
      const promedioDiario = totalVendido / 30;
      const demandaProyectada = Math.ceil(promedioDiario * 7);

      predicciones.push({
        producto: producto,
        stockActual: producto.stock || 0,
        demandaProyectada: demandaProyectada,
        diferencia: (producto.stock || 0) - demandaProyectada
      });
    }
  });

  // Ordenar por mayor demanda proyectada
  predicciones.sort((a, b) => b.demandaProyectada - a.demandaProyectada);

  // Renderizar tabla
  const tablaDiv = document.getElementById('tablaDemandaPredictiva');
  if (predicciones.length > 0) {
    tablaDiv.innerHTML = `
      <div style="max-height: 400px; overflow: auto; border: 1px solid #e5e7eb; border-radius: 8px;">
        <table style="width: 100%; border-collapse: collapse;">
          <thead style="position: sticky; top: 0; background: #f9fafb; z-index: 10;">
            <tr>
              <th style="padding: 12px; text-align: left; font-weight: 700; border-bottom: 2px solid #e5e7eb;">Producto</th>
              <th style="padding: 12px; text-align: center; font-weight: 700; border-bottom: 2px solid #e5e7eb;">Stock Actual</th>
              <th style="padding: 12px; text-align: center; font-weight: 700; border-bottom: 2px solid #e5e7eb;">Demanda Proyectada</th>
              <th style="padding: 12px; text-align: center; font-weight: 700; border-bottom: 2px solid #e5e7eb;">Estado</th>
            </tr>
          </thead>
          <tbody>
            ${predicciones.slice(0, 20).map(p => {
              let estadoHtml = '';
              if (p.diferencia < 0) {
                estadoHtml = `<span style="background: #fee2e2; color: #991b1b; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">‚ö†Ô∏è Insuficiente</span>`;
              } else if (p.diferencia < p.demandaProyectada * 0.3) {
                estadoHtml = `<span style="background: #fef3c7; color: #92400e; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">‚ö° Justo</span>`;
              } else {
                estadoHtml = `<span style="background: #d1fae5; color: #065f46; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">‚úÖ Suficiente</span>`;
              }

              return `
                <tr style="border-bottom: 1px solid #f3f4f6;">
                  <td style="padding: 12px; font-weight: 600; color: #1f2937;">${p.producto.nombre}</td>
                  <td style="padding: 12px; text-align: center; font-weight: 600;">${p.stockActual}</td>
                  <td style="padding: 12px; text-align: center; font-weight: 600; color: #3b82f6;">${p.demandaProyectada}</td>
                  <td style="padding: 12px; text-align: center;">${estadoHtml}</td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      </div>
    `;
  } else {
    tablaDiv.innerHTML = '<div style="text-align: center; padding: 40px; color: #9ca3af;">No hay datos suficientes para predicci√≥n</div>';
  }
}

// ==================== M√ìDULO DE REPORTES ====================

// Funci√≥n auxiliar para abrir ventana de impresi√≥n (evita problemas de parsing HTML)
function abrirVentanaImpresion(contenido, titulo) {
  var ventana = window.open('', '_blank');
  var estilos = 'body { font-family: Arial, sans-serif; padding: 20px; }' +
    '.reporte-header { text-align: center; margin-bottom: 20px; }' +
    '.reporte-header h2 { color: #6b21a8; margin: 0; }' +
    '.reporte-header h3 { margin: 5px 0; }' +
    '.reporte-table { width: 100%; border-collapse: collapse; margin: 20px 0; }' +
    '.reporte-table th, .reporte-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }' +
    '.reporte-table th { background: #6b21a8; color: white; }' +
    '.reporte-table tfoot td { background: #f3e8ff; font-weight: bold; }' +
    '.text-right { text-align: right; }' +
    '.text-center { text-align: center; }' +
    '.badge { padding: 2px 8px; border-radius: 4px; font-size: 12px; }' +
    '.badge-success { background: #22c55e; color: white; }' +
    '.badge-warning { background: #f59e0b; color: white; }' +
    '.reporte-footer { text-align: center; margin-top: 20px; padding-top: 10px; border-top: 1px solid #ddd; }';

  var html = '<html><head><title>' + titulo + '</title><style>' + estilos + '</style></head><body>' + contenido + '</body></html>';
  ventana.document.write(html);
  ventana.document.close();
  ventana.print();
}

// Navegaci√≥n de tabs de Reportes
function mostrarTabReportes(tabId, btn) {
  document.querySelectorAll('.reportes-tab-content').forEach(t => {
    t.classList.remove('active');
    t.style.display = 'none';
  });
  document.querySelectorAll('.reportes-tab-btn').forEach(b => b.classList.remove('active'));

  const tab = document.getElementById(tabId);
  if (tab) {
    tab.classList.add('active');
    tab.style.display = 'block';
  }
  if (btn) btn.classList.add('active');

  // Cargar an√°lisis predictivo si se abre ese tab
  if (tabId === 'tabAnalisisPredictivo') {
    if (typeof cargarAnalisisPredictivo === 'function') {
      cargarAnalisisPredictivo();
    }
  }
}

// Sub-tabs de Ventas
function mostrarSubRepVentas(tipo) {
  document.querySelectorAll('.sub-rep-content').forEach(c => c.classList.remove('active'));
  document.querySelectorAll('.sub-rep-btn').forEach(b => b.classList.remove('active'));

  document.getElementById('subRep' + tipo.charAt(0).toUpperCase() + tipo.slice(1)).classList.add('active');
  event.target.classList.add('active');
}

// Inicializar fechas de reportes
function initReportesFechas() {
  const hoy = new Date().toISOString().split('T')[0];
  const hace30 = new Date(Date.now() - 30*24*60*60*1000).toISOString().split('T')[0];

  // Fechas Ventas
  const repVentasDesde = document.getElementById('repVentasDesde');
  const repVentasHasta = document.getElementById('repVentasHasta');
  if (repVentasDesde) repVentasDesde.value = hace30;
  if (repVentasHasta) repVentasHasta.value = hoy;

  // Fechas Especialistas
  const repEspDesde = document.getElementById('repEspDesde');
  const repEspHasta = document.getElementById('repEspHasta');
  if (repEspDesde) repEspDesde.value = hace30;
  if (repEspHasta) repEspHasta.value = hoy;

  // Fechas Productos
  const repProdDesde = document.getElementById('repProdDesde');
  const repProdHasta = document.getElementById('repProdHasta');
  if (repProdDesde) repProdDesde.value = hace30;
  if (repProdHasta) repProdHasta.value = hoy;

  // Fechas Clientes
  const repClientesDesde = document.getElementById('repClientesDesde');
  const repClientesHasta = document.getElementById('repClientesHasta');
  if (repClientesDesde) repClientesDesde.value = hace30;
  if (repClientesHasta) repClientesHasta.value = hoy;
}

// ========== REPORTE DE VENTAS ==========
function generarReporteVentas() {
  const desde = document.getElementById('repVentasDesde').value;
  const hasta = document.getElementById('repVentasHasta').value;
  const estado = document.getElementById('repVentasEstado').value;
  const pago = document.getElementById('repVentasEstadoPago').value;
  const entrega = document.getElementById('repVentasEntrega').value;
  const tipoRadio = document.querySelector('input[name="tipoRepVentas"]:checked');
  const tipo = tipoRadio ? tipoRadio.value : 'general';

  let ventas = load(DB.VENTAS);
  const clientes = load(DB.CLIENTES);

  // Filtrar por fecha
  if (desde) ventas = ventas.filter(v => v.fecha >= desde);
  if (hasta) ventas = ventas.filter(v => v.fecha <= hasta);

  // Filtrar por estado
  if (estado) ventas = ventas.filter(v => v.estado === estado);

  // Filtrar por tipo de pago
  if (pago) ventas = ventas.filter(v => v.tipoPago === pago);

  // Filtrar por entrega
  if (entrega) ventas = ventas.filter(v => v.entregado === (entrega === 'si'));

  if (ventas.length === 0) {
    toast('No hay ventas con los filtros seleccionados', 'warning');
    return;
  }

  // Generar contenido del reporte
  let totalGeneral = 0;
  let html = `
    <div class="reporte-header">
      <h2>üè™ CENTRO √ìPTICO SICUANI</h2>
      <h3>REPORTE DE VENTAS</h3>
      <p>Per√≠odo: ${desde || 'Inicio'} al ${hasta || 'Hoy'}</p>
      <p>Generado: ${new Date().toLocaleString()}</p>
    </div>
    <table class="reporte-table">
      <thead>
        <tr>
          <th>N¬∞</th>
          <th>Fecha</th>
          <th>Cliente</th>
          <th>DNI</th>
          ${tipo === 'detallada' ? '<th>Productos</th>' : ''}
          <th>Total</th>
          <th>Estado</th>
          <th>Pago</th>
        </tr>
      </thead>
      <tbody>
  `;

  ventas.forEach((v, i) => {
    const cliente = clientes.find(c => c.id === v.clienteId) || {};
    totalGeneral += v.total || 0;

    let productosHtml = '';
    if (tipo === 'detallada' && v.productos) {
      const listaProds = v.productos.map(function(p) { return p.nombre + ' x' + p.cantidad; }).join('<br>');
      productosHtml = '<td>' + listaProds + '</td>';
    }

    html += `
      <tr>
        <td>${i + 1}</td>
        <td>${v.fecha}</td>
        <td>${cliente.nombre || 'Cliente General'}</td>
        <td>${cliente.dni || '-'}</td>
        ${tipo === 'detallada' ? productosHtml : ''}
        <td class="text-right">S/ ${(v.total || 0).toFixed(2)}</td>
        <td><span class="badge ${v.estado === 'Pagado' ? 'badge-success' : 'badge-warning'}">${v.estado || 'Pendiente'}</span></td>
        <td>${v.tipoPago || '-'}</td>
      </tr>
    `;
  });

  html += `
      </tbody>
      <tfoot>
        <tr>
          <td colspan="${tipo === 'detallada' ? 5 : 4}" class="text-right"><strong>TOTAL GENERAL:</strong></td>
          <td class="text-right"><strong>S/ ${totalGeneral.toFixed(2)}</strong></td>
          <td colspan="2"></td>
        </tr>
      </tfoot>
    </table>
    <div class="reporte-footer">
      <p>Total de ventas: ${ventas.length} | Monto total: S/ ${totalGeneral.toFixed(2)}</p>
    </div>
  `;

  document.getElementById('previewRepVentas').innerHTML = html;
  document.getElementById('previewRepVentas').style.display = 'block';
}

function cerrarReporteVentas() {
  document.getElementById('previewRepVentas').style.display = 'none';
}

function imprimirReporteVentas() {
  const contenido = document.getElementById('previewRepVentas').innerHTML;
  abrirVentanaImpresion(contenido, 'Reporte de Ventas');
}

function exportarReporteVentasExcel() {
  const desde = document.getElementById('repVentasDesde').value;
  const hasta = document.getElementById('repVentasHasta').value;

  let ventas = load(DB.VENTAS);
  const clientes = load(DB.CLIENTES);

  if (desde) ventas = ventas.filter(v => v.fecha >= desde);
  if (hasta) ventas = ventas.filter(v => v.fecha <= hasta);

  if (ventas.length === 0) {
    toast('No hay datos para exportar', 'warning');
    return;
  }

  const headers = ['N¬∞', 'Fecha', 'Cliente', 'DNI', 'Total', 'Estado', 'Tipo Pago'];
  const rows = ventas.map((v, i) => {
    const cliente = clientes.find(c => c.id === v.clienteId) || {};
    return [i + 1, v.fecha, cliente.nombre || 'Cliente General', cliente.dni || '', (v.total || 0).toFixed(2), v.estado || 'Pendiente', v.tipoPago || ''];
  });

  const csv = generarCSV(headers, rows);
  descargarCSV(csv, `reporte_ventas_${desde}_${hasta}.csv`);
  toast('‚úÖ Reporte exportado a Excel');
}

// Establecer per√≠odos r√°pidos para reportes de ventas
function establecerPeriodoVentas(periodo) {
  const hoy = new Date();
  let desde, hasta;

  switch(periodo) {
    case 'hoy':
      desde = hasta = hoy.toISOString().split('T')[0];
      break;
    case 'semana':
      const inicioSemana = new Date(hoy);
      inicioSemana.setDate(hoy.getDate() - hoy.getDay());
      desde = inicioSemana.toISOString().split('T')[0];
      hasta = hoy.toISOString().split('T')[0];
      break;
    case 'mes':
      desde = new Date(hoy.getFullYear(), hoy.getMonth(), 1).toISOString().split('T')[0];
      hasta = hoy.toISOString().split('T')[0];
      break;
    case 'anio':
      desde = new Date(hoy.getFullYear(), 0, 1).toISOString().split('T')[0];
      hasta = hoy.toISOString().split('T')[0];
      break;
    case 'todo':
      document.getElementById('repVentasFiltrarFecha').checked = false;
      document.getElementById('repVentasDesde').value = '';
      document.getElementById('repVentasHasta').value = '';
      toast('üìä Mostrando todas las ventas', 'info');
      return;
  }

  document.getElementById('repVentasFiltrarFecha').checked = true;
  document.getElementById('repVentasDesde').value = desde;
  document.getElementById('repVentasHasta').value = hasta;

  const periodos = {
    'hoy': 'Hoy',
    'semana': 'Esta Semana',
    'mes': 'Este Mes',
    'anio': 'Este A√±o'
  };
  toast(`üìÖ Per√≠odo: ${periodos[periodo]}`, 'info');
}

// Exportar reporte de ventas a PDF
function exportarReporteVentasPDF() {
  const desde = document.getElementById('repVentasDesde').value;
  const hasta = document.getElementById('repVentasHasta').value;
  const estado = document.getElementById('repVentasEstado').value;
  const pago = document.getElementById('repVentasEstadoPago').value;

  let ventas = load(DB.VENTAS);
  const clientes = load(DB.CLIENTES);

  // Aplicar filtros
  if (desde) ventas = ventas.filter(v => v.fecha >= desde);
  if (hasta) ventas = ventas.filter(v => v.fecha <= hasta);
  if (estado) ventas = ventas.filter(v => v.estado === estado);
  if (pago) ventas = ventas.filter(v => v.tipoPago === pago);

  if (ventas.length === 0) {
    toast('No hay datos para exportar', 'warning');
    return;
  }

  let totalGeneral = 0;
  let html = '<html><head><title>Reporte de Ventas</title>';
  html += '<style>';
  html += 'body { font-family: Arial, sans-serif; padding: 20px; }';
  html += 'h2, h3 { text-align: center; color: #1e40af; margin: 5px 0; }';
  html += 'table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 11px; }';
  html += 'th { background: #3b82f6; color: white; padding: 8px; border: 1px solid #1e40af; }';
  html += 'td { padding: 6px; border: 1px solid #ddd; }';
  html += 'tr:nth-child(even) { background: #f3f4f6; }';
  html += '.text-right { text-align: right; }';
  html += 'tfoot { font-weight: bold; background: #dbeafe; }';
  html += '.header-info { text-align: center; font-size: 12px; margin: 10px 0; }';
  html += '</style></head><body>';

  html += '<h2>üè™ CENTRO √ìPTICO SICUANI</h2>';
  html += '<h3>REPORTE DE VENTAS</h3>';
  html += '<div class="header-info">';
  html += '<p><strong>Per√≠odo:</strong> ' + (desde || 'Inicio') + ' al ' + (hasta || 'Hoy') + '</p>';
  html += '<p><strong>Generado:</strong> ' + new Date().toLocaleString() + '</p>';
  html += '</div>';

  html += '<table><thead><tr>';
  html += '<th>N¬∞</th><th>Fecha</th><th>Cliente</th><th>DNI</th><th>Total</th><th>Estado</th><th>Pago</th>';
  html += '</tr></thead><tbody>';

  ventas.forEach((v, i) => {
    const cliente = clientes.find(c => c.id === v.clienteId) || {};
    totalGeneral += v.total || 0;
    html += '<tr>';
    html += '<td>' + (i + 1) + '</td>';
    html += '<td>' + v.fecha + '</td>';
    html += '<td>' + (cliente.nombre || 'Cliente General') + '</td>';
    html += '<td>' + (cliente.dni || '-') + '</td>';
    html += '<td class="text-right">S/ ' + (v.total || 0).toFixed(2) + '</td>';
    html += '<td>' + (v.estado || 'Pendiente') + '</td>';
    html += '<td>' + (v.tipoPago || '-') + '</td>';
    html += '</tr>';
  });

  html += '</tbody><tfoot><tr>';
  html += '<td colspan="4" class="text-right"><strong>TOTAL GENERAL:</strong></td>';
  html += '<td class="text-right"><strong>S/ ' + totalGeneral.toFixed(2) + '</strong></td>';
  html += '<td colspan="2"></td>';
  html += '</tr></tfoot></table>';

  html += '<div style="margin-top: 20px; text-align: center; font-size: 11px;">';
  html += '<p><strong>Total de ventas:</strong> ' + ventas.length + ' | <strong>Monto total:</strong> S/ ' + totalGeneral.toFixed(2) + '</p>';
  html += '</div>';

  html += '<script>window.print(); window.close();<\/script>';
  html += '</body></html>';

  const printWindow = window.open('', '_blank');
  printWindow.document.write(html);
  printWindow.document.close();

  toast('‚úÖ Generando PDF para imprimir', 'success');
}

// ========== REPORTE DE ESPECIALISTAS ==========
function generarReporteEspecialistas() {
  const desde = document.getElementById('repEspDesde').value;
  const hasta = document.getElementById('repEspHasta').value;
  const vendedor = document.getElementById('repEspVendedor').value;
  const especialista = document.getElementById('repEspEspecialista').value;

  let ventas = load(DB.VENTAS);
  const clientes = load(DB.CLIENTES);

  // Filtrar por fecha
  if (desde) ventas = ventas.filter(v => v.fecha >= desde);
  if (hasta) ventas = ventas.filter(v => v.fecha <= hasta);

  // Filtrar por vendedor
  if (vendedor) ventas = ventas.filter(v => v.vendedor === vendedor);

  // Filtrar por especialista
  if (especialista) ventas = ventas.filter(v => v.especialista === especialista);

  if (ventas.length === 0) {
    toast('No hay ventas con los filtros seleccionados', 'warning');
    return;
  }

  // Agrupar por especialista
  const porEspecialista = {};
  ventas.forEach(v => {
    const esp = v.especialista || 'Sin Especialista';
    if (!porEspecialista[esp]) {
      porEspecialista[esp] = { ventas: [], total: 0 };
    }
    porEspecialista[esp].ventas.push(v);
    porEspecialista[esp].total += v.total || 0;
  });

  let totalGeneral = 0;
  let html = `
    <div class="reporte-header">
      <h2>üè™ CENTRO √ìPTICO SICUANI</h2>
      <h3>REPORTE DE VENTAS POR ESPECIALISTA</h3>
      <p>Per√≠odo: ${desde || 'Inicio'} al ${hasta || 'Hoy'}</p>
      <p>Generado: ${new Date().toLocaleString()}</p>
    </div>
  `;

  for (const esp in porEspecialista) {
    const data = porEspecialista[esp];
    totalGeneral += data.total;

    html += `
      <div style="margin: 20px 0; padding: 15px; background: #f3e8ff; border-radius: 8px;">
        <h4 style="margin: 0 0 10px 0; color: #6b21a8;">üë®‚Äç‚öïÔ∏è ${esp}</h4>
        <p>Ventas: ${data.ventas.length} | Total: S/ ${data.total.toFixed(2)}</p>
      </div>
      <table class="reporte-table">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Cliente</th>
            <th>Vendedor</th>
            <th>Total</th>
            <th>Estado</th>
          </tr>
        </thead>
        <tbody>
    `;

    data.ventas.forEach(v => {
      const cliente = clientes.find(c => c.id === v.clienteId) || {};
      html += `
        <tr>
          <td>${v.fecha}</td>
          <td>${cliente.nombre || 'Cliente General'}</td>
          <td>${v.vendedor || '-'}</td>
          <td class="text-right">S/ ${(v.total || 0).toFixed(2)}</td>
          <td>${v.estado || 'Pendiente'}</td>
        </tr>
      `;
    });

    html += `</tbody></table>`;
  }

  html += `
    <div class="reporte-footer">
      <p><strong>RESUMEN TOTAL:</strong> ${ventas.length} ventas | S/ ${totalGeneral.toFixed(2)}</p>
    </div>
  `;

  document.getElementById('previewRepEspecialistas').innerHTML = html;
  document.getElementById('previewRepEspecialistas').style.display = 'block';
}

function cerrarReporteEspecialistas() {
  document.getElementById('previewRepEspecialistas').style.display = 'none';
}

function imprimirReporteEspecialistas() {
  const contenido = document.getElementById('previewRepEspecialistas').innerHTML;
  abrirVentanaImpresion(contenido, 'Reporte por Especialistas');
}

// ========== REPORTE DE PRODUCTOS VENDIDOS ==========
function generarReporteProductos() {
  const desde = document.getElementById('repProdDesde').value;
  const hasta = document.getElementById('repProdHasta').value;
  const familia = document.getElementById('repProdFamilia').checked ? document.getElementById('repProdFamiliaVal').value : '';
  const linea = document.getElementById('repProdLinea').checked ? document.getElementById('repProdLineaVal').value : '';
  const categoria = document.getElementById('repProdCategoria').checked ? document.getElementById('repProdCategoriaVal').value : '';
  const marca = document.getElementById('repProdMarca').checked ? document.getElementById('repProdMarcaVal').value : '';
  const orden = document.getElementById('repProdOrden').value;

  let ventas = load(DB.VENTAS);
  const productos = load(DB.PRODUCTOS);

  // Filtrar por fecha
  if (desde) ventas = ventas.filter(v => v.fecha >= desde);
  if (hasta) ventas = ventas.filter(v => v.fecha <= hasta);

  // Extraer todos los productos vendidos
  const productosVendidos = {};

  ventas.forEach(v => {
    if (v.productos && Array.isArray(v.productos)) {
      v.productos.forEach(p => {
        const prod = productos.find(pr => pr.id === p.id) || p;

        // Aplicar filtros
        if (familia && prod.familia !== familia) return;
        if (linea && prod.linea !== linea) return;
        if (categoria && prod.categoria !== categoria) return;
        if (marca && prod.marca !== marca) return;

        const key = p.id || p.nombre;
        if (!productosVendidos[key]) {
          productosVendidos[key] = {
            nombre: p.nombre || prod.nombre,
            codigo: prod.codigo || '',
            familia: prod.familia || '',
            linea: prod.linea || '',
            categoria: prod.categoria || '',
            marca: prod.marca || '',
            cantidad: 0,
            total: 0
          };
        }
        productosVendidos[key].cantidad += p.cantidad || 1;
        productosVendidos[key].total += (p.precio || 0) * (p.cantidad || 1);
      });
    }
  });

  let lista = Object.values(productosVendidos);

  if (lista.length === 0) {
    toast('No hay productos con los filtros seleccionados', 'warning');
    return;
  }

  // Ordenar
  switch (orden) {
    case 'cantidad_desc':
      lista.sort((a, b) => b.cantidad - a.cantidad);
      break;
    case 'cantidad_asc':
      lista.sort((a, b) => a.cantidad - b.cantidad);
      break;
    case 'monto_desc':
      lista.sort((a, b) => b.total - a.total);
      break;
    case 'monto_asc':
      lista.sort((a, b) => a.total - b.total);
      break;
    default:
      lista.sort((a, b) => a.nombre.localeCompare(b.nombre));
  }

  let totalCantidad = 0;
  let totalMonto = 0;

  let html = `
    <div class="reporte-header">
      <h2>üè™ CENTRO √ìPTICO SICUANI</h2>
      <h3>REPORTE DE PRODUCTOS VENDIDOS</h3>
      <p>Per√≠odo: ${desde || 'Inicio'} al ${hasta || 'Hoy'}</p>
      <p>Generado: ${new Date().toLocaleString()}</p>
    </div>
    <table class="reporte-table">
      <thead>
        <tr>
          <th>N¬∞</th>
          <th>C√≥digo</th>
          <th>Producto</th>
          <th>Familia</th>
          <th>L√≠nea</th>
          <th>Categor√≠a</th>
          <th>Marca</th>
          <th>Cantidad</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody>
  `;

  lista.forEach((p, i) => {
    totalCantidad += p.cantidad;
    totalMonto += p.total;

    html += `
      <tr>
        <td>${i + 1}</td>
        <td>${p.codigo}</td>
        <td>${p.nombre}</td>
        <td>${p.familia}</td>
        <td>${p.linea}</td>
        <td>${p.categoria}</td>
        <td>${p.marca}</td>
        <td class="text-center">${p.cantidad}</td>
        <td class="text-right">S/ ${p.total.toFixed(2)}</td>
      </tr>
    `;
  });

  html += `
      </tbody>
      <tfoot>
        <tr>
          <td colspan="7" class="text-right"><strong>TOTALES:</strong></td>
          <td class="text-center"><strong>${totalCantidad}</strong></td>
          <td class="text-right"><strong>S/ ${totalMonto.toFixed(2)}</strong></td>
        </tr>
      </tfoot>
    </table>
    <div class="reporte-footer">
      <p>Productos √∫nicos: ${lista.length} | Total unidades: ${totalCantidad} | Monto total: S/ ${totalMonto.toFixed(2)}</p>
    </div>
  `;

  document.getElementById('previewRepProductos').innerHTML = html;
  document.getElementById('previewRepProductos').style.display = 'block';
}

function cerrarReporteProductos() {
  document.getElementById('previewRepProductos').style.display = 'none';
}

function imprimirReporteProductos() {
  const contenido = document.getElementById('previewRepProductos').innerHTML;
  abrirVentanaImpresion(contenido, 'Reporte de Productos Vendidos');
}

function exportarReporteProductosExcel() {
  const desde = document.getElementById('repProdDesde').value;
  const hasta = document.getElementById('repProdHasta').value;

  let ventas = load(DB.VENTAS);
  const productos = load(DB.PRODUCTOS);

  if (desde) ventas = ventas.filter(v => v.fecha >= desde);
  if (hasta) ventas = ventas.filter(v => v.fecha <= hasta);

  const productosVendidos = {};

  ventas.forEach(v => {
    if (v.productos && Array.isArray(v.productos)) {
      v.productos.forEach(p => {
        const prod = productos.find(pr => pr.id === p.id) || p;
        const key = p.id || p.nombre;
        if (!productosVendidos[key]) {
          productosVendidos[key] = {
            nombre: p.nombre || prod.nombre,
            codigo: prod.codigo || '',
            familia: prod.familia || '',
            categoria: prod.categoria || '',
            cantidad: 0,
            total: 0
          };
        }
        productosVendidos[key].cantidad += p.cantidad || 1;
        productosVendidos[key].total += (p.precio || 0) * (p.cantidad || 1);
      });
    }
  });

  const lista = Object.values(productosVendidos);

  if (lista.length === 0) {
    toast('No hay datos para exportar', 'warning');
    return;
  }

  const headers = ['C√≥digo', 'Producto', 'Familia', 'Categor√≠a', 'Cantidad', 'Total'];
  const rows = lista.map(p => [p.codigo, p.nombre, p.familia, p.categoria, p.cantidad, p.total.toFixed(2)]);

  const csv = generarCSV(headers, rows);
  descargarCSV(csv, `productos_vendidos_${desde}_${hasta}.csv`);
  toast('Reporte exportado');
}

// ========== REPORTE DE CLIENTES ==========
function generarReporteClientes() {
  const desde = document.getElementById('repClientesDesde').value;
  const hasta = document.getElementById('repClientesHasta').value;
  const sexo = document.getElementById('repClientesSexo').checked ? document.getElementById('repClientesSexoVal').value : '';
  const estadoCivil = document.getElementById('repClientesEstadoCivil').checked ? document.getElementById('repClientesEstadoCivilVal').value : '';
  const departamento = document.getElementById('repClientesDpto').checked ? document.getElementById('repClientesDptoVal').value : '';
  const provincia = document.getElementById('repClientesProv').checked ? document.getElementById('repClientesProvVal').value : '';
  const distrito = document.getElementById('repClientesDist').checked ? document.getElementById('repClientesDistVal').value : '';

  let clientes = load(DB.CLIENTES);

  // Filtrar por fecha de registro
  if (desde) clientes = clientes.filter(c => c.fechaRegistro >= desde);
  if (hasta) clientes = clientes.filter(c => c.fechaRegistro <= hasta);

  // Filtrar por sexo
  if (sexo) clientes = clientes.filter(c => c.sexo === sexo);

  // Filtrar por estado civil
  if (estadoCivil) clientes = clientes.filter(c => c.estadoCivil === estadoCivil);

  // Filtrar por ubicaci√≥n
  if (departamento) clientes = clientes.filter(c => c.departamento === departamento);
  if (provincia) clientes = clientes.filter(c => c.provincia === provincia);
  if (distrito) clientes = clientes.filter(c => c.distrito === distrito);

  if (clientes.length === 0) {
    toast('No hay clientes con los filtros seleccionados', 'warning');
    return;
  }

  // Estad√≠sticas
  const porSexo = {};
  const porEdad = { '0-17': 0, '18-30': 0, '31-50': 0, '51-70': 0, '71+': 0 };

  clientes.forEach(c => {
    // Por sexo
    const s = c.sexo || 'No especificado';
    porSexo[s] = (porSexo[s] || 0) + 1;

    // Por edad
    if (c.fechaNacimiento) {
      const edad = calcularEdad(c.fechaNacimiento);
      if (edad < 18) porEdad['0-17']++;
      else if (edad <= 30) porEdad['18-30']++;
      else if (edad <= 50) porEdad['31-50']++;
      else if (edad <= 70) porEdad['51-70']++;
      else porEdad['71+']++;
    }
  });

  let html = `
    <div class="reporte-header">
      <h2>üè™ CENTRO √ìPTICO SICUANI</h2>
      <h3>REPORTE DE CLIENTES SUSCRITOS</h3>
      <p>Per√≠odo: ${desde || 'Inicio'} al ${hasta || 'Hoy'}</p>
      <p>Generado: ${new Date().toLocaleString()}</p>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
      <div style="background: #f3e8ff; padding: 15px; border-radius: 8px;">
        <h4 style="margin: 0 0 10px 0; color: #6b21a8;">üìä Por Sexo</h4>
        ${generarEstadisticasSexo(porSexo, clientes.length)}
      </div>
      <div style="background: #f3e8ff; padding: 15px; border-radius: 8px;">
        <h4 style="margin: 0 0 10px 0; color: #6b21a8;">üìä Por Rango de Edad</h4>
        ${generarEstadisticasEdad(porEdad, clientes.length)}
      </div>
    </div>

    <table class="reporte-table">
      <thead>
        <tr>
          <th>N¬∞</th>
          <th>DNI</th>
          <th>Nombre</th>
          <th>Tel√©fono</th>
          <th>Email</th>
          <th>Sexo</th>
          <th>Edad</th>
          <th>Ubicaci√≥n</th>
          <th>Registro</th>
        </tr>
      </thead>
      <tbody>
  `;

  clientes.forEach((c, i) => {
    const edad = c.fechaNacimiento ? calcularEdad(c.fechaNacimiento) : '-';
    const ubicacion = [c.distrito, c.provincia].filter(Boolean).join(', ') || '-';

    html += `
      <tr>
        <td>${i + 1}</td>
        <td>${c.dni || '-'}</td>
        <td>${c.nombre}</td>
        <td>${c.telefono || '-'}</td>
        <td>${c.email || '-'}</td>
        <td>${c.sexo || '-'}</td>
        <td>${edad}</td>
        <td>${ubicacion}</td>
        <td>${c.fechaRegistro || '-'}</td>
      </tr>
    `;
  });

  html += `
      </tbody>
    </table>
    <div class="reporte-footer">
      <p>Total de clientes: ${clientes.length}</p>
    </div>
  `;

  document.getElementById('previewRepClientes').innerHTML = html;
  document.getElementById('previewRepClientes').style.display = 'block';
}

function calcularEdad(fechaNac) {
  const hoy = new Date();
  const nac = new Date(fechaNac);
  let edad = hoy.getFullYear() - nac.getFullYear();
  const m = hoy.getMonth() - nac.getMonth();
  if (m < 0 || (m === 0 && hoy.getDate() < nac.getDate())) {
    edad--;
  }
  return edad;
}

function generarEstadisticasSexo(porSexo, total) {
  let html = '';
  for (const key in porSexo) {
    const valor = porSexo[key];
    const porcentaje = ((valor / total) * 100).toFixed(1);
    html += '<p>' + key + ': ' + valor + ' (' + porcentaje + '%)</p>';
  }
  return html;
}

function generarEstadisticasEdad(porEdad, total) {
  let html = '';
  for (const key in porEdad) {
    const valor = porEdad[key];
    if (valor > 0) {
      const porcentaje = ((valor / total) * 100).toFixed(1);
      html += '<p>' + key + ' a√±os: ' + valor + ' (' + porcentaje + '%)</p>';
    }
  }
  return html;
}

function cerrarReporteClientes() {
  document.getElementById('previewRepClientes').style.display = 'none';
}

function imprimirReporteClientes() {
  const contenido = document.getElementById('previewRepClientes').innerHTML;
  abrirVentanaImpresion(contenido, 'Reporte de Clientes');
}

function exportarReporteClientesExcel() {
  let clientes = load(DB.CLIENTES);

  if (clientes.length === 0) {
    toast('No hay clientes para exportar', 'warning');
    return;
  }

  const headers = ['DNI', 'Nombre', 'Tel√©fono', 'Email', 'Sexo', 'Fecha Nacimiento', 'Departamento', 'Provincia', 'Distrito', 'Fecha Registro'];
  const rows = clientes.map(c => [
    c.dni || '',
    c.nombre,
    c.telefono || '',
    c.email || '',
    c.sexo || '',
    c.fechaNacimiento || '',
    c.departamento || '',
    c.provincia || '',
    c.distrito || '',
    c.fechaRegistro || ''
  ]);

  const csv = generarCSV(headers, rows);
  descargarCSV(csv, `clientes_${new Date().toISOString().split('T')[0]}.csv`);
  toast('Clientes exportados');
}

/* ============================================
   REPORTES OPTIABI (Compatible con sistema antiguo)
   ============================================ */

// Inicializar selectores de a√±os
function initReportesOptiabi() {
  const medidas = load(DB.MEDIDAS);
  const anos = [...new Set(medidas.map(m => m.fecha ? m.fecha.substring(0, 4) : null).filter(Boolean))];
  anos.sort().reverse();

  const selectAnio = document.getElementById('repOptiabiAnio');
  const selectMesAnio = document.getElementById('repOptiabiMesAnio');

  if (selectAnio) {
    selectAnio.innerHTML = '<option value="">Seleccionar a√±o...</option>' +
      anos.map(a => `<option value="${a}">${a}</option>`).join('');
  }

  if (selectMesAnio) {
    selectMesAnio.innerHTML = '<option value="">Seleccionar a√±o...</option>' +
      anos.map(a => `<option value="${a}">${a}</option>`).join('');
  }
}

function generarReporteOptiabi(tipo) {
  const clientes = load(DB.CLIENTES);
  let medidas = load(DB.MEDIDAS);
  const ventas = load(DB.VENTAS);

  // Filtrar seg√∫n el tipo de reporte
  switch(tipo) {
    case 'dias':
      const fecha = document.getElementById('repOptiabiDia').value;
      if (!fecha) {
        toast('Selecciona una fecha', 'warning');
        return;
      }
      medidas = medidas.filter(m => m.fecha === fecha);
      break;

    case 'anios':
      const anio = document.getElementById('repOptiabiAnio').value;
      if (!anio) {
        toast('Selecciona un a√±o', 'warning');
        return;
      }
      medidas = medidas.filter(m => m.fecha && m.fecha.startsWith(anio));
      break;

    case 'meses':
      const mes = document.getElementById('repOptiabiMes').value;
      const mesAnio = document.getElementById('repOptiabiMesAnio').value;
      if (!mesAnio) {
        toast('Selecciona un a√±o', 'warning');
        return;
      }
      const periodoMes = `${mesAnio}-${mes}`;
      medidas = medidas.filter(m => m.fecha && m.fecha.startsWith(periodoMes));
      break;

    case 'deudores':
      // Filtrar solo ventas con saldo pendiente
      const ventasConDeuda = ventas.filter(v => (v.total - v.pagado) > 0);
      const clientesConDeuda = new Set(ventasConDeuda.map(v => v.clienteId));
      medidas = medidas.filter(m => clientesConDeuda.has(m.clienteId));
      break;

    case 'general':
      // Todos los registros
      break;
  }

  // Ordenar por fecha
  medidas.sort((a, b) => (b.fecha || '').localeCompare(a.fecha || ''));

  // Generar vista previa
  mostrarVistaReporteOptiabi(medidas, clientes, ventas, tipo);
}

function mostrarVistaReporteOptiabi(medidas, clientes, ventas, tipo) {
  const preview = document.getElementById('previewRepOptiabi');

  if (medidas.length === 0) {
    preview.innerHTML = '<div style="padding: 40px; text-align: center; color: #6b7280;">No hay datos para mostrar con los filtros seleccionados</div>';
    preview.style.display = 'block';
    return;
  }

  let numero = 1;
  const filas = medidas.map(m => {
    const cliente = clientes.find(c => c.id === m.clienteId);
    const nombreCompleto = cliente ? `${cliente.apellidos} ${cliente.nombres}`.trim() : 'Sin nombre';

    const od = `${m.lejosOdEsf || ''}/${m.lejosOdCil || ''}${m.lejosOdEje ? 'X' + m.lejosOdEje : ''}`;
    const oi = `${m.lejosOiEsf || ''}/${m.lejosOiCil || ''}${m.lejosOiEje ? 'X' + m.lejosOiEje : ''}`;

    // Buscar venta relacionada (compatible con ventas normales e importadas de Optiabi)
    const venta = ventas.find(v => v.clienteId === m.clienteId && (v.fechaEmision === m.fecha || v.fecha === m.fecha));
    const precio = venta ? venta.total : 0;
    const adelanto = venta ? (venta.adelanto || venta.pagado || 0) : 0;
    const deuda = venta ? (venta.saldo || (venta.total - (venta.pagado || 0))) : 0;

    return `
      <tr>
        <td>${numero++}</td>
        <td>${nombreCompleto}</td>
        <td>${m.edad || cliente?.edad || '-'}</td>
        <td>${od}</td>
        <td>${oi}</td>
        <td>${m.rxMonturas || '-'}</td>
        <td>${m.rxCristales || '-'}</td>
        <td style="text-align: right;">S/ ${precio.toFixed(2)}</td>
        <td style="text-align: right;">S/ ${adelanto.toFixed(2)}</td>
        <td style="text-align: right; ${deuda > 0 ? 'color: #dc2626; font-weight: bold;' : ''}">S/ ${deuda.toFixed(2)}</td>
        <td>${formatDate(m.fecha)}</td>
      </tr>
    `;
  }).join('');

  const html = `
    <div style="background: white; padding: 20px; border-radius: 8px;">
      <h3 style="color: #6b21a8; margin-bottom: 16px;">
        üìä Reporte ${tipo.charAt(0).toUpperCase() + tipo.slice(1)} - ${medidas.length} registros
      </h3>
      <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
          <thead>
            <tr style="background: #6b21a8; color: white;">
              <th style="padding: 10px; border: 1px solid #e5e7eb;">N¬∞</th>
              <th style="padding: 10px; border: 1px solid #e5e7eb;">APELLIDOS Y NOMBRES</th>
              <th style="padding: 10px; border: 1px solid #e5e7eb;">EDAD</th>
              <th style="padding: 10px; border: 1px solid #e5e7eb;">OJO DER.</th>
              <th style="padding: 10px; border: 1px solid #e5e7eb;">OJO IZQ.</th>
              <th style="padding: 10px; border: 1px solid #e5e7eb;">MONTURAS</th>
              <th style="padding: 10px; border: 1px solid #e5e7eb;">CRISTALES</th>
              <th style="padding: 10px; border: 1px solid #e5e7eb;">PRECIO</th>
              <th style="padding: 10px; border: 1px solid #e5e7eb;">ADELANTO</th>
              <th style="padding: 10px; border: 1px solid #e5e7eb;">DEUDA</th>
              <th style="padding: 10px; border: 1px solid #e5e7eb;">FECHA VENTA</th>
            </tr>
          </thead>
          <tbody>
            ${filas}
          </tbody>
        </table>
      </div>
      <div style="margin-top: 20px; display: flex; gap: 12px;">
        <button class="btn btn-success" onclick="exportarReporteOptiabiExcel('${tipo}')">üìä Exportar a Excel</button>
        <button class="btn btn-info" onclick="imprimirReporteOptiabi()">üñ®Ô∏è Imprimir</button>
      </div>
    </div>
  `;

  preview.innerHTML = html;
  preview.style.display = 'block';
}

function exportarReporteOptiabiExcel(tipo) {
  const clientes = load(DB.CLIENTES);
  let medidas = load(DB.MEDIDAS);
  const ventas = load(DB.VENTAS);

  // Aplicar filtros seg√∫n tipo (mismo c√≥digo que generarReporteOptiabi)
  switch(tipo) {
    case 'dias':
      const fecha = document.getElementById('repOptiabiDia').value;
      if (fecha) medidas = medidas.filter(m => m.fecha === fecha);
      break;
    case 'anios':
      const anio = document.getElementById('repOptiabiAnio').value;
      if (anio) medidas = medidas.filter(m => m.fecha && m.fecha.startsWith(anio));
      break;
    case 'meses':
      const mes = document.getElementById('repOptiabiMes').value;
      const mesAnio = document.getElementById('repOptiabiMesAnio').value;
      if (mesAnio) {
        const periodoMes = `${mesAnio}-${mes}`;
        medidas = medidas.filter(m => m.fecha && m.fecha.startsWith(periodoMes));
      }
      break;
    case 'deudores':
      const ventasConDeuda = ventas.filter(v => (v.total - v.pagado) > 0);
      const clientesConDeuda = new Set(ventasConDeuda.map(v => v.clienteId));
      medidas = medidas.filter(m => clientesConDeuda.has(m.clienteId));
      break;
  }

  medidas.sort((a, b) => (b.fecha || '').localeCompare(a.fecha || ''));

  const headers = ['N¬∞', 'APELLIDOS Y NOMBRES', 'EDAD', 'OJO DERECHO', 'OJO IZQUIERDO', 'MONTURAS', 'CRISTALES', 'PRECIO', 'ADELANTO', 'DEUDA', 'FECHA VENTA'];

  let numero = 1;
  const rows = medidas.map(m => {
    const cliente = clientes.find(c => c.id === m.clienteId);
    const nombreCompleto = cliente ? `${cliente.apellidos} ${cliente.nombres}`.trim() : 'Sin nombre';
    const od = `${m.lejosOdEsf || ''}/${m.lejosOdCil || ''}${m.lejosOdEje ? 'X' + m.lejosOdEje : ''}`;
    const oi = `${m.lejosOiEsf || ''}/${m.lejosOiCil || ''}${m.lejosOiEje ? 'X' + m.lejosOiEje : ''}`;

    const venta = ventas.find(v => v.clienteId === m.clienteId && (v.fechaEmision === m.fecha || v.fecha === m.fecha));
    const precio = venta ? venta.total : 0;
    const adelanto = venta ? (venta.adelanto || venta.pagado || 0) : 0;
    const deuda = venta ? (venta.saldo || (venta.total - (venta.pagado || 0))) : 0;

    return [
      numero++,
      nombreCompleto,
      m.edad || cliente?.edad || '-',
      od,
      oi,
      m.rxMonturas || '-',
      m.rxCristales || '-',
      precio.toFixed(2),
      adelanto.toFixed(2),
      deuda.toFixed(2),
      formatDate(m.fecha)
    ];
  });

  const csv = generarCSV(headers, rows);
  descargarCSV(csv, `reporte_optiabi_${tipo}_${today()}.csv`);
  toast(`Exportados ${medidas.length} registros`, 'success');
}

function imprimirReporteOptiabi() {
  const contenido = document.getElementById('previewRepOptiabi').innerHTML;
  const ventana = window.open('', '_blank');
  ventana.document.write(`
    <html>
    <head>
      <title>Reporte Optiabi</title>
      <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        table { border-collapse: collapse; width: 100%; font-size: 12px; }
        th, td { border: 1px solid #000; padding: 6px; }
        th { background: #6b21a8; color: white; }
        @media print {
          button { display: none; }
        }
      </style>
    </head>
    <body>
      ${contenido}
    </body>
    </html>
  `);
  ventana.document.close();
  setTimeout(() => ventana.print(), 250);
}

function cerrarReporteOptiabi() {
  document.getElementById('previewRepOptiabi').style.display = 'none';
}

// Inicializaci√≥n de Reportes
function initReportes() {
  initReportesFechas();
  initReportesOptiabi();

  // Cargar opciones din√°micas en filtros de productos
  const productos = load(DB.PRODUCTOS);

  const familias = [...new Set(productos.map(p => p.familia).filter(Boolean))];
  const lineas = [...new Set(productos.map(p => p.linea).filter(Boolean))];
  const categorias = [...new Set(productos.map(p => p.categoria).filter(Boolean))];
  const marcas = [...new Set(productos.map(p => p.marca).filter(Boolean))];

  const selFamilia = document.getElementById('repProdFamiliaVal');
  const selLinea = document.getElementById('repProdLineaVal');
  const selCategoria = document.getElementById('repProdCategoriaVal');
  const selMarca = document.getElementById('repProdMarcaVal');

  if (selFamilia) {
    familias.forEach(f => {
      const opt = document.createElement('option');
      opt.value = f;
      opt.textContent = f;
      selFamilia.appendChild(opt);
    });
  }

  if (selLinea) {
    lineas.forEach(l => {
      const opt = document.createElement('option');
      opt.value = l;
      opt.textContent = l;
      selLinea.appendChild(opt);
    });
  }

  if (selCategoria) {
    categorias.forEach(c => {
      const opt = document.createElement('option');
      opt.value = c;
      opt.textContent = c;
      selCategoria.appendChild(opt);
    });
  }

  if (selMarca) {
    marcas.forEach(m => {
      const opt = document.createElement('option');
      opt.value = m;
      opt.textContent = m;
      selMarca.appendChild(opt);
    });
  }
}

// ==================== M√ìDULO DE IMPORTACI√ìN AVANZADA ====================

// Variables globales para importaci√≥n
let importCurrentStep = 0;
let importExcelData = [];
let importExcelHeaders = [];
let importProcessing = false;
let importType = 'productos'; // 'productos' o 'clientes'

// Inicializar el wizard de importaci√≥n
function initImportWizard() {
  // Evento para selecci√≥n de archivo
  const fileInput = document.getElementById('importArchivoExcel');
  if (fileInput) {
    fileInput.addEventListener('change', handleExcelFileSelect);
  }

  // Event listeners para selector de tipo de importaci√≥n
  const typeOptions = document.querySelectorAll('.import-type-option');
  typeOptions.forEach(option => {
    option.addEventListener('click', function() {
      // Remover active de todos
      typeOptions.forEach(opt => opt.classList.remove('active'));
      // Agregar active al seleccionado
      this.classList.add('active');
      // Actualizar radio button
      const radio = this.querySelector('input[type="radio"]');
      if (radio) {
        radio.checked = true;
        importType = radio.value;
        console.log('Tipo de importaci√≥n:', importType);
      }
    });
  });
}

// Manejar selecci√≥n de archivo Excel
function handleExcelFileSelect(event) {
  const file = event.target.files[0];
  if (!file) return;

  // Validar tama√±o (40MB m√°ximo)
  const maxSize = 40 * 1024 * 1024; // 40MB
  if (file.size > maxSize) {
    toast('El archivo excede el l√≠mite de 40MB', 'error');
    return;
  }

  // Validar tipo de archivo
  const validTypes = ['.xlsx', '.xls', '.csv', '.pdf'];
  const fileName = file.name.toLowerCase();
  const isValid = validTypes.some(ext => fileName.endsWith(ext));
  if (!isValid) {
    toast('Formato de archivo no v√°lido. Use .xlsx, .xls, .csv o .pdf', 'error');
    return;
  }

  document.getElementById('importArchivoNombre').value = file.name;

  // Si es PDF, usar lectura especial
  if (fileName.endsWith('.pdf')) {
    leerPDF(file);
    return;
  }

  // Leer el archivo Excel/CSV
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = e.target.result;
      parseExcelData(data, file.name);
    } catch (error) {
      toast('Error al leer el archivo: ' + error.message, 'error');
    }
  };

  if (fileName.endsWith('.csv')) {
    reader.readAsText(file);
  } else {
    reader.readAsBinaryString(file);
  }
}

// ============================================
// FUNCIONES PARA LECTURA DE PDFs
// ============================================

// Leer archivo PDF y extraer texto (MEJORADO PARA TABLAS)
async function leerPDF(file) {
  try {
    toast('Leyendo archivo PDF tipo tabla...', 'info');

    // Convertir archivo a ArrayBuffer
    const arrayBuffer = await file.arrayBuffer();

    // Cargar el PDF con PDF.js
    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

    toast(`Procesando ${pdf.numPages} p√°ginas...`, 'info');

    // Extraer texto de todas las p√°ginas PRESERVANDO POSICIONES
    let textoCompleto = '';

    for (let numPagina = 1; numPagina <= pdf.numPages; numPagina++) {
      const pagina = await pdf.getPage(numPagina);
      const contenidoTexto = await pagina.getTextContent();

      // Reconstruir texto l√≠nea por l√≠nea preservando estructura de tabla
      const items = contenidoTexto.items;

      // Agrupar items por posici√≥n Y (misma l√≠nea)
      const lineasPorY = {};
      items.forEach(item => {
        const y = Math.round(item.transform[5]); // Posici√≥n Y
        if (!lineasPorY[y]) {
          lineasPorY[y] = [];
        }
        lineasPorY[y].push({
          x: item.transform[4], // Posici√≥n X
          text: item.str
        });
      });

      // Ordenar l√≠neas de arriba a abajo
      const ySorted = Object.keys(lineasPorY).sort((a, b) => b - a);

      ySorted.forEach(y => {
        // Ordenar items de izquierda a derecha
        const itemsEnLinea = lineasPorY[y].sort((a, b) => a.x - b.x);
        const lineaTexto = itemsEnLinea.map(item => item.text).join(' ');
        textoCompleto += lineaTexto + '\n';
      });

      textoCompleto += '\n'; // Separador entre p√°ginas
    }

    // Extraer datos del texto tipo tabla
    const datosExtraidos = extraerDatosPDFTabla(textoCompleto);

    if (datosExtraidos.length === 0) {
      toast('No se encontraron recetas v√°lidas en el PDF', 'warning');
      return;
    }

    toast(`Se encontraron ${datosExtraidos.length} recetas en el PDF`, 'success');

    // Convertir datos a formato compatible con el importador
    importExcelData = datosExtraidos;
    importExcelHeaders = Object.keys(datosExtraidos[0] || {});

    // Mostrar vista previa
    showImportPreview();

    // Poblar los selects de mapeo con las columnas del PDF
    populateColumnMappings();

    // Avanzar al paso de mapeo (paso 2)
    setImportStep(2);

  } catch (error) {
    console.error('Error al leer PDF:', error);
    toast('Error al procesar el PDF: ' + error.message, 'error');
  }
}

// ============================================
// EXTRACTOR DE DATOS TIPO TABLA (MEJORADO - V2)
// ============================================
function extraerDatosPDFTabla(texto) {
  console.log('=== INICIANDO EXTRACCI√ìN DE PDF TABLA ===');

  const recetas = [];
  const lineas = texto.split('\n');

  let encabezadoEncontrado = false;
  let indiceColumnas = null;

  for (let i = 0; i < lineas.length; i++) {
    let linea = lineas[i];

    // Detectar encabezado de tabla
    if (!encabezadoEncontrado) {
      const lineaUpper = linea.toUpperCase();

      // Buscar l√≠nea que contenga las columnas caracter√≠sticas
      if ((lineaUpper.includes('APELLIDOS') || lineaUpper.includes('NOMBRES')) &&
          (lineaUpper.includes('EDAD') || lineaUpper.includes('O D') || lineaUpper.includes('O_D'))) {

        console.log('‚úÖ Encabezado encontrado en l√≠nea', i);

        // Detectar posiciones de columnas usando el encabezado
        indiceColumnas = {
          nro: lineaUpper.indexOf('N¬∫') >= 0 ? lineaUpper.indexOf('N¬∫') : 0,
          paciente: lineaUpper.indexOf('APELLIDOS'),
          edad: lineaUpper.indexOf('EDAD'),
          od: Math.max(lineaUpper.indexOf('O D'), lineaUpper.indexOf('O_D')),
          oi: Math.max(lineaUpper.indexOf('O I'), lineaUpper.indexOf('O_I')),
          montura: lineaUpper.indexOf('MONTURA'),
          cristales: lineaUpper.indexOf('CRISTAL'),
          precio: lineaUpper.indexOf('PRECIO'),
          adelanto: Math.max(lineaUpper.indexOf('ADLANT'), lineaUpper.indexOf('ADELANT')),
          deuda: lineaUpper.indexOf('DEUDA'),
          fecha: lineaUpper.indexOf('FECHA')
        };

        console.log('√çndices:', indiceColumnas);
        encabezadoEncontrado = true;
        continue;
      }
    }

    // Procesar filas de datos
    if (encabezadoEncontrado && linea.trim().length > 0) {

      // Ignorar separadores y t√≠tulos
      if (linea.match(/^[-=\s]+$/) ||
          linea.toUpperCase().includes('TITULO') ||
          linea.toUpperCase().includes('Optica') ||
          linea.toUpperCase().includes('Pag')) {
        continue;
      }

      try {
        // Extraer campos usando posiciones
        const extraerCampo = (inicio, fin) => {
          if (inicio < 0 || inicio >= linea.length) return '';
          const valor = fin > 0 ? linea.substring(inicio, fin) : linea.substring(inicio);
          return valor.trim();
        };

        const posiciones = Object.values(indiceColumnas).filter(p => p >= 0).sort((a, b) => a - b);

        const obtenerCampo = (nombreCampo) => {
          const inicio = indiceColumnas[nombreCampo];
          if (inicio < 0) return '';
          const siguientePos = posiciones.find(p => p > inicio) || linea.length;
          return extraerCampo(inicio, siguientePos);
        };

        const paciente = obtenerCampo('paciente');

        // Solo procesar si tiene paciente v√°lido
        if (!paciente || paciente.length < 3 || /^[0-9]+$/.test(paciente)) {
          continue;
        }

        const od = obtenerCampo('od');
        const oi = obtenerCampo('oi');

        // Parsear medidas
        const medidasOD = parsearMedidaCompleja(od);
        const medidasOI = parsearMedidaCompleja(oi);

        // Parsear fecha (formato DD/MM/YY)
        let fechaStr = obtenerCampo('fecha');
        let fechaFormateada = '';
        if (fechaStr) {
          const matchFecha = fechaStr.match(/(\d{1,2})\/(\d{1,2})\/(\d{2,4})/);
          if (matchFecha) {
            let dia = matchFecha[1].padStart(2, '0');
            let mes = matchFecha[2].padStart(2, '0');
            let anio = matchFecha[3];
            if (anio.length === 2) anio = '20' + anio;
            fechaFormateada = `${anio}-${mes}-${dia}`;
          }
        }

        const recetaCompleta = {
          NRO: obtenerCampo('nro'),
          PACIENTE: paciente,
          EDAD: obtenerCampo('edad'),

          // OD parseado
          OD_ESF: medidasOD.esf,
          OD_CIL: medidasOD.cil,
          OD_EJE: medidasOD.eje,
          OD_ADD: medidasOD.add,

          // OI parseado
          OI_ESF: medidasOI.esf,
          OI_CIL: medidasOI.cil,
          OI_EJE: medidasOI.eje,
          OI_ADD: medidasOI.add,

          MONTURA: obtenerCampo('montura'),
          CRISTALES: obtenerCampo('cristales'),
          PRECIO: obtenerCampo('precio').replace(/[^\d.]/g, ''),
          ADELANTO: obtenerCampo('adelanto').replace(/[^\d.]/g, ''),
          DEUDA: obtenerCampo('deuda').replace(/[^\d.]/g, ''),
          FECHA: fechaFormateada || obtenerCampo('fecha')
        };

        console.log('‚úÖ Receta:', recetaCompleta.PACIENTE);
        recetas.push(recetaCompleta);

      } catch (error) {
        console.log('‚ö†Ô∏è Error en l√≠nea', i, ':', error.message);
      }
    }
  }

  console.log('Total extra√≠das:', recetas.length);
  return recetas;
}

// Parsear medidas complejas tipo "CIL-2.00X20¬∞" o "ESF-0.50" o "+2.50-5.00X176¬∞"
function parsearMedidaCompleja(medida) {
  if (!medida || medida.trim() === '' || medida.includes('...')) {
    return { esf: '', cil: '', eje: '', add: '' };
  }

  const resultado = { esf: '', cil: '', eje: '', add: '' };

  // Limpiar medida
  medida = medida.toUpperCase().replace(/¬∞/g, '').trim();

  // Patr√≥n: CIL -2.00 X 20
  const matchCIL = medida.match(/CIL\s*([-+]?\d*\.?\d+)/i);
  if (matchCIL) resultado.cil = matchCIL[1];

  // Patr√≥n: ESF -0.50 o simplemente el primer n√∫mero si no hay CIL
  const matchESF = medida.match(/ESF\s*([-+]?\d*\.?\d+)/i);
  if (matchESF) {
    resultado.esf = matchESF[1];
  } else {
    // Si no dice ESF expl√≠citamente, el primer n√∫mero es ESF
    const matchPrimerNumero = medida.match(/^([-+]?\d*\.?\d+)/);
    if (matchPrimerNumero && !matchCIL) {
      resultado.esf = matchPrimerNumero[1];
    }
  }

  // Patr√≥n: X 180 o X180
  const matchEJE = medida.match(/X\s*(\d+)/i);
  if (matchEJE) resultado.eje = matchEJE[1];

  // Patr√≥n complejo: "+2.50-5.00X176"
  // Formato: ESF CIL X EJE
  const matchComplejo = medida.match(/([-+]?\d*\.?\d+)\s*([-+]\d*\.?\d+)?\s*X?\s*(\d+)?/);
  if (matchComplejo && !matchCIL && !matchESF) {
    resultado.esf = matchComplejo[1] || '';
    if (matchComplejo[2]) resultado.cil = matchComplejo[2];
    if (matchComplejo[3]) resultado.eje = matchComplejo[3];
  }

  return resultado;
}

// Extraer datos de recetas del texto del PDF (M√âTODO ANTIGUO - MANTENER PARA COMPATIBILIDAD)
function extraerDatosPDF(texto) {
  const recetas = [];

  // Patrones para identificar datos
  // Ajusta estos patrones seg√∫n el formato de tus PDFs

  // Dividir por posibles separadores de recetas
  const lineas = texto.split('\n');

  let recetaActual = {};
  let enReceta = false;

  for (let i = 0; i < lineas.length; i++) {
    const linea = lineas[i].trim();

    if (!linea) continue;

    // Detectar inicio de nueva receta (buscar palabras clave)
    if (linea.match(/paciente|nombre|patient/i) && linea.length < 100) {
      // Si ya ten√≠amos una receta, guardarla
      if (Object.keys(recetaActual).length > 0) {
        recetas.push(recetaActual);
      }
      recetaActual = {};
      enReceta = true;
    }

    // Extraer NOMBRE/PACIENTE
    const matchNombre = linea.match(/(?:paciente|nombre|patient)[:\s]+([A-Z√Å√â√ç√ì√ö√ëa-z√°√©√≠√≥√∫√±\s]+?)(?:\s+edad|\s+\d+|\s*$)/i);
    if (matchNombre && !recetaActual.PACIENTE) {
      recetaActual.PACIENTE = matchNombre[1].trim();
    }

    // Extraer EDAD
    const matchEdad = linea.match(/edad[:\s]+(\d+)/i);
    if (matchEdad && !recetaActual.EDAD) {
      recetaActual.EDAD = matchEdad[1];
    }

    // Extraer OD (Ojo Derecho) - ESF, CIL, EJE, ADD
    const matchOD = linea.match(/OD[:\s]+(-?\d+\.?\d*)\s+(-?\d+\.?\d*)\s+(\d+)(?:\s+(-?\d+\.?\d*))?/i);
    if (matchOD) {
      recetaActual.OD_ESF = matchOD[1];
      recetaActual.OD_CIL = matchOD[2];
      recetaActual.OD_EJE = matchOD[3];
      if (matchOD[4]) recetaActual.OD_ADD = matchOD[4];
    }

    // Extraer OI (Ojo Izquierdo) - ESF, CIL, EJE, ADD
    const matchOI = linea.match(/OI[:\s]+(-?\d+\.?\d*)\s+(-?\d+\.?\d*)\s+(\d+)(?:\s+(-?\d+\.?\d*))?/i);
    if (matchOI) {
      recetaActual.OI_ESF = matchOI[1];
      recetaActual.OI_CIL = matchOI[2];
      recetaActual.OI_EJE = matchOI[3];
      if (matchOI[4]) recetaActual.OI_ADD = matchOI[4];
    }

    // Extraer MONTURA/FRAME
    const matchMontura = linea.match(/(?:montura|frame|armazon)[:\s]+([A-Za-z0-9\s\-]+?)(?:\s+cristal|\s+lens|\s*$)/i);
    if (matchMontura && !recetaActual.MONTURA) {
      recetaActual.MONTURA = matchMontura[1].trim();
    }

    // Extraer CRISTALES/LENSES
    const matchCristales = linea.match(/(?:cristal|lens|lente)[:\s]+([A-Za-z0-9\s\-]+?)(?:\s+precio|\s+total|\s*$)/i);
    if (matchCristales && !recetaActual.CRISTALES) {
      recetaActual.CRISTALES = matchCristales[1].trim();
    }

    // Extraer PRECIO/TOTAL
    const matchPrecio = linea.match(/(?:precio|total|costo)[:\s]*S\/?\s*(\d+\.?\d*)/i);
    if (matchPrecio && !recetaActual.PRECIO) {
      recetaActual.PRECIO = matchPrecio[1];
    }

    // Extraer FECHA
    const matchFecha = linea.match(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})/);
    if (matchFecha && !recetaActual.FECHA) {
      let dia = matchFecha[1].padStart(2, '0');
      let mes = matchFecha[2].padStart(2, '0');
      let anio = matchFecha[3];
      if (anio.length === 2) anio = '20' + anio;
      recetaActual.FECHA = `${anio}-${mes}-${dia}`;
    }

    // Extraer OBSERVACIONES (l√≠neas que contengan texto descriptivo)
    if (linea.match(/(?:observ|nota|comentario)[:\s]+(.+)/i)) {
      const matchObs = linea.match(/(?:observ|nota|comentario)[:\s]+(.+)/i);
      if (matchObs) {
        recetaActual.OBSERVACIONES = matchObs[1].trim();
      }
    }
  }

  // Guardar √∫ltima receta si existe
  if (Object.keys(recetaActual).length > 0) {
    recetas.push(recetaActual);
  }

  // Filtrar recetas que tengan al menos nombre o datos de medida
  return recetas.filter(r => r.PACIENTE || r.OD_ESF || r.OI_ESF);
}

// Parsear datos del Excel/CSV
function parseExcelData(data, fileName) {
  importExcelData = [];
  importExcelHeaders = [];

  if (fileName.toLowerCase().endsWith('.csv')) {
    // Parsear CSV
    const lines = data.split('\n').filter(line => line.trim());
    if (lines.length > 0) {
      // Primera l√≠nea son los headers
      importExcelHeaders = parseCSVLine(lines[0]);

      // Resto son datos
      for (let i = 1; i < lines.length; i++) {
        const values = parseCSVLine(lines[i]);
        if (values.length > 0) {
          const row = {};
          importExcelHeaders.forEach((header, idx) => {
            row[header] = values[idx] || '';
          });
          importExcelData.push(row);
        }
      }
    }
  } else {
    // Parsear Excel usando una implementaci√≥n simple
    // Para archivos Excel reales, necesitar√≠amos una librer√≠a como SheetJS
    // Aqu√≠ implementamos un parser b√°sico para CSV exportado desde Excel
    toast('Para archivos .xlsx/.xls, por favor exporte a CSV primero', 'warning');

    // Intentar parsear como texto de todas formas
    const lines = data.split('\n').filter(line => line.trim());
    if (lines.length > 0) {
      importExcelHeaders = parseCSVLine(lines[0]);
      for (let i = 1; i < lines.length; i++) {
        const values = parseCSVLine(lines[i]);
        if (values.length > 0) {
          const row = {};
          importExcelHeaders.forEach((header, idx) => {
            row[header] = values[idx] || '';
          });
          importExcelData.push(row);
        }
      }
    }
  }

  // Mostrar vista previa
  showImportPreview();

  // Llenar selectores de mapeo de columnas
  populateColumnMappings();

  if (importExcelData.length > 0) {
    toast(`Se cargaron ${importExcelData.length} registros`, 'success');
  } else {
    toast('No se encontraron datos en el archivo', 'warning');
  }
}

// Parsear l√≠nea CSV (maneja comillas y comas dentro de campos)
function parseCSVLine(line) {
  const result = [];
  let current = '';
  let inQuotes = false;

  for (let i = 0; i < line.length; i++) {
    const char = line[i];

    if (char === '"') {
      inQuotes = !inQuotes;
    } else if ((char === ',' || char === ';') && !inQuotes) {
      result.push(current.trim());
      current = '';
    } else {
      current += char;
    }
  }
  result.push(current.trim());

  return result;
}

// Mostrar vista previa de datos importados
function showImportPreview() {
  const previewArea = document.getElementById('importPreviewArea');
  if (!previewArea || importExcelData.length === 0) {
    previewArea.innerHTML = '<p class="text-center text-muted">No hay datos para mostrar</p>';
    return;
  }

  // Mostrar solo las primeras 100 filas para rendimiento
  const maxRows = Math.min(importExcelData.length, 100);

  let html = '<table><thead><tr>';
  importExcelHeaders.forEach(header => {
    html += `<th>${header}</th>`;
  });
  html += '</tr></thead><tbody>';

  for (let i = 0; i < maxRows; i++) {
    html += '<tr>';
    importExcelHeaders.forEach(header => {
      html += `<td>${importExcelData[i][header] || ''}</td>`;
    });
    html += '</tr>';
  }

  html += '</tbody></table>';

  if (importExcelData.length > 100) {
    html += `<p class="text-center text-muted" style="margin-top:10px;">Mostrando 100 de ${importExcelData.length} registros</p>`;
  }

  previewArea.innerHTML = html;
}

// Llenar los selectores de mapeo de columnas
function populateColumnMappings() {
  // Selectores para PRODUCTOS
  const mapSelectsProductos = [
    'mapSubCodigo', 'mapDescripcion', 'mapMarca', 'mapModelo',
    'mapFamilia', 'mapLinea', 'mapCategoria', 'mapUbicacion',
    'mapMaterial', 'mapUnidadMedida', 'mapTalla', 'mapCaracteristica',
    'mapStock', 'mapPrecioCompra', 'mapPrecioVenta',
    'mapPrecioVentaMedio', 'mapPrecioVentaMinimo'
  ];

  // Selectores para CLIENTES
  const mapSelectsClientes = [
    'mapCliNombre', 'mapCliApellido', 'mapCliDni', 'mapCliCelular',
    'mapCliEmail', 'mapCliDireccion', 'mapCliCiudad', 'mapCliFechaNac',
    'mapCliObservaciones'
  ];

  // Selectores para PRESCRIPCIONES
  const mapSelectsPrescripciones = [
    'mapRxCodigo', 'mapRxPaciente', 'mapRxFecha', 'mapRxEspecialista',
    'mapRxOdEsf', 'mapRxOdCil', 'mapRxOdEje', 'mapRxOdAdd',
    'mapRxOiEsf', 'mapRxOiCil', 'mapRxOiEje', 'mapRxOiAdd',
    'mapRxDip', 'mapRxObservaciones'
  ];

  // Selectores para PDFs
  const mapSelectsPdf = [
    'mapPdfPaciente', 'mapPdfEdad', 'mapPdfFecha',
    'mapPdfOdEsf', 'mapPdfOdCil', 'mapPdfOdEje', 'mapPdfOdAdd',
    'mapPdfOiEsf', 'mapPdfOiCil', 'mapPdfOiEje', 'mapPdfOiAdd',
    'mapPdfMontura', 'mapPdfCristales', 'mapPdfPrecio', 'mapPdfObservaciones'
  ];

  // Selectores para OPTIABI
  const mapSelectsOptiabi = [
    'mapOptiabiApellidos', 'mapOptiabiEdad', 'mapOptiabiOd', 'mapOptiabiOi',
    'mapOptiabiMonturas', 'mapOptiabiCristales', 'mapOptiabiPrecio',
    'mapOptiabiAdelanto', 'mapOptiabiDeuda', 'mapOptiabiFechaVenta',
    'mapOptiabiDocumento', 'mapOptiabiTelefono', 'mapOptiabiDireccion',
    'mapOptiabiObservaciones'
  ];

  // Llenar selectores de productos
  mapSelectsProductos.forEach(selectId => {
    const select = document.getElementById(selectId);
    if (select) {
      select.innerHTML = '<option value="">--Seleccione--</option>';
      importExcelHeaders.forEach(header => {
        const option = document.createElement('option');
        option.value = header;
        option.textContent = header;
        select.appendChild(option);
      });
      autoSelectMapping(select, selectId);
    }
  });

  // Llenar selectores de clientes
  mapSelectsClientes.forEach(selectId => {
    const select = document.getElementById(selectId);
    if (select) {
      select.innerHTML = '<option value="">--Seleccione--</option>';
      importExcelHeaders.forEach(header => {
        const option = document.createElement('option');
        option.value = header;
        option.textContent = header;
        select.appendChild(option);
      });
      autoSelectMappingClientes(select, selectId);
    }
  });

  // Llenar selectores de prescripciones
  mapSelectsPrescripciones.forEach(selectId => {
    const select = document.getElementById(selectId);
    if (select) {
      select.innerHTML = '<option value="">--Seleccione--</option>';
      importExcelHeaders.forEach(header => {
        const option = document.createElement('option');
        option.value = header;
        option.textContent = header;
        select.appendChild(option);
      });
      autoSelectMappingPrescripciones(select, selectId);
    }
  });

  // Llenar selectores de PDFs
  mapSelectsPdf.forEach(selectId => {
    const select = document.getElementById(selectId);
    if (select) {
      select.innerHTML = '<option value="">--Seleccione--</option>';
      importExcelHeaders.forEach(header => {
        const option = document.createElement('option');
        option.value = header;
        option.textContent = header;
        select.appendChild(option);
      });
      autoSelectMappingPdf(select, selectId);
    }
  });

  // Llenar selectores de OPTIABI
  mapSelectsOptiabi.forEach(selectId => {
    const select = document.getElementById(selectId);
    if (select) {
      select.innerHTML = '<option value="">--Seleccione--</option>';
      importExcelHeaders.forEach(header => {
        const option = document.createElement('option');
        option.value = header;
        option.textContent = header;
        select.appendChild(option);
      });
      autoSelectMappingOptiabi(select, selectId);
    }
  });
}

// Auto-seleccionar mapeo basado en nombres similares
function autoSelectMapping(select, selectId) {
  const fieldName = selectId.replace('map', '').toLowerCase();
  const mappings = {
    'subcodigo': ['codigo', 'subcodigo', 'sub_codigo', 'sku', 'id'],
    'descripcion': ['descripcion', 'nombre', 'producto', 'articulo', 'description'],
    'marca': ['marca', 'brand'],
    'modelo': ['modelo', 'model'],
    'familia': ['familia', 'family'],
    'linea': ['linea', 'linea', 'line'],
    'categoria': ['categoria', 'category', 'tipo'],
    'ubicacion': ['ubicacion', 'location', 'almacen'],
    'material': ['material'],
    'unidadmedida': ['unidad', 'unidad_medida', 'um', 'unit'],
    'talla': ['talla', 'size', 'tama√±o'],
    'caracteristica': ['caracteristica', 'feature', 'detalle'],
    'stock': ['stock', 'cantidad', 'qty', 'existencia'],
    'preciocompra': ['costo', 'precio_compra', 'cost', 'precio_costo'],
    'precioventa': ['precio', 'precio_venta', 'price', 'pvp'],
    'precioventamedio': ['precio_medio', 'precio_mayorista'],
    'precioventaminimo': ['precio_minimo', 'precio_min']
  };

  const possibleNames = mappings[fieldName] || [];

  for (const option of select.options) {
    const optionValue = option.value.toLowerCase().replace(/[_\s]/g, '');
    for (const name of possibleNames) {
      if (optionValue.includes(name.replace(/[_\s]/g, ''))) {
        select.value = option.value;
        return;
      }
    }
  }
}

// Auto-seleccionar mapeo para CLIENTES
function autoSelectMappingClientes(select, selectId) {
  const fieldName = selectId.replace('mapCli', '').toLowerCase();
  const mappings = {
    'nombre': ['nombre', 'nombres', 'cliente', 'razon_social', 'razonsocial', 'name', 'first_name', 'firstname'],
    'apellido': ['apellido', 'apellidos', 'apellidopaterno', 'apellidomaterno', 'lastname', 'last_name', 'surname'],
    'dni': ['dni', 'documento', 'doc', 'ruc', 'cedula', 'nit', 'id_cliente', 'num_documento'],
    'celular': ['celular', 'telefono', 'phone', 'tel', 'movil', 'mobile', 'cel', 'fono', 'contacto'],
    'email': ['email', 'correo', 'mail', 'e-mail', 'email_cliente', 'correoelectronico'],
    'direccion': ['direccion', 'address', 'dir', 'domicilio', 'ubicacion'],
    'ciudad': ['ciudad', 'distrito', 'provincia', 'city', 'localidad', 'municipio'],
    'fechanac': ['fecha_nacimiento', 'fechanacimiento', 'nacimiento', 'birthday', 'fecha_nac', 'fnac', 'birth'],
    'observaciones': ['observaciones', 'notas', 'notes', 'comentario', 'obs', 'descripcion']
  };

  const possibleNames = mappings[fieldName] || [];

  for (const option of select.options) {
    const optionValue = option.value.toLowerCase().replace(/[_\s-]/g, '');
    for (const name of possibleNames) {
      if (optionValue.includes(name.replace(/[_\s-]/g, ''))) {
        select.value = option.value;
        return;
      }
    }
  }
}

// Auto-seleccionar mapeo para PRESCRIPCIONES
function autoSelectMappingPrescripciones(select, selectId) {
  const fieldName = selectId.replace('mapRx', '').toLowerCase();
  const mappings = {
    'codigo': ['codigo', 'code', 'id', 'receta', 'rx'],
    'paciente': ['paciente', 'cliente', 'patient', 'name', 'nombre_completo', 'fullname'],
    'fecha': ['fecha', 'date', 'fecha_receta', 'fecha_rx'],
    'especialista': ['especialista', 'doctor', 'medico', 'physician', 'optometrista', 'oftalmologo'],
    'odesf': ['od_esf', 'odesf', 'od esf', 'esfera od', 'esfera_od', 'sphere_od', 'od sphere'],
    'odcil': ['od_cil', 'odcil', 'od cil', 'cilindro od', 'cilindro_od', 'cylinder_od', 'od cylinder'],
 'odeje': ['od_eje', 'odeje', 'od eje', 'eje od', 'eje_od', 'axis_od', 'od axis'],
    'odadd': ['od_add', 'odadd', 'od add', 'add od', 'adicion_od', 'addition_od', 'od addition'],
    'oiesf': ['oi_esf', 'oiesf', 'oi esf', 'esfera oi', 'esfera_oi', 'sphere_oi', 'oi sphere', 'os_esf'],
    'oicil': ['oi_cil', 'oicil', 'oi cil', 'cilindro oi', 'cilindro_oi', 'cylinder_oi', 'oi cylinder', 'os_cil'],
    'oieje': ['oi_eje', 'oieje', 'oi eje', 'eje oi', 'eje_oi', 'axis_oi', 'oi axis', 'os_axis'],
    'oiadd': ['oi_add', 'oiadd', 'oi add', 'add oi', 'adicion_oi', 'addition_oi', 'oi addition', 'os_add'],
    'dip': ['dip', 'dp', 'distancia_pupilar', 'distancia pupilar', 'pd', 'pupillary_distance'],
    'observaciones': ['observaciones', 'notas', 'notes', 'comentarios', 'obs', 'remarks']
  };

  const possibleNames = mappings[fieldName] || [];

  for (const option of select.options) {
    const optionValue = option.value.toLowerCase().replace(/[_\s-]/g, '');
    for (const name of possibleNames) {
      if (optionValue.includes(name.replace(/[_\s-]/g, ''))) {
        select.value = option.value;
        return;
      }
    }
  }
}

// Auto-seleccionar mapeo para PDFs (MEJORADO PARA TABLA)
function autoSelectMappingPdf(select, selectId) {
  const fieldName = selectId.replace('mapPdf', '').toLowerCase();
  const mappings = {
    'paciente': ['paciente', 'cliente', 'patient', 'name', 'nombre', 'apellidos', 'nombres'],
    'edad': ['edad', 'age', 'anos', 'years'],
    'fecha': ['fecha', 'date', 'fecha_receta', 'fechaventa'],
    'odesf': ['od_esf', 'odesf', 'od esf', 'esfera od', 'esfera_od'],
    'odcil': ['od_cil', 'odcil', 'od cil', 'cilindro od', 'cilindro_od'],
    'odeje': ['od_eje', 'odeje', 'od eje', 'eje od', 'eje_od'],
    'odadd': ['od_add', 'odadd', 'od add', 'add od', 'adicion_od'],
    'oiesf': ['oi_esf', 'oiesf', 'oi esf', 'esfera oi', 'esfera_oi'],
    'oicil': ['oi_cil', 'oicil', 'oi cil', 'cilindro oi', 'cilindro_oi'],
    'oieje': ['oi_eje', 'oieje', 'oi eje', 'eje oi', 'eje_oi'],
    'oiadd': ['oi_add', 'oiadd', 'oi add', 'add oi', 'adicion_oi'],
    'montura': ['montura', 'monturas', 'frame', 'armazon', 'marco'],
    'cristales': ['cristales', 'cristal', 'lentes', 'lens'],
    'precio': ['precio', 'total', 'costo', 'price', 'amount'],
    'observaciones': ['observaciones', 'notas', 'notes', 'comentarios', 'obs', 'adelanto', 'adlant', 'deuda']
  };

  const possibleNames = mappings[fieldName] || [];

  for (const option of select.options) {
    const optionValue = option.value.toLowerCase().replace(/[_\s-]/g, '');
    for (const name of possibleNames) {
      if (optionValue.includes(name.replace(/[_\s-]/g, ''))) {
        select.value = option.value;
        return;
      }
    }
  }
}

// Auto-seleccionar mapeo para OPTIABI
function autoSelectMappingOptiabi(select, selectId) {
  const fieldName = selectId.replace('mapOptiabi', '').toLowerCase();
  const mappings = {
    'apellidos': ['apellidos', 'nombres', 'apellidosynombres', 'apellidosynombre', 'paciente', 'cliente', 'patient', 'name'],
    'edad': ['edad', 'age', 'anos', 'years'],
    'od': ['od', 'o.d', 'o-d', 'o_d', 'ojoderecho', 'ojo derecho', 'right eye'],
    'oi': ['oi', 'o.i', 'o-i', 'o_i', 'ojoizquierdo', 'ojo izquierdo', 'left eye', 'os'],
    'monturas': ['monturas', 'montura', 'frame', 'armazon', 'marco'],
    'cristales': ['cristales', 'cristal', 'lentes', 'lens', 'lunas'],
    'precio': ['precio', 'total', 'costo', 'price', 'amount', 'monto'],
    'adelanto': ['adelanto', 'adelant', 'adlant', 'pago', 'anticipo', 'acuenta', 'a cuenta'],
    'deuda': ['deuda', 'saldo', 'pendiente', 'debe', 'balance'],
    'fechaventa': ['fecha', 'fechaventa', 'fecha venta', 'fechadeventa', 'date', 'fecha de venta'],
    'documento': ['documento', 'dni', 'doc', 'cedula', 'id', 'identification'],
    'telefono': ['telefono', 'celular', 'phone', 'tel', 'movil'],
    'direccion': ['direccion', 'address', 'domicilio', 'calle'],
    'observaciones': ['observaciones', 'notas', 'notes', 'comentarios', 'obs', 'remarks', 'observacion']
  };

  const possibleNames = mappings[fieldName] || [];

  for (const option of select.options) {
    const optionValue = option.value.toLowerCase().replace(/[_\s.-]/g, '');
    for (const name of possibleNames) {
      if (optionValue.includes(name.replace(/[_\s.-]/g, ''))) {
        select.value = option.value;
        return;
      }
    }
  }
}

// Navegaci√≥n del wizard
function importWizardNext() {
  if (importCurrentStep === 0) {
    // Paso 0 -> 1: Ir a cargar archivo
    setImportStep(1);
  } else if (importCurrentStep === 1) {
    // Paso 1 -> 2: Validar que hay datos cargados
    if (importExcelData.length === 0) {
      toast('Debe cargar un archivo Excel primero', 'warning');
      return;
    }
    // Mostrar/ocultar mapeos seg√∫n tipo
    document.getElementById('mappingProductos').style.display = importType === 'productos' ? 'flex' : 'none';
    document.getElementById('mappingClientes').style.display = importType === 'clientes' ? 'flex' : 'none';
    document.getElementById('mappingPrescripciones').style.display = importType === 'prescripciones' ? 'flex' : 'none';
    document.getElementById('mappingPdf').style.display = importType === 'pdf' ? 'flex' : 'none';
    document.getElementById('mappingOptiabi').style.display = importType === 'optiabi' ? 'flex' : 'none';
    setImportStep(2);
  } else if (importCurrentStep === 2) {
    // Paso 2 -> 3: Validar mapeo m√≠nimo seg√∫n tipo
    if (importType === 'productos') {
      const descripcion = document.getElementById('mapDescripcion').value;
      if (!descripcion) {
        toast('Debe mapear al menos el campo Descripci√≥n', 'warning');
        return;
      }
    } else if (importType === 'clientes') {
      const nombre = document.getElementById('mapCliNombre').value;
      if (!nombre) {
        toast('Debe mapear al menos el campo Nombre', 'warning');
        return;
      }
    } else if (importType === 'prescripciones') {
      const paciente = document.getElementById('mapRxPaciente').value;
      if (!paciente) {
        toast('Debe mapear al menos el campo Paciente', 'warning');
        return;
      }
    } else if (importType === 'pdf') {
      const paciente = document.getElementById('mapPdfPaciente').value;
      if (!paciente) {
        toast('Debe mapear al menos el campo Paciente', 'warning');
        return;
      }
    }
    setImportStep(3);
  }
}

function importWizardPrev() {
  if (importCurrentStep > 0) {
    setImportStep(importCurrentStep - 1);
  }
}

function setImportStep(step) {
  importCurrentStep = step;

  // Ocultar todos los contenidos
  document.querySelectorAll('.wizard-content').forEach(el => el.classList.remove('active'));

  // Mostrar el paso actual
  document.getElementById('importPaso' + step).classList.add('active');

  // Actualizar indicadores de pasos
  for (let i = 1; i <= 3; i++) {
    const stepEl = document.getElementById('wizardStep' + i);
    if (stepEl) {
      stepEl.classList.remove('active', 'completed');
      if (i < step || (step === 3 && i <= 3)) {
        if (i < step) stepEl.classList.add('completed');
        if (i === step || (step === 0 && i === 1)) stepEl.classList.add('active');
      }
      if (i === step) stepEl.classList.add('active');
    }
  }

  // Mostrar/ocultar botones de navegaci√≥n
  const btnPrev = document.getElementById('btnImportPrev');
  const btnNext = document.getElementById('btnImportNext');

  if (btnPrev) {
    btnPrev.style.visibility = step > 0 ? 'visible' : 'hidden';
  }

  if (btnNext) {
    btnNext.style.display = step < 3 ? 'inline-flex' : 'none';
  }

  // Actualizar texto del Paso 3 seg√∫n el tipo de importaci√≥n
  if (step === 3) {
    const warningText = document.querySelector('#importPaso3 p.text-warning');
    if (warningText) {
      if (importType === 'clientes') {
        warningText.innerHTML = '<strong>Estimado usuario debe haber revisado los datos detalladamente ya que esta operaci√≥n es irreversible, solo se importar√°n los datos de los clientes</strong>';
      } else if (importType === 'prescripciones') {
        warningText.innerHTML = '<strong>Estimado usuario debe haber revisado los datos detalladamente ya que esta operaci√≥n es irreversible, solo se importar√°n las prescripciones/recetas. El campo Paciente se dividir√° autom√°ticamente en Nombre y Apellido.</strong>';
      } else {
        warningText.innerHTML = '<strong>Estimado usuario debe haber revisado los datos detalladamente ya que esta operaci√≥n es irreversible, solo se importar√°n los datos de los productos</strong>';
      }
    }
  }
}

// Procesar la importaci√≥n
function procesarImportacion() {
  if (importProcessing) {
    toast('Ya hay un proceso en ejecuci√≥n', 'warning');
    return;
  }

  if (importExcelData.length === 0) {
    toast('No hay datos para procesar', 'error');
    return;
  }

  // Delegar a la funci√≥n espec√≠fica seg√∫n el tipo
  if (importType === 'clientes') {
    procesarImportacionClientes();
  } else if (importType === 'prescripciones') {
    procesarImportacionPrescripciones();
  } else if (importType === 'pdf') {
    procesarImportacionPDF();
  } else if (importType === 'optiabi') {
    procesarImportacionOptiabi();
  } else {
    procesarImportacionProductos();
  }
}

// Procesar la importaci√≥n de PRODUCTOS
function procesarImportacionProductos() {
  importProcessing = true;

  const salidaProcesados = document.getElementById('importSalidaProcesados');
  const salidaErrores = document.getElementById('importSalidaErrores');
  const existentesBody = document.getElementById('importExistentesBody');
  const progressBar = document.getElementById('importProgressBar');
  const resultMessage = document.getElementById('importResultMessage');

  // Limpiar outputs
  salidaProcesados.innerHTML = 'Procesando.. por favor espere...';
  salidaErrores.innerHTML = '';
  existentesBody.innerHTML = '';
  progressBar.style.width = '0%';
  resultMessage.style.display = 'none';

  // Obtener mapeos
  const mapping = {
    subCodigo: document.getElementById('mapSubCodigo').value,
    descripcion: document.getElementById('mapDescripcion').value,
    marca: document.getElementById('mapMarca').value,
    modelo: document.getElementById('mapModelo').value,
    familia: document.getElementById('mapFamilia').value,
    linea: document.getElementById('mapLinea').value,
    categoria: document.getElementById('mapCategoria').value,
    ubicacion: document.getElementById('mapUbicacion').value,
    material: document.getElementById('mapMaterial').value,
    unidadMedida: document.getElementById('mapUnidadMedida').value,
    talla: document.getElementById('mapTalla').value,
    caracteristica: document.getElementById('mapCaracteristica').value,
    stock: document.getElementById('mapStock').value,
    precioCompra: document.getElementById('mapPrecioCompra').value,
    precioVenta: document.getElementById('mapPrecioVenta').value,
    precioVentaMedio: document.getElementById('mapPrecioVentaMedio').value,
    precioVentaMinimo: document.getElementById('mapPrecioVentaMinimo').value
  };

  const noIngresarDuplicados = document.getElementById('importNoIngresarDuplicados').checked;

  // Cargar productos existentes
  let productos = load(DB.PRODUCTOS);
  const codigosExistentes = new Set(productos.map(p => p.codigo).filter(Boolean));

  let procesados = 0;
  let errores = [];
  let existentes = [];
  let nuevosProductos = [];

  const total = importExcelData.length;

  // Procesar en chunks para no bloquear la UI
  let index = 0;

  function procesarChunk() {
    const chunkSize = 50;
    const endIndex = Math.min(index + chunkSize, total);

    for (; index < endIndex; index++) {
      const row = importExcelData[index];

      try {
        const codigo = mapping.subCodigo ? (row[mapping.subCodigo] || '').toString().trim() : '';
        const descripcion = mapping.descripcion ? (row[mapping.descripcion] || '').toString().trim() : '';

        if (!descripcion) {
          errores.push(`Fila ${index + 2}: Sin descripci√≥n`);
          continue;
        }

        // Verificar si existe
        if (codigo && codigosExistentes.has(codigo)) {
          existentes.push(codigo);
          if (noIngresarDuplicados) {
            continue;
          }
        }

        // Crear nuevo producto
        const nuevoProducto = {
          id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
          codigo: codigo || generarCodigoProducto(),
          nombre: descripcion,
          marca: mapping.marca ? row[mapping.marca] || '' : '',
          modelo: mapping.modelo ? row[mapping.modelo] || '' : '',
          familia: mapping.familia ? row[mapping.familia] || '' : '',
          linea: mapping.linea ? row[mapping.linea] || '' : '',
          categoria: mapping.categoria ? row[mapping.categoria] || '' : '',
          ubicacion: mapping.ubicacion ? row[mapping.ubicacion] || '' : '',
          material: mapping.material ? row[mapping.material] || '' : '',
          unidadMedida: mapping.unidadMedida ? row[mapping.unidadMedida] || 'UND' : 'UND',
          talla: mapping.talla ? row[mapping.talla] || '' : '',
          caracteristica: mapping.caracteristica ? row[mapping.caracteristica] || '' : '',
          stock: mapping.stock ? parseInt(row[mapping.stock]) || 0 : 0,
          precioCompra: mapping.precioCompra ? parseFloat(row[mapping.precioCompra]) || 0 : 0,
          precio: mapping.precioVenta ? parseFloat(row[mapping.precioVenta]) || 0 : 0,
          precioMedio: mapping.precioVentaMedio ? parseFloat(row[mapping.precioVentaMedio]) || 0 : 0,
          precioMinimo: mapping.precioVentaMinimo ? parseFloat(row[mapping.precioVentaMinimo]) || 0 : 0,
          fechaRegistro: new Date().toISOString().split('T')[0]
        };

        nuevosProductos.push(nuevoProducto);
        codigosExistentes.add(nuevoProducto.codigo);
        procesados++;

      } catch (error) {
        errores.push(`Fila ${index + 2}: ${error.message}`);
      }
    }

    // Actualizar progreso
    const progress = Math.round((index / total) * 100);
    progressBar.style.width = progress + '%';

    if (index < total) {
      // Continuar procesando
      setTimeout(procesarChunk, 10);
    } else {
      // Finalizar
      finalizarImportacion(nuevosProductos, procesados, errores, existentes);
    }
  }

  procesarChunk();
}

function generarCodigoProducto() {
  return 'PROD-' + Date.now().toString().slice(-8);
}

function finalizarImportacion(nuevosProductos, procesados, errores, existentes) {
  const salidaProcesados = document.getElementById('importSalidaProcesados');
  const salidaErrores = document.getElementById('importSalidaErrores');
  const existentesBody = document.getElementById('importExistentesBody');
  const progressBar = document.getElementById('importProgressBar');
  const resultMessage = document.getElementById('importResultMessage');

  // Guardar nuevos productos
  if (nuevosProductos.length > 0) {
    let productos = load(DB.PRODUCTOS);
    productos = productos.concat(nuevosProductos);
    save(DB.PRODUCTOS, productos);

    // Registrar movimientos en kardex
    const movimientos = load(DB.MOVIMIENTOS);
    nuevosProductos.forEach(prod => {
      if (prod.stock > 0) {
        movimientos.push({
          id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
          fecha: new Date().toISOString().split('T')[0],
          tipo: 'ENTRADA',
          motivo: 'IMPORTACI√ìN EXCEL',
          productoId: prod.id,
          producto: prod.nombre,
          cantidad: prod.stock,
          stockAnterior: 0,
          stockNuevo: prod.stock,
          documento: 'IMP-' + Date.now().toString().slice(-6),
          usuario: 'SISTEMA'
        });
      }
    });
    save(DB.MOVIMIENTOS, movimientos);
  }

  // Mostrar resultados
  progressBar.style.width = '100%';

  salidaProcesados.innerHTML = `Procesando.. por favor espere...√âxito : Proceso Finalizado..... :D<br><br>` +
    `‚úÖ Productos importados: ${procesados}<br>` +
    `üì¶ Stock actualizado en Kardex`;

  if (errores.length > 0) {
    salidaErrores.innerHTML = errores.slice(0, 50).join('<br>');
    if (errores.length > 50) {
      salidaErrores.innerHTML += `<br>... y ${errores.length - 50} errores m√°s`;
    }
  } else {
    salidaErrores.innerHTML = '<span style="color: #22c55e;">Sin errores</span>';
  }

  // Mostrar existentes
  existentes.slice(0, 50).forEach(codigo => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>‚úì</td><td>${codigo}</td>`;
    existentesBody.appendChild(tr);
  });

  // Mensaje de resultado
  resultMessage.style.display = 'block';
  if (procesados > 0) {
    resultMessage.className = 'import-result-message success';
    resultMessage.innerHTML = `‚úÖ Se ha generado un excel en la misma ruta del archivo con el nombre de "PROCESADOS"<br>` +
      `Importaci√≥n completada: ${procesados} productos agregados`;
  } else {
    resultMessage.className = 'import-result-message error';
    resultMessage.innerHTML = '‚ùå No se importaron productos. Verifique el archivo y los mapeos.';
  }

  importProcessing = false;

  // Actualizar inventario si est√° visible
  if (typeof cargarProductos === 'function') {
    cargarProductos();
  }

  toast(`Importaci√≥n finalizada: ${procesados} productos`, procesados > 0 ? 'success' : 'warning');
}

// Procesar la importaci√≥n de CLIENTES
function procesarImportacionClientes() {
  importProcessing = true;

  const salidaProcesados = document.getElementById('importSalidaProcesados');
  const salidaErrores = document.getElementById('importSalidaErrores');
  const existentesBody = document.getElementById('importExistentesBody');
  const progressBar = document.getElementById('importProgressBar');
  const resultMessage = document.getElementById('importResultMessage');

  // Limpiar outputs
  salidaProcesados.innerHTML = 'Procesando clientes.. por favor espere...';
  salidaErrores.innerHTML = '';
  existentesBody.innerHTML = '';
  progressBar.style.width = '0%';
  resultMessage.style.display = 'none';

  // Obtener mapeos de clientes
  const mapping = {
    nombre: document.getElementById('mapCliNombre').value,
    apellido: document.getElementById('mapCliApellido').value,
    dni: document.getElementById('mapCliDni').value,
    celular: document.getElementById('mapCliCelular').value,
    email: document.getElementById('mapCliEmail').value,
    direccion: document.getElementById('mapCliDireccion').value,
    ciudad: document.getElementById('mapCliCiudad').value,
    fechaNac: document.getElementById('mapCliFechaNac').value,
    observaciones: document.getElementById('mapCliObservaciones').value
  };

  const noIngresarDuplicados = document.getElementById('importNoIngresarDuplicadosCli').checked;

  // Cargar clientes existentes
  let clientes = load(DB.CLIENTES);
  const dnisExistentes = new Set(clientes.map(c => c.dni).filter(Boolean));

  let procesados = 0;
  let errores = [];
  let existentes = [];
  let nuevosClientes = [];

  const total = importExcelData.length;

  // Procesar en chunks
  let index = 0;

  function procesarChunkClientes() {
    const chunkSize = 50;
    const endIndex = Math.min(index + chunkSize, total);

    for (; index < endIndex; index++) {
      const row = importExcelData[index];

      try {
        const nombre = mapping.nombre ? (row[mapping.nombre] || '').toString().trim() : '';
        const apellido = mapping.apellido ? (row[mapping.apellido] || '').toString().trim() : '';
        const dni = mapping.dni ? (row[mapping.dni] || '').toString().trim() : '';

        if (!nombre) {
          errores.push(`Fila ${index + 2}: Sin nombre`);
          continue;
        }

        // Verificar si existe por DNI
        if (dni && dnisExistentes.has(dni)) {
          existentes.push(dni);
          if (noIngresarDuplicados) {
            continue;
          }
        }

        // Crear nuevo cliente
        const nuevoCliente = {
          id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
          nombre: nombre,
          apellido: apellido,
          dni: dni || '',
          celular: mapping.celular ? row[mapping.celular] || '' : '',
          email: mapping.email ? row[mapping.email] || '' : '',
          direccion: mapping.direccion ? row[mapping.direccion] || '' : '',
          ciudad: mapping.ciudad ? row[mapping.ciudad] || '' : '',
          fechaNacimiento: mapping.fechaNac ? row[mapping.fechaNac] || '' : '',
          observaciones: mapping.observaciones ? row[mapping.observaciones] || '' : '',
          fechaRegistro: new Date().toISOString().split('T')[0]
        };

        nuevosClientes.push(nuevoCliente);
        if (dni) dnisExistentes.add(dni);
        procesados++;

      } catch (error) {
        errores.push(`Fila ${index + 2}: ${error.message}`);
      }
    }

    // Actualizar progreso
    const progress = Math.round((index / total) * 100);
    progressBar.style.width = progress + '%';

    if (index < total) {
      // Continuar procesando
      setTimeout(procesarChunkClientes, 10);
    } else {
      // Finalizar
      finalizarImportacionClientes(nuevosClientes, procesados, errores, existentes);
    }
  }

  procesarChunkClientes();
}

function finalizarImportacionClientes(nuevosClientes, procesados, errores, existentes) {
  const salidaProcesados = document.getElementById('importSalidaProcesados');
  const salidaErrores = document.getElementById('importSalidaErrores');
  const existentesBody = document.getElementById('importExistentesBody');
  const progressBar = document.getElementById('importProgressBar');
  const resultMessage = document.getElementById('importResultMessage');

  // Guardar nuevos clientes
  if (nuevosClientes.length > 0) {
    let clientes = load(DB.CLIENTES);
    clientes = clientes.concat(nuevosClientes);
    save(DB.CLIENTES, clientes);
  }

  // Mostrar resultados
  progressBar.style.width = '100%';

  salidaProcesados.innerHTML = `Procesando.. por favor espere...√âxito : Proceso Finalizado..... :D<br><br>` +
    `‚úÖ Clientes importados: ${procesados}<br>` +
    `üë• ${nuevosClientes.length} nuevos registros agregados`;

  if (errores.length > 0) {
    salidaErrores.innerHTML = errores.slice(0, 50).join('<br>');
    if (errores.length > 50) {
      salidaErrores.innerHTML += `<br>... y ${errores.length - 50} errores m√°s`;
    }
  } else {
    salidaErrores.innerHTML = '<span style="color: #22c55e;">Sin errores</span>';
  }

  // Mostrar existentes
  existentes.slice(0, 50).forEach(dni => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>‚úì</td><td>${dni}</td>`;
    existentesBody.appendChild(tr);
  });

  // Mensaje de resultado
  resultMessage.style.display = 'block';
  if (procesados > 0) {
    resultMessage.className = 'import-result-message success';
    resultMessage.innerHTML = `‚úÖ Importaci√≥n completada: ${procesados} clientes agregados`;
  } else {
    resultMessage.className = 'import-result-message error';
    resultMessage.innerHTML = '‚ùå No se importaron clientes. Verifique el archivo y los mapeos.';
  }

  importProcessing = false;

  // Actualizar lista de clientes si est√° visible
  if (typeof cargarClientes === 'function') {
    cargarClientes();
  }

  toast(`Importaci√≥n finalizada: ${procesados} clientes`, procesados > 0 ? 'success' : 'warning');
}

// Funci√≥n para normalizar columnas de PRESCRIPCIONES - Divide nombre/apellido
function normalizeColumns(row) {
  let full = row["Paciente"] ? row["Paciente"].trim() : "";
  let partes = full.split(" ");
  let apellido = partes.pop() || "";
  let nombre = partes.join(" ") || "";

  return {
    codigo: row["Codigo"] || "",
    paciente_completo: full,
    nombre,
    apellido,
    fecha: row["Fecha"] || "",
    especialista: row["Especialista"] || "",
    od_esf: row["OD_ESF"] || "",
    od_cil: row["OD_CIL"] || "",
    od_eje: row["OD_EJE"] || "",
    od_add: row["OD_ADD"] || "",
    oi_esf: row["OI_ESF"] || "",
    oi_cil: row["OI_CIL"] || "",
    oi_eje: row["OI_EJE"] || "",
    oi_add: row["OI_ADD"] || "",
    dip: row["DIP"] || "",
    observaciones: row["Observaciones"] || ""
  };
}

// Procesar la importaci√≥n de PRESCRIPCIONES - INTEGRADO CON BUSCAR RX
function procesarImportacionPrescripciones() {
  importProcessing = true;

  const salidaProcesados = document.getElementById('importSalidaProcesados');
  const salidaErrores = document.getElementById('importSalidaErrores');
  const existentesBody = document.getElementById('importExistentesBody');
  const progressBar = document.getElementById('importProgressBar');
  const resultMessage = document.getElementById('importResultMessage');

  // Limpiar outputs
  salidaProcesados.innerHTML = 'Procesando prescripciones.. por favor espere...';
  salidaErrores.innerHTML = '';
  existentesBody.innerHTML = '';
  progressBar.style.width = '0%';
  resultMessage.style.display = 'none';

  // Obtener mapeos de prescripciones
  const mapping = {
    codigo: document.getElementById('mapRxCodigo').value,
    paciente: document.getElementById('mapRxPaciente').value,
    fecha: document.getElementById('mapRxFecha').value,
    especialista: document.getElementById('mapRxEspecialista').value,
    od_esf: document.getElementById('mapRxOdEsf').value,
    od_cil: document.getElementById('mapRxOdCil').value,
    od_eje: document.getElementById('mapRxOdEje').value,
    od_add: document.getElementById('mapRxOdAdd').value,
    oi_esf: document.getElementById('mapRxOiEsf').value,
    oi_cil: document.getElementById('mapRxOiCil').value,
    oi_eje: document.getElementById('mapRxOiEje').value,
    oi_add: document.getElementById('mapRxOiAdd').value,
    dip: document.getElementById('mapRxDip').value,
    observaciones: document.getElementById('mapRxObservaciones').value
  };

  const noIngresarDuplicados = document.getElementById('importNoIngresarDuplicadosRx').checked;

  // Cargar medidas y clientes existentes (Buscar RX usa DB.MEDIDAS)
  let medidas = load(DB.MEDIDAS);
  let clientes = load(DB.CLIENTES);
  const codigosExistentes = new Set(medidas.map(m => m.codigo).filter(Boolean));

  let procesados = 0;
  let errores = [];
  let existentes = [];
  let nuevasMedidas = [];
  let clientesCreados = 0;

  const total = importExcelData.length;

  // Procesar en chunks
  let index = 0;

  function procesarChunkPrescripciones() {
    const chunkSize = 50;
    const endIndex = Math.min(index + chunkSize, total);

    for (; index < endIndex; index++) {
      const row = importExcelData[index];

      try {
        const pacienteCompleto = mapping.paciente ? (row[mapping.paciente] || '').toString().trim() : '';
        const fecha = mapping.fecha ? (row[mapping.fecha] || '').toString().trim() : '';

        // Validaciones obligatorias
        if (!pacienteCompleto) {
          errores.push(`Fila ${index + 2}: Sin nombre de paciente`);
          continue;
        }

        if (!fecha) {
          errores.push(`Fila ${index + 2}: Sin fecha`);
          continue;
        }

        const codigo = mapping.codigo ? (row[mapping.codigo] || '').toString().trim() : '';

        // Verificar si existe por c√≥digo
        if (codigo && codigosExistentes.has(codigo)) {
          existentes.push(codigo);
          if (noIngresarDuplicados) {
            continue;
          }
        }

        // Buscar o crear cliente (usando nombre completo SIN dividir)
        let cliente = clientes.find(c => {
          const nombreCompletoCliente = (c.nombres + ' ' + (c.apellidos || '')).trim();
          return nombreCompletoCliente.toLowerCase() === pacienteCompleto.toLowerCase() ||
                 c.nombres?.toLowerCase() === pacienteCompleto.toLowerCase();
        });

        if (!cliente) {
          // Crear nuevo cliente con nombre completo (sin dividir)
          cliente = {
            id: 'CLI_' + Date.now().toString() + '_' + Math.random().toString(36).substr(2, 6),
            codigo: 'C-' + Date.now().toString().slice(-6),
            tipo: 'PN',
            nombres: pacienteCompleto,  // ‚úÖ NOMBRE COMPLETO sin dividir
            apellidos: '',  // ‚úÖ Vac√≠o porque ya est√° todo en "nombres"
            documento: '',
            telefono: '',
            direccion: '',
            fechaRegistro: new Date().toISOString().split('T')[0]
          };
          clientes.push(cliente);
          clientesCreados++;
        }

        // Crear nueva medida/prescripci√≥n compatible con Buscar RX
        const rxId = 'RX_' + Date.now().toString() + '_' + Math.random().toString(36).substr(2, 6);
        const nuevaMedida = {
          id: rxId,
          clienteId: cliente.id,
          codigo: codigo || Date.now().toString().slice(-8),
          fecha: fecha,
          especialista: mapping.especialista ? row[mapping.especialista] || '' : '',
          tipo: 'PROPIA',

          // Visi√≥n de Lejos (mapear desde Excel)
          lejosOdEsf: mapping.od_esf ? row[mapping.od_esf] || '' : '',
          lejosOdCil: mapping.od_cil ? row[mapping.od_cil] || '' : '',
          lejosOdEje: mapping.od_eje ? row[mapping.od_eje] || '' : '',
          lejosOdAdd: mapping.od_add ? row[mapping.od_add] || '' : '',
          lejosDip: mapping.dip ? row[mapping.dip] || '' : '',

          lejosOiEsf: mapping.oi_esf ? row[mapping.oi_esf] || '' : '',
          lejosOiCil: mapping.oi_cil ? row[mapping.oi_cil] || '' : '',
          lejosOiEje: mapping.oi_eje ? row[mapping.oi_eje] || '' : '',
          lejosOiAdd: mapping.oi_add ? row[mapping.oi_add] || '' : '',

          // Observaciones
          rxObservacion: mapping.observaciones ? row[mapping.observaciones] || '' : '',

          // Campos vac√≠os para compatibilidad
          lejosOdAv: '',
          lejosOiAv: '',
          lejosOdNp: '',
          lejosOiNp: '',
          lejosOdPrisma: '',
          lejosOiPrisma: '',

          fechaCreacion: new Date().toISOString()
        };

        nuevasMedidas.push(nuevaMedida);
        codigosExistentes.add(nuevaMedida.codigo);
        procesados++;

      } catch (error) {
        errores.push(`Fila ${index + 2}: ${error.message}`);
      }
    }

    // Actualizar progreso
    const progress = Math.round((index / total) * 100);
    progressBar.style.width = progress + '%';

    if (index < total) {
      // Continuar procesando
      setTimeout(procesarChunkPrescripciones, 10);
    } else {
      // Finalizar y guardar
      finalizarImportacionPrescripciones(nuevasMedidas, clientes, procesados, errores, existentes, clientesCreados);
    }
  }

  procesarChunkPrescripciones();
}

function finalizarImportacionPrescripciones(nuevasMedidas, clientes, procesados, errores, existentes, clientesCreados) {
  const salidaProcesados = document.getElementById('importSalidaProcesados');
  const salidaErrores = document.getElementById('importSalidaErrores');
  const existentesBody = document.getElementById('importExistentesBody');
  const progressBar = document.getElementById('importProgressBar');
  const resultMessage = document.getElementById('importResultMessage');

  // Guardar clientes actualizados (nuevos + existentes)
  save(DB.CLIENTES, clientes);

  // Guardar nuevas medidas/prescripciones en DB.MEDIDAS (compatible con Buscar RX)
  if (nuevasMedidas.length > 0) {
    let medidas = load(DB.MEDIDAS);
    medidas = medidas.concat(nuevasMedidas);
    save(DB.MEDIDAS, medidas);
  }

  // Mostrar resultados
  progressBar.style.width = '100%';

  salidaProcesados.innerHTML = `‚úÖ Proceso Finalizado con √âxito<br><br>` +
    `üìä <strong>Prescripciones importadas:</strong> ${procesados}<br>` +
    `üëì <strong>Nuevas en Buscar RX:</strong> ${nuevasMedidas.length}<br>` +
    `üë• <strong>Clientes creados:</strong> ${clientesCreados} (con nombre completo)<br>` +
    `‚ú® <strong>Los nombres NO fueron divididos</strong> - aparecer√°n completos en Buscar RX<br>` +
    `üìã Integrado al 100% con "Buscar RX"`;

  if (errores.length > 0) {
    salidaErrores.innerHTML = errores.slice(0, 50).join('<br>');
    if (errores.length > 50) {
      salidaErrores.innerHTML += `<br>... y ${errores.length - 50} errores m√°s`;
    }
  } else {
    salidaErrores.innerHTML = '<span style="color: #22c55e;">Sin errores</span>';
  }

  // Mostrar existentes
  existentes.slice(0, 50).forEach(codigo => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>‚úì</td><td>${codigo}</td>`;
    existentesBody.appendChild(tr);
  });

  // Mensaje de resultado
  resultMessage.style.display = 'block';
  if (procesados > 0) {
    resultMessage.className = 'import-result-message success';
    resultMessage.innerHTML = `‚úÖ Importaci√≥n completada: ${procesados} prescripciones en "Buscar RX"<br>` +
      `Los registros ahora aparecer√°n en el m√≥dulo "Buscar RX" junto con las prescripciones creadas manualmente`;
  } else {
    resultMessage.className = 'import-result-message error';
    resultMessage.innerHTML = '‚ùå No se importaron prescripciones. Verifique el archivo y los mapeos.';
  }

  importProcessing = false;

  toast(`‚úÖ ${procesados} prescripciones importadas a Buscar RX`, procesados > 0 ? 'success' : 'warning');
}

// ============================================
// PROCESAR IMPORTACI√ìN DE PDFs
// ============================================
function procesarImportacionPDF() {
  importProcessing = true;

  const salidaProcesados = document.getElementById('importSalidaProcesados');
  const salidaErrores = document.getElementById('importSalidaErrores');
  const existentesBody = document.getElementById('importExistentesBody');
  const progressBar = document.getElementById('importProgressBar');
  const resultMessage = document.getElementById('importResultMessage');

  // Limpiar outputs
  salidaProcesados.innerHTML = 'Procesando datos del PDF... por favor espere...';
  salidaErrores.innerHTML = '';
  existentesBody.innerHTML = '';
  progressBar.style.width = '0%';
  resultMessage.style.display = 'none';

  // Obtener mapeos de PDF
  const mapping = {
    paciente: document.getElementById('mapPdfPaciente').value,
    edad: document.getElementById('mapPdfEdad').value,
    fecha: document.getElementById('mapPdfFecha').value,
    od_esf: document.getElementById('mapPdfOdEsf').value,
    od_cil: document.getElementById('mapPdfOdCil').value,
    od_eje: document.getElementById('mapPdfOdEje').value,
    od_add: document.getElementById('mapPdfOdAdd').value,
    oi_esf: document.getElementById('mapPdfOiEsf').value,
    oi_cil: document.getElementById('mapPdfOiCil').value,
    oi_eje: document.getElementById('mapPdfOiEje').value,
    oi_add: document.getElementById('mapPdfOiAdd').value,
    montura: document.getElementById('mapPdfMontura').value,
    cristales: document.getElementById('mapPdfCristales').value,
    precio: document.getElementById('mapPdfPrecio').value,
    observaciones: document.getElementById('mapPdfObservaciones').value
  };

  // Cargar medidas y clientes existentes
  let medidas = load(DB.MEDIDAS);
  let clientes = load(DB.CLIENTES);

  let procesados = 0;
  let errores = [];
  let nuevasMedidas = [];
  let clientesCreados = 0;

  const total = importExcelData.length;

  // Procesar en chunks
  let index = 0;

  function procesarChunkPDF() {
    const chunkSize = 50;
    const endIndex = Math.min(index + chunkSize, total);

    for (; index < endIndex; index++) {
      const row = importExcelData[index];

      try {
        const pacienteCompleto = mapping.paciente ? (row[mapping.paciente] || '').toString().trim() : '';

        // Validaci√≥n obligatoria
        if (!pacienteCompleto) {
          errores.push(`Registro ${index + 1}: Sin nombre de paciente`);
          continue;
        }

        // Obtener fecha (usar fecha actual si no hay)
        let fecha = mapping.fecha ? (row[mapping.fecha] || '').toString().trim() : '';
        if (!fecha) {
          fecha = new Date().toISOString().split('T')[0];
        }

        // Buscar o crear cliente (usando nombre completo SIN dividir)
        let cliente = clientes.find(c => {
          const nombreCompletoCliente = (c.nombres + ' ' + (c.apellidos || '')).trim();
          return nombreCompletoCliente.toLowerCase() === pacienteCompleto.toLowerCase() ||
                 c.nombres?.toLowerCase() === pacienteCompleto.toLowerCase();
        });

        if (!cliente) {
          // Crear nuevo cliente con nombre completo
          cliente = {
            id: 'CLI_' + Date.now().toString() + '_' + Math.random().toString(36).substr(2, 6),
            codigo: 'C-' + Date.now().toString().slice(-6),
            tipo: 'PN',
            nombres: pacienteCompleto,
            apellidos: '',
            documento: '',
            telefono: '',
            direccion: '',
            fechaRegistro: new Date().toISOString().split('T')[0]
          };
          clientes.push(cliente);
          clientesCreados++;
        }

        // Crear nueva medida/prescripci√≥n desde PDF
        const rxId = 'RX_PDF_' + Date.now().toString() + '_' + Math.random().toString(36).substr(2, 6);
        const nuevaMedida = {
          id: rxId,
          clienteId: cliente.id,
          codigo: 'PDF-' + Date.now().toString().slice(-8) + '-' + (index + 1),
          fecha: fecha,
          especialista: '',
          tipo: 'PROPIA',

          // Visi√≥n de Lejos (desde PDF)
          lejosOdEsf: mapping.od_esf ? row[mapping.od_esf] || '' : '',
          lejosOdCil: mapping.od_cil ? row[mapping.od_cil] || '' : '',
          lejosOdEje: mapping.od_eje ? row[mapping.od_eje] || '' : '',
          lejosOdAdd: mapping.od_add ? row[mapping.od_add] || '' : '',
          lejosDip: '',

          lejosOiEsf: mapping.oi_esf ? row[mapping.oi_esf] || '' : '',
          lejosOiCil: mapping.oi_cil ? row[mapping.oi_cil] || '' : '',
          lejosOiEje: mapping.oi_eje ? row[mapping.oi_eje] || '' : '',
          lejosOiAdd: mapping.oi_add ? row[mapping.oi_add] || '' : '',

          // Datos adicionales del PDF
          pdfEdad: mapping.edad ? row[mapping.edad] || '' : '',
          pdfMontura: mapping.montura ? row[mapping.montura] || '' : '',
          pdfCristales: mapping.cristales ? row[mapping.cristales] || '' : '',
          pdfPrecio: mapping.precio ? row[mapping.precio] || '' : '',

          // Observaciones
          rxObservacion: mapping.observaciones ? row[mapping.observaciones] || '' : '',

          // Campos vac√≠os para compatibilidad
          lejosOdAv: '',
          lejosOiAv: '',
          lejosOdNp: '',
          lejosOiNp: '',
          lejosOdPrisma: '',
          lejosOiPrisma: '',

          // Marcar que viene de PDF
          origen: 'PDF_IMPORT',
          fechaCreacion: new Date().toISOString()
        };

        nuevasMedidas.push(nuevaMedida);
        procesados++;

      } catch (error) {
        errores.push(`Registro ${index + 1}: ${error.message}`);
      }
    }

    // Actualizar progreso
    const progress = Math.round((index / total) * 100);
    progressBar.style.width = progress + '%';

    if (index < total) {
      // Continuar procesando
      setTimeout(procesarChunkPDF, 10);
    } else {
      // Finalizar y guardar
      finalizarImportacionPDF(nuevasMedidas, clientes, procesados, errores, clientesCreados);
    }
  }

  procesarChunkPDF();
}

function finalizarImportacionPDF(nuevasMedidas, clientes, procesados, errores, clientesCreados) {
  const salidaProcesados = document.getElementById('importSalidaProcesados');
  const salidaErrores = document.getElementById('importSalidaErrores');
  const existentesBody = document.getElementById('importExistentesBody');
  const progressBar = document.getElementById('importProgressBar');
  const resultMessage = document.getElementById('importResultMessage');

  // Guardar clientes actualizados
  save(DB.CLIENTES, clientes);

  // Guardar nuevas medidas/prescripciones desde PDF
  if (nuevasMedidas.length > 0) {
    let medidas = load(DB.MEDIDAS);
    medidas = medidas.concat(nuevasMedidas);
    save(DB.MEDIDAS, medidas);
  }

  // Mostrar resultados
  progressBar.style.width = '100%';

  salidaProcesados.innerHTML = `‚úÖ Importaci√≥n desde PDF Finalizada<br><br>` +
    `üìÑ <strong>Recetas extra√≠das del PDF:</strong> ${procesados}<br>` +
    `üëì <strong>Registradas en Buscar RX:</strong> ${nuevasMedidas.length}<br>` +
    `üë• <strong>Clientes creados:</strong> ${clientesCreados}<br>` +
    `‚ú® <strong>Datos extra√≠dos autom√°ticamente del PDF</strong><br>` +
    `üìã Integrado al 100% con "Buscar RX"`;

  if (errores.length > 0) {
    salidaErrores.innerHTML = errores.slice(0, 50).join('<br>');
    if (errores.length > 50) {
      salidaErrores.innerHTML += `<br>... y ${errores.length - 50} errores m√°s`;
    }
  } else {
    salidaErrores.innerHTML = '<span style="color: #22c55e;">Sin errores</span>';
  }

  // Mensaje de resultado
  resultMessage.style.display = 'block';
  if (procesados > 0) {
    resultMessage.className = 'import-result-message success';
    resultMessage.innerHTML = `‚úÖ Importaci√≥n completada: ${procesados} recetas desde PDF en "Buscar RX"<br>` +
      `Los datos extra√≠dos del PDF ahora aparecen en el m√≥dulo "Buscar RX"`;
  } else {
    resultMessage.className = 'import-result-message error';
    resultMessage.innerHTML = '‚ùå No se importaron recetas. Verifique el archivo PDF y los mapeos.';
  }

  importProcessing = false;

  toast(`‚úÖ ${procesados} recetas importadas desde PDF`, procesados > 0 ? 'success' : 'warning');
}

// Procesar importaci√≥n desde sistema Optiabi antiguo
function procesarImportacionOptiabi() {
  importProcessing = true;

  const salidaProcesados = document.getElementById('importSalidaProcesados');
  const salidaErrores = document.getElementById('importSalidaErrores');
  const existentesBody = document.getElementById('importExistentesBody');
  const progressBar = document.getElementById('importProgressBar');
  const resultMessage = document.getElementById('importResultMessage');

  salidaProcesados.innerHTML = 'Procesando datos de Optiabi... por favor espere...';
  salidaErrores.innerHTML = '';
  existentesBody.innerHTML = '';

  const clientes = load(DB.CLIENTES);
  const medidas = load(DB.MEDIDAS);
  const ventas = load(DB.VENTAS);
  const nuevosClientes = [];
  const nuevasMedidas = [];
  const nuevasVentas = [];
  const errores = [];
  let procesados = 0;
  let clientesCreados = 0;
  let ventasCreadas = 0;

  // Obtener mapeo de columnas desde los selectores de Optiabi
  const mapping = {
    apellidos: document.getElementById('mapOptiabiApellidos')?.value,
    edad: document.getElementById('mapOptiabiEdad')?.value,
    od: document.getElementById('mapOptiabiOd')?.value,
    oi: document.getElementById('mapOptiabiOi')?.value,
    monturas: document.getElementById('mapOptiabiMonturas')?.value,
    cristales: document.getElementById('mapOptiabiCristales')?.value,
    precio: document.getElementById('mapOptiabiPrecio')?.value,
    adelanto: document.getElementById('mapOptiabiAdelanto')?.value,
    deuda: document.getElementById('mapOptiabiDeuda')?.value,
    fechaVenta: document.getElementById('mapOptiabiFechaVenta')?.value,
    documento: document.getElementById('mapOptiabiDocumento')?.value,
    telefono: document.getElementById('mapOptiabiTelefono')?.value,
    direccion: document.getElementById('mapOptiabiDireccion')?.value,
    observaciones: document.getElementById('mapOptiabiObservaciones')?.value
  };

  // Procesar cada fila del Excel de Optiabi
  importExcelData.forEach((row, index) => {
    try {
      // Extraer nombre completo (columna "APELLIDOS Y NOMBRES" del PDF)
      let nombreCompletoOriginal = (
        row[mapping.apellidos] ||
        row['APELLIDOS Y NOMBRES'] ||
        row['Apellidos y Nombres'] ||
        row['APELLIDOS'] ||
        row['Nombre'] ||
        ''
      ).toString().trim();

      if (!nombreCompletoOriginal) {
        errores.push(`Fila ${index + 1}: Sin nombre de cliente`);
        return;
      }

      // Separar apellidos y nombres (formato t√≠pico: "APELLIDO, Nombre" o "APELLIDO Y Nombre")
      let apellidos = '';
      let nombres = '';

      if (nombreCompletoOriginal.includes(',')) {
        // Formato: "APELLIDO APELLIDO, Nombre Nombre"
        const partes = nombreCompletoOriginal.split(',');
        apellidos = partes[0].trim();
        nombres = partes.length > 1 ? partes[1].trim() : '';
      } else {
        // Sin coma: intentar separar por palabras (√∫ltimas 1-2 palabras son nombres)
        const palabras = nombreCompletoOriginal.split(/\s+/);
        if (palabras.length >= 3) {
          // Asumimos que las √∫ltimas 2 palabras son nombres
          apellidos = palabras.slice(0, -2).join(' ');
          nombres = palabras.slice(-2).join(' ');
        } else if (palabras.length === 2) {
          apellidos = palabras[0];
          nombres = palabras[1];
        } else {
          apellidos = nombreCompletoOriginal;
          nombres = '';
        }
      }

      const nombreCompleto = `${apellidos} ${nombres}`.trim();

      // Buscar o crear cliente
      let cliente = clientes.find(c => {
        const nombreC = (c.apellidos + ' ' + c.nombres).trim().toLowerCase();
        return nombreC === nombreCompleto.toLowerCase();
      });

      if (!cliente) {
        // Crear nuevo cliente
        cliente = {
          id: genId('CLI'),
          apellidos: apellidos,
          nombres: nombres,
          documento: (row[mapping.documento] || row['Documento'] || '').toString().trim(),
          telefono: (row[mapping.telefono] || row['Telefono'] || '').toString().trim(),
          email: '',
          direccion: (row[mapping.direccion] || row['Direccion'] || '').toString().trim(),
          ocupacion: '',
          edad: parseInt(row[mapping.edad] || row['Edad'] || 0) || 0,
          estado: 'H',
          fechaCreacion: new Date().toISOString()
        };
        clientes.push(cliente);
        nuevosClientes.push(cliente);
        clientesCreados++;
      }

      // Extraer medidas del OD y OI (formato del sistema antiguo)
      const odTexto = (row[mapping.od] || row['O-D'] || row['O.D'] || row['OD'] || '').toString().trim();
      const oiTexto = (row[mapping.oi] || row['O-I'] || row['O.I'] || row['OI'] || '').toString().trim();

      // Parser mejorado para m√∫ltiples formatos de medidas del sistema Optiabi
      const parsearMedida = (texto) => {
        const medida = { esf: '', cil: '', eje: '' };
        if (!texto || texto === '-' || texto.toLowerCase() === 'plano') return medida;

        // Limpiar texto
        texto = texto.toUpperCase().replace(/\s+/g, '');

        // Formato 1: "CIL-2.00X179" (solo cilindro y eje)
        let match = texto.match(/CIL([-+]?\d+\.?\d*)[Xx](\d+)/);
        if (match) {
          medida.cil = match[1];
          medida.eje = match[2];
          return medida;
        }

        // Formato 2: "ESF-0.75" o "ESF+2.00" (solo esf√©rico)
        match = texto.match(/ESF([-+]?\d+\.?\d*)/);
        if (match) {
          medida.esf = match[1];
          return medida;
        }

        // Formato 3: "+1.50-3.00X163" (esf√©rico + cilindro + eje)
        match = texto.match(/([-+]?\d+\.?\d*)([-+]\d+\.?\d*)[Xx](\d+)/);
        if (match) {
          medida.esf = match[1];
          medida.cil = match[2];
          medida.eje = match[3];
          return medida;
        }

        // Formato 4: "-2.50-1.50X179" o similares
        match = texto.match(/([-+]?\d+\.?\d*)[-+](\d+\.?\d*)[Xx](\d+)/);
        if (match) {
          medida.esf = match[1];
          medida.cil = '-' + match[2]; // Asumimos cilindro negativo
          medida.eje = match[3];
          return medida;
        }

        // Formato 5: Solo n√∫mero (asumimos esf√©rico)
        match = texto.match(/^([-+]?\d+\.?\d*)$/);
        if (match) {
          medida.esf = match[1];
          return medida;
        }

        // Formato 6: "PLANO" o vac√≠o
        if (texto === 'PLANO' || texto === '') {
          return medida;
        }

        // Si no matchea ning√∫n formato, intentar extraer n√∫meros
        const numeros = texto.match(/([-+]?\d+\.?\d*)/g);
        if (numeros && numeros.length > 0) {
          medida.esf = numeros[0] || '';
          medida.cil = numeros[1] || '';
          medida.eje = numeros[2] || '';
        }

        return medida;
      };

      const odMedida = parsearMedida(odTexto);
      const oiMedida = parsearMedida(oiTexto);

      // Extraer otros datos
      const monturas = (row[mapping.monturas] || row['Monturas'] || '').toString().trim();
      const cristales = (row[mapping.cristales] || row['Cristales'] || '').toString().trim();
      const observaciones = (row[mapping.observaciones] || row['Observacion'] || row['Observaciones. y/o tratamientos'] || '').toString().trim();
      const fechaVenta = row[mapping.fechaVenta] || row['Fecha de Venta'] || today();

      // Crear nueva medida
      const nuevaMedida = {
        id: genId('MED'),
        clienteId: cliente.id,
        codigo: `M${Date.now()}`,
        fecha: fechaVenta,
        edad: cliente.edad,
        especialista: 'IMPORTADO - SISTEMA ANTIGUO',
        tipo: 'PROPIA',

        // Visi√≥n de Lejos (OD)
        lejosOdEsf: odMedida.esf,
        lejosOdCil: odMedida.cil,
        lejosOdEje: odMedida.eje,
        lejosOdAv: '',
        lejosDip: '',
        lejosOdNp: '',
        lejosOdAdd: '',

        // Visi√≥n de Lejos (OI)
        lejosOiEsf: oiMedida.esf,
        lejosOiCil: oiMedida.cil,
        lejosOiEje: oiMedida.eje,
        lejosOiAv: '',
        lejosOiNp: '',
        lejosOiAdd: '',

        // Observaciones
        rxObservacion: observaciones,
        rxMonturas: monturas,
        rxCristales: cristales,

        // Marcar origen
        origen: 'OPTIABI_IMPORT',
        fechaCreacion: new Date().toISOString()
      };

      medidas.push(nuevaMedida);
      nuevasMedidas.push(nuevaMedida);
      procesados++;

      // Crear registro de venta si hay datos de precio
      const precioTexto = (row[mapping.precio] || row['Precio'] || row['PRECIO'] || '').toString().trim();
      const adelantoTexto = (row[mapping.adelanto] || row['Adelanto'] || row['ADELANT.'] || '').toString().trim();
      const deudaTexto = (row[mapping.deuda] || row['Deuda'] || row['DEUDA'] || '').toString().trim();

      const precio = parseFloat(precioTexto.replace(/[^\d.-]/g, '')) || 0;
      const adelanto = parseFloat(adelantoTexto.replace(/[^\d.-]/g, '')) || 0;
      const deuda = parseFloat(deudaTexto.replace(/[^\d.-]/g, '')) || 0;

      if (precio > 0) {
        const nuevaVenta = {
          id: genId('VTA'),
          clienteId: cliente.id,
          medidaId: nuevaMedida.id,
          fecha: fechaVenta,
          vendedor: 'SISTEMA ANTIGUO',

          // Productos vendidos (basados en monturas y cristales)
          productos: [],

          // Monturas si existe
          monturaSeleccionada: monturas ? {
            nombre: monturas,
            codigo: 'IMPORTADO',
            precio: 0
          } : null,

          // Lunas/Cristales si existen
          lunasVendidas: cristales ? [{
            tipo: cristales,
            precio: 0,
            cantidad: 1
          }] : [],

          // Totales
          subtotal: precio,
          descuento: 0,
          total: precio,

          // Pagos
          aPagar: precio,
          adelanto: adelanto,
          saldo: deuda || (precio - adelanto),

          metodoPago: adelanto >= precio ? 'EFECTIVO' : 'CREDITO',
          estado: deuda > 0 || (precio - adelanto) > 0 ? 'PENDIENTE' : 'PAGADO',

          // Marcar origen
          origen: 'OPTIABI_IMPORT',
          observaciones: `Importado de Optiabi - ${observaciones}`,
          fechaCreacion: new Date().toISOString()
        };

        ventas.push(nuevaVenta);
        nuevasVentas.push(nuevaVenta);
        ventasCreadas++;
      }

    } catch (error) {
      errores.push(`Fila ${index + 1}: ${error.message}`);
    }

    // Actualizar progreso
    const progress = Math.round(((index + 1) / importExcelData.length) * 100);
    progressBar.style.width = progress + '%';
  });

  // Guardar datos
  save(DB.CLIENTES, clientes);
  save(DB.MEDIDAS, medidas);
  save(DB.VENTAS, ventas);

  // Mostrar resultados
  salidaProcesados.innerHTML = `
    <p><strong>‚úÖ Importaci√≥n de Optiabi completada</strong></p>
    <ul>
      <li>Clientes nuevos: ${clientesCreados}</li>
      <li>Prescripciones importadas: ${procesados}</li>
      <li>Ventas registradas: ${ventasCreadas}</li>
      <li>Total procesado: ${importExcelData.length} registros</li>
    </ul>
  `;

  if (errores.length > 0) {
    salidaErrores.innerHTML = `<p><strong>‚ö†Ô∏è Errores encontrados (${errores.length}):</strong></p>` +
      errores.slice(0, 20).map(e => `<div>${e}</div>`).join('');
  } else {
    salidaErrores.innerHTML = '<p class="text-success">‚úÖ Sin errores</p>';
  }

  if (procesados > 0) {
    resultMessage.style.display = 'block';
    resultMessage.className = 'import-result-message success';
    resultMessage.innerHTML = `‚úÖ Importaci√≥n exitosa: ${procesados} prescripciones, ${ventasCreadas} ventas de ${clientesCreados} clientes nuevos<br>` +
      `Los datos del sistema Optiabi ahora est√°n disponibles en "Consultas", "Buscar RX" y todos los reportes`;
  } else {
    resultMessage.className = 'import-result-message error';
    resultMessage.innerHTML = '‚ùå No se importaron datos. Verifique el formato del Excel.';
  }

  importProcessing = false;
  toast(`‚úÖ ${procesados} prescripciones y ${ventasCreadas} ventas importadas de Optiabi`, 'success');
}

// Cancelar importaci√≥n
function cancelarImportacion() {
  if (importProcessing) {
    toast('Espere a que termine el proceso actual', 'warning');
    return;
  }

  // Limpiar datos
  importExcelData = [];
  importExcelHeaders = [];
  importCurrentStep = 0;
  importType = 'productos'; // Resetear al tipo por defecto

  // Resetear formulario
  document.getElementById('importArchivoExcel').value = '';
  document.getElementById('importArchivoNombre').value = '';
  document.getElementById('importPreviewArea').innerHTML = '<p class="text-center text-muted">Vista previa de datos aparecer√° aqu√≠...</p>';
  document.getElementById('importSalidaProcesados').innerHTML = '<p class="text-muted">Esperando proceso...</p>';
  document.getElementById('importSalidaErrores').innerHTML = '<p class="text-muted">Sin errores</p>';
  document.getElementById('importExistentesBody').innerHTML = '';
  document.getElementById('importProgressBar').style.width = '0%';
  document.getElementById('importResultMessage').style.display = 'none';

  // Resetear selecci√≥n de tipo de importaci√≥n
  document.querySelectorAll('.import-type-option').forEach(opt => opt.classList.remove('active'));
  const productoOption = document.querySelector('.import-type-option[data-type="productos"]');
  if (productoOption) {
    productoOption.classList.add('active');
    const radio = productoOption.querySelector('input[type="radio"]');
    if (radio) radio.checked = true;
  }

  // Volver al paso 0
  setImportStep(0);

  toast('Importaci√≥n cancelada');
}

// Cerrar wizard
function cerrarImportWizard() {
  cancelarImportacion();
  // Cambiar a otra secci√≥n
  document.querySelector('[data-section="inventario"]').click();
}

// Exportar datos procesados a CSV
function exportarProcesados() {
  const productos = load(DB.PRODUCTOS);
  if (productos.length === 0) {
    toast('No hay productos para exportar', 'warning');
    return;
  }

  const headers = ['C√≥digo', 'Descripci√≥n', 'Marca', 'Modelo', 'Familia', 'L√≠nea', 'Categor√≠a', 'Stock', 'Precio Compra', 'Precio Venta'];
  const rows = productos.map(p => [
    p.codigo || '',
    p.nombre || '',
    p.marca || '',
    p.modelo || '',
    p.familia || '',
    p.linea || '',
    p.categoria || '',
    p.stock || 0,
    p.precioCompra || 0,
    p.precio || 0
  ]);

  const csv = generarCSV(headers, rows);
  descargarCSV(csv, 'PROCESADOS.csv');
  toast('Archivo exportado');
}

// ==================== M√ìDULO DE CONFIGURACI√ìN ====================

let usuarioSeleccionadoId = null;
let correlativoSeleccionadoId = null;
let usuarioAlmacenSeleccionado = null;
let usuarioCajaSeleccionado = null;

// Navegaci√≥n de tabs de Configuraci√≥n
function mostrarConfigTab(tabId, btn) {
  document.querySelectorAll('.config-tab-content').forEach(t => {
    t.classList.remove('active');
  });
  document.querySelectorAll('.config-tab-btn').forEach(b => b.classList.remove('active'));

  const tab = document.getElementById(tabId);
  if (tab) {
    tab.classList.add('active');
  }
  if (btn) btn.classList.add('active');

  // Cargar datos seg√∫n la pesta√±a
  if (tabId === 'tabUsuarios') mostrarUsuarios();
  if (tabId === 'tabUsuariosAlmacen') cargarUsuariosAlmacen();
  if (tabId === 'tabCorrelativos') mostrarCorrelativos();
  if (tabId === 'tabUsuariosCaja') cargarUsuariosCaja();
}

// ========== GESTI√ìN DE USUARIOS ==========
function mostrarUsuarios() {
  const usuarios = load(DB.USUARIOS);
  usuarioSeleccionadoId = null;

  document.getElementById('usuariosBody').innerHTML = usuarios.map(u => {
    return '<tr onclick="seleccionarUsuario(\'' + u.id + '\')" class="' + (usuarioSeleccionadoId === u.id ? 'selected' : '') + '">' +
      '<td><input type="radio" name="selUsuario" class="config-radio" ' + (usuarioSeleccionadoId === u.id ? 'checked' : '') + '></td>' +
      '<td>' + (u.username || '') + '</td>' +
      '<td>' + (u.nombres || '') + '</td>' +
      '<td><span style="color: ' + (u.estado === 'HABILITADO' ? '#16a34a' : '#dc2626') + ';">' + (u.estado || 'DESHABILITADO') + '</span></td>' +
      '<td>' + (u.grupo || '') + '</td>' +
      '</tr>';
  }).join('');

  document.getElementById('usuariosCount').textContent = 'REGISTROS ENCONTRADOS: ' + usuarios.length;
}

function seleccionarUsuario(id) {
  usuarioSeleccionadoId = id;
  mostrarUsuarios();
}

function abrirModalUsuario(usuario = null) {
  document.getElementById('usuarioModalTitulo').textContent = usuario ? '‚úèÔ∏è Modificar Usuario' : 'üë§ Nuevo Usuario';
  document.getElementById('usuarioIdHidden').value = usuario?.id || '';
  document.getElementById('usuarioTipoDoc').value = usuario?.tipoDoc || 'DNI';
  document.getElementById('usuarioDni').value = usuario?.dni || '';
  document.getElementById('usuarioNombres').value = usuario?.nombres || '';
  document.getElementById('usuarioTelefono').value = usuario?.telefono || '';
  document.getElementById('usuarioCorreo').value = usuario?.correo || '';
  document.getElementById('usuarioDireccion').value = usuario?.direccion || '';
  document.getElementById('usuarioFechaNac').value = usuario?.fechaNac || today();
  document.getElementById('usuarioFechaInicio').value = usuario?.fechaInicio || today();
  document.getElementById('usuarioGrupo').value = usuario?.grupo || '';
  document.getElementById('usuarioEsVendedor').checked = usuario?.esVendedor || false;
  document.getElementById('usuarioEsCajero').checked = usuario?.esCajero || false;
  document.getElementById('usuarioUsername').value = usuario?.username || '';
  document.getElementById('usuarioPassword').value = '';
  document.getElementById('usuarioPasswordConfirm').value = '';

  document.getElementById('usuarioModal').showModal();
}

function modificarUsuarioSeleccionado() {
  if (!usuarioSeleccionadoId) {
    toast('Seleccione un usuario', 'warning');
    return;
  }
  const usuarios = load(DB.USUARIOS);
  const usuario = usuarios.find(u => u.id === usuarioSeleccionadoId);
  if (usuario) {
    abrirModalUsuario(usuario);
  }
}

function guardarUsuario() {
  const id = document.getElementById('usuarioIdHidden').value;
  const nombres = document.getElementById('usuarioNombres').value.trim();
  const username = document.getElementById('usuarioUsername').value.trim();
  const password = document.getElementById('usuarioPassword').value;
  const passwordConfirm = document.getElementById('usuarioPasswordConfirm').value;
  const grupo = document.getElementById('usuarioGrupo').value;

  if (!nombres) {
    toast('El nombre es requerido', 'error');
    return;
  }

  if (!username) {
    toast('El usuario es requerido', 'error');
    return;
  }

  if (!id && !password) {
    toast('La contrase√±a es requerida', 'error');
    return;
  }

  if (password && password !== passwordConfirm) {
    toast('Las contrase√±as no coinciden', 'error');
    return;
  }

  const usuarios = load(DB.USUARIOS);

  // Verificar usuario duplicado
  const duplicado = usuarios.find(u => u.username === username && u.id !== id);
  if (duplicado) {
    toast('El usuario ya existe', 'error');
    return;
  }

  const usuarioData = {
    id: id || genId('USR'),
    tipoDoc: document.getElementById('usuarioTipoDoc').value,
    dni: document.getElementById('usuarioDni').value.trim(),
    nombres: nombres,
    telefono: document.getElementById('usuarioTelefono').value.trim(),
    correo: document.getElementById('usuarioCorreo').value.trim(),
    direccion: document.getElementById('usuarioDireccion').value.trim(),
    fechaNac: document.getElementById('usuarioFechaNac').value,
    fechaInicio: document.getElementById('usuarioFechaInicio').value,
    grupo: grupo,
    esVendedor: document.getElementById('usuarioEsVendedor').checked,
    esCajero: document.getElementById('usuarioEsCajero').checked,
    username: username,
    estado: 'HABILITADO',
    almacenes: [],
    cajas: []
  };

  if (id) {
    // Modificar
    const idx = usuarios.findIndex(u => u.id === id);
    if (idx >= 0) {
      // Mantener contrase√±a anterior si no se cambi√≥
      if (password) {
        usuarioData.password = password;
      } else {
        usuarioData.password = usuarios[idx].password;
      }
      // Mantener asignaciones
      usuarioData.almacenes = usuarios[idx].almacenes || [];
      usuarioData.cajas = usuarios[idx].cajas || [];
      usuarios[idx] = usuarioData;
    }
  } else {
    // Nuevo
    usuarioData.password = password;
    usuarios.push(usuarioData);
  }

  save(DB.USUARIOS, usuarios);
  cerrarModal('usuarioModal');
  mostrarUsuarios();
  toast(id ? 'Usuario modificado' : 'Usuario creado');
}

function anularUsuarioSeleccionado() {
  if (!usuarioSeleccionadoId) {
    toast('Seleccione un usuario', 'warning');
    return;
  }

  if (!confirm('¬øEst√° seguro de cambiar el estado del usuario?')) return;

  const usuarios = load(DB.USUARIOS);
  const idx = usuarios.findIndex(u => u.id === usuarioSeleccionadoId);

  if (idx >= 0) {
    usuarios[idx].estado = usuarios[idx].estado === 'HABILITADO' ? 'DESHABILITADO' : 'HABILITADO';
    save(DB.USUARIOS, usuarios);
    mostrarUsuarios();
    toast('Estado del usuario actualizado');
  }
}

function consultarReniecUsuario() {
  const dni = document.getElementById('usuarioDni').value.trim();
  if (dni.length !== 8) {
    toast('DNI debe tener 8 d√≠gitos', 'warning');
    return;
  }
  // Simulaci√≥n - en producci√≥n conectar con API RENIEC
  toast('Funci√≥n RENIEC no disponible en modo demo', 'info');
}

// ========== GESTI√ìN DE USUARIOS CON ALMACENES ==========
function cargarUsuariosAlmacen() {
  const usuarios = load(DB.USUARIOS);
  const busqueda = (document.getElementById('buscarUsuarioAlmacen')?.value || '').toLowerCase();

  const filtrados = usuarios.filter(u =>
    u.nombres?.toLowerCase().includes(busqueda) ||
    u.username?.toLowerCase().includes(busqueda)
  );

  document.getElementById('listaUsuariosAlmacen').innerHTML = filtrados.map(u => {
    return '<div class="config-user-item ' + (usuarioAlmacenSeleccionado === u.id ? 'selected' : '') + '" onclick="seleccionarUsuarioAlmacen(\'' + u.id + '\')">' +
      '<span class="user-icon">üë§</span>' +
      '<span>' + u.username + '</span>' +
      '</div>';
  }).join('');

  // Cargar almacenes disponibles
  cargarSelectAlmacenes();

  // Si hay usuario seleccionado, mostrar sus almacenes
  if (usuarioAlmacenSeleccionado) {
    mostrarAlmacenesUsuario(usuarioAlmacenSeleccionado);
  }
}

function seleccionarUsuarioAlmacen(id) {
  usuarioAlmacenSeleccionado = id;
  cargarUsuariosAlmacen();
  mostrarAlmacenesUsuario(id);
}

function mostrarAlmacenesUsuario(userId) {
  const usuarios = load(DB.USUARIOS);
  const usuario = usuarios.find(u => u.id === userId);
  const almacenes = usuario?.almacenes || [];

  document.getElementById('listaAlmacenesUsuario').innerHTML = almacenes.map(a => {
    return '<div class="config-almacen-item">' +
      '<span>' + a + '</span>' +
      '<button class="btn btn-danger btn-sm" onclick="quitarAlmacenUsuario(\'' + a + '\')">‚ùå</button>' +
      '</div>';
  }).join('') || '<p class="text-muted" style="padding: 20px; text-align: center;">Sin almacenes asignados</p>';
}

function cargarSelectAlmacenes() {
  let almacenes = load(DB.ALMACENES);
  if (almacenes.length === 0) {
    // Crear almacenes por defecto
    almacenes = [
      { id: 'ALM1', nombre: 'PREMIUM' },
      { id: 'ALM2', nombre: 'PRINCIPAL' },
      { id: 'ALM3', nombre: 'SUCURSAL' }
    ];
    save(DB.ALMACENES, almacenes);
  }

  document.getElementById('selectAlmacenAsignar').innerHTML =
    '<option value="">-- Seleccionar Almac√©n --</option>' +
    almacenes.map(a => '<option value="' + a.nombre + '">' + a.nombre + '</option>').join('');
}

function asignarAlmacenUsuario() {
  if (!usuarioAlmacenSeleccionado) {
    toast('Seleccione un usuario', 'warning');
    return;
  }

  const almacen = document.getElementById('selectAlmacenAsignar').value;
  if (!almacen) {
    toast('Seleccione un almac√©n', 'warning');
    return;
  }

  const usuarios = load(DB.USUARIOS);
  const idx = usuarios.findIndex(u => u.id === usuarioAlmacenSeleccionado);

  if (idx >= 0) {
    if (!usuarios[idx].almacenes) usuarios[idx].almacenes = [];
    if (!usuarios[idx].almacenes.includes(almacen)) {
      usuarios[idx].almacenes.push(almacen);
      save(DB.USUARIOS, usuarios);
      mostrarAlmacenesUsuario(usuarioAlmacenSeleccionado);
      toast('Almac√©n asignado');
    } else {
      toast('El almac√©n ya est√° asignado', 'warning');
    }
  }
}

function quitarAlmacenUsuario(almacen) {
  if (!usuarioAlmacenSeleccionado) return;

  const usuarios = load(DB.USUARIOS);
  const idx = usuarios.findIndex(u => u.id === usuarioAlmacenSeleccionado);

  if (idx >= 0 && usuarios[idx].almacenes) {
    usuarios[idx].almacenes = usuarios[idx].almacenes.filter(a => a !== almacen);
    save(DB.USUARIOS, usuarios);
    mostrarAlmacenesUsuario(usuarioAlmacenSeleccionado);
    toast('Almac√©n removido');
  }
}

// ========== GESTI√ìN DE CORRELATIVOS ==========
function mostrarCorrelativos() {
  const correlativos = load(DB.CORRELATIVOS);
  correlativoSeleccionadoId = null;

  document.getElementById('correlativosBody').innerHTML = correlativos.map(c => {
    return '<tr onclick="seleccionarCorrelativo(\'' + c.id + '\')" class="' + (correlativoSeleccionadoId === c.id ? 'selected' : '') + '">' +
      '<td><input type="radio" name="selCorrelativo" class="config-radio" ' + (correlativoSeleccionadoId === c.id ? 'checked' : '') + '></td>' +
      '<td>' + (c.documento || '') + '</td>' +
      '<td>' + (c.serie || '') + '</td>' +
      '<td>' + (c.emitidos || 0) + '</td>' +
      '<td>' + (c.establecimiento || '') + '</td>' +
      '</tr>';
  }).join('');

  document.getElementById('correlativosCount').textContent = 'REGISTROS ENCONTRADOS: ' + correlativos.length;
}

function seleccionarCorrelativo(id) {
  correlativoSeleccionadoId = id;
  mostrarCorrelativos();
}

function abrirModalCorrelativo(correlativo = null) {
  document.getElementById('correlativoModalTitulo').textContent = correlativo ? '‚úèÔ∏è Modificar Correlativo' : 'üìÑ Nuevo Correlativo';
  document.getElementById('correlativoIdHidden').value = correlativo?.id || '';
  document.getElementById('correlativoDocumento').value = correlativo?.documento || '';
  document.getElementById('correlativoEstablecimiento').value = correlativo?.establecimiento || 'PREMIUM';
  document.getElementById('correlativoNombreReporte').value = correlativo?.nombreReporte || '';
  document.getElementById('correlativoSerie').value = correlativo?.serie || '';
  document.getElementById('correlativoEmitidos').value = correlativo?.emitidos || 0;
  document.getElementById('correlativoMostrarVentas').checked = correlativo?.mostrarVentas || false;
  document.getElementById('correlativoGenAuto').checked = correlativo?.genAuto !== false;

  document.getElementById('correlativoModal').showModal();
}

function modificarCorrelativoSeleccionado() {
  if (!correlativoSeleccionadoId) {
    toast('Seleccione un correlativo', 'warning');
    return;
  }
  const correlativos = load(DB.CORRELATIVOS);
  const correlativo = correlativos.find(c => c.id === correlativoSeleccionadoId);
  if (correlativo) {
    abrirModalCorrelativo(correlativo);
  }
}

function guardarCorrelativo() {
  const id = document.getElementById('correlativoIdHidden').value;
  const documento = document.getElementById('correlativoDocumento').value;
  const serie = document.getElementById('correlativoSerie').value.trim();

  if (!documento) {
    toast('Seleccione un tipo de documento', 'error');
    return;
  }

  if (!serie) {
    toast('La serie es requerida', 'error');
    return;
  }

  const correlativos = load(DB.CORRELATIVOS);

  const correlativoData = {
    id: id || genId('COR'),
    documento: documento,
    establecimiento: document.getElementById('correlativoEstablecimiento').value,
    nombreReporte: document.getElementById('correlativoNombreReporte').value.trim(),
    serie: serie,
    emitidos: parseInt(document.getElementById('correlativoEmitidos').value) || 0,
    mostrarVentas: document.getElementById('correlativoMostrarVentas').checked,
    genAuto: document.getElementById('correlativoGenAuto').checked
  };

  if (id) {
    const idx = correlativos.findIndex(c => c.id === id);
    if (idx >= 0) {
      correlativos[idx] = correlativoData;
    }
  } else {
    correlativos.push(correlativoData);
  }

  save(DB.CORRELATIVOS, correlativos);
  cerrarModal('correlativoModal');
  mostrarCorrelativos();
  toast(id ? 'Correlativo modificado' : 'Correlativo creado');
}

function eliminarCorrelativoSeleccionado() {
  if (!correlativoSeleccionadoId) {
    toast('Seleccione un correlativo', 'warning');
    return;
  }

  if (!confirm('¬øEst√° seguro de eliminar este correlativo?')) return;

  let correlativos = load(DB.CORRELATIVOS);
  correlativos = correlativos.filter(c => c.id !== correlativoSeleccionadoId);
  save(DB.CORRELATIVOS, correlativos);
  correlativoSeleccionadoId = null;
  mostrarCorrelativos();
  toast('Correlativo eliminado');
}

// ========== GESTI√ìN DE USUARIOS CON CAJAS ==========
function cargarUsuariosCaja() {
  const usuarios = load(DB.USUARIOS);
  const busqueda = (document.getElementById('buscarUsuarioCaja')?.value || '').toLowerCase();

  const filtrados = usuarios.filter(u =>
    u.nombres?.toLowerCase().includes(busqueda) ||
    u.username?.toLowerCase().includes(busqueda)
  );

  document.getElementById('listaUsuariosCaja').innerHTML = filtrados.map(u => {
    return '<div class="config-user-item ' + (usuarioCajaSeleccionado === u.id ? 'selected' : '') + '" onclick="seleccionarUsuarioCaja(\'' + u.id + '\')">' +
      '<span class="user-icon">üë§</span>' +
      '<span>' + u.username + '</span>' +
      '</div>';
  }).join('');

  // Cargar cajas disponibles
  cargarSelectCajas();

  // Si hay usuario seleccionado, mostrar sus cajas
  if (usuarioCajaSeleccionado) {
    mostrarCajasUsuario(usuarioCajaSeleccionado);
  }
}

function seleccionarUsuarioCaja(id) {
  usuarioCajaSeleccionado = id;
  cargarUsuariosCaja();
  mostrarCajasUsuario(id);
}

function mostrarCajasUsuario(userId) {
  const usuarios = load(DB.USUARIOS);
  const usuario = usuarios.find(u => u.id === userId);
  const cajas = usuario?.cajas || [];

  document.getElementById('listaCajasUsuario').innerHTML = cajas.map(c => {
    return '<div class="config-caja-item">' +
      '<span>' + c + '</span>' +
      '<button class="btn btn-danger btn-sm" onclick="quitarCajaUsuario(\'' + c + '\')">‚ùå</button>' +
      '</div>';
  }).join('') || '<p class="text-muted" style="padding: 20px; text-align: center;">Sin cajas asignadas</p>';
}

function cargarSelectCajas() {
  let cajas = load(DB.CAJAS);
  if (cajas.length === 0) {
    // Crear cajas por defecto
    cajas = [
      { id: 'CAJA1', nombre: 'TIENDA' },
      { id: 'CAJA2', nombre: 'PRINCIPAL' },
      { id: 'CAJA3', nombre: 'SUCURSAL' }
    ];
    save(DB.CAJAS, cajas);
  }

  document.getElementById('selectCajaAsignar').innerHTML =
    '<option value="">-- Seleccionar Caja --</option>' +
    cajas.map(c => '<option value="' + c.nombre + '">' + c.nombre + '</option>').join('');
}

function asignarCajaUsuario() {
  if (!usuarioCajaSeleccionado) {
    toast('Seleccione un usuario', 'warning');
    return;
  }

  const caja = document.getElementById('selectCajaAsignar').value;
  if (!caja) {
    toast('Seleccione una caja', 'warning');
    return;
  }

  const usuarios = load(DB.USUARIOS);
  const idx = usuarios.findIndex(u => u.id === usuarioCajaSeleccionado);

  if (idx >= 0) {
    if (!usuarios[idx].cajas) usuarios[idx].cajas = [];
    if (!usuarios[idx].cajas.includes(caja)) {
      usuarios[idx].cajas.push(caja);
      save(DB.USUARIOS, usuarios);
      mostrarCajasUsuario(usuarioCajaSeleccionado);
      toast('Caja asignada');
    } else {
      toast('La caja ya est√° asignada', 'warning');
    }
  }
}

function quitarCajaUsuario(caja) {
  if (!usuarioCajaSeleccionado) return;

  const usuarios = load(DB.USUARIOS);
  const idx = usuarios.findIndex(u => u.id === usuarioCajaSeleccionado);

  if (idx >= 0 && usuarios[idx].cajas) {
    usuarios[idx].cajas = usuarios[idx].cajas.filter(c => c !== caja);
    save(DB.USUARIOS, usuarios);
    mostrarCajasUsuario(usuarioCajaSeleccionado);
    toast('Caja removida');
  }
}

// Inicializaci√≥n de Configuraci√≥n
function initConfiguracion() {
  // Eventos de b√∫squeda
  const buscarAlmacen = document.getElementById('buscarUsuarioAlmacen');
  if (buscarAlmacen) {
    buscarAlmacen.addEventListener('input', cargarUsuariosAlmacen);
  }

  const buscarCaja = document.getElementById('buscarUsuarioCaja');
  if (buscarCaja) {
    buscarCaja.addEventListener('input', cargarUsuariosCaja);
  }
}

// Funci√≥n para inicializar todo el sistema despu√©s del login
/* ============================================
   DASHBOARD ULTRA MODERNO - M√âTRICAS EN TIEMPO REAL
   ============================================ */

// Variable global para el per√≠odo seleccionado en el dashboard
let periodoDashboard = 'hoy'; // 'hoy', 'semana', '15dias', 'mes'

// Funci√≥n para cambiar el per√≠odo del dashboard
function cambiarPeriodoDashboard(periodo) {
  periodoDashboard = periodo;

  // Actualizar estilos de los botones
  const botones = {
    hoy: document.getElementById('periodHoy'),
    semana: document.getElementById('periodSemana'),
    '15dias': document.getElementById('period15dias'),
    mes: document.getElementById('periodMes')
  };

  // Resetear todos los botones
  Object.values(botones).forEach(btn => {
    if (btn) {
      btn.style.background = 'white';
      btn.style.color = '#6b7280';
      btn.style.border = '2px solid #e5e7eb';
      btn.style.boxShadow = 'none';
    }
  });

  // Activar el bot√≥n seleccionado
  const btnActivo = botones[periodo];
  if (btnActivo) {
    btnActivo.style.background = 'linear-gradient(135deg, #10b981, #059669)';
    btnActivo.style.color = 'white';
    btnActivo.style.border = 'none';
    btnActivo.style.boxShadow = '0 4px 12px rgba(16, 185, 129, 0.4)';
  }

  // Recargar m√©tricas y gr√°fico
  cargarMetricasDashboard();
  cargarGraficoVentas();
}

function cargarDashboard() {
  console.log('üìä Cargando Dashboard Ultra Moderno...');

  // Cargar m√©tricas principales
  cargarMetricasDashboard();

  // Cargar gr√°fico de ventas
  cargarGraficoVentas();

  // Cargar top productos
  cargarTopProductos();

  // Cargar stock bajo
  cargarStockBajo();

  // Cargar actividad reciente
  cargarActividadReciente();
}

function cargarMetricasDashboard() {
  const ventas = load(DB.VENTAS) || [];
  const productos = load(DB.PRODUCTOS) || [];
  const clientes = load(DB.CLIENTES) || [];
  const consultas = load(DB.CONSULTAS_CLINICAS) || [];

  const hoy = new Date();
  hoy.setHours(0, 0, 0, 0);

  // Calcular fecha de inicio seg√∫n el per√≠odo seleccionado
  let fechaInicio;
  let tituloPeriodo;

  switch (periodoDashboard) {
    case 'hoy':
      fechaInicio = new Date(hoy);
      tituloPeriodo = 'Hoy';
      break;
    case 'semana':
      fechaInicio = new Date(hoy);
      fechaInicio.setDate(hoy.getDate() - 7);
      tituloPeriodo = '√öltimos 7 d√≠as';
      break;
    case '15dias':
      fechaInicio = new Date(hoy);
      fechaInicio.setDate(hoy.getDate() - 15);
      tituloPeriodo = '√öltimos 15 d√≠as';
      break;
    case 'mes':
      fechaInicio = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
      tituloPeriodo = 'Este mes';
      break;
    default:
      fechaInicio = new Date(hoy);
      tituloPeriodo = 'Hoy';
  }

  console.log(`üìä Cargando m√©tricas para: ${tituloPeriodo}`, fechaInicio);

  // Filtrar ventas seg√∫n el per√≠odo
  const ventasPeriodo = ventas.filter(v => {
    const fechaVenta = new Date(v.fecha);
    fechaVenta.setHours(0, 0, 0, 0);
    return fechaVenta >= fechaInicio;
  });

  // Filtrar consultas seg√∫n el per√≠odo
  const consultasPeriodo = consultas.filter(c => {
    const fechaConsulta = new Date(c.fecha);
    fechaConsulta.setHours(0, 0, 0, 0);
    return fechaConsulta >= fechaInicio;
  });

  // Calcular totales
  const totalVentas = ventasPeriodo.reduce((sum, v) => sum + (v.total || 0), 0);
  const promedioVenta = ventasPeriodo.length > 0 ? totalVentas / ventasPeriodo.length : 0;
  const stockBajo = productos.filter(p => p.stock <= (p.stockMin || 5)).length;

  // Calcular ventas de HOY para comparaci√≥n
  const ventasHoy = ventas.filter(v => {
    const fechaVenta = new Date(v.fecha);
    return fechaVenta.toDateString() === new Date().toDateString();
  });
  const totalVentasHoy = ventasHoy.reduce((sum, v) => sum + (v.total || 0), 0);

  // M√©tricas a mostrar
  const metricas = [
    {
      titulo: `Ventas - ${tituloPeriodo}`,
      valor: `S/ ${totalVentas.toFixed(2)}`,
      icono: 'üí∞',
      color: '#10b981',
      colorFondo: '#d1fae5',
      subtitulo: `${ventasPeriodo.length} transacciones`
    },
    {
      titulo: 'Promedio por Venta',
      valor: `S/ ${promedioVenta.toFixed(2)}`,
      icono: 'üìä',
      color: '#3b82f6',
      colorFondo: '#dbeafe',
      subtitulo: `Basado en ${ventasPeriodo.length} ventas`
    },
    {
      titulo: 'Consultas',
      valor: consultasPeriodo.length,
      icono: 'üëÅÔ∏è',
      color: '#8b5cf6',
      colorFondo: '#ede9fe',
      subtitulo: `${tituloPeriodo.toLowerCase()}`
    },
    {
      titulo: 'Ventas Hoy',
      valor: `S/ ${totalVentasHoy.toFixed(2)}`,
      icono: 'üî•',
      color: '#f59e0b',
      colorFondo: '#fef3c7',
      subtitulo: `${ventasHoy.length} transacciones hoy`
    }
  ];

  // Generar HTML de las tarjetas
  const metricasDiv = document.getElementById('dashboardMetricas');
  if (!metricasDiv) return;

  metricasDiv.innerHTML = metricas.map((m, index) => `
    <div style="
      background: linear-gradient(135deg, white 0%, ${m.colorFondo} 100%);
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.08);
      border: 2px solid ${m.color}20;
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      cursor: pointer;
      animation: fadeInUp 0.6s ease-out ${index * 0.1}s both;
      position: relative;
      overflow: hidden;
    " onmouseover="this.style.transform='translateY(-8px) scale(1.02)'; this.style.boxShadow='0 12px 32px rgba(0,0,0,0.15)';" onmouseout="this.style.transform='translateY(0) scale(1)'; this.style.boxShadow='0 4px 16px rgba(0,0,0,0.08)';">

      <!-- Icono de fondo -->
      <div style="
        position: absolute;
        top: -20px;
        right: -20px;
        font-size: 120px;
        opacity: 0.1;
        transform: rotate(-15deg);
      ">${m.icono}</div>

      <!-- Contenido -->
      <div style="position: relative; z-index: 1;">
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
          <div style="
            width: 50px;
            height: 50px;
            background: ${m.color};
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 12px ${m.color}40;
          ">${m.icono}</div>
          <div style="flex: 1;">
            <div style="
              font-size: 13px;
              font-weight: 600;
              color: #64748b;
              text-transform: uppercase;
              letter-spacing: 0.5px;
              margin-bottom: 4px;
            ">${m.titulo}</div>
            <div style="
              font-size: 28px;
              font-weight: 900;
              color: ${m.color};
              line-height: 1;
            ">${m.valor}</div>
          </div>
        </div>
        <div style="
          font-size: 12px;
          color: #64748b;
          font-weight: 500;
          padding-top: 12px;
          border-top: 2px solid ${m.color}20;
        ">${m.subtitulo}</div>
      </div>
    </div>
  `).join('');
}

function cargarGraficoVentas() {
  const ventas = load(DB.VENTAS) || [];

  const hoy = new Date();
  hoy.setHours(0, 0, 0, 0);

  // Calcular fecha de inicio seg√∫n el per√≠odo seleccionado (sincronizado con periodoDashboard)
  let fechaInicio, tituloPeriodo, etiquetas = [];
  let ventasPorPeriodo = {};

  switch (periodoDashboard) {
    case 'hoy':
      // Mostrar ventas por hora del d√≠a actual
      fechaInicio = new Date(hoy);
      tituloPeriodo = 'Ventas de Hoy (por hora)';

      // Crear 24 slots para cada hora
      for (let hora = 0; hora < 24; hora++) {
        const horaKey = hora.toString().padStart(2, '0') + ':00';
        ventasPorPeriodo[horaKey] = 0;
        etiquetas.push(horaKey);
      }

      // Agrupar ventas por hora
      ventas.forEach(v => {
        const fechaVenta = new Date(v.fecha || v.fechaEmision);
        if (fechaVenta.toDateString() === hoy.toDateString()) {
          const hora = fechaVenta.getHours().toString().padStart(2, '0') + ':00';
          ventasPorPeriodo[hora] += v.total || v.totalPagar || 0;
        }
      });
      break;

    case 'semana':
      // Mostrar ventas de los √∫ltimos 7 d√≠as
      fechaInicio = new Date(hoy);
      fechaInicio.setDate(hoy.getDate() - 6); // 6 d√≠as atr√°s + hoy = 7 d√≠as
      tituloPeriodo = '√öltimos 7 D√≠as';

      // Crear 7 slots para cada d√≠a
      for (let i = 0; i < 7; i++) {
        const fecha = new Date(fechaInicio);
        fecha.setDate(fechaInicio.getDate() + i);
        const diaKey = fecha.toISOString().split('T')[0];
        const diaLabel = fecha.getDate() + '/' + (fecha.getMonth() + 1);
        ventasPorPeriodo[diaKey] = 0;
        etiquetas.push(diaLabel);
      }

      // Agrupar ventas por d√≠a
      ventas.forEach(v => {
        const fechaVenta = new Date(v.fecha || v.fechaEmision);
        fechaVenta.setHours(0, 0, 0, 0);
        if (fechaVenta >= fechaInicio && fechaVenta <= hoy) {
          const diaKey = fechaVenta.toISOString().split('T')[0];
          if (ventasPorPeriodo.hasOwnProperty(diaKey)) {
            ventasPorPeriodo[diaKey] += v.total || v.totalPagar || 0;
          }
        }
      });
      break;

    case '15dias':
      // Mostrar ventas de los √∫ltimos 15 d√≠as
      fechaInicio = new Date(hoy);
      fechaInicio.setDate(hoy.getDate() - 14); // 14 d√≠as atr√°s + hoy = 15 d√≠as
      tituloPeriodo = '√öltimos 15 D√≠as';

      // Crear 15 slots
      for (let i = 0; i < 15; i++) {
        const fecha = new Date(fechaInicio);
        fecha.setDate(fechaInicio.getDate() + i);
        const diaKey = fecha.toISOString().split('T')[0];
        const diaLabel = fecha.getDate() + '/' + (fecha.getMonth() + 1);
        ventasPorPeriodo[diaKey] = 0;
        etiquetas.push(diaLabel);
      }

      // Agrupar ventas por d√≠a
      ventas.forEach(v => {
        const fechaVenta = new Date(v.fecha || v.fechaEmision);
        fechaVenta.setHours(0, 0, 0, 0);
        if (fechaVenta >= fechaInicio && fechaVenta <= hoy) {
          const diaKey = fechaVenta.toISOString().split('T')[0];
          if (ventasPorPeriodo.hasOwnProperty(diaKey)) {
            ventasPorPeriodo[diaKey] += v.total || v.totalPagar || 0;
          }
        }
      });
      break;

    case 'mes':
      // Mostrar ventas del mes actual por d√≠as
      fechaInicio = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
      const ultimoDia = new Date(hoy.getFullYear(), hoy.getMonth() + 1, 0).getDate();
      tituloPeriodo = 'Este Mes';

      // Crear slots para cada d√≠a del mes
      for (let dia = 1; dia <= ultimoDia; dia++) {
        const fecha = new Date(hoy.getFullYear(), hoy.getMonth(), dia);
        const diaKey = fecha.toISOString().split('T')[0];
        ventasPorPeriodo[diaKey] = 0;
        etiquetas.push(dia.toString());
      }

      // Agrupar ventas por d√≠a
      ventas.forEach(v => {
        const fechaVenta = new Date(v.fecha || v.fechaEmision);
        if (fechaVenta.getMonth() === hoy.getMonth() && fechaVenta.getFullYear() === hoy.getFullYear()) {
          const diaKey = fechaVenta.toISOString().split('T')[0];
          if (ventasPorPeriodo.hasOwnProperty(diaKey)) {
            ventasPorPeriodo[diaKey] += v.total || v.totalPagar || 0;
          }
        }
      });
      break;
  }

  // Generar gr√°fico
  const graficoDiv = document.getElementById('graficoVentasMes');
  const graficoDivGraficas = document.getElementById('graficoVentasGraficas');

  const valores = Object.values(ventasPorPeriodo);
  const maxVenta = Math.max(...valores, 100);
  const totalPeriodo = valores.reduce((a, b) => a + b, 0);

  // Ajustar el tama√±o de fuente de las etiquetas seg√∫n cantidad
  const fontSize = etiquetas.length > 15 ? '8px' : '10px';
  const barGap = etiquetas.length > 20 ? '2px' : '4px';

  const graficoHTML = `
    <div style="text-align: center; margin-bottom: 15px;">
      <h3 style="font-size: 16px; font-weight: 800; color: #1e293b; margin: 0;">üìä ${tituloPeriodo}</h3>
    </div>
    <div style="display: flex; align-items: flex-end; justify-content: space-between; gap: ${barGap}; height: 450px; padding: 10px 0;">
      ${Object.entries(ventasPorPeriodo).map(([key, total], index) => {
        const altura = maxVenta > 0 ? (total / maxVenta) * 100 : 0;
        const etiqueta = etiquetas[index];
        return `
          <div style="flex: 1; display: flex; flex-direction: column; align-items: center; gap: 8px;">
            <div style="
              width: 100%;
              height: ${altura}%;
              background: linear-gradient(180deg, #10b981 0%, #059669 100%);
              border-radius: 4px 4px 0 0;
              transition: all 0.3s ease;
              cursor: pointer;
              position: relative;
              min-height: ${total > 0 ? '2px' : '0'};
            " onmouseover="this.style.background='linear-gradient(180deg, #059669 0%, #047857 100%)'; this.style.transform='scaleY(1.05)';" onmouseout="this.style.background='linear-gradient(180deg, #10b981 0%, #059669 100%)'; this.style.transform='scaleY(1)';" title="${etiqueta}: S/ ${total.toFixed(2)}">
            </div>
            <div style="font-size: ${fontSize}; color: #94a3b8; font-weight: 600; transform: ${etiquetas.length > 20 ? 'rotate(-45deg)' : 'none'}; white-space: nowrap;">${etiqueta}</div>
          </div>
        `;
      }).join('')}
    </div>
    <div style="text-align: center; margin-top: 15px; padding-top: 15px; border-top: 2px solid #f1f5f9;">
      <span style="font-size: 14px; color: #64748b; font-weight: 600;">
        Total del per√≠odo: <strong style="color: #10b981; font-size: 18px;">S/ ${totalPeriodo.toFixed(2)}</strong>
      </span>
      <div style="font-size: 12px; color: #94a3b8; margin-top: 5px;">
        Promedio: <strong style="color: #6b7280;">S/ ${valores.length > 0 ? (totalPeriodo / valores.length).toFixed(2) : '0.00'}</strong>
      </div>
    </div>
  `;

  // Asignar el HTML a ambos contenedores
  if (graficoDiv) graficoDiv.innerHTML = graficoHTML;
  if (graficoDivGraficas) graficoDivGraficas.innerHTML = graficoHTML;
}

function cargarTopProductos() {
  const ventas = load(DB.VENTAS) || [];
  const productos = load(DB.PRODUCTOS) || [];

  // Contar ventas por producto
  const ventasPorProducto = {};
  ventas.forEach(v => {
    if (v.items) {
      v.items.forEach(item => {
        const key = item.descripcion || item.nombre;
        if (!ventasPorProducto[key]) {
          ventasPorProducto[key] = { cantidad: 0, total: 0 };
        }
        ventasPorProducto[key].cantidad += item.cantidad || 1;
        ventasPorProducto[key].total += item.importe || 0;
      });
    }
  });

  // Ordenar y tomar top 5
  const topProductos = Object.entries(ventasPorProducto)
    .sort((a, b) => b[1].total - a[1].total)
    .slice(0, 5);

  const topDiv = document.getElementById('topProductos');
  if (!topDiv) return;

  if (topProductos.length === 0) {
    topDiv.innerHTML = '<div style="text-align: center; color: #94a3b8; padding: 40px 0;">No hay datos disponibles</div>';
    return;
  }

  const maxTotal = topProductos[0][1].total;

  topDiv.innerHTML = topProductos.map(([nombre, data], index) => {
    const porcentaje = (data.total / maxTotal) * 100;
    const colores = ['#10b981', '#3b82f6', '#8b5cf6', '#f59e0b', '#ef4444'];
    const color = colores[index];

    return `
      <div style="animation: fadeInLeft 0.6s ease-out ${index * 0.1}s both;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
          <div style="font-size: 13px; font-weight: 700; color: #1e293b; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
            ${index + 1}. ${nombre}
          </div>
          <div style="font-size: 14px; font-weight: 800; color: ${color};">S/ ${data.total.toFixed(2)}</div>
        </div>
        <div style="height: 8px; background: #f1f5f9; border-radius: 4px; overflow: hidden;">
          <div style="
            height: 100%;
            width: ${porcentaje}%;
            background: linear-gradient(90deg, ${color} 0%, ${color}dd 100%);
            border-radius: 4px;
            transition: width 0.6s ease-out;
          "></div>
        </div>
        <div style="font-size: 11px; color: #64748b; margin-top: 4px;">${data.cantidad} unidades vendidas</div>
      </div>
    `;
  }).join('');
}

function cargarStockBajo() {
  const productos = load(DB.PRODUCTOS) || [];
  const stockBajoProductos = productos.filter(p => p.stock <= (p.stockMin || 5));

  const countSpan = document.getElementById('stockBajoCount');
  const listaDiv = document.getElementById('listaStockBajo');

  if (countSpan) countSpan.textContent = stockBajoProductos.length;
  if (!listaDiv) return;

  if (stockBajoProductos.length === 0) {
    listaDiv.innerHTML = '<div style="text-align: center; color: #10b981; padding: 40px 0; font-weight: 600;">‚úì Todo el stock est√° bien</div>';
    return;
  }

  listaDiv.innerHTML = stockBajoProductos.slice(0, 10).map((p, index) => `
    <div style="
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: ${p.stock === 0 ? '#fee2e2' : '#fef3c7'};
      border-left: 4px solid ${p.stock === 0 ? '#ef4444' : '#f59e0b'};
      border-radius: 8px;
      margin-bottom: 8px;
      animation: fadeInLeft 0.6s ease-out ${index * 0.05}s both;
    ">
      <div style="flex: 1;">
        <div style="font-size: 13px; font-weight: 700; color: #1e293b; margin-bottom: 4px;">${p.nombre}</div>
        <div style="font-size: 11px; color: #64748b;">C√≥digo: ${p.id}</div>
      </div>
      <div style="text-align: right;">
        <div style="
          padding: 4px 12px;
          background: ${p.stock === 0 ? '#dc2626' : '#d97706'};
          color: white;
          border-radius: 12px;
          font-size: 12px;
          font-weight: 800;
          margin-bottom: 4px;
        ">${p.stock === 0 ? 'AGOTADO' : `${p.stock} und.`}</div>
        <div style="font-size: 10px; color: #64748b;">M√≠n: ${p.stockMin || 5}</div>
      </div>
    </div>
  `).join('');
}

function cargarActividadReciente() {
  const ventas = load(DB.VENTAS) || [];
  const consultas = load(DB.CONSULTAS_CLINICAS) || [];

  // Combinar y ordenar actividades
  const actividades = [
    ...ventas.slice(-10).map(v => ({
      tipo: 'venta',
      fecha: new Date(v.fecha),
      descripcion: `Venta ${v.id} - S/ ${(v.total || 0).toFixed(2)}`,
      icono: 'üí∞',
      color: '#10b981'
    })),
    ...consultas.slice(-10).map(c => ({
      tipo: 'consulta',
      fecha: new Date(c.fecha),
      descripcion: `Consulta de ${c.nombreCliente}`,
      icono: 'ü©∫',
      color: '#3b82f6'
    }))
  ].sort((a, b) => b.fecha - a.fecha).slice(0, 10);

  const actividadDiv = document.getElementById('actividadReciente');
  if (!actividadDiv) return;

  if (actividades.length === 0) {
    actividadDiv.innerHTML = '<div style="text-align: center; color: #94a3b8; padding: 40px 0;">No hay actividad reciente</div>';
    return;
  }

  actividadDiv.innerHTML = actividades.map((a, index) => `
    <div style="
      display: flex;
      gap: 12px;
      padding: 12px;
      border-bottom: 1px solid #f1f5f9;
      animation: fadeIn 0.6s ease-out ${index * 0.05}s both;
    ">
      <div style="
        width: 36px;
        height: 36px;
        background: ${a.color}20;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        flex-shrink: 0;
      ">${a.icono}</div>
      <div style="flex: 1;">
        <div style="font-size: 13px; font-weight: 600; color: #1e293b; margin-bottom: 2px;">${a.descripcion}</div>
        <div style="font-size: 11px; color: #94a3b8;">${timeAgo(a.fecha)}</div>
      </div>
    </div>
  `).join('');
}

function timeAgo(fecha) {
  const segundos = Math.floor((new Date() - fecha) / 1000);

  if (segundos < 60) return 'Hace unos segundos';
  if (segundos < 3600) return `Hace ${Math.floor(segundos / 60)} minutos`;
  if (segundos < 86400) return `Hace ${Math.floor(segundos / 3600)} horas`;
  if (segundos < 604800) return `Hace ${Math.floor(segundos / 86400)} d√≠as`;

  return fecha.toLocaleDateString('es-PE');
}

function actualizarDashboard() {
  cargarDashboard();
}

// ============================================================================
// üéØ SISTEMA UNIFICADO DE PRESCRIPCIONES V2.0 - ULTRA MODERNO
// ============================================================================

// Estado global del sistema de RX
let tipoVisionActual = 'distancia';
let autoGuardadoRXActivado = true;
let timerAutoGuardadoRX = null;
let datosRXTemporales = {};

// Cambiar entre tipos de visi√≥n (Distancia/Cerca/Intermedia)
function cambiarTipoVision(tipo) {
  // Guardar datos actuales antes de cambiar
  guardarDatosVisualesActuales();

  tipoVisionActual = tipo;

  // Actualizar UI de botones
  const botones = {
    'distancia': document.getElementById('btnVisionDistancia'),
    'cerca': document.getElementById('btnVisionCerca'),
    'intermedia': document.getElementById('btnVisionIntermedia')
  };

  Object.keys(botones).forEach(key => {
    if (key === tipo) {
      botones[key].style.background = 'linear-gradient(135deg, #7c3aed, #6b21a8)';
      botones[key].style.color = 'white';
      botones[key].style.boxShadow = '0 4px 12px rgba(124, 58, 237, 0.4)';
      botones[key].style.border = 'none';
    } else {
      botones[key].style.background = 'white';
      botones[key].style.color = '#7c3aed';
      botones[key].style.border = '2px solid #7c3aed';
      botones[key].style.boxShadow = 'none';
    }
  });

  // Cargar datos del tipo de visi√≥n seleccionado
  cargarDatosVisuales(tipo);
}

// Guardar datos visuales actuales en memoria temporal
function guardarDatosVisualesActuales() {
  const prefijo = tipoVisionActual === 'distancia' ? 'Dist' :
                  tipoVisionActual === 'cerca' ? 'Cerca' : 'Inter';

  datosRXTemporales[tipoVisionActual] = {
    esfOD: document.getElementById('rxDistEsfOD').value,
    cilOD: document.getElementById('rxDistCilOD').value,
    ejeOD: document.getElementById('rxDistEjeOD').value,
    dipOD: document.getElementById('rxDistDipOD').value,
    esfOI: document.getElementById('rxDistEsfOI').value,
    cilOI: document.getElementById('rxDistCilOI').value,
    ejeOI: document.getElementById('rxDistEjeOI').value,
    dipOI: document.getElementById('rxDistDipOI').value
  };

  // Copiar a campos ocultos correspondientes
  if (tipoVisionActual === 'cerca') {
    document.getElementById('rxCercaEsfOD').value = datosRXTemporales[tipoVisionActual].esfOD;
    document.getElementById('rxCercaCilOD').value = datosRXTemporales[tipoVisionActual].cilOD;
    document.getElementById('rxCercaEjeOD').value = datosRXTemporales[tipoVisionActual].ejeOD;
    document.getElementById('rxCercaDipOD').value = datosRXTemporales[tipoVisionActual].dipOD;
    document.getElementById('rxCercaEsfOI').value = datosRXTemporales[tipoVisionActual].esfOI;
    document.getElementById('rxCercaCilOI').value = datosRXTemporales[tipoVisionActual].cilOI;
    document.getElementById('rxCercaEjeOI').value = datosRXTemporales[tipoVisionActual].ejeOI;
    document.getElementById('rxCercaDipOI').value = datosRXTemporales[tipoVisionActual].dipOI;
  } else if (tipoVisionActual === 'intermedia') {
    document.getElementById('rxInterEsfOD').value = datosRXTemporales[tipoVisionActual].esfOD;
    document.getElementById('rxInterCilOD').value = datosRXTemporales[tipoVisionActual].cilOD;
    document.getElementById('rxInterEjeOD').value = datosRXTemporales[tipoVisionActual].ejeOD;
    document.getElementById('rxInterDipOD').value = datosRXTemporales[tipoVisionActual].dipOD;
    document.getElementById('rxInterEsfOI').value = datosRXTemporales[tipoVisionActual].esfOI;
    document.getElementById('rxInterCilOI').value = datosRXTemporales[tipoVisionActual].cilOI;
    document.getElementById('rxInterEjeOI').value = datosRXTemporales[tipoVisionActual].ejeOI;
    document.getElementById('rxInterDipOI').value = datosRXTemporales[tipoVisionActual].dipOI;
  }
}

// Cargar datos visuales del tipo seleccionado
function cargarDatosVisuales(tipo) {
  if (datosRXTemporales[tipo]) {
    document.getElementById('rxDistEsfOD').value = datosRXTemporales[tipo].esfOD;
    document.getElementById('rxDistCilOD').value = datosRXTemporales[tipo].cilOD;
    document.getElementById('rxDistEjeOD').value = datosRXTemporales[tipo].ejeOD;
    document.getElementById('rxDistDipOD').value = datosRXTemporales[tipo].dipOD;
    document.getElementById('rxDistEsfOI').value = datosRXTemporales[tipo].esfOI;
    document.getElementById('rxDistCilOI').value = datosRXTemporales[tipo].cilOI;
    document.getElementById('rxDistEjeOI').value = datosRXTemporales[tipo].ejeOI;
    document.getElementById('rxDistDipOI').value = datosRXTemporales[tipo].dipOI;
  } else {
    // Cargar desde campos ocultos
    const prefijo = tipo === 'distancia' ? 'Dist' : tipo === 'cerca' ? 'Cerca' : 'Inter';
    document.getElementById('rxDistEsfOD').value = document.getElementById('rx' + prefijo + 'EsfOD').value || '';
    document.getElementById('rxDistCilOD').value = document.getElementById('rx' + prefijo + 'CilOD').value || '';
    document.getElementById('rxDistEjeOD').value = document.getElementById('rx' + prefijo + 'EjeOD').value || '';
    document.getElementById('rxDistDipOD').value = document.getElementById('rx' + prefijo + 'DipOD').value || '';
    document.getElementById('rxDistEsfOI').value = document.getElementById('rx' + prefijo + 'EsfOI').value || '';
    document.getElementById('rxDistCilOI').value = document.getElementById('rx' + prefijo + 'CilOI').value || '';
    document.getElementById('rxDistEjeOI').value = document.getElementById('rx' + prefijo + 'EjeOI').value || '';
    document.getElementById('rxDistDipOI').value = document.getElementById('rx' + prefijo + 'DipOI').value || '';
  }
}

// Validar campo de RX en tiempo real
// ============================================================================
// üéØ VALIDACIONES INTELIGENTES PROFESIONALES DE RX
// Rangos cl√≠nicos est√°ndar seg√∫n normas optom√©tricas internacionales
// ============================================================================

function validarCampoRX(input) {
  const valor = input.value.trim();
  const id = input.id.toLowerCase();

  // Si est√° vac√≠o, resetear estilo
  if (valor === '') {
    input.style.borderColor = '#cbd5e1';
    input.style.background = 'white';
    input.removeAttribute('title');
    return;
  }

  // Validar formato num√©rico b√°sico
  const esNumeroValido = /^[+-]?\d*\.?\d+$/.test(valor);

  if (!esNumeroValido) {
    input.style.borderColor = '#ef4444';
    input.style.background = '#fef2f2';
    input.title = '‚ö†Ô∏è Debe ser un n√∫mero v√°lido (Ej: +2.50, -1.25)';
    return;
  }

  const numero = parseFloat(valor);
  let esValido = true;
  let mensaje = '';

  // VALIDACIONES POR TIPO DE CAMPO

  // ESF (ESF√âRICO): -20.00 a +20.00
  if (id.includes('esf')) {
    if (numero < -20 || numero > 20) {
      esValido = false;
      mensaje = '‚ö†Ô∏è ESF debe estar entre -20.00 y +20.00';
    }
  }

  // CIL (CIL√çNDRICO): -8.00 a 0.00 (o 0.00 a +8.00 si configurado)
  else if (id.includes('cil')) {
    if (numero < -8 || numero > 8) {
      esValido = false;
      mensaje = '‚ö†Ô∏è CIL debe estar entre -8.00 y +8.00';
    }

    // Si hay CIL, debe haber EJE
    if (numero !== 0) {
      const ejeId = id.replace('cil', 'eje');
      const ejeInput = document.getElementById(ejeId);
      if (ejeInput && !ejeInput.value) {
        ejeInput.style.borderColor = '#f59e0b';
        ejeInput.style.background = '#fef3c7';
        ejeInput.title = '‚ö†Ô∏è Si hay CIL, debe especificar EJE';
      }
    }
  }

  // EJE: 0¬∞ a 180¬∞
  else if (id.includes('eje')) {
    if (numero < 0 || numero > 180) {
      esValido = false;
      mensaje = '‚ö†Ô∏è EJE debe estar entre 0¬∞ y 180¬∞';
    }
    // NO normalizar aqu√≠ - solo validar el rango
    // La normalizaci√≥n se har√° en el evento onblur
  }

  // DIP/PD (DISTANCIA PUPILAR): 40mm a 80mm
  else if (id.includes('dip') || id.includes('pd')) {
    if (numero < 40 || numero > 80) {
      esValido = false;
      mensaje = '‚ö†Ô∏è DIP/PD debe estar entre 40 y 80 mm';
    }
  }

  // ADD (ADICI√ìN): 0.00 a +4.00
  else if (id.includes('add')) {
    if (numero < 0 || numero > 4) {
      esValido = false;
      mensaje = '‚ö†Ô∏è ADD debe estar entre 0.00 y +4.00';
    }
  }

  // PIO (PRESI√ìN INTRAOCULAR): 8 a 30 mmHg
  else if (id.includes('pio')) {
    if (numero < 8 || numero > 30) {
      esValido = false;
      mensaje = '‚ö†Ô∏è PIO debe estar entre 8 y 30 mmHg';
    }

    // Alerta si est√° fuera del rango normal (10-21)
    if (numero < 10 || numero > 21) {
      input.style.borderColor = '#f59e0b';
      input.style.background = '#fef3c7';
      input.title = '‚ö†Ô∏è PIO fuera del rango normal (10-21 mmHg). Revisar.';
      return;
    }
  }

  // Aplicar estilos seg√∫n resultado
  if (esValido) {
    input.style.borderColor = '#10b981';
    input.style.background = '#f0fdf4';
    input.title = '‚úì Valor v√°lido';
  } else {
    input.style.borderColor = '#ef4444';
    input.style.background = '#fef2f2';
    input.title = mensaje;
  }
}

// ‚ú® GUARDAR DIAGN√ìSTICO AUTOM√ÅTICAMENTE EN TIEMPO REAL ‚ú®
function guardarDiagnosticoAutomatico() {
  // Esta funci√≥n se dispara cada vez que cambia un checkbox de diagn√≥stico
  // Los valores se guardar√°n autom√°ticamente cuando se guarde la consulta
  console.log('‚úÖ Diagn√≥stico actualizado en tiempo real');

  // Marcar que hubo cambios para el auto-guardado
  if (typeof marcarCambio === 'function') {
    marcarCambio({ value: 'diagnostico' });
  }
}

// Normalizar EJE cuando el usuario termina de escribir (onblur)
function normalizarEje(input) {
  const valor = input.value.trim();
  if (!valor) return; // Si est√° vac√≠o, no hacer nada

  const numero = parseFloat(valor);

  // Verificar que sea un n√∫mero v√°lido entre 0 y 180
  if (!isNaN(numero) && numero >= 0 && numero <= 180) {
    // Normalizar sin ceros a la izquierda (Ej: 12 ‚Üí 12, 5 ‚Üí 5)
    const valorNormalizado = Math.round(numero).toString();
    input.value = valorNormalizado;
  }
}

// Marcar cambio para auto-guardado profesional (5 segundos)
function marcarCambio(input) {
  if (autoGuardadoRXActivado) {
    // Mostrar indicador de "Guardando..."
    mostrarIndicadorGuardado('guardando');

    // Reiniciar timer de auto-guardado
    if (timerAutoGuardadoRX) clearTimeout(timerAutoGuardadoRX);

    timerAutoGuardadoRX = setTimeout(() => {
      ejecutarAutoGuardadoRX();
    }, 5000); // Guardar despu√©s de 5 segundos de inactividad
  }
}

// Mostrar indicador de guardado con estados
function mostrarIndicadorGuardado(estado) {
  const indicador = document.getElementById('indicadorAutoGuardado');
  if (!indicador) return;

  if (estado === 'guardando') {
    indicador.innerHTML = '‚è≥ Guardando cambios...';
    indicador.style.display = 'block';
    indicador.style.background = 'linear-gradient(135deg, #f59e0b, #d97706)';
  } else if (estado === 'guardado') {
    const ahora = new Date();
    const hora = ahora.toLocaleTimeString('es-PE', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    indicador.innerHTML = `‚úì Guardado autom√°ticamente a las ${hora}`;
    indicador.style.display = 'block';
    indicador.style.background = 'linear-gradient(135deg, #10b981, #059669)';

    // Ocultar despu√©s de 3 segundos
    setTimeout(() => {
      indicador.style.display = 'none';
    }, 3000);
  } else if (estado === 'error') {
    indicador.innerHTML = '‚ö†Ô∏è Error al guardar. Intenta nuevamente';
    indicador.style.display = 'block';
    indicador.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
  }
}

// Ejecutar auto-guardado profesional
function ejecutarAutoGuardadoRX() {
  try {
    // Guardar datos actuales
    guardarDatosVisualesActuales();

    // Mostrar indicador de √©xito
    mostrarIndicadorGuardado('guardado');

    console.log('‚úì Auto-guardado ejecutado exitosamente');
  } catch (error) {
    // Mostrar indicador de error
    mostrarIndicadorGuardado('error');
    console.error('‚ùå Error en auto-guardado:', error);
  }
}

// Toggle auto-guardado
function autoGuardarRX() {
  autoGuardadoRXActivado = !autoGuardadoRXActivado;
  const estado = document.getElementById('estadoAutoGuardado');

  if (autoGuardadoRXActivado) {
    estado.textContent = 'Activado';
    estado.parentElement.style.background = 'linear-gradient(135deg, #10b981, #059669)';
    toast('‚úì Auto-guardado activado');
  } else {
    estado.textContent = 'Desactivado';
    estado.parentElement.style.background = 'linear-gradient(135deg, #6b7280, #4b5563)';
    toast('‚äó Auto-guardado desactivado');
  }
}

// Comparar con √∫ltima RX
function compararUltimaRX() {
  // Verificar que haya un paciente seleccionado
  if (!pacienteConsultorioActual) {
    toast('‚ö†Ô∏è Primero selecciona un paciente', 'warning');
    return;
  }

  // Buscar consultas previas del paciente usando su ID
  const consultas = load(DB.CONSULTAS_CLINICAS) || [];
  const consultasPaciente = consultas
    .filter(c => c.idCliente === pacienteConsultorioActual.id)
    .sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

  if (consultasPaciente.length === 0) {
    toast('‚ÑπÔ∏è Este paciente no tiene consultas previas registradas', 'info');
    return;
  }

  if (consultasPaciente.length === 1) {
    toast('‚ÑπÔ∏è Solo hay una consulta registrada. Se necesitan al menos 2 consultas para comparar.', 'info');
    return;
  }

  const ultimaRX = consultasPaciente[0];
  const penultimaRX = consultasPaciente[1];

  // Obtener nombre completo del paciente
  const nombreCompleto = `${pacienteConsultorioActual.nombres || pacienteConsultorioActual.nombre || ''} ${pacienteConsultorioActual.apellidos || pacienteConsultorioActual.apellido || ''}`.trim();

  // Crear ventana de comparaci√≥n
  const ventanaComparacion = window.open('', 'Comparaci√≥n RX', 'width=1000,height=700');

  ventanaComparacion.document.write(`
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="UTF-8">
      <title>Comparaci√≥n de Prescripciones</title>
      <style>
        body {
          font-family: Arial, sans-serif;
          padding: 30px;
          background: #f8fafc;
        }
        h1 {
          color: #7c3aed;
          text-align: center;
          margin-bottom: 30px;
        }
        .comparacion-grid {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 20px;
          margin-bottom: 20px;
        }
        .rx-card {
          background: white;
          padding: 25px;
          border-radius: 12px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .rx-card h2 {
          color: #1f2937;
          margin-bottom: 20px;
          padding-bottom: 10px;
          border-bottom: 3px solid #7c3aed;
        }
        .fecha {
          color: #6b7280;
          font-size: 14px;
          margin-bottom: 15px;
        }
        table {
          width: 100%;
          border-collapse: collapse;
          margin-bottom: 15px;
        }
        th, td {
          padding: 6px;
          border: 2px solid #e5e7eb;
          text-align: center;
        }
        th {
          background: #f3f4f6;
          font-weight: 700;
          color: #374151;
        }
        .diferencia {
          background: #fef3c7 !important;
          border-color: #f59e0b !important;
          font-weight: 700;
        }
        .btn-cerrar {
          display: block;
          width: 200px;
          margin: 0 auto;
          padding: 12px;
          background: #7c3aed;
          color: white;
          border: none;
          border-radius: 8px;
          font-weight: 700;
          cursor: pointer;
          font-size: 14px;
        }
        .btn-cerrar:hover {
          background: #6b21a8;
        }
      </style>
    </head>
    <body>
      <h1>üìä Comparaci√≥n de Prescripciones</h1>
      <div style="text-align: center; margin-bottom: 30px; padding: 15px; background: linear-gradient(135deg, #eff6ff, #dbeafe); border-radius: 12px; border: 2px solid #3b82f6;">
        <div style="font-size: 18px; font-weight: 700; color: #1e40af;">üë§ Paciente: ${nombreCompleto}</div>
        <div style="font-size: 14px; color: #3b82f6; margin-top: 5px;">DNI: ${pacienteConsultorioActual.documento || pacienteConsultorioActual.dni || 'No registrado'}</div>
      </div>

      <div class="comparacion-grid">
        <div class="rx-card">
          <h2>√öltima Prescripci√≥n</h2>
          <div class="fecha">üìÖ ${formatDate(ultimaRX.fecha)}</div>

          <h3>DISTANCIA</h3>
          <table>
            <tr><th></th><th>ESF</th><th>CIL</th><th>EJE</th><th>DIP</th></tr>
            <tr>
              <td>O.D.</td>
              <td>${ultimaRX.rxDistEsfOD || '-'}</td>
              <td>${ultimaRX.rxDistCilOD || '-'}</td>
              <td>${ultimaRX.rxDistEjeOD || '-'}</td>
              <td>${ultimaRX.rxDistDipOD || '-'}</td>
            </tr>
            <tr>
              <td>O.I.</td>
              <td>${ultimaRX.rxDistEsfOI || '-'}</td>
              <td>${ultimaRX.rxDistCilOI || '-'}</td>
              <td>${ultimaRX.rxDistEjeOI || '-'}</td>
              <td>${ultimaRX.rxDistDipOI || '-'}</td>
            </tr>
          </table>

          <h3>CERCA</h3>
          <table>
            <tr><th></th><th>ESF</th><th>CIL</th><th>EJE</th><th>DIP</th></tr>
            <tr>
              <td>O.D.</td>
              <td>${ultimaRX.rxCercaEsfOD || '-'}</td>
              <td>${ultimaRX.rxCercaCilOD || '-'}</td>
              <td>${ultimaRX.rxCercaEjeOD || '-'}</td>
              <td>${ultimaRX.rxCercaDipOD || '-'}</td>
            </tr>
            <tr>
              <td>O.I.</td>
              <td>${ultimaRX.rxCercaEsfOI || '-'}</td>
              <td>${ultimaRX.rxCercaCilOI || '-'}</td>
              <td>${ultimaRX.rxCercaEjeOI || '-'}</td>
              <td>${ultimaRX.rxCercaDipOI || '-'}</td>
            </tr>
          </table>
        </div>

        <div class="rx-card">
          <h2>Prescripci√≥n Anterior</h2>
          <div class="fecha">üìÖ ${formatDate(penultimaRX.fecha)}</div>

          <h3>DISTANCIA</h3>
          <table>
            <tr><th></th><th>ESF</th><th>CIL</th><th>EJE</th><th>DIP</th></tr>
            <tr>
              <td>O.D.</td>
              <td class="${ultimaRX.rxDistEsfOD !== penultimaRX.rxDistEsfOD ? 'diferencia' : ''}">${penultimaRX.rxDistEsfOD || '-'}</td>
              <td class="${ultimaRX.rxDistCilOD !== penultimaRX.rxDistCilOD ? 'diferencia' : ''}">${penultimaRX.rxDistCilOD || '-'}</td>
              <td class="${ultimaRX.rxDistEjeOD !== penultimaRX.rxDistEjeOD ? 'diferencia' : ''}">${penultimaRX.rxDistEjeOD || '-'}</td>
              <td class="${ultimaRX.rxDistDipOD !== penultimaRX.rxDistDipOD ? 'diferencia' : ''}">${penultimaRX.rxDistDipOD || '-'}</td>
            </tr>
            <tr>
              <td>O.I.</td>
              <td class="${ultimaRX.rxDistEsfOI !== penultimaRX.rxDistEsfOI ? 'diferencia' : ''}">${penultimaRX.rxDistEsfOI || '-'}</td>
              <td class="${ultimaRX.rxDistCilOI !== penultimaRX.rxDistCilOI ? 'diferencia' : ''}">${penultimaRX.rxDistCilOI || '-'}</td>
              <td class="${ultimaRX.rxDistEjeOI !== penultimaRX.rxDistEjeOI ? 'diferencia' : ''}">${penultimaRX.rxDistEjeOI || '-'}</td>
              <td class="${ultimaRX.rxDistDipOI !== penultimaRX.rxDistDipOI ? 'diferencia' : ''}">${penultimaRX.rxDistDipOI || '-'}</td>
            </tr>
          </table>

          <h3>CERCA</h3>
          <table>
            <tr><th></th><th>ESF</th><th>CIL</th><th>EJE</th><th>DIP</th></tr>
            <tr>
              <td>O.D.</td>
              <td class="${ultimaRX.rxCercaEsfOD !== penultimaRX.rxCercaEsfOD ? 'diferencia' : ''}">${penultimaRX.rxCercaEsfOD || '-'}</td>
              <td class="${ultimaRX.rxCercaCilOD !== penultimaRX.rxCercaCilOD ? 'diferencia' : ''}">${penultimaRX.rxCercaCilOD || '-'}</td>
              <td class="${ultimaRX.rxCercaEjeOD !== penultimaRX.rxCercaEjeOD ? 'diferencia' : ''}">${penultimaRX.rxCercaEjeOD || '-'}</td>
              <td class="${ultimaRX.rxCercaDipOD !== penultimaRX.rxCercaDipOD ? 'diferencia' : ''}">${penultimaRX.rxCercaDipOD || '-'}</td>
            </tr>
            <tr>
              <td>O.I.</td>
              <td class="${ultimaRX.rxCercaEsfOI !== penultimaRX.rxCercaEsfOI ? 'diferencia' : ''}">${penultimaRX.rxCercaEsfOI || '-'}</td>
              <td class="${ultimaRX.rxCercaCilOI !== penultimaRX.rxCercaCilOI ? 'diferencia' : ''}">${penultimaRX.rxCercaCilOI || '-'}</td>
              <td class="${ultimaRX.rxCercaEjeOI !== penultimaRX.rxCercaEjeOI ? 'diferencia' : ''}">${penultimaRX.rxCercaEjeOI || '-'}</td>
              <td class="${ultimaRX.rxCercaDipOI !== penultimaRX.rxCercaDipOI ? 'diferencia' : ''}">${penultimaRX.rxCercaDipOI || '-'}</td>
            </tr>
          </table>
        </div>
      </div>

      <button class="btn-cerrar" onclick="window.close()">Cerrar Comparaci√≥n</button>
    </body>
    </html>
  `);

  toast('‚úì Ventana de comparaci√≥n abierta', 'success');
}

// ============================================================================
// üéØ VALIDACI√ìN DE EDAD OPCIONAL
// ============================================================================

function validarEdad(input) {
  const valor = parseInt(input.value);

  // Si est√° vac√≠o, es v√°lido (opcional)
  if (!input.value || input.value === '') {
    input.style.borderColor = '#cbd5e1';
    input.style.background = 'white';
    input.removeAttribute('title');
    return;
  }

  // Validar rango 0-120
  if (isNaN(valor) || valor < 0 || valor > 120) {
    input.style.borderColor = '#ef4444';
    input.style.background = '#fef2f2';
    input.title = '‚ö†Ô∏è Edad debe estar entre 0 y 120 a√±os';
  } else {
    input.style.borderColor = '#10b981';
    input.style.background = '#f0fdf4';
    input.title = '‚úì Edad v√°lida';

    // Ajustar si es pedi√°trico
    if (valor < 18) {
      input.style.borderColor = '#f59e0b';
      input.style.background = '#fef3c7';
      input.title = 'üë∂ Paciente pedi√°trico';
    }
  }
}

// ============================================================================

function inicializarSistema() {
  // Inicializaci√≥n de Almac√©n
  initAlmacenFechas();

  // Inicializaci√≥n de Reportes
  initReportes();

  // Inicializaci√≥n de Importaci√≥n
  initImportWizard();

  // Inicializaci√≥n de Configuraci√≥n
  initConfiguracion();

  // Crear datos de ejemplo si no existen
  crearDatosDeEjemplo();

  // Inicializaci√≥n del Dashboard con m√©tricas en tiempo real
  if (typeof cargarDashboard === 'function') cargarDashboard();

  // Renderizar datos iniciales
  if (typeof renderClientes === 'function') renderClientes();
  if (typeof cargarProductos === 'function') cargarProductos();
}

// Crear datos de ejemplo para pruebas
function crearDatosDeEjemplo() {
  console.log('üì¶ Verificando datos de ejemplo...');
  const clientes = load(DB.CLIENTES);
  console.log('üìä Clientes actuales en DB:', clientes.length);

  // Si no hay clientes, crear algunos de ejemplo
  if (clientes.length === 0) {
    console.log('‚öôÔ∏è Creando clientes de ejemplo...');
    const clientesEjemplo = [
      {
        id: genId('CLI'),
        dni: '12345678',
        nombre: 'Aldo',
        apellidos: 'Mendoza Huaman',
        telefono: '987654321',
        email: 'aldo@email.com',
        direccion: 'Av. Principal 123',
        fechaNacimiento: '1990-05-15',
        tipo: 'NATURAL',
        fechaRegistro: new Date().toISOString()
      },
      {
        id: genId('CLI'),
        dni: '87654321',
        nombre: 'Mar√≠a',
        apellidos: 'Garc√≠a L√≥pez',
        telefono: '987123456',
        email: 'maria@email.com',
        direccion: 'Jr. Los Olivos 456',
        fechaNacimiento: '1985-08-20',
        tipo: 'NATURAL',
        fechaRegistro: new Date().toISOString()
      },
      {
        id: genId('CLI'),
        dni: '45678912',
        nombre: 'Juan',
        apellidos: 'P√©rez Rodr√≠guez',
        telefono: '998877665',
        email: 'juan@email.com',
        direccion: 'Calle Real 789',
        fechaNacimiento: '1995-03-10',
        tipo: 'NATURAL',
        fechaRegistro: new Date().toISOString()
      }
    ];

    save(DB.CLIENTES, clientesEjemplo);
    console.log('‚úÖ Clientes de ejemplo creados:', clientesEjemplo.length);
    console.log('üë• Datos guardados:', clientesEjemplo);
  } else {
    console.log('‚ÑπÔ∏è Ya existen clientes en la base de datos');
  }
}

// Verificar sesi√≥n al cargar la p√°gina
if (verificarSesion()) {
  // Si hay sesi√≥n v√°lida, inicializar sistema
  inicializarSistema();
  toast('‚úÖ Sesi√≥n restaurada - ' + usuarioActual);
} else {
  // Auto-login para desarrollo (comentar en producci√≥n)
  console.log('üîê Iniciando auto-login...');

  // Crear sesi√≥n autom√°tica con el primer establecimiento
  const autoEstablecimiento = 'DOS_DE_MAYO';
  const autoUsuario = 'Centro √ìptico Sicuani';

  establecimientoActual = autoEstablecimiento;
  usuarioActual = autoUsuario;

  // Guardar sesi√≥n
  localStorage.setItem('optica_sesion', JSON.stringify({
    establecimiento: autoEstablecimiento,
    usuario: autoUsuario,
    timestamp: Date.now()
  }));

  // Ocultar login y mostrar sistema
  document.getElementById('loginOverlay').classList.add('hidden');
  const ribbonElement = document.getElementById('ribbon');
  if (ribbonElement) {
    ribbonElement.classList.remove('hidden');
    ribbonElement.style.display = 'flex';
  }

  // Actualizar badge
  const credenciales = CREDENCIALES[autoEstablecimiento];
  document.getElementById('establecimientoBadge').textContent = 'üè™ ' + credenciales.nombreMostrar;

  // Actualizar logo principal del dashboard
  actualizarLogoPrincipal(autoEstablecimiento);

  // Inicializar sistema
  actualizarDB();
  inicializarSistema();

  toast('‚úÖ Sistema listo - ' + autoUsuario);
  console.log('‚úÖ Auto-login completado');
}

/* ============================================
   PANEL LATERAL DE CONFIGURACI√ìN R√ÅPIDA
   ============================================ */

// Toggle del panel lateral
function toggleConfigPanel() {
  const panel = document.getElementById('configSidePanel');
  const btn = document.getElementById('configFloatBtn');

  if (panel.classList.contains('open')) {
    panel.classList.remove('open');
    btn.classList.remove('active');
  } else {
    panel.classList.add('open');
    btn.classList.add('active');
  }
}

// Cerrar modal de configuraci√≥n
function cerrarModalConfiguracion(modalId) {
  const modal = document.getElementById(modalId);
  if (modal) {
    modal.classList.remove('active');
  }
}

// ‚ú® FUNCI√ìN SALIR DEL SISTEMA - CIERRA TODOS LOS MODALES Y PANELES ‚ú®
function salirSistema() {
  // Cerrar modal de visualizaci√≥n RX si est√° abierto
  const modalRX = document.getElementById('modalVisualizacionRX');
  if (modalRX) {
    modalRX.style.display = 'none';
    rxActualModal = null;
  }

  // Cerrar modal de consultas
  const modalConsulta = document.getElementById('modalConsultaDetalle');
  if (modalConsulta) {
    modalConsulta.style.display = 'none';
  }

  // Cerrar modal de historial
  const modalHistorial = document.getElementById('modalHistorialConsulta');
  if (modalHistorial) {
    modalHistorial.style.display = 'none';
  }

  // Cerrar todos los modales de configuraci√≥n
  const modalesConfig = document.querySelectorAll('.config-modal');
  modalesConfig.forEach(modal => {
    modal.classList.remove('active');
  });

  // Cerrar panel de configuraci√≥n
  const panel = document.getElementById('configSidePanel');
  const btn = document.getElementById('configFloatBtn');
  if (panel && panel.classList.contains('open')) {
    panel.classList.remove('open');
    btn.classList.remove('active');
  }

  // Cerrar cualquier otro modal gen√©rico
  const modalesGenericos = document.querySelectorAll('.modal-overlay, .mdi-window-overlay');
  modalesGenericos.forEach(modal => {
    modal.style.display = 'none';
  });

  // Notificaci√≥n
  toast('üëã Modales cerrados correctamente', 'info');
}

// ============================================
// 1. CAMBIAR CONTRASE√ëA
// ============================================
function abrirCambiarContrasena() {
  toggleConfigPanel(); // Cerrar panel lateral
  document.getElementById('modalCambiarContrasena').classList.add('active');
  document.getElementById('nuevaContrasena').value = '';
  document.getElementById('confirmarContrasena').value = '';
}

function guardarNuevaContrasena() {
  const nueva = document.getElementById('nuevaContrasena').value;
  const confirmar = document.getElementById('confirmarContrasena').value;

  if (!nueva || !confirmar) {
    toast('Complete todos los campos', 'error');
    return;
  }

  if (nueva !== confirmar) {
    toast('Las contrase√±as no coinciden', 'error');
    return;
  }

  if (nueva.length < 4) {
    toast('La contrase√±a debe tener al menos 4 caracteres', 'warning');
    return;
  }

  // Guardar nueva contrase√±a para el establecimiento actual
  if (establecimientoActual && CREDENCIALES[establecimientoActual]) {
    CREDENCIALES[establecimientoActual].password = nueva;

    // Guardar en localStorage
    localStorage.setItem('CREDENCIALES_' + establecimientoActual, JSON.stringify({
      password: nueva,
      usuario: CREDENCIALES[establecimientoActual].usuario
    }));

    toast('Contrase√±a actualizada correctamente', 'success');
    cerrarModalConfiguracion('modalCambiarContrasena');
  } else {
    toast('Error: No se pudo identificar el establecimiento', 'error');
  }
}

// ============================================
// 2. CAMBIAR ALMAC√âN
// ============================================
let almacenActual = 'PREMIUM'; // Almac√©n por defecto

function abrirCambiarAlmacen() {
  toggleConfigPanel();
  document.getElementById('modalCambiarAlmacen').classList.add('active');
  document.getElementById('selectAlmacen').value = almacenActual;
}

function cambiarAlmacen() {
  const nuevoAlmacen = document.getElementById('selectAlmacen').value;
  almacenActual = nuevoAlmacen;

  // Guardar en localStorage
  localStorage.setItem('almacenActual', nuevoAlmacen);

  toast(`Almac√©n cambiado a: ${nuevoAlmacen}`, 'success');
  cerrarModalConfiguracion('modalCambiarAlmacen');

  // Actualizar badge si existe
  const badge = document.getElementById('establecimientoBadge');
  if (badge) {
    badge.innerHTML = `üè™ ${establecimientoActual ? CREDENCIALES[establecimientoActual].nombreMostrar : ''} - ${almacenActual}`;
  }
}

// ============================================
// 3. CAMBIAR ESTILO (TEMAS)
// ============================================
// Variable movida al inicio del script (l√≠nea 9697)

const TEMAS = {
  'sicuani': {
    nombre: 'Sicuani Original',
    colores: {
      primario: '#9333ea',
      secundario: '#7c3aed',
      texto: '#1f2937',
      fondo: '#faf5ff',
      textoContenido: '#1f2937',
      fondoCard: '#ffffff',
      textoLabel: '#374151',
      ribbonBg: '#9333ea',
      ribbonText: '#ffffff',
      cardTitleBg: '#9333ea',
      inputBg: '#ffffff',
      inputText: '#1f2937',
      inputBorder: '#c084fc',
      inputPlaceholder: '#9ca3af'
    },
    dark: false,
    original: true
  },
  'office2010black': {
    nombre: 'Office Black',
    colores: {
      primario: '#dc2626',
      secundario: '#b91c1c',
      texto: '#ffffff',
      fondo: '#18181b',
      textoContenido: '#f3f4f6',
      fondoCard: '#27272a',
      textoLabel: '#d4d4d8',
      ribbonBg: '#dc2626',
      ribbonText: '#ffffff',
      inputBg: '#3f3f46',
      inputText: '#f3f4f6',
      inputBorder: '#71717a',
      inputPlaceholder: '#a1a1aa'
    },
    dark: true
  },
  'office2010blue': {
    nombre: 'Office Blue',
    colores: {
      primario: '#2563eb',
      secundario: '#1d4ed8',
      texto: '#1f2937',
      fondo: '#eff6ff',
      textoContenido: '#1e293b',
      fondoCard: '#ffffff',
      textoLabel: '#475569',
      ribbonBg: '#2563eb',
      ribbonText: '#ffffff',
      inputBg: '#ffffff',
      inputText: '#1e293b',
      inputBorder: '#93c5fd',
      inputPlaceholder: '#94a3b8'
    },
    dark: false
  },
  'office2010silver': {
    nombre: 'Office Silver',
    colores: {
      primario: '#475569',
      secundario: '#334155',
      texto: '#0f172a',
      fondo: '#f1f5f9',
      textoContenido: '#1e293b',
      fondoCard: '#ffffff',
      textoLabel: '#475569',
      ribbonBg: '#64748b',
      ribbonText: '#ffffff',
      inputBg: '#ffffff',
      inputText: '#1e293b',
      inputBorder: '#cbd5e1',
      inputPlaceholder: '#94a3b8'
    },
    dark: false
  },
  'visualstudio2012blue': {
    nombre: 'VS Blue',
    colores: {
      primario: '#0891b2',
      secundario: '#0e7490',
      texto: '#164e63',
      fondo: '#ecfeff',
      textoContenido: '#164e63',
      fondoCard: '#ffffff',
      textoLabel: '#0e7490',
      ribbonBg: '#0891b2',
      ribbonText: '#ffffff',
      inputBg: '#ffffff',
      inputText: '#164e63',
      inputBorder: '#67e8f9',
      inputPlaceholder: '#94a3b8'
    },
    dark: false
  },
  'visualstudio2012dark': {
    nombre: 'VS Dark',
    colores: {
      primario: '#3b82f6',
      secundario: '#2563eb',
      texto: '#ffffff',
      fondo: '#0f172a',
      textoContenido: '#f1f5f9',
      fondoCard: '#1e293b',
      textoLabel: '#cbd5e1',
      ribbonBg: '#3b82f6',
      ribbonText: '#ffffff',
      inputBg: '#334155',
      inputText: '#f1f5f9',
      inputBorder: '#475569',
      inputPlaceholder: '#94a3b8'
    },
    dark: true
  },
  'visualstudio2012light': {
    nombre: 'VS Light',
    colores: {
      primario: '#64748b',
      secundario: '#475569',
      texto: '#0f172a',
      fondo: '#ffffff',
      textoContenido: '#1e293b',
      fondoCard: '#f8fafc',
      textoLabel: '#475569',
      ribbonBg: '#64748b',
      ribbonText: '#ffffff',
      inputBg: '#ffffff',
      inputText: '#1e293b',
      inputBorder: '#e2e8f0',
      inputPlaceholder: '#94a3b8'
    },
    dark: false
  },
  'windows7blue': {
    nombre: 'Windows Blue',
    colores: {
      primario: '#1d4ed8',
      secundario: '#1e40af',
      texto: '#1e3a8a',
      fondo: '#dbeafe',
      textoContenido: '#1e3a8a',
      fondoCard: '#ffffff',
      textoLabel: '#1e40af',
      ribbonBg: '#1d4ed8',
      ribbonText: '#ffffff',
      inputBg: '#ffffff',
      inputText: '#1e3a8a',
      inputBorder: '#93c5fd',
      inputPlaceholder: '#94a3b8'
    },
    dark: false
  },
  'metro': {
    nombre: 'Metro Purple',
    colores: {
      primario: '#7c3aed',
      secundario: '#6d28d9',
      texto: '#4c1d95',
      fondo: '#f5f3ff',
      textoContenido: '#5b21b6',
      fondoCard: '#ffffff',
      textoLabel: '#6d28d9',
      ribbonBg: '#7c3aed',
      ribbonText: '#ffffff',
      inputBg: '#ffffff',
      inputText: '#5b21b6',
      inputBorder: '#c4b5fd',
      inputPlaceholder: '#94a3b8'
    },
    dark: false
  },
  'forest': {
    nombre: 'Forest Green',
    colores: {
      primario: '#059669',
      secundario: '#047857',
      texto: '#064e3b',
      fondo: '#ecfdf5',
      textoContenido: '#064e3b',
      fondoCard: '#ffffff',
      textoLabel: '#047857',
      ribbonBg: '#059669',
      ribbonText: '#ffffff',
      inputBg: '#ffffff',
      inputText: '#064e3b',
      inputBorder: '#6ee7b7',
      inputPlaceholder: '#94a3b8'
    },
    dark: false
  },
  'sunset': {
    nombre: 'Sunset Orange',
    colores: {
      primario: '#ea580c',
      secundario: '#c2410c',
      texto: '#7c2d12',
      fondo: '#fff7ed',
      textoContenido: '#7c2d12',
      fondoCard: '#ffffff',
      textoLabel: '#9a3412',
      ribbonBg: '#ea580c',
      ribbonText: '#ffffff',
      inputBg: '#ffffff',
      inputText: '#7c2d12',
      inputBorder: '#fdba74',
      inputPlaceholder: '#94a3b8'
    },
    dark: false
  },
  'midnight': {
    nombre: 'Midnight Blue',
    colores: {
      primario: '#6366f1',
      secundario: '#4f46e5',
      texto: '#ffffff',
      fondo: '#1e1b4b',
      textoContenido: '#e0e7ff',
      fondoCard: '#312e81',
      textoLabel: '#c7d2fe',
      ribbonBg: '#6366f1',
      ribbonText: '#ffffff',
      inputBg: '#3730a3',
      inputText: '#e0e7ff',
      inputBorder: '#4f46e5',
      inputPlaceholder: '#a5b4fc'
    },
    dark: true
  },
  'professional': {
    nombre: 'Professional Blue',
    colores: {
      primario: '#3b82f6',
      secundario: '#2563eb',
      texto: '#1e293b',
      fondo: '#f8fafc',
      textoContenido: '#1e293b',
      fondoCard: '#ffffff',
      textoLabel: '#475569',
      ribbonBg: '#3b82f6',
      ribbonText: '#ffffff',
      cardTitleBg: '#3b82f6',
      inputBg: '#ffffff',
      inputText: '#1e293b',
      inputBorder: '#93c5fd',
      inputPlaceholder: '#94a3b8'
    },
    dark: false,
    classic: true
  }
};

function abrirCambiarEstilo() {
  toggleConfigPanel();
  document.getElementById('modalCambiarEstilo').classList.add('active');

  // Marcar tema activo
  document.querySelectorAll('.theme-card').forEach(card => {
    card.classList.remove('active');
  });
}

function aplicarTema(nombreTema) {
  if (!TEMAS[nombreTema]) {
    toast('Tema no encontrado', 'error');
    return;
  }

  temaActual = nombreTema;
  const tema = TEMAS[nombreTema];

  // ==== RIBBON ====
  const ribbon = document.getElementById('ribbon');
  if (ribbon) {
    ribbon.style.background = `linear-gradient(135deg, ${tema.colores.ribbonBg || tema.colores.primario} 0%, ${tema.colores.secundario} 100%)`;
    ribbon.style.borderBottom = `3px solid ${tema.colores.primario}`;
    ribbon.style.color = tema.colores.ribbonText || '#ffffff';

    const ribbonBtns = ribbon.querySelectorAll('.ribbon-btn');
    ribbonBtns.forEach(btn => {
      btn.style.color = tema.colores.ribbonText || '#ffffff';
      if (tema.original) {
        btn.style.background = 'rgba(255,255,255,0.95)';
        btn.style.border = '1px solid rgba(255,255,255,0.3)';
        btn.style.color = tema.colores.primario;
      } else {
        btn.style.background = 'rgba(255,255,255,0.1)';
        btn.style.border = '1px solid rgba(255,255,255,0.2)';
        btn.style.color = '#ffffff';
      }
    });

    const ribbonLabels = ribbon.querySelectorAll('h4');
    ribbonLabels.forEach(label => {
      if (tema.original) {
        label.style.color = 'rgba(255,255,255,0.9)';
      } else {
        label.style.color = 'rgba(255,255,255,0.8)';
      }
    });

    const ribbonSpans = ribbon.querySelectorAll('.ribbon-btn span');
    ribbonSpans.forEach(span => {
      if (tema.original) {
        span.style.color = tema.colores.primario;
      } else {
        span.style.color = '#ffffff';
      }
    });

    // Bot√≥n activo
    const activeBtn = ribbon.querySelector('.ribbon-btn.active');
    if (activeBtn) {
      activeBtn.style.background = 'rgba(255,255,255,0.25)';
      activeBtn.style.color = '#ffffff';
      activeBtn.style.borderColor = 'rgba(255,255,255,0.4)';
      activeBtn.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
      const activeSpan = activeBtn.querySelector('span');
      if (activeSpan) activeSpan.style.color = '#ffffff';
    }
  }

  // ==== FONDO DEL SISTEMA ====
  const desktop = document.getElementById('desktop');
  if (desktop) {
    desktop.style.background = tema.colores.fondo;
  }

  // ==== VENTANA PRINCIPAL ====
  const appWindow = document.getElementById('appWindow');
  if (appWindow) {
    appWindow.style.background = tema.colores.fondoCard;
    appWindow.style.color = tema.colores.textoContenido;
  }

  // ==== CARDS ====
  const cards = document.querySelectorAll('.card');
  cards.forEach(card => {
    card.style.background = tema.colores.fondoCard;
    card.style.color = tema.colores.textoContenido;
  });

  // ==== CARD TITLES ====
  const cardTitles = document.querySelectorAll('.card-title');
  cardTitles.forEach(title => {
    title.style.background = `linear-gradient(135deg, ${tema.colores.primario} 0%, ${tema.colores.secundario} 100%)`;
    title.style.color = '#ffffff';
  });

  // ==== LABELS Y TEXTOS ====
  const labels = document.querySelectorAll('label:not(.btn), .config-form-label, .field label');
  labels.forEach(label => {
    label.style.color = tema.colores.textoLabel;
    label.style.fontWeight = '500';
  });

  // ==== INPUTS, SELECTS, TEXTAREAS ====
  const inputs = document.querySelectorAll('input:not([type="checkbox"]):not([type="radio"]), select, textarea');
  inputs.forEach(input => {
    input.style.background = tema.colores.inputBg;
    input.style.color = tema.colores.inputText;
    input.style.borderColor = tema.colores.inputBorder;
    input.style.border = `1px solid ${tema.colores.inputBorder}`;
  });

  // ==== TABLAS ====
  const tables = document.querySelectorAll('.data-table, table');
  tables.forEach(table => {
    const thead = table.querySelector('thead');
    const tbody = table.querySelector('tbody');
    const tfoot = table.querySelector('tfoot');

    if (thead) {
      const ths = thead.querySelectorAll('th');
      ths.forEach(th => {
        th.style.background = `linear-gradient(135deg, ${tema.colores.primario} 0%, ${tema.colores.secundario} 100%)`;
        th.style.color = tema.colores.ribbonText || '#ffffff';
        th.style.fontWeight = '600';
      });
    }

    if (tbody) {
      const rows = tbody.querySelectorAll('tr');
      rows.forEach((row, index) => {
        if (tema.dark) {
          row.style.background = index % 2 === 0 ? tema.colores.fondoCard : tema.colores.fondo;
          row.style.color = tema.colores.textoContenido;
        } else {
          row.style.background = index % 2 === 0 ? '#ffffff' : '#fafafa';
          row.style.color = tema.colores.textoContenido;
        }

        const cells = row.querySelectorAll('td');
        cells.forEach(cell => {
          cell.style.color = tema.colores.textoContenido;
          cell.style.borderColor = tema.dark ? tema.colores.inputBorder : '#e4e4e7';
        });
      });
    }

    if (tfoot) {
      const tds = tfoot.querySelectorAll('td');
      tds.forEach(td => {
        td.style.background = tema.dark ? tema.colores.fondoCard : '#f4f4f5';
        td.style.color = tema.colores.textoContenido;
        td.style.fontWeight = '600';
      });
    }
  });

  // ==== HEADER DE APP ====
  const appHeader = document.querySelector('.app-header');
  if (appHeader) {
    if (tema.dark) {
      appHeader.style.background = `linear-gradient(180deg, ${tema.colores.fondoCard} 0%, ${tema.colores.fondo} 100%)`;
      appHeader.style.borderBottom = `2px solid ${tema.colores.primario}`;
    } else {
      appHeader.style.background = `linear-gradient(180deg, ${tema.colores.fondo} 0%, ${tema.colores.fondoCard} 100%)`;
      appHeader.style.borderBottom = `2px solid ${tema.colores.primario}`;
    }
  }

  // ==== TEXTOS GENERALES ====
  document.body.style.color = tema.colores.textoContenido;

  // T√≠tulos y encabezados
  const headings = document.querySelectorAll('h1, h2, h3, h4, h5, h6');
  headings.forEach(h => {
    if (!h.closest('.ribbon') && !h.closest('.card-title')) {
      h.style.color = tema.colores.textoContenido;
    }
  });

  // Textos de secci√≥n (app-header)
  const sectionTexts = document.querySelectorAll('.app-header h1, .app-header small, .app-header span');
  sectionTexts.forEach(el => {
    el.style.color = tema.colores.textoContenido;
  });

  // Field labels y otros textos
  const allTexts = document.querySelectorAll('p, small, .field label, .config-form-label');
  allTexts.forEach(el => {
    if (!el.closest('.btn') && !el.closest('.badge') && !el.closest('#ribbon') && !el.closest('.card-title')) {
      el.style.color = tema.colores.textoLabel;
    }
  });

  // ==== HISTORIAL ITEMS (selecciones) ====
  const historialItems = document.querySelectorAll('.historial-item');
  historialItems.forEach(item => {
    if (!item.classList.contains('selected')) {
      if (tema.dark) {
        item.style.background = tema.colores.inputBg;
        item.style.borderColor = tema.colores.inputBorder;
        item.style.color = tema.colores.textoContenido;
      } else {
        item.style.background = '#f9fafb';
        item.style.borderColor = '#e5e7eb';
        item.style.color = tema.colores.textoContenido;
      }
    }
  });

  const historialItemsSelected = document.querySelectorAll('.historial-item.selected');
  historialItemsSelected.forEach(item => {
    if (tema.dark) {
      item.style.background = tema.colores.primario;
      item.style.borderColor = tema.colores.secundario;
      item.style.color = '#ffffff';
    } else {
      item.style.background = tema.colores.fondo;
      item.style.borderColor = tema.colores.primario;
      item.style.color = tema.colores.textoContenido;
    }
    item.style.boxShadow = `0 0 0 3px ${tema.colores.primario}33`;
  });

  // ==== ELEMENTOS DE CONSULTAS ====
  const consultaListaClientes = document.getElementById('consultaListaClientes');
  if (consultaListaClientes) {
    consultaListaClientes.style.background = tema.colores.fondoCard;
    consultaListaClientes.style.color = tema.colores.textoContenido;
    // Textos internos
    const textosConsulta = consultaListaClientes.querySelectorAll('div[style*="color"]');
    textosConsulta.forEach(txt => {
      txt.style.color = tema.colores.textoLabel;
    });
  }

  const consultaDetalleCliente = document.getElementById('consultaDetalleCliente');
  if (consultaDetalleCliente) {
    const fondoDetalle = consultaDetalleCliente.querySelector('div[style*="background"]');
    if (fondoDetalle) {
      fondoDetalle.style.background = tema.colores.fondo;
      fondoDetalle.style.color = tema.colores.textoLabel;
    }
  }

  // ==== TODOS LOS DIVS CON FONDO BLANCO HARDCODED ====
  const allDivs = document.querySelectorAll('div[style*="background: white"], div[style*="background: #fff"]');
  allDivs.forEach(div => {
    if (!div.closest('.login-container') && !div.closest('.config-modal')) {
      if (tema.dark) {
        div.style.background = tema.colores.fondoCard;
        div.style.color = tema.colores.textoContenido;
      }
    }
  });

  // ==== DIVS CON FONDO GRIS CLARO ====
  const grayDivs = document.querySelectorAll('div[style*="background: #f9fafb"], div[style*="background: #f3f4f6"]');
  grayDivs.forEach(div => {
    if (!div.closest('.login-container')) {
      if (tema.dark) {
        div.style.background = tema.colores.inputBg;
        div.style.color = tema.colores.textoContenido;
      }
    }
  });

  // ==== MODALES DE CONFIGURACI√ìN ====
  const configModals = document.querySelectorAll('.config-modal-content');
  configModals.forEach(modal => {
    modal.style.background = tema.colores.fondoCard;
    modal.style.color = tema.colores.textoContenido;
  });

  const configModalHeaders = document.querySelectorAll('.config-modal-header');
  configModalHeaders.forEach(header => {
    header.style.background = `linear-gradient(135deg, ${tema.colores.primario} 0%, ${tema.colores.secundario} 100%)`;
    header.style.color = tema.colores.ribbonText || '#ffffff';
  });

  const configModalBodies = document.querySelectorAll('.config-modal-body');
  configModalBodies.forEach(body => {
    body.style.background = tema.colores.fondoCard;
    body.style.color = tema.colores.textoContenido;
  });

  // ==== TABS ====
  const tabsContainers = document.querySelectorAll('.tabs');
  tabsContainers.forEach(tabs => {
    tabs.style.background = tema.colores.fondo;
    tabs.style.borderBottom = `2px solid ${tema.colores.primario}`;
  });

  const tabBtns = document.querySelectorAll('.tab-btn');
  tabBtns.forEach(btn => {
    if (!btn.classList.contains('active')) {
      btn.style.background = 'transparent';
      btn.style.color = tema.colores.textoLabel;
    }
  });

  const tabBtnsActive = document.querySelectorAll('.tab-btn.active');
  tabBtnsActive.forEach(btn => {
    btn.style.background = tema.colores.fondoCard;
    btn.style.color = tema.colores.primario;
    btn.style.borderBottomColor = tema.colores.primario;
  });

  // ==== BOTONES ====
  const buttons = document.querySelectorAll('.btn:not(.ribbon-btn)');
  buttons.forEach(btn => {
    if (btn.classList.contains('btn-primary')) {
      btn.style.background = `linear-gradient(135deg, ${tema.colores.primario} 0%, ${tema.colores.secundario} 100%)`;
      btn.style.color = '#ffffff';
      btn.style.border = 'none';
    }
  });

  // ==== PLACEHOLDER COLOR FIX ====
  const style = document.createElement('style');
  style.id = 'dynamic-placeholder-style';
  const existingStyle = document.getElementById('dynamic-placeholder-style');
  if (existingStyle) existingStyle.remove();

  style.textContent = `
    input::placeholder,
    textarea::placeholder,
    select::placeholder {
      color: ${tema.colores.inputPlaceholder} !important;
      opacity: 1;
    }
  `;
  document.head.appendChild(style);

  // Guardar tema seleccionado
  localStorage.setItem('temaActual', nombreTema);

  // ==== MARCAR TEMA ACTIVO ====
  document.querySelectorAll('.theme-card').forEach(card => {
    card.classList.remove('active');
  });

  // Marcar la tarjeta del tema actual
  const themeCards = document.querySelectorAll('.theme-card');
  themeCards.forEach(card => {
    const cardTheme = card.getAttribute('onclick').match(/'([^']+)'/)[1];
    if (cardTheme === nombreTema) {
      card.classList.add('active');
    }
  });

  // ==== GUARDAR PREFERENCIA ====
  localStorage.setItem('temaActual', nombreTema);

  toast(`‚ú® Tema aplicado: ${tema.nombre}`, 'success');
}

// ============================================
// 4. RECORDATORIOS
// ============================================
const DB_RECORDATORIOS = 'recordatorios';

function abrirRecordatorios() {
  toggleConfigPanel();
  document.getElementById('modalRecordatorios').classList.add('active');
  cargarRecordatorios();
}

function mostrarFormNuevoRecordatorio() {
  document.getElementById('formNuevoRecordatorio').style.display = 'block';
  document.getElementById('recordatorioFecha').value = today();
  document.getElementById('recordatorioNota').value = '';
}

function cancelarNuevoRecordatorio() {
  document.getElementById('formNuevoRecordatorio').style.display = 'none';
}

function agregarRecordatorio() {
  const fecha = document.getElementById('recordatorioFecha').value;
  const nota = document.getElementById('recordatorioNota').value.trim();

  if (!fecha || !nota) {
    toast('Complete todos los campos', 'warning');
    return;
  }

  const recordatorios = load(DB_RECORDATORIOS) || [];
  recordatorios.push({
    id: genId('REC'),
    fecha: fecha,
    nota: nota,
    creado: new Date().toISOString()
  });

  save(DB_RECORDATORIOS, recordatorios);
  cancelarNuevoRecordatorio();
  cargarRecordatorios();
  toast('Recordatorio agregado', 'success');
}

function cargarRecordatorios() {
  const recordatorios = load(DB_RECORDATORIOS) || [];
  const lista = document.getElementById('listaRecordatorios');

  if (recordatorios.length === 0) {
    lista.innerHTML = '<div style="text-align: center; padding: 40px; color: #9ca3af;">No hay recordatorios</div>';
    return;
  }

  // Ordenar por fecha
  recordatorios.sort((a, b) => a.fecha.localeCompare(b.fecha));

  lista.innerHTML = recordatorios.map(r => `
    <div class="recordatorio-item">
      <div class="recordatorio-fecha">üìÖ ${formatDate(r.fecha)}</div>
      <div class="recordatorio-nota">${r.nota}</div>
      <button class="btn btn-danger btn-sm" style="margin-top: 8px;" onclick="eliminarRecordatorio('${r.id}')">üóëÔ∏è Eliminar</button>
    </div>
  `).join('');
}

function eliminarRecordatorio(id) {
  if (!confirm('¬øEliminar este recordatorio?')) return;

  let recordatorios = load(DB_RECORDATORIOS) || [];
  recordatorios = recordatorios.filter(r => r.id !== id);
  save(DB_RECORDATORIOS, recordatorios);
  cargarRecordatorios();
  toast('Recordatorio eliminado', 'success');
}

// ============================================
// 5. VER AVISOS DEL SISTEMA
// ============================================
const DB_AVISOS = 'avisos';

function abrirVerAvisos() {
  toggleConfigPanel();
  document.getElementById('modalVerAvisos').classList.add('active');
  cargarAvisos();
}

function cargarAvisos() {
  const avisos = load(DB_AVISOS) || [];
  const lista = document.getElementById('listaAvisos');

  // Generar avisos autom√°ticos del sistema
  generarAvisosAutomaticos();

  const todosAvisos = load(DB_AVISOS) || [];

  if (todosAvisos.length === 0) {
    lista.innerHTML = '<div style="text-align: center; padding: 40px; color: #9ca3af;">No hay avisos pendientes</div>';
    return;
  }

  lista.innerHTML = todosAvisos.map(aviso => `
    <div class="aviso-item">
      <div class="aviso-content">
        <div class="aviso-titulo">${aviso.titulo}</div>
        <div class="aviso-mensaje">${aviso.mensaje}</div>
      </div>
      ${aviso.detalles ? `<button class="aviso-detalles" onclick="mostrarDetallesAviso('${aviso.id}')">Ver Detalles</button>` : ''}
    </div>
  `).join('');
}

function generarAvisosAutomaticos() {
  const avisos = load(DB_AVISOS) || [];

  // Limpiar avisos antiguos (m√°s de 7 d√≠as)
  const hace7Dias = new Date();
  hace7Dias.setDate(hace7Dias.getDate() - 7);
  const avisosValidos = avisos.filter(a => new Date(a.fecha) > hace7Dias);

  // Verificar productos con stock bajo
  const productos = load(DB.PRODUCTOS);
  const productosBajoStock = productos.filter(p => parseInt(p.stock) < 5);

  if (productosBajoStock.length > 0 && !avisosValidos.some(a => a.tipo === 'stock_bajo')) {
    avisosValidos.push({
      id: genId('AVI'),
      tipo: 'stock_bajo',
      titulo: 'üì¶ Productos con Stock Bajo',
      mensaje: `Existen ${productosBajoStock.length} productos con menos de 5 unidades en stock`,
      fecha: new Date().toISOString(),
      visto: false
    });
  }

  // Verificar √≥rdenes pendientes (simulado)
  const ventas = load(DB.VENTAS);
  const ordenesPendientes = ventas.filter(v => v.estado === 'PENDIENTE');

  if (ordenesPendientes.length > 0 && !avisosValidos.some(a => a.tipo === 'ordenes_pendientes')) {
    avisosValidos.push({
      id: genId('AVI'),
      tipo: 'ordenes_pendientes',
      titulo: 'üìã √ìrdenes Pendientes de Entrega',
      mensaje: `Tienes ${ordenesPendientes.length} ventas con estado pendiente`,
      fecha: new Date().toISOString(),
      visto: false
    });
  }

  save(DB_AVISOS, avisosValidos);
}

function mostrarDetallesAviso(id) {
  const avisos = load(DB_AVISOS) || [];
  const aviso = avisos.find(a => a.id === id);

  if (aviso && aviso.detalles) {
    alert(aviso.detalles);
  }
}

function marcarAvisosComoVistos() {
  const avisos = load(DB_AVISOS) || [];
  avisos.forEach(a => a.visto = true);
  save(DB_AVISOS, avisos);
  toast('Avisos marcados como vistos', 'success');
  cerrarModalConfiguracion('modalVerAvisos');
}

// Cargar configuraci√≥n guardada al iniciar
function cargarConfiguracionInicial() {
  // Cargar almac√©n guardado
  const almacenGuardado = localStorage.getItem('almacenActual');
  if (almacenGuardado) {
    almacenActual = almacenGuardado;
  }

  // Cargar tema guardado o aplicar tema por defecto
  const temaGuardado = localStorage.getItem('temaActual');
  if (temaGuardado && TEMAS[temaGuardado]) {
    aplicarTema(temaGuardado);
  } else {
    // Aplicar tema por defecto 'sicuani'
    aplicarTema('sicuani');
  }

  // Cargar credenciales personalizadas
  if (establecimientoActual) {
    const credGuardadas = localStorage.getItem('CREDENCIALES_' + establecimientoActual);
    if (credGuardadas) {
      try {
        const cred = JSON.parse(credGuardadas);
        if (cred.password) {
          CREDENCIALES[establecimientoActual].password = cred.password;
        }
      } catch (e) {
        console.error('Error al cargar credenciales:', e);
      }
    }
  }
}

// Llamar al cargar el sistema
setTimeout(() => {
  cargarConfiguracionInicial();
}, 500);

// ============================================
// GESTI√ìN DE CAJA
// ============================================

// Constantes de base de datos para Caja
const DB_CAJA_APERTURAS = 'caja_aperturas';
const DB_MOVIMIENTOS_CAJA = 'movimientos_caja';
const DB_COBROS_VENTAS = 'cobros_ventas';
const DB_PAGOS_PROVEEDORES = 'pagos_proveedores';

// Estado de la caja
let cajaActual = null;

// ============================================
// NAVEGACI√ìN DE TABS EN CAJA
// ============================================
function mostrarCajaTab(tabId, button) {
  // Ocultar todos los tabs
  document.querySelectorAll('#caja .config-tab-content').forEach(tab => {
    tab.classList.remove('active');
  });

  // Mostrar el tab seleccionado
  document.getElementById(tabId).classList.add('active');

  // Actualizar botones
  document.querySelectorAll('#caja .config-tab-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  button.classList.add('active');

  // Cargar datos seg√∫n el tab
  if (tabId === 'tabApertura') {
    verificarEstadoCaja();
  } else if (tabId === 'tabCierre') {
    mostrarResumenCierre();
  } else if (tabId === 'tabMovimientos') {
    mostrarMovimientosCaja();
  } else if (tabId === 'tabCobroVentas') {
    mostrarCobrosVentas();
  } else if (tabId === 'tabPagoProveedores') {
    mostrarPagosProveedores();
  }
}

// ============================================
// 1. APERTURA DE CAJA
// ============================================
function verificarEstadoCaja() {
  const aperturas = load(DB_CAJA_APERTURAS) || [];
  const hoy = today();

  // Buscar si ya hay apertura del d√≠a
  const aperturaHoy = aperturas.find(a => a.fecha === hoy && a.estado === 'ABIERTA');

  const estadoCajaDiv = document.getElementById('estadoCajaActual');
  const infoCajaDiv = document.getElementById('infoCajaActual');

  if (aperturaHoy) {
    cajaActual = aperturaHoy;
    document.getElementById('aperturaFecha').value = hoy;
    document.getElementById('aperturaMonto').value = aperturaHoy.montoInicial;
    document.getElementById('aperturaObservacion').value = aperturaHoy.observacion || '';

    // Mostrar estado de caja abierta
    if (estadoCajaDiv && infoCajaDiv) {
      estadoCajaDiv.style.display = 'block';
      infoCajaDiv.innerHTML = `
        <p><strong>ID Caja:</strong> ${aperturaHoy.id}</p>
        <p><strong>Monto Inicial:</strong> S/ ${parseFloat(aperturaHoy.montoInicial).toFixed(2)}</p>
        <p><strong>Fecha:</strong> ${aperturaHoy.fecha}</p>
        <p><strong>Usuario:</strong> ${aperturaHoy.usuario}</p>
      `;
    }
  } else {
    cajaActual = null;
    document.getElementById('aperturaFecha').value = hoy;
    document.getElementById('aperturaMonto').value = '';
    document.getElementById('aperturaObservacion').value = '';

    // Ocultar estado de caja
    if (estadoCajaDiv) {
      estadoCajaDiv.style.display = 'none';
    }
  }
}

function guardarAperturaCaja() {
  const fecha = document.getElementById('aperturaFecha').value;
  const monto = parseFloat(document.getElementById('aperturaMonto').value);
  const observacion = document.getElementById('aperturaObservacion').value.trim();

  // Validaciones
  if (!fecha) {
    toast('Debe seleccionar una fecha', 'error');
    return;
  }

  if (isNaN(monto) || monto < 0) {
    toast('El monto inicial debe ser un n√∫mero v√°lido', 'error');
    return;
  }

  const aperturas = load(DB_CAJA_APERTURAS) || [];

  // Verificar si ya existe apertura para esta fecha
  const existeApertura = aperturas.some(a => a.fecha === fecha && a.estado === 'ABIERTA');
  if (existeApertura) {
    toast('Ya existe una apertura de caja para esta fecha', 'error');
    return;
  }

  // Crear nueva apertura
  const nuevaApertura = {
    id: genId('CAJ'),
    fecha: fecha,
    montoInicial: monto,
    observacion: observacion,
    usuario: 'ADMIN',
    establecimiento: establecimientoActual,
    estado: 'ABIERTA',
    fechaRegistro: new Date().toISOString()
  };

  aperturas.push(nuevaApertura);
  save(DB_CAJA_APERTURAS, aperturas);

  cajaActual = nuevaApertura;

  toast('Apertura de caja registrada correctamente', 'success');
  cancelarAperturaCaja();
  verificarEstadoCaja(); // Actualizar vista del estado
}

function cancelarAperturaCaja() {
  document.getElementById('aperturaMonto').value = '';
  document.getElementById('aperturaObservacion').value = '';
}

// ============================================
// 2. CIERRE DE CAJA
// ============================================
function mostrarResumenCierre() {
  if (!cajaActual) {
    const aperturas = load(DB_CAJA_APERTURAS) || [];
    const hoy = today();
    cajaActual = aperturas.find(a => a.fecha === hoy && a.estado === 'ABIERTA');
  }

  if (!cajaActual) {
    document.getElementById('cierreResumenOperaciones').innerHTML =
      '<tr><td colspan="4" style="text-align: center; padding: 20px;">No hay caja aperturada para el d√≠a de hoy</td></tr>';
    document.getElementById('cierreTotalesFormaPago').innerHTML =
      '<tr><td colspan="3" style="text-align: center; padding: 20px;">No hay caja aperturada</td></tr>';
    document.getElementById('cierreMontoApertura').textContent = 'S/ 0.00';
    document.getElementById('cierreMontoFinal').textContent = 'S/ 0.00';
    return;
  }

  // Mostrar monto de apertura
  document.getElementById('cierreMontoApertura').textContent = 'S/ ' + parseFloat(cajaActual.montoInicial).toFixed(2);

  // Obtener todos los movimientos del d√≠a
  const movimientos = load(DB_MOVIMIENTOS_CAJA) || [];
  const cobros = load(DB_COBROS_VENTAS) || [];
  const pagos = load(DB_PAGOS_PROVEEDORES) || [];

  const movimientosHoy = movimientos.filter(m =>
    m.fechaOperacion === cajaActual.fecha && m.estado !== 'ANULADO'
  );
  const cobrosHoy = cobros.filter(c =>
    c.fecha === cajaActual.fecha && c.estado !== 'ANULADO'
  );
  const pagosHoy = pagos.filter(p =>
    p.fecha === cajaActual.fecha && p.estado !== 'ANULADO'
  );

  // Resumen por tipo de operaci√≥n
  const resumenOperaciones = {
    'INGRESO': { cantidad: 0, monto: 0 },
    'EGRESO': { cantidad: 0, monto: 0 }
  };

  movimientosHoy.forEach(m => {
    const tipo = m.tipoOperacion || 'INGRESO';
    resumenOperaciones[tipo].cantidad++;
    resumenOperaciones[tipo].monto += parseFloat(m.monto) || 0;
  });

  cobrosHoy.forEach(c => {
    resumenOperaciones['INGRESO'].cantidad++;
    resumenOperaciones['INGRESO'].monto += parseFloat(c.monto) || 0;
  });

  pagosHoy.forEach(p => {
    resumenOperaciones['EGRESO'].cantidad++;
    resumenOperaciones['EGRESO'].monto += parseFloat(p.monto) || 0;
  });

  // Renderizar tabla de operaciones (columnas: TIPO OPERACI√ìN, Tipo, TOTAL, CAJA)
  let htmlOperaciones = '';
  for (const tipo in resumenOperaciones) {
    const data = resumenOperaciones[tipo];
    htmlOperaciones += `
      <tr>
        <td>${tipo}</td>
        <td style="text-align: center;">${data.cantidad}</td>
        <td style="text-align: right;">S/ ${data.monto.toFixed(2)}</td>
        <td>${cajaActual.id}</td>
      </tr>
    `;
  }

  const totalNeto = resumenOperaciones['INGRESO'].monto - resumenOperaciones['EGRESO'].monto;
  const montoFinalCaja = parseFloat(cajaActual.montoInicial) + totalNeto;

  htmlOperaciones += `
    <tr style="font-weight: bold; background-color: #f3f4f6;">
      <td>TOTAL NETO</td>
      <td style="text-align: center;">${resumenOperaciones['INGRESO'].cantidad + resumenOperaciones['EGRESO'].cantidad}</td>
      <td style="text-align: right; color: ${totalNeto >= 0 ? '#10b981' : '#ef4444'};">S/ ${totalNeto.toFixed(2)}</td>
      <td>${cajaActual.id}</td>
    </tr>
  `;

  document.getElementById('cierreResumenOperaciones').innerHTML = htmlOperaciones;

  // Actualizar monto final de caja
  document.getElementById('cierreMontoFinal').textContent = 'S/ ' + montoFinalCaja.toFixed(2);
  document.getElementById('cierreMontoFinal').style.color = montoFinalCaja >= 0 ? '#059669' : '#dc2626';

  // Resumen por forma de pago
  const resumenPagos = {};

  [...movimientosHoy, ...cobrosHoy, ...pagosHoy].forEach(item => {
    const formaPago = item.formaPago || 'EFECTIVO';
    if (!resumenPagos[formaPago]) {
      resumenPagos[formaPago] = { cantidad: 0, monto: 0 };
    }
    resumenPagos[formaPago].cantidad++;
    const monto = parseFloat(item.monto) || 0;
    if (item.tipoOperacion === 'EGRESO' || pagosHoy.includes(item)) {
      resumenPagos[formaPago].monto -= monto;
    } else {
      resumenPagos[formaPago].monto += monto;
    }
  });

  // Renderizar tabla de formas de pago (columnas: FORMA DE PAGO, TOTAL, CAJA)
  let htmlPagos = '';
  let totalPagos = 0;
  for (const forma in resumenPagos) {
    const data = resumenPagos[forma];
    totalPagos += data.monto;
    htmlPagos += `
      <tr>
        <td>${forma}</td>
        <td style="text-align: right;">S/ ${data.monto.toFixed(2)}</td>
        <td>${cajaActual.id}</td>
      </tr>
    `;
  }

  htmlPagos += `
    <tr style="font-weight: bold; background-color: #f3f4f6;">
      <td>TOTAL</td>
      <td style="text-align: right;">S/ ${totalPagos.toFixed(2)}</td>
      <td>${cajaActual.id}</td>
    </tr>
  `;

  document.getElementById('cierreTotalesFormaPago').innerHTML = htmlPagos;
}

function cerrarCaja() {
  if (!cajaActual) {
    toast('No hay caja aperturada para cerrar', 'error');
    return;
  }

  if (!confirm('¬øEst√° seguro de cerrar la caja? Esta acci√≥n no se puede deshacer')) {
    return;
  }

  const aperturas = load(DB_CAJA_APERTURAS) || [];
  const index = aperturas.findIndex(a => a.id === cajaActual.id);

  if (index !== -1) {
    aperturas[index].estado = 'CERRADA';
    aperturas[index].fechaCierre = new Date().toISOString();
    save(DB_CAJA_APERTURAS, aperturas);

    toast('Caja cerrada exitosamente', 'success');
    cajaActual = null;
    mostrarResumenCierre();
  }
}

function imprimirCierreCaja() {
  const contenido = document.getElementById('tabCajaCierre').innerHTML;
  const ventana = window.open('', '', 'width=800,height=600');
  ventana.document.write(`
    <html>
    <head>
      <title>Cierre de Caja</title>
      <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { padding: 8px; border: 1px solid #ddd; }
        th { background-color: #7c3aed; color: white; }
        h3 { color: #7c3aed; }
      </style>
    </head>
    <body>
      <h2>CENTRO √ìPTICO SICUANI</h2>
      <h3>Cierre de Caja - ${cajaActual ? cajaActual.fecha : ''}</h3>
      ${contenido}
      <p style="margin-top: 40px;">Fecha de impresi√≥n: ${new Date().toLocaleString()}</p>
    </body>
    </html>
  `);
  ventana.document.close();
  ventana.print();
}

function exportarCierreExcel() {
  if (!cajaActual) {
    toast('No hay caja aperturada', 'error');
    return;
  }

  const movimientos = load(DB_MOVIMIENTOS_CAJA) || [];
  const cobros = load(DB_COBROS_VENTAS) || [];
  const pagos = load(DB_PAGOS_PROVEEDORES) || [];

  const data = [
    ['CIERRE DE CAJA - ' + cajaActual.fecha],
    [''],
    ['TIPO', 'CONCEPTO', 'MONTO', 'FORMA PAGO', 'FECHA'],
  ];

  movimientos.filter(m => m.fechaOperacion === cajaActual.fecha && m.estado !== 'ANULADO').forEach(m => {
    data.push([
      m.tipoOperacion,
      m.concepto,
      m.monto,
      m.formaPago,
      m.fechaOperacion
    ]);
  });

  cobros.filter(c => c.fecha === cajaActual.fecha && c.estado !== 'ANULADO').forEach(c => {
    data.push([
      'COBRO VENTA',
      c.concepto || 'Cobro de venta',
      c.monto,
      c.formaPago,
      c.fecha
    ]);
  });

  pagos.filter(p => p.fecha === cajaActual.fecha && p.estado !== 'ANULADO').forEach(p => {
    data.push([
      'PAGO PROVEEDOR',
      p.concepto,
      p.monto,
      p.formaPago,
      p.fecha
    ]);
  });

  const csv = data.map(row => row.join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `cierre_caja_${cajaActual.fecha}.csv`;
  link.click();

  toast('Cierre exportado a Excel', 'success');
}

// ============================================
// 3. MOVIMIENTOS DE CAJA
// ============================================
function mostrarMovimientosCaja() {
  const movimientos = load(DB_MOVIMIENTOS_CAJA) || [];
  const tbody = document.getElementById('movimientosCajaBody');

  if (movimientos.length === 0) {
    tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 20px;">No hay movimientos registrados</td></tr>';
    return;
  }

  tbody.innerHTML = movimientos.map(m => `
    <tr>
      <td>${m.id}</td>
      <td>${m.concepto}</td>
      <td style="text-align: right;">S/ ${parseFloat(m.monto).toFixed(2)}</td>
      <td>${m.tipo || '-'}</td>
      <td>${m.tipoOperacion}</td>
      <td>${m.formaPago}</td>
      <td>${m.fechaOperacion}</td>
      <td>${new Date(m.fechaRegistro).toLocaleString('es-PE', { dateStyle: 'short', timeStyle: 'short' })}</td>
      <td><span class="badge ${m.estado === 'ACTIVO' ? 'badge-success' : 'badge-danger'}">${m.estado}</span></td>
      <td>${m.cajaId || '-'}</td>
    </tr>
  `).join('');
}

function nuevoMovimientoCaja() {
  // Verificar que haya caja abierta
  if (!cajaActual) {
    const aperturas = load(DB_CAJA_APERTURAS) || [];
    const hoy = today();
    cajaActual = aperturas.find(a => a.fecha === hoy && a.estado === 'ABIERTA');
  }

  if (!cajaActual) {
    toast('Debe aperturar la caja antes de registrar movimientos', 'error');
    return;
  }

  // Limpiar y configurar el modal
  document.getElementById('movTipoOperacion').value = '';
  document.getElementById('movConcepto').value = '';
  document.getElementById('movMonto').value = '';
  document.getElementById('movTipo').value = 'EGRESO';
  document.getElementById('movFormaPago').value = 'EFECTIVO';
  document.getElementById('movFechaOperacion').value = today();

  // Abrir modal
  document.getElementById('modalNuevoMovimiento').classList.add('active');
}

function guardarNuevoMovimiento() {
  const tipoOperacion = document.getElementById('movTipoOperacion').value;
  const concepto = document.getElementById('movConcepto').value.trim();
  const monto = parseFloat(document.getElementById('movMonto').value);
  const tipo = document.getElementById('movTipo').value;
  const formaPago = document.getElementById('movFormaPago').value;
  const fechaOperacion = document.getElementById('movFechaOperacion').value;

  // Validaciones
  if (!tipoOperacion) {
    toast('Debe seleccionar el tipo de operaci√≥n', 'error');
    return;
  }

  if (!concepto) {
    toast('Debe ingresar el concepto', 'error');
    return;
  }

  if (isNaN(monto) || monto <= 0) {
    toast('El monto debe ser un n√∫mero v√°lido mayor a 0', 'error');
    return;
  }

  if (!fechaOperacion) {
    toast('Debe seleccionar la fecha de operaci√≥n', 'error');
    return;
  }

  const movimientos = load(DB_MOVIMIENTOS_CAJA) || [];

  const nuevoMovimiento = {
    id: genId('MOV'),
    concepto: concepto,
    monto: monto,
    tipo: tipoOperacion,
    tipoOperacion: tipo,
    formaPago: formaPago,
    fechaOperacion: fechaOperacion,
    fechaRegistro: new Date().toISOString(),
    estado: 'ACTIVO',
    usuario: 'ADMIN',
    cajaId: cajaActual.id
  };

  movimientos.push(nuevoMovimiento);
  save(DB_MOVIMIENTOS_CAJA, movimientos);

  toast('Movimiento registrado correctamente', 'success');
  cerrarModalConfiguracion('modalNuevoMovimiento');
  mostrarMovimientosCaja();
}

function modificarMovimientoSeleccionado() {
  toast('Funci√≥n en desarrollo', 'info');
}

function anularMovimientoSeleccionado() {
  const id = prompt('Ingrese el ID del movimiento a anular:');
  if (!id) return;

  const movimientos = load(DB_MOVIMIENTOS_CAJA) || [];
  const index = movimientos.findIndex(m => m.id === id);

  if (index === -1) {
    toast('Movimiento no encontrado', 'error');
    return;
  }

  if (!confirm('¬øEst√° seguro de anular este movimiento?')) {
    return;
  }

  movimientos[index].estado = 'ANULADO';
  save(DB_MOVIMIENTOS_CAJA, movimientos);

  toast('Movimiento anulado correctamente', 'success');
  mostrarMovimientosCaja();
}

function verDetalleMovimiento() {
  toast('Funci√≥n en desarrollo', 'info');
}

function exportarMovimientosExcel() {
  const movimientos = load(DB_MOVIMIENTOS_CAJA) || [];

  const data = [
    ['ID', 'CONCEPTO', 'MONTO', 'TIPO', 'TIPO OPERACI√ìN', 'FORMA PAGO', 'FECHA OPERACI√ìN', 'FECHA REGISTRO', 'ESTADO']
  ];

  movimientos.forEach(m => {
    data.push([
      m.id,
      m.concepto,
      m.monto,
      m.tipo,
      m.tipoOperacion,
      m.formaPago,
      m.fechaOperacion,
      m.fechaRegistro,
      m.estado
    ]);
  });

  const csv = data.map(row => row.join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `movimientos_caja_${today()}.csv`;
  link.click();

  toast('Movimientos exportados a Excel', 'success');
}

// ============================================
// 4. COBRO DE VENTAS
// ============================================
function mostrarCobrosVentas() {
  const cobros = load(DB_COBROS_VENTAS) || [];
  const tbody = document.getElementById('cobrosVentasBody');

  if (cobros.length === 0) {
    tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 20px;">No hay cobros registrados</td></tr>';
    return;
  }

  tbody.innerHTML = cobros.map(c => `
    <tr>
      <td>${c.id}</td>
      <td>${c.concepto || 'Cobro de venta'}</td>
      <td style="text-align: right;">S/ ${parseFloat(c.monto).toFixed(2)}</td>
      <td>${c.clienteNombre || '-'}</td>
      <td>${c.tipoDocumento || 'BOLETA'}</td>
      <td>${c.formaPago}</td>
      <td>${c.fecha}</td>
      <td>${new Date(c.fechaRegistro).toLocaleString('es-PE', { dateStyle: 'short', timeStyle: 'short' })}</td>
      <td><span class="badge ${c.estado === 'ACTIVO' ? 'badge-success' : 'badge-danger'}">${c.estado}</span></td>
      <td>${c.cajaId || '-'}</td>
    </tr>
  `).join('');
}

function nuevoCobroVenta() {
  // Verificar que haya caja abierta
  if (!cajaActual) {
    const aperturas = load(DB_CAJA_APERTURAS) || [];
    const hoy = today();
    cajaActual = aperturas.find(a => a.fecha === hoy && a.estado === 'ABIERTA');
  }

  if (!cajaActual) {
    toast('Debe aperturar la caja antes de registrar cobros', 'error');
    return;
  }

  // Limpiar y configurar el modal
  document.getElementById('cobroVentaId').value = '';
  document.getElementById('cobroClienteNombre').value = '';
  document.getElementById('cobroConcepto').value = '';
  document.getElementById('cobroMonto').value = '';
  document.getElementById('cobroTipoDocumento').value = 'BOLETA';
  document.getElementById('cobroFormaPago').value = 'EFECTIVO';
  document.getElementById('cobroFecha').value = today();

  // Abrir modal
  document.getElementById('modalNuevoCobro').classList.add('active');
}

function guardarNuevoCobro() {
  const ventaId = document.getElementById('cobroVentaId').value.trim();
  const clienteNombre = document.getElementById('cobroClienteNombre').value.trim();
  const concepto = document.getElementById('cobroConcepto').value.trim();
  const monto = parseFloat(document.getElementById('cobroMonto').value);
  const tipoDocumento = document.getElementById('cobroTipoDocumento').value;
  const formaPago = document.getElementById('cobroFormaPago').value;
  const fecha = document.getElementById('cobroFecha').value;

  // Validaciones
  if (!ventaId) {
    toast('Debe ingresar el ID de la venta', 'error');
    return;
  }

  if (!clienteNombre) {
    toast('Debe ingresar el nombre del cliente', 'error');
    return;
  }

  if (!concepto) {
    toast('Debe ingresar el concepto del cobro', 'error');
    return;
  }

  if (isNaN(monto) || monto <= 0) {
    toast('El monto debe ser un n√∫mero v√°lido mayor a 0', 'error');
    return;
  }

  if (!fecha) {
    toast('Debe seleccionar la fecha', 'error');
    return;
  }

  const cobros = load(DB_COBROS_VENTAS) || [];

  const nuevoCobro = {
    id: genId('COB'),
    ventaId: ventaId,
    clienteNombre: clienteNombre,
    concepto: concepto,
    monto: monto,
    tipoDocumento: tipoDocumento,
    formaPago: formaPago,
    fecha: fecha,
    fechaRegistro: new Date().toISOString(),
    estado: 'ACTIVO',
    usuario: 'ADMIN',
    cajaId: cajaActual.id
  };

  cobros.push(nuevoCobro);
  save(DB_COBROS_VENTAS, cobros);

  toast('Cobro registrado correctamente', 'success');
  cerrarModalConfiguracion('modalNuevoCobro');
  mostrarCobrosVentas();
}

function anularCobroSeleccionado() {
  const id = prompt('Ingrese el ID del cobro a anular:');
  if (!id) return;

  const cobros = load(DB_COBROS_VENTAS) || [];
  const index = cobros.findIndex(c => c.id === id);

  if (index === -1) {
    toast('Cobro no encontrado', 'error');
    return;
  }

  if (!confirm('¬øEst√° seguro de anular este cobro?')) {
    return;
  }

  cobros[index].estado = 'ANULADO';
  save(DB_COBROS_VENTAS, cobros);

  toast('Cobro anulado correctamente', 'success');
  mostrarCobrosVentas();
}

function exportarCobrosExcel() {
  const cobros = load(DB_COBROS_VENTAS) || [];

  const data = [
    ['ID', 'VENTA ID', 'CLIENTE', 'MONTO', 'FORMA PAGO', 'FECHA', 'ESTADO']
  ];

  cobros.forEach(c => {
    data.push([
      c.id,
      c.ventaId,
      c.clienteNombre,
      c.monto,
      c.formaPago,
      c.fecha,
      c.estado
    ]);
  });

  const csv = data.map(row => row.join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `cobros_ventas_${today()}.csv`;
  link.click();

  toast('Cobros exportados a Excel', 'success');
}

// ============================================
// 5. PAGO A PROVEEDORES
// ============================================
function mostrarPagosProveedores() {
  const pagos = load(DB_PAGOS_PROVEEDORES) || [];
  const tbody = document.getElementById('pagosProveedoresBody');

  if (pagos.length === 0) {
    tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 20px;">No hay pagos registrados</td></tr>';
    return;
  }

  tbody.innerHTML = pagos.map(p => `
    <tr>
      <td>${p.id}</td>
      <td>${p.concepto}</td>
      <td style="text-align: right;">S/ ${parseFloat(p.monto).toFixed(2)}</td>
      <td>${p.proveedorNombre || '-'}</td>
      <td>${p.tipoDocumento || 'FACTURA'}</td>
      <td>${p.formaPago}</td>
      <td>${p.fecha}</td>
      <td>${new Date(p.fechaRegistro).toLocaleString('es-PE', { dateStyle: 'short', timeStyle: 'short' })}</td>
      <td><span class="badge ${p.estado === 'ACTIVO' ? 'badge-success' : 'badge-danger'}">${p.estado}</span></td>
      <td>${p.cajaId || '-'}</td>
    </tr>
  `).join('');
}

function anularPagoSeleccionado() {
  const id = prompt('Ingrese el ID del pago a anular:');
  if (!id) return;

  const pagos = load(DB_PAGOS_PROVEEDORES) || [];
  const index = pagos.findIndex(p => p.id === id);

  if (index === -1) {
    toast('Pago no encontrado', 'error');
    return;
  }

  if (!confirm('¬øEst√° seguro de anular este pago?')) {
    return;
  }

  pagos[index].estado = 'ANULADO';
  save(DB_PAGOS_PROVEEDORES, pagos);

  toast('Pago anulado correctamente', 'success');
  mostrarPagosProveedores();
}

function imprimirDocumentoPago() {
  toast('Funci√≥n en desarrollo', 'info');
}

function exportarPagosExcel() {
  const pagos = load(DB_PAGOS_PROVEEDORES) || [];

  const data = [
    ['ID', 'PROVEEDOR', 'CONCEPTO', 'MONTO', 'FORMA PAGO', 'FECHA', 'ESTADO']
  ];

  pagos.forEach(p => {
    data.push([
      p.id,
      p.proveedorNombre,
      p.concepto,
      p.monto,
      p.formaPago,
      p.fecha,
      p.estado
    ]);
  });

  const csv = data.map(row => row.join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `pagos_proveedores_${today()}.csv`;
  link.click();

  toast('Pagos exportados a Excel', 'success');
}

// ============================================
// M√ìDULO CONSULTORIO ULTRA PROFESIONAL V2.0
// Sistema Integral de Gesti√≥n Cl√≠nica
// ============================================

/*
 * CARACTER√çSTICAS PRINCIPALES:
 * ‚úì B√∫squeda inteligente de pacientes con sugerencias en tiempo real
 * ‚úì Interfaz multi-panel con navegaci√≥n fluida
 * ‚úì Formularios especializados por tipo de profesional
 * ‚úì Historial cl√≠nico completo y trazable
 * ‚úì Sistema de impresi√≥n profesional
 * ‚úì Exportaci√≥n de datos m√©dicos
 * ‚úì Validaciones m√©dicas inteligentes
 * ‚úì Dise√±o responsive y moderno
 */

// ============================================
// VARIABLES GLOBALES DEL SISTEMA
// ============================================
// (Declaradas al inicio del script en l√≠neas 9948-9950)

// ============================================
// CONTROLADOR PRINCIPAL DE VISTAS
// ============================================

function mostrarTabConsultorio(tab) {
  console.log('üè• Cambiando vista de consultorio a:', tab);
  modoVistaConsultorio = tab;

  // Ocultar todos los paneles
  const paneles = ['consultorioNuevoExamen', 'consultorioHistorial', 'consultorioEstadisticas'];
  paneles.forEach(id => {
    const elem = document.getElementById(id);
    if (elem) elem.style.display = 'none';
  });

  // Mostrar panel activo
  const panelActivo = document.getElementById(`consultorio${capitalizar(tab)}`);
  if (panelActivo) {
    panelActivo.style.display = 'block';

    // Animar entrada
    panelActivo.style.opacity = '0';
    panelActivo.style.transform = 'translateY(20px)';
    setTimeout(() => {
      panelActivo.style.transition = 'all 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
      panelActivo.style.opacity = '1';
      panelActivo.style.transform = 'translateY(0)';
    }, 10);
  }

  // Acciones espec√≠ficas por tab
  if (tab === 'historial') {
    cargarHistorialConsultas();
  } else if (tab === 'estadisticas') {
    cargarEstadisticasConsultorio();
  }

  // Actualizar botones de navegaci√≥n
  actualizarBotonesNavegacionConsultorio(tab);
}

function capitalizar(str) {
  return str.charAt(0).toUpperCase() + str.slice(1);
}

function actualizarBotonesNavegacionConsultorio(tabActivo) {
  const botones = document.querySelectorAll('.consultorio-nav-btn');
  botones.forEach(btn => {
    btn.classList.remove('active');
    if (btn.dataset.tab === tabActivo) {
      btn.classList.add('active');
    }
  });
}

// ============================================
// SISTEMA DE B√öSQUEDA INTELIGENTE DE PACIENTES
// ============================================

function buscarPacienteConsultorio() {
  const inputBusqueda = document.getElementById('consultorioBuscarPaciente');
  const resultadosDiv = document.getElementById('consultorioResultadosBusqueda');

  if (!inputBusqueda || !resultadosDiv) {
    console.error('‚ùå Elementos de b√∫squeda no encontrados');
    return;
  }

  const busqueda = inputBusqueda.value.trim();

  if (busqueda.length < 2) {
    resultadosDiv.innerHTML = '';
    resultadosDiv.style.display = 'none';
    return;
  }

  const clientes = load(DB.CLIENTES);
  console.log('üìã Total clientes en DB:', clientes.length);

  const busquedaLower = busqueda.toLowerCase();

  // Algoritmo de b√∫squeda inteligente con scoring
  const resultados = clientes.map(c => {
    const documento = (c.documento || c.dni || '').toLowerCase();
    const nombres = (c.nombres || c.nombre || '').toLowerCase();
    const apellidos = (c.apellidos || c.apellido || '').toLowerCase();
    const nombreCompleto = (nombres + ' ' + apellidos).toLowerCase();
    const telefono = (c.telefono || '').toLowerCase();

    let score = 0;

    // B√∫squeda exacta tiene mayor prioridad
    if (documento === busquedaLower) score += 100;
    else if (documento.startsWith(busquedaLower)) score += 80;
    else if (documento.includes(busquedaLower)) score += 40;

    if (nombreCompleto === busquedaLower) score += 90;
    else if (nombreCompleto.startsWith(busquedaLower)) score += 70;
    else if (nombres.startsWith(busquedaLower)) score += 60;
    else if (apellidos.startsWith(busquedaLower)) score += 60;
    else if (nombreCompleto.includes(busquedaLower)) score += 30;

    if (telefono.includes(busquedaLower)) score += 20;

    return { cliente: c, score };
  })
  .filter(r => r.score > 0)
  .sort((a, b) => b.score - a.score)
  .slice(0, 10)
  .map(r => r.cliente);

  console.log('üîç Resultados encontrados:', resultados.length);

  if (resultados.length === 0) {
    resultadosDiv.style.display = 'block';
    resultadosDiv.innerHTML = `
      <div style="padding: 20px; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 3px solid #f59e0b; border-radius: 16px; text-align: center; box-shadow: 0 10px 40px rgba(245, 158, 11, 0.3); animation: shake 0.5s;">
        <div style="font-size: 48px; margin-bottom: 12px; animation: bounce 1s infinite;">üîç</div>
        <div style="font-weight: 800; font-size: 16px; color: #92400e; margin-bottom: 8px;">No se encontraron pacientes</div>
        <div style="font-size: 13px; color: #92400e; opacity: 0.85; margin-bottom: 16px;">Intenta buscar por DNI, nombre completo o tel√©fono</div>
        <button onclick="abrirModalRegistroPacienteConsultorio()" style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; border: none; padding: 12px 24px; border-radius: 10px; font-weight: 700; cursor: pointer; box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4); transition: all 0.3s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
          ‚ûï Registrar Nuevo Paciente
        </button>
      </div>
    `;
    return;
  }

  resultadosDiv.style.display = 'block';
  resultadosDiv.innerHTML = `
    <div style="background: white; border: 3px solid #7c3aed; border-radius: 16px; overflow: hidden; box-shadow: 0 20px 60px rgba(124, 58, 237, 0.25); animation: slideInDown 0.4s cubic-bezier(0.4, 0, 0.2, 1);">
      <div style="background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%); padding: 14px 20px; color: white; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
        <div>
          <div style="font-weight: 800; font-size: 14px;">üìã ${resultados.length} PACIENTE${resultados.length !== 1 ? 'S' : ''} ENCONTRADO${resultados.length !== 1 ? 'S' : ''}</div>
          <div style="font-size: 11px; opacity: 0.9; margin-top: 2px;">Seleccione un paciente para continuar</div>
        </div>
        <button onclick="limpiarBusquedaPaciente()" style="background: rgba(255,255,255,0.2); border: 2px solid white; color: white; padding: 6px 12px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 11px; transition: all 0.2s;" onmouseover="this.style.background='white'; this.style.color='#7c3aed'" onmouseout="this.style.background='rgba(255,255,255,0.2)'; this.style.color='white'">
          ‚úï Cerrar
        </button>
      </div>
      <div style="max-height: 400px; overflow-y: auto;">
        ${resultados.map((c, index) => {
          const nombres = c.nombres || c.nombre || '';
          const apellidos = c.apellidos || c.apellido || '';
          const documento = c.documento || c.dni || 'Sin DNI';
          const telefono = c.telefono || 'Sin tel√©fono';
          const nombreCompleto = (nombres + ' ' + apellidos).trim();

          // Obtener √∫ltima consulta
          const consultas = load(DB.CONSULTAS_CLINICAS).filter(cons => cons.idCliente === c.id);
          const ultimaConsulta = consultas.length > 0 ? consultas.sort((a,b) => new Date(b.fecha) - new Date(a.fecha))[0] : null;

          return `
            <div onclick="seleccionarPacienteConsultorio('${c.id}')"
                 class="paciente-resultado-item"
                 style="padding: 16px 20px; border-bottom: 1px solid #f3f4f6; cursor: pointer; transition: all 0.3s; position: relative; animation: fadeIn 0.3s ease ${index * 0.05}s both;"
                 onmouseover="this.style.background='linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%)'; this.style.paddingLeft='28px'; this.style.borderLeft='6px solid #7c3aed'"
                 onmouseout="this.style.background='white'; this.style.paddingLeft='20px'; this.style.borderLeft='none'">

              <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                <div style="flex: 1;">
                  <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                    <span style="font-size: 24px;">üë§</span>
                    <div style="font-weight: 800; color: #7c3aed; font-size: 16px;">${nombreCompleto}</div>
                    ${consultas.length > 0 ? `<span style="background: #10b981; color: white; padding: 2px 8px; border-radius: 12px; font-size: 10px; font-weight: 700;">‚úì ${consultas.length} CONSULTA${consultas.length !== 1 ? 'S' : ''}</span>` : '<span style="background: #f59e0b; color: white; padding: 2px 8px; border-radius: 12px; font-size: 10px; font-weight: 700;">SIN HISTORIAL</span>'}
                  </div>

                  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px; font-size: 13px; color: #64748b;">
                    <div style="display: flex; align-items: center; gap: 6px;">
                      <span style="font-weight: 700; color: #475569;">üÜî DNI:</span>
                      <span style="font-family: monospace; background: #f1f5f9; padding: 2px 8px; border-radius: 6px;">${documento}</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 6px;">
                      <span style="font-weight: 700; color: #475569;">üìû Tel:</span>
                      <span>${telefono}</span>
                    </div>
                    ${c.fechaNacimiento ? `
                    <div style="display: flex; align-items: center; gap: 6px;">
                      <span style="font-weight: 700; color: #475569;">üéÇ Edad:</span>
                      <span>${calcularEdad(c.fechaNacimiento)} a√±os</span>
                    </div>` : ''}
                  </div>

                  ${ultimaConsulta ? `
                  <div style="margin-top: 8px; padding: 8px 12px; background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); border-left: 3px solid #10b981; border-radius: 8px;">
                    <div style="font-size: 11px; font-weight: 700; color: #065f46; margin-bottom: 4px;">üìÖ √öLTIMA CONSULTA: ${formatDate(ultimaConsulta.fecha)}</div>
                    <div style="font-size: 11px; color: #047857;">${ultimaConsulta.motivo ? 'üí¨ ' + ultimaConsulta.motivo.substring(0, 80) + (ultimaConsulta.motivo.length > 80 ? '...' : '') : 'Sin motivo registrado'}</div>
                  </div>
                  ` : ''}
                </div>

                <div style="text-align: right;">
                  <div style="font-size: 11px; color: #9ca3af; margin-bottom: 4px;">C√≥digo</div>
                  <div style="font-family: monospace; font-size: 12px; font-weight: 700; color: #7c3aed; background: #f5f3ff; padding: 4px 8px; border-radius: 6px;">${c.id}</div>
                </div>
              </div>
            </div>
          `;
        }).join('')}
      </div>

      <div style="background: #f9fafb; padding: 12px 20px; border-top: 2px solid #e5e7eb; text-align: center;">
        <div style="font-size: 11px; color: #6b7280;">üí° Haz clic en un paciente para seleccionarlo y comenzar el examen</div>
      </div>
    </div>
  `;
}

function calcularEdad(fechaNacimiento) {
  if (!fechaNacimiento) return 'N/A';
  const hoy = new Date();
  const nacimiento = new Date(fechaNacimiento);
  let edad = hoy.getFullYear() - nacimiento.getFullYear();
  const mes = hoy.getMonth() - nacimiento.getMonth();
  if (mes < 0 || (mes === 0 && hoy.getDate() < nacimiento.getDate())) {
    edad--;
  }
  return edad;
}

// ============================================
// REGISTRO R√ÅPIDO DE PACIENTE DESDE CONSULTORIO
// ============================================

function abrirModalRegistroPacienteConsultorio() {
  // Crear modal de registro r√°pido
  const modalHTML = `
    <div id="modalRegistroPacienteConsultorio" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 10000; backdrop-filter: blur(4px);">
      <div style="background: white; border-radius: 20px; padding: 0; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: slideDown 0.3s ease-out;">
        <!-- Header -->
        <div style="background: linear-gradient(135deg, #10b981, #059669); padding: 24px; border-radius: 20px 20px 0 0; color: white;">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <h2 style="margin: 0; font-size: 24px; font-weight: 800;">‚ûï Registrar Nuevo Paciente</h2>
              <p style="margin: 4px 0 0 0; font-size: 14px; opacity: 0.9;">Complete los datos b√°sicos del paciente</p>
            </div>
            <button onclick="cerrarModalRegistroPacienteConsultorio()" style="background: rgba(255,255,255,0.2); border: none; color: white; font-size: 24px; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">‚úï</button>
          </div>
        </div>

        <!-- Formulario -->
        <div style="padding: 30px;">
          <div style="margin-bottom: 20px;">
            <label style="display: block; font-weight: 700; margin-bottom: 8px; color: #374151; font-size: 14px;">
              DNI / Documento <span style="color: #ef4444;">*</span>
            </label>
            <input id="regConsultDNI" type="text" placeholder="Ingrese DNI o documento" style="width: 100%; padding: 14px; border: 2px solid #d1d5db; border-radius: 10px; font-size: 15px; transition: all 0.3s;" onfocus="this.style.borderColor='#10b981'" onblur="this.style.borderColor='#d1d5db'">
          </div>

          <div style="margin-bottom: 20px;">
            <label style="display: block; font-weight: 700; margin-bottom: 8px; color: #374151; font-size: 14px;">
              Nombres <span style="color: #ef4444;">*</span>
            </label>
            <input id="regConsultNombres" type="text" placeholder="Ingrese nombres" style="width: 100%; padding: 14px; border: 2px solid #d1d5db; border-radius: 10px; font-size: 15px; transition: all 0.3s;" onfocus="this.style.borderColor='#10b981'" onblur="this.style.borderColor='#d1d5db'">
          </div>

          <div style="margin-bottom: 20px;">
            <label style="display: block; font-weight: 700; margin-bottom: 8px; color: #374151; font-size: 14px;">
              Apellidos <span style="color: #ef4444;">*</span>
            </label>
            <input id="regConsultApellidos" type="text" placeholder="Ingrese apellidos" style="width: 100%; padding: 14px; border: 2px solid #d1d5db; border-radius: 10px; font-size: 15px; transition: all 0.3s;" onfocus="this.style.borderColor='#10b981'" onblur="this.style.borderColor='#d1d5db'">
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
            <div>
              <label style="display: block; font-weight: 700; margin-bottom: 8px; color: #374151; font-size: 14px;">
                Tel√©fono
              </label>
              <input id="regConsultTelefono" type="text" placeholder="Ej: 999888777" style="width: 100%; padding: 14px; border: 2px solid #d1d5db; border-radius: 10px; font-size: 15px; transition: all 0.3s;" onfocus="this.style.borderColor='#10b981'" onblur="this.style.borderColor='#d1d5db'">
            </div>
            <div>
              <label style="display: block; font-weight: 700; margin-bottom: 8px; color: #374151; font-size: 14px;">
                Fecha de Nacimiento
              </label>
              <input id="regConsultFechaNac" type="date" style="width: 100%; padding: 14px; border: 2px solid #d1d5db; border-radius: 10px; font-size: 15px; transition: all 0.3s;" onfocus="this.style.borderColor='#10b981'" onblur="this.style.borderColor='#d1d5db'">
            </div>
          </div>

          <div style="margin-bottom: 20px;">
            <label style="display: block; font-weight: 700; margin-bottom: 8px; color: #374151; font-size: 14px;">
              Direcci√≥n
            </label>
            <input id="regConsultDireccion" type="text" placeholder="Ingrese direcci√≥n" style="width: 100%; padding: 14px; border: 2px solid #d1d5db; border-radius: 10px; font-size: 15px; transition: all 0.3s;" onfocus="this.style.borderColor='#10b981'" onblur="this.style.borderColor='#d1d5db'">
          </div>

          <!-- Botones -->
          <div style="display: flex; gap: 12px; margin-top: 30px;">
            <button onclick="cerrarModalRegistroPacienteConsultorio()" style="flex: 1; padding: 14px; background: #f3f4f6; border: 2px solid #d1d5db; border-radius: 10px; font-weight: 700; color: #374151; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='#e5e7eb'" onmouseout="this.style.background='#f3f4f6'">
              Cancelar
            </button>
            <button onclick="guardarPacienteConsultorio()" style="flex: 1; padding: 14px; background: linear-gradient(135deg, #10b981, #059669); border: none; border-radius: 10px; font-weight: 700; color: white; cursor: pointer; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4); transition: all 0.3s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(16, 185, 129, 0.5)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(16, 185, 129, 0.4)'">
              ‚úì Registrar y Seleccionar
            </button>
          </div>

          <p style="margin-top: 16px; text-align: center; font-size: 13px; color: #6b7280;">
            <span style="color: #ef4444;">*</span> Campos obligatorios
          </p>
        </div>
      </div>
    </div>
  `;

  // Agregar modal al DOM
  document.body.insertAdjacentHTML('beforeend', modalHTML);

  // Hacer foco en el primer campo
  setTimeout(() => {
    document.getElementById('regConsultDNI').focus();
  }, 100);
}

function cerrarModalRegistroPacienteConsultorio() {
  const modal = document.getElementById('modalRegistroPacienteConsultorio');
  if (modal) {
    modal.remove();
  }
}

function guardarPacienteConsultorio() {
  // Obtener valores del formulario
  const dni = document.getElementById('regConsultDNI').value.trim();
  const nombres = document.getElementById('regConsultNombres').value.trim();
  const apellidos = document.getElementById('regConsultApellidos').value.trim();
  const telefono = document.getElementById('regConsultTelefono').value.trim();
  const fechaNac = document.getElementById('regConsultFechaNac').value.trim();
  const direccion = document.getElementById('regConsultDireccion').value.trim();

  // Validar campos obligatorios
  if (!dni) {
    toast('‚ö†Ô∏è El DNI es obligatorio', 'warning');
    document.getElementById('regConsultDNI').focus();
    return;
  }

  if (!nombres) {
    toast('‚ö†Ô∏è Los nombres son obligatorios', 'warning');
    document.getElementById('regConsultNombres').focus();
    return;
  }

  if (!apellidos) {
    toast('‚ö†Ô∏è Los apellidos son obligatorios', 'warning');
    document.getElementById('regConsultApellidos').focus();
    return;
  }

  // Verificar si el DNI ya existe
  const clientes = load(DB.CLIENTES);
  const existente = clientes.find(c => c.documento === dni || c.dni === dni);

  if (existente) {
    toast('‚ö†Ô∏è Ya existe un paciente con este DNI', 'warning');
    // Cerrar modal y seleccionar el paciente existente
    cerrarModalRegistroPacienteConsultorio();
    seleccionarPacienteConsultorio(existente.id);
    return;
  }

  // Crear nuevo cliente
  const nuevoCliente = {
    id: genId('CLI'),
    documento: dni,
    dni: dni,
    nombres: nombres,
    apellidos: apellidos,
    telefono: telefono,
    fechaNacimiento: fechaNac,
    direccion: direccion,
    fechaRegistro: new Date().toISOString(),
    activo: true
  };

  // Guardar en DB
  clientes.push(nuevoCliente);
  save(DB.CLIENTES, clientes);

  // Cerrar modal
  cerrarModalRegistroPacienteConsultorio();

  // Mostrar notificaci√≥n de √©xito
  toast('‚úÖ Paciente registrado exitosamente', 'success');

  // Seleccionar autom√°ticamente el paciente reci√©n creado
  seleccionarPacienteConsultorio(nuevoCliente.id);

  // Actualizar campo de b√∫squeda con el nombre del paciente
  const inputBusqueda = document.getElementById('consultorioBuscarPaciente');
  if (inputBusqueda) {
    inputBusqueda.value = `${nombres} ${apellidos}`;
  }
}

// ============================================
// SELECCI√ìN Y CARGA DE DATOS DEL PACIENTE
// ============================================

function seleccionarPacienteConsultorio(idCliente) {
  const clientes = load(DB.CLIENTES);
  const cliente = clientes.find(c => c.id === idCliente);

  if (!cliente) {
    toast('‚ùå Cliente no encontrado', 'error');
    return;
  }

  pacienteConsultorioActual = cliente;

  // Soportar m√∫ltiples nombres de campos
  const nombres = cliente.nombres || cliente.nombre || '';
  const apellidos = cliente.apellidos || cliente.apellido || '';
  const documento = cliente.documento || cliente.dni || '';
  const nombreCompleto = (nombres + ' ' + apellidos).trim();
  const telefono = cliente.telefono || '';
  const edad = cliente.fechaNacimiento ? calcularEdad(cliente.fechaNacimiento) : '';

  // Autocompletar datos del paciente
  const dniInput = document.getElementById('consultorioDNI');
  const nombreInput = document.getElementById('consultorioNombre');
  const telefonoInput = document.getElementById('consultorioTelefono');
  const edadInput = document.getElementById('consultorioEdad');

  if (dniInput) dniInput.value = documento;
  if (nombreInput) nombreInput.value = nombreCompleto;
  if (telefonoInput) telefonoInput.value = telefono;
  if (edadInput) edadInput.value = edad ? `${edad} a√±os` : '';

  // Obtener historial de consultas
  const consultas = load(DB.CONSULTAS_CLINICAS).filter(c => c.idCliente === idCliente);
  const ultimaConsulta = consultas.length > 0 ? consultas.sort((a,b) => new Date(b.fecha) - new Date(a.fecha))[0] : null;

  // Mostrar tarjeta de paciente seleccionado con informaci√≥n completa
  const resultadosDiv = document.getElementById('consultorioResultadosBusqueda');
  if (resultadosDiv) {
    resultadosDiv.innerHTML = `
      <div style="background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); border: 4px solid #10b981; border-radius: 16px; overflow: hidden; box-shadow: 0 10px 40px rgba(16, 185, 129, 0.4); animation: slideInDown 0.4s cubic-bezier(0.4, 0, 0.2, 1);">

        <!-- Header -->
        <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 16px 20px; color: white; display: flex; justify-content: space-between; align-items: center;">
          <div style="display: flex; align-items: center; gap: 12px;">
            <div style="width: 50px; height: 50px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.2);">
              üë§
            </div>
            <div>
              <div style="font-weight: 800; font-size: 18px; margin-bottom: 2px;">‚úì PACIENTE SELECCIONADO</div>
              <div style="font-size: 12px; opacity: 0.95;">Listo para iniciar examen cl√≠nico</div>
            </div>
          </div>
          <button onclick="limpiarBusquedaPaciente()" style="background: rgba(255,255,255,0.2); border: 2px solid white; color: white; padding: 8px 16px; border-radius: 10px; cursor: pointer; font-weight: 700; font-size: 12px; transition: all 0.3s; display: flex; align-items: center; gap: 6px;" onmouseover="this.style.background='white'; this.style.color='#10b981'" onmouseout="this.style.background='rgba(255,255,255,0.2)'; this.style.color='white'">
            <span>üîÑ</span> Cambiar Paciente
          </button>
        </div>

        <!-- Datos del paciente -->
        <div style="padding: 20px;">
          <div style="background: white; border-radius: 12px; padding: 16px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <div style="font-size: 24px; font-weight: 800; color: #065f46; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
              <span>üè•</span> ${nombreCompleto}
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 12px; margin-bottom: 12px;">
              <div style="background: #f0fdf4; padding: 12px; border-radius: 10px; border-left: 4px solid #10b981;">
                <div style="font-size: 11px; color: #065f46; font-weight: 700; margin-bottom: 4px;">üÜî DOCUMENTO</div>
                <div style="font-size: 16px; font-weight: 700; color: #047857; font-family: monospace;">${documento}</div>
              </div>

              ${telefono ? `
              <div style="background: #f0fdf4; padding: 12px; border-radius: 10px; border-left: 4px solid #10b981;">
                <div style="font-size: 11px; color: #065f46; font-weight: 700; margin-bottom: 4px;">üìû TEL√âFONO</div>
                <div style="font-size: 16px; font-weight: 700; color: #047857;">${telefono}</div>
              </div>
              ` : ''}

              ${edad ? `
              <div style="background: #f0fdf4; padding: 12px; border-radius: 10px; border-left: 4px solid #10b981;">
                <div style="font-size: 11px; color: #065f46; font-weight: 700; margin-bottom: 4px;">üéÇ EDAD</div>
                <div style="font-size: 16px; font-weight: 700; color: #047857;">${edad} a√±os</div>
              </div>
              ` : ''}

              <div style="background: #f0fdf4; padding: 12px; border-radius: 10px; border-left: 4px solid #10b981;">
                <div style="font-size: 11px; color: #065f46; font-weight: 700; margin-bottom: 4px;">üìä HISTORIAL</div>
                <div style="font-size: 16px; font-weight: 700; color: #047857;">${consultas.length} consulta${consultas.length !== 1 ? 's' : ''}</div>
              </div>
            </div>

            ${ultimaConsulta ? `
            <div style="background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); padding: 14px; border-radius: 10px; border: 2px solid #6ee7b7;">
              <div style="font-size: 12px; font-weight: 800; color: #065f46; margin-bottom: 8px; display: flex; align-items: center; gap: 6px;">
                <span>üìÖ</span> √öLTIMA CONSULTA: ${formatDate(ultimaConsulta.fecha)}
              </div>
              ${ultimaConsulta.motivo ? `
              <div style="font-size: 12px; color: #047857; margin-bottom: 6px;">
                <strong>üí¨ Motivo:</strong> ${ultimaConsulta.motivo}
              </div>
              ` : ''}
              ${ultimaConsulta.rxEspecialista ? `
              <div style="font-size: 11px; color: #059669;">
                <strong>üë®‚Äç‚öïÔ∏è Atendido por:</strong> ${ultimaConsulta.rxEspecialista}
              </div>
              ` : ''}
              <div style="display: flex; gap: 8px; margin-top: 8px;">
                <button onclick="verDetalleConsulta('${ultimaConsulta.id}')" style="flex: 1; background: #10b981; color: white; border: none; padding: 6px 12px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 11px; transition: all 0.2s;" onmouseover="this.style.background='#059669'" onmouseout="this.style.background='#10b981'">
                  üëÅÔ∏è Ver √öltima Consulta
                </button>
                <button onclick="verHistorialCompletoConsultas('${cliente.id}')" style="flex: 1; background: #7c3aed; color: white; border: none; padding: 6px 12px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 11px; transition: all 0.2s;" onmouseover="this.style.background='#6d28d9'" onmouseout="this.style.background='#7c3aed'">
                  üìã Ver ${consultas.length} Consulta${consultas.length !== 1 ? 's' : ''}
                </button>
              </div>
            </div>
            ` : `
            <div style="background: #fef3c7; padding: 12px; border-radius: 10px; border: 2px solid #f59e0b; text-align: center; color: #92400e;">
              <div style="font-size: 32px; margin-bottom: 8px;">üìã</div>
              <div style="font-weight: 700; font-size: 13px;">Primera consulta de este paciente</div>
              <div style="font-size: 11px; margin-top: 4px; opacity: 0.85;">No hay historial cl√≠nico previo</div>
            </div>
            `}
          </div>
        </div>
      </div>
    `;
  }

  // Limpiar solo campos cl√≠nicos (mantener paciente visible)
  limpiarFormularioConsultorioSinPaciente();

  // Cargar historial de consultas del paciente en panel lateral
  cargarHistorialConsultas();

  // Enfocar en el primer campo del formulario
  setTimeout(() => {
    const motivoInput = document.getElementById('consultorioMotivo');
    if (motivoInput) motivoInput.focus();
  }, 500);

  // Actualizar progreso del formulario
  actualizarProgresoConsultorio();

  // Animaci√≥n y notificaci√≥n
  toast(`‚úÖ Paciente seleccionado: ${nombreCompleto}`, 'success');
  console.log('‚úÖ Paciente cargado exitosamente:', {
    id: cliente.id,
    nombreCompleto,
    documento,
    telefono,
    edad,
    consultasPrevias: consultas.length
  });
}

// ============================================
// FUNCIONES AUXILIARES DE B√öSQUEDA
// ============================================

function limpiarBusquedaPaciente() {
  const inputBusqueda = document.getElementById('consultorioBuscarPaciente');
  const resultadosDiv = document.getElementById('consultorioResultadosBusqueda');

  if (inputBusqueda) {
    inputBusqueda.value = '';
    inputBusqueda.focus();
  }
  if (resultadosDiv) {
    resultadosDiv.innerHTML = '';
    resultadosDiv.style.display = 'none';
  }

  // Limpiar paciente actual
  pacienteConsultorioActual = null;

  // Limpiar campos del formulario
  const dniInput = document.getElementById('consultorioDNI');
  const nombreInput = document.getElementById('consultorioNombre');
  const telefonoInput = document.getElementById('consultorioTelefono');
  const edadInput = document.getElementById('consultorioEdad');

  if (dniInput) dniInput.value = '';
  if (nombreInput) nombreInput.value = '';
  if (telefonoInput) telefonoInput.value = '';
  if (edadInput) edadInput.value = '';

  limpiarFormularioConsultorioSinPaciente();

  toast('üîç Puedes buscar otro paciente', 'info');
}

// ‚ú® LIMPIAR FORMULARIO - ESTRUCTURA EST√ÅNDAR UNIFICADA
function limpiarFormularioConsultorioSinPaciente() {
  document.getElementById('consultorioMotivo').value = '';

  // ‚úÖ PRESCRIPCI√ìN DE LENTES - Distancia (Lejos)
  ['rxDistEsfOD', 'rxDistCilOD', 'rxDistEjeOD', 'rxDistDipOD',
   'rxDistEsfOI', 'rxDistCilOI', 'rxDistEjeOI', 'rxDistDipOI'].forEach(id => {
    const elem = document.getElementById(id);
    if (elem) elem.value = '';
  });

  // ‚úÖ PRESCRIPCI√ìN DE LENTES - Cerca
  ['rxCercaEsfOD', 'rxCercaCilOD', 'rxCercaEjeOD', 'rxCercaDipOD',
   'rxCercaEsfOI', 'rxCercaCilOI', 'rxCercaEjeOI', 'rxCercaDipOI'].forEach(id => {
    const elem = document.getElementById(id);
    if (elem) elem.value = '';
  });

  // ‚úÖ PIO - Presi√≥n Intraocular
  ['rxPioOD', 'rxPioOI'].forEach(id => {
    const elem = document.getElementById(id);
    if (elem) elem.value = '';
  });

  // ‚úÖ DIAGN√ìSTICO - Checkboxes
  ['diagMiopia', 'diagHipermetropia', 'diagAstigmatismo', 'diagPresbicia', 'diagAmbliopia', 'diagAnisometropia'].forEach(id => {
    const elem = document.getElementById(id);
    if (elem) elem.checked = false;
  });

  // ‚úÖ OBSERVACIONES Y ESPECIALISTA
  ['rxObservaciones', 'rxEspecialista'].forEach(id => {
    const elem = document.getElementById(id);
    if (elem) elem.value = '';
  });

  // ‚úÖ HISTORIAL CL√çNICO
  ['histAntecedentesOculares', 'histAntecedentesMedicos', 'histMedicamentos', 'histAntecedentesFamiliares'].forEach(id => {
    const elem = document.getElementById(id);
    if (elem) elem.value = '';
  });

  // ‚úÖ TRATAMIENTO Y RECOMENDACIONES
  ['oftalmTratamiento', 'oftalmRecomendaciones', 'oftalmProximoControl', 'oftalmIndicacionesVenta'].forEach(id => {
    const elem = document.getElementById(id);
    if (elem) elem.value = '';
  });

  console.log('‚úÖ Formulario limpiado con estructura est√°ndar unificada');
}

// Limpiar formulario completo (incluyendo paciente)
// ==================== MEJORAS DEL CONSULTORIO ====================

// Toggle panel de ayuda
function toggleAyudaConsultorio() {
  const panel = document.getElementById('panelAyudaConsultorio');
  if (panel.style.display === 'none' || !panel.style.display) {
    panel.style.display = 'block';
  } else {
    panel.style.display = 'none';
  }
}

// B√∫squeda mejorada de pacientes con loading
function buscarPacienteConsultorioMejorado() {
  const termino = document.getElementById('consultorioBuscarPaciente').value.trim();
  const loadingDiv = document.getElementById('consultorioLoadingBusqueda');

  if (termino.length < 2) {
    document.getElementById('consultorioResultadosBusqueda').innerHTML = '';
    return;
  }

  // Mostrar loading
  loadingDiv.style.display = 'block';

  // Simular b√∫squeda con peque√±o delay para mostrar loading
  setTimeout(() => {
    buscarPacienteConsultorio();
    loadingDiv.style.display = 'none';
  }, 300);
}

// Actualizar progreso del formulario
function actualizarProgresoConsultorio() {
  const dni = document.getElementById('consultorioDNI').value.trim();
  const nombre = document.getElementById('consultorioNombre').value.trim();
  const motivo = document.getElementById('consultorioMotivo').value.trim();

  const esfOD = document.getElementById('rxDistEsfOD').value.trim();
  const esfOI = document.getElementById('rxDistEsfOI').value.trim();

  let camposCompletados = 0;
  let totalCampos = 4;

  // Check datos del paciente
  const checkPaciente = document.getElementById('checkPaciente');
  if (dni && nombre) {
    checkPaciente.textContent = '‚úÖ';
    camposCompletados++;
  } else {
    checkPaciente.textContent = '‚≠ï';
  }

  // Check motivo
  const checkMotivo = document.getElementById('checkMotivo');
  if (motivo) {
    checkMotivo.textContent = '‚úÖ';
    camposCompletados++;
  } else {
    checkMotivo.textContent = '‚≠ï';
  }

  // Check prescripci√≥n
  const checkPrescripcion = document.getElementById('checkPrescripcion');
  if (esfOD || esfOI) {
    checkPrescripcion.textContent = '‚úÖ';
    camposCompletados++;
  } else {
    checkPrescripcion.textContent = '‚≠ï';
  }

  // Check diagn√≥stico (verificar si al menos un checkbox de diagn√≥stico est√° marcado)
  const checkDiagnostico = document.getElementById('checkDiagnostico');
  const diagMiopia = document.getElementById('diagMiopia')?.checked || false;
  const diagHipermetropia = document.getElementById('diagHipermetropia')?.checked || false;
  const diagAstigmatismo = document.getElementById('diagAstigmatismo')?.checked || false;
  const diagPresbicia = document.getElementById('diagPresbicia')?.checked || false;
  const diagAmbliopia = document.getElementById('diagAmbliopia')?.checked || false;
  const diagAnisometropia = document.getElementById('diagAnisometropia')?.checked || false;

  const tieneDiagnostico = diagMiopia || diagHipermetropia || diagAstigmatismo || diagPresbicia || diagAmbliopia || diagAnisometropia;

  if (tieneDiagnostico) {
    checkDiagnostico.textContent = '‚úÖ';
    camposCompletados++;
  } else {
    checkDiagnostico.textContent = '‚≠ï';
  }

  // Calcular porcentaje
  const porcentaje = (camposCompletados / totalCampos) * 100;

  // Actualizar barra
  const barra = document.getElementById('consultorioProgresoBarra');
  const texto = document.getElementById('consultorioProgresoTexto');

  barra.style.width = porcentaje + '%';
  texto.textContent = Math.round(porcentaje) + '%';

  // Cambiar color seg√∫n progreso
  if (porcentaje < 25) {
    barra.style.background = 'linear-gradient(90deg, #ef4444 0%, #dc2626 100%)';
  } else if (porcentaje < 50) {
    barra.style.background = 'linear-gradient(90deg, #f59e0b 0%, #d97706 100%)';
  } else if (porcentaje < 100) {
    barra.style.background = 'linear-gradient(90deg, #3b82f6 0%, #2563eb 100%)';
  } else {
    barra.style.background = 'linear-gradient(90deg, #10b981 0%, #059669 100%)';
  }

  // Actualizar estado del paciente
  const estadoPaciente = document.getElementById('consultorioEstadoPaciente');
  if (pacienteConsultorioActual) {
    estadoPaciente.textContent = 'Paciente: ' + pacienteConsultorioActual.nombre;
    estadoPaciente.style.background = '#d1fae5';
    estadoPaciente.style.color = '#065f46';
  } else {
    estadoPaciente.textContent = 'Sin seleccionar';
    estadoPaciente.style.background = '#f3f4f6';
    estadoPaciente.style.color = '#6b7280';
  }
}

// Atajos de teclado para consultorio
document.addEventListener('keydown', function(e) {
  // Solo activar atajos si estamos en la secci√≥n de consultorio
  const consultorioSection = document.getElementById('consultorio');
  if (!consultorioSection || consultorioSection.classList.contains('hidden')) {
    return;
  }

  // F1 - Ayuda
  if (e.key === 'F1') {
    e.preventDefault();
    toggleAyudaConsultorio();
  }

  // Ctrl + S - Guardar
  if (e.ctrlKey && e.key === 's') {
    e.preventDefault();
    if (typeof guardarConsultaClinica === 'function') {
      guardarConsultaClinica();
    }
  }

  // Ctrl + P - Imprimir
  if (e.ctrlKey && e.key === 'p') {
    e.preventDefault();
    if (typeof guardarEImprimirConsulta === 'function') {
      guardarEImprimirConsulta();
    }
  }

  // Ctrl + N - Nuevo
  if (e.ctrlKey && e.key === 'n') {
    e.preventDefault();
    limpiarFormularioConsultorio();
  }

  // Ctrl + F - Buscar
  if (e.ctrlKey && e.key === 'f') {
    e.preventDefault();
    document.getElementById('consultorioBuscarPaciente').focus();
  }
});

// Auto-guardado de borrador cada 2 minutos
let consultorioBorradorTimer = null;

function iniciarAutoGuardadoConsultorio() {
  if (consultorioBorradorTimer) {
    clearInterval(consultorioBorradorTimer);
  }

  consultorioBorradorTimer = setInterval(() => {
    const dni = document.getElementById('consultorioDNI').value.trim();
    if (dni) {
      guardarBorradorConsultorio();
    }
  }, 120000); // 2 minutos
}

function guardarBorradorConsultorio() {
  const borrador = {
    dni: document.getElementById('consultorioDNI').value.trim(),
    nombre: document.getElementById('consultorioNombre').value.trim(),
    telefono: document.getElementById('consultorioTelefono').value.trim(),
    edad: document.getElementById('consultorioEdad').value.trim(),
    motivo: document.getElementById('consultorioMotivo').value.trim(),
    timestamp: new Date().toISOString()
  };

  localStorage.setItem('consultorio_borrador', JSON.stringify(borrador));
  console.log('üíæ Borrador auto-guardado');
}

function cargarBorradorConsultorio() {
  const borradorStr = localStorage.getItem('consultorio_borrador');
  if (borradorStr) {
    try {
      const borrador = JSON.parse(borradorStr);
      const timestamp = new Date(borrador.timestamp);
      const ahora = new Date();
      const diffMinutos = (ahora - timestamp) / 1000 / 60;

      // Solo cargar si el borrador es menor a 1 hora
      if (diffMinutos < 60) {
        if (confirm('Se encontr√≥ un borrador guardado hace ' + Math.round(diffMinutos) + ' minutos. ¬øDesea recuperarlo?')) {
          document.getElementById('consultorioDNI').value = borrador.dni || '';
          document.getElementById('consultorioNombre').value = borrador.nombre || '';
          document.getElementById('consultorioTelefono').value = borrador.telefono || '';
          document.getElementById('consultorioEdad').value = borrador.edad || '';
          document.getElementById('consultorioMotivo').value = borrador.motivo || '';

          actualizarProgresoConsultorio();
          toast('Borrador recuperado', 'success');
        }
      }
    } catch (error) {
      console.error('Error cargando borrador:', error);
    }
  }
}

// Inicializar mejoras del consultorio
document.addEventListener('DOMContentLoaded', function() {
  iniciarAutoGuardadoConsultorio();

  // Agregar listeners a campos para actualizar progreso
  const camposPaciente = ['consultorioDNI', 'consultorioNombre', 'consultorioTelefono', 'consultorioEdad'];
  camposPaciente.forEach(id => {
    const campo = document.getElementById(id);
    if (campo) {
      campo.addEventListener('input', actualizarProgresoConsultorio);
    }
  });

  // Agregar listeners a campos de prescripci√≥n
  const camposPrescripcion = ['rxDistEsfOD', 'rxDistEsfOI', 'rxDistCilOD', 'rxDistCilOI'];
  camposPrescripcion.forEach(id => {
    const campo = document.getElementById(id);
    if (campo) {
      campo.addEventListener('input', actualizarProgresoConsultorio);
    }
  });

  // Agregar listeners a checkboxes de diagn√≥stico
  const camposDiagnostico = ['diagMiopia', 'diagHipermetropia', 'diagAstigmatismo', 'diagPresbicia', 'diagAmbliopia', 'diagAnisometropia'];
  camposDiagnostico.forEach(id => {
    const campo = document.getElementById(id);
    if (campo) {
      campo.addEventListener('change', actualizarProgresoConsultorio);
    }
  });
});

function limpiarFormularioConsultorio() {
  pacienteConsultorioActual = null;

  // Limpiar b√∫squeda
  document.getElementById('consultorioBuscarPaciente').value = '';
  document.getElementById('consultorioResultadosBusqueda').innerHTML = '';

  // Limpiar datos del paciente
  document.getElementById('consultorioDNI').value = '';
  document.getElementById('consultorioNombre').value = '';
  document.getElementById('consultorioTelefono').value = '';
  document.getElementById('consultorioEdad').value = '';

  // Limpiar todos los campos cl√≠nicos
  limpiarFormularioConsultorioSinPaciente();

  // Limpiar historial
  document.getElementById('consultorioHistorial').innerHTML = '<div style="padding: 30px; text-align: center; color: #9ca3af;">Seleccione un paciente para ver su historial cl√≠nico</div>';

  // Actualizar progreso
  actualizarProgresoConsultorio();

  // Limpiar borrador
  localStorage.removeItem('consultorio_borrador');

  toast('Formulario limpiado', 'info');
}

// ============================================
// SISTEMA DE GUARDADO DE CONSULTAS CL√çNICAS
// ============================================

function guardarConsultaClinica() {
  console.log('üíæ Iniciando guardado de consulta cl√≠nica...');

  // VALIDACI√ìN 1: Verificar paciente seleccionado
  if (!pacienteConsultorioActual) {
    toast('‚ö†Ô∏è Primero busque y seleccione un paciente usando el campo de b√∫squeda superior', 'warning');
    document.getElementById('consultorioBuscarPaciente')?.focus();
    return;
  }

  // VALIDACI√ìN 2: Verificar motivo de consulta
  const motivo = document.getElementById('consultorioMotivo')?.value.trim() || '';
  if (!motivo) {
    toast('‚ö†Ô∏è Debe ingresar el motivo de consulta antes de guardar', 'warning');
    document.getElementById('consultorioMotivo')?.focus();
    return;
  }

  // Mostrar indicador de guardado
  const btnGuardar = event?.target;
  const textoOriginal = btnGuardar?.textContent;
  if (btnGuardar) {
    btnGuardar.disabled = true;
    btnGuardar.textContent = 'üíæ Guardando...';
    btnGuardar.style.opacity = '0.6';
  }

  try {
    const consultas = load(DB.CONSULTAS_CLINICAS);

    // Construir objeto de consulta con todos los datos
    const nuevaConsulta = {
      id: genId('CONS'),
      idCliente: pacienteConsultorioActual.id,
      dniCliente: pacienteConsultorioActual.documento || pacienteConsultorioActual.dni || '',
      nombreCliente: `${pacienteConsultorioActual.nombres || pacienteConsultorioActual.nombre || ''} ${pacienteConsultorioActual.apellidos || pacienteConsultorioActual.apellido || ''}`.trim(),
      fecha: new Date().toISOString(),
      fechaFormato: formatDate(today()),
      motivo: motivo,

      // HISTORIAL CL√çNICO
      antecedentesOculares: document.getElementById('histAntecedentesOculares')?.value.trim() || '',
      antecedentesMedicos: document.getElementById('histAntecedentesMedicos')?.value.trim() || '',
      medicamentosActuales: document.getElementById('histMedicamentos')?.value.trim() || '',
      antecedentesFamiliares: document.getElementById('histAntecedentesFamiliares')?.value.trim() || '',

      // PRESCRIPCI√ìN DE LENTES - DISTANCIA
      rxDistEsfOD: document.getElementById('rxDistEsfOD')?.value.trim() || '',
      rxDistCilOD: document.getElementById('rxDistCilOD')?.value.trim() || '',
      rxDistEjeOD: document.getElementById('rxDistEjeOD')?.value.trim() || '',
      rxDistDipOD: document.getElementById('rxDistDipOD')?.value.trim() || '',
      rxDistEsfOI: document.getElementById('rxDistEsfOI')?.value.trim() || '',
      rxDistCilOI: document.getElementById('rxDistCilOI')?.value.trim() || '',
      rxDistEjeOI: document.getElementById('rxDistEjeOI')?.value.trim() || '',
      rxDistDipOI: document.getElementById('rxDistDipOI')?.value.trim() || '',

      // PRESCRIPCI√ìN DE LENTES - CERCA
      rxCercaEsfOD: document.getElementById('rxCercaEsfOD')?.value.trim() || '',
      rxCercaCilOD: document.getElementById('rxCercaCilOD')?.value.trim() || '',
      rxCercaEjeOD: document.getElementById('rxCercaEjeOD')?.value.trim() || '',
      rxCercaDipOD: document.getElementById('rxCercaDipOD')?.value.trim() || '',
      rxCercaEsfOI: document.getElementById('rxCercaEsfOI')?.value.trim() || '',
      rxCercaCilOI: document.getElementById('rxCercaCilOI')?.value.trim() || '',
      rxCercaEjeOI: document.getElementById('rxCercaEjeOI')?.value.trim() || '',
      rxCercaDipOI: document.getElementById('rxCercaDipOI')?.value.trim() || '',

      // PRESI√ìN INTRAOCULAR
      rxPioOD: document.getElementById('rxPioOD')?.value.trim() || '',
      rxPioOI: document.getElementById('rxPioOI')?.value.trim() || '',

      // AGUDEZA VISUAL
      avDistOD: document.getElementById('avDistOD')?.value.trim() || '',
      avDistOI: document.getElementById('avDistOI')?.value.trim() || '',
      avCercaOD: document.getElementById('avCercaOD')?.value.trim() || '',
      avCercaOI: document.getElementById('avCercaOI')?.value.trim() || '',

      // DIAGN√ìSTICOS
      diagMiopia: document.getElementById('diagMiopia')?.checked || false,
      diagHipermetropia: document.getElementById('diagHipermetropia')?.checked || false,
      diagAstigmatismo: document.getElementById('diagAstigmatismo')?.checked || false,
      diagPresbicia: document.getElementById('diagPresbicia')?.checked || false,
      diagAmbliopia: document.getElementById('diagAmbliopia')?.checked || false,
      diagAnisometropia: document.getElementById('diagAnisometropia')?.checked || false,

      // OBSERVACIONES Y ESPECIALISTA
      rxObservaciones: document.getElementById('rxObservaciones')?.value.trim() || '',
      rxEspecialista: document.getElementById('rxEspecialista')?.value.trim() || '',

      // TRATAMIENTO Y RECOMENDACIONES
      planTratamiento: document.getElementById('oftalmTratamiento')?.value.trim() || '',
      recomendaciones: document.getElementById('oftalmRecomendaciones')?.value.trim() || '',
      proximoControl: document.getElementById('oftalmProximoControl')?.value.trim() || '',
      indicacionesVenta: document.getElementById('oftalmIndicacionesVenta')?.value.trim() || '',

      // METADATA DEL SISTEMA
      usuario: usuarioActual || 'ADMIN',
      establecimiento: establecimientoActual || 'PRINCIPAL',
      fechaRegistro: new Date().toISOString()
    };

    // Guardar consulta en DB.CONSULTAS_CLINICAS
    consultas.push(nuevaConsulta);
    save(DB.CONSULTAS_CLINICAS, consultas);

    // ‚ú® GUARDAR TAMBI√âN EN DB.MEDIDAS (Prescripci√≥n de Lentes) ‚ú®
    const medidas = load(DB.MEDIDAS);
    const prescripcionId = genId('RX');

    const prescripcion = {
      id: prescripcionId,
      clienteId: pacienteConsultorioActual.id,
      codigo: prescripcionId.split('_')[1],
      fecha: formatDate(today()),
      proximaCita: nuevaConsulta.proximoControl || '',
      especialista: nuevaConsulta.rxEspecialista || '',
      tipo: 'PROPIA',

      // Visi√≥n Lejos
      lejosOdEsf: nuevaConsulta.rxDistEsfOD || '',
      lejosOdCil: nuevaConsulta.rxDistCilOD || '',
      lejosOdEje: nuevaConsulta.rxDistEjeOD || '',
      lejosDip: nuevaConsulta.rxDistDipOD || '',
      lejosOiEsf: nuevaConsulta.rxDistEsfOI || '',
      lejosOiCil: nuevaConsulta.rxDistCilOI || '',
      lejosOiEje: nuevaConsulta.rxDistEjeOI || '',

      // Visi√≥n Cerca
      cercaOdEsf: nuevaConsulta.rxCercaEsfOD || '',
      cercaOdCil: nuevaConsulta.rxCercaCilOD || '',
      cercaOdEje: nuevaConsulta.rxCercaEjeOD || '',
      cercaDip: nuevaConsulta.rxCercaDipOD || '',
      cercaOiEsf: nuevaConsulta.rxCercaEsfOI || '',
      cercaOiCil: nuevaConsulta.rxCercaCilOI || '',
      cercaOiEje: nuevaConsulta.rxCercaEjeOI || '',

      // Observaci√≥n
      rxObservacion: nuevaConsulta.rxObservaciones || '',

      // Metadata
      fechaCreacion: new Date().toISOString(),
      origenConsultorio: true,
      consultaId: nuevaConsulta.id
    };

    medidas.push(prescripcion);
    save(DB.MEDIDAS, medidas);

    console.log('‚úÖ Consulta guardada exitosamente:', nuevaConsulta.id);
    console.log('‚úÖ Prescripci√≥n guardada en DB.MEDIDAS:', prescripcionId);

    // Notificaci√≥n de √©xito con detalles
    toast(`‚úÖ Consulta y Prescripci√≥n guardadas exitosamente`, 'success');

    // Recargar historial
    cargarHistorialConsultas();

    // Limpiar solo datos cl√≠nicos, mantener paciente
    limpiarFormularioConsultorioSinPaciente();

    // Enfocar motivo para siguiente consulta
    setTimeout(() => {
      document.getElementById('consultorioMotivo')?.focus();
    }, 300);

    // Mostrar opci√≥n de imprimir
    if (confirm('¬øDesea imprimir la receta m√©dica de esta consulta?')) {
      imprimirRecetaMedica(nuevaConsulta.id);
    }

    return nuevaConsulta.id;

  } catch (error) {
    console.error('‚ùå Error al guardar consulta:', error);
    toast('‚ùå Error al guardar la consulta. Por favor intente nuevamente.', 'error');
    return null;
  } finally {
    // Restaurar bot√≥n de guardado
    if (btnGuardar) {
      btnGuardar.disabled = false;
      btnGuardar.textContent = textoOriginal || 'üíæ Guardar Consulta';
      btnGuardar.style.opacity = '1';
    }
  }
}

// ============================================
// SISTEMA DE HISTORIAL CL√çNICO AVANZADO
// ============================================

function cargarHistorialConsultas() {
  const historialDiv = document.getElementById('consultorioHistorial');

  if (!historialDiv) {
    console.warn('‚ö†Ô∏è Elemento consultorioHistorial no encontrado');
    return;
  }

  if (!pacienteConsultorioActual) {
    historialDiv.innerHTML = `
      <div style="padding: 40px; text-align: center; background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%); border-radius: 16px; border: 3px dashed #d1d5db;">
        <div style="font-size: 64px; margin-bottom: 16px; opacity: 0.5;">üìã</div>
        <div style="font-size: 16px; font-weight: 700; color: #6b7280; margin-bottom: 8px;">Historial Cl√≠nico</div>
        <div style="font-size: 13px; color: #9ca3af;">Seleccione un paciente para ver su historial cl√≠nico</div>
      </div>
    `;
    return;
  }

  const consultas = load(DB.CONSULTAS_CLINICAS);
  const consultasPaciente = consultas.filter(c => c.idCliente === pacienteConsultorioActual.id)
    .sort((a, b) => new Date(b.fecha) - new Date(a.fecha))
    .slice(0, 15); // √öltimas 15 consultas

  if (consultasPaciente.length === 0) {
    historialDiv.innerHTML = `
      <div style="padding: 30px; text-align: center; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 16px; border: 3px solid #f59e0b; box-shadow: 0 8px 24px rgba(245, 158, 11, 0.2);">
        <div style="font-size: 56px; margin-bottom: 12px;">üìã</div>
        <div style="font-size: 16px; font-weight: 800; color: #92400e; margin-bottom: 6px;">Primera Consulta</div>
        <div style="font-size: 13px; color: #92400e; opacity: 0.85;">Este paciente no tiene consultas previas registradas</div>
        <div style="margin-top: 16px; padding: 12px; background: rgba(255,255,255,0.6); border-radius: 10px; font-size: 12px; color: #78350f;">
          üí° Complete el formulario para crear el primer registro cl√≠nico
        </div>
      </div>
    `;
    return;
  }

  // Generar HTML del historial con dise√±o moderno
  let historialHTML = `
    <div style="background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%); padding: 16px 20px; border-radius: 12px 12px 0 0; color: white; margin-bottom: 16px; box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
          <div style="font-size: 18px; font-weight: 800; margin-bottom: 4px;">üìä HISTORIAL CL√çNICO</div>
          <div style="font-size: 12px; opacity: 0.95;">${consultasPaciente.length} consulta${consultasPaciente.length !== 1 ? 's' : ''} registrada${consultasPaciente.length !== 1 ? 's' : ''}</div>
        </div>
        <div style="background: rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 10px; backdrop-filter: blur(10px);">
          <div style="font-size: 11px; opacity: 0.9; margin-bottom: 2px;">Paciente</div>
          <div style="font-size: 14px; font-weight: 700;">${pacienteConsultorioActual.nombres || pacienteConsultorioActual.nombre} ${pacienteConsultorioActual.apellidos || pacienteConsultorioActual.apellido}</div>
        </div>
      </div>
    </div>

    <div style="max-height: 600px; overflow-y: auto; padding-right: 8px;">
  `;

  consultasPaciente.forEach((consulta, index) => {
    // Construir diagn√≥sticos
    const diagnosticos = [];
    if (consulta.diagMiopia) diagnosticos.push('Miop√≠a');
    if (consulta.diagHipermetropia) diagnosticos.push('Hipermetrop√≠a');
    if (consulta.diagAstigmatismo) diagnosticos.push('Astigmatismo');
    if (consulta.diagPresbicia) diagnosticos.push('Presbicia');
    if (consulta.diagAmbliopia) diagnosticos.push('Ambliop√≠a');
    if (consulta.diagAnisometropia) diagnosticos.push('Anisometrop√≠a');

    const diagnosticoTexto = diagnosticos.length > 0 ? diagnosticos.join(', ') : 'Sin diagn√≥stico espec√≠fico';

    // Verificar si tiene prescripci√≥n
    const tienePrescripcion = consulta.rxDistEsfOD || consulta.rxDistEsfOI || consulta.rxCercaEsfOD || consulta.rxCercaEsfOI;

    historialHTML += `
      <div style="background: white; border: 2px solid #e5e7eb; border-radius: 12px; padding: 16px; margin-bottom: 12px; cursor: pointer; transition: all 0.3s; animation: fadeIn 0.3s ease ${index * 0.05}s both; position: relative; overflow: hidden;"
           onclick="verDetalleConsulta('${consulta.id}')"
           onmouseover="this.style.borderColor='#7c3aed'; this.style.boxShadow='0 8px 24px rgba(124, 58, 237, 0.2)'; this.style.transform='translateY(-2px)'"
           onmouseout="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'; this.style.transform='translateY(0)'">

        <!-- Indicador visual lateral -->
        <div style="position: absolute; left: 0; top: 0; bottom: 0; width: 5px; background: linear-gradient(180deg, #7c3aed 0%, #6d28d9 100%);"></div>

        <!-- Header de la consulta -->
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px; padding-left: 8px;">
          <div style="flex: 1;">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
              <span style="font-size: 20px;">üìÖ</span>
              <div style="font-weight: 800; color: #7c3aed; font-size: 15px;">${consulta.fechaFormato}</div>
              ${index === 0 ? '<span style="background: #10b981; color: white; padding: 2px 8px; border-radius: 12px; font-size: 10px; font-weight: 700;">M√ÅS RECIENTE</span>' : ''}
            </div>
            <div style="font-size: 11px; color: #9ca3af; font-family: monospace;">${consulta.id}</div>
          </div>

          <div style="text-align: right;">
            ${consulta.rxEspecialista ? `
            <div style="background: #eff6ff; padding: 6px 12px; border-radius: 8px; border: 1px solid #bfdbfe;">
              <div style="font-size: 10px; color: #3b82f6; font-weight: 700; margin-bottom: 2px;">ATENDIDO POR</div>
              <div style="font-size: 11px; color: #1e40af; font-weight: 600;">${consulta.rxEspecialista}</div>
            </div>
            ` : ''}
          </div>
        </div>

        <!-- Contenido de la consulta -->
        <div style="padding-left: 8px;">
          <!-- Motivo -->
          <div style="background: #f8fafc; padding: 12px; border-radius: 10px; margin-bottom: 10px; border-left: 3px solid #64748b;">
            <div style="font-size: 10px; font-weight: 700; color: #64748b; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px;">üí¨ Motivo de Consulta</div>
            <div style="font-size: 13px; color: #1e293b; line-height: 1.5;">${consulta.motivo || 'Sin especificar'}</div>
          </div>

          <!-- Diagn√≥stico -->
          ${diagnosticos.length > 0 ? `
          <div style="background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); padding: 12px; border-radius: 10px; margin-bottom: 10px; border: 2px solid #6ee7b7;">
            <div style="font-size: 10px; font-weight: 700; color: #065f46; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;">üîç Diagn√≥stico</div>
            <div style="display: flex; flex-wrap: wrap; gap: 6px;">
              ${diagnosticos.map(d => `<span style="background: #10b981; color: white; padding: 4px 10px; border-radius: 16px; font-size: 11px; font-weight: 600;">${d}</span>`).join('')}
            </div>
          </div>
          ` : ''}

          <!-- Prescripci√≥n -->
          ${tienePrescripcion ? `
          <div style="background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); padding: 12px; border-radius: 10px; border: 2px solid #93c5fd;">
            <div style="font-size: 10px; font-weight: 700; color: #1e40af; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">üëì Prescripci√≥n de Lentes</div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 11px;">
              ${consulta.rxDistEsfOD || consulta.rxDistEsfOI ? `
              <div style="background: white; padding: 8px; border-radius: 6px;">
                <div style="font-weight: 700; color: #1e40af; margin-bottom: 4px;">Distancia</div>
                <div style="color: #475569;">
                  <div>OD: ${consulta.rxDistEsfOD || '-'} ${consulta.rxDistCilOD ? consulta.rxDistCilOD : ''} ${consulta.rxDistEjeOD ? consulta.rxDistEjeOD + '¬∞' : ''}</div>
                  <div>OI: ${consulta.rxDistEsfOI || '-'} ${consulta.rxDistCilOI ? consulta.rxDistCilOI : ''} ${consulta.rxDistEjeOI ? consulta.rxDistEjeOI + '¬∞' : ''}</div>
                </div>
              </div>
              ` : ''}
              ${consulta.rxCercaEsfOD || consulta.rxCercaEsfOI ? `
              <div style="background: white; padding: 8px; border-radius: 6px;">
                <div style="font-weight: 700; color: #1e40af; margin-bottom: 4px;">Cerca</div>
                <div style="color: #475569;">
                  <div>OD: ${consulta.rxCercaEsfOD || '-'} ${consulta.rxCercaCilOD ? consulta.rxCercaCilOD : ''}</div>
                  <div>OI: ${consulta.rxCercaEsfOI || '-'} ${consulta.rxCercaCilOI ? consulta.rxCercaCilOI : ''}</div>
                </div>
              </div>
              ` : ''}
            </div>
          </div>
          ` : ''}

          <!-- Bot√≥n ver m√°s -->
          <div style="margin-top: 12px; text-align: right;">
            <span style="color: #7c3aed; font-size: 12px; font-weight: 600; display: inline-flex; align-items: center; gap: 4px;">
              <span>Ver detalles completos</span>
              <span>‚Üí</span>
            </span>
          </div>
        </div>
      </div>
    `;
  });

  historialHTML += '</div>';

  historialDiv.innerHTML = historialHTML;
  console.log(`‚úÖ Historial cargado: ${consultasPaciente.length} consultas`);
}

// Variable global para almacenar consulta actual
let consultaActualModal = null;

// Ver detalle completo de una consulta - VERSI√ìN ULTRA MODERNA
function verDetalleConsulta(idConsulta) {
  const consultas = load(DB.CONSULTAS_CLINICAS);
  const consulta = consultas.find(c => c.id === idConsulta);

  if (!consulta) {
    toast('‚ùå Consulta no encontrada', 'error');
    return;
  }

  // Almacenar consulta actual para funciones de impresi√≥n/export
  consultaActualModal = consulta;

  // Actualizar subt√≠tulo del modal
  document.getElementById('modalHistorialSubtitulo').textContent =
    `${consulta.nombreCliente} - DNI: ${consulta.dniCliente} - ${consulta.fechaFormato}`;

  // Construir HTML moderno
  let detalleHTML = '';

  // 1. MOTIVO DE CONSULTA
  detalleHTML += `
    <div class="historial-section">
      <h3 class="historial-section-title"><span>üìã</span> MOTIVO DE CONSULTA</h3>
      <div style="background: linear-gradient(135deg, #f3f4f6, #e5e7eb); padding: 16px; border-radius: 10px; border-left: 5px solid var(--primary-500);">
        <p style="margin: 0; font-size: 15px; color: #374151; line-height: 1.6;">${consulta.motivo || 'No especificado'}</p>
      </div>
    </div>
  `;

  // 2. MEDIDAS - Visi√≥n de Lejos
  if (consulta.medLejosEsfOD || consulta.medLejosEsfOI) {
    detalleHTML += `
      <div class="historial-section">
        <h3 class="historial-section-title"><span>üëÅÔ∏è</span> VISI√ìN DE LEJOS</h3>
        <div class="rx-grid" style="grid-template-columns: 80px repeat(9, 1fr); font-size: 13px;">
          <div></div>
          <div class="rx-header">Esf√©rico</div>
          <div class="rx-header">Cilindro</div>
          <div class="rx-header">Eje</div>
          <div class="rx-header">A.V</div>
          <div class="rx-header">D.Pup</div>
          <div class="rx-header">D.NP</div>
          <div class="rx-header">Prisma</div>
          <div class="rx-header">Add</div>
          <div class="rx-header">Add Media</div>

          <div class="rx-label">OD</div>
          <div style="padding: 8px; background: white; border-radius: 6px; font-weight: 600; text-align: center;">${consulta.medLejosEsfOD || '-'}</div>
          <div style="padding: 8px; background: white; border-radius: 6px; font-weight: 600; text-align: center;">${consulta.medLejosCilOD || '-'}</div>
          <div style="padding: 8px; background: white; border-radius: 6px; font-weight: 600; text-align: center;">${consulta.medLejosEjeOD || '-'}</div>
          <div style="padding: 8px; background: white; border-radius: 6px; font-weight: 600; text-align: center;">${consulta.medLejosAVOD || '-'}</div>
          <div style="padding: 8px; background: white; border-radius: 6px; font-weight: 600; text-align: center;">${consulta.medLejosDistPupOD || '-'}</div>
          <div style="padding: 8px; background: white; border-radius: 6px; font-weight: 600; text-align: center;">${consulta.medLejosDistNPOD || '-'}</div>
          <div style="padding: 8px; background: white; border-radius: 6px; font-weight: 600; text-align: center;">${consulta.medLejosPrismaOD || '-'}</div>
          <div style="padding: 8px; background: white; border-radius: 6px; font-weight: 600; text-align: center;">${consulta.medLejosAdicionOD || '-'}</div>
          <div style="padding: 8px; background: white; border-radius: 6px; font-weight: 600; text-align: center;">${consulta.medLejosAddMediaOD || '-'}</div>

          <div class="rx-label">OI</div>
          <div style="padding: 8px; background: white; border-radius: 6px; font-weight: 600; text-align: center;">${consulta.medLejosEsfOI || '-'}</div>
          <div style="padding: 8px; background: white; border-radius: 6px; font-weight: 600; text-align: center;">${consulta.medLejosCilOI || '-'}</div>
          <div style="padding: 8px; background: white; border-radius: 6px; font-weight: 600; text-align: center;">${consulta.medLejosEjeOI || '-'}</div>
          <div style="padding: 8px; background: white; border-radius: 6px; font-weight: 600; text-align: center;">${consulta.medLejosAVOI || '-'}</div>
          <div style="padding: 8px; background: white; border-radius: 6px; font-weight: 600; text-align: center;">${consulta.medLejosDistPupOI || '-'}</div>
          <div style="padding: 8px; background: white; border-radius: 6px; font-weight: 600; text-align: center;">${consulta.medLejosDistNPOI || '-'}</div>
          <div style="padding: 8px; background: white; border-radius: 6px; font-weight: 600; text-align: center;">${consulta.medLejosPrismaOI || '-'}</div>
          <div style="padding: 8px; background: white; border-radius: 6px; font-weight: 600; text-align: center;">${consulta.medLejosAdicionOI || '-'}</div>
          <div style="padding: 8px; background: white; border-radius: 6px; font-weight: 600; text-align: center;">${consulta.medLejosAddMediaOI || '-'}</div>
        </div>
      </div>
    `;
  }

  // MEDIDAS - Visi√≥n de Cerca
  if (consulta.medCercaEsfOD || consulta.medCercaEsfOI) {
    detalleHTML += '<div style="margin-bottom: 16px;"><h3 style="margin: 0 0 8px 0; font-size: 14px; color: #7c3aed;">üìè MEDIDAS - Visi√≥n de Cerca</h3>';
    detalleHTML += '<table style="width:100%; border-collapse: collapse; font-size: 12px;"><tr style="background: #e9d5ff;"><th>Ojo</th><th>Esf√©rico</th><th>Cilindro</th><th>Eje</th><th>A.V</th><th>D.Pup</th><th>D.NP</th><th>Prisma</th><th>Altura</th></tr>';
    detalleHTML += '<tr><td>OD</td><td>' + (consulta.medCercaEsfOD || '-') + '</td><td>' + (consulta.medCercaCilOD || '-') + '</td><td>' + (consulta.medCercaEjeOD || '-') + '</td><td>' + (consulta.medCercaAVOD || '-') + '</td><td>' + (consulta.medCercaDistPupOD || '-') + '</td><td>' + (consulta.medCercaDistNPOD || '-') + '</td><td>' + (consulta.medCercaPrismaOD || '-') + '</td><td>' + (consulta.medCercaAlturaOD || '-') + '</td></tr>';
    detalleHTML += '<tr><td>OI</td><td>' + (consulta.medCercaEsfOI || '-') + '</td><td>' + (consulta.medCercaCilOI || '-') + '</td><td>' + (consulta.medCercaEjeOI || '-') + '</td><td>' + (consulta.medCercaAVOI || '-') + '</td><td>' + (consulta.medCercaDistPupOI || '-') + '</td><td>' + (consulta.medCercaDistNPOI || '-') + '</td><td>' + (consulta.medCercaPrismaOI || '-') + '</td><td>' + (consulta.medCercaAlturaOI || '-') + '</td></tr>';
    detalleHTML += '</table></div>';
  }

  // L.C (Lentes de Contacto)
  if (consulta.lcMarcaOD || consulta.lcMarcaOI || consulta.lcObservaciones) {
    detalleHTML += '<div style="margin-bottom: 16px;"><h3 style="margin: 0 0 8px 0; font-size: 14px; color: #7c3aed;">üëÅÔ∏è Lentes de Contacto</h3>';
    detalleHTML += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 13px;">';
    detalleHTML += '<div><strong>OD - Marca:</strong> ' + (consulta.lcMarcaOD || '-') + '</div><div><strong>OI - Marca:</strong> ' + (consulta.lcMarcaOI || '-') + '</div>';
    detalleHTML += '<div><strong>OD - Curva Base:</strong> ' + (consulta.lcCurvaBaseOD || '-') + '</div><div><strong>OI - Curva Base:</strong> ' + (consulta.lcCurvaBaseOI || '-') + '</div>';
    detalleHTML += '<div><strong>OD - Di√°metro:</strong> ' + (consulta.lcDiametroOD || '-') + '</div><div><strong>OI - Di√°metro:</strong> ' + (consulta.lcDiametroOI || '-') + '</div>';
    detalleHTML += '<div><strong>OD - Poder:</strong> ' + (consulta.lcPoderOD || '-') + '</div><div><strong>OI - Poder:</strong> ' + (consulta.lcPoderOI || '-') + '</div>';
    detalleHTML += '</div>';
    if (consulta.lcObservaciones) {
      detalleHTML += '<div style="margin-top: 8px;"><strong>Observaciones:</strong> ' + consulta.lcObservaciones + '</div>';
    }
    detalleHTML += '</div>';
  }

  // OTROS
  if (consulta.queratometriaOD || consulta.presionIntraOD || consulta.biomicroscopia || consulta.fondoOjo || consulta.otrosHallazgos) {
    detalleHTML += '<div style="margin-bottom: 16px;"><h3 style="margin: 0 0 8px 0; font-size: 14px; color: #7c3aed;">üî¨ Otros Ex√°menes</h3>';
    detalleHTML += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 13px;">';
    detalleHTML += '<div><strong>Queratometr√≠a OD:</strong> ' + (consulta.queratometriaOD || '-') + '</div><div><strong>Queratometr√≠a OI:</strong> ' + (consulta.queratometriaOI || '-') + '</div>';
    detalleHTML += '<div><strong>Presi√≥n Intra OD:</strong> ' + (consulta.presionIntraOD || '-') + '</div><div><strong>Presi√≥n Intra OI:</strong> ' + (consulta.presionIntraOI || '-') + '</div>';
    detalleHTML += '</div>';
    if (consulta.biomicroscopia) detalleHTML += '<div style="margin-top: 8px;"><strong>Biomicroscop√≠a:</strong> ' + consulta.biomicroscopia + '</div>';
    if (consulta.fondoOjo) detalleHTML += '<div style="margin-top: 8px;"><strong>Fondo de Ojo:</strong> ' + consulta.fondoOjo + '</div>';
    if (consulta.otrosHallazgos) detalleHTML += '<div style="margin-top: 8px;"><strong>Otros Hallazgos:</strong> ' + consulta.otrosHallazgos + '</div>';
    detalleHTML += '</div>';
  }

  // PRESCRIPCI√ìN DE LENTES
  if (consulta.rxDistEsfOD || consulta.rxDistEsfOI || consulta.rxCercaEsfOD || consulta.rxCercaEsfOI) {
    detalleHTML += '<div style="margin-bottom: 16px; padding: 16px; background: #eff6ff; border: 2px solid #1e40af; border-radius: 8px;">';
    detalleHTML += '<h3 style="margin: 0 0 12px 0; font-size: 14px; color: #1e40af; text-align: center; font-weight: 700;">üìã PRESCRIPCI√ìN DE LENTES</h3>';

    // Distancia
    detalleHTML += '<div style="margin-bottom: 12px;"><strong style="color: #1e40af;">DISTANCIA:</strong></div>';
    detalleHTML += '<table style="width: 100%; border-collapse: collapse; margin-bottom: 16px; font-size: 12px;"><tr style="background: #3b82f6; color: white;"><th style="padding: 6px; border: 1px solid #1e40af;"></th><th style="padding: 6px; border: 1px solid #1e40af;">ESF</th><th style="padding: 6px; border: 1px solid #1e40af;">CIL</th><th style="padding: 6px; border: 1px solid #1e40af;">EJE</th><th style="padding: 6px; border: 1px solid #1e40af;">DIP</th></tr>';
    detalleHTML += '<tr style="background: #dbeafe;"><td style="padding: 6px; border: 1px solid #1e40af; font-weight: bold;">O.D.</td><td style="padding: 6px; border: 1px solid #1e40af;">' + (consulta.rxDistEsfOD || '-') + '</td><td style="padding: 6px; border: 1px solid #1e40af;">' + (consulta.rxDistCilOD || '-') + '</td><td style="padding: 6px; border: 1px solid #1e40af;">' + (consulta.rxDistEjeOD || '-') + '</td><td style="padding: 6px; border: 1px solid #1e40af;">' + (consulta.rxDistDipOD || '-') + '</td></tr>';
    detalleHTML += '<tr><td style="padding: 6px; border: 1px solid #1e40af; font-weight: bold;">O.I.</td><td style="padding: 6px; border: 1px solid #1e40af;">' + (consulta.rxDistEsfOI || '-') + '</td><td style="padding: 6px; border: 1px solid #1e40af;">' + (consulta.rxDistCilOI || '-') + '</td><td style="padding: 6px; border: 1px solid #1e40af;">' + (consulta.rxDistEjeOI || '-') + '</td><td style="padding: 6px; border: 1px solid #1e40af;">' + (consulta.rxDistDipOI || '-') + '</td></tr></table>';

    // Cerca
    detalleHTML += '<div style="margin-bottom: 12px;"><strong style="color: #1e40af;">CERCA:</strong></div>';
    detalleHTML += '<table style="width: 100%; border-collapse: collapse; font-size: 12px;"><tr style="background: #3b82f6; color: white;"><th style="padding: 6px; border: 1px solid #1e40af;"></th><th style="padding: 6px; border: 1px solid #1e40af;">ESF</th><th style="padding: 6px; border: 1px solid #1e40af;">CIL</th><th style="padding: 6px; border: 1px solid #1e40af;">EJE</th><th style="padding: 6px; border: 1px solid #1e40af;">DIP</th></tr>';
    detalleHTML += '<tr style="background: #dbeafe;"><td style="padding: 6px; border: 1px solid #1e40af; font-weight: bold;">O.D.</td><td style="padding: 6px; border: 1px solid #1e40af;">' + (consulta.rxCercaEsfOD || '-') + '</td><td style="padding: 6px; border: 1px solid #1e40af;">' + (consulta.rxCercaCilOD || '-') + '</td><td style="padding: 6px; border: 1px solid #1e40af;">' + (consulta.rxCercaEjeOD || '-') + '</td><td style="padding: 6px; border: 1px solid #1e40af;">' + (consulta.rxCercaDipOD || '-') + '</td></tr>';
    detalleHTML += '<tr><td style="padding: 6px; border: 1px solid #1e40af; font-weight: bold;">O.I.</td><td style="padding: 6px; border: 1px solid #1e40af;">' + (consulta.rxCercaEsfOI || '-') + '</td><td style="padding: 6px; border: 1px solid #1e40af;">' + (consulta.rxCercaCilOI || '-') + '</td><td style="padding: 6px; border: 1px solid #1e40af;">' + (consulta.rxCercaEjeOI || '-') + '</td><td style="padding: 6px; border: 1px solid #1e40af;">' + (consulta.rxCercaDipOI || '-') + '</td></tr></table>';
    detalleHTML += '</div>';
  }

  // PIO
  if (consulta.rxPioOD || consulta.rxPioOI) {
    detalleHTML += '<div style="margin-bottom: 16px;"><h3 style="margin: 0 0 8px 0; font-size: 14px; color: #7c3aed;">üìä Presi√≥n Intraocular</h3>';
    detalleHTML += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 13px;">';
    detalleHTML += '<div><strong>PIO OD:</strong> ' + (consulta.rxPioOD || '-') + ' mmHg</div>';
    detalleHTML += '<div><strong>PIO OI:</strong> ' + (consulta.rxPioOI || '-') + ' mmHg</div>';
    detalleHTML += '</div></div>';
  }

  // Diagn√≥sticos
  const diagnosticosDetalle = [];
  if (consulta.diagMiopia) diagnosticosDetalle.push('Miop√≠a');
  if (consulta.diagHipermetropia) diagnosticosDetalle.push('Hipermetrop√≠a');
  if (consulta.diagAstigmatismo) diagnosticosDetalle.push('Astigmatismo');
  if (consulta.diagPresbicia) diagnosticosDetalle.push('Presbicia');
  if (consulta.diagAmbliopia) diagnosticosDetalle.push('Ambliop√≠a');
  if (consulta.diagAnisometropia) diagnosticosDetalle.push('Anisometrop√≠a');

  if (diagnosticosDetalle.length > 0) {
    detalleHTML += '<div style="margin-bottom: 16px; padding: 12px; background: #d1fae5; border-left: 4px solid #10b981; border-radius: 4px;">';
    detalleHTML += '<h3 style="margin: 0 0 8px 0; font-size: 14px; color: #059669;">üîç Diagn√≥stico</h3>';
    detalleHTML += '<p style="margin: 0;">' + diagnosticosDetalle.join(', ') + '</p></div>';
  }

  // Observaciones
  if (consulta.rxObservaciones) {
    detalleHTML += '<div style="margin-bottom: 16px;"><h3 style="margin: 0 0 8px 0; font-size: 14px; color: #7c3aed;">üìù Observaciones</h3>';
    detalleHTML += '<p style="margin: 0; color: #475569;">' + consulta.rxObservaciones + '</p></div>';
  }

  // Especialista
  if (consulta.rxEspecialista) {
    detalleHTML += '<div style="margin-bottom: 16px;"><h3 style="margin: 0 0 8px 0; font-size: 14px; color: #7c3aed;">üë®‚Äç‚öïÔ∏è Especialista</h3>';
    detalleHTML += '<p style="margin: 0; color: #475569;">' + consulta.rxEspecialista + '</p></div>';
  }

  // HISTORIAL CL√çNICO
  if (consulta.antecedentesOculares || consulta.antecedentesMedicos || consulta.medicamentosActuales || consulta.antecedentesFamiliares) {
    detalleHTML += '<div style="margin-bottom: 16px; padding: 12px; background: #fef3c7; border-left: 4px solid #f59e0b; border-radius: 4px;">';
    detalleHTML += '<h3 style="margin: 0 0 8px 0; font-size: 14px; color: #92400e;">üìã Historial Cl√≠nico</h3>';
    if (consulta.antecedentesOculares) detalleHTML += '<div style="margin-bottom: 6px;"><strong>Antecedentes Oculares:</strong> ' + consulta.antecedentesOculares + '</div>';
    if (consulta.antecedentesMedicos) detalleHTML += '<div style="margin-bottom: 6px;"><strong>Antecedentes M√©dicos:</strong> ' + consulta.antecedentesMedicos + '</div>';
    if (consulta.medicamentosActuales) detalleHTML += '<div style="margin-bottom: 6px;"><strong>Medicamentos Actuales:</strong> ' + consulta.medicamentosActuales + '</div>';
    if (consulta.antecedentesFamiliares) detalleHTML += '<div><strong>Antecedentes Familiares:</strong> ' + consulta.antecedentesFamiliares + '</div>';
    detalleHTML += '</div>';
  }

  if (consulta.planTratamiento) {
    detalleHTML += '<div style="margin-bottom: 16px;"><h3 style="margin: 0 0 8px 0; font-size: 14px; color: #7c3aed;">üíä Plan de Tratamiento</h3>';
    detalleHTML += '<p style="margin: 0; color: #475569;">' + consulta.planTratamiento + '</p></div>';
  }

  if (consulta.recomendaciones) {
    detalleHTML += '<div style="margin-bottom: 16px;"><h3 style="margin: 0 0 8px 0; font-size: 14px; color: #7c3aed;">üí° Recomendaciones</h3>';
    detalleHTML += '<p style="margin: 0; color: #475569;">' + consulta.recomendaciones + '</p></div>';
  }

  if (consulta.proximoControl) {
    detalleHTML += '<div style="margin-bottom: 16px;"><h3 style="margin: 0 0 8px 0; font-size: 14px; color: #7c3aed;">üìÖ Pr√≥ximo Control</h3>';
    detalleHTML += '<p style="margin: 0; color: #475569;">' + consulta.proximoControl + '</p></div>';
  }

  if (consulta.indicacionesVenta) {
    detalleHTML += '<div style="margin-bottom: 16px;"><h3 style="margin: 0 0 8px 0; font-size: 14px; color: #7c3aed;">üìù Indicaciones para Venta</h3>';
    detalleHTML += '<p style="margin: 0; color: #475569;">' + consulta.indicacionesVenta + '</p></div>';
  }

  detalleHTML += '<div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid #e5e7eb; font-size: 12px; color: #9ca3af;">';
  detalleHTML += '<strong>Usuario:</strong> ' + consulta.usuario + ' | <strong>Establecimiento:</strong> ' + consulta.establecimiento + '</div>';

  detalleHTML += '<div style="margin-top: 16px; text-align: center;">';
  detalleHTML += '<button class="btn btn-primary" onclick="imprimirConsulta(\'' + consulta.id + '\')">üñ®Ô∏è Imprimir</button>';
  detalleHTML += '<button class="btn btn-secondary" onclick="cerrarDetalleConsulta()">Cerrar</button>';
  detalleHTML += '</div></div></div>';

  // Insertar contenido en el modal y mostrarlo
  document.getElementById('modalHistorialContenido').innerHTML = detalleHTML;
  document.getElementById('modalHistorialConsulta').style.display = 'flex';

  // Animaci√≥n de entrada
  setTimeout(() => {
    document.querySelector('.modal-historial-container').style.opacity = '1';
  }, 10);
}

// Cerrar modal de historial
function cerrarModalHistorial() {
  document.getElementById('modalHistorialConsulta').style.display = 'none';
  consultaActualModal = null;
}

// Funci√≥n obsoleta para compatibilidad
function cerrarDetalleConsulta() {
  cerrarModalHistorial();
}

// Imprimir consulta actual del modal
function imprimirConsultaActual() {
  if (consultaActualModal) {
    imprimirConsulta(consultaActualModal.id);
  } else {
    toast('‚ö†Ô∏è No hay consulta seleccionada', 'warning');
  }
}

// Ver historial completo de consultas del paciente
function verHistorialCompletoConsultas(clienteId) {
  const consultas = load(DB.CONSULTAS_CLINICAS);
  const cliente = load(DB.CLIENTES).find(c => c.id === clienteId);

  if (!cliente) {
    toast('‚ùå Cliente no encontrado', 'error');
    return;
  }

  const consultasPaciente = consultas.filter(c => c.idCliente === clienteId)
    .sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

  const nombreCompleto = `${cliente.nombres || cliente.nombre || ''} ${cliente.apellidos || cliente.apellido || ''}`.trim();

  if (consultasPaciente.length === 0) {
    toast('‚ö†Ô∏è Este paciente no tiene consultas registradas', 'warning');
    return;
  }

  // Construir contenido del modal
  let contenidoHTML = `
    <div style="background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%); padding: 20px; margin: -24px -24px 20px -24px; color: white; border-radius: 12px 12px 0 0;">
      <div style="font-size: 24px; font-weight: 800; margin-bottom: 8px;">üìä HISTORIAL COMPLETO DE CONSULTAS</div>
      <div style="font-size: 14px; opacity: 0.95;">Paciente: ${nombreCompleto}</div>
      <div style="font-size: 13px; opacity: 0.85; margin-top: 4px;">Total: ${consultasPaciente.length} consulta${consultasPaciente.length !== 1 ? 's' : ''} registrada${consultasPaciente.length !== 1 ? 's' : ''}</div>
    </div>

    <div style="max-height: 500px; overflow-y: auto; padding-right: 8px;">
  `;

  consultasPaciente.forEach((consulta, index) => {
    const diagnosticos = [];
    if (consulta.diagMiopia) diagnosticos.push('Miop√≠a');
    if (consulta.diagHipermetropia) diagnosticos.push('Hipermetrop√≠a');
    if (consulta.diagAstigmatismo) diagnosticos.push('Astigmatismo');
    if (consulta.diagPresbicia) diagnosticos.push('Presbicia');
    if (consulta.diagAmbliopia) diagnosticos.push('Ambliop√≠a');
    if (consulta.diagAnisometropia) diagnosticos.push('Anisometrop√≠a');

    const diagnosticoTexto = diagnosticos.length > 0 ? diagnosticos.join(', ') : 'Sin diagn√≥stico espec√≠fico';
    const tienePrescripcion = consulta.rxDistEsfOD || consulta.rxDistEsfOI || consulta.rxCercaEsfOD || consulta.rxCercaEsfOI;

    contenidoHTML += `
      <div onclick="cerrarModalHistorial(); verDetalleConsulta('${consulta.id}')"
           style="background: white; border: 2px solid #e5e7eb; border-radius: 12px; padding: 16px; margin-bottom: 12px; cursor: pointer; transition: all 0.3s; position: relative; overflow: hidden;"
           onmouseover="this.style.borderColor='#7c3aed'; this.style.boxShadow='0 8px 24px rgba(124, 58, 237, 0.2)'; this.style.transform='translateY(-2px)'"
           onmouseout="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'; this.style.transform='translateY(0)'">

        <div style="position: absolute; left: 0; top: 0; bottom: 0; width: 5px; background: linear-gradient(180deg, #7c3aed 0%, #6d28d9 100%);"></div>

        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px; padding-left: 8px;">
          <div style="flex: 1;">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
              <span style="font-size: 20px;">üìÖ</span>
              <div style="font-weight: 800; color: #7c3aed; font-size: 15px;">${consulta.fechaFormato || formatDate(consulta.fecha)}</div>
              ${index === 0 ? '<span style="background: #10b981; color: white; padding: 2px 8px; border-radius: 12px; font-size: 10px; font-weight: 700;">M√ÅS RECIENTE</span>' : ''}
            </div>
          </div>

          ${consulta.rxEspecialista ? `
          <div style="background: #eff6ff; padding: 6px 12px; border-radius: 8px; border: 1px solid #bfdbfe;">
            <div style="font-size: 10px; color: #3b82f6; font-weight: 700; margin-bottom: 2px;">ATENDIDO POR</div>
            <div style="font-size: 11px; color: #1e40af; font-weight: 600;">${consulta.rxEspecialista}</div>
          </div>
          ` : ''}
        </div>

        <div style="padding-left: 8px;">
          <div style="background: #f9fafb; padding: 10px; border-radius: 8px; margin-bottom: 10px;">
            <div style="font-size: 11px; color: #6b7280; font-weight: 700; margin-bottom: 4px;">üí¨ MOTIVO DE CONSULTA</div>
            <div style="font-size: 13px; color: #374151; line-height: 1.5;">${consulta.motivo || 'No especificado'}</div>
          </div>

          <div style="background: #fef3c7; padding: 10px; border-radius: 8px; margin-bottom: 10px;">
            <div style="font-size: 11px; color: #92400e; font-weight: 700; margin-bottom: 4px;">üîç DIAGN√ìSTICO</div>
            <div style="font-size: 12px; color: #78350f;">${diagnosticoTexto}</div>
          </div>

          ${tienePrescripcion ? `
          <div style="background: #d1fae5; padding: 10px; border-radius: 8px;">
            <div style="font-size: 11px; color: #065f46; font-weight: 700; margin-bottom: 4px;">üëì PRESCRIPCI√ìN</div>
            <div style="font-size: 11px; color: #047857;">
              OD: ${consulta.rxDistEsfOD || '-'} / ${consulta.rxDistCilOD || '-'} x ${consulta.rxDistEjeOD || '-'}¬∞
              &nbsp;&nbsp;|&nbsp;&nbsp;
              OI: ${consulta.rxDistEsfOI || '-'} / ${consulta.rxDistCilOI || '-'} x ${consulta.rxDistEjeOI || '-'}¬∞
            </div>
          </div>
          ` : ''}
        </div>

        <div style="text-align: center; margin-top: 12px; padding-top: 12px; border-top: 1px dashed #e5e7eb; padding-left: 8px;">
          <div style="font-size: 11px; color: #7c3aed; font-weight: 600;">üëÅÔ∏è Clic para ver detalles completos</div>
        </div>
      </div>
    `;
  });

  contenidoHTML += '</div>';

  // Insertar en el modal y mostrarlo
  document.getElementById('modalHistorialContenido').innerHTML = contenidoHTML;
  document.getElementById('modalHistorialTitulo').textContent = 'HISTORIAL COMPLETO';
  document.getElementById('modalHistorialSubtitulo').textContent = `${nombreCompleto} - ${consultasPaciente.length} consulta${consultasPaciente.length !== 1 ? 's' : ''}`;

  document.getElementById('modalHistorialConsulta').style.display = 'flex';
  setTimeout(() => {
    document.querySelector('.modal-historial-container').style.opacity = '1';
  }, 10);
}

// Exportar consulta a PDF (placeholder - se puede implementar con jsPDF)
function exportarConsultaPDF() {
  if (consultaActualModal) {
    toast('üîÑ Funci√≥n de exportaci√≥n PDF en desarrollo', 'info');
    // Aqu√≠ se puede implementar la exportaci√≥n con jsPDF
  } else {
    toast('‚ö†Ô∏è No hay consulta seleccionada', 'warning');
  }
}

/* ============================================
   MODAL DE VISUALIZACI√ìN DE RX - ULTRA MODERNO
   ============================================ */
let rxActualModal = null;
let tabRxActiva = 'actual'; // 'actual' o 'historial'
let clienteRxActual = null; // Guardar el cliente actual para el historial
let todasLasRxCliente = []; // Todas las RX del cliente (consultas + medidas)

// Funci√≥n para cambiar entre pesta√±as del modal RX
function cambiarTabRX(tab) {
  tabRxActiva = tab;

  // Actualizar estilos de las pesta√±as
  const tabActual = document.getElementById('tabRxActual');
  const tabHistorial = document.getElementById('tabRxHistorial');

  if (tab === 'actual') {
    tabActual.style.background = 'linear-gradient(135deg, #3b82f6, #2563eb)';
    tabActual.style.color = 'white';
    tabHistorial.style.background = 'white';
    tabHistorial.style.color = '#6b7280';

    // Mostrar prescripci√≥n actual
    mostrarRxActual();
  } else {
    tabHistorial.style.background = 'linear-gradient(135deg, #7c3aed, #6d28d9)';
    tabHistorial.style.color = 'white';
    tabActual.style.background = 'white';
    tabActual.style.color = '#6b7280';

    // Mostrar historial de prescripciones
    mostrarHistorialRx();
  }
}

// Funci√≥n principal para visualizar RX en modal ultra moderno
function verRxClienteModal(clienteId) {
  console.log('üëì Abriendo visualizaci√≥n RX para cliente:', clienteId);

  // Obtener datos del cliente
  const cliente = load(DB.CLIENTES).find(c => c.id === clienteId);
  if (!cliente) {
    toast('‚ùå Cliente no encontrado', 'error');
    return;
  }

  // Construir nombre completo
  const nombre = cliente.nombre || cliente.nombres || '';
  const apellido = cliente.apellidos || cliente.apellido || '';
  const nombreCompleto = (nombre + ' ' + apellido).trim();

  // Buscar √∫ltima prescripci√≥n/consulta del cliente
  const consultas = load(DB.CONSULTAS_CLINICAS).filter(c => c.idCliente === clienteId)
    .sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

  const medidas = load(DB.MEDIDAS).filter(m => m.clienteId === clienteId)
    .sort((a, b) => (b.fecha || '').localeCompare(a.fecha || ''));

  console.log('üîç B√∫squeda RX para cliente:', clienteId);
  console.log('üìã Consultas encontradas:', consultas.length, consultas);
  console.log('üìè Medidas encontradas:', medidas.length, medidas);

  // Determinar qu√© datos usar (priorizar consultas cl√≠nicas, luego medidas)
  let rxData = null;
  let fuente = '';

  if (consultas.length > 0) {
    rxData = consultas[0];
    fuente = 'CONSULTA CL√çNICA';
    console.log('‚úÖ Usando datos de CONSULTA CL√çNICA:', rxData);
  } else if (medidas.length > 0) {
    rxData = medidas[0];
    fuente = 'MEDIDA';
    console.log('‚úÖ Usando datos de MEDIDA:', rxData);
  } else {
    console.log('‚ùå No se encontraron prescripciones para este cliente');
    toast('‚ö†Ô∏è No hay prescripciones registradas para este cliente', 'warning');
    return;
  }

  // Guardar datos globales para el modal
  clienteRxActual = cliente;
  rxActualModal = { ...rxData, clienteNombre: nombreCompleto, clienteDni: cliente.documento, fuente: fuente };

  // Combinar y ordenar TODAS las RX del cliente (consultas + medidas)
  todasLasRxCliente = [
    ...consultas.map(c => ({ ...c, fuente: 'CONSULTA CL√çNICA' })),
    ...medidas.map(m => ({ ...m, fuente: 'MEDIDA' }))
  ].sort((a, b) => new Date(b.fecha || 0) - new Date(a.fecha || 0));

  console.log('üìä Total de RX encontradas:', todasLasRxCliente.length);

  // Actualizar subt√≠tulo del modal
  const fechaRx = formatDate(rxData.fecha) || 'Sin fecha';
  document.getElementById('modalRxSubtitulo').textContent =
    `${nombreCompleto} - DNI: ${cliente.documento || 'N/A'} - ${todasLasRxCliente.length} prescripci√≥n(es) registrada(s)`;

  // Generar contenido del modal
  let contenidoHTML = '';

  // Agregar encabezado con fecha de la prescripci√≥n
  contenidoHTML += `
    <div style="background: linear-gradient(135deg, #3b82f6, #2563eb); padding: 20px 30px; margin: 0; border-radius: 0; color: white; box-shadow: 0 4px 20px rgba(59, 130, 246, 0.3);">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
          <h3 style="margin: 0; font-size: 18px; font-weight: 800;">üìÖ Prescripci√≥n del ${fechaRx}</h3>
          <p style="margin: 4px 0 0 0; font-size: 13px; opacity: 0.9;">Fuente: ${fuente}</p>
        </div>
        <div style="background: rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 8px; font-size: 14px; font-weight: 700;">
          ${todasLasRxCliente.length > 1 ? `${todasLasRxCliente.length - 1} prescripci√≥n(es) anterior(es)` : 'Primera prescripci√≥n'}
        </div>
      </div>
    </div>
  `;

  // ========================================
  // TABLA DE DISTANCIA (VISI√ìN DE LEJOS)
  // ========================================
  // Debug: mostrar valores espec√≠ficos de campos de Lejos
  console.log('üîç Verificando campos LEJOS:');
  console.log('  lejosOdEsf:', rxData.lejosOdEsf);
  console.log('  medLejosEsfOD:', rxData.medLejosEsfOD);
  console.log('  rxDistEsfOD:', rxData.rxDistEsfOD);
  console.log('  rxDistEsfOI:', rxData.rxDistEsfOI);

  // Verificar si existen datos de distancia (ignorar strings vac√≠as)
  const tieneDatosLejos =
    (rxData.lejosOdEsf && rxData.lejosOdEsf !== '') ||
    (rxData.lejosOdCil && rxData.lejosOdCil !== '') ||
    (rxData.lejosOdEje && rxData.lejosOdEje !== '') ||
    (rxData.lejosOiEsf && rxData.lejosOiEsf !== '') ||
    (rxData.lejosOiCil && rxData.lejosOiCil !== '') ||
    (rxData.lejosOiEje && rxData.lejosOiEje !== '') ||
    (rxData.medLejosEsfOD && rxData.medLejosEsfOD !== '') ||
    (rxData.medLejosCilOD && rxData.medLejosCilOD !== '') ||
    (rxData.medLejosEjeOD && rxData.medLejosEjeOD !== '') ||
    (rxData.medLejosEsfOI && rxData.medLejosEsfOI !== '') ||
    (rxData.medLejosCilOI && rxData.medLejosCilOI !== '') ||
    (rxData.medLejosEjeOI && rxData.medLejosEjeOI !== '') ||
    (rxData.rxDistEsfOD && rxData.rxDistEsfOD !== '') ||
    (rxData.rxDistCilOD && rxData.rxDistCilOD !== '') ||
    (rxData.rxDistEjeOD && rxData.rxDistEjeOD !== '') ||
    (rxData.rxDistEsfOI && rxData.rxDistEsfOI !== '') ||
    (rxData.rxDistCilOI && rxData.rxDistCilOI !== '') ||
    (rxData.rxDistEjeOI && rxData.rxDistEjeOI !== '') ||
    // Tambi√©n verificar DIP y AV
    (rxData.rxDistDipOD && rxData.rxDistDipOD !== '') ||
    (rxData.rxDistDipOI && rxData.rxDistDipOI !== '') ||
    (rxData.avDistOD && rxData.avDistOD !== '') ||
    (rxData.avDistOI && rxData.avDistOI !== '');

  console.log('üîç Detecci√≥n LEJOS:', tieneDatosLejos);
  console.log('üìä Campos disponibles en rxData:', Object.keys(rxData));

  if (tieneDatosLejos) {
    contenidoHTML += `
      <div class="rx-table-container">
        <h3 class="rx-table-title">üëì VISI√ìN DE DISTANCIA (LEJOS)</h3>
        <table class="rx-data-table">
          <thead>
            <tr>
              <th></th>
              <th>ESF</th>
              <th>CIL</th>
              <th>EJE</th>
              <th>DIP</th>
              <th>A.V.</th>
              <th>ADD</th>
              <th>PRISMA</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>O.D.</td>
              <td>${rxData.lejosOdEsf || rxData.medLejosEsfOD || rxData.rxDistEsfOD || '-'}</td>
              <td>${rxData.lejosOdCil || rxData.medLejosCilOD || rxData.rxDistCilOD || '-'}</td>
              <td>${rxData.lejosOdEje || rxData.medLejosEjeOD || rxData.rxDistEjeOD || '-'}</td>
              <td rowspan="2" style="vertical-align: middle; font-size: 18px; font-weight: 900; color: #1e40af;">
                ${rxData.lejosDip || rxData.medLejosDip || rxData.rxDistDipOD || '-'}
              </td>
              <td>${rxData.lejosOdAv || rxData.medLejosAvOD || '-'}</td>
              <td>${rxData.lejosOdAdd || '-'}</td>
              <td>${rxData.lejosOdPrisma || '-'}</td>
            </tr>
            <tr>
              <td>O.I.</td>
              <td>${rxData.lejosOiEsf || rxData.medLejosEsfOI || rxData.rxDistEsfOI || '-'}</td>
              <td>${rxData.lejosOiCil || rxData.medLejosCilOI || rxData.rxDistCilOI || '-'}</td>
              <td>${rxData.lejosOiEje || rxData.medLejosEjeOI || rxData.rxDistEjeOI || '-'}</td>
              <td>${rxData.lejosOiAv || rxData.medLejosAvOI || '-'}</td>
              <td>${rxData.lejosOiAdd || '-'}</td>
              <td>${rxData.lejosOiPrisma || '-'}</td>
            </tr>
          </tbody>
        </table>
      </div>
    `;
  }

  // ========================================
  // TABLA DE CERCA (VISI√ìN CERCANA)
  // ========================================
  // Verificar si existen datos de cerca (ignorar strings vac√≠as)
  const tieneDatosCerca =
    (rxData.cercaOdEsf && rxData.cercaOdEsf !== '') ||
    (rxData.cercaOdCil && rxData.cercaOdCil !== '') ||
    (rxData.cercaOdEje && rxData.cercaOdEje !== '') ||
    (rxData.cercaOiEsf && rxData.cercaOiEsf !== '') ||
    (rxData.cercaOiCil && rxData.cercaOiCil !== '') ||
    (rxData.cercaOiEje && rxData.cercaOiEje !== '') ||
    (rxData.medCercaEsfOD && rxData.medCercaEsfOD !== '') ||
    (rxData.medCercaCilOD && rxData.medCercaCilOD !== '') ||
    (rxData.medCercaEjeOD && rxData.medCercaEjeOD !== '') ||
    (rxData.medCercaEsfOI && rxData.medCercaEsfOI !== '') ||
    (rxData.medCercaCilOI && rxData.medCercaCilOI !== '') ||
    (rxData.medCercaEjeOI && rxData.medCercaEjeOI !== '') ||
    (rxData.rxCercaEsfOD && rxData.rxCercaEsfOD !== '') ||
    (rxData.rxCercaCilOD && rxData.rxCercaCilOD !== '') ||
    (rxData.rxCercaEjeOD && rxData.rxCercaEjeOD !== '') ||
    (rxData.rxCercaEsfOI && rxData.rxCercaEsfOI !== '') ||
    (rxData.rxCercaCilOI && rxData.rxCercaCilOI !== '') ||
    (rxData.rxCercaEjeOI && rxData.rxCercaEjeOI !== '') ||
    // Tambi√©n verificar DIP y AV
    (rxData.rxCercaDipOD && rxData.rxCercaDipOD !== '') ||
    (rxData.rxCercaDipOI && rxData.rxCercaDipOI !== '') ||
    (rxData.avCercaOD && rxData.avCercaOD !== '') ||
    (rxData.avCercaOI && rxData.avCercaOI !== '');

  console.log('üîç Detecci√≥n CERCA:', tieneDatosCerca);

  if (tieneDatosCerca) {
    contenidoHTML += `
      <div class="rx-table-container">
        <h3 class="rx-table-title">üìñ VISI√ìN DE CERCA</h3>
        <table class="rx-data-table">
          <thead>
            <tr>
              <th></th>
              <th>ESF</th>
              <th>CIL</th>
              <th>EJE</th>
              <th>DIP</th>
              <th>A.V.</th>
              <th>ALTURA</th>
              <th>PRISMA</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>O.D.</td>
              <td>${rxData.cercaOdEsf || rxData.medCercaEsfOD || rxData.rxCercaEsfOD || '-'}</td>
              <td>${rxData.cercaOdCil || rxData.medCercaCilOD || rxData.rxCercaCilOD || '-'}</td>
              <td>${rxData.cercaOdEje || rxData.medCercaEjeOD || rxData.rxCercaEjeOD || '-'}</td>
              <td rowspan="2" style="vertical-align: middle; font-size: 18px; font-weight: 900; color: #1e40af;">
                ${rxData.cercaDip || rxData.medCercaDip || rxData.rxCercaDipOD || '-'}
              </td>
              <td>${rxData.cercaOdAv || rxData.medCercaAvOD || '-'}</td>
              <td rowspan="2" style="vertical-align: middle; font-size: 18px; font-weight: 900; color: #1e40af;">
                ${rxData.cercaAltura || '-'}
              </td>
              <td>${rxData.cercaOdPrisma || '-'}</td>
            </tr>
            <tr>
              <td>O.I.</td>
              <td>${rxData.cercaOiEsf || rxData.medCercaEsfOI || rxData.rxCercaEsfOI || '-'}</td>
              <td>${rxData.cercaOiCil || rxData.medCercaCilOI || rxData.rxCercaCilOI || '-'}</td>
              <td>${rxData.cercaOiEje || rxData.medCercaEjeOI || rxData.rxCercaEjeOI || '-'}</td>
              <td>${rxData.cercaOiAv || rxData.medCercaAvOI || '-'}</td>
              <td>${rxData.cercaOiPrisma || '-'}</td>
            </tr>
          </tbody>
        </table>
      </div>
    `;
  }

  // ========================================
  // TABLA DE LENTES DE CONTACTO (si existe)
  // ========================================
  const tieneDatosLC = rxData.lcOdH || rxData.lcOdV || rxData.lcOdPoder ||
                       rxData.lcOiH || rxData.lcOiV || rxData.lcOiPoder;

  if (tieneDatosLC) {
    contenidoHTML += `
      <div class="rx-table-container">
        <h3 class="rx-table-title">üëÅÔ∏è LENTES DE CONTACTO</h3>
        <table class="rx-data-table">
          <thead>
            <tr>
              <th></th>
              <th>K.H.</th>
              <th>K.V.</th>
              <th>EJE</th>
              <th>CB</th>
              <th>PODER</th>
              <th>DI√ÅMETRO</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>O.D.</td>
              <td>${rxData.lcOdH || '-'}</td>
              <td>${rxData.lcOdV || '-'}</td>
              <td>${rxData.lcOdEje || '-'}</td>
              <td>${rxData.lcOdCb || '-'}</td>
              <td>${rxData.lcOdPoder || '-'}</td>
              <td>${rxData.lcOdDiametro || '-'}</td>
            </tr>
            <tr>
              <td>O.I.</td>
              <td>${rxData.lcOiH || '-'}</td>
              <td>${rxData.lcOiV || '-'}</td>
              <td>${rxData.lcOiEje || '-'}</td>
              <td>${rxData.lcOiCb || '-'}</td>
              <td>${rxData.lcOiPoder || '-'}</td>
              <td>${rxData.lcOiDiametro || '-'}</td>
            </tr>
          </tbody>
        </table>
        ${rxData.lcTipoLente ? `<p style="margin-top: 12px; color: #1e40af; font-weight: 600;"><strong>Tipo de Lente:</strong> ${rxData.lcTipoLente}</p>` : ''}
      </div>
    `;
  }

  // ========================================
  // SECCI√ìN DE DIAGN√ìSTICO
  // ========================================
  let diagnosticos = [];

  // Detectar diagn√≥sticos comunes basados en los datos
  const esfOD = parseFloat(rxData.lejosOdEsf || rxData.medLejosEsfOD || 0);
  const esfOI = parseFloat(rxData.lejosOiEsf || rxData.medLejosEsfOI || 0);
  const cilOD = parseFloat(rxData.lejosOdCil || rxData.medLejosCilOD || 0);
  const cilOI = parseFloat(rxData.lejosOiCil || rxData.medLejosCilOI || 0);

  if (esfOD < 0 || esfOI < 0) {
    diagnosticos.push('MIOP√çA');
  }
  if (esfOD > 0 || esfOI > 0) {
    diagnosticos.push('HIPERMETROP√çA');
  }
  if (cilOD !== 0 || cilOI !== 0) {
    diagnosticos.push('ASTIGMATISMO');
  }
  if (rxData.lejosOdAdd || rxData.lejosOiAdd) {
    diagnosticos.push('PRESBICIA');
  }

  // Agregar diagn√≥stico del campo oftCie10 si existe
  if (rxData.oftCie10) {
    diagnosticos.push(rxData.oftCie10.toUpperCase());
  }

  // Agregar diagn√≥stico del campo tratamiento si existe
  if (rxData.oftTratamiento) {
    diagnosticos.push(rxData.oftTratamiento.toUpperCase());
  }

  if (diagnosticos.length > 0 || rxData.rxObservacion) {
    contenidoHTML += `
      <div class="rx-diagnostico-box">
        <h3 class="rx-diagnostico-title">
          <span style="font-size: 28px;">ü©∫</span>
          DIAGN√ìSTICO Y OBSERVACIONES
        </h3>
        <div class="rx-diagnostico-content">
          ${diagnosticos.length > 0 ? `
            <p style="margin-bottom: 12px;">
              <strong>Condiciones detectadas:</strong><br>
              ${diagnosticos.map(d => `<span style="display: inline-block; background: #059669; color: white; padding: 4px 12px; border-radius: 8px; margin: 4px 4px 0 0; font-size: 14px;">${d}</span>`).join('')}
            </p>
          ` : ''}
          ${rxData.rxObservacion ? `
            <p style="margin-top: 12px;">
              <strong>Observaciones:</strong><br>
              ${rxData.rxObservacion}
            </p>
          ` : ''}
          ${rxData.oftTratamiento && !diagnosticos.includes(rxData.oftTratamiento.toUpperCase()) ? `
            <p style="margin-top: 12px;">
              <strong>Tratamiento:</strong><br>
              ${rxData.oftTratamiento}
            </p>
          ` : ''}
        </div>
      </div>
    `;
  }

  // ========================================
  // INFORMACI√ìN ADICIONAL
  // ========================================
  const infoAdicional = [];

  if (rxData.especialista || rxData.rxEspecialista) {
    infoAdicional.push(`<strong>Especialista:</strong> ${rxData.especialista || rxData.rxEspecialista}`);
  }
  if (rxData.tipo || rxData.rxTipo) {
    infoAdicional.push(`<strong>Tipo:</strong> ${rxData.tipo || rxData.rxTipo}`);
  }
  if (rxData.proximaCita || rxData.rxProximaCita) {
    infoAdicional.push(`<strong>Pr√≥xima Cita:</strong> ${formatDate(rxData.proximaCita || rxData.rxProximaCita)}`);
  }

  if (infoAdicional.length > 0) {
    contenidoHTML += `
      <div style="background: linear-gradient(135deg, #eff6ff, #dbeafe); padding: 16px; border-radius: 12px; margin-top: 20px; border-left: 4px solid #3b82f6;">
        <p style="margin: 0; color: #1e40af; font-size: 14px; line-height: 1.8;">
          ${infoAdicional.join(' &nbsp;|&nbsp; ')}
        </p>
      </div>
    `;
  }

  // MOSTRAR SIEMPRE las tablas - Si no hay datos espec√≠ficos, mostrar estructura vac√≠a
  // Esto es mejor UX: el usuario ve qu√© campos existen
  if (!tieneDatosLejos && !tieneDatosCerca && !tieneDatosLC) {
    console.log('‚ö†Ô∏è No se detectaron datos llenos, pero mostrando estructura de tablas');
    // Agregar tablas vac√≠as para LEJOS
    contenidoHTML += `
      <div class="rx-table-container">
        <h3 class="rx-table-title">üëì VISI√ìN DE DISTANCIA (LEJOS)</h3>
        <table class="rx-data-table">
          <thead>
            <tr>
              <th></th>
              <th>ESF</th>
              <th>CIL</th>
              <th>EJE</th>
              <th>DIP</th>
              <th>A.V.</th>
              <th>ADD</th>
              <th>PRISMA</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>O.D.</td>
              <td>-</td>
              <td>-</td>
              <td>-</td>
              <td rowspan="2" style="vertical-align: middle;">-</td>
              <td>-</td>
              <td>-</td>
              <td>-</td>
            </tr>
            <tr>
              <td>O.I.</td>
              <td>-</td>
              <td>-</td>
              <td>-</td>
              <td>-</td>
              <td>-</td>
              <td>-</td>
            </tr>
          </tbody>
        </table>
      </div>
    `;
    // Agregar tablas vac√≠as para CERCA
    contenidoHTML += `
      <div class="rx-table-container">
        <h3 class="rx-table-title">üìñ VISI√ìN DE CERCA</h3>
        <table class="rx-data-table">
          <thead>
            <tr>
              <th></th>
              <th>ESF</th>
              <th>CIL</th>
              <th>EJE</th>
              <th>DIP</th>
              <th>A.V.</th>
              <th>ALTURA</th>
              <th>PRISMA</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>O.D.</td>
              <td>-</td>
              <td>-</td>
              <td>-</td>
              <td rowspan="2" style="vertical-align: middle;">-</td>
              <td>-</td>
              <td rowspan="2" style="vertical-align: middle;">-</td>
              <td>-</td>
            </tr>
            <tr>
              <td>O.I.</td>
              <td>-</td>
              <td>-</td>
              <td>-</td>
              <td>-</td>
              <td>-</td>
            </tr>
          </tbody>
        </table>
      </div>
    `;
  }

  console.log('‚úÖ Contenido HTML generado correctamente');

  console.log('üìÑ Longitud del contenido HTML:', contenidoHTML.length, 'caracteres');

  // Insertar contenido en el modal
  document.getElementById('modalRxContenido').innerHTML = contenidoHTML;

  // Resetear pesta√±a activa a "actual"
  tabRxActiva = 'actual';
  document.getElementById('tabRxActual').style.background = 'linear-gradient(135deg, #3b82f6, #2563eb)';
  document.getElementById('tabRxActual').style.color = 'white';
  document.getElementById('tabRxHistorial').style.background = 'white';
  document.getElementById('tabRxHistorial').style.color = '#6b7280';

  // Mostrar modal con animaci√≥n
  document.getElementById('modalVisualizacionRX').style.display = 'flex';

  console.log('‚úÖ Modal RX abierto exitosamente');
  toast('üëì Prescripci√≥n cargada', 'success');
}

// Funci√≥n para mostrar solo la RX actual (se llama desde cambiarTabRX)
function mostrarRxActual() {
  if (!rxActualModal) {
    document.getElementById('modalRxContenido').innerHTML = '<p style="text-align: center; padding: 40px; color: #6b7280;">No hay datos para mostrar</p>';
    return;
  }

  // Usar la misma l√≥gica que ya existe en verRxClienteModal
  // para generar el contenido de la RX actual
  const rxData = rxActualModal;
  let contenidoHTML = '';

  // Helper function: verificar si un valor es v√°lido
  const esValido = (val) => val !== undefined && val !== null && val !== '' && val !== 'undefined';

  // TABLA DE DISTANCIA (VISI√ìN DE LEJOS)
  const tieneDatosLejos =
    esValido(rxData.lejosOdEsf) || esValido(rxData.lejosOdCil) || esValido(rxData.lejosOdEje) ||
    esValido(rxData.lejosOiEsf) || esValido(rxData.lejosOiCil) || esValido(rxData.lejosOiEje) ||
    esValido(rxData.medLejosEsfOD) || esValido(rxData.medLejosCilOD) || esValido(rxData.medLejosEjeOD) ||
    esValido(rxData.medLejosEsfOI) || esValido(rxData.medLejosCilOI) || esValido(rxData.medLejosEjeOI) ||
    esValido(rxData.rxDistEsfOD) || esValido(rxData.rxDistCilOD) || esValido(rxData.rxDistEjeOD) ||
    esValido(rxData.rxDistEsfOI) || esValido(rxData.rxDistCilOI) || esValido(rxData.rxDistEjeOI) ||
    esValido(rxData.rxDistDipOD) || esValido(rxData.rxDistDipOI) ||
    esValido(rxData.avDistOD) || esValido(rxData.avDistOI);

  // Generar el mismo contenido que se genera en verRxClienteModal
  // (copiar la l√≥gica de generaci√≥n de tablas)
  verRxClienteModal(clienteRxActual.id); // Regenerar el contenido
}

// Funci√≥n para mostrar el historial completo de prescripciones
function mostrarHistorialRx() {
  if (!todasLasRxCliente || todasLasRxCliente.length === 0) {
    document.getElementById('modalRxContenido').innerHTML = `
      <div style="text-align: center; padding: 60px 20px; color: #64748b;">
        <div style="font-size: 72px; margin-bottom: 20px;">üìö</div>
        <h3 style="color: #475569; margin-bottom: 12px;">Sin historial de prescripciones</h3>
        <p>Este cliente no tiene prescripciones anteriores registradas.</p>
      </div>
    `;
    return;
  }

  let contenidoHTML = `
    <div style="padding: 20px;">
      <h3 style="color: #1e40af; margin-bottom: 20px; font-size: 20px; font-weight: 800;">
        üìö HISTORIAL COMPLETO DE PRESCRIPCIONES (${todasLasRxCliente.length})
      </h3>
  `;

  // Generar una tarjeta por cada prescripci√≥n
  todasLasRxCliente.forEach((rx, index) => {
    const esReciente = index === 0;
    const fecha = formatDate(rx.fecha) || 'Sin fecha';
    const fuente = rx.fuente || 'DESCONOCIDO';

    // Extraer datos de lejos
    const lejosOD = {
      esf: rx.lejosOdEsf || rx.medLejosEsfOD || rx.rxDistEsfOD || '-',
      cil: rx.lejosOdCil || rx.medLejosCilOD || rx.rxDistCilOD || '-',
      eje: rx.lejosOdEje || rx.medLejosEjeOD || rx.rxDistEjeOD || '-'
    };
    const lejosOI = {
      esf: rx.lejosOiEsf || rx.medLejosEsfOI || rx.rxDistEsfOI || '-',
      cil: rx.lejosOiCil || rx.medLejosCilOI || rx.rxDistCilOI || '-',
      eje: rx.lejosOiEje || rx.medLejosEjeOI || rx.rxDistEjeOI || '-'
    };

    // Extraer datos de cerca
    const cercaOD = {
      esf: rx.cercaOdEsf || rx.medCercaEsfOD || rx.rxCercaEsfOD || '-',
      cil: rx.cercaOdCil || rx.medCercaCilOD || rx.rxCercaCilOD || '-',
      eje: rx.cercaOdEje || rx.medCercaEjeOD || rx.rxCercaEjeOD || '-'
    };
    const cercaOI = {
      esf: rx.cercaOiEsf || rx.medCercaEsfOI || rx.rxCercaEsfOI || '-',
      cil: rx.cercaOiCil || rx.medCercaCilOI || rx.rxCercaCilOI || '-',
      eje: rx.cercaOiEje || rx.medCercaEjeOI || rx.rxCercaEjeOI || '-'
    };

    const borderColor = esReciente ? '#10b981' : '#cbd5e1';
    const bgColor = esReciente ? '#f0fdf4' : '#f9fafb';
    const badge = esReciente ? '<span style="background: #10b981; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 700; margin-left: 10px;">M√ÅS RECIENTE</span>' : '';

    contenidoHTML += `
      <div style="border: 3px solid ${borderColor}; border-radius: 12px; padding: 20px; margin-bottom: 20px; background: ${bgColor};">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
          <h4 style="color: #1e40af; font-size: 16px; font-weight: 700; margin: 0;">
            ${index + 1}. Prescripci√≥n del ${fecha} ${badge}
          </h4>
          <span style="background: #3b82f6; color: white; padding: 6px 14px; border-radius: 8px; font-size: 12px; font-weight: 700;">
            ${fuente}
          </span>
        </div>

        <!-- Tabla de LEJOS -->
        <div style="margin-bottom: 16px;">
          <h5 style="color: #475569; font-size: 14px; font-weight: 700; margin-bottom: 8px;">üìè VISI√ìN DE DISTANCIA</h5>
          <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
            <thead>
              <tr style="background: #e0e7ff;">
                <th style="padding: 8px; border: 1px solid #cbd5e1; text-align: center;"></th>
                <th style="padding: 8px; border: 1px solid #cbd5e1; text-align: center; font-weight: 700;">ESF</th>
                <th style="padding: 8px; border: 1px solid #cbd5e1; text-align: center; font-weight: 700;">CIL</th>
                <th style="padding: 8px; border: 1px solid #cbd5e1; text-align: center; font-weight: 700;">EJE</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td style="padding: 8px; border: 1px solid #cbd5e1; font-weight: 700; text-align: center; background: #f3f4f6;">O.D.</td>
                <td style="padding: 8px; border: 1px solid #cbd5e1; text-align: center;">${lejosOD.esf}</td>
                <td style="padding: 8px; border: 1px solid #cbd5e1; text-align: center;">${lejosOD.cil}</td>
                <td style="padding: 8px; border: 1px solid #cbd5e1; text-align: center;">${lejosOD.eje}</td>
              </tr>
              <tr>
                <td style="padding: 8px; border: 1px solid #cbd5e1; font-weight: 700; text-align: center; background: #f3f4f6;">O.I.</td>
                <td style="padding: 8px; border: 1px solid #cbd5e1; text-align: center;">${lejosOI.esf}</td>
                <td style="padding: 8px; border: 1px solid #cbd5e1; text-align: center;">${lejosOI.cil}</td>
                <td style="padding: 8px; border: 1px solid #cbd5e1; text-align: center;">${lejosOI.eje}</td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Tabla de CERCA -->
        <div>
          <h5 style="color: #475569; font-size: 14px; font-weight: 700; margin-bottom: 8px;">üìñ VISI√ìN DE CERCA</h5>
          <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
            <thead>
              <tr style="background: #fce7f3;">
                <th style="padding: 8px; border: 1px solid #cbd5e1; text-align: center;"></th>
                <th style="padding: 8px; border: 1px solid #cbd5e1; text-align: center; font-weight: 700;">ESF</th>
                <th style="padding: 8px; border: 1px solid #cbd5e1; text-align: center; font-weight: 700;">CIL</th>
                <th style="padding: 8px; border: 1px solid #cbd5e1; text-align: center; font-weight: 700;">EJE</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td style="padding: 8px; border: 1px solid #cbd5e1; font-weight: 700; text-align: center; background: #f3f4f6;">O.D.</td>
                <td style="padding: 8px; border: 1px solid #cbd5e1; text-align: center;">${cercaOD.esf}</td>
                <td style="padding: 8px; border: 1px solid #cbd5e1; text-align: center;">${cercaOD.cil}</td>
                <td style="padding: 8px; border: 1px solid #cbd5e1; text-align: center;">${cercaOD.eje}</td>
              </tr>
              <tr>
                <td style="padding: 8px; border: 1px solid #cbd5e1; font-weight: 700; text-align: center; background: #f3f4f6;">O.I.</td>
                <td style="padding: 8px; border: 1px solid #cbd5e1; text-align: center;">${cercaOI.esf}</td>
                <td style="padding: 8px; border: 1px solid #cbd5e1; text-align: center;">${cercaOI.cil}</td>
                <td style="padding: 8px; border: 1px solid #cbd5e1; text-align: center;">${cercaOI.eje}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    `;
  });

  contenidoHTML += '</div>';

  // Actualizar contenido del modal
  document.getElementById('modalRxContenido').innerHTML = contenidoHTML;
}

// Cerrar modal RX
function cerrarModalRX() {
  document.getElementById('modalVisualizacionRX').style.display = 'none';
  rxActualModal = null;
}

// Imprimir RX actual
// ‚ú® NUEVA FUNCI√ìN DE IMPRESI√ìN RX ACTUAL CON DISE√ëO ULTRA MODERNO ‚ú®
function imprimirRxActual() {
  if (!rxActualModal) {
    toast('‚ö†Ô∏è No hay prescripci√≥n seleccionada', 'warning');
    return;
  }

  // Preparar datos en el formato que espera imprimirPrescripcionUnificada
  const datosImpresion = {
    // Informaci√≥n del paciente
    nombreCliente: rxActualModal.clienteNombre || 'Paciente',
    dniCliente: rxActualModal.clienteDni || '',
    edad: rxActualModal.edad || '',
    fechaFormato: formatDate(rxActualModal.fecha) || formatDate(today()),
    fecha: rxActualModal.fecha || today(),

    // DISTANCIA (LEJOS) - Soportar m√∫ltiples formatos de campo
    rxDistEsfOD: rxActualModal.lejosOdEsf || rxActualModal.medLejosEsfOD || rxActualModal.rxDistEsfOD || '',
    rxDistCilOD: rxActualModal.lejosOdCil || rxActualModal.medLejosCilOD || rxActualModal.rxDistCilOD || '',
    rxDistEjeOD: rxActualModal.lejosOdEje || rxActualModal.medLejosEjeOD || rxActualModal.rxDistEjeOD || '',
    rxDistDipOD: rxActualModal.lejosDip || rxActualModal.medLejosDip || rxActualModal.rxDistDipOD || '',

    rxDistEsfOI: rxActualModal.lejosOiEsf || rxActualModal.medLejosEsfOI || rxActualModal.rxDistEsfOI || '',
    rxDistCilOI: rxActualModal.lejosOiCil || rxActualModal.medLejosCilOI || rxActualModal.rxDistCilOI || '',
    rxDistEjeOI: rxActualModal.lejosOiEje || rxActualModal.medLejosEjeOI || rxActualModal.rxDistEjeOI || '',
    rxDistDipOI: '',

    // CERCA - Soportar m√∫ltiples formatos de campo
    rxCercaEsfOD: rxActualModal.cercaOdEsf || rxActualModal.medCercaEsfOD || rxActualModal.rxCercaEsfOD || '',
    rxCercaCilOD: rxActualModal.cercaOdCil || rxActualModal.medCercaCilOD || rxActualModal.rxCercaCilOD || '',
    rxCercaEjeOD: rxActualModal.cercaOdEje || rxActualModal.medCercaEjeOD || rxActualModal.rxCercaEjeOD || '',
    rxCercaDipOD: rxActualModal.cercaDip || rxActualModal.medCercaDip || rxActualModal.rxCercaDipOD || '',

    rxCercaEsfOI: rxActualModal.cercaOiEsf || rxActualModal.medCercaEsfOI || rxActualModal.rxCercaEsfOI || '',
    rxCercaCilOI: rxActualModal.cercaOiCil || rxActualModal.medCercaCilOI || rxActualModal.rxCercaCilOI || '',
    rxCercaEjeOI: rxActualModal.cercaOiEje || rxActualModal.medCercaEjeOI || rxActualModal.rxCercaEjeOI || '',
    rxCercaDipOI: '',

    // PIO (Presi√≥n Intraocular) - Soportar m√∫ltiples formatos de campo
    rxPioOD: rxActualModal.oftTonoOd || rxActualModal.pioOD || rxActualModal.rxPioOD || '',
    rxPioOI: rxActualModal.oftTonoOi || rxActualModal.pioOI || rxActualModal.rxPioOI || '',

    // DIAGN√ìSTICO - Soportar m√∫ltiples formatos de campo
    diagMiopia: rxActualModal.diagMiopia || false,
    diagHipermetropia: rxActualModal.diagHipermetropia || false,
    diagAstigmatismo: rxActualModal.diagAstigmatismo || false,
    diagPresbicia: rxActualModal.diagPresbicia || false,
    diagAmbliopia: rxActualModal.diagAmbliopia || false,
    diagAnisometropia: rxActualModal.diagAnisometropia || false,

    // OTROS DATOS
    rxObservaciones: rxActualModal.rxObservaciones || rxActualModal.observaciones || '',
    rxEspecialista: rxActualModal.rxEspecialista || rxActualModal.especialista || '',
    proximoControl: rxActualModal.proximoControl || rxActualModal.proximaCita || ''
  };

  // Usar la funci√≥n unificada de impresi√≥n profesional
  imprimirPrescripcionUnificada(datosImpresion, 'CONSULTA');
}

// Imprimir Historial Cl√≠nico Completo (Anamnesis + RX + Tratamiento)
function imprimirHistorialClinicoCompleto() {
  if (!rxActualModal) {
    toast('‚ö†Ô∏è No hay datos para imprimir', 'warning');
    return;
  }

  // Obtener cliente
  const clienteId = rxActualModal.idCliente || rxActualModal.clienteId;
  const clientes = load(DB.CLIENTES);
  const cliente = clientes.find(c => c.id === clienteId);

  if (!cliente) {
    toast('‚ùå Cliente no encontrado', 'error');
    return;
  }

  const nombreCompleto = `${cliente.nombres || cliente.nombre || ''} ${cliente.apellidos || cliente.apellido || ''}`.trim();
  const documento = cliente.documento || cliente.dni || 'Sin DNI';
  const edad = cliente.fechaNacimiento ? calcularEdad(cliente.fechaNacimiento) : '-';
  const telefono = cliente.telefono || '-';

  // Preparar datos de prescripci√≥n
  const distEsfOD = rxActualModal.lejosOdEsf || rxActualModal.medLejosEsfOD || rxActualModal.rxDistEsfOD || '-';
  const distCilOD = rxActualModal.lejosOdCil || rxActualModal.medLejosCilOD || rxActualModal.rxDistCilOD || '-';
  const distEjeOD = rxActualModal.lejosOdEje || rxActualModal.medLejosEjeOD || rxActualModal.rxDistEjeOD || '-';
  const distDip = rxActualModal.lejosDip || rxActualModal.medLejosDip || rxActualModal.rxDistDipOD || '-';

  const distEsfOI = rxActualModal.lejosOiEsf || rxActualModal.medLejosEsfOI || rxActualModal.rxDistEsfOI || '-';
  const distCilOI = rxActualModal.lejosOiCil || rxActualModal.medLejosCilOI || rxActualModal.rxDistCilOI || '-';
  const distEjeOI = rxActualModal.lejosOiEje || rxActualModal.medLejosEjeOI || rxActualModal.rxDistEjeOI || '-';

  const cercaEsfOD = rxActualModal.cercaOdEsf || rxActualModal.medCercaEsfOD || rxActualModal.rxCercaEsfOD || '-';
  const cercaCilOD = rxActualModal.cercaOdCil || rxActualModal.medCercaCilOD || rxActualModal.rxCercaCilOD || '-';
  const cercaEjeOD = rxActualModal.cercaOdEje || rxActualModal.medCercaEjeOD || rxActualModal.rxCercaEjeOD || '-';
  const cercaDip = rxActualModal.cercaDip || rxActualModal.medCercaDip || rxActualModal.rxCercaDipOD || '-';

  const cercaEsfOI = rxActualModal.cercaOiEsf || rxActualModal.medCercaEsfOI || rxActualModal.rxCercaEsfOI || '-';
  const cercaCilOI = rxActualModal.cercaOiCil || rxActualModal.medCercaCilOI || rxActualModal.rxCercaCilOI || '-';
  const cercaEjeOI = rxActualModal.cercaOiEje || rxActualModal.medCercaEjeOI || rxActualModal.rxCercaEjeOI || '-';

  // Datos del historial cl√≠nico
  const antecedentesOculares = rxActualModal.histAntecedentesOculares || '-';
  const antecedentesMedicos = rxActualModal.histAntecedentesMedicos || '-';
  const medicamentos = rxActualModal.histMedicamentos || '-';
  const antecedentesFamiliares = rxActualModal.histAntecedentesFamiliares || '-';
  const tratamiento = rxActualModal.oftalmTratamiento || '-';
  const recomendaciones = rxActualModal.oftalmRecomendaciones || '-';
  const proximoControl = rxActualModal.oftalmProximoControl ? formatDate(rxActualModal.oftalmProximoControl) : '-';
  const indicacionesVenta = rxActualModal.oftalmIndicacionesVenta || '-';

  // Diagn√≥sticos
  const diagnosticos = [];
  if (rxActualModal.diagMiopia) diagnosticos.push('Miop√≠a');
  if (rxActualModal.diagHipermetropia) diagnosticos.push('Hipermetrop√≠a');
  if (rxActualModal.diagAstigmatismo) diagnosticos.push('Astigmatismo');
  if (rxActualModal.diagPresbicia) diagnosticos.push('Presbicia');
  if (rxActualModal.diagAmbliopia) diagnosticos.push('Ambliop√≠a');
  if (rxActualModal.diagAnisometropia) diagnosticos.push('Anisometrop√≠a');
  const diagnosticoTexto = diagnosticos.length > 0 ? diagnosticos.join(', ') : 'Sin diagn√≥stico espec√≠fico';

  const observaciones = rxActualModal.rxObservaciones || rxActualModal.observaciones || '-';
  const especialista = rxActualModal.rxEspecialista || rxActualModal.especialista || 'No especificado';
  const fecha = formatDate(rxActualModal.fecha) || today();
  const motivo = rxActualModal.motivo || 'No especificado';

  // Crear ventana de impresi√≥n
  const printWindow = window.open('', '', 'width=900,height=700');
  if (!printWindow) {
    alert('Por favor permite las ventanas emergentes para imprimir');
    return;
  }

  printWindow.document.write(`
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="UTF-8">
      <title>Historial Cl√≠nico - ${nombreCompleto}</title>
      <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
          font-family: 'Arial', sans-serif;
          padding: 20px;
          background: white;
          color: #1f2937;
        }
        @media print {
          @page { size: A4; margin: 15mm; }
          body { margin: 0; padding: 0; }
        }

        .header {
          text-align: center;
          border-bottom: 4px solid #7c3aed;
          padding-bottom: 15px;
          margin-bottom: 20px;
        }
        .header h1 {
          color: #7c3aed;
          font-size: 24px;
          margin-bottom: 5px;
        }
        .header h2 {
          color: #6b7280;
          font-size: 16px;
          font-weight: normal;
        }

        .patient-info {
          background: linear-gradient(135deg, #f3e8ff, #e9d5ff);
          padding: 15px;
          border-radius: 8px;
          margin-bottom: 20px;
          border: 2px solid #7c3aed;
        }
        .patient-info h3 {
          color: #7c3aed;
          margin-bottom: 10px;
          font-size: 18px;
        }
        .info-grid {
          display: grid;
          grid-template-columns: repeat(2, 1fr);
          gap: 10px;
        }
        .info-item {
          font-size: 13px;
        }
        .info-item strong {
          color: #374151;
        }

        .section {
          margin-bottom: 20px;
          page-break-inside: avoid;
        }
        .section-title {
          background: linear-gradient(135deg, #7c3aed, #6d28d9);
          color: white;
          padding: 10px 15px;
          border-radius: 6px;
          font-size: 15px;
          font-weight: bold;
          margin-bottom: 12px;
        }
        .section-content {
          padding: 12px;
          background: #f9fafb;
          border: 2px solid #e5e7eb;
          border-radius: 6px;
          font-size: 13px;
          line-height: 1.6;
        }

        table {
          width: 100%;
          border-collapse: collapse;
          margin: 10px 0;
        }
        table th {
          background: #374151;
          color: white;
          padding: 10px;
          text-align: center;
          font-size: 12px;
          border: 2px solid #1f2937;
        }
        table td {
          padding: 6px;
          border: 2px solid #d1d5db;
          text-align: center;
          font-weight: 600;
          font-size: 14px;
        }
        table td.label {
          background: #f3e8ff;
          color: #7c3aed;
          font-weight: 800;
        }

        .diagnostico-box {
          background: #fef3c7;
          border: 2px solid #f59e0b;
          padding: 12px;
          border-radius: 6px;
          margin: 10px 0;
        }
        .diagnostico-box strong {
          color: #92400e;
        }

        .footer {
          margin-top: 30px;
          padding-top: 15px;
          border-top: 2px solid #e5e7eb;
          text-align: center;
          font-size: 11px;
          color: #6b7280;
        }
      </style>
    </head>
    <body>
      <!-- ENCABEZADO -->
      <div class="header">
        <h1>üìã HISTORIAL CL√çNICO COMPLETO</h1>
        <h2>Centro √ìptico Sicuani - Examen Optom√©trico</h2>
      </div>

      <!-- INFORMACI√ìN DEL PACIENTE -->
      <div class="patient-info">
        <h3>üë§ DATOS DEL PACIENTE</h3>
        <div class="info-grid">
          <div class="info-item"><strong>Nombre:</strong> ${nombreCompleto}</div>
          <div class="info-item"><strong>DNI:</strong> ${documento}</div>
          <div class="info-item"><strong>Edad:</strong> ${edad} a√±os</div>
          <div class="info-item"><strong>Tel√©fono:</strong> ${telefono}</div>
          <div class="info-item"><strong>Fecha de consulta:</strong> ${fecha}</div>
          <div class="info-item"><strong>Especialista:</strong> ${especialista}</div>
        </div>
      </div>

      <!-- MOTIVO DE CONSULTA -->
      <div class="section">
        <div class="section-title">üí¨ MOTIVO DE CONSULTA</div>
        <div class="section-content">${motivo}</div>
      </div>

      <!-- ANAMNESIS -->
      <div class="section">
        <div class="section-title">üìã ANAMNESIS</div>
        <div class="section-content">
          <p><strong>Antecedentes Oculares:</strong> ${antecedentesOculares}</p>
          <p style="margin-top: 8px;"><strong>Antecedentes M√©dicos:</strong> ${antecedentesMedicos}</p>
          <p style="margin-top: 8px;"><strong>Medicamentos Actuales:</strong> ${medicamentos}</p>
          <p style="margin-top: 8px;"><strong>Antecedentes Familiares:</strong> ${antecedentesFamiliares}</p>
        </div>
      </div>

      <!-- PRESCRIPCI√ìN DE LENTES -->
      <div class="section">
        <div class="section-title">üëì PRESCRIPCI√ìN DE LENTES</div>

        <h4 style="margin: 15px 0 8px 0; color: #374151;">VISI√ìN DE DISTANCIA (LEJOS)</h4>
        <table>
          <thead>
            <tr>
              <th></th>
              <th>ESF</th>
              <th>CIL</th>
              <th>EJE</th>
              <th>DIP</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="label">O.D.</td>
              <td>${distEsfOD}</td>
              <td>${distCilOD}</td>
              <td>${distEjeOD}¬∞</td>
              <td rowspan="2" style="vertical-align: middle; font-size: 16px; font-weight: 900;">${distDip}</td>
            </tr>
            <tr>
              <td class="label">O.I.</td>
              <td>${distEsfOI}</td>
              <td>${distCilOI}</td>
              <td>${distEjeOI}¬∞</td>
            </tr>
          </tbody>
        </table>

        <h4 style="margin: 15px 0 8px 0; color: #374151;">VISI√ìN DE CERCA</h4>
        <table>
          <thead>
            <tr>
              <th></th>
              <th>ESF</th>
              <th>CIL</th>
              <th>EJE</th>
              <th>DIP</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="label">O.D.</td>
              <td>${cercaEsfOD}</td>
              <td>${cercaCilOD}</td>
              <td>${cercaEjeOD}¬∞</td>
              <td rowspan="2" style="vertical-align: middle; font-size: 16px; font-weight: 900;">${cercaDip}</td>
            </tr>
            <tr>
              <td class="label">O.I.</td>
              <td>${cercaEsfOI}</td>
              <td>${cercaCilOI}</td>
              <td>${cercaEjeOI}¬∞</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- DIAGN√ìSTICO -->
      <div class="section">
        <div class="section-title">üîç DIAGN√ìSTICO</div>
        <div class="diagnostico-box">
          <strong>Diagn√≥stico:</strong> ${diagnosticoTexto}
        </div>
        ${observaciones !== '-' ? `<div class="section-content" style="margin-top: 10px;"><strong>Observaciones:</strong> ${observaciones}</div>` : ''}
      </div>

      <!-- TRATAMIENTO Y RECOMENDACIONES -->
      <div class="section">
        <div class="section-title">üíä TRATAMIENTO Y RECOMENDACIONES</div>
        <div class="section-content">
          <p><strong>Plan de Tratamiento:</strong> ${tratamiento}</p>
          <p style="margin-top: 8px;"><strong>Recomendaciones:</strong> ${recomendaciones}</p>
          <p style="margin-top: 8px;"><strong>Pr√≥ximo Control:</strong> ${proximoControl}</p>
          <p style="margin-top: 8px;"><strong>Indicaciones para Venta:</strong> ${indicacionesVenta}</p>
        </div>
      </div>

      <!-- FOOTER -->
      <div class="footer">
        <p>Centro √ìptico Sicuani - Jr. Dos de Mayo N¬∞217 - Plaza de Armas, Sicuani - Canchis - Cusco</p>
        <p>Cel. 984 047 273</p>
        <p style="margin-top: 5px;">Documento generado el ${new Date().toLocaleDateString('es-PE')} a las ${new Date().toLocaleTimeString('es-PE')}</p>
      </div>
    </body>
    </html>
  `);

  printWindow.document.close();
  printWindow.focus();

  setTimeout(() => {
    printWindow.print();
  }, 500);

  toast('üìã Historial cl√≠nico listo para imprimir', 'success');
}

// Editar RX actual - VERSI√ìN MEJORADA CON ANIMACIONES
function editarRxActual() {
  if (!rxActualModal) {
    toast('‚ö†Ô∏è No hay prescripci√≥n seleccionada', 'warning');
    return;
  }

  // Buscar el ID del cliente desde rxActualModal
  const clienteId = rxActualModal.idCliente || rxActualModal.clienteId;

  if (!clienteId) {
    toast('‚ùå No se pudo determinar el cliente', 'error');
    return;
  }

  // ‚ú® ANIMACI√ìN DE CIERRE SUAVE DEL MODAL
  const modalRX = document.getElementById('modalVisualizacionRX');
  if (modalRX) {
    modalRX.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
    modalRX.style.opacity = '0';
    modalRX.style.transform = 'scale(0.95)';

    setTimeout(() => {
      cerrarModalRX();

      // Mostrar notificaci√≥n premium
      toast('‚úèÔ∏è Cargando prescripci√≥n para edici√≥n...', 'info');

      // ‚ú® ABRIR PRESCRIPCI√ìN CON DELAY PARA ANIMACI√ìN FLUIDA
      setTimeout(() => {
        abrirPrescripcion(clienteId, false);

        // ‚ú® NOTIFICACI√ìN DE √âXITO CON EFECTO
        setTimeout(() => {
          toast('‚úÖ Prescripci√≥n lista para editar', 'success');

          // ‚ú® FOCUS AUTOM√ÅTICO EN EL PRIMER CAMPO EDITABLE
          const primerCampo = document.querySelector('#lejosOdEsf, #rxDistEsfOD');
          if (primerCampo) {
            primerCampo.focus();
            primerCampo.style.animation = 'inputPulse 0.6s ease-out';
          }
        }, 400);
      }, 200);
    }, 300);
  } else {
    // Fallback sin modal
    cerrarModalRX();
    abrirPrescripcion(clienteId, false);
    toast('‚úèÔ∏è Prescripci√≥n lista para edici√≥n', 'success');
  }
}

// Guardar e imprimir consulta
function guardarEImprimirConsulta() {
  const consultaId = guardarConsultaClinica();

  // Si se guard√≥ exitosamente, imprimir
  if (consultaId) {
    setTimeout(() => {
      imprimirConsulta(consultaId);
    }, 500);
  }
}

// ============================================
// SISTEMA DE IMPRESI√ìN ULTRA PROFESIONAL V2.0
// Dise√±o basado en formato profesional de recetas m√©dicas
// Compatible con Consultorio y m√≥dulo de Prescripciones
// ============================================

function imprimirConsulta(idConsulta) {
  const consultas = load(DB.CONSULTAS_CLINICAS);
  const consulta = consultas.find(c => c.id === idConsulta);

  if (!consulta) {
    toast('‚ùå Consulta no encontrada', 'error');
    return;
  }

  imprimirPrescripcionUnificada(consulta, 'CONSULTA');
}

// Funci√≥n unificada para imprimir prescripciones (desde Consultorio o Medidas)
// ============================================
// NUEVA FUNCI√ìN DE IMPRESI√ìN: 2 PRESCRIPCIONES POR HOJA A4
// Optimizado para imprimir 2 recetas id√©nticas en media hoja cada una
// ============================================

// ============================================
// FUNCI√ìN DE IMPRESI√ìN HORIZONTAL: 2 PRESCRIPCIONES POR HOJA A4
// Dise√±o horizontal simple con paleta morada
// ============================================

function imprimirPrescripcionUnificada(datos, origen = 'CONSULTA') {
  const printWindow = window.open('', '', 'width=900,height=700');

  if (!printWindow) {
    toast('‚ùå No se pudo abrir la ventana de impresi√≥n. Desactiva el bloqueador de ventanas emergentes.', 'error');
    return;
  }

  // Configuraci√≥n din√°mica por establecimiento
  const establecimiento = sessionStorage.getItem('establecimiento') || establecimientoActual || 'DOS_DE_MAYO';

  const config = establecimiento === 'PLAZA_DE_ARMAS' ? {
    nombre: '√ìPTICA SICUANI',
    subtitulo: 'SERVICIO PROFESIONAL EN OPTOMETR√çA',
    descripcion: 'Examen Visual y Medida de Vista por Computadora',
    direccion: 'Jr. Garcilazo de la Vega N¬∫ 135 - Plaza de Armas',
    telefono: 'Cel. 984047273',
    colorPrimario: '#2563eb'  // Azul
  } : {
    nombre: 'CENTRO √ìPTICO SICUANI',
    subtitulo: 'SERVICIO PROFESIONAL EN OPTOMETR√çA',
    descripcion: 'Examen Visual y Medida de Vista por Computadora',
    direccion: 'Jr. Dos de Mayo 217',
    telefono: 'Cel. 984047273',
    colorPrimario: '#7c3aed'  // Morado
  };

  // Preparar datos
  const nombrePaciente = datos.nombreCliente || datos.paciente || 'Paciente';
  const dniPaciente = datos.dniCliente || datos.documento || '';
  const edadPaciente = datos.edad || '';
  const fechaConsulta = datos.fechaFormato || formatDate(datos.fecha) || formatDate(today());
  const proximoControl = datos.proximoControl || '';

  // Funci√≥n helper para generar UNA prescripci√≥n
  function generarPrescripcionHTML() {
    return `
    <div class="prescripcion-wrapper">
      <div class="prescripcion-flex">

        <!-- SIDEBAR VERTICAL IZQUIERDO -->
        <div class="sidebar-vertical">
          <div class="sidebar-content">
            <div class="sidebar-nombre">${config.nombre}</div>
            <div class="sidebar-subtitulo">${config.subtitulo}</div>
            <div class="sidebar-descripcion">${config.descripcion}</div>
            <div class="sidebar-adicional">ADAPTACI√ìN DE LENTES DE CONTACTO</div>
          </div>
        </div>

        <!-- CONTENIDO PRINCIPAL -->
        <div class="contenido-principal">

          <!-- HEADER HORIZONTAL -->
          <div class="header">
            <div class="empresa-contacto">${config.direccion} | ${config.telefono}</div>
          </div>

          <!-- INFO PACIENTE -->
          <div class="info-paciente">
            <div class="info-grid">
          <div class="info-item">
            <span class="label">Nombre:</span>
            <span class="value">${nombrePaciente}</span>
          </div>
          <div class="info-item">
            <span class="label">Fecha:</span>
            <span class="value">${fechaConsulta}</span>
          </div>
          <div class="info-item">
            <span class="label">Edad:</span>
            <span class="value">${edadPaciente}</span>
          </div>
          <div class="info-item">
            <span class="label">Control:</span>
            <span class="value">${proximoControl}</span>
          </div>
        </div>
      </div>

      <!-- PRESCRIPCI√ìN DE LENTES -->
      <div class="section-title">PRESCRIPCI√ìN DE LENTES</div>

      <!-- TABLA DISTANCIA -->
      <div class="subsection-title">DISTANCIA</div>
      <table>
        <tr>
          <th style="width: 60px;"></th>
          <th>ESF√âRICO</th>
          <th>CIL√çNDRICO</th>
          <th>EJE</th>
          <th>DIP</th>
        </tr>
        <tr>
          <td class="ojo-label">O.D.</td>
          <td>${datos.rxDistEsfOD || datos.lejosOdEsf || ''}</td>
          <td>${datos.rxDistCilOD || datos.lejosOdCil || ''}</td>
          <td>${datos.rxDistEjeOD || datos.lejosOdEje || ''}</td>
          <td>${datos.rxDistDipOD || datos.lejosDip || ''}</td>
        </tr>
        <tr>
          <td class="ojo-label">O.I.</td>
          <td>${datos.rxDistEsfOI || datos.lejosOiEsf || ''}</td>
          <td>${datos.rxDistCilOI || datos.lejosOiCil || ''}</td>
          <td>${datos.rxDistEjeOI || datos.lejosOiEje || ''}</td>
          <td>${datos.rxDistDipOI || ''}</td>
        </tr>
      </table>

      <!-- TABLA CERCA -->
      <div class="subsection-title">CERCA</div>
      <table>
        <tr>
          <th style="width: 60px;"></th>
          <th>ESF√âRICO</th>
          <th>CIL√çNDRICO</th>
          <th>EJE</th>
          <th>DIP</th>
        </tr>
        <tr>
          <td class="ojo-label">O.D.</td>
          <td>${datos.rxCercaEsfOD || datos.cercaOdEsf || ''}</td>
          <td>${datos.rxCercaCilOD || datos.cercaOdCil || ''}</td>
          <td>${datos.rxCercaEjeOD || datos.cercaOdEje || ''}</td>
          <td>${datos.rxCercaDipOD || datos.cercaDip || ''}</td>
        </tr>
        <tr>
          <td class="ojo-label">O.I.</td>
          <td>${datos.rxCercaEsfOI || datos.cercaOiEsf || ''}</td>
          <td>${datos.rxCercaCilOI || datos.cercaOiCil || ''}</td>
          <td>${datos.rxCercaEjeOI || datos.cercaOiEje || ''}</td>
          <td>${datos.rxCercaDipOI || ''}</td>
        </tr>
      </table>

      <!-- DIAGN√ìSTICO Y PIO -->
      <div class="bottom-section">

        <!-- DIAGN√ìSTICO -->
        <div class="diagnostico-box">
          <div class="diagnostico-title">DIAGN√ìSTICO</div>
          <div class="diagnostico-grid">
            <div class="diagnostico-item ${datos.diagMiopia ? 'checked' : ''}">
              <span class="checkbox ${datos.diagMiopia ? 'checked' : ''}"></span>
              <span>Miop√≠a</span>
            </div>
            <div class="diagnostico-item ${datos.diagHipermetropia ? 'checked' : ''}">
              <span class="checkbox ${datos.diagHipermetropia ? 'checked' : ''}"></span>
              <span>Hipermetrop√≠a</span>
            </div>
            <div class="diagnostico-item ${datos.diagAstigmatismo ? 'checked' : ''}">
              <span class="checkbox ${datos.diagAstigmatismo ? 'checked' : ''}"></span>
              <span>Astigmatismo</span>
            </div>
            <div class="diagnostico-item ${datos.diagPresbicia ? 'checked' : ''}">
              <span class="checkbox ${datos.diagPresbicia ? 'checked' : ''}"></span>
              <span>Presbicia</span>
            </div>
            <div class="diagnostico-item ${datos.diagAmbliopia ? 'checked' : ''}">
              <span class="checkbox ${datos.diagAmbliopia ? 'checked' : ''}"></span>
              <span>Ambliop√≠a</span>
            </div>
            <div class="diagnostico-item ${datos.diagAnisometropia ? 'checked' : ''}">
              <span class="checkbox ${datos.diagAnisometropia ? 'checked' : ''}"></span>
              <span>Anisometrop√≠a</span>
            </div>
          </div>
        </div>

        <!-- PIO -->
        <div class="pio-box">
          <div class="pio-title">PIO</div>
          <div class="pio-items">
            <div class="pio-field">
              <span class="pio-label">PIO OD:</span>
              <span class="pio-value">${datos.rxPioOD || ''}</span>
            </div>
            <div class="pio-field">
              <span class="pio-label">PIO OI:</span>
              <span class="pio-value">${datos.rxPioOI || ''}</span>
            </div>
          </div>
        </div>

      </div>

          <!-- OBSERVACIONES -->
          <div class="observaciones-box">
            <div class="observaciones-title">OBSERVACIONES</div>
            <div class="observaciones-content">${datos.rxObservaciones || datos.rxObservacion || ''}</div>
          </div>

        </div><!-- /contenido-principal -->
      </div><!-- /prescripcion-flex -->
    </div><!-- /prescripcion-wrapper -->`;
  }

  // Construir HTML completo
  let html = `<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Prescripci√≥n - ${nombrePaciente}</title>
  <style>
    @page {
      size: A4 portrait;
      margin: 10mm;
    }

    @media print {
      body {
        margin: 0;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: Arial, sans-serif;
      background: white;
      color: #000;
    }

    /* WRAPPER DE PRESCRIPCI√ìN - MEDIA HOJA */
    .prescripcion-wrapper {
      width: 190mm;
      min-height: 138mm;
      margin: 0 auto;
      page-break-after: always;
      page-break-inside: avoid;
      border: 2px solid ${config.colorPrimario};
    }

    .prescripcion-wrapper:last-child {
      page-break-after: auto;
    }

    /* FLEX CONTAINER */
    .prescripcion-flex {
      display: flex;
      height: 100%;
    }

    /* SIDEBAR VERTICAL IZQUIERDO */
    .sidebar-vertical {
      width: 12mm;
      background: ${config.colorPrimario};
      color: white;
      writing-mode: vertical-rl;
      text-orientation: mixed;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 3mm 1mm;
      border-right: 2px solid ${config.colorPrimario};
    }

    .sidebar-content {
      text-align: center;
    }

    .sidebar-nombre {
      font-size: 14px;
      font-weight: 900;
      letter-spacing: 2px;
      margin-bottom: 5mm;
    }

    .sidebar-subtitulo {
      font-size: 7px;
      font-weight: 700;
      opacity: 0.95;
      margin-bottom: 3mm;
    }

    .sidebar-descripcion {
      font-size: 6px;
      font-weight: 600;
      opacity: 0.9;
      margin-bottom: 3mm;
    }

    .sidebar-adicional {
      font-size: 6px;
      font-weight: 600;
      opacity: 0.85;
    }

    /* CONTENIDO PRINCIPAL */
    .contenido-principal {
      flex: 1;
      padding: 2mm;
    }

    /* HEADER */
    .header {
      text-align: center;
      padding: 1mm 0;
      border-bottom: 2px solid ${config.colorPrimario};
      margin-bottom: 2mm;
    }

    .empresa-nombre {
      font-size: 18px;
      font-weight: 900;
      color: ${config.colorPrimario};
      letter-spacing: 1.5px;
      margin-bottom: 1mm;
    }

    .empresa-subtitulo {
      font-size: 9px;
      font-weight: 700;
      color: #333;
      margin-bottom: 0.5mm;
    }

    .empresa-descripcion {
      font-size: 8px;
      color: #666;
      margin-bottom: 1mm;
    }

    .empresa-contacto {
      font-size: 7px;
      color: #999;
    }

    /* INFO PACIENTE */
    .info-paciente {
      border: 2px solid ${config.colorPrimario};
      padding: 2mm;
      margin-bottom: 2mm;
    }

    .info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2mm 3mm;
    }

    .info-item {
      display: flex;
      align-items: baseline;
      gap: 1mm;
    }

    .info-item .label {
      font-weight: 800;
      color: ${config.colorPrimario};
      font-size: 8px;
      min-width: 15mm;
    }

    .info-item .value {
      flex: 1;
      border-bottom: 1px solid #999;
      font-size: 9px;
      font-weight: 600;
      min-height: 3.5mm;
      padding-bottom: 0.5mm;
    }

    /* T√çTULOS */
    .section-title {
      background: ${config.colorPrimario};
      color: white;
      text-align: center;
      padding: 2mm;
      font-size: 12px;
      font-weight: 900;
      letter-spacing: 1.2px;
      margin: 2mm 0 1mm 0;
    }

    .subsection-title {
      background: ${config.colorPrimario};
      color: white;
      text-align: center;
      padding: 1.5mm;
      font-size: 11px;
      font-weight: 900;
      margin: 1.5mm 0 1mm 0;
    }

    /* TABLAS */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 1.5mm;
      border: 2px solid ${config.colorPrimario};
    }

    table th {
      background: ${config.colorPrimario};
      color: white;
      padding: 2mm;
      border: 1px solid ${config.colorPrimario};
      font-weight: 900;
      text-align: center;
      font-size: 10px;
    }

    table td {
      padding: 3mm 2mm;
      border: 1px solid ${config.colorPrimario};
      text-align: center;
      font-size: 14px;
      font-weight: 700;
      color: #000;
      background: white;
      min-height: 8mm;
    }

    table td.ojo-label {
      font-weight: 900;
      color: ${config.colorPrimario};
      font-size: 13px;
    }

    /* SECCI√ìN INFERIOR */
    .bottom-section {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 2mm;
      margin: 2mm 0;
    }

    /* DIAGN√ìSTICO */
    .diagnostico-box {
      border: 2px solid ${config.colorPrimario};
    }

    .diagnostico-title {
      background: ${config.colorPrimario};
      color: white;
      text-align: center;
      padding: 1.5mm;
      font-size: 10px;
      font-weight: 900;
    }

    .diagnostico-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0;
    }

    .diagnostico-item {
      padding: 2mm;
      border: 1px solid ${config.colorPrimario};
      font-size: 9px;
      display: flex;
      align-items: center;
      gap: 2mm;
      background: white;
      font-weight: 600;
    }

    .checkbox {
      width: 4mm;
      height: 4mm;
      border: 2px solid ${config.colorPrimario};
      display: inline-block;
      position: relative;
      background: white;
      flex-shrink: 0;
    }

    .checkbox.checked::after {
      content: '‚úì';
      position: absolute;
      top: -1mm;
      left: 0.3mm;
      color: ${config.colorPrimario};
      font-size: 12px;
      font-weight: 900;
    }

    /* PIO */
    .pio-box {
      border: 2px solid ${config.colorPrimario};
    }

    .pio-title {
      background: ${config.colorPrimario};
      color: white;
      text-align: center;
      padding: 1.5mm;
      font-size: 10px;
      font-weight: 900;
    }

    .pio-items {
      padding: 2mm;
    }

    .pio-field {
      display: flex;
      align-items: center;
      gap: 1mm;
      margin-bottom: 2mm;
    }

    .pio-field:last-child {
      margin-bottom: 0;
    }

    .pio-label {
      font-size: 9px;
      font-weight: 800;
      color: ${config.colorPrimario};
      min-width: 15mm;
    }

    .pio-value {
      flex: 1;
      border-bottom: 1px solid #999;
      font-size: 12px;
      font-weight: 700;
      min-height: 4mm;
      padding-bottom: 0.5mm;
    }

    /* OBSERVACIONES */
    .observaciones-box {
      border: 2px solid ${config.colorPrimario};
      margin-top: 2mm;
    }

    .observaciones-title {
      background: ${config.colorPrimario};
      color: white;
      text-align: center;
      padding: 1.5mm;
      font-size: 10px;
      font-weight: 900;
    }

    .observaciones-content {
      padding: 2mm;
      font-size: 10px;
      line-height: 1.6;
      min-height: 12mm;
    }

    /* L√çNEA DE CORTE */
    .linea-corte {
      width: 100%;
      text-align: center;
      padding: 2mm 0;
      font-size: 8px;
      color: #666;
      border-top: 2px solid #000;
      margin: 0;
    }
  </style>
</head>
<body>`;

  // Primera prescripci√≥n
  html += generarPrescripcionHTML();

  // L√≠nea de corte
  html += '<div class="linea-corte">‚úÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ L√çNEA DE CORTE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ‚úÇ</div>';

  // Segunda prescripci√≥n (id√©ntica)
  html += generarPrescripcionHTML();

  // Auto-imprimir
  html += `
  <script>
    window.onload = function() {
      window.print();
    };
  <\/script>
</body>
</html>`;

  printWindow.document.write(html);
  printWindow.document.close();

  console.log('‚úÖ Receta generada (2 por hoja - dise√±o horizontal)');
  toast('‚úÖ Generando 2 recetas m√©dicas...', 'success');
}
function imprimirRecetaMedica(idConsulta) {
  const consultas = load(DB.CONSULTAS_CLINICAS);
  const consulta = consultas.find(c => c.id === idConsulta);

  if (!consulta) {
    toast('‚ùå Consulta no encontrada', 'error');
    return;
  }

  console.log('üñ®Ô∏è Imprimiendo receta m√©dica:', idConsulta);

  // Llamar a la funci√≥n de impresi√≥n existente
  imprimirConsulta(idConsulta);
}

// ============================================
// PANEL DE ESTAD√çSTICAS DEL CONSULTORIO
// ============================================

function cargarEstadisticasConsultorio() {
  console.log('üìä Cargando estad√≠sticas del consultorio...');

  const consultas = load(DB.CONSULTAS_CLINICAS);
  const clientes = load(DB.CLIENTES);

  if (consultas.length === 0) {
    const statsDiv = document.getElementById('consultorioEstadisticas');
    if (statsDiv) {
      statsDiv.innerHTML = `
        <div style="padding: 60px; text-align: center; background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%); border-radius: 16px; border: 3px dashed #d1d5db;">
          <div style="font-size: 72px; margin-bottom: 20px; opacity: 0.5;">üìä</div>
          <div style="font-size: 18px; font-weight: 800; color: #6b7280; margin-bottom: 10px;">Sin Datos Estad√≠sticos</div>
          <div style="font-size: 14px; color: #9ca3af;">No hay consultas registradas para generar estad√≠sticas</div>
        </div>
      `;
    }
    return;
  }

  // Calcular estad√≠sticas
  const hoy = new Date();
  const hace30Dias = new Date(hoy.getTime() - 30 * 24 * 60 * 60 * 1000);
  const hace7Dias = new Date(hoy.getTime() - 7 * 24 * 60 * 60 * 1000);

  const consultasHoy = consultas.filter(c => {
    const fechaConsulta = new Date(c.fecha);
    return fechaConsulta.toDateString() === hoy.toDateString();
  }).length;

  const consultasSemana = consultas.filter(c => {
    const fechaConsulta = new Date(c.fecha);
    return fechaConsulta >= hace7Dias;
  }).length;

  const consultasMes = consultas.filter(c => {
    const fechaConsulta = new Date(c.fecha);
    return fechaConsulta >= hace30Dias;
  }).length;

  // Diagn√≥sticos m√°s comunes
  const diagnosticos = {
    miopia: consultas.filter(c => c.diagMiopia).length,
    hipermetropia: consultas.filter(c => c.diagHipermetropia).length,
    astigmatismo: consultas.filter(c => c.diagAstigmatismo).length,
    presbicia: consultas.filter(c => c.diagPresbicia).length,
    ambliopia: consultas.filter(c => c.diagAmbliopia).length,
    anisometropia: consultas.filter(c => c.diagAnisometropia).length
  };

  // Consultas por especialista
  const especialistas = {};
  consultas.forEach(c => {
    if (c.rxEspecialista) {
      especialistas[c.rxEspecialista] = (especialistas[c.rxEspecialista] || 0) + 1;
    }
  });

  // Renderizar estad√≠sticas
  const statsDiv = document.getElementById('consultorioEstadisticas');
  if (!statsDiv) return;

  let html = `
    <div style="background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%); padding: 24px; border-radius: 16px 16px 0 0; color: white; margin-bottom: 24px; box-shadow: 0 8px 32px rgba(124, 58, 237, 0.4);">
      <div style="text-align: center;">
        <div style="font-size: 48px; margin-bottom: 12px;">üìä</div>
        <div style="font-size: 24px; font-weight: 900; margin-bottom: 8px; letter-spacing: 1px;">ESTAD√çSTICAS DEL CONSULTORIO</div>
        <div style="font-size: 14px; opacity: 0.95;">Panel de an√°lisis y m√©tricas cl√≠nicas</div>
      </div>
    </div>

    <!-- M√©tricas principales -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
      <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 24px; border-radius: 16px; color: white; box-shadow: 0 8px 24px rgba(16, 185, 129, 0.3); transition: transform 0.3s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
        <div style="font-size: 40px; margin-bottom: 8px;">üìÖ</div>
        <div style="font-size: 36px; font-weight: 900; margin-bottom: 4px;">${consultasHoy}</div>
        <div style="font-size: 13px; opacity: 0.95; font-weight: 600; text-transform: uppercase; letter-spacing: 1px;">Hoy</div>
      </div>

      <div style="background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%); padding: 24px; border-radius: 16px; color: white; box-shadow: 0 8px 24px rgba(59, 130, 246, 0.3); transition: transform 0.3s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
        <div style="font-size: 40px; margin-bottom: 8px;">üìÜ</div>
        <div style="font-size: 36px; font-weight: 900; margin-bottom: 4px;">${consultasSemana}</div>
        <div style="font-size: 13px; opacity: 0.95; font-weight: 600; text-transform: uppercase; letter-spacing: 1px;">Esta Semana</div>
      </div>

      <div style="background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%); padding: 24px; border-radius: 16px; color: white; box-shadow: 0 8px 24px rgba(139, 92, 246, 0.3); transition: transform 0.3s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
        <div style="font-size: 40px; margin-bottom: 8px;">üìä</div>
        <div style="font-size: 36px; font-weight: 900; margin-bottom: 4px;">${consultasMes}</div>
        <div style="font-size: 13px; opacity: 0.95; font-weight: 600; text-transform: uppercase; letter-spacing: 1px;">Este Mes</div>
      </div>

      <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); padding: 24px; border-radius: 16px; color: white; box-shadow: 0 8px 24px rgba(245, 158, 11, 0.3); transition: transform 0.3s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
        <div style="font-size: 40px; margin-bottom: 8px;">üë•</div>
        <div style="font-size: 36px; font-weight: 900; margin-bottom: 4px;">${consultas.length}</div>
        <div style="font-size: 13px; opacity: 0.95; font-weight: 600; text-transform: uppercase; letter-spacing: 1px;">Total Consultas</div>
      </div>
    </div>

    <!-- Diagn√≥sticos m√°s comunes -->
    <div style="background: white; border-radius: 16px; padding: 24px; margin-bottom: 30px; box-shadow: 0 4px 16px rgba(0,0,0,0.1);">
      <h3 style="margin: 0 0 20px 0; color: #7c3aed; font-size: 18px; font-weight: 800; display: flex; align-items: center; gap: 10px;">
        <span style="font-size: 28px;">üîç</span>
        DIAGN√ìSTICOS M√ÅS FRECUENTES
      </h3>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px;">
        ${Object.entries(diagnosticos).map(([nombre, cantidad]) => {
          const porcentaje = consultas.length > 0 ? ((cantidad / consultas.length) * 100).toFixed(1) : 0;
          const colores = {
            miopia: { bg: '#eff6ff', border: '#3b82f6', text: '#1e40af' },
            hipermetropia: { bg: '#fef3c7', border: '#f59e0b', text: '#92400e' },
            astigmatismo: { bg: '#ecfdf5', border: '#10b981', text: '#065f46' },
            presbicia: { bg: '#fce7f3', border: '#ec4899', text: '#9f1239' },
            ambliopia: { bg: '#f3e8ff', border: '#a855f7', text: '#6b21a8' },
            anisometropia: { bg: '#fee2e2', border: '#ef4444', text: '#991b1b' }
          };
          const color = colores[nombre] || { bg: '#f3f4f6', border: '#9ca3af', text: '#374151' };
          const nombreFormateado = nombre.replace(/([A-Z])/g, ' $1').trim();

          return '<div style="background: ' + color.bg + '; padding: 16px; border-radius: 12px; border-left: 4px solid ' + color.border + ';">' +
              '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">' +
                '<div style="font-weight: 700; color: ' + color.text + '; font-size: 14px; text-transform: capitalize;">' + nombreFormateado + '</div>' +
                '<div style="background: ' + color.border + '; color: white; padding: 4px 12px; border-radius: 20px; font-weight: 700; font-size: 12px;">' + cantidad + '</div>' +
              '</div>' +
              '<div style="background: white; border-radius: 8px; height: 8px; overflow: hidden;">' +
                '<div style="background: ' + color.border + '; height: 100%; width: ' + porcentaje + '%; transition: width 0.3s;"></div>' +
              '</div>' +
              '<div style="text-align: right; font-size: 11px; color: ' + color.text + '; font-weight: 600; margin-top: 4px;">' + porcentaje + '%</div>' +
            '</div>';
        }).join('')}
      </div>
    </div>

    <!-- Consultas por especialista -->
    ${Object.keys(especialistas).length > 0 ? `
    <div style="background: white; border-radius: 16px; padding: 24px; box-shadow: 0 4px 16px rgba(0,0,0,0.1);">
      <h3 style="margin: 0 0 20px 0; color: #7c3aed; font-size: 18px; font-weight: 800; display: flex; align-items: center; gap: 10px;">
        <span style="font-size: 28px;">üë®‚Äç‚öïÔ∏è</span>
        CONSULTAS POR ESPECIALISTA
      </h3>
      <div style="display: grid; gap: 12px;">
        ${Object.entries(especialistas)
          .sort((a, b) => b[1] - a[1])
          .map(([nombre, cantidad], index) => {
            const porcentaje = ((cantidad / consultas.length) * 100).toFixed(1);
            const colores = ['#7c3aed', '#3b82f6', '#10b981', '#f59e0b', '#ef4444'];
            const color = colores[index % colores.length];

            return '<div style="background: #f8fafc; padding: 16px; border-radius: 12px; border-left: 4px solid ' + color + ';">' +
              '<div style="display: flex; justify-content: space-between; align-items: center;">' +
                '<div style="flex: 1;">' +
                  '<div style="font-weight: 700; color: #1e293b; font-size: 15px; margin-bottom: 4px;">' + nombre + '</div>' +
                  '<div style="background: white; border-radius: 8px; height: 8px; width: 80%; overflow: hidden;">' +
                    '<div style="background: ' + color + '; height: 100%; width: ' + porcentaje + '%; transition: width 0.3s;"></div>' +
                  '</div>' +
                '</div>' +
                '<div style="text-align: right; margin-left: 16px;">' +
                  '<div style="background: ' + color + '; color: white; padding: 6px 16px; border-radius: 12px; font-weight: 800; font-size: 18px; margin-bottom: 4px;">' + cantidad + '</div>' +
                  '<div style="font-size: 11px; color: #64748b; font-weight: 600;">' + porcentaje + '%</div>' +
                '</div>' +
              '</div>' +
            '</div>';
          }).join('')}
      </div>
    </div>
    ` : ''}
  `;

  statsDiv.innerHTML = html;
  console.log('‚úÖ Estad√≠sticas cargadas exitosamente');
}

// ============================================
// FUNCIONES AUXILIARES ADICIONALES
// ============================================

// Actualizar contadores en tiempo real
function actualizarContadoresConsultorio() {
  const consultas = load(DB.CONSULTAS_CLINICAS);
  const contadorTotal = document.getElementById('contadorConsultasTotal');
  if (contadorTotal) {
    contadorTotal.textContent = consultas.length;
  }
}

// Exportar consultas a CSV
function exportarConsultasCSV() {
  const consultas = load(DB.CONSULTAS_CLINICAS);

  if (consultas.length === 0) {
    toast('‚ö†Ô∏è No hay consultas para exportar', 'warning');
    return;
  }

  let csv = 'ID,Fecha,Paciente,DNI,Motivo,Diagn√≥stico,Especialista,Usuario\n';

  consultas.forEach(c => {
    const diagnosticos = [];
    if (c.diagMiopia) diagnosticos.push('Miop√≠a');
    if (c.diagHipermetropia) diagnosticos.push('Hipermetrop√≠a');
    if (c.diagAstigmatismo) diagnosticos.push('Astigmatismo');
    if (c.diagPresbicia) diagnosticos.push('Presbicia');
    if (c.diagAmbliopia) diagnosticos.push('Ambliop√≠a');
    if (c.diagAnisometropia) diagnosticos.push('Anisometrop√≠a');

    csv += `${c.id},${c.fechaFormato},"${c.nombreCliente}",${c.dniCliente},"${c.motivo}","${diagnosticos.join(', ')}","${c.rxEspecialista || ''}",${c.usuario}\n`;
  });

  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `consultas_${today()}.csv`;
  link.click();

  toast('‚úÖ Consultas exportadas exitosamente', 'success');
}

console.log('‚úÖ M√≥dulo Consultorio Ultra Profesional V2.0 cargado exitosamente');

// ==================== B√öSQUEDA GLOBAL INTELIGENTE ====================

// Crear modal de b√∫squeda global
function crearModalBusquedaGlobal() {
  const modal = document.createElement('div');
  modal.id = 'modalBusquedaGlobal';
  modal.style.cssText = `
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
    z-index: 10000;
    align-items: flex-start;
    justify-content: center;
    padding-top: 10vh;
    animation: fadeIn 0.2s ease-out;
  `;

  modal.innerHTML = `
    <div style="
      background: white;
      border-radius: 16px;
      width: 90%;
      max-width: 700px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: slideDown 0.3s ease-out;
      overflow: hidden;
    ">
      <!-- Header de b√∫squeda -->
      <div style="padding: 20px; border-bottom: 2px solid #e5e7eb;">
        <div style="position: relative;">
          <input
            type="text"
            id="inputBusquedaGlobal"
            placeholder="üîç Buscar en todo el sistema... (Ctrl+K)"
            style="
              width: 100%;
              padding: 15px 50px 15px 50px;
              font-size: 18px;
              border: 2px solid #e5e7eb;
              border-radius: 12px;
              outline: none;
              transition: all 0.3s ease;
            "
            onkeyup="realizarBusquedaGlobal()"
          >
          <span style="position: absolute; left: 15px; top: 50%; transform: translateY(-50%); font-size: 24px;">üîç</span>
          <button onclick="cerrarBusquedaGlobal()" style="
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: #f3f4f6;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
          ">‚úñÔ∏è</button>
        </div>

        <!-- Filtros r√°pidos -->
        <div style="display: flex; gap: 8px; margin-top: 15px; flex-wrap: wrap;">
          <button class="filtro-busqueda-btn active" data-filtro="todo" onclick="cambiarFiltroBusqueda('todo')" style="
            background: #3b82f6;
            color: white;
            border: none;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
          ">Todo</button>
          <button class="filtro-busqueda-btn" data-filtro="clientes" onclick="cambiarFiltroBusqueda('clientes')" style="
            background: #f3f4f6;
            color: #6b7280;
            border: none;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
          ">üë• Clientes</button>
          <button class="filtro-busqueda-btn" data-filtro="productos" onclick="cambiarFiltroBusqueda('productos')" style="
            background: #f3f4f6;
            color: #6b7280;
            border: none;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
          ">üì¶ Productos</button>
          <button class="filtro-busqueda-btn" data-filtro="ventas" onclick="cambiarFiltroBusqueda('ventas')" style="
            background: #f3f4f6;
            color: #6b7280;
            border: none;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
          ">üí∞ Ventas</button>
          <button class="filtro-busqueda-btn" data-filtro="consultas" onclick="cambiarFiltroBusqueda('consultas')" style="
            background: #f3f4f6;
            color: #6b7280;
            border: none;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
          ">ü©∫ Consultas</button>
        </div>
      </div>

      <!-- Resultados -->
      <div id="resultadosBusquedaGlobal" style="
        max-height: 500px;
        overflow-y: auto;
        padding: 10px;
      ">
        <div style="padding: 60px 20px; text-align: center; color: #9ca3af;">
          <div style="font-size: 48px; margin-bottom: 15px;">üîç</div>
          <div style="font-size: 16px; font-weight: 600; color: #6b7280;">Busca clientes, productos, ventas o consultas</div>
          <div style="font-size: 13px; color: #9ca3af; margin-top: 8px;">Escribe al menos 2 caracteres para buscar</div>
        </div>
      </div>

      <!-- Footer con atajos -->
      <div style="
        padding: 12px 20px;
        background: #f9fafb;
        border-top: 1px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
      ">
        <div style="display: flex; gap: 15px; font-size: 12px; color: #6b7280;">
          <div><kbd style="background: white; padding: 3px 8px; border-radius: 4px; border: 1px solid #d1d5db;">‚Üë‚Üì</kbd> Navegar</div>
          <div><kbd style="background: white; padding: 3px 8px; border-radius: 4px; border: 1px solid #d1d5db;">Enter</kbd> Abrir</div>
          <div><kbd style="background: white; padding: 3px 8px; border-radius: 4px; border: 1px solid #d1d5db;">Esc</kbd> Cerrar</div>
        </div>
        <div style="font-size: 12px; color: #9ca3af;" id="contadorResultados">0 resultados</div>
      </div>
    </div>
  `;

  document.body.appendChild(modal);

  // Cerrar al hacer clic fuera
  modal.addEventListener('click', function(e) {
    if (e.target === modal) {
      cerrarBusquedaGlobal();
    }
  });
}

// Variables globales para b√∫squeda
let filtroActualBusqueda = 'todo';
let resultadosActualesBusqueda = [];
let indiceSeleccionadoBusqueda = -1;

// Abrir modal de b√∫squeda
function abrirBusquedaGlobal() {
  const modal = document.getElementById('modalBusquedaGlobal');
  if (!modal) {
    crearModalBusquedaGlobal();
  }

  const modalElement = document.getElementById('modalBusquedaGlobal');
  modalElement.style.display = 'flex';

  setTimeout(() => {
    document.getElementById('inputBusquedaGlobal').focus();
  }, 100);
}

// Cerrar modal de b√∫squeda
function cerrarBusquedaGlobal() {
  const modal = document.getElementById('modalBusquedaGlobal');
  if (modal) {
    modal.style.display = 'none';
    document.getElementById('inputBusquedaGlobal').value = '';
    document.getElementById('resultadosBusquedaGlobal').innerHTML = `
      <div style="padding: 60px 20px; text-align: center; color: #9ca3af;">
        <div style="font-size: 48px; margin-bottom: 15px;">üîç</div>
        <div style="font-size: 16px; font-weight: 600; color: #6b7280;">Busca clientes, productos, ventas o consultas</div>
        <div style="font-size: 13px; color: #9ca3af; margin-top: 8px;">Escribe al menos 2 caracteres para buscar</div>
      </div>
    `;
    resultadosActualesBusqueda = [];
    indiceSeleccionadoBusqueda = -1;
  }
}

// Cambiar filtro de b√∫squeda
function cambiarFiltroBusqueda(filtro) {
  filtroActualBusqueda = filtro;

  // Actualizar UI de botones
  document.querySelectorAll('.filtro-busqueda-btn').forEach(btn => {
    if (btn.dataset.filtro === filtro) {
      btn.style.background = '#3b82f6';
      btn.style.color = 'white';
      btn.classList.add('active');
    } else {
      btn.style.background = '#f3f4f6';
      btn.style.color = '#6b7280';
      btn.classList.remove('active');
    }
  });

  // Reejecutar b√∫squeda
  realizarBusquedaGlobal();
}

// Realizar b√∫squeda global
function realizarBusquedaGlobal() {
  const termino = document.getElementById('inputBusquedaGlobal').value.trim().toLowerCase();

  if (termino.length < 2) {
    document.getElementById('resultadosBusquedaGlobal').innerHTML = `
      <div style="padding: 60px 20px; text-align: center; color: #9ca3af;">
        <div style="font-size: 48px; margin-bottom: 15px;">üîç</div>
        <div style="font-size: 16px; font-weight: 600; color: #6b7280;">Busca clientes, productos, ventas o consultas</div>
        <div style="font-size: 13px; color: #9ca3af; margin-top: 8px;">Escribe al menos 2 caracteres para buscar</div>
      </div>
    `;
    document.getElementById('contadorResultados').textContent = '0 resultados';
    return;
  }

  resultadosActualesBusqueda = [];

  // Buscar en clientes
  if (filtroActualBusqueda === 'todo' || filtroActualBusqueda === 'clientes') {
    const clientes = load(DB.CLIENTES) || [];
    clientes.forEach(cliente => {
      const coincide =
        (cliente.dni && cliente.dni.toLowerCase().includes(termino)) ||
        (cliente.nombre && cliente.nombre.toLowerCase().includes(termino)) ||
        (cliente.apellidos && cliente.apellidos.toLowerCase().includes(termino)) ||
        (cliente.email && cliente.email.toLowerCase().includes(termino));

      if (coincide) {
        resultadosActualesBusqueda.push({
          tipo: 'cliente',
          icono: 'üë§',
          titulo: `${cliente.nombre} ${cliente.apellidos || ''}`,
          subtitulo: `DNI: ${cliente.dni} - Tel: ${cliente.telefono || 'N/A'}`,
          color: '#3b82f6',
          data: cliente,
          accion: () => {
            cerrarBusquedaGlobal();
            mostrarSeccion('clientes');
            // Resaltar cliente en la lista
            setTimeout(() => {
              const input = document.getElementById('searchCliente');
              if (input) {
                input.value = cliente.dni;
                if (typeof renderClientes === 'function') renderClientes();
              }
            }, 300);
          }
        });
      }
    });
  }

  // Buscar en productos
  if (filtroActualBusqueda === 'todo' || filtroActualBusqueda === 'productos') {
    const productos = load(DB.PRODUCTOS) || [];
    productos.forEach(producto => {
      const coincide =
        (producto.codigo && producto.codigo.toLowerCase().includes(termino)) ||
        (producto.nombre && producto.nombre.toLowerCase().includes(termino)) ||
        (producto.marca && producto.marca.toLowerCase().includes(termino)) ||
        (producto.modelo && producto.modelo.toLowerCase().includes(termino));

      if (coincide) {
        resultadosActualesBusqueda.push({
          tipo: 'producto',
          icono: 'üì¶',
          titulo: producto.nombre,
          subtitulo: `C√≥digo: ${producto.codigo} - Stock: ${producto.stock || 0} - S/ ${(producto.precio || 0).toFixed(2)}`,
          color: '#10b981',
          data: producto,
          accion: () => {
            cerrarBusquedaGlobal();
            mostrarSeccion('productos');
            setTimeout(() => {
              const input = document.getElementById('searchProducto');
              if (input) {
                input.value = producto.codigo;
                if (typeof cargarProductos === 'function') cargarProductos();
              }
            }, 300);
          }
        });
      }
    });
  }

  // Buscar en ventas
  if (filtroActualBusqueda === 'todo' || filtroActualBusqueda === 'ventas') {
    const ventas = load(DB.VENTAS) || [];
    ventas.forEach(venta => {
      const coincide =
        (venta.id && venta.id.toLowerCase().includes(termino)) ||
        (venta.clienteNombre && venta.clienteNombre.toLowerCase().includes(termino)) ||
        (venta.clienteDNI && venta.clienteDNI.toLowerCase().includes(termino));

      if (coincide) {
        resultadosActualesBusqueda.push({
          tipo: 'venta',
          icono: 'üí∞',
          titulo: `Venta ${venta.id}`,
          subtitulo: `Cliente: ${venta.clienteNombre || 'N/A'} - Total: S/ ${(venta.total || 0).toFixed(2)} - ${venta.fecha}`,
          color: '#f59e0b',
          data: venta,
          accion: () => {
            cerrarBusquedaGlobal();
            mostrarSeccion('ventas');
            toast('Venta encontrada: ' + venta.id, 'info');
          }
        });
      }
    });
  }

  // Buscar en consultas cl√≠nicas
  if (filtroActualBusqueda === 'todo' || filtroActualBusqueda === 'consultas') {
    const consultas = load(DB.CONSULTAS_CLINICAS) || [];
    consultas.forEach(consulta => {
      const coincide =
        (consulta.pacienteNombre && consulta.pacienteNombre.toLowerCase().includes(termino)) ||
        (consulta.pacienteDNI && consulta.pacienteDNI.toLowerCase().includes(termino)) ||
        (consulta.diagnostico && consulta.diagnostico.toLowerCase().includes(termino));

      if (coincide) {
        resultadosActualesBusqueda.push({
          tipo: 'consulta',
          icono: 'ü©∫',
          titulo: `Consulta - ${consulta.pacienteNombre}`,
          subtitulo: `DNI: ${consulta.pacienteDNI} - Fecha: ${consulta.fecha || 'N/A'}`,
          color: '#8b5cf6',
          data: consulta,
          accion: () => {
            cerrarBusquedaGlobal();
            mostrarSeccion('consultorio');
            toast('Consulta encontrada', 'info');
          }
        });
      }
    });
  }

  // Renderizar resultados
  mostrarResultadosBusqueda();
}

// Mostrar resultados de b√∫squeda
function mostrarResultadosBusqueda() {
  const container = document.getElementById('resultadosBusquedaGlobal');
  const contador = document.getElementById('contadorResultados');

  if (resultadosActualesBusqueda.length === 0) {
    container.innerHTML = `
      <div style="padding: 60px 20px; text-align: center; color: #9ca3af;">
        <div style="font-size: 48px; margin-bottom: 15px;">üîç</div>
        <div style="font-size: 16px; font-weight: 600; color: #6b7280;">No se encontraron resultados</div>
        <div style="font-size: 13px; color: #9ca3af; margin-top: 8px;">Intenta con otro t√©rmino de b√∫squeda</div>
      </div>
    `;
    contador.textContent = '0 resultados';
    return;
  }

  container.innerHTML = resultadosActualesBusqueda.map((resultado, index) => `
    <div
      class="resultado-busqueda-item"
      data-index="${index}"
      onclick="resultadosActualesBusqueda[${index}].accion()"
      style="
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        background: white;
        border: 2px solid #f3f4f6;
        display: flex;
        align-items: center;
        gap: 15px;
      "
      onmouseover="this.style.background='#f9fafb'; this.style.borderColor='${resultado.color}';"
      onmouseout="this.style.background='white'; this.style.borderColor='#f3f4f6';"
    >
      <div style="
        font-size: 32px;
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: ${resultado.color}15;
        border-radius: 10px;
      ">${resultado.icono}</div>
      <div style="flex: 1;">
        <div style="font-weight: 700; color: #1f2937; margin-bottom: 4px;">${resultado.titulo}</div>
        <div style="font-size: 13px; color: #6b7280;">${resultado.subtitulo}</div>
      </div>
      <div style="
        background: ${resultado.color};
        color: white;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
      ">${resultado.tipo}</div>
    </div>
  `).join('');

  contador.textContent = `${resultadosActualesBusqueda.length} resultado${resultadosActualesBusqueda.length !== 1 ? 's' : ''}`;
  indiceSeleccionadoBusqueda = -1;
}

// Atajo de teclado global para b√∫squeda (Ctrl+K)
document.addEventListener('keydown', function(e) {
  // Ctrl+K o Cmd+K para abrir b√∫squeda
  if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
    e.preventDefault();
    abrirBusquedaGlobal();
  }

  // ESC para cerrar b√∫squeda
  if (e.key === 'Escape') {
    const modal = document.getElementById('modalBusquedaGlobal');
    if (modal && modal.style.display === 'flex') {
      cerrarBusquedaGlobal();
    }
  }

  // Navegaci√≥n con flechas en resultados
  const modal = document.getElementById('modalBusquedaGlobal');
  if (modal && modal.style.display === 'flex' && resultadosActualesBusqueda.length > 0) {
    if (e.key === 'ArrowDown') {
      e.preventDefault();
      indiceSeleccionadoBusqueda = Math.min(indiceSeleccionadoBusqueda + 1, resultadosActualesBusqueda.length - 1);
      resaltarResultadoSeleccionado();
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      indiceSeleccionadoBusqueda = Math.max(indiceSeleccionadoBusqueda - 1, 0);
      resaltarResultadoSeleccionado();
    } else if (e.key === 'Enter' && indiceSeleccionadoBusqueda >= 0) {
      e.preventDefault();
      resultadosActualesBusqueda[indiceSeleccionadoBusqueda].accion();
    }
  }
});

// Resaltar resultado seleccionado con teclado
function resaltarResultadoSeleccionado() {
  const items = document.querySelectorAll('.resultado-busqueda-item');
  items.forEach((item, index) => {
    if (index === indiceSeleccionadoBusqueda) {
      const resultado = resultadosActualesBusqueda[index];
      item.style.background = '#f9fafb';
      item.style.borderColor = resultado.color;
      item.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    } else {
      item.style.background = 'white';
      item.style.borderColor = '#f3f4f6';
    }
  });
}

// Inicializar b√∫squeda global al cargar
document.addEventListener('DOMContentLoaded', function() {
  crearModalBusquedaGlobal();
  console.log('üîç Sistema de b√∫squeda global inicializado (Ctrl+K)');
});

console.log('‚úÖ Sistema de B√∫squeda Global Inteligente cargado');

// üöÄ INICIALIZAR SISTEMA DE SINCRONIZACI√ìN EN TIEMPO REAL
document.addEventListener('DOMContentLoaded', function() {
  // Peque√±o delay para asegurar que todos los elementos del DOM est√©n listos
  setTimeout(function() {
    inicializarSincronizacionRX();
    console.log('üí´ Sistema de sincronizaci√≥n en tiempo real ACTIVADO - Consultorio ‚Üî Clientes ‚Üî Ventas');
  }, 500);
});

console.log('‚úÖ Sistema de Sincronizaci√≥n en Tiempo Real cargado');

// ============================================
// üîç SCRIPT DE VERIFICACI√ìN DE PRESCRIPCIONES
// ============================================
// Este script permite verificar que las prescripciones se est√°n guardando
// y leyendo correctamente desde la base de datos central (DB.MEDIDAS)
//
// INSTRUCCIONES PARA USAR:
// 1. Abre la consola del navegador (F12 > Consola)
// 2. Escribe: verificarRxUnificada()
// 3. Revisa el reporte completo en la consola

function verificarRxUnificada() {
  console.clear();
  console.log('%c‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'color: #7c3aed; font-weight: bold');
  console.log('%cüîç VERIFICACI√ìN DEL SISTEMA DE PRESCRIPCIONES UNIFICADO', 'color: #7c3aed; font-weight: bold; font-size: 16px');
  console.log('%c‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'color: #7c3aed; font-weight: bold');
  console.log('');

  // Cargar datos
  const medidas = load(DB.MEDIDAS);
  const clientes = load(DB.CLIENTES);
  const consultas = load(DB.CONSULTAS_CLINICAS);

  console.log('%cüìä ESTAD√çSTICAS GENERALES:', 'color: #3b82f6; font-weight: bold; font-size: 14px');
  console.log(`  üìã Total de prescripciones en DB.MEDIDAS: ${medidas.length}`);
  console.log(`  üë• Total de clientes: ${clientes.length}`);
  console.log(`  ü©∫ Total de consultas cl√≠nicas: ${consultas.length}`);
  console.log('');

  // Verificar prescripciones recientes
  console.log('%cüïí √öLTIMAS 5 PRESCRIPCIONES:', 'color: #10b981; font-weight: bold; font-size: 14px');
  const ultimasRx = [...medidas].sort((a, b) => {
    const fechaA = a.fechaCreacion || a.fecha || '';
    const fechaB = b.fechaCreacion || b.fecha || '';
    return fechaB.localeCompare(fechaA);
  }).slice(0, 5);

  if (ultimasRx.length === 0) {
    console.log('%c  ‚ö†Ô∏è No hay prescripciones registradas', 'color: #f59e0b');
  } else {
    ultimasRx.forEach((rx, index) => {
      const cliente = clientes.find(c => c.id === rx.clienteId);
      const nombreCliente = cliente
        ? `${cliente.nombres || cliente.nombre || ''} ${cliente.apellidos || cliente.apellido || ''}`.trim()
        : 'Cliente no encontrado';

      console.log(`  ${index + 1}. %c${nombreCliente}`, 'color: #1f2937; font-weight: bold');
      console.log(`     üìÖ Fecha: ${rx.fecha || 'Sin fecha'}`);
      console.log(`     üÜî ID: ${rx.id}`);
      console.log(`     üëÅÔ∏è Lejos OD: ESF ${rx.lejosOdEsf || '-'} | CIL ${rx.lejosOdCil || '-'} | EJE ${rx.lejosOdEje || '-'}`);
      console.log(`     üëÅÔ∏è Lejos OI: ESF ${rx.lejosOiEsf || '-'} | CIL ${rx.lejosOiCil || '-'} | EJE ${rx.lejosOiEje || '-'}`);
      console.log(`     ${rx.origenConsultorio ? 'ü©∫ Origen: Consultorio' : 'üìã Origen: Clientes'}`);
      console.log('');
    });
  }

  // Verificar prescripciones desde Consultorio
  console.log('%cü©∫ PRESCRIPCIONES DESDE CONSULTORIO:', 'color: #8b5cf6; font-weight: bold; font-size: 14px');
  const rxConsultorio = medidas.filter(m => m.origenConsultorio === true);
  console.log(`  Total: ${rxConsultorio.length}`);
  if (rxConsultorio.length > 0) {
    console.log(`  ‚úÖ El Consultorio EST√Å guardando en DB.MEDIDAS correctamente`);
  } else {
    console.log(`  ‚ö†Ô∏è No se encontraron prescripciones del Consultorio`);
  }
  console.log('');

  // Verificar clientes con prescripciones
  console.log('%cüë• CLIENTES CON PRESCRIPCIONES:', 'color: #06b6d4; font-weight: bold; font-size: 14px');
  const clientesConRx = new Set(medidas.map(m => m.clienteId));
  console.log(`  Total de clientes con RX: ${clientesConRx.size}`);
  console.log(`  Total de clientes sin RX: ${clientes.length - clientesConRx.size}`);
  console.log('');

  // Verificar integridad de datos
  console.log('%cüîß VERIFICACI√ìN DE INTEGRIDAD:', 'color: #ef4444; font-weight: bold; font-size: 14px');
  let errores = 0;

  medidas.forEach(rx => {
    const cliente = clientes.find(c => c.id === rx.clienteId);
    if (!cliente) {
      console.log(`  ‚ùå Prescripci√≥n ${rx.id} referencia a cliente inexistente: ${rx.clienteId}`);
      errores++;
    }
  });

  if (errores === 0) {
    console.log(`  ‚úÖ Todas las prescripciones tienen clientes v√°lidos`);
  } else {
    console.log(`  ‚ùå Se encontraron ${errores} errores de integridad`);
  }
  console.log('');

  // Resumen final
  console.log('%c‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'color: #7c3aed; font-weight: bold');
  console.log('%c‚úÖ VERIFICACI√ìN COMPLETADA', 'color: #10b981; font-weight: bold; font-size: 16px');
  console.log('%c‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'color: #7c3aed; font-weight: bold');
  console.log('');
  console.log('%cPara ver una prescripci√≥n espec√≠fica, usa:', 'color: #6b7280');
  console.log('%cverRxClienteModal("ID_DEL_CLIENTE")', 'color: #3b82f6; font-family: monospace');
  console.log('');
  console.log('%cPara ver todas las prescripciones:', 'color: #6b7280');
  console.log('%cload(DB.MEDIDAS)', 'color: #3b82f6; font-family: monospace');
}

// Hacer la funci√≥n disponible globalmente
window.verificarRxUnificada = verificarRxUnificada;

console.log('');
console.log('%cüîç Script de verificaci√≥n cargado', 'color: #10b981; font-weight: bold');
console.log('%cEscribe verificarRxUnificada() en la consola para verificar el sistema', 'color: #6b7280');
console.log('');

</script>
</body>
</html>
